"object"!=typeof globalThis&&(globalThis=window),(this.webpackJsonp=this.webpackJsonp||[]).push([[21],{"+eUS":function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var i=s("jDHv"),a=s("+ExH"),n=s("ycTR"),r=s("YEoC"),o=s("kFM4"),d=s("teaq"),l=s("PhBv"),c=s("1UUk"),h=s("Hw41");function u(e){Object(o.a)("RunMode",e),e!==r.f.Unknown&&(i.ModuleContainer.resolve(c.b).install(),e!==r.f.Background&&(setTimeout((()=>{const e=i.ModuleContainer.resolve(l.b);e.install(a.b),e.start()}),1),i.ModuleContainer.resolve(d.b).install(n.a,n.b)),e===r.f.Host&&i.ModuleContainer.resolve(h.a).install())}},"+iAT":function(e,t,s){"use strict";var i=s("VTBJ"),a=s("YEoC"),n=s("xI/L"),r=s("C9Dv"),o=s("teaq");const d={PartitionKey:new o.d({tableName:"partition_key",name:"PartitionKey",fields:{database:{name:"database",type:a.h.string},table:{name:"table",type:a.h.string},key:{name:"key",type:a.h.string},value:{name:"value",type:a.h.string}},indices:{primary:{name:"primary",fields:[{type:"raw",field:"database"},{type:"raw",field:"table"},{type:"raw",field:"key"}],unique:!0}}})},l={name:"Meta",session:!0},c={partitionNamingStrategy:[n.a.byUser(),n.a.const("Meta")],partitionsMap:Object(r.a)(d)},h={partitionNamingStrategy:[n.a.const("mt"),n.a.byUser()],partitionsMap:Object(r.a)(d)},u=Object(i.a)(Object(i.a)(Object(i.a)({},l),c),{},{version:1,milestoneVersion:1,type:a.a.SQLite,corruptionImpact:a.b.IMPACT_PARTIAL}),g=Object(i.a)(Object(i.a)(Object(i.a)({},l),h),{},{version:1,milestoneVersion:1,type:a.a.IDB});let m=null,p=null;t.a={baseConfig:l,schema:d,get useSqlite(){return null===m&&(m=new o.a(u)),m},get useIdb(){return null===p&&(p=new o.a(g)),p}}},"0rWR":function(e,t,s){"use strict";var i,a=s("8/YW"),n=s("jDHv"),r=s("Mgpg"),o=s("YEoC"),d=s("PmZf"),l=s("x9oK"),c=s("UJ0r");let h=Object(a.g)()(i=n.ModuleContainer.injectable()(i=function(e,t){return n.ModuleContainer.inject(r.ZLoggerFactory)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===r.ZLoggerFactory?Object:r.ZLoggerFactory])(i=class extends c.a{constructor(e){super(),this.logger=void 0,this.removeListenersData=[],this.removeListenersForAllAdapters=()=>{this.removeListenersData.forEach((e=>e()))},this.logger=e.createZLogger("db",["adapter-manager"])}registerListenersForAdapter(e){const t=e=>{this.dispatchEvent(e)};this.removeListenersData.push(e.addEventListener(d.b.SuccessOpenDB,t)),this.removeListenersData.push(e.addEventListener(d.b.LongOpenDB,t)),this.removeListenersData.push(e.addEventListener(d.b.TimeConsumingQuery,t)),this.removeListenersData.push(e.addEventListener(d.b.ConnectionClosedAbnormally,t)),this.removeListenersData.push(e.addEventListener(d.b.SchemaMigratedAbnormally,t)),this.removeListenersData.push(e.addEventListener(d.b.Warning,t))}onDispose(){this.removeListenersForAllAdapters()}async getDatabaseAdapter(e,t){const s=this.getAdapterFactoryToken(t.type),i=n.ModuleContainer.resolve(s),a=await i.createAdapter(e,t);return this.registerListenersForAdapter(a),a}async canUse(e){return e!==o.a.SQLite||await this.canIUseSQLite()}async canIUseSQLite(){return!1}getAdapterFactoryToken(e){return e===o.a.IDB?l.b:l.c}getExistedPartitionKeys(e,t){const s=this.getAdapterFactoryToken(t);return n.ModuleContainer.resolve(s).getExistedPartitionKeys(e)}})||i)||i)||i)||i)||i;n.ModuleContainer.registerSingleton(c.b,h)},"1BPm":function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i={UnknownError:-1,FileNotFound:0,ReadEmptyFile:1,WorkerNotFound:2,WorkerNotReady:3,BadFileDescriptorNodeJS:4}},22:function(e,t){},"3a9X":function(e,t,s){"use strict";s.r(t),s.d(t,"initWebWorker",(function(){return m})),s.d(t,"getFileSize",(function(){return p})),s.d(t,"readRange",(function(){return f})),s.d(t,"writeRange",(function(){return v})),s.d(t,"initBinaryLogFile",(function(){return b})),s.d(t,"getWebLogFileAsBuffer",(function(){return y}));var i=s("Tv80"),a=s("OgkW"),n=s.n(a);class r{constructor(){this.worker=void 0,this._eventEmitter=new n.a,this.postMessage=e=>{this.worker.postMessage(e)},this.subscribeMessages=()=>(this.worker.addEventListener("message",this._handleMessageFromFromWorker),()=>{this.worker.removeEventListener("message",this._handleMessageFromFromWorker)}),this.unsubscribeMessages=()=>{this.worker.removeEventListener("message",this._handleMessageFromFromWorker)},this.terminate=()=>{this.worker.terminate(),this.worker.removeEventListener("message",this._handleMessageFromFromWorker)},this._handleMessageFromFromWorker=e=>{const{data:t}=e;switch(t.type){case i.a.onWorkerReady:this._emit(i.a.onWorkerReady,{});break;case i.a.responseFileSize:{const e=t.payload;this._emit(i.a.responseFileSize,e);break}case i.a.responseInitBinaryFile:{const e=t.payload;this._emit(i.a.responseInitBinaryFile,e);break}case i.a.responseReadRange:{const e=t.payload;this._emit(i.a.responseReadRange,e);break}case i.a.responseWriteRange:{const e=t.payload;this._emit(i.a.responseWriteRange,e);break}case i.a.responseGetWebLogFileAsBuffer:{const e=t.payload;this._emit(i.a.responseGetWebLogFileAsBuffer,e);break}}},this.worker=new Worker(__SRC_OPFS_WORKER__),this.worker.addEventListener("message",this._handleMessageFromFromWorker)}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}_emit(e,t){this._eventEmitter&&e in i.a&&this._eventEmitter.emit(e,t)}}var o=s("5FGm"),d=s("1BPm"),l=s("JRkD");let c=null,h=()=>{},u=!1;const g=()=>{c&&(self.removeEventListener("beforeunload",g),c.postMessage({type:i.b.closeWorker}),c.unsubscribeMessages(),c.terminate(),c=null,h=()=>{},u=!1)},m=e=>{if(!c){h=e,c=new r,c.subscribeMessages();const t=c.on(i.a.onWorkerReady,(()=>{u=!0,h(),t()}));self.addEventListener("beforeunload",g)}return c},p=async e=>new Promise(((t,s)=>{try{Object(l.a)(!!c,"oPFSWorker not initialized"),Object(l.a)(u,"oPFSWorker not ready"),c.postMessage({type:i.b.getFileSize,payload:{filePath:e}});const s=a=>{const{data:n}=a;switch(n.type){case i.a.responseFileSize:{const a=n.payload;a.filePath===e&&(c.off(i.a.responseFileSize,s),t(a.response));break}}};c.on(i.a.responseFileSize,s)}catch(a){s(o.c.Failure({code:d.a.UnknownError,message:`getFileSize failed for ${e}`}))}})),f=async(e,t,s)=>new Promise(((a,n)=>{try{Object(l.a)(!!c,"oPFSWorker not initialized"),Object(l.a)(u,"oPFSWorker not ready"),c.postMessage({type:i.b.readRange,payload:{filePath:e,start:t,end:s}});const n=t=>{var s;const r=t;r.filePath===e&&a(r.response),null===(s=c)||void 0===s||s.off(i.a.responseReadRange,n)};c.on(i.a.responseReadRange,n)}catch(r){n(o.c.Failure({code:d.a.UnknownError,message:`getFileSize failed for ${e}`}))}})),v=async(e,t,s)=>new Promise(((a,n)=>{try{Object(l.a)(!!c,"oPFSWorker not initialized"),Object(l.a)(u,"oPFSWorker not ready"),c.postMessage({type:i.b.writeRange,payload:{filePath:e,offset:t,data:s}});const n=t=>{var s;const r=t;r.filePath===e&&a(r.response),null===(s=c)||void 0===s||s.off(i.a.responseWriteRange,n)};c.on(i.a.responseWriteRange,n)}catch(r){n(o.c.Failure({code:d.a.UnknownError,message:`getFileSize failed for ${e}`}))}})),b=async(e,t)=>new Promise(((s,a)=>{try{Object(l.a)(!!c,"oPFSWorker not initialized"),Object(l.a)(u,"oPFSWorker not ready"),c.postMessage({type:i.b.initBinaryLogFile,payload:{filePath:e,initData:t}});const a=t=>{var n;const r=t;r.filePath===e&&s(r.response),null===(n=c)||void 0===n||n.off(i.a.responseInitBinaryFile,a)};c.on(i.a.responseInitBinaryFile,a)}catch(n){a(o.c.Failure({code:d.a.UnknownError,message:`getFileSize failed for ${e}`}))}})),y=async()=>new Promise(((e,t)=>{const s="web.calf";try{Object(l.a)(!!c,"oPFSWorker not initialized"),Object(l.a)(u,"oPFSWorker not ready"),c.postMessage({type:i.b.getWebLogFileAsBuffer,payload:{filePath:s}});const t=s=>{var a;const n=s;"web.calf"===n.filePath&&e(n.response),null===(a=c)||void 0===a||a.off(i.a.responseGetWebLogFileAsBuffer,t)};c.on(i.a.responseGetWebLogFileAsBuffer,t)}catch(a){t(o.c.Failure({code:d.a.UnknownError,message:`getFileSize failed for ${s}`}))}}))},"5FGm":function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return n}));const i=Object.freeze({Success:e=>({type:"SUCCESS",data:e}),Failure:e=>({type:"ERROR",data:e})}),a="cal";let n=function(e){return e[e.None=0]="None",e[e.FlushNow=1]="FlushNow",e[e.FlushOnNextRun=2]="FlushOnNextRun",e}({})},"5l/R":function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i=s("jDHv");const a=Object(i.define)("zlog-writer-manager")},"5yGw":function(e,t,s){"use strict";var i=s("jDHv"),a=s("Mgpg"),n=s("DI/x"),r=s("wH4e"),o=s("+iAT");var d,l=s("d/or"),c=s("teaq");let h=i.ModuleContainer.injectable()(d=function(e,t){return i.ModuleContainer.inject(l.a)(e,void 0,0)}(d=function(e,t){return i.ModuleContainer.inject(a.ZLoggerFactory)(e,void 0,1)}(d=Reflect.metadata("design:type",Function)(d=Reflect.metadata("design:paramtypes",[void 0===l.a?Object:l.a,void 0===a.ZLoggerFactory?Object:a.ZLoggerFactory])(d=class{constructor(e,t){this.settingsManager=e,this.configFactory=void 0,this.getDatabaseBaseConfigFn=void 0,this.configCache=void 0,this.session=null,this.logger=void 0,this.logger=t.createZLogger("db",["config"]),this.configCache=new Map}getDatabaseBaseConfig(e){if(!this.getDatabaseBaseConfigFn)throw new n.g("Config manager hasn't been installed yet!");const t=this.getDatabaseBaseConfigFn(e);if(void 0===t)throw new n.g(`No base config found for '${e}' database`);return t}authenticate(e){this.logger.zsymb(0,"mBNrfa","Clear cache due to new session"),this.clearCache(),this.session=e,this.settingsManager.init(e.userId)}install(e,t){this.configFactory=(t,s)=>{let i=e(t,s);return void 0===i&&(i=((e,t)=>t===r.AdapterType.IDB?"Meta"===e?o.a.useIdb:void 0:t===r.AdapterType.SQLite&&"Meta"===e?o.a.useSqlite:void 0)(t,s)),i},this.getDatabaseBaseConfigFn=e=>{let s=t(e);return void 0===s&&(s=(e=>{if("Meta"===e)return o.a.baseConfig})(e)),s}}async getDatabaseConfigs(e){const t=this.configCache.get(e);return t||await this.createConfigCache(e)}clearCache(){const e=this.configCache.values();let t=e.next();for(;!t.done;){t.value.forEach((e=>{e.clearCache()})),t=e.next()}this.configCache.clear()}async createConfigCache(e){const t=[],s=await this.getCurrentConfig(e);return s&&t.push(s),this.configCache.has(e)||this.configCache.set(e,t),t}async getCurrentConfig(e){if(!this.getDatabaseBaseConfigFn)throw new n.g("Config manager hasn't been installed yet!");const t=this.getDatabaseBaseConfigFn(e);if(void 0===t)throw new n.g(`Missing base config for '${e}' database`);const{session:s}=t;let i=null;if(s){if(null===this.session)throw new n.g("Config manager hasn't been authenticated yet!");i=await this.settingsManager.getAdapterTypeOfUserScopedDatabases(this.session.userId)}else i=await this.settingsManager.getAdapterTypeOfSharedDatabases();if("number"!=typeof i)throw new n.g(`${i} is not a valid AdapterType value!`);return this.configFactory(e,i)}})||d)||d)||d)||d)||d;i.ModuleContainer.registerSingleton(c.b,h)},BtX6:function(e,t,s){s("E2g8").polyfill()},HD3z:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i=!0},HPcM:function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return n}));var i=s("jDHv");const a=Object(i.define)("zlog-sentry-bucket"),n=Object(i.define)("zlog-regular-bucket")},HWGt:function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var i=s("PmZf"),a=s("YZti"),n=s("1UUk"),r=s("jDHv"),o=s("Mk04"),d=s("Mgpg");class l{handleOutOfMemError(e){}handleInvalidVersionError(e){}handleMissingStoreError(e){}handleExceedingLimitInReopeningDBConnection(e){}handleQueryExec(e){}handleSuccessOpenDB(e){}handleConnectionClosedAbnormally(e){}handleSchemaMigratedAbnormally(e){}handleLongOpenDB(e){}handleTimeConsumingQuery(e,t){}handleQueryError(e){}handleWarning(e){}constructor(){this.logger=void 0,this.logErrorMessageOnce=Object(o.a)((e=>{this.logger.zsymb(18,"5AOLKH",e)})),this.dispose=()=>{};const e=r.ModuleContainer.resolve(d.ZLoggerFactory);this.logger=e.createZLogger("db",["event-handler"])}start(){const e=r.ModuleContainer.resolve(n.b),t=e=>{const{data:t}=e;this.handleQueryExec(t)},s=e=>{const{error:t}=e;a.b.isOutOfMemError(t)?(this.logErrorMessageOnce(`OutOfMemError: ${t.message}`),this.handleOutOfMemError(t)):a.b.isInvalidVersionError(t)?(this.logErrorMessageOnce(`${t}`),this.handleInvalidVersionError(t)):a.b.isMissingTableError(t)?(this.logErrorMessageOnce(`${t}`),this.handleMissingStoreError(t)):a.b.isFailedToOpenConnectionError(t)&&(this.logErrorMessageOnce(`${t}`),this.handleExceedingLimitInReopeningDBConnection(t)),this.handleQueryError(t)},o=e=>{this.handleSuccessOpenDB(e.data)},d=e=>{this.handleLongOpenDB(e.data)},l=e=>{const{logInfo:t,totalTime:s}=e;this.handleTimeConsumingQuery(t,s)},c=e=>{this.logErrorMessageOnce(`DB connection closed abnormally: '${e.database}'`),this.handleConnectionClosedAbnormally(e)},h=e=>{this.logErrorMessageOnce(`Schema migrated abnormally: '${e.data}'`),this.handleSchemaMigratedAbnormally(e)},u=e=>{this.handleWarning(e.data)};e.addEventListener(i.b.QueryExec,t),e.addEventListener(i.b.QueryError,s),e.addEventListener(i.b.SuccessOpenDB,o),e.addEventListener(i.b.LongOpenDB,d),e.addEventListener(i.b.TimeConsumingQuery,l),e.addEventListener(i.b.ConnectionClosedAbnormally,c),e.addEventListener(i.b.SchemaMigratedAbnormally,h),e.addEventListener(i.b.Warning,u),this.dispose=()=>{e.removeEventListener(i.b.QueryExec,t),e.removeEventListener(i.b.QueryError,s),e.removeEventListener(i.b.SuccessOpenDB,o),e.removeEventListener(i.b.LongOpenDB,d),e.removeEventListener(i.b.TimeConsumingQuery,l),e.removeEventListener(i.b.ConnectionClosedAbnormally,c),e.removeEventListener(i.b.SchemaMigratedAbnormally,h),e.removeEventListener(i.b.Warning,u)}}}},K8kB:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i=s("jDHv");const a=Object(i.define)("zlog-write-scheduler")},KRcn:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i=s("PLj1");function a(){let e;try{switch(__ZaBUNDLENAME__.toLocaleLowerCase()){case"main":e=i.b.Main;break;case"web":e=i.b.Web;break;case"login":e=i.b.Login;break;case"photo":e=i.b.Photo;break;case"render":e=i.b.Render;break;case"shared-worker":e=i.b.SharedWorker;break;case"preload-shared-worker":e=i.b.PreloadSharedWorker;break;case"preload-sqlite":e=i.b.PreloadSQLite;break;case"utility-process-sqlite":e=i.b.UProcessSQLite;break;default:e=i.b.Unknown}}catch{e=i.b.Unknown}return e}},KdAX:function(e,t,s){"use strict";var i=s("jDHv"),a=s("W8fB"),n=s("UJDs"),r=s("7FSS"),o=(s("j6JD"),s("VTBJ"));const d=s("4JQ2"),l={intro:e=>l.eol(e),info:e=>e,debug:e=>e,warning:e=>e,error:e=>e,placeholder:e=>e,tick:e=>e,header:e=>d.green(e),sourcemap:e=>d.gray(e),level:e=>e,bold:e=>d.bold(e),eol:e=>e+"\n\n"},c=(Object(o.a)(Object(o.a)({},l),{},{intro:e=>l.eol(d.bgWhite.black(e)),info:e=>d.white(e),debug:e=>d.blue(e),warning:e=>d.yellow(e),error:e=>d.red(e),tick:e=>d.black.bgWhite.bold(` ${e} `),header:e=>e}),l);s("CDcE");const h={display:!0,style:"font-size: 11px; color: gray"},u={display:!1,style:"font-size: 11px; color: gray; margin-bottom: 8px"};function g({metadata:e,args:t}){const s=e.tags.join("|");let i=t.map((e=>function(e){let t=e;if("function"==typeof e)try{t=e()}catch(s){r.a.error("ZLogSanitizer: failed to exec func. Please make sure your func executable"+s),t=e.toString()}return t}(e)));1===i.length&&1===t.length&&"function"==typeof t[0]&&Array.isArray(i[0])&&(i=i[0]);const a=function(e,t){if(null===e)return"";const s="{}";let i=0;for(;-1!==e.search(s)&&i<t.length;)switch(typeof t[i++]){case"number":e=e.replace(s,"%d");break;case"string":default:e=e.replace(s,"%s");break;case"object":e=e.replace(s,"%o")}return e}(e.template.length>0?e.template[0]:null,i).trim(),n=(e.ln.toString().substring(e.ln.toString().indexOf("src")),""),o=[];return u.display&&n.trim()&&o.push(c.sourcemap(n)+"\n"),h.display&&s.trim()&&o.push(c.sourcemap(s.trim())+"\n"),a.trim()&&o.push(a.trim()),i.length>0?(i.unshift(o.join(" ")),i):[o.join(" ")]}var m;let p=Object(i.injectable)()(m=class{write(e){const t=g(e),s=globalThis.zconsole||console;switch(e.metadata.level){case n.b.info:s.info.apply(s,t);break;case n.b.warn:s.warn.apply(s,t);break;case n.b.debug:s.debug.apply(s,t);break;case n.b.error:s.error.apply(s,t);break;default:s.log.apply(s,t)}}})||m;i.ModuleContainer.registerSingleton(a.a,p)},Lp8g:function(e,t){globalThis.hasOwnProperty("$recoilDebugStates")&&(globalThis.$recoilDebugStates.push=function(...e){this.length>=100&&Array.prototype.splice.apply(this,[0,Math.round(this.length/2)]),Array.prototype.push.apply(this,e)})},Lq8m:function(e,t,s){"use strict";var i,a=s("jDHv"),n=s("Uzj0"),r=s("Mgpg"),o=s("tHMN"),d=s("8eps"),l=s("oM1A"),c=s("zpw2"),h=s("Mk04"),u=s("LzQZ"),g=s("pjo1");let m=a.ModuleContainer.injectable()(i=function(e,t){return a.ModuleContainer.inject(o.b)(e,void 0,0)}(i=function(e,t){return a.ModuleContainer.inject(u.a)(e,void 0,1)}(i=function(e,t){return a.ModuleContainer.inject(d.a)(e,void 0,2)}(i=function(e,t){return a.ModuleContainer.inject(r.ZLoggerFactory)(e,void 0,3)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===o.a?Object:o.a,void 0===u.a?Object:u.a,void 0===d.a?Object:d.a,void 0===r.ZLoggerFactory?Object:r.ZLoggerFactory])(i=class{constructor(e,t,s,i){this.engine=e,this.transactionManager=t,this.internalData=s,this.loggerFactory=i,this.logger=void 0,this.logger=this.loggerFactory.createZLogger("db",["client"]),this.internalData.install(n.e.map(l.a,((e,t)=>this.createBuilder(e,t))))}createQueryBuilder(e){const t=n.e.map(e,((e,t)=>this.createBuilder(e,t)));return t.deleteAllDatabases=Object(h.a)(this.engine.deleteAllDatabases.bind(this.engine)),t.closeAllDatabases=Object(h.a)(this.engine.closeAllDatabases.bind(this.engine)),t.getAvailableDBBasicInfos=this.engine.getAvailableDBBasicInfos.bind(this.engine),t}createBuilder(e,t,s){return new c.a(this.engine,this.transactionManager,e,t,s)}})||i)||i)||i)||i)||i)||i)||i;a.ModuleContainer.registerSingleton(g.a,m)},Lrq5:function(e,t,s){"use strict";function i(e){return"number"==typeof e}function a(e){return"string"==typeof e}function n(e){return"boolean"==typeof e}function r(e){return"object"==typeof e}function o(e){return"function"==typeof e}function d(e){return void 0===e}function l(e){return null===e}s.d(t,"d",(function(){return i})),s.d(t,"f",(function(){return a})),s.d(t,"a",(function(){return n})),s.d(t,"e",(function(){return r})),s.d(t,"b",(function(){return o})),s.d(t,"g",(function(){return d})),s.d(t,"c",(function(){return l}))},Mk04:function(e,t,s){"use strict";function i(e){let t={};return async(...s)=>{const i=s.length?s.join("-"):"";if(!t[i])return t[i]=!0,e(...s)}}s.d(t,"a",(function(){return i}))},PLj1:function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"c",(function(){return n})),s.d(t,"a",(function(){return r}));var i=s("fsQs");let a=function(e){return e.Main="main",e.Render="render",e.SharedWorker="shared-worker",e.PreloadSharedWorker="preload-shared-worker",e.Unknown="unknown",e.Photo="photo",e.Web="web",e.Embed="embed",e.Login="login",e.PreloadSQLite="preload-sqlite",e.UProcessSQLite="u-process-sqlite",e}({});const n={[a.Main]:i.f,[a.Render]:i.f,[a.SharedWorker]:i.f,[a.PreloadSharedWorker]:i.g,[a.PreloadSQLite]:i.f,[a.Unknown]:i.f,[a.Photo]:i.f,[a.Web]:i.h,[a.Embed]:-1,[a.Login]:i.g,[a.UProcessSQLite]:i.g},r=[a.Embed,a.Unknown]},QxEN:function(e,t,s){"use strict";var i=s("YrRS"),a=s("eBEg");let n;n="undefined"!=typeof window&&globalThis.zconsole||console;const r=function(){},o={release:["log","debug","trace"]};if(n){for(const[t,s]of Object.entries(o))if("release"===t)for(const e of s)n[e]=r;globalThis.zconsole=n;const e=a.a.create(["zconsole","nullLogger"],{});Object(i.a)(e,!0)}},SF1S:function(e,t){},SGjP:function(e,t,s){"use strict";s.r(t),s.d(t,"appendTextLog",(function(){return r})),s.d(t,"archiveFileLog",(function(){return o})),s.d(t,"getFileSize",(function(){return d})),s.d(t,"readRange",(function(){return l})),s.d(t,"writeRange",(function(){return c})),s.d(t,"cleanupDescriptors",(function(){return h})),s.d(t,"initBinaryLogFile",(function(){return u}));var i=s("1BPm"),a=s("5FGm");const n=new class{constructor(){this.tracker=new Map,this.track=(e,t)=>{this.tracker.set(e,t)},this.untrack=e=>{this.tracker.delete(e)},this.getDescriptor=e=>this.tracker.get(e),this.getAllDescriptors=()=>Array.from(this.tracker.values()),this.removeAllDescriptors=()=>{this.tracker.clear()},this.removeDescriptor=e=>{this.tracker.delete(e)}}},r=async(e,t)=>{await $zFileManager.appendBufferToPath(e,t)},o=async e=>{const t=$znode.fsExtra;t.existsSync(e)&&t.renameSync(e,e+".old")},d=async e=>{const t=$znode.fs;if(!t.existsSync(e))return 0;return t.statSync(e).size},l=async(e,t,r)=>{try{const o=s("cSWM");let d=n.getDescriptor(e);if(!o.existsSync(e))return d&&(o.closeSync(d),n.removeDescriptor(e)),a.c.Failure({code:i.a.FileNotFound,message:`readRange failed for ${e}`});d||(d=o.openSync(e,"r+"),n.track(e,d));const l=new Uint8Array(r-t);return o.readSync(d,l,0,r-t,t),a.c.Success(l)}catch(o){return a.c.Failure({code:i.a.UnknownError,message:`readRange failed for ${e}`})}},c=async(e,t,r)=>{const o=s("cSWM");let d=n.getDescriptor(e);if(!o.existsSync(e))return d&&(o.closeSync(d),n.removeDescriptor(e)),o.writeFileSync(e,r),a.c.Success(null);d||(d=o.openSync(e,"r+"),n.track(e,d));let l=!1;try{o.writeSync(d,r,0,r.byteLength,t)}catch(c){if("object"!=typeof c||"EBADF"!==c.code)return a.c.Failure({code:i.a.BadFileDescriptorNodeJS,message:`initBinaryLogFile failed for ${e}`});(e=>{if("number"==typeof e)try{s("cSWM").closeSync(e)}catch(c){}})(d),n.removeDescriptor(e),l=!0}return l&&(d=o.openSync(e,"r+"),n.track(e,d),o.writeSync(d,r,0,r.byteLength,t)),a.c.Success(null)},h=async()=>{const e=s("cSWM"),t=n.getAllDescriptors();for(const s of t)try{e.closeSync(s)}catch{}n.removeAllDescriptors()},u=async(e,t)=>{try{const o=s("cSWM");let d=n.getDescriptor(e);d&&(o.closeSync(d),n.removeDescriptor(e));try{o.writeFileSync(e,t)}catch(r){return a.c.Failure({code:i.a.UnknownError,message:`initBinaryLogFile failed for ${e}`})}return a.c.Success(null)}catch(o){return a.c.Failure({code:i.a.UnknownError,message:`initBinaryLogFile failed for ${e}`})}}},Tv80:function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return a}));let i=function(e){return e.ping="ping",e.initBinaryLogFile="initBinaryLogFile",e.getFileSize="getFileSize",e.readRange="readRange",e.writeRange="writeRange",e.getWebLogFileAsBuffer="getWebLogFileAsBuffer",e.removeFile="removeFile",e.closeWorker="closeWorker",e}({}),a=function(e){return e.pong="pong",e.onWorkerReady="onWorkerReady",e.responseInitBinaryFile="responseInitBinaryFile",e.responseFileSize="responseFileSize",e.responseReadRange="responseReadRange",e.responseWriteRange="responseWriteRange",e.responseGetWebLogFileAsBuffer="responseGetWebLogFileAsBuffer",e}({})},UJDs:function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return a}));let i=function(e){return e[e.info=0]="info",e[e.error=1]="error",e[e.warn=2]="warn",e[e.debug=3]="debug",e[e.critical=4]="critical",e}({});const a={[i.info]:"info",[i.error]:"error",[i.warn]:"warn",[i.debug]:"debug",[i.critical]:"critical"}},W8fB:function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return n})),s.d(t,"c",(function(){return r}));var i=s("jDHv");const a=Object(i.define)("sen-log-writer"),n=Object(i.define)("console-log-writer"),r=Object(i.define)("zlog-writer")},WOja:function(e,t){},Wc52:function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));var i=s("fsQs"),a=s("PLj1");const n={[a.b.Unknown]:{toConsole:!1,toFile:!1,fileInterval:i.f},[a.b.Embed]:{toConsole:!1,toFile:!1,fileInterval:-1},[a.b.Main]:{toConsole:!1,toFile:!0,fileInterval:i.f},[a.b.Login]:{toConsole:!0,toFile:!0,fileInterval:i.g},[a.b.Render]:{toConsole:!0,toFile:!0,fileInterval:i.f},[a.b.Photo]:{toConsole:!0,toFile:!0,fileInterval:i.f},[a.b.SharedWorker]:{toConsole:!1,toFile:!0,fileInterval:i.f},[a.b.PreloadSharedWorker]:{toConsole:!0,toFile:!0,fileInterval:i.f},[a.b.Web]:{toConsole:!0,toFile:!0,fileInterval:i.h},[a.b.PreloadSQLite]:{toConsole:!0,toFile:!0,fileInterval:i.f},[a.b.UProcessSQLite]:{toConsole:!1,toFile:!0,fileInterval:i.f}}},XuBa:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));const i=s("NFKh");class a{static encrypt(e){return i.AES.encrypt(e,"5dbe084b7eedNWjRref04e2rDxs01lwH",{iv:"7eb5dbe084b7eedeef04e2622d46ba00",mode:i.mode.ECB,padding:i.pad.Pkcs7})+""}static decrypt(e){return i.AES.decrypt(e,"5dbe084b7eedNWjRref04e2rDxs01lwH",{keySize:16,iv:"7eb5dbe084b7eedeef04e2622d46ba00",mode:i.mode.ECB,padding:i.pad.Pkcs7}).toString(i.enc.Utf8)}}},Y41u:function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return n}));let i=function(e){return e.RegLogBucketStatus="RegLogBucketStatus",e.SentryLogBucketStatus="SentryLogBucketStatus",e.WriteSchedulerRequestFlush="WriteSchedulerRequestFlush",e.WriterStatus="WriterStatus",e.LogBucketRequestFlush="LogBucketRequestFlush",e}({});class a{constructor(e,t){this.type=e,this.payload=t}}class n{constructor(e){this.type=e}}},Yggq:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i=new Set(["Qos"])},YrRS:function(e,t,s){"use strict";s.d(t,"b",(function(){return d})),s.d(t,"a",(function(){return c}));var i=s("jDHv"),a=s("PLj1"),n=s("KRcn"),r=s("5l/R"),o=s("XB6V");function d(){const e=Object(n.a)();if(a.a.includes(e))return;i.ModuleContainer.resolve(r.a).setupWriters();c(i.ModuleContainer.resolve(o.a).createZLogger("zconsole",["zlogger"]))}const l=function(){};function c(e,t=!1){const s=["_applyFilter","_getLevel","_transport"],i=Object.getOwnPropertyNames(e).filter((t=>"function"==typeof e[t]&&!s.includes(t)));if(globalThis.zconsole)for(const a of i)globalThis.zconsole[a]=t?l:e[a].bind(e)}},ZfyH:function(e,t){globalThis.$zcommon={},globalThis.$znode={},globalThis.$zglobalThis={},globalThis.$zresource={onClipboardChange:()=>{},onCheckIdleUpdaterBusy:()=>{},getChildUrl:()=>Promise.resolve()},globalThis.$zlogger={},globalThis.$zupdater={},globalThis.$zapp={onRequestShowPreference:()=>{},onRequestShowAbout:()=>{},beforeAppClose:()=>{},beforeAppAutoRestart:()=>{}},globalThis.$zdownload={},globalThis.$zdb={},globalThis.$zsessionManager={},globalThis.$zmulti={},globalThis.$zcall={sendDataToNative:()=>{}},globalThis.$zsharedWorker={},globalThis.$zelectron={},globalThis.$zelectronNative={},globalThis.$zuri={onNewRequest:()=>{},onRequestOpenConv:()=>{},removeListenNewRequest:()=>{},removeListenRequestOpenConv:()=>{}},globalThis.$zscreencap={onEventOs:()=>{}},globalThis.$zlogin={},globalThis.$zperf={},globalThis.$zconfig={},globalThis.$zFileManager={trustBlob:()=>{}},globalThis.$zFeatures={},globalThis.$zMsgChannel={},globalThis.$zscript={},globalThis.$zwindow={closeWindow:()=>{},expandMainWindow:()=>{},focus:()=>{},onHideWindowComplete:()=>{},removeListenHideWindowComplete:()=>{},removeListenVisibilityChange:()=>{},onVisibilityChange:()=>{}},globalThis.$zcloud={},globalThis.$zsub={$zapp:globalThis.$zapp,$zscreencap:globalThis.$zscreencap,$zuri:globalThis.$zuri,$zresource:globalThis.$zresource,$zlogger:globalThis.$zlogger,$zwindow:globalThis.$zwindow,$zFileManager:globalThis.$zFileManager,$zcall:globalThis.$zcall},globalThis.$zInAppPayment={openUrl:()=>{},closeInAppPayment:()=>{}},globalThis.$zsqlitebw={}},cF85:function(e,t,s){"use strict";var i=s("jDHv"),a=s("x9oK"),n=s("YEoC"),r=s("LzQZ"),o=s("DI/x"),d=s("PmZf"),l=s("AH6j"),c=s("1CsI");class h extends l.b{constructor(e,t){super(),this.fullname=e,this.partition=t,this.schemaVersionHistory=i.ModuleContainer.resolve(c.a)}}var u=s("g/Dz"),g=s("bSii"),m=s("3wcW");class p extends m.a{constructor(e,t,s,i){super(e,t,s,!1),this._transaction=i,this.allowMissingTable=!1}createMissingTable(e){throw new o.A("IndexedDB doesn't support create missing tables")}async _getTables(){return Array.from(this.instance.objectStoreNames)}async _createTable(e){const t=this.instance;let s={};if(e.isNonFieldlikeEntity)s={autoIncrement:!0};else{const t=e.primaryIndex;s={keyPath:Object(g.a)(t.getRealFields()),autoIncrement:t.autoIncrement}}if(t.objectStoreNames.contains(e.tableName))return;const i=t.createObjectStore(e.tableName,s);Object.values(e.indices).map((e=>{if("primary"===e.name)return;const t=e.fields.map((e=>"object"!=typeof e?e:"length"===e.type?`${e.field.toString()}.length`:e.field));i.createIndex(e.name,Object(g.a)(t),{unique:e.unique})}))}async _createIndex(e,t){const s=this._transaction;if(!s)throw new o.D(`Can't create '${t}' due to unavailable IDBTransaction transaction!`);const i=s.objectStore(e.tableName),a=e.getIndex(t),n=a.fields.map((e=>"object"!=typeof e?e:"length"===e.type?`${e.field.toString()}.length`:e.field));var r;i.indexNames.contains(t)||i.createIndex(t,1===(r=n).length?r[0]:r,{unique:a.unique})}_addColumns(e,t){return Promise.resolve()}}class f extends h{async create(){let e=null;const t=(t,s)=>(null===e&&(e=new p(this.fullname,this.partition,t,s)),e.addEventListener(d.b.SchemaMigratedAbnormally,(e=>this.dispatchEvent(e))),e),s=this.schemaVersionHistory,i=Date.now(),a=await new Promise(((e,i)=>{const a=indexedDB.open(this.fullname,this.partition.version);a.onupgradeneeded=async e=>{if(null!==e.newVersion)try{const s=t(a.result,a.transaction);await s.upgrade(e.oldVersion,e.newVersion)}catch(s){throw a.transaction.abort(),s}},a.onsuccess=async()=>{try{const i=a.result,r=t(i,a.transaction);await r.validate(),s.updateSchemaVersion(n.a.IDB,this.fullname,i.version),e(i)}catch(r){i(r)}},a.onerror=()=>{let e=a.error;e=u.a.isVersionError(e)?new o.p({fullname:this.fullname,currentVersion:u.a.getCurrentVersionFromVersionError(e),requestedVersion:this.partition.version}):new o.l(e.message),i(e)},a.onblocked=()=>{var e;const t=new o.l((null===(e=a.error)||void 0===e?void 0:e.message)||"");i(t)}})),r=Date.now(),l={fullname:this.fullname,adapterType:n.a.IDB,startTime:i,endTime:r};this.dispatchEvent(new d.h(l));return r-i>=2e4&&this.dispatchEvent(new d.c(l)),a.onversionchange=function(e){if(null===e.newVersion){e.target.close()}},a}}var v,b=s("Mgpg"),y=s("UK4g"),I=s("YZti"),_=s("8/YW");let C=Object(_.g)()(v=Reflect.metadata("design:type",Function)(v=Reflect.metadata("design:paramtypes",[void 0===h?Object:h])(v=class extends l.b{constructor(e){super(),this.removeListeners=()=>{},this.registerListeners(e)}onDispose(){this.removeListeners()}registerListeners(e){const t=e=>{this.dispatchEvent(e)},s=[];s.push(e.addEventListener(d.b.SuccessOpenDB,t)),s.push(e.addEventListener(d.b.LongOpenDB,t)),s.push(e.addEventListener(d.b.SchemaMigratedAbnormally,t)),this.removeListeners=()=>s.forEach((e=>e()))}})||v)||v)||v,O=null;const S=()=>{if(null===O){const e=i.ModuleContainer.resolve(b.ZLoggerFactory);O=e.createZLogger("idb",["connection"])}return O};class E extends C{constructor(e){super(e),this.connectionFactory=e,this.connection=null,this.isManuallyClose=!1,this.reOpenCountIn1Hour=0,this.firstTimeReOpenDttm=null,this.onAbnormallyCloseListeners=[],this.failedToOpenDBConnectionErrorMessage=""}get hasActiveConnection(){return null!==this.connection}async getName(){return(await this.getConnection()).name}async getObjectStoreNames(){return(await this.getConnection()).objectStoreNames}async getVersion(){return(await this.getConnection()).version}canReOpenConnection(){return this.reOpenCountIn1Hour<=y.h}updateReopenMetadata(){const e=Date.now();null===this.firstTimeReOpenDttm||(()=>Math.abs(e-this.firstTimeReOpenDttm)>=36e5)()?(this.firstTimeReOpenDttm=e,this.reOpenCountIn1Hour=1):this.reOpenCountIn1Hour+=1}async getConnection(e=!1){const t=async()=>{let e=null;try{e=await this.connectionFactory.create()}catch(t){if(I.b.isFailedToOpenConnectionError(t)){return S().zsymb(18,"ltU29g",`${t}`),this.failedToOpenDBConnectionErrorMessage=t.message,new Promise(((e,t)=>{setTimeout((()=>{this.getConnection(!0).then(e).catch(t)}))}))}throw t}return e.onclose=()=>{var t;this.dispatchEvent(new d.a((null===(t=e)||void 0===t?void 0:t.name)||""))},e};if(e){if(this.isManuallyClose)throw new o.c("The database connection has manually been closed!",["idb"]);if(this.updateReopenMetadata(),!this.canReOpenConnection()){const e=this.failedToOpenDBConnectionErrorMessage;throw this.failedToOpenDBConnectionErrorMessage="",new o.l(e)}const e=this.connection;e&&this.onAbnormallyCloseListeners.forEach((t=>{e.removeEventListener("close",t)})),this.connection=await t()}else this.connection||(this.connection=await t());return this.connection}async getTransaction(e,t){let s=await this.getConnection(),i=null;try{i=s.transaction(e,t)}catch(a){if(!a||!u.a.isInvalidStateError(a))throw a;s=await this.getConnection(!0),i=s.transaction(e,t)}return i}close(){this.connection&&!this.isManuallyClose&&(this.connection.close(),this.connection=null,this.isManuallyClose=!0)}}var M=s("VTBJ"),T=s("X2RP");class w extends T.a{constructor(e,t){super(),this.instance=e,this.transactionManager=t}getExecutorName(){return"idb"}async clear({transaction:e,meta:t,deferrer:s}){const i=t.tableConfig,a=(await this.getStore(e,i,n.g.READWRITE,s.reject)).clear();return Object(u.e)(a)}async get({transaction:e,meta:t,params:s,deferrer:i}){const a=s.index,n=s.key,r=t.tableConfig,o=await this.getStoreOrIndex(e,r,a,i.reject),d=this.validateKey(r,a,n),l=o.get(d);return this.getResult(r,l)}async getMulti({transaction:e,meta:t,params:s,deferrer:i}){const{index:a,keys:n,onValue:r}=s,o=t.tableConfig,d=await this.getStoreOrIndex(e,o,a,i.reject),l=n.map((async e=>{const t=this.validateKey(o,a,e),s=d.get(t),i=await this.getResult(o,s);return r&&r(i),i}));return Promise.all(l)}async getMultiIfExists({transaction:e,meta:t,params:s,deferrer:i}){const a=s.index,n=s.keys,r=t.tableConfig,o=await this.getStoreOrIndex(e,r,a,i.reject),d=n.map((e=>{const t=this.validateKey(r,a,e),s=o.get(t);return this.getResult(r,s)}));return Promise.all(d).then((e=>e.filter(Boolean)))}getAll(e){return e.params.direction===n.c.PREV||e.params.direction===n.c.PREV_UNIQUE||e.params.filter||e.params.predicate||e.params.aborted||e.params.onProgress||e.params.onValue||e.params.useKeyRangeV2&&e.params.range&&Object(u.f)(e.params.range)?this.getAllByCursor(e):this.getAllWithoutFilter(e)}async getAllKeyByCursor({meta:e,params:t,transaction:s,deferrer:i}){const a=e.tableConfig,n=t.useKeyRangeV2,r=this.toIDBKeyRange(t.range),o=(await this.getStoreOrIndex(s,a,t.index,i.reject)).openKeyCursor(r,t.direction);return null===o?[]:new Promise(((e,s)=>{const i=[];o.onsuccess=()=>{const s=o.result;if(null===s||null===s.primaryKey)return void e(i);if(n&&t.range&&Object(u.f)(t.range)){const e=Object(u.d)(s.key,r,t.direction);if(null!==e)return void s.continue(e)}const a=s.primaryKey;i.push(a);i.length>=t.limit?e(i):s.continue()},o.onerror=()=>{s(o.error)}}))}async getAllKey(e){if(e.params.direction===n.c.PREV||e.params.direction===n.c.PREV_UNIQUE||e.params.useKeyRangeV2&&e.params.range&&Object(u.f)(e.params.range))return this.getAllKeyByCursor(e);{const{meta:t,params:s,transaction:i}=e,a=t.tableConfig,n=this.toIDBKeyRange(s.range),r=(await this.getStoreOrIndex(i,a,s.index,e.deferrer.reject)).getAllKeys(n,s.limit);return Object(u.e)(r)}}async getAndUpdate(e){const{transaction:t,params:s,meta:i}=e,a=s.index,r=s.updater,d=s.key,l=i.tableConfig,c=await this.getStoreOrIndex(t,l,a,e.deferrer.reject),h=this.validateKey(l,a,d),g=c.get(h),m=await this.getResult(l,g);if(void 0===m){if(!1!==s.ignoreNotFound)throw new o.f("Update undefined document");return}const p=await this.getStore(t,l,n.g.READWRITE,e.deferrer.reject),f=await r(m||{}),v=this.toDB(l,f),b=p.put(v);return await Object(u.e)(b),f}insert(e){return e.params.replace?this._insertOrReplace(e):this._insertIfNotExist(e)}insertMulti(e){return e.params.replace?this.insertOrReplaceMulti(e):this.insertIfNotExistMulti(e)}async update(e){const{transaction:t,meta:s,params:i,deferrer:a}=e,r=s.tableConfig,o=await this.getStore(t,r,n.g.READWRITE,a.reject);return this._update(o,this.validateKey(r,i.index,i.key),i.attributes,this.toDB(r,i.value,!1),i.index,i.ignoreNotFound).then((({fail:e})=>!e.length))}async updateMulti(e){const{transaction:t,meta:s,params:i}=e,a=s.tableConfig,r=await this.getStore(t,a,n.g.READWRITE,e.deferrer.reject),o={success:[],fail:[]},d=i.patches.map((t=>this._update(r,this.validateKey(a,i.index,t.key),t.attributes,this.toDB(a,t.value,!1),i.index,i.ignoreNotFound).then((({success:t,fail:s})=>{o.success.push(...this.fromDB(e.meta.tableConfig,t)),o.fail.push(...this.fromDB(e.meta.tableConfig,s))}))));return Promise.all(d).then((()=>o))}async delete({transaction:e,meta:t,params:s,deferrer:i}){const a=t.tableConfig,r=s.index,o=this.validateKey(a,r,s.key),d=await this.getStore(e,a,n.g.READWRITE,i.reject);if("primary"===r){const e=d.delete(o);return this.checkReqSuccessOrFail(e)}{const e=d.index(r),t=this.toIDBKeyRange({from:o,to:o}),s=e.getAllKeys(t),i=(await Object(u.e)(s)).map((e=>{const t=d.delete(e);return Object(u.e)(t)}));return Promise.all(i).then((()=>!0)).catch((()=>!1))}}async deleteMulti({transaction:e,meta:t,params:s,deferrer:i}){const a=t.tableConfig,r=s.index,o=await this.getStore(e,a,n.g.READWRITE,i.reject),d=s.keys.map((e=>this.validateKey(a,r,e)));let l=[];const c={success:[],fail:[]};if("primary"===r)l=d.map((e=>{const t=o.delete(e);return this.checkReqSuccessOrFail(t).then((t=>{t?c.success.push(e):c.fail.push(e)}))}));else{const e=o.index(r);l=d.map((async t=>{const s=this.toIDBKeyRange({from:t,to:t}),i=(await Object(u.e)(e.getAllKeys(s))).map((e=>Object(u.e)(o.delete(e))));return Promise.all(i).then((()=>{c.success.push(t)})).catch((()=>{c.fail.push(t)}))}))}return Promise.all(l).then((()=>c))}async count({transaction:e,meta:t,params:s,deferrer:i}){const a=t.tableConfig,n=this.toIDBKeyRange(s.range),r=s.useKeyRangeV2,o=await this.getStoreOrIndex(e,a,s.index,i.reject);if(r&&s.range&&Object(u.f)(s.range)){const e=o.openKeyCursor(n);return null===e?0:new Promise(((t,s)=>{let i=0;e.onsuccess=()=>{const s=e.result;if(null===s||null===s.primaryKey)return void t(i);const a=Object(u.d)(s.key,n);null===a?(i+=1,s.continue()):s.continue(a)},e.onerror=()=>{s(e.error)}}))}{const e=o.count(n);return Object(u.e)(e)}}async findAndDelete({transaction:e,meta:t,params:s,deferrer:i}){const a=t.tableConfig,{filter:r,index:o,useKeyRangeV2:d}=s,l=r?e=>Object(u.b)(e,r):null,c=this.toIDBKeyRange(s.range);let h=await this.getStore(e,a,n.g.READWRITE,i.reject);"primary"!==o&&(h=h.index(o));const g=h.openCursor(c);return null===g?[]:new Promise(((e,t)=>{let i=new Set,n=!1;g.onsuccess=()=>{if(n)return;const t=g.result;if(null===t||null===t.value)return n=!0,void e(Array.from(i));if(d&&s.range&&Object(u.f)(s.range)){const e=Object(u.d)(t.key,c);if(e)return void t.continue(e)}const r=this.fromDB(a,t.value);if(!l||l(r)){t.delete();const s=t.key;if(i.add(s),n)return void e(Array.from(i))}t.continue()},g.onerror=()=>{t(g.error)}}))}async getAllByCursor({transaction:e,meta:t,params:s,deferrer:i}){const a=t.tableConfig,{onProgress:n,advance:r,stepCount:d,onValue:l,predicate:c,filter:h,useKeyRangeV2:g}=s;if(c&&h){const e=new o.o("Query using both 'filter' and 'predicate' is not allowed!");return void(null==i||i.reject(e))}let m=null;(c||h)&&(m=c||(e=>Object(u.b)(e,h)));const p=await this.getStoreOrIndex(e,a,s.index,i.reject),f=this.toIDBKeyRange(s.range),v=p.openCursor(f,s.direction);return null===v?[]:new Promise(((e,t)=>{const i=[];let o=!1,c=!!r;v.onsuccess=()=>{if(o)return;const t=v.result;if(null===t||null===t.value)return o=!0,void e(i);if(c&&r)return c=!1,void t.advance(r);if(g&&s.range&&Object(u.f)(s.range)){const e=Object(u.d)(t.key,f,s.direction);if(e)return void t.continue(e)}const h=this.fromDB(a,t.value);l&&l(h),m&&!m(h)||(i.push(h),n&&n(i,h),o=i.length>=s.limit,o||(o=!!s.aborted&&s.aborted(i,h)),!o)?(d&&t.advance(d),t.continue()):e(i)},v.onerror=()=>{t(v.error)}}))}async getAllWithoutFilter({transaction:e,meta:t,params:s,deferrer:i}){const a=t.tableConfig,n=this.toIDBKeyRange(s.range),r=(await this.getStoreOrIndex(e,a,s.index,i.reject)).getAll(n,s.limit);return this.getResult(a,r)}async getStoreOrIndex(e,t,s,i){const a=await this.getStore(e,t,n.g.READONLY,i);if("primary"===s)return a;const r=t.getIndex(s);if(!r)throw new o.v(s);return a.index(r.name)}async _insertIfNotExist(e){const{transaction:t,meta:s,params:i}=e,a=s.tableConfig,r=await this.getTransaction(t,a,n.g.READWRITE,e.deferrer.reject),o=r.objectStore(a.tableName);let d=null;if(!a.isNonFieldlikeEntity){const e=a.primaryIndex;if(!e.autoIncrement){const t=Object(g.a)(e.createKey(i.value)),s=o.get(t);d=await new Promise((e=>{s.onsuccess=()=>{const t=this.fromDB(a,s.result);e(t)},s.onerror=()=>{e(null)}}))}}if(d)return Promise.resolve(d);{const e=o.add(this.toDB(a,i.value)),s=await Object(u.e)(e),n=Object(u.c)(a,s,i.value);return t?n:new Promise(((t,s)=>{r.oncomplete=()=>{t(n)},r.onerror=()=>{var a;0===(null===(a=e.error)||void 0===a?void 0:a.code)?t(i.value):s(e.error)}}))}}async _insertOrReplace(e){const{transaction:t,meta:s,params:i}=e,a=s.tableConfig,r=await this.getTransaction(t,a,n.g.READWRITE,e.deferrer.reject),o=r.objectStore(a.tableName).put(this.toDB(a,i.value)),d=await Object(u.e)(o),l=Object(u.c)(a,d,i.value);return t?l:new Promise(((e,t)=>{r.oncomplete=()=>{e(l)},r.onerror=()=>{t(o.error)}}))}async insertIfNotExistMulti(e){const{transaction:t,meta:s,params:i}=e,a=s.tableConfig,r=await this.getTransaction(t,a,n.g.READWRITE,e.deferrer.reject),o=r.objectStore(a.tableName),d={success:[],fail:[]},l=i.values.map((async e=>{let t=!1;if(!a.isNonFieldlikeEntity){const s=a.primaryIndex;if(!s.autoIncrement){const i=Object(g.a)(s.createKey(e)),n=o.get(i);t=await new Promise((e=>{n.onsuccess=()=>{const t=this.fromDB(a,n.result);let s=!1;void 0!==t&&(d.success.push(t),s=!0),e(s)},n.onerror=()=>{e(!1)}}))}}if(t)return;const s=o.add(this.toDB(a,e));return this.checkReqSuccessOrFail(s).then((t=>{if(t){let t=e;if(!a.isNonFieldlikeEntity){const{primaryIndex:e}=a,i=e.fields[0].field;Object.prototype.hasOwnProperty.call(t,i)||(t[i]=s.result)}d.success.push(t)}else d.fail.push(e)})).catch((()=>{d.fail.push(e)}))}));return t?Promise.all(l).then((()=>d)):new Promise((e=>{r.oncomplete=()=>{e(d)},r.onerror=()=>{e(d)}}))}async insertOrReplaceMulti(e){const{transaction:t,meta:s,params:i}=e,a=s.tableConfig,r=await this.getTransaction(t,a,n.g.READWRITE,e.deferrer.reject),o=r.objectStore(a.tableName),d={success:[],fail:[]},l=i.values.map((e=>{const t=o.put(this.toDB(a,e));return this.checkReqSuccessOrFail(t).then((s=>{if(s){let s=e;if(!a.isNonFieldlikeEntity){const{primaryIndex:e}=a,i=e.fields[0].field;Object.prototype.hasOwnProperty.call(s,i)||(s[i]=t.result)}d.success.push(s)}else d.fail.push(e)})).catch((()=>{d.fail.push(e)}))}));return t?Promise.all(l).then((()=>d)):new Promise((e=>{r.oncomplete=()=>e(d),r.onerror=()=>e(d)}))}async _update(e,t,s,i,a,n){if("primary"===a){const a=e.get(t),r=await Object(u.e)(a);if(!r){if(n)return{success:[],fail:[]};throw new o.f("Update undefined document!")}const d=s.reduce(((e,t)=>(e[t]=i[t],e)),r),l=e.put(d);return this.checkReqSuccessOrFail(l).then((e=>e?{success:[d],fail:[]}:{success:[],fail:[r]}))}{const r=this.toIDBKeyRange({from:t,to:t}),d=e.index(a).getAll(r),l=await Object(u.e)(d);if(0===l.length){if(n)return{success:[],fail:[]};throw new o.f("Update undefined document!")}const c=l.map((e=>s.reduce(((e,t)=>(e[t]=i[t],e)),e))),h=c.map((t=>{const s=e.put(t);return Object(u.e)(s)}));return Promise.all(h).then((()=>({success:c,fail:[]}))).catch((()=>({success:[],fail:l})))}}checkReqSuccessOrFail(e){return Object(u.e)(e).then((()=>!0)).catch((()=>!1))}async getTransaction(e,t,s,i){const a=t.tableName;if(e>0){const t=this.transactionManager.get(e);return Promise.resolve(t.instance)}const n=await this.instance.getTransaction([a],s);return n.addEventListener("error",(()=>i(n.error))),n.addEventListener("abort",(()=>i(n.error))),n}async getStore(e,t,s,i){return(await this.getTransaction(e,t,s,i)).objectStore(t.tableName)}toIDBKeyRange(e){if(e){if(e.from&&e.to)try{return IDBKeyRange.bound(e.from,e.to,e.excludeFrom,e.excludeTo)}catch(t){throw t}return e.from?IDBKeyRange.lowerBound(e.from,e.excludeFrom):e.to?IDBKeyRange.upperBound(e.to,e.excludeTo):void 0}}getResult(e,t){return Object(u.e)(t).then((t=>this.fromDB(e,t)))}toDB(e,t,s=!0){try{e.validate(t,s)}catch(r){this.logger.zsymb(21,"ov3KeE",["{}: {} (database={}, table={})","FisgYw"],r.name,r.message,e.dbName,e.name)}const{isNonFieldlikeEntity:i}=e,a=e.getTransformConfigs(n.a.IDB);return function(e){if(0===a.length)return e;const t=e=>{const t=i?e:Object(M.a)({},e);return a.forEach((e=>{e.toDB(t)})),t};return Array.isArray(e)?e.map(t):t(e)}(t=e.prepareValue(t,s,i))}fromDB(e,t){const s=e.getTransformConfigs(n.a.IDB);if(0===s.length)return t;const i=e=>(s.forEach((t=>{t.fromDB(e)})),e);return Array.isArray(t)?t.map(i):i(t)}}class R{constructor(e,t){this.partition=e,this.instance=t}async beginTransaction(e){try{const t=e.params.tables.map((e=>this.partition.getTableConfig(e).tableName)),s=e.params.mode,i=await this.instance.getTransaction(t,s),a=e.transaction;e.deferrer.resolve(new L(a,i))}catch(t){e.deferrer.reject(t)}}}class L{constructor(e,t){this.id=e,this.instance=t,this.error=null,this.closed=void 0,this.onCloseListeners=[],this.closed=!1;const s=()=>{const{error:e}=t;this.closed=!0,this.error=e,this.onCloseListeners.forEach((t=>t(e))),t.removeEventListener("complete",s),t.removeEventListener("abort",s),t.removeEventListener("error",s)};t.addEventListener("complete",s),t.addEventListener("abort",s),t.addEventListener("error",s)}execute(e){return e().catch((e=>{throw this.instance.abort(),e}))}commit(){return Promise.resolve()}onClose(e){this.onCloseListeners.push(e),this.closed&&e(this.error)}}class F extends a.a{constructor(e,t,s,i,a,n){super(e,t,s,i,a,n,{})}async doesDatabaseExist(e){try{return(await function(e){const t=globalThis.indexedDB.open(e);return new Promise(((s,i)=>{t.onupgradeneeded=function(){var s;null===(s=t.transaction)||void 0===s||s.abort(),i(new A(`No database whose name is ${e} exists`))},t.onsuccess=function(){s(t.result)},t.onerror=function(){i(t.error)}}))}(e)).close(),!0}catch(t){if(t.name===D)return!1;throw t}}async deleteThisDatabase(e){super.deleteThisDatabase(e);if(!(await this.doesDatabaseExist(this.fullName)))return void this.logger.zsymb(6,"fxlfvR",`Skip db deletion due to non-existence: '${this.fullName}'`);this.instance.close();const t=indexedDB.deleteDatabase(this.fullName),s=this.instance,i=this.fullName,a=this.logger;return a.zsymb(6,"yCqYTj",`The database connection is manually closed due to database deletion: '${i}'`),new Promise(((e,n)=>{t.onsuccess=function(){a.zsymb(0,"MdrTLT",`Delete database sucessfully: '${i}'`),e()},t.onblocked=function(){a.zsymb(0,"bc6sQ4",`Delete database blocked: '${i}'`),e(),s.close()},t.onerror=function(){const e=t.error;a.zsymb(0,"9wevIs",`Failed to delete database: '${i}' - Error: ${e}`),n(e)}}))}closeThisDatabase(e){if(super.closeThisDatabase(e),!this.instance.hasActiveConnection)return Promise.resolve();this.instance.close(),this.logger.zsymb(6,"P2kOG8",`The database connection is manually closed due to manual database closing: '${this.fullName}'`);const t=void 0!==e.idbTimeout?e.idbTimeout:y.a;return new Promise((e=>{setTimeout((()=>{e()}),t)}))}static async factory(e,t){const s=new f(e,t),a=new E(s),o=i.ModuleContainer.resolve(r.a),d=new R(t,a),l=new w(a,o);return t.tables.forEach((e=>e.getTransformConfigs(n.a.IDB).forEach((e=>e.init(t.cipherKey))))),new F(t,e,o,a,l,d)}}const D="NonExistedDBError";class A extends Error{constructor(e){super(e),this.name=D}}var j;let P=i.ModuleContainer.injectable()(j=class{async createAdapter(e,t){return F.factory(e,t)}async getExistedPartitionKeys(){return[]}})||j;i.ModuleContainer.registerSingleton(a.b,P)},d951:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));class i{constructor(e){this.executor=e,this.resolve=()=>{},this.reject=()=>{}}execute(){this.executor().then(this.resolve).catch(this.reject)}getResult(){return new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}},eBEg:function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var i=s("UJDs");const a="z",n=["info","warn","debug","error","critical"],r=["","F","C","T","FT","CT"];function o(){let e=0;const t={},s={};return n.forEach((i=>{r.forEach((n=>{""===n?(t[e]=`${a}${i}A`,s[`${a}${i}A`]=e,e+=1):"T"===n?(t[e]=`${a}${i}AT`,s[`${a}${i}AT`]=e,e+=1):(t[e]=`${a}${i}${n}`,s[`${a}${i}${n}`]=e,e+=1)}))})),{EnumeratedLevels:t,ReversedEnumeratedLevels:s}}Object.freeze(r),Object.freeze(n);const d=o().EnumeratedLevels,l=o().ReversedEnumeratedLevels;Object.freeze(d),Object.freeze(l);var c=s("jDHv"),h=s("jGDt"),u=s("KRcn");const g={[i.b.info]:!0,[i.b.warn]:!0,[i.b.error]:!0,[i.b.critical]:!0,[i.b.debug]:!1};var m=s("Wc52");class p{constructor(e,t){this.tags=e,this.transporters=t,this.enabled=!0,this.Sentry=null,this.tempOffConfig={toConsole:!1,toFile:!1,toSentry:!1},this.zsentry=(...e)=>{this.Sentry&&this.Sentry.captureException(new Error(e.join(" ")))},this.zfatal=(...e)=>{},this.zcritical=(...e)=>{},this.zsymb=(e,t,...s)=>{if(!this.enabled)return;const i=d[e];let a=[];if(i.endsWith("T")&&(null==s?void 0:s.length)>0&&(a=s.shift()),i.includes("zcritical"))return void(this.Sentry&&this.Sentry.captureException(new Error(s.join(" "))));const n=this._getLevel(i);let r="None";i.endsWith("A")||i.endsWith("AT")?r="ConsoleFile":i.endsWith("C")||i.endsWith("CT")?r="toConsole":(i.endsWith("F")||i.endsWith("FT"))&&(r="toFile"),"None"!==r&&this._applyFilter({metadata:{tick:Date.now(),level:n,ln:t,template:a,targetTransporter:r,tags:this.tags},args:s})},this._applyFilter=e=>{if(!g[e.metadata.level])return;let t=e.metadata.targetTransporter;const s=c.ModuleContainer.resolve(h.a),i=Object(u.a)(),a=!!this.transporters.consoleTransporter&&m.a[i].toConsole&&s.isEnabledConsole(),n=!!this.transporters.fileTransporter&&m.a[i].toFile;"ConsoleFile"===t&&(a||(t="toFile"),n||(t="None")),"toConsole"!==t||a||(t="None"),"toFile"!==t||n||(t="None"),"None"!==t&&(e.metadata.targetTransporter=t,this._transport(e))},this._transport=e=>{const t=e.metadata.targetTransporter;var s,i;"toConsole"!==t&&"ConsoleFile"!==t||(null===(s=this.transporters.consoleTransporter)||void 0===s||s.transport(e));"toFile"!==t&&"ConsoleFile"!==t||(null===(i=this.transporters.fileTransporter)||void 0===i||i.transport(e))},this._getLevel=e=>{let t=e;e.endsWith("A")?t=e.replace("A",""):e.endsWith("AT")?t=e.replace("AT",""):e.endsWith("C")?t=e.replace("C",""):e.endsWith("CT")?t=e.replace("CT",""):e.endsWith("F")?t=e.replace("F",""):e.endsWith("FT")&&(t=e.replace("FT",""));let s=i.b.info;switch(t){case"zinfo":s=i.b.info;break;case"zwarn":s=i.b.warn;break;case"zerror":s=i.b.error;break;case"zdebug":s=i.b.debug}return s},this.zinfo=(...e)=>{zconsole.debug("[ZLL-ALERT]: zinfo is not recognized. Function cannot be used directly")},this.zinfoC=(...e)=>{zconsole.debug("[ZLL-ALERT]: zinfoC is not recognized. Function cannot be used directly")},this.zinfoF=(...e)=>{zconsole.debug("[ZLL-ALERT]: zinfoF is not recognized. Function cannot be used directly")},this.zwarn=(...e)=>{zconsole.debug("[ZLL-ALERT]: zwarn is not recognized. Function cannot be used directly")},this.zwarnC=(...e)=>{zconsole.debug("[ZLL-ALERT]: zwarnC is not recognized. Function cannot be used directly")},this.zwarnF=(...e)=>{zconsole.debug("[ZLL-ALERT]: zwarnF is not recognized. Function cannot be used directly")},this.zerror=(...e)=>{zconsole.debug("[ZLL-ALERT]: zerror is not recognized. Function cannot be used directly")},this.zerrorC=(...e)=>{zconsole.debug("[ZLL-ALERT]: zerrorC is not recognized. Function cannot be used directly")},this.zerrorF=(...e)=>{zconsole.debug("[ZLL-ALERT]: zerrorF is not recognized. Function cannot be used directly")},this.zdebug=(...e)=>{zconsole.debug("[ZLL-ALERT]: zdebug is not recognized. Function cannot be used directly")},this.zdebugC=(...e)=>{zconsole.debug("[ZLL-ALERT]: zdebugC is not recognized. Function cannot be used directly")},this.zdebugF=(...e)=>{zconsole.debug("[ZLL-ALERT]: zdebugF is not recognized. Function cannot be used directly")}}disableFile(){this.tempOffConfig.toFile=!0}enableFile(){this.tempOffConfig.toFile=!1}disableConsole(){this.tempOffConfig.toConsole=!0}enableConsole(){this.tempOffConfig.toConsole=!1}static create(e,t){return new this(e,t)}pause(){this.enabled=!0}resume(){this.enabled=!1}}},ebA4:function(e,t,s){"use strict";s.d(t,"c",(function(){return g})),s.d(t,"b",(function(){return m})),s.d(t,"a",(function(){return p}));var i=s("VTBJ"),a=s("UJDs"),n=s("j6JD"),r=s("CDcE"),o=s("fsQs"),d=s("XuBa"),l=(s("7FSS"),s("Lrq5")),c=s("6xEa"),h=s.n(c);const u=new TextEncoder;function g(e,t={}){const{noTruncate:s=!1,noCompress:a=!1}=t;if(Object(r.c)(e)){0;let t=g(e.asset,{noTruncate:!0});return"string"!=typeof t&&(t=JSON.stringify(t)),Object(i.a)(Object(i.a)({},e),{},{asset:d.a.encrypt(t)})}if(Object(r.b)(e))return g(e.asset,{noTruncate:!0,noCompress:!1});let n=e;if(l.b(n))try{n=e()}catch(c){n="[Function]"}return l.e(n)&&(n=JSON.stringify(n,Object(r.a)())),l.f(n)&&(n=n.replace(/\r\n|\n|\t|\r/g,""),s||(n=n.slice(0,o.l)),a||(n=h.a.compressToBase64(n))),n}function m({metadata:e,args:t},s){const i=Object(n.a)(e.tick),r=e.tags.filter((e=>!!e)).join("|"),d=function(e,t){let s=t.map((e=>g(e,{noCompress:!0})));if(1===s.length&&1===t.length&&"function"==typeof t[0]&&Array.isArray(s[0])&&(s=[...s[0]]),!e)return s.join(" ");let i=e;const a=[];return s.forEach((e=>{-1!==i.search("{}")?i=i.replace("{}",e):a.push(e)})),i.concat(" ").concat(a.join(" "))}(e.template.length>0?e.template[0]:null,t),l="["+e.ln+"]",c=[`${i}`,a.a[e.level].toUpperCase(),r,d,l].join("\t");let h=u.encode(c.concat("\n"));return h.byteLength>o.d.line_hard_lim&&(h=u.encode(c.slice(0,o.d.line_hard_lim)+"[BIG OBJECT]\n")),h}function p(e){const t=new ArrayBuffer(8),s=new DataView(t),i=4294967295,a=~~(e/i),n=e%i-a;return s.setUint32(0,a),s.setUint32(4,n),t}},ez9R:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i=s("jDHv");const a=Object(i.define)("zlog-bin-encoder")},ezdo:function(e,t,s){"use strict";var i,a=s("jDHv"),n=s("HPcM"),r=(s("Y58e"),s("AH6j")),o=s("fsQs"),d=s("Y41u"),l=s("UJDs"),c=s("jGDt"),h=s("7FSS");const u=null===globalThis||void 0===globalThis?void 0:globalThis.performance;let g=Object(a.injectable)()(i=function(e,t){return Object(a.inject)(c.a)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===c.a?Object:c.a])(i=class extends r.b{constructor(e){super(),this._session=e,this._data=[],this._lastPing=0,this._isSessionLineReady=!1,this.add=e=>{this._data.length<5e4&&this._data.push(e),u.now()-this._lastPing>=o.o&&(this._lastPing=u.now(),this._broadcastEvent(d.c.LogBucketRequestFlush)),this._data.length>5e4&&h.a.error(`[ZLL]: bucket size high: ${this._data.length}`)},this.getElectronApi=()=>{let e=null;try{e=$zelectron}catch(t){}return e},this._broadcastEvent=(e,t)=>{switch(e){case d.c.LogBucketRequestFlush:case d.c.RegLogBucketStatus:this.dispatchEvent(new d.b(e,t))}},this.recordSession()}get(e=o.m){return this._isSessionLineReady||h.a.error("[ZLL]: session line not ready. get() returns 0 untils it is ready"),this._isSessionLineReady?this._data.slice(0,e):[]}removeFirst(e=1){this._data.splice(0,e)}getAll(){return this._isSessionLineReady?this._data:[]}size(){return this._data.length}async recordSession(){const e=this._session.getSession();const t=`zlgvers:${e.zlgv} ps:${e.process} build:${e.env}-${e.buildType} pversion:${e.pversion} avers: bhash:${e.build}`,s={metadata:{tags:["Session".toUpperCase()],level:l.b.info,tick:this._session.getProcessStartTime(),ln:0,targetTransporter:"toFile",template:[]},args:[t]};this._data.unshift(s),this._isSessionLineReady=!0}})||i)||i)||i)||i;var m;a.ModuleContainer.registerSingleton(n.a,g);let p=Object(a.injectable)()(m=class extends r.b{constructor(...e){super(...e),this._data=[]}removeFirst(e=1){this._data.splice(0,e)}add(e){this._data.push(e),this._broadcastEvent(d.c.LogBucketRequestFlush)}get(e){const t=this._data.slice(0,e);return this._data=this._data.slice(e),t}getAll(){return this._data}size(){return this._data.length}_broadcastEvent(e,t){switch(e){case d.c.LogBucketRequestFlush:case d.c.SentryLogBucketStatus:this.dispatchEvent(new d.b(e,t))}}})||m;a.ModuleContainer.registerSingleton(n.b,p);const f=Object(a.define)("zsentry-log-trans"),v=Object(a.define)("zfile-log-trans"),b=Object(a.define)("zconsole-log-trans");var y,I,_,C=s("W8fB"),O=s("HD3z"),S=s("/n5c");let E=Object(a.injectable)()(y=function(e,t){return Object(a.inject)(n.b)(e,void 0,0)}(y=Reflect.metadata("design:type",Function)(y=Reflect.metadata("design:paramtypes",[void 0===n.b?Object:n.b])(y=class{constructor(e){this.sentryBucket=e}transport(e){throw new Error("Method not implemented.")}})||y)||y)||y)||y,M=Object(a.injectable)()(I=function(e,t){return Object(a.inject)(n.a)(e,void 0,0)}(I=Reflect.metadata("design:type",Function)(I=Reflect.metadata("design:paramtypes",[void 0===n.a?Object:n.a])(I=class{constructor(e){this.regularBucket=e}transport(e){O.a?a.ModuleContainer.resolve(S.a).write(e):this.regularBucket.add(e)}})||I)||I)||I)||I,T=Object(a.injectable)()(_=class{transport(e){a.ModuleContainer.resolve(C.a).write(e)}})||_;a.ModuleContainer.registerSingleton(v,M),a.ModuleContainer.registerSingleton(f,E),a.ModuleContainer.registerSingleton(b,T);var w,R=s("XB6V"),L=s("eBEg"),F=s("h0S/");let D=Object(a.injectable)()(w=function(e,t){return Object(a.inject)(v)(e,void 0,0)}(w=function(e,t){return Object(a.inject)(f)(e,void 0,1)}(w=function(e,t){return Object(a.inject)(b)(e,void 0,2)}(w=Reflect.metadata("design:type",Function)(w=Reflect.metadata("design:paramtypes",[void 0===v?Object:v,void 0===f?Object:f,void 0===b?Object:b])(w=class{constructor(e,t,s){this.fileTransporter=e,this.sentryTransporter=t,this.consoleTransporter=s}createZLogger(e,t=[]){const s=[];"string"==typeof e?s.push(e):Array.isArray(e)&&s.push(...e),s.push(...t);return L.a.create(s,{fileTransporter:this.fileTransporter,consoleTransporter:this.consoleTransporter,sentryTransporter:this.sentryTransporter})}createZLoggerStaging(e,t=[]){return t.push(F.ZLoggerNametags.staging),this.createZLogger(e,t)}})||w)||w)||w)||w)||w)||w;a.ModuleContainer.register(R.a,D);var A=s("yBqK"),j=s("ebA4");class P{constructor(){this._TextEncoder=new TextEncoder}encodeUi8(e,t,s){return e.setUint8(t,s),t+o.b.ui8}encodeUi16(e,t,s){return e.setUint16(t,s),t+o.b.ui16}encodeUi32(e,t,s){return e.setUint32(t,s),t+o.b.ui32}encodeFloat32(e,t,s){return e.setFloat32(t,s),t+o.b.float32}encodeFloat64(e,t,s){return e.setFloat64(t,s),t+o.b.float64}encodeBigInt64(e,t,s){const i=Object(j.a)(s),a=new Uint8Array(i);for(let n=0;n<a.byteLength;n++)t=this.encodeUi8(e,t,a[n]);return t}encodeTotalSize(e,t,s){return this.encodeUi16(e,t,s)}encodeTotalSizeEnd(e,t){return this.encodeUi16(e,t,t+o.b.ui16)}encodeTick(e,t,s){const i=Object(j.a)(s),a=new Uint8Array(i);return this.copyCache(e,t,a)}encodeVers(e,t,s){if(s>32767)throw new Error("[BinEncoder] error: encoding verion is TOO BIG!");return this.encodeUi16(e,t,s)}encodeEncoderVers(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding level is TOO BIG!");return this.encodeUi8(e,t,s)}encodeLevel(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding level is TOO BIG!");return this.encodeUi8(e,t,s)}encodeHeaderNum(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding numOfHeader is TOO BIG!");return this.encodeUi8(e,t,s)}encodeStringOnly(e,t,s){const i=this._TextEncoder.encode(s),a=i.byteLength;return t=this.encodeUi8(e,t,a),this.copyCache(e,t,i)}copyCache(e,t,s){for(let i=0;i<s.byteLength;i++)t=this.encodeUi8(e,t,s[i]);return t}}var N,U=s("6xEa"),k=s.n(U),B=s("Lrq5");let G=Object(a.injectable)()(N=Reflect.metadata("design:type",Function)(N=Reflect.metadata("design:paramtypes",[])(N=class extends P{constructor(){super(),this.MemoryLogBatch=void 0,this.dv=void 0,this._lastOffset=0,this._lastTs=0,this.encodeTags=e=>k.a.compress(e.join(".")),this.encodePayload=(e,t,s)=>{const{ln:i,tags:a,template:n,args:r}=s,d=[],l=this.encodeTags(a),c=n||"";let h=e+4+l.length+c.length;for(let m of r){const e=Object(j.c)(m);if(B.d(e)&&(h+=o.b.ubig64),B.f(e)&&(h+=o.b.ui16*e.length),(B.a(e)||B.g(e)||B.c(e))&&(h+=o.b.ui8),h>o.d.line_malloc)break;d.push(e)}const u={$1:i,$2:l,$3:d,$4:c};d.length||delete u.$3,c.length||delete u.$4;const g=A.encode(u);return this.copyCache(t,e,g)},this.MemoryLogBatch=new ArrayBuffer(o.d.mem_batch_lim),this.dv=new DataView(this.MemoryLogBatch)}getLastBuffer(){return this.MemoryLogBatch.slice(0,this._lastOffset)}encode(e){try{var t;const{metadata:s,args:i}=e;let a=0;a+=o.b.ui16;let n=s.tick;n<=this._lastTs&&(n=this._lastTs+1),this._lastTs=n,a=this.encodeTick(this.dv,a,n),a=this.encodeEncoderVers(this.dv,a,o.t),a=this.encodeLevel(this.dv,a,s.level),a=this.encodeStringOnly(this.dv,a,"0O57uwou"),a=this.encodePayload(a,this.dv,{ln:s.ln,tags:s.tags,template:null==s||null===(t=s.template)||void 0===t?void 0:t[1],args:i});const r=a+o.b.ui16;return this.encodeTotalSize(this.dv,0,r),a=this.encodeTotalSize(this.dv,a,r),this._lastOffset=a,this.MemoryLogBatch.slice(0,r)}catch(s){throw h.a.error("BinEncoderImpl.encode error:",s),new Error("BinEncoderImpl.encode error")}}})||N)||N)||N;var x=s("ez9R");a.ModuleContainer.registerSingleton(x.a,G);var z=s("K8kB");var V,H=class{constructor(e=[],t=!0){this.tasks=e,this.alive=t}do(...e){return this.add(...e)}add(...e){return this.tasks=this.tasks.concat(e),this}once(e=!1){return this.alive=!1,e&&(async e=>this.async())()||this.sync(),this}every(e){return this.add((()=>new Promise((t=>setTimeout(t,e))))),this.forever(!0)}forever(e=!1){return this.alive=!0,e&&(async e=>this.async())()||this.sync(),this}cancel(){return this.alive=!1,this}async async(){for(let e of this.tasks)await e();this.alive&&this.async()}sync(){for(let e of this.tasks)e();this.alive&&this.sync()}},$=s("PLj1"),W=s("KRcn");let q=Object(a.injectable)()(V=function(e,t){return Object(a.inject)(n.a)(e,void 0,0)}(V=Reflect.metadata("design:type",Function)(V=Reflect.metadata("design:paramtypes",[void 0===n.a?Object:n.a])(V=class extends r.b{constructor(e){super(),this.bucket=e,this.task=void 0,this.start=()=>{var e;if(null!==(e=this.task)&&void 0!==e&&e.alive)return;this.task||(this.task=new H);const t=$.c[Object(W.a)()]||o.f;this.task.add((()=>this._broadcastEvent(d.c.WriteSchedulerRequestFlush))).every(t),this._listenEvents()},this.stop=()=>{this.task&&this.task.cancel(),this.task=void 0},this._listenEvents=()=>{this.bucket.addEventListener(d.c.LogBucketRequestFlush,this._handleFlushRequestFromBucket)},this._handleFlushRequestFromBucket=()=>{var e;this.task&&this.task.alive||(o.q&&h.a.log("Oopsie! Scheduler is somehow not running. Restarting..."),null===(e=this.task)||void 0===e||e.cancel(),this.task=void 0,this.start())}}_broadcastEvent(e){if(e===d.c.WriteSchedulerRequestFlush)this.dispatchEvent(new d.a(e))}})||V)||V)||V)||V;a.ModuleContainer.registerSingleton(z.a,q)},gpNb:function(e,t,s){"use strict";var i,a=s("8/YW"),n=s("jDHv"),r=s("UK4g"),o=s("YEoC"),d=s("PmZf"),l=s("PhBv"),c=s("tHMN"),h=s("NTiX");let u=Object(a.g)()(i=Object(n.injectable)()(i=function(e,t){return Object(n.inject)(l.b)(e,void 0,0)}(i=function(e,t){return Object(n.inject)(h.a)(e,void 0,1)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===l.a?Object:l.a,void 0===h.IDatabaseStateStorage?Object:h.IDatabaseStateStorage])(i=class extends c.a{constructor(e,t){super(),this.queryPlanner=e,this.databaseStateStorage=t,this.removeListeners=()=>{},this.registerListeners()}registerListeners(){const e=e=>this.dispatchEvent(e),t=[];t.push(this.queryPlanner.addEventListener(d.b.QueryExec,e)),t.push(this.queryPlanner.addEventListener(d.b.QueryError,e)),t.push(this.queryPlanner.addEventListener(d.b.UnexpectedError,e)),t.push(this.queryPlanner.addEventListener(d.b.SuccessOpenDB,e)),t.push(this.queryPlanner.addEventListener(d.b.LongOpenDB,e)),t.push(this.queryPlanner.addEventListener(d.b.ConnectionClosedAbnormally,e)),t.push(this.queryPlanner.addEventListener(d.b.TimeConsumingQuery,e)),t.push(this.queryPlanner.addEventListener(d.b.SchemaMigratedAbnormally,e)),t.push(this.queryPlanner.addEventListener(d.b.Warning,e)),this.removeListeners=()=>t.forEach((e=>e()))}onDispose(){this.removeListeners()}authenticate(e){this.queryPlanner.authenticate(e),this.databaseStateStorage.authenticate(e)}do(e){return this.queryPlanner.do(e)}doImmediately(e){return"Qos"===e.database&&e.trace(),this.queryPlanner.doImmediately(e)}deleteDatabase(e,t){return this.doImmediately({trace:(...e)=>{},type:o.e.DeleteDB,database:e,table:"",transaction:0,priority:o.d.BLOCKING,retry:r.g,timing:{},meta:{error:new Error,dead:!1,step:-1},params:t||{}})}deleteAllDatabases(e){return this.doImmediately({trace:(...e)=>{},type:o.e.DeleteAllDBs,database:"",table:"",transaction:0,priority:o.d.BLOCKING,retry:r.g,timing:{},meta:{error:new Error,dead:!1,step:-1},params:e||{}})}closeDatabase(e,t){return this.doImmediately({trace:(...e)=>{},type:o.e.CloseDB,database:e,table:"",transaction:0,priority:o.d.BLOCKING,retry:r.g,timing:{},meta:{error:new Error,dead:!1,step:-1},params:t||{}})}closeAllDatabases(e){return this.doImmediately({trace:(...e)=>{},type:o.e.CloseAllDBs,database:"",table:"",transaction:0,priority:o.d.BLOCKING,retry:r.g,timing:{},meta:{error:new Error,dead:!1,step:-1},params:e||{}})}getAvailableDBBasicInfos(e){return this.queryPlanner.getAvailableDBBasicInfos(e)}})||i)||i)||i)||i)||i)||i;n.ModuleContainer.registerSingleton(c.b,u)},hRcX:function(e,t,s){"use strict";var i=s("VTBJ"),a=s("8/YW"),n=s("jDHv"),r=s("Uzj0");const o=()=>{},d=(()=>{let e=0;return()=>++e})(),l={id:0,retry:0,success:o,error:o,execute:o};function c(e,t){const s=e.length;e.push(t),function(e,t,s){let i=s;for(;;){const s=i-1>>>1,a=e[s];if(!(void 0!==a&&u(a,t)>0))return;e[s]=t,e[i]=a,i=s}}(e,t,s)}function h(e){const t=e[0];if(void 0!==t){const s=e.pop();return s!==t&&(e[0]=s,function(e,t,s){let i=s;const a=e.length;for(;i<a;){const s=2*(i+1)-1,a=e[s],n=s+1,r=e[n];if(void 0!==a&&u(a,t)<0)void 0!==r&&u(r,a)<0?(e[i]=r,e[n]=t,i=n):(e[i]=a,e[s]=t,i=s);else{if(!(void 0!==r&&u(r,t)<0))return;e[i]=r,e[n]=t,i=n}}}(e,s,0)),t}return null}function u(e,t){const s=e.sortIndex-t.sortIndex;return 0!==s?s:e.id-t.id}let g=function(e){return e[e.BLOCKING=50]="BLOCKING",e[e.NON_BLOCKING=250]="NON_BLOCKING",e[e.IDLE=500]="IDLE",e[e.NEVER_TIMEOUT=1e3]="NEVER_TIMEOUT",e}({});const m=new class{initData(){return[]}push(e,t){const s=Object(i.a)(Object(i.a)(Object(i.a)({},l),t),{},{id:d()});e.push(s)}getCandidate(e){return e.shift()}},p=new class{initData(){return[]}push(e,t){c(e,Object(i.a)(Object(i.a)(Object(i.a)({},l),t),{},{sortIndex:Date.now()+(t.deadline||g.NON_BLOCKING),id:d()}))}getCandidate(e){return h(e)}};class f{constructor(e=m,t=!0){this._data=void 0,this._strategy=void 0,this._stopped=void 0,this._inactive=void 0,this._data=e.initData(),this._strategy=e,this._stopped=!t,this._inactive=!0}run(e){this._strategy.push(this._data,e),this._inactive&&this._run()}start(){this._stopped=!1,setTimeout((()=>{this._run()}))}stop(){this._stopped=!0,this._inactive=!0}async _run(){if(this._stopped)return void(this._inactive=!0);const e=this._strategy.getCandidate(this._data);if(e)try{const s=await e.execute();try{null==e||e.success(s)}catch(t){}setTimeout((()=>{this._run()}))}catch(t){e.retry>0?(e.retry--,this.run(e)):null==e||e.error(t),setTimeout((()=>{this._run()}))}else this._inactive=!0}}new f(p);class v{constructor(e){this.value=e,this.next=null}}class b{constructor(){this.head=null,this.tail=null,this.size=0}enqueue(e){const t=new v(e);this.size+=1,null!==this.tail?(this.tail.next=t,this.tail=t):this.head=this.tail=t}dequeue(){if(null===this.head)return null;this.size-=1;const e=this.head.value;return this.head=this.head.next,null===this.head&&(this.tail=null),e}peek(){return null===this.head?null:this.head.value}inversedPeek(){return null===this.tail?null:this.tail.value}getSize(){return this.size}}class y{constructor(){this.sortedPriorityValues=[],this.queues={}}enqueue(e,t){-1!==function(e,t){let s=e.length;if(0===s)return-1;let i=0,a=s-1;for(;i<=a;){const s=i+Math.floor((a-i)/2);if(e[s]===t)return s;e[s]>t?a=s-1:i=s+1}return-1}(this.sortedPriorityValues,t)||(this.sortedPriorityValues.push(t),this.sortedPriorityValues.sort(),this.queues[t]=new b);this.queues[t].enqueue(e)}dequeue(){const e=this.sortedPriorityValues.length;if(0===e)return null;for(let t=0;t<e;t+=1){const e=this.sortedPriorityValues[t],s=this.queues[e];if(0!==s.getSize())return s.dequeue()}return null}getSize(){let e=0;for(const t of this.sortedPriorityValues){e+=this.queues[t].getSize()}return e}peek(){const e=this.sortedPriorityValues.length;if(0===e)return null;for(let t=0;t<e;t+=1){const e=this.sortedPriorityValues[t],s=this.queues[e];if(0!==s.getSize())return s.peek()}return null}inversedPeek(){const e=this.sortedPriorityValues.length;if(0===e)return null;for(let t=e-1;t>=0;t-=1){const e=this.sortedPriorityValues[t],s=this.queues[e];if(0!==s.getSize())return s.inversedPeek()}return null}}class I{initData(){return new y}push(e,t){const s=Object(i.a)(Object(i.a)(Object(i.a)({},l),t),{},{id:d()});e.enqueue(s,t.priority)}getCandidate(e){return e.dequeue()}}var _=s("Mgpg"),C=s("YEoC"),O=s("DI/x"),S=s("PmZf"),E=s("xI/L"),M=s("YZti");var T,w=s("MRjZ"),R=s("UJ0r"),L=s("teaq"),F=s("8eps"),D=s("oM1A"),A=s("Abbu"),j=s("PhBv");let P=Object(a.g)()(T=n.ModuleContainer.injectable()(T=function(e,t){return n.ModuleContainer.inject(R.b)(e,void 0,0)}(T=function(e,t){return n.ModuleContainer.inject(L.b)(e,void 0,1)}(T=function(e,t){return n.ModuleContainer.inject(F.a)(e,void 0,2)}(T=function(e,t){return n.ModuleContainer.inject(_.ZLoggerFactory)(e,void 0,3)}(T=Reflect.metadata("design:type",Function)(T=Reflect.metadata("design:paramtypes",[void 0===R.a?Object:R.a,void 0===L.b?Object:L.b,void 0===F.a?Object:F.a,void 0===_.ZLoggerFactory?Object:_.ZLoggerFactory])(T=class extends j.a{constructor(e,t,s,i){super(),this.adapterManager=e,this.configManager=t,this.internalData=s,this.scheduler=void 0,this.pendingQueries=[],this.session=void 0,this.logger=void 0,this.adapterContainers=new Map,this.adapterInfoMap=new Map,this.idCounter=0,this.dbSchema=void 0,this.isShuttingDown=!1,this.removeListeners=()=>{},this.authenticate=e=>{this.scheduler.stop(),this.session=e;const t=this.pendingQueries;this.pendingQueries=[],t.forEach((e=>{this.enqueue(e,{immediately:!1})})),this.clearAdapterData(),this.logger.zsymb(0,"TonHDq","Clear adapter cache due to new session"),this.configManager.authenticate(e),this.scheduler.start()};const a=new I;this.scheduler=new f(a,!1),this.logger=i.createZLogger("db",["host","planner"]),this.registerListeners()}registerListeners(){const e=e=>this.dispatchEvent(e),t=[];t.push(this.adapterManager.addEventListener(S.b.SuccessOpenDB,e)),t.push(this.adapterManager.addEventListener(S.b.LongOpenDB,e)),t.push(this.adapterManager.addEventListener(S.b.ConnectionClosedAbnormally,e)),t.push(this.adapterManager.addEventListener(S.b.TimeConsumingQuery,e)),t.push(this.adapterManager.addEventListener(S.b.SchemaMigratedAbnormally,e)),t.push(this.adapterManager.addEventListener(S.b.Warning,e)),this.removeListeners=()=>t.forEach((e=>e()))}onDispose(){this.removeListeners()}install(e){this.dbSchema=Object(i.a)(Object(i.a)({},e),D.a)}start(){this.scheduler.start()}stop(){this.scheduler.stop(),this.logger.zsymb(6,"r8kgAR","Stop!")}do(e){const t=new r.b.Container,s={database:e.database,table:e.table,method:M.c.getTypeName(e.type)||"Unknown method",transaction:e.transaction,startTime:Date.now(),getEndTime:async()=>t.value||t.promise};return this.dispatchEvent(new S.e(s)),new Promise(((t,s)=>{this.enqueue(Object(i.a)(Object(i.a)({},e),{},{deferrer:{resolve:t,reject:e=>{s(e)}}}),{immediately:A.a.isInTransaction(e)})})).finally((()=>{t.resolve(Date.now())}))}doImmediately(e){return new Promise(((t,s)=>{this.enqueue(Object(i.a)(Object(i.a)({},e),{},{deferrer:{resolve:t,reject:s}}),{immediately:!0})}))}async getAvailableDBBasicInfos(e){const t=[],s=this.getAllDBNames(),i=!!this.session,a=[];for(const n of s){const s=this.configManager.getDatabaseBaseConfig(n);!i&&s.session||a.push((async()=>{const s=this.getTablesNameOfDB(n);for(const a of s){const s=(await this.configManager.getDatabaseConfigs(n)).filter((t=>t.type===e))[0];if(void 0===s)return;const r=i?this.session.userId:"";let o=s.computeDatabaseName(r,a);const d=s.getPartition(a,this.session);if(!d)throw new O.w(a,this.session);const l=d.getTableConfig(a);if(!l)throw new O.y(a);if(l.dbName=n,s.supportPartitionByField&&l.doesHavePartitionByField(d.type)){const e=await this.adapterManager.getExistedPartitionKeys(o,s.type);for(const i of e)t.push({fullname:`${o}/${i}`,sessional:s.session})}else t.push({fullname:o,sessional:s.session})}})())}return await Promise.all(a),t}enqueue(e,t){e.meta.step=0,e.meta.id=this.idCounter++,this.scheduler.run({immediately:t.immediately,execute:()=>{try{return this.execute(e)}catch(t){if(0!==e.retry)throw e.retry-=1,t;{const s=this.createErrorForQuery(e,t);this.logger.zsymb(18,"ihb3f4",(()=>[s]));const i=new O.i(s.message),a=this.getAdapterTypeOfQuery(e);null!==a&&i.setAdaperType(a),this.dispatchEvent(new S.j(i))}}},retry:e.retry})}getAdapterTypeOfQuery(e){const t=e.meta.databaseConfig;return void 0!==t?t.type:null}trapQueryError(e){let t=null,s=()=>{};this.shouldTrapTimeoutQuery(e)&&(t=setTimeout((()=>{var t,s;const i=(null===(t=e.params)||void 0===t||null===(s=t.values)||void 0===s?void 0:s.length)||void 0,a=void 0!==i?[i]:[];e.deferrer.reject(new O.B(a))}),e.meta.timeout),e.meta.timer=t,s=()=>{clearTimeout(t)});const i=e.deferrer;e.deferrer={resolve:e=>{s(),i.resolve(e)},reject:t=>{s();const a=this.createErrorForQuery(e,t);this.dispatchEvent(new S.d(a)),i.reject(a)}}}createErrorForQuery(e,t){const s=Object(w.a)(e);let i=null;const a=(e=>{const t=e.stack;if(!t)return"";const s=`${e.name}`+(e.message?`: ${e.message}`:"")+"\n";return t.startsWith(s)?t.slice(s.length):t})(e.meta.error);if(t)if(t instanceof Error){const n=t.message+` (${s})`;if(t instanceof DOMException)i=new O.b(n,t.name,t.code),i.setStack(a);else if(t instanceof O.e)i=t,i.message=n,i.setStack(a);else if(t.message.includes("SQLITE_CORRUPT")){const s=[e.database,e.table].join("/");i=new O.d(`${s} - ${t.message}`,[s]),i.adapterType=C.a.SQLite,i.setStack(a)}else i=new O.i(n),i.setStack(a)}else{let e=t?`${t}`:"Unknown reason";e+=` (${s})`,i=new O.i(e),i.setStack(a)}else{let e=`Unknown reason (${s})`;i=new O.i(e),i.setStack(a)}const n=this.getAdapterTypeOfQuery(e);return null!==n&&i.setAdaperType(n),i}shouldTrapTimeoutQuery(e){return!1}async execute(e){e.meta.step=1,e.meta.dead=!1,this.isReadyForExecute(e)&&(e.meta.step=2,!e.meta.databaseConfig&&(await this.computeDatabaseConfig(e),e.meta.dead)||(e.meta.step=3,e.meta.shouldNotTrapQuery||this.trapQueryError(e),e.meta.step=4,!e.meta.databaseName&&(this.computeDatabaseName(e),e.meta.dead)||(e.meta.step=5,e.meta.step=6,!e.meta.partitionConfig&&(this.computePartitionConfig(e),e.meta.dead)||(e.meta.step=7,!e.meta.tableConfig&&(this.computeTableConfig(e),e.meta.dead)||(e.meta.step=8,"string"!=typeof e.meta.partitionKey&&(this.computePartitionKey(e),e.meta.dead)||(e.meta.step=9,!e.meta.executor&&(this.computeDatabaseAdapter(e),e.meta.dead)||(e.meta.step=10,e.meta.executor())))))))}setAdapterInfo(e,t){const{partitionConfig:s,partitionKey:i,databaseConfig:a,tableConfig:n}=e.meta;if(!A.a.isPartitionlessQuery(e)&&a.supportPartitionByField&&n.doesHavePartitionByField(s.type)&&""===i)return void this.rejectQuery(e,new O.x("Partition key is required"));const r=s.type,o=a.name,d=n.name,l=i||"";this.adapterInfoMap.has(r)||this.adapterInfoMap.set(r,{});const c=this.adapterInfoMap.get(r);void 0===c[o]&&(c[o]={});const h=c[o];void 0===h[d]&&(h[d]={});h[d][l]=t}clearAdapterData(){this.adapterContainers.clear(),this.adapterInfoMap.clear()}getAvailableAdapters(){const e=new Set;this.adapterInfoMap.forEach((t=>{for(const s of Object.values(t))for(const t of Object.values(s))for(const s of Object.values(t))e.add(s)}));const t=[],s=e.values();let i=s.next();for(;!i.done;){const e=i.value,a=this.adapterContainers.get(e);if(!a)throw new Error("Mismatched adapter info");t.push(a.promise),i=s.next()}return Promise.all(t)}getAvailableAdaptersOfDatabase(e){const t=new Set;this.adapterInfoMap.forEach((s=>{const i=s[e];if(void 0!==i)for(const e of Object.values(i))for(const s of Object.values(e))t.add(s)}));const s=[],i=t.values();let a=i.next();for(;!a.done;){const e=a.value,t=this.adapterContainers.get(e);if(!t)throw new Error("Mismatched adapter info");s.push(t.promise),a=i.next()}return Promise.all(s)}computeDatabaseAdapter(e){const{databaseName:t,partitionConfig:s,partitionKey:i,databaseConfig:a,tableConfig:n}=e.meta;let o=t;const d=s.type;if(!A.a.isPartitionlessQuery(e)&&a.supportPartitionByField&&a.hasPartitionedTables){const s=[t];if(n.doesHavePartitionByField(d)){if(""===i)return void this.rejectQuery(e,new O.x("Partition key is required"));s.push(n.name,i)}else s.push("Index");const a=Object(E.b)(d);o=s.join(a)}const l=`${o}_${s.type}`;let c=this.adapterContainers.get(l);c||(c=new r.b.Container,this.setAdapterInfo(e,l),this.adapterContainers.set(l,c),this.adapterManager.getDatabaseAdapter(o,s).then(c.resolve).catch(c.reject)),c.value||c.promise.then((()=>(e.meta.shouldNotTrapQuery=!0,this.execute(e)))).catch((t=>{const s=new O.a(l,t.message);this.logger.zsymb(18,"vY5kzt",(()=>[s]));const i=this.getAdapterTypeOfQuery(e);null!==i&&s.setAdaperType(i),this.dispatchEvent(new S.j(s))}));const h=c.value;h?(e.meta.adapterName=h.type===C.a.IDB?"idb":"sqlite",e.meta.executor=()=>{e.meta.databaseName=o,h.execute(e)}):e.meta.dead=!0}replicate(e,t){this.do(Object(i.a)(Object(i.a)({},e),{},{transaction:0,meta:Object(i.a)(Object(i.a)({},e.meta),{},{databaseConfig:t,error:new Error}),deferrer:void 0}))}isReadyForExecute(e){return!!(A.a.isCloseAllDBsQuery(e)||A.a.isDeleteAllDBsQuery(e)||A.a.isDeleteDBQuery(e)||A.a.isCloseDBQuery(e))||(this.isShuttingDown?(this.pendingQueries.push(e),!1):!(!this.session&&(()=>this.configManager.getDatabaseBaseConfig(e.database).session)())||(this.pendingQueries.push(e),!1))}async computeDatabaseConfig(e){if(""===e.database){if(A.a.isCloseAllDBsQuery(e))return e.meta.dead=!0,this.isShuttingDown=!0,void(async()=>{const t=await this.getAvailableAdapters();let s=t.length;const i=(...e)=>{this.logger.zsymb(0,"KQmaT5","[close-all-dbs]",...e)},a=(...e)=>{this.logger.zsymb(18,"ZwtYP2","[close-all-dbs]",...e)};i("Start ..."),i(`Wait to close ${s} connection`);const n=setInterval((()=>{i((function(e){return e[0]})`Wait to close ${s} connection`)}),5e3);try{await Promise.all(t.map((t=>t.closeThisDatabase(e.params).then((()=>{s-=1}))))),e.deferrer.resolve(),i("Done!")}catch(r){e.deferrer.reject(r),a("Failed to close all dbs",r)}finally{clearInterval(n)}})();if(A.a.isDeleteAllDBsQuery(e)){e.meta.dead=!0,this.isShuttingDown=!0;const t=this.getAllDBNames();let s=[...t];const a=(...e)=>{this.logger.zsymb(0,"TWP_d7","[delete-all-dbs]",...e)},n=(...e)=>{this.logger.zsymb(18,"oH0KJq","[delete-all-dbs]",...e)};a("Start ..."),a(`Wait for dbs: ${s}`);const r=t.map((t=>this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{type:C.e.DeleteDB,database:t,meta:Object(i.a)(Object(i.a)({},e.meta),{},{error:new Error}),deferrer:void 0})).then((()=>{s=s.filter((e=>e!==t)),a(`Wait for dbs: ${s}`)})).catch((()=>{n(`Failed to operate on db: '${t}'`)}))));return void Promise.all(r).then((()=>{a("Done!"),e.deferrer.resolve()})).catch(e.deferrer.reject)}}const t=await this.configManager.getDatabaseConfigs(e.database);if(0!==t.length){if(t.length>1&&this.shouldReplicate(e))for(let s=1;s<t.length;s++)this.replicate(e,t[s]);e.meta.databaseConfig=t[0]}else this.rejectQuery(e,new O.t(e.database))}getAllDBNames(){return Object.keys(this.dbSchema)}getTablesNameOfDB(e){const t=this.dbSchema[e];if(!t)throw new O.u(e);return Object.values(t).map((e=>e.name))}computeDatabaseName(e){var t,s;const{meta:a,table:n,database:r}=e;if(""===n){if(A.a.isCloseDBQuery(e))return e.meta.dead=!0,void(async()=>{const t=await this.getAvailableAdaptersOfDatabase(r);try{await Promise.all(t.map((t=>t.closeThisDatabase(e.params)))),e.deferrer.resolve()}catch(s){e.deferrer.reject(s)}})();if(A.a.isDeleteDBQuery(e)){e.meta.dead=!0;const t=this.getTablesNameOfDB(r).map((t=>this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{table:t,meta:Object(i.a)(Object(i.a)({},e.meta),{},{error:new Error}),deferrer:void 0}))));return void Promise.all(t).then((()=>e.deferrer.resolve())).catch(e.deferrer.reject)}}const o=null!==(t=null===(s=this.session)||void 0===s?void 0:s.userId)&&void 0!==t?t:"",d=a.databaseConfig.computeDatabaseName(o,n);a.databaseName=d}computePartitionConfig(e){const t=e.meta.databaseConfig.getPartition(e.table,this.session);t?e.meta.partitionConfig=t:this.rejectQuery(e,new O.w(e.table,this.session))}computeTableConfig(e){const{partitionConfig:t}=e.meta,s=t.getTableConfig(e.table);if(!s)return void this.rejectQuery(e,new O.y(e.table));s.dbName=e.database,e.meta.tableConfig=s;const{type:i}=t;if(s.doesUsePartitionTable(i)&&A.a.isUpdateQuery(e)){const{key:t,attributes:i,value:a}=e.params,{type:n}=e.meta.partitionConfig,r=s.getPartitionField(n);if(i.includes(r)){const s=a[r],i=Array.isArray(t)?t.join("-"):`${t}`;this.internalData.getValue().Meta.PartitionKey.insert({database:e.database,table:e.table,key:i,value:s},{replace:!0}).catch((e=>{this.logger.zsymb(18,"rZcHpD","Failed to update partition key mapping",e)}))}}}computePartitionKey(e){const{databaseConfig:t,tableConfig:s,partitionConfig:i}=e.meta;if(t.supportPartitionByField&&s.doesHavePartitionByField(i.type))switch(e.type){case C.e.BeginTransaction:return void(e.meta.partitionKey="");case C.e.Clear:return;case C.e.Insert:return void this.computePartitionForInsertQuery(e);case C.e.InsertMulti:return void this.computePartitionForInsertMultiQuery(e);case C.e.Get:case C.e.GetAndUpdate:case C.e.Update:case C.e.Delete:return void this.computePartitionForIndexedQuery(e);case C.e.FindAndDelete:case C.e.GetAllKey:case C.e.GetAll:case C.e.Count:return void this.computePartitionForRangedQuery(e);case C.e.DeleteMulti:case C.e.GetMulti:return void this.computePartitionForGetMultiAndDeleteMultiQuery(e);case C.e.UpdateMulti:return void this.computePartitionForUpdateMultiQuery(e);case C.e.CloseDB:case C.e.DeleteDB:return void this.computePartitionForCloseDBAndDeleteDBQuery(e)}else e.meta.partitionKey=""}computePartitionForInsertQuery(e){const{tableConfig:t,partitionConfig:s}=e.meta,{type:i}=s;let a=this.computePartitionKeyFromEntityValue(t,i,e.params.value);if(void 0!==a){if(a=`${a}`,e.meta.partitionKey=a,t.doesUsePartitionTable(i)){const s=t.primaryIndex.createKey(e.params.value).join("-");this.internalData.getValue().Meta.PartitionKey.insert({database:e.database,table:e.table,key:s,value:a}).catch((e=>{this.logger.zsymb(18,"If4w84","Failed to insert partition key mapping",e)}))}}else this.rejectQuery(e,new O.x("Partition key is required"))}computePartitionForInsertMultiQuery(e){const{tableConfig:t,partitionConfig:s}=e.meta,{type:a}=s,n={groupByPartitions:{},partitions:[]};for(const i of e.params.values){const s=this.computePartitionKeyFromEntityValue(e.meta.tableConfig,e.meta.partitionConfig.type,i);if(void 0===s)return void this.rejectQuery(e,new O.x("Partition key is required"));if(n.groupByPartitions[s]||(n.groupByPartitions[s]=[]),n.groupByPartitions[s].push(i),t.doesUsePartitionTable(a)){const a=t.primaryIndex.createKey(i).join("-");n.partitions.push({database:e.database,table:e.table,key:a,value:`${s}`})}}let r;const o=Object.entries(n.groupByPartitions);if(1===o.length)r=o[0][0],t.doesUsePartitionTable(a)&&n.partitions.length>0&&this.internalData.getValue().Meta.PartitionKey.insertMulti(n.partitions).catch((e=>{this.logger.zsymb(18,"5rzM1V","Failed to insert partition key mapping",e)})),e.meta.partitionKey=r;else{e.meta.dead=!0;const t=o.map((([t,s])=>{const a=t;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:a,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{values:s}),deferrer:void 0}))}));Promise.all(t).then((t=>{const s={success:[],fail:[]};t.forEach((({success:e,fail:t})=>{s.success.push(...e),s.fail.push(...t)})),e.deferrer.resolve(s)})).catch(e.deferrer.reject)}}computePartitionForIndexedQuery(e){const{key:t,index:s}=e.params,{tableConfig:a,partitionConfig:n}=e.meta,{type:r}=n,o=this.computePartitionKeyFromEntityKey(a,n.type,t,s);if(void 0!==o)e.meta.partitionKey=`${o}`;else if(a.doesUsePartitionTable(r))if("primary"===s){e.meta.dead=!0,this.logger.zsymb(6,"KeYDp8","Partition key is missing! Please fix it!");const s=Array.isArray(t)?t.join("-"):t;this.internalData.getValue().Meta.PartitionKey.get([e.database,e.table,s]).then((t=>{if(t){const s=t.value;this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:`${s}`,dead:!1,error:new Error}),deferrer:void 0})).then(e.deferrer.resolve).catch(e.deferrer.reject)}else this.rejectQuery(e,new O.x("No partition key mapping found"))})).catch((t=>{this.rejectQuery(e,new O.x("Partition key mapping failed",t))}))}else this.rejectQuery(e,new O.x("Partition key is required (indexed query)"));else this.rejectQuery(e,new O.x("Partition key is required"))}computePartitionForRangedQuery(e){var t,s;if(!e.params.range){const t=new O.A("Get all data in partitioned table");return void this.rejectQuery(e,t)}let i="";i=e.type===C.e.FindAndDelete||e.type===C.e.Count?"primary":e.params.index;const{partitionConfig:a,tableConfig:n}=e.meta,{type:r}=a;if(-1===n.getIndexPartitionField(r,i)){if(n.doesUsePartitionTable(r)){const t=new O.x("Partition key is required (ranged query)");this.rejectQuery(e,t)}else{const t=new O.A("Get all data by index in partitioned table");this.rejectQuery(e,t)}return}if(null===(t=e.params.range)||void 0===t||!t.from||null===(s=e.params.range)||void 0===s||!s.to){const t=new O.A("Get data with open boundary in partition table");return void this.rejectQuery(e,t)}const o=e.params.range.from,d=e.params.range.to,l=this.computePartitionKeyFromEntityKey(e.meta.tableConfig,o,i);if(l!==this.computePartitionKeyFromEntityKey(e.meta.tableConfig,d,i)){const t=new O.A("Get data from multiple partition");return void this.rejectQuery(e,t)}let c=l;void 0!==c?e.meta.partitionKey=`${c}`:this.rejectQuery(e,new O.x("Partition key is required (ranged query)"))}computePartitionForGetMultiAndDeleteMultiQuery(e){let t="";t=e.type===C.e.DeleteMulti?"primary":e.params.index;const{tableConfig:s,partitionConfig:a}=e.meta,{type:n}=a,r={},o=[];for(const i of e.params.keys){const a=this.computePartitionKeyFromEntityKey(s,n,i,t);if(void 0===a){if(!s.doesUsePartitionTable(n))return void this.rejectQuery(e,new O.x("Partition key is required"));if("primary"!==t)return void this.rejectQuery(e,new O.x("Partition key is required (indexed query)"));o.push(i)}else r[a]||(r[a]=[]),r[a].push(i)}if(s.doesUsePartitionTable(n)&&0!==o.length)return e.meta.dead=!0,this.logger.zsymb(6,"dtNWLp","Partition key is missing! Please fix it!"),void Promise.all(o.map((async t=>{const s=Array.isArray(t)?t.join("-"):t,i=await this.internalData.getValue().Meta.PartitionKey.get([e.database,e.table,s]).catch((e=>{throw this.logger.zsymb(18,"oT1n-W","Failed to get partition key mapping",e),new O.x("Failed to get partition key mapping")}));if(!i)throw new O.x("No partition key mapping found");{const e=i.value;r[e]||(r[e]=[]),r[e].push(t)}}))).then((()=>{const t=Object.entries(r).map((([t,s])=>{const a=t;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:a,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{keys:s}),deferrer:void 0}))}));Promise.all(t).then((t=>e.deferrer.resolve(t.flat()))).catch(e.deferrer.reject)})).catch((t=>{this.rejectQuery(e,t)}));const d=Object.entries(r);let l;if(1===d.length)l=d[0][0],e.meta.partitionKey=`${l}`;else{e.meta.dead=!0;const t=d.map((([t,s])=>{const a=t;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:a,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{keys:s}),deferrer:void 0}))}));Promise.all(t).then((t=>e.deferrer.resolve(t.flat()))).catch(e.deferrer.reject)}}computePartitionForUpdateMultiQuery(e){const{tableConfig:t,partitionConfig:s}=e.meta,{type:a}=s,{patches:n}=e.params,r={},o=[];for(const i of n){const{key:s}=i;let n=this.computePartitionKeyFromEntityKey(t,a,s);if(void 0===n){if(!t.doesUsePartitionTable(a))return void this.rejectQuery(e,new O.x("Partition key is required"));o.push(i)}else r[n]||(r[n]=[]),r[n].push(i)}if(t.doesUsePartitionTable(a)&&0!==o.length)return e.meta.dead=!0,this.logger.zsymb(6,"BS2wBg","Partition key is missing! Please fix it!"),void Promise.all(o.map((async t=>{const{key:s}=t,i=Array.isArray(s)?s.join("-"):s,a=await this.internalData.getValue().Meta.PartitionKey.get([e.database,e.table,i]).catch((e=>{throw this.logger.zsymb(18,"eeR3PK","Failed to get partition key mapping",e),new O.x("Failed to get partition key mapping")}));if(!a)throw new O.x("No partition key mapping found");{const e=a.value;r[e]||(r[e]=[]),r[e].push(t)}}))).then((()=>{const t=Object.entries(r).map((([t,s])=>{const a=t;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:a,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{patches:s}),deferrer:void 0}))}));Promise.all(t).then((t=>{const s={success:[],fail:[]};t.forEach((({success:e,fail:t})=>{s.success.push(...e),s.fail.push(...t)})),e.deferrer.resolve(s)})).catch(e.deferrer.reject)})).catch((t=>{this.rejectQuery(e,t)}));let d;const l=Object.entries(r);if(1===l.length)d=l[0][0],e.meta.partitionKey=d;else{const t=l.map((([t,s])=>{const a=t;return this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:a,error:new Error}),params:Object(i.a)(Object(i.a)({},e.params),{},{patches:s}),deferrer:void 0}))}));Promise.all(t).then((t=>{const s={success:[],fail:[]};t.forEach((({success:e,fail:t})=>{s.success.push(...e),s.fail.push(...t)})),e.deferrer.resolve(s)})).catch(e.deferrer.reject)}}async computePartitionForCloseDBAndDeleteDBQuery(e){e.meta.dead=!0;const{meta:t}=e,s=(await this.adapterManager.getExistedPartitionKeys(t.databaseName,t.databaseConfig.type)).map((t=>this.doImmediately(Object(i.a)(Object(i.a)({},e),{},{meta:Object(i.a)(Object(i.a)({},e.meta),{},{partitionKey:t,error:new Error}),deferrer:void 0}))));Promise.all(s).then((()=>e.deferrer.resolve())).catch(e.deferrer.reject)}computePartitionKeyFromEntityValue(e,t,s){const i=e.getPartitionField(t);if(void 0!==i)return s[i]}computePartitionKeyFromEntityKey(e,t,s,i="primary"){const a=e.getPartitionField(t);if(void 0!==a)return e.getIndex(i).getValue(s,a)}shouldReplicate(e){switch(e.type){case C.e.Clear:case C.e.Delete:case C.e.DeleteMulti:case C.e.FindAndDelete:case C.e.Insert:case C.e.InsertMulti:case C.e.Update:case C.e.UpdateMulti:case C.e.GetAndUpdate:case C.e.CloseDB:case C.e.CloseAllDBs:case C.e.DeleteDB:case C.e.DeleteAllDBs:return!0;default:return!1}}logQueryInfo(e){const t=Object(w.a)(e);this.logger.zsymb(12,"5woCSZ",t)}rejectQuery(e,t){e.meta.dead=!0,e.deferrer.reject(t)}})||T)||T)||T)||T)||T)||T)||T)||T;n.ModuleContainer.registerSingleton(j.b,P)},i15Q:function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var i=s("KRcn");class a{constructor(){this._session=null,this._processStart=void 0,this._enableConsole=void 0,this.isReady=()=>!!this._session,this.getSession=()=>{if(!this._session)throw new Error("session is not ready");return this._session},this.getProcessStartTime=()=>this._processStart,this.setSession=e=>{this._session=e},this._processStart=Date.now(),this._session={build:"28274ae2a111c240593eff5f0be8bb6e9d770598",zlgv:"0O57uwou",env:"prod",buildType:"release",pversion:"24.9.4",process:Object(i.a)()},this._enableConsole=!1}enableConsole(){}disableConsole(){}isEnabledConsole(){return this._enableConsole||!1}}},j6JD:function(e,t,s){"use strict";function i(e,t){"string"==typeof e&&(e=parseInt(e));const s=new Date(e),i=s.getDate(),n=s.getMonth()+1,r=(s.getFullYear(),s.getHours()),o=s.getMinutes(),d=s.getSeconds();return null!=t&&t.dayOnly?`${i}.${n}`:null!=t&&t.timeOnly?`${a(r,2)}:${a(o,2)}:${a(d,2)}`:`${i}.${n} ${a(r,2)}:${a(o,2)}:${a(d,2)}`}function a(e,t){const s=e.toString();return s.length<t?"0".repeat(t-s.length)+s:s}s.d(t,"a",(function(){return i}))},jw3m:function(e,t,s){},o0oJ:function(e,t,s){(function(e){const t={};function s(e){return t[e]||(t[e]=0),t[e]+=1,100*e+t[e]}if(!e.perf){let t=()=>Date.now();const i={STARTUP:s(1),MIGRATION_DONE:s(2),MAIN_SCRIPT:s(2),LOADED_MAIN_SCRIPT:s(3),MAIN_APP_READY:s(3),LOADED_STARTUP_SCRIPT:s(2),STARTUP_BEFORE_HEAVY:s(3),CREATE_MAIN_WINDOW:s(3),SHOW_MAIN_WINDOW:s(3),MAIN_WINDOW_LOADING:s(3),MAIN_WINDOW_LOADED:s(3),APP_STARTUP:s(2),LOAD_APP_SCRIPT:s(3),APP_DID_MOUNT:s(3),CHATBOX_DID_MOUNT:s(3),SELECT_CONVERSATION:s(1),SELECTED_CONVERSATION:s(2)};e.perf={...i,perfRecords:[],record:s=>{s||(s=0);const i=[s,t()];e.perf.perfRecords.push(i)}}}}).call(this,s("yLpj"))},oM1A:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));const i={Meta:s("+iAT").a.schema}},oSk7:function(e,t,s){"use strict";class i{constructor(e){this.stream=void 0,this.stream=e}pipe(e){return this.stream=i.transformStream(this.stream,e),this}getStream(){return this.stream}static transformStream(e,t,s){try{return e.pipeThrough(new TransformStream(t))}catch(i){const s=e.getReader();return new ReadableStream({start(e){var s;const i={desiredSize:null,enqueue(t){e.enqueue(t)},error(e){},terminate(){}};return null===(s=t.start)||void 0===s?void 0:s.call(t,i)},async pull(e){let i=!1;const a={desiredSize:null,enqueue(t){i=!0,t&&e.enqueue(t)},error(e){},terminate(){}};for(;!i;){var n;const i=await s.read();var r;if(i.done)return await(null===(r=t.flush)||void 0===r?void 0:r.call(t,a)),e.close();await(null===(n=t.transform)||void 0===n?void 0:n.call(t,i.value,a))}}})}}static createReadbleStreamFromArrayBuffer(e,t=2**20){const s=Math.ceil(e.byteLength/t);return new ReadableStream({start(i){for(let a=0;a<=s;a++)i.enqueue(new Uint8Array(e,a*t,t));i.close()}})}}t.a=i},qLCR:function(e,t,s){"use strict";s.r(t);s("cOPa"),s("mNvP"),s("QxEN"),s("BtX6"),s("ZfyH");var i=s("jDHv"),a=s("7wvk");i.ModuleContainer.registerSingleton(a.TFactoryMainless,class{constructor(){this.map=new Map,this.mainless=new Map}registerMainless(e,t){if(this.mainless.has(t))throw Error("mainless registered");this.mainless.set(t,e)}registerMethod(e,t){if(this.map.has(e))throw Error("method registered");this.map.set(e,t)}getMethodTarget(e){return this.map.get(e)}getMainless(e){const t=this.map.get(e);return this.mainless.get(t)}});var n=s("wq09");const r=i.ModuleContainer.resolve(a.TFactoryMainless),o={zip:n.b.node,unzip:n.b.node,md5:n.b.node,fileEexc:n.b.node,getDirSize:n.b.node,getDirSizeNoCaching:n.b.node,genThumbMacOfficeBuffer:n.b.node,genThumbWinOfficeBuffer:n.b.node,parseLink:n.b.node,parseBank:n.b.node},d={fileType:n.b.render,sha256:n.b.render,rmd5:n.b.render,genThumbPicBuffer:n.b.render,genPreviewThumb:n.b.render,resizeImage:n.b.render},l={sha256:n.b.web,genPreviewThumb:n.b.web,resizeImage:n.b.web,fileType:n.b.web,wmd5:n.b.web,parseBank:n.b.web};for(let NT in l)r.registerMethod(NT,l[NT]);if("render"==__ZaBUNDLENAME__){for(let e in d)r.registerMethod(e,d[e]);for(let e in o)r.registerMethod(e,o[e])}var c=s("9jPG");class h{get instance(){return this._instance||(this._instance=new h),this._instance}constructor(){this._instance=void 0,this._do_not_use_me_pool=void 0,this._do_not_use_me_pool=Object(c.pool)(__SRC_MAINLESS_WORKER__,{workerType:"web",maxWorkers:1,minWorkers:1})}get pool(){return this.instance._do_not_use_me_pool}get proxy(){return this.pool.proxy()}exec(e,t,s){return Promise.resolve(this.execRaw(e,t,s))}execRaw(e,t,s){return this.pool.exec(e,t,s)}}const u=i.ModuleContainer.resolve(a.TFactoryMainless);{const e=new h;u.registerMainless(e,n.b.web),i.ModuleContainer.registerValue(a.TWebMainless,e)}var g=s("hzFW");class m{}class p{constructor(){this.instance=void 0}createAppPathManager(){return this.instance||(this.instance=new m),this.instance}}"function"==typeof importScripts||i.ModuleContainer.registerSingleton(g.a,p);var f=s("VTBJ"),v=s("mwIZ"),b=s.n(v),y=s("D1y2"),I=s.n(y),_=s("Y58e");i.ModuleContainer.registerSingleton(_.a,class{get(e){const t=s("NDmK").default;return b()(t,e)}set(e,t){const i=s("NDmK").default,a=Object(f.a)(Object(f.a)({},b()(i,e)),t);return I()(i,e,a)}});var C,O=s("jGDt"),S=s("igA5"),E=s("PLj1"),M=s("KRcn"),T=s("7FSS"),w=s("i15Q"),R=s("1pet");let L=Object(i.injectable)()(C=Reflect.metadata("design:type",Function)(C=Reflect.metadata("design:paramtypes",[])(C=class extends w.a{constructor(){super();const e=Object(M.a)();if(E.a.includes(e))this._enableConsole=!1;else{var t;const e=null===(t=S.default.getInstance())||void 0===t?void 0:t.getItem(R.ZLoggerLocalStorageKeys.RENDERER_CONSOLE_MODE);this._enableConsole="true"===e||!1}T.a.log("[ZLL]: Console logging",this._enableConsole?"enabled":"disabled")}enableConsole(){T.a.log("[ZLL]: Console logging enabled"),this._enableConsole=!0;const e=Object(M.a)();var t;E.a.includes(e)||(null===(t=S.default.getInstance())||void 0===t||t.setItem(R.ZLoggerLocalStorageKeys.RENDERER_CONSOLE_MODE,"true"))}disableConsole(){T.a.log("[ZLL]: Console logging disabled"),this._enableConsole=!1;const e=Object(M.a)();var t;E.a.includes(e)||(null===(t=S.default.getInstance())||void 0===t||t.setItem(R.ZLoggerLocalStorageKeys.RENDERER_CONSOLE_MODE,"false"))}})||C)||C)||C;i.ModuleContainer.registerSingleton(O.a,L);const F=Object(i.define)("zlog-binary-file-system");var D=s("Wc52"),A=s("HD3z");let j=function(e){return e.Binary="zlog",e.Text="log",e}({});const P={[j.Binary]:{logExt:A.a?".calf":".zlog",metaExt:".meta",moduleExt:".module"},[j.Text]:{logExt:A.a?".txt":".log",metaExt:".dmeta",moduleExt:".module"}};var N=s("UJDs"),U=s("HhRM"),k=s("5FGm");const B=self.performance;class G{constructor(){var e;this.status="init",this.queue=[],this.lastFlush=0,this.flushTimeout=0,this.flushTimer=null,this.logFolderName=k.b,this.EncodeMode=j.Binary,this.logFileName=`${Object(M.a)()}${P[this.EncodeMode].logExt}`,this._tryFlushAll=k.a.None,this.MAX_FLUSH_DURATION=80,this.supported=null,this.isWriterReady=!1,this.lock=null,this.filePath="",this.write=async e=>{if(A.a)if(null===this.supported&&(this.supported=await U.a.async("OPFS")),!1!==this.supported){if(this.queue.push(e),this.flushable)if(B.now()-this.lastFlush>=this.flushTimeout)this._flush();else{const e=this.flushTimeout-(B.now()-this.lastFlush);this._scheduleNextFlush(e)}}else this.size>0&&this.queue.splice(0,this.size)},this.tryFlushAll=async()=>{if(!A.a)return;const e={metadata:{tags:["ZLL.F".toUpperCase()],level:N.b.info,tick:Date.now(),ln:0,targetTransporter:"toFile",template:[]},args:[`====FLUSHALL: ${this.size}====`]};if(this.queue.push(e),"busy"===this.status)return this._tryFlushAll=k.a.FlushOnNextRun,this.releaseTryFlushLock(),this.lock=this.createDeferredPromise(),void(await this.lock.promise);this._tryFlushAll=k.a.FlushNow,await this._flush()},this.resetFlushAll=()=>{this._tryFlushAll=k.a.None},this._addSession=e=>{this.queue.unshift(e),this.status="idle"},this.getFilePath=async()=>this.logFileName,this.createLogDir=async()=>"",this.isLogDirExists=async()=>!0,this.createDeferredPromise=()=>{let e,t;return{promise:new Promise(((s,i)=>{e=s,t=i})),resolve:e,reject:t}},this.ensureDir=e=>new Promise(((t,s)=>{$znode.fsExtra.ensureDir(e,1533,(e=>{if(e)return s(e);t()}))})),this.getAppVersion=async()=>"24.9.4",this.cleanupOldLogs=async()=>{},this.buildSession=async e=>{if(!A.a)return;const t=i.ModuleContainer.resolve(O.a);const s=`zlgvers:0O57uwou ps:${Object(M.a)()} build:production-release pversion:24.9.4 avers: bhash:28274ae2a111c240593eff5f0be8bb6e9d770598`,a={metadata:{tags:["Session".toUpperCase()],level:N.b.info,tick:t.getProcessStartTime(),ln:0,targetTransporter:"toFile",template:[]},args:[s]};e&&e(a)},this._scheduleNextFlush=e=>{if((this._tryFlushAll===k.a.FlushNow||this.size<=0)&&(this.releaseTryFlushLock(),this._tryFlushAll=k.a.None),this.lastFlush=B.now(),this.clearFlushTimer(),this.status="idle",!(this.size<=0)){if(this._tryFlushAll===k.a.FlushOnNextRun)return this._tryFlushAll=k.a.FlushNow,void this._flush();this.status="sleeping",this.flushTimer=setTimeout((()=>{this.status="idle",this._flush()}),e)}},this.clearFlushTimer=()=>{this.flushTimer&&clearTimeout(this.flushTimer),this.flushTimer=null,"sleeping"===this.status&&(this.status="idle")},this.releaseTryFlushLock=()=>{var e;null===(e=this.lock)||void 0===e||e.resolve(),this.lock=null},this.flushTimeout=(null===(e=D.a[Object(M.a)()])||void 0===e?void 0:e.fileInterval)||5e3,this.buildSession(this._addSession),this.cleanupOldLogs()}get size(){return this.queue.length}get flushable(){return this.supported&&this.isWriterReady&&"idle"===this.status&&this.size>0}}var x=s("fsQs"),z=s("ebA4"),V=s("yBqK"),H=s("Lrq5"),$=s("6xEa"),W=s.n($);class q{constructor(){this._TextEncoder=new TextEncoder}encodeUi8(e,t,s){return e.setUint8(t,s),t+x.b.ui8}encodeUi16(e,t,s){return e.setUint16(t,s),t+x.b.ui16}encodeUi32(e,t,s){return e.setUint32(t,s),t+x.b.ui32}encodeFloat32(e,t,s){return e.setFloat32(t,s),t+x.b.float32}encodeFloat64(e,t,s){return e.setFloat64(t,s),t+x.b.float64}encodeBigInt64(e,t,s){const i=Object(z.a)(s),a=new Uint8Array(i);for(let n=0;n<a.byteLength;n++)t=this.encodeUi8(e,t,a[n]);return t}encodeTotalSize(e,t,s){return this.encodeUi16(e,t,s)}encodeTotalSizeEnd(e,t){return this.encodeUi16(e,t,t+x.b.ui16)}encodesSeparator(e,t){return t=this.encodeUi8(e,t,x.r[0]),t=this.encodeUi8(e,t,x.r[1])}encodeTick(e,t,s){const i=Object(z.a)(s),a=new Uint8Array(i);return this.copyCache(e,t,a)}encodeZlogVersion(e,t,s){const i=this._TextEncoder.encode(s);return t=this.encodeUi8(e,t,i.byteLength),this.copyCache(e,t,i)}encodeEncoderVers(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding level is TOO BIG!");return this.encodeUi8(e,t,s)}encodeLevel(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding level is TOO BIG!");return this.encodeUi8(e,t,s)}encodeHeaderNum(e,t,s){if(s>255)throw new Error("[BinEncoder] error: encoding numOfHeader is TOO BIG!");return this.encodeUi8(e,t,s)}encodeStringOnly(e,t,s){const i=this._TextEncoder.encode(s),a=i.byteLength;return t=this.encodeUi8(e,t,a),this.copyCache(e,t,i)}copyCache(e,t,s){for(let i=0;i<s.byteLength;i++)t=this.encodeUi8(e,t,s[i]);return t}encodeTags(e){return W.a.compress(e.join("."))}encodePayload(e,t,s){const{ln:i,tags:a,template:n,args:r}=s,o=[],d=this.encodeTags(a),l=n||"";let c=e+4+d.length+l.length;for(let g of r){const e=Object(z.c)(g);if(H.d(e)&&(c+=x.b.ubig64),H.f(e)&&(c+=x.b.ui16*e.length),(H.a(e)||H.g(e)||H.c(e))&&(c+=x.b.ui8),c>x.d.line_malloc)break;o.push(e)}const h={$1:i,$2:d,$3:o,$4:l};o.length||delete h.$3,l.length||delete h.$4;const u=V.encode(h);return this.copyCache(t,e,u)}}q.getters=e=>({[x.b.ui8]:(...t)=>e.getUint8(...t),[x.b.ui16]:(...t)=>e.getUint16(...t),[x.b.ui32]:(...t)=>e.getUint32(...t),[x.b.ubig64]:(...t)=>e.getBigUint64(...t)}),q.setters=e=>({[x.b.ui8]:(...t)=>e.setUint8(...t),[x.b.ui16]:(...t)=>e.setUint16(...t),[x.b.ui32]:(...t)=>e.setUint32(...t),[x.b.ubig64]:(...t)=>e.setBigUint64(...t)});var K=s("JRkD");const Z=(e,t)=>{const s="number"==typeof t?t:e.reduce(((e,t)=>e+t.byteLength),0),i=new Uint8Array(s);let a=0;for(const n of e)i.set(new Uint8Array(n),a),a+=n.byteLength;return i};class Q{}Q.writeNoiseLogs=async(e,t,s)=>{const{FileSizeLimit:i,ReservedBytesStructure:a}=s;Object(K.a)(!!e,"[writeBinLog]: filePath is invalid"),Object(K.a)(!!t,"[writeBinLog]: data is invalid"),Object(K.a)("number"==typeof i&&i>0,`[writeBinLog]: FileSizeLimit is invalid. Got ${i}`),Object(K.a)(Array.isArray(a),`[writeBinLog]: ReservedBytes is invalid. Got ${a}`);const n=a.reduce(((e,t)=>e+t),0);if(0===t.length)return!0;let[r,o]=await Q._readInstructions(e,a),d=0;for(;d<t.length;){const s=[];let l=0;for(;d<t.length&&r+l+t[d].byteLength<i;)s.push(t[d]),l+=t[d].byteLength,d++;if(s.length>0&&r+l<i){const t=await Q._overwriteRange(e,Z(s,l),r);if("ERROR"===t.type)throw t.data;r+=l,o=Math.max(r,o),await Q._updateInstructions(e,a,[r,o]),l=0}d<t.length&&r+t[d].byteLength>=i&&(r=n,await Q._updateInstructions(e,a,[r,r]))}return!0},Q.getFileHandler=()=>{{const e=s("3a9X");return{initBinaryLogFile:e.initBinaryLogFile,readRange:e.readRange,writeRange:e.writeRange}}},Q._readInstructions=async(e,t)=>{const s=Q.getFileHandler(),i=t.reduce(((e,t)=>e+t),0),a=await s.readRange(e,0,i);if("ERROR"===a.type){const a=await Q._getInitialData(t,[i,i]);return await s.initBinaryLogFile(e,a),[i,i]}const n=a.data,r=new DataView(n.buffer),o=[];let d=0;for(let l of t)o.push(q.getters(r)[l](d)),d+=l;return o},Q._updateInstructions=async(e,t,s)=>{const i=Q.getFileHandler(),a=t.reduce(((e,t)=>e+t),0),n=new Uint8Array(a),r=new DataView(n.buffer);let o=0;for(let d=0;d<t.length;d++)q.setters(r)[t[d]](o,s[d]),o+=t[d];return await i.writeRange(e,0,n)},Q._overwriteRange=(e,t,s)=>Q.getFileHandler().writeRange(e,s,t),Q._getInitialData=async(e,t)=>{const s=e.reduce(((e,t)=>e+t),0),i=new Uint8Array(s),a=new DataView(i.buffer);let n=0;for(let r=0;r<e.length;r++){const s=e[r];q.setters(a)[s](n,t[r]),n+=s}return i};const J={MAX_RETRY:0,INVALID_CONFIG_JITTER:1,INVALID_CONFIG_MIN:2,TIMEOUT:3,RETRY_ON_ERROR_CONDITION_FAIL:4};class Y extends Error{constructor(e){super(`ExpBackoff error:${e}`),this.code=e}}function X(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function ee({step:e,nTry:t,jitter:s,min:i,max:a}){let n=i*Math.pow(e,t);if(s){const e=Math.random(),t=Math.floor(e*s*n);n=1&Math.floor(10*e)?n+t:n-t}return 0|Math.min(n,a)}function te(e,t){return async function(...s){for await(const{sleep:a,duration:n,nTry:r}of function*(e){var t,s,i,a,n,r,o,d,l;const c=null!==(t=null==e?void 0:e.retries)&&void 0!==t?t:3,h=null!==(s=null==e?void 0:e.min)&&void 0!==s?s:100,u=null!==(i=null==e?void 0:e.max)&&void 0!==i?i:1e4,g=null!==(a=null==e?void 0:e.step)&&void 0!==a?a:2,m=null!==(n=null==e?void 0:e.jitter)&&void 0!==n?n:0,p="number"==typeof(null==e||null===(r=e.lastTryDelayTime)||void 0===r?void 0:r.min)?null==e||null===(o=e.lastTryDelayTime)||void 0===o?void 0:o.min:h,f={min:p,max:X(p,"number"==typeof(null==e||null===(d=e.lastTryDelayTime)||void 0===d?void 0:d.max)?null==e||null===(l=e.lastTryDelayTime)||void 0===l?void 0:l.max:u)};if(h<=0)throw new Y(J.INVALID_CONFIG_MIN);if(m<0||m>1)throw new Y(J.INVALID_CONFIG_JITTER);let v=0;for(;v<=c;){let e=h,t=u;v===c-1&&(e=f.min,t=f.max);const s=ee({nTry:v,step:g,jitter:m,min:e,max:t});yield{nTry:v,duration:s,sleep:()=>new Promise((e=>{setTimeout(e,s)}))},v++}}(t))try{const i=await e(...s);return r>0&&null!=t&&t.afterRetry&&(null==t||t.afterRetry({nTry:r,duration:n,sleep:a,success:!0,shouldRetry:!1})),i}catch(i){const e=null!=t&&t.shouldRetryOnError?null==t?void 0:t.shouldRetryOnError:()=>Promise.resolve(!0),o=await e({error:i,currentState:{nTry:r,duration:n,sleep:a},input:s});if(null!=t&&t.afterRetry&&(null==t||t.afterRetry({nTry:r,duration:n,sleep:a,shouldRetry:o,success:!1})),!o)throw new Y(J.RETRY_ON_ERROR_CONDITION_FAIL);await a()}throw new Y(J.MAX_RETRY)}}const se=self.performance;i.ModuleContainer.registerSingleton(F,class extends G{constructor(){super(),this._flush=async()=>{const e=[];try{if(this.clearFlushTimer(),"busy"===this.status)return;this.status="busy";const t=await this.getFilePath();let s=0;const i=se.now();let a=0;for(;s<x.j&&this.size>0&&e.length<x.k&&se.now()-i<this.MAX_FLUSH_DURATION||this._tryFlushAll===k.a.FlushNow&&this.size>0&&se.now()-i<500;){const t=this.queue.shift();if(a++,t){const i=this._encode(t);s+=i.byteLength,e.push(i)}}const n=te(Q.writeNoiseLogs,{min:x.e.min,max:x.e.max,retries:x.e.maxRetries,shouldRetryOnError:async({error:e})=>{x.s&&zconsole.error(`ZLL: _flush: failed with error: ${e}`);await this.isLogDirExists();return!0},afterRetry:async({success:e,shouldRetry:t,nTry:s,duration:i})=>{x.s&&(e?zconsole.info(`ZLL: _flush try ${s}: success after ${i}ms`):zconsole.error(`ZLL: _flush try ${s}: failed. Should retry: ${t} after ${i}ms`)),e||t||zconsole.error(`ZLL: _flush failed after ${s} tries`)}});await n(t,e,{ReservedBytesStructure:[x.b.ui32,x.b.ui32],FileSizeLimit:x.d.file_lim})}catch(t){zconsole.error("ZLOG: _flush throws error",t)}finally{e.splice(0,e.length),this._scheduleNextFlush(this.flushTimeout)}},this._encode=e=>{try{var t;const{metadata:s,args:i}=e;let a=0;const n=new q,r=new Uint8Array(x.d.line_malloc+1),o=new DataView(r.buffer);a+=n.encodesSeparator(o,a);const d=a;a+=x.b.ui16,a=n.encodeTick(o,a,s.tick),a=n.encodeEncoderVers(o,a,x.t),a=n.encodeLevel(o,a,s.level),a=n.encodeZlogVersion(o,a,"0O57uwou"),a=n.encodePayload(a,o,{ln:s.ln,tags:s.tags,template:null==s||null===(t=s.template)||void 0===t?void 0:t[1],args:i}),n.encodeTotalSize(o,d,a);const l=a%2==0?a+1:a;return r.slice(0,l)}catch(s){throw T.a.error("BinEncoderImpl.encode error:",s),new Error("BinEncoderImpl.encode error")}},s("3a9X").initWebWorker((()=>{this.isWriterReady=!0,zconsole.info("ZLOG: opfs worker ready")}))}});var ie=s("/n5c");Object(i.define)("zlog-text-file-system");i.ModuleContainer.registerSingleton(ie.a,class{constructor(){this.write=async e=>{i.ModuleContainer.resolve(F).write(e)},this.tryFlushAll=async()=>{await i.ModuleContainer.resolve(F).tryFlushAll()}}});s("ezdo"),s("KdAX");var ae=s("W8Xk");const ne=Object(i.define)("kv-cache"),re=Object(i.define)("kv-cache-in-mem");var oe;class de{constructor(e){this._prefix=void 0,this._prefix=`${e}-kv-db`}_buildKey(e){return`${this._prefix}-${e}`}async setItem(e,t){const s=this._buildKey(e),i=S.default.getInstance();return await i.setItemAsync(s,ae.b(t)),t}async getItem(e){const t=this._buildKey(e),s=S.default.getInstance(),i=await s.getItemAsync(t);return Promise.resolve(i?ae.a(i):void 0)}async removeItem(e){const t=this._buildKey(e),s=S.default.getInstance();return await s.removeItemAsync(t),this}}Object(i.singleton)(ne)(oe=class{createCache(e){return new de(`${e}`)}});var le,ce=s("ndDP");class he{constructor(e,t){this._unused_name=e,this._lru=void 0,this._lru=new ce.default(t)}setItem(e,t){return this._lru.set(e,t),Promise.resolve(t)}getItem(e){return Promise.resolve(this._lru.get(e))}removeItem(e){return this._lru.delete(e),Promise.resolve(this)}}Object(i.singleton)(re)(le=class{constructor(){this._registry={}}createCache(e,t){return this._registry[e]||(this._registry[e]=new he(e,t)),this._registry[e]}});var ue=s("T0aS");class ge extends ue.b{}i.ModuleContainer.registerSingleton(ue.a,ge);s("0rWR"),s("Lq8m");var me=s("NTiX");i.ModuleContainer.registerSingleton(me.a,class{constructor(){this.store=S.default.getInstance(),this.getObject=this.store.getObject.bind(this.store),this.setObject=this.store.setObject.bind(this.store),this.getItem=this.store.getItem.bind(this.store),this.setItem=this.store.setItem.bind(this.store),this.removeItem=this.store.removeItem.bind(this.store),this.getItemForCurrentUser=this.store.getItemForCurrentUser.bind(this.store),this.getIntForCurrentUser=this.store.getIntForCurrentUser.bind(this.store),this.setItemForCurrentUser=this.store.setItemForCurrentUser.bind(this.store),this.removeItemForCurrentUser=this.store.removeItemForCurrentUser.bind(this.store)}authenticate(){}async getObjectAsync(e){return this.getObject(e)}async setObjectAsync(e,t){this.setObject(e,t)}async getItemAsync(e){return this.getItem(e)}async setItemAsync(e,t){this.setItem(e,t)}async removeItemAsync(e){this.removeItem(e)}async getIntForCurrentUserAsync(e,t){return this.getIntForCurrentUser(e,t)}async getItemForCurrentUserAsync(e){return this.getItemForCurrentUserAsync(e)}async setItemForCurrentUserAsync(e,t){this.setItemForCurrentUser(e,t)}async removeItemForCurrentUserAsync(e){this.removeItemForCurrentUser(e)}});var pe=s("75pU"),fe=s.n(pe),ve=s("d/or"),be=s("Brnv"),ye=s("JTyQ"),Ie=s("wudS");var _e;let Ce=i.ModuleContainer.injectable()(_e=function(e,t){return Object(i.inject)(be.a)(e,void 0,0)}(_e=Reflect.metadata("design:type",Function)(_e=Reflect.metadata("design:paramtypes",[void 0===be.IDatabaseStateStorage?Object:be.IDatabaseStateStorage])(_e=class{constructor(e){this.databaseStateStorage=e,this._userId=null,this.states=null,this.getAdapterTypeOfSharedDatabases=fe()(this.getAdapterTypeOfSharedDatabases.bind(this)),this.getAdapterTypeOfUserScopedDatabases=fe()(this.getAdapterTypeOfUserScopedDatabases.bind(this))}reset(){this.states=null,this.getAdapterTypeOfSharedDatabases=fe()(this.getAdapterTypeOfSharedDatabases.bind(this)),this.getAdapterTypeOfUserScopedDatabases=fe()(this.getAdapterTypeOfUserScopedDatabases.bind(this))}async getStates(){if(null!==this.states)return this.states;try{let e=await this.databaseStateStorage.getObjectAsync(ye.a);null===e&&(e=(()=>{const e=Object(Ie.e)(),t={shared:ye.c};return e.forEach((e=>{t[e]=ye.c})),t})(),await this.databaseStateStorage.setObjectAsync(ye.a,e)),this.states=e}catch(e){throw new Error("Invalid adapter type states")}return this.states}async saveStates(e){this.states=e,await this.databaseStateStorage.setObjectAsync(ye.a,e)}async getAdapterTypeOfSharedDatabases(){const e=await this.getStates();let t=!1;return void 0===e.shared&&(e.shared=ye.b,t=!0),t&&await this.saveStates(e),e.shared}async setAdapterTypeOfSharedDatabases(e){const t=await this.getStates();let s=!1;t.shared!==e&&(t.shared=e,s=!0),s&&await this.saveStates(t)}async getAdapterTypeOfUserScopedDatabases(e){const t=await this.getStates();let s=!1;return void 0===t[e]&&(t[e]=ye.b,s=!0),s&&await this.saveStates(t),t[e]}async setAdapterTypeOfUserScopedDatabases(e,t){const s=await this.getStates();let i=!1;s[e]!==t&&(s[e]=t,i=!0),i&&await this.saveStates(s)}async getInUseAdaperTypes(){const e=await this.getStates(),t=[];if(void 0!==e.shared){const s=e.shared;t.push(s)}if(null!==this._userId&&void 0!==e[this._userId]){const s=e[this._userId];t.includes(s)||t.push(s)}return t}init(e){this._userId=e,this.reset()}})||_e)||_e)||_e)||_e;i.ModuleContainer.registerSingleton(ve.a,Ce);s("5yGw"),s("hRcX");var Oe,Se=s("8eps");let Ee=Object(i.injectable)()(Oe=class{install(){}getValue(){return{}}})||Oe;i.ModuleContainer.registerSingleton(Se.a,Ee);s("gpNb"),s("rhBN");var Me=s("Mgpg"),Te=s("1CsI");const we="schverhis";i.ModuleContainer.registerSingleton(Te.a,class{constructor(){this.data=null,this.logger=void 0,this.flushTimeout=null;const e=i.ModuleContainer.resolve(Me.ZLoggerFactory);this.logger=e.createZLogger("db",["schema-version-history"])}getHistoryData(){if(null===this.data){const t=S.default.getInstance().getItem(we);if(null===t)this.data={};else try{const e=JSON.parse(t);this.data=e}catch(e){this.logger.zsymb(18,"nQWnf_","Can't parse schema version history data"),this.data={}}}return this.data}setHistoryData(e){this.data=e}verifySchemaVersion(e,t,s){const i={isAbnormal:!1,expectedVersion:null},a=this.getHistoryData()[`${e}`];if(void 0!==a){const e=a[t];void 0!==e&&(i.isAbnormal=e!==s,i.expectedVersion=e)}return i}updateSchemaVersion(e,t,s){const i=this.getHistoryData();let a={},n=!1;const r=`${e}`,o=i[r];if(void 0===o)a[r]={[t]:s},n=!0;else{o[t]!==s&&(a=Object(f.a)(Object(f.a)({},i),{},{[r]:Object(f.a)(Object(f.a)({},i[r]),{},{[t]:s})}),n=!0)}n&&(this.setHistoryData(a),this.scheduleFlushData())}scheduleFlushData(){if(null===this.flushTimeout){const e=()=>{const e=this.getHistoryData(),t=JSON.stringify(e);S.default.getInstance().setItem(we,t)};this.flushTimeout=setTimeout((()=>{e(),this.flushTimeout=null}),6e4)}}});s("cF85");var Re,Le=s("ggcH"),Fe=s("wH4e"),De=s("pAGP"),Ae=s("zmG6"),je=s("AH6j"),Pe=s("Jz/+");let Ne=Object(i.injectable)()(Re=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(Re=Reflect.metadata("design:type",Function)(Re=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Re=class extends je.b{constructor(e){super(),this.logger=void 0,this.corruptionDetectorAdapters=void 0,this.handleCorruptionEvent=e=>{this.logger.zsymb(0,"3ZrZG1","Corrupt occurs"),this.dispatchEvent(e)},this.logger=e.createZLogger("db-corruption-detector",[]),this.corruptionDetectorAdapters=new Map,this.startDetectForSharedDB();i.ModuleContainer.resolve(ue.a).addEventListener(Pe.a.SessionChange,(async({session:e})=>{null!==e&&this.startDetectForUserScopedDB(e.userId)}))}getAdapter(e){return i.ModuleContainer.resolveAll(Le.TDBCorruptionDetectorAdapter).find((t=>t.adapterType===e))}async startDetect(e){if(!i.ModuleContainer.isRegistered(Le.TDBCorruptionDetectorAdapter))return void this.logger.zsymb(0,"reru6_","Skip track corrupt, no available adapters.");const t=this.getAdapter(e);t&&!this.corruptionDetectorAdapters.has(e)&&(this.corruptionDetectorAdapters.set(e,t),t.addEventListener(Ae.a.DB_CORRUPTION_DETECTED,this.handleCorruptionEvent),t.start())}async startDetectForSharedDB(){const e=await i.ModuleContainer.resolve(De.a).getAdapterTypeOfSharedDatabases();this.startDetect(e)}async startDetectForUserScopedDB(e){const t=await i.ModuleContainer.resolve(De.a).getAdapterTypeOfUserScopedDatabases(e);this.startDetect(t)}async forceCheckDBCorruption(){this.logger.zsymb(0,"7uLYkh","forceCheckDBCorruption"),this.corruptionDetectorAdapters.forEach((e=>e.forceCheckDBCorruption()))}async forceCheckDBCorruptionFor(e){switch(this.logger.zsymb(0,"qCc6UA","forceCheckDBCorruptionFor",e),e){case Fe.AdapterType.IDB:{const t=this.getAdapter(e);if(!t){this.logger.zsymb(0,"TN3Yyw","Adapter not found",e);break}await t.forceCheckDBCorruption(),t.corruptionHasOccurred()&&this.handleCorruptionEvent(new Le.IndexedDBCorruptionDetectedEvent(Date.now(),!1));break}default:throw new Error("Not support"+e)}}corruptionHasOccurred(){let e=!1;return this.corruptionDetectorAdapters.forEach((t=>{e=e||t.corruptionHasOccurred()})),e}})||Re)||Re)||Re)||Re;i.ModuleContainer.registerSingleton(Le.TDBCorruptionDetector,Ne),i.ModuleContainer.resolve(Le.TDBCorruptionDetector);var Ue,ke=s("8/YW"),Be=s("PmZf"),Ge=s("tHMN"),xe=s("jIg3"),ze=s("fsN4");let Ve=Object(ke.g)()(Ue=i.ModuleContainer.injectable()(Ue=function(e,t){return i.ModuleContainer.inject(Ge.b)(e,void 0,0)}(Ue=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,1)}(Ue=Reflect.metadata("design:type",Function)(Ue=Reflect.metadata("design:paramtypes",[void 0===Ge.a?Object:Ge.a,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Ue=class extends xe.a{constructor(e,t){super(),this.engine=e,this.logger=void 0,this.removeListeners=()=>{},this.logger=t.createZLogger("db",["browser"]),this.registerListeners()}registerListeners(){const e=e=>this.dispatchEvent(e),t=[];t.push(this.engine.addEventListener(Be.b.UnexpectedError,e)),t.push(this.engine.addEventListener(Be.b.QueryExec,e)),t.push(this.engine.addEventListener(Be.b.QueryError,e)),t.push(this.engine.addEventListener(Be.b.SuccessOpenDB,e)),t.push(this.engine.addEventListener(Be.b.LongOpenDB,e)),t.push(this.engine.addEventListener(Be.b.ConnectionClosedAbnormally,e)),t.push(this.engine.addEventListener(Be.b.SchemaMigratedAbnormally,e)),t.push(this.engine.addEventListener(Be.b.Warning,e))}onDispose(){this.removeListeners()}install(){const e=i.ModuleContainer.resolve(ke.a);e.addEventListener(ke.b.Authenticated,(e=>{this.authenticate(e.getSession())})),e.currentSession&&this.authenticate(e.currentSession),this.logger.zsymb(3,"o_-Sns",["installed","DDrn2z"])}areYouOk(){return!0}authenticate(e){e&&(this.session=e,this.dispatchEvent(new Be.g(e)),this.engine.authenticate(e),this.logger.zsymb(0,"TiEN0m",(()=>["authenticated",`id: ${e.userId}`])))}async closeDBs(e,t){const s=ze.default.getInstance();let i=[];e?e.length&&(i=e.map((e=>s[e].closeThisDatabase(t)))):i=[s.closeAllDatabases(t)],await Promise.all(i)}})||Ue)||Ue)||Ue)||Ue)||Ue)||Ue;i.ModuleContainer.registerSingleton(xe.b,Ve);var He=s("fc/q"),$e=s("PoHQ");i.ModuleContainer.registerSingleton(He.b,class{log(e){$e.p.triggerEvent($e.h,[{commandId:e.commandId,success:!0===e.success,subCommandId:e.subCommandId||0,duration:e.duration||0,errorCode:e.errorCode||0,startTime:e.startTime||Date.now(),params:e.params||[]}])}});var We,qe=s("W8fB");let Ke=Object(i.injectable)()(We=class{})||We;i.ModuleContainer.registerSingleton(qe.b,Ke);var Ze=s("HPcM");let Qe=function(e){return e.Init="Init",e.Idle="Idle",e.Busy="Busy",e.Paused="Paused",e.Disabled="Disabled",e}({});const Je=Object(i.define)("virtual-file-writer");var Ye;let Xe=Object(i.injectable)()(Ye=function(e,t){return Object(i.inject)(Ze.a)(e,void 0,0)}(Ye=function(e,t){return Object(i.inject)(Je)(e,void 0,1)}(Ye=Reflect.metadata("design:type",Function)(Ye=Reflect.metadata("design:paramtypes",[void 0===Ze.a?Object:Ze.a,void 0===Je?Object:Je])(Ye=class extends je.b{constructor(e,t){super(),this.bucket=e,this.logWriter=t,this._mode=void 0,this.status=Qe.Init,this._mode=j.Binary}async init(){x.q&&T.a.log("DBLogWriterImpl.init()");try{await this.logWriter.loadMeta(),this._mode===j.Binary&&x.t<62&&await this.logWriter.loadModule()}catch(e){T.a.debug("[ZLL]: DBLogWriterImpl.init() failed",e)}this.status=Qe.Idle,x.q&&T.a.log("[ZLL]: DBLogWriterImpl init() DONE",Qe[this.status])}async flush(){if(this.status!==Qe.Idle)return;let e=Date.now();if(0===this.bucket.size())return;x.q&&T.a.log(`FLUSHING: ${this.bucket.size()} logs => DB`),this.status=Qe.Busy;const t=this.bucket.get(x.n),s=t.length;await this.logWriter.write(t)?(await this.logWriter.flushMetas(),this.bucket.removeFirst(s-t.length)):t.length>0&&T.a.error(`[ZLL]: flush failed: ${s-t.length}/${s}. failed:${t.length}/${s}`),this._mode===j.Binary&&x.t<62&&await this.logWriter.flushModules(),this.status=Qe.Idle,x.q&&T.a.log(`FLUSHED: ${s-t.length}/${s} logs => DB. TOOK: ${Date.now()-e}ms`)}})||Ye)||Ye)||Ye)||Ye)||Ye;var et,tt=s("ez9R"),st=s("XuBa"),it=s("j6JD");const at={id:0,current:0,currentPage:0,startups:[],ss:-1,ss_ln:-1};let nt=Object(i.injectable)()(et=Reflect.metadata("design:type",Function)(et=Reflect.metadata("design:paramtypes",[])(et=class{constructor(){this._status=void 0,this.BinEncoder=null,this.DB=void 0,this.currentPage=void 0,this.module=new Map,this.metas={data:at,updateRequired:!1},this._status=Qe.Idle,this.DB=ze.default.getInstance().ZLog}get status(){return this._status}async write(e){try{return this._status=Qe.Busy,await this.encodeFit(e,this.metas),this._status=Qe.Idle,!0}catch(t){return T.a.error(`[ZLL]: VirtualFileWriterImpl.write err ${t}`),this._status=Qe.Idle,!1}}async collectAllLogs(){try{const e=(await this.DB.Pages.getAll()).map((e=>e.data.slice(0,e.curoffs))),t=new Blob(e);return await t.arrayBuffer()}catch(e){return T.a.error(`[ZLL]:VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}async read(e){try{return await this.DB.Pages.get(e)}catch(t){return void T.a.error(`[ZLL]: VirtualFileWriterImpl.reading ${e} err ${t}`)}}async delete(e){try{return await this.DB.Pages.delete(e),!0}catch(t){return T.a.error(`[ZLL]:VirtualFileWriterImpl.deleting ${e} err ${t}`),!1}}async encodeFit(e,t){var s;if(0===e.length)return;const i=[],a=x.d.page_limit;this.currentPage&&this.currentPage.id===t.data.currentPage||(this.currentPage=await this.DB.Pages.get(t.data.currentPage),this.currentPage&&(this.currentPage.curoffs=0));let n=0;const r=a-((null===(s=this.currentPage)||void 0===s?void 0:s.curoffs)||0);let o=x.c.OK;for(;e.length;){const t=await this.encodeBinary(e[0]);if(n+t.byteLength>r){o=x.c.OVERSIZE_NEXTPAGE;break}i.push(new Uint8Array(t)),n+=t.byteLength,e.shift()}if(0===i.length&&o===x.c.OVERSIZE_NEXTPAGE){if(this.currentPage&&this.currentPage.curoffs<this.currentPage.data.size){const e=this.currentPage.data.slice(0,this.currentPage.curoffs);this.currentPage.data=e,await this.DB.Pages.insert(this.currentPage,{replace:!0})}return this.nextPage(t),void(await this.DB.Metas.insert(t.data,{replace:!0}))}if(!i.length)return;const d=this.combineArrayBuffers(i);if(this.currentPage){if(d.byteLength){const e=this.currentPage.data.slice(0,this.currentPage.curoffs),t=new Blob([e,d]);this.currentPage.data=t,this.currentPage.curoffs+=d.byteLength,this.currentPage.max=x.d.page_limit,this.currentPage.mtime=Date.now()}o===x.c.OVERSIZE_NEXTPAGE?this.nextPage(t):t.data.current=this.currentPage.curoffs,d.byteLength&&await this.DB.Pages.insert(this.currentPage,{replace:!0});try{await this.DB.Metas.insert(t.data,{replace:!0})}catch(l){T.a.error("[ZLL]: VirtualFileWriterImpl.encodeFit err2",l)}}else{this.currentPage={id:t.data.currentPage,data:new Blob([d]),curoffs:d.byteLength,max:x.d.page_limit,mtime:Date.now()},t.data.current=d.byteLength;try{await this.DB.Pages.insert(this.currentPage,{replace:!0}),await this.DB.Metas.insert(t.data,{replace:!0})}catch(l){T.a.error("[ZLL]:VirtualFileWriterImpl.encodeFit err",l)}}}combineArrayBuffers(e){const t=e.reduce(((e,t)=>e+t.byteLength),0),s=new Uint8Array(t);let i=0;for(const a of e)s.set(new Uint8Array(a),i),i+=a.byteLength;return s.buffer}getSessionLineId(){let e=this.metas.data.ss;const t=(this.metas.data.ss_ln+1)%x.p.SESSION_LINE_MAX;return 0===t&&(e=(e+1)%x.p.SESSION_MAX),this.metas.data.ss=e,this.metas.data.ss_ln=t,{ss:e,ss_ln:t}}encodeText(e){const t=this.getSessionLineId();return Object(z.b)(e,t).buffer}async encodeBinary(e){this.BinEncoder||(this.BinEncoder=i.ModuleContainer.resolve(tt.a));return this.BinEncoder.encode(e)}nextPage(e){const t=x.d.page_limit,s=x.d.file_lim,i=Math.floor(s/t),a=(e.data.currentPage+1)%i;return e.updateRequired=!0,e.data.currentPage=a,e.data.current=0,e}async loadMeta(){try{let e=await this.DB.Metas.get(0);e||(e=at),e.startups.length>x.a&&(e.startups=e.startups.slice(0,x.a)),e.startups.unshift(Object(it.a)(Date.now())),e.ss=void 0!==e.ss?e.ss:-1,e.ss_ln=-1,this.metas.data=e,this.metas.updateRequired=!1}catch(e){T.a.error(`[ZLL]: VirtualFileWriterImpl.loadMeta err ${e}`)}return await this._loadCurrentPage(),this.metas}async flushMetas(){this.metas.updateRequired&&await this.DB.Metas.insert(this.metas.data,{replace:!0,retry:1})}async loadModule(){try{const e=await this.DB.Modules.getAll();if(e){const t=e.map((e=>[st.a.decrypt(e.hash),{data:e,updateRequired:!1}]));this.module=new Map(t)}}catch(e){T.a.error(`[ZLL]: VirtualFileWriterImpl.loadModule err ${e}`)}return this.module}async flushModules(){const e=Array.from(this.module.values());for(const t of e)t.updateRequired&&(await this.DB.Modules.insert(t.data,{retry:1}),t.updateRequired=!1)}async _loadCurrentPage(){this.metas||await this.loadMeta();const e=await this.DB.Pages.get(this.metas.data.currentPage);return this.currentPage=e,e}})||et)||et)||et;i.ModuleContainer.registerSingleton(Je,nt),i.ModuleContainer.registerSingleton(qe.c,Xe);var rt,ot=s("5l/R"),dt=s("Y41u"),lt=s("K8kB");let ct=Object(i.injectable)()(rt=function(e,t){return Object(i.inject)(lt.a)(e,void 0,0)}(rt=function(e,t){return Object(i.inject)(qe.c)(e,void 0,1)}(rt=function(e,t){return Object(i.inject)(qe.b)(e,void 0,2)}(rt=Reflect.metadata("design:type",Function)(rt=Reflect.metadata("design:paramtypes",[void 0===lt.a?Object:lt.a,void 0===qe.c?Object:qe.c,void 0===qe.b?Object:qe.b])(rt=class{constructor(e,t,s){this._writeScheduler=e,this.zlogWriter=t,this.senWriter=s,this._handleFlushRequest=()=>{this.zlogWriter.flush()},this._handleWriterStatus=e=>{}}setupWriters(){A.a||(this.zlogWriter.init(),this._writeScheduler.start(),this._listenEvents())}_listenEvents(){this._writeScheduler.addEventListener(dt.c.WriteSchedulerRequestFlush,this._handleFlushRequest),this.zlogWriter.addEventListener(dt.c.WriterStatus,this._handleWriterStatus)}})||rt)||rt)||rt)||rt)||rt)||rt;i.ModuleContainer.registerSingleton(ot.a,ct);var ht,ut=s("YrRS"),gt=s("OMsT"),mt=s("XS0u");let pt=Object(i.injectable)()(ht=class{clientDeviceInfo(){return navigator.userAgent}prepareLogBlob(e){return new Promise(((t,i)=>{let a=e.viewerKey;if(!a){a=mt.default.getLastViewKey()||"";try{var n;a=null===(n=a)||void 0===n?void 0:n.split(".")[0]}catch{}}const r=new(s("xOOu"));if(A.a){s("3a9X").getWebLogFileAsBuffer("web.calf").then((s=>{"ERROR"!==s.type?(r.file("web.calf",s.data.buffer),r.generateAsync({type:"arraybuffer",compression:"DEFLATE"}).then((s=>{if(e.bareContent)t({name:`zlog_${a}_${Date.now()}.zip`,data:new Uint8Array(s)});else{const e=new Blob([new Uint8Array(s)]);e.name=`zlog_${a}_${Date.now()}.zip`,t(e)}})).catch((e=>{i(e)}))):i(s.data)}))}else{const s=[this.collectLDBLogs(),this.collectLDBMetas(),this.collectLDBModules()];Promise.all(s).then((s=>{const[n,o,d]=s;{const e=j.Binary,t=`${Object(M.a)()}.${P[e].logExt}`;r.file(t,n)}{const e=`${Object(M.a)()}.meta`;r.file(e,o)}{const e=`${Object(M.a)()}.module`;r.file(e,d)}{const e="device.zinfo",t=new TextEncoder;r.file(e,t.encode(this.clientDeviceInfo()).buffer)}r.generateAsync({type:"arraybuffer",compression:"DEFLATE"}).then((s=>{if(e.bareContent)t({name:`zlog_${a}_${Date.now()}.zip`,data:new Uint8Array(s)});else{const e=new Blob([new Uint8Array(s)]);e.name=`zlog_${a}_${Date.now()}.zip`,t(e)}})).catch((e=>{i(e)}))}))}}))}async collectLDBLogs(){try{const e=ze.default.getInstance().ZLog,t=(await e.Pages.getAll()).map((e=>e.data)),s=new Blob(t);return await s.arrayBuffer()}catch(e){return T.a.error(`VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}async collectLDBMetas(){try{const e=ze.default.getInstance().ZLog,t=await e.Metas.get(0);if(t){const e=new Blob([JSON.stringify({current:t.current,currentPage:t.currentPage,startups:t.startups})]);return await e.arrayBuffer()}return new ArrayBuffer(0)}catch(e){return T.a.error(`VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}async collectLDBModules(){try{const e=ze.default.getInstance().ZLog,t=await e.Modules.getAll();if(t){const e={size:0};t.forEach((t=>{e[t.hash]=t.id,e.size++}));const s=new Blob([JSON.stringify(e)]);return await s.arrayBuffer()}return new ArrayBuffer(0)}catch(e){return T.a.error(`VirtualFileWriterImpl.getAllPagesCombine err ${e}`),new ArrayBuffer(0)}}})||ht;i.ModuleContainer.registerSingleton(gt.a,pt);s("jw3m");var ft=s("q1tI"),vt=s.n(ft),bt=s("i8i4"),yt=s.n(bt),It=s("Jcee");class _t extends It.b{constructor(e,t,s,i){super(e,t,s),this.container=void 0,this.component=void 0,this.container=i.container,this.component=i.component}async start(){await super.start(),this.render()}render(){yt.a.render(vt.a.createElement(this.component),this.container)}}let Ct=function(e){return e.Idle="idle",e.Active="active",e}({}),Ot=function(e){return e[e.idle=0]="idle",e[e.active=1]="active",e}({});class St extends je.b{constructor(e){super(),this.status=Ot.active,this.window=void 0,this.idleDelay=void 0,this.minimumIdlePeriod=void 0,this.lastIdleTime=void 0,this.focusStateChangeDebounceTimer=void 0,this.handleDocumentBlur=()=>{this.resetFocusStateChangeDebounceTimer(),this.focusStateChangeDebounceTimer=setTimeout((()=>{this.setStateToIdle()}),this.idleDelay)},this.handleDocumentFocus=()=>{this.resetFocusStateChangeDebounceTimer(),this.setStateToActive()},this.idleDelay=e.idleDelay,this.minimumIdlePeriod=e.minimumIdlePeriod,this.window=e.window||window,this.lastIdleTime=0,this.focusStateChangeDebounceTimer=null}start(){this.window.addEventListener("blur",this.handleDocumentBlur),this.window.addEventListener("focus",this.handleDocumentFocus)}stop(){this.window.removeEventListener("blur",this.handleDocumentBlur),this.window.removeEventListener("focus",this.handleDocumentFocus)}onIdle(e){return this.addEventListener(Ct.Idle,e)}setStateToActive(){this.status!==Ot.idle||(this.status=Ot.active,this.dispatchEvent(new Event(Ct.Active)))}setStateToIdle(){if(this.status!==Ot.active)return;this.isThrottlingIdleState()||(this.lastIdleTime=Date.now(),this.status=Ot.idle,this.dispatchEvent(new Event(Ct.Idle)))}isThrottlingIdleState(){return Date.now()-this.lastIdleTime<this.minimumIdlePeriod}resetFocusStateChangeDebounceTimer(){this.focusStateChangeDebounceTimer&&(clearTimeout(this.focusStateChangeDebounceTimer),this.focusStateChangeDebounceTimer=null)}}var Et=s("wx14"),Mt=s("/MKj"),Tt=s("FK2X"),wt=s("emRR"),Rt=s("xrk1"),Lt=s("ZBGy"),Ft=s("T1Xd"),Dt=s("uzdi");const At=Object(Dt.a)();function jt(){const e=At.useRecoilSnapshot();return At.setSnapShot(e),null}var Pt=s("QVmZ"),Nt=s("72hn"),Ut=s("ZlRg"),kt=s("VaDh"),Bt=s("CzFt"),Gt=s("h0sc"),xt=s("L+5E"),zt=s("UiPd"),Vt=s("Yi2m"),Ht=s("6uTC"),$t=s("c51z"),Wt=s("sqm0"),qt=s("NTw/");var Kt=s("hI9i"),Zt=s("q9t1"),Qt=s("Jq9Z");Object(i.define)("app-version-manager");let Jt=function(e){return e.VERIFIED="VERIFIED",e.OLD_MAJOR_VERSION="OLD_MAJOR_VERSION",e.OLD_DB_VERSION="OLD_DB_VERSION",e.NONE="NONE",e}({});var Yt=()=>{const[e,t]=Object(ft.useState)(Jt.VERIFIED);return Object(ft.useEffect)((()=>{0}),[]),{appVersionState:e}};const Xt=e=>{const t=Object(Mt.f)(),s=Object(ft.useMemo)((()=>Object(Lt.d)(t)),[t]),i=Object(Lt.c)(),a=Object(Mt.g)((e=>({user:e.user,popup:e.popup,status:e.status,profile:e.profile,chatview:e.chatview})),((e,t)=>e.user==t.user&&e.popup==t.popup&&e.status==t.status&&e.profile==t.profile&&e.chatview==t.chatview));return(e=>{const t=Object(ft.useCallback)((()=>{Gt.ModalManagerV2.openModal({windowId:"1",name:R.ModalIdentitiesDefine.SETTINGS,params:!0,forceCloseAll:!0})}),[]),s=Object(ft.useCallback)((()=>{Gt.ModalManagerV2.openModal({windowId:"1",name:R.ModalIdentitiesDefine.APP_INFO,params:!0})}),[]),i=Object(ft.useCallback)(((e,t)=>{var s;Wt.a.setFlagCopyFromCapture(!!t&&!!t.isCopyFromCap),Wt.a.setTimeClipboardChanged(performance.now()),null===(s=Object(qt.b)())||void 0===s||s.setTimeClipboardChanged(performance.now())}),[]),a=(t,s)=>{const i=zt.default.getFriendsSync();xt.a.doActionWithUri(s,e,i)},n=(t,{term:s,data:i})=>{switch(s){case"id":xt.a.autoOpenConversationById(i,e),i.startsWith(R.GROUPID_PREFIX)?Vt.default.logAction(2220801):i.startsWith(R.OA_ID_PREFIX)?Vt.default.logAction(2220803):Vt.default.logAction(2220802);break;case"phone":Vt.default.logAction(2220804),xt.a.autoOpenConversationByPhone(i,e);break;case"username":Vt.default.logAction(2220805),xt.a.autoOpenConversationByUsername(i,e);break;default:Ht.a.createError($t.default.str("STR_GROUP_NO_EXIST"))}};Object(ft.useEffect)((()=>($zsub.$zuri.onNewRequest(a),$zsub.$zuri.onRequestOpenConv(n),()=>{$zsub.$zuri.removeListenNewRequest(a),$zsub.$zuri.removeListenRequestOpenConv(n)})),[e]),Object(ft.useEffect)((()=>{$zsub.$zapp.onRequestShowPreference(t),$zsub.$zapp.onRequestShowAbout(s),$zsub.$zresource.onClipboardChange(i)}),[])})(s),vt.a.createElement(Tt.c,Object(Et.a)({emitter:i,dispatch:s},a,{shouldShowMigrateScreen:e.shouldShowMigrateScreen}))};function es(e){const t=Object(Kt.k)(Zt.b,Zt.c,(e=>{const{status:t}=e;return Qt.b.includes(t)}));return vt.a.createElement(Xt,Object(Et.a)({},e,{shouldShowMigrateScreen:t}))}const ts=e=>{const{appVersionState:t}=Yt();if(t===Jt.NONE)return null;Jt.VERIFIED;return vt.a.createElement(es,e)},ss=((...e)=>({children:t})=>e.reduceRight(((e,[t,s={}])=>vt.a.createElement(t,s,e)),t))([Mt.a,{store:wt.default}],[Mt.a,{store:Bt.a,context:Bt.b}],[Mt.a,{store:Pt.a,context:Nt.a}],[Mt.a,{store:Ut.a,context:kt.a}],[Mt.a,{store:Kt.b,context:Kt.a}],[Lt.b],[Rt.c],[Ft.a]),is=()=>vt.a.createElement(ss,null,vt.a.createElement(jt,null),vt.a.createElement(ts,null));var as;let ns=Object(i.injectable)()(as=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(as=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(as=Reflect.metadata("design:type",Function)(as=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(as=class extends _t{constructor(e,t){super("zalo",e,t,{component:is,container:document.getElementById("app")})}async start(){this.setupIdleDetector(),await super.start()}setupIdleDetector(){const e=this.config.get("idle_detector"),t=new St(e);t.addEventListener(Ct.Idle,(()=>{this.setStateToIdle()})),t.addEventListener(Ct.Active,(()=>this.setStateToActive())),t.start(),this.disposables.add((()=>t.stop())),document.hasFocus()?this.setStateToActive():this.setStateToIdle()}})||as)||as)||as)||as)||as;i.ModuleContainer.registerSingleton(ke.a,ns);var rs=s("sxU/"),os=s("SZ0g");i.ModuleContainer.registerValue(os.a,new class{constructor(){this._emitter=void 0,this._emitter=rs.a.instance}emit(e){return this._emitter.emit(e.topic,e),Promise.resolve()}on(e,t){return this._emitter.on(e,t),this}off(e,t){return this._emitter.off(e,t),this}});var ds=s("ahRi");var ls=s("ptxg"),cs=s("pUq9");let hs;hs=class{getOverrideDomain(e){}getDomainConfig(){return{}}setDomainConfig(e){return this}subscribe(e){return()=>{}}},Object(i.injectable)()(hs),Object(i.singleton)(ls.a)(hs);var us,gs,ms=s("NDmK"),ps=s("qLo6"),fs=s("4prX");Object(ke.e)()(us=class{onAuthenticated(e){ms.default.e2ee.enable_wasm&&ps.AesGcmWasmFactory.instance.installAndTestWasm().then((()=>{})).catch((e=>{}))}}),Object(ke.e)()(gs=class{onAuthenticated(e){try{WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]))?fs.default.increaseSuccess(97135,0,0):fs.default.increaseFailed(97135,0,0,0,0)}catch{fs.default.increaseFailed(97135,0,0,1,0)}}});const vs=Object(i.define)("system-time");var bs=s("bUXd");i.ModuleContainer.registerSingleton(vs,class{getHourNow(){return new Date(bs.default.getTimeNow()).getHours()}getTimeNow(){return bs.default.getTimeNow()}getSystemTimeNow(){return bs.default.getSystemTimeNow()}});s("o0oJ");var ys=s("dThN"),Is=s("z0WU"),_s=s("vSga");perf.record(perf.LOAD_APP_SCRIPT),function(){window.__loadTimer&&clearTimeout(window.__loadTimer);window.__startTime&&$zlogger.loadShellQos(Date.now()-window.__startTime)}();s("FcQj");var Cs=s("Ydol"),Os=s("97kL"),Ss=s("eSGF");let Es;function Ms(){return Es||(Es=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("utils",["event-bus-effects"])),Es}const Ts={[Os.FetchActions.DELETE_EVERYONE]:(e,t)=>{ws(e.toUid,e.msgId)},[Os.FetchActions.UNDO_MULTI]:(e,t)=>{var s;null==e||null===(s=e.forEach)||void 0===s||s.call(e,(e=>ws(e.toUid||e.userId,e.msgId)))},[Os.FetchActions.UNDO]:(e,t)=>{ws(e.toUid||e.userId,e.msgId)},[Os.FetchActions.REMOVE_MEDIA]:(e,t)=>{for(let s of e.items)ws(null==e?void 0:e.conversationId,null==s?void 0:s.msgId)},[Os.ChatBoxActions.REMOVE_EXPIRED_MEDIA]:(e,t)=>{ws(null==e?void 0:e.conversationId,(null==e?void 0:e.msgIds)||(null==e?void 0:e.msgId))},[Os.ChatBoxActions.DELETE_MESSAGE]:(e,t)=>{const s=e.toUid||e.userId||e.conversation&&e.conversation.userId;s!==ms.default.sendToMeId&&ws(s,e.msgId)}};function ws(e,t){if(!e)return;if(!t)return;let s=Object(Ss.a)(t);rs.a.instance.emit("media-removed",{convId:e,msgIds:s})}Cs.default.subscribe((function(e,t){let s=Ts[e];if(s)try{s(t,e)}catch(i){Ms().zsymb(18,"Rrl2yl","Failed to run side effect for event:"+e),Ms().zsymb(18,"W4-VuG",[i])}}));var Rs=s("2ua2");s.p;Rs.a.init(),Is.default.checkSupport(),Is.default.showWarningMsg();var Ls,Fs=s("Kvb3"),Ds=s("QPNp"),As=s("lTs8"),js=s("DvVh"),Ps=s("Y4eg"),Ns=s("+2cI");Object(i.singleton)(Fs.a)(Ls=Object(ke.e)()(Ls=Reflect.metadata("design:type",Function)(Ls=Reflect.metadata("design:paramtypes",[])(Ls=class{constructor(){this._isConnectSignalChangeInfo=void 0,this._dispatch=void 0,this._authEvent=void 0,this._isConnectSignalChangeInfo=!1,this.signalInfoChange=this.signalInfoChange.bind(this)}isWeb(){return!0}bindDispatch(e){this._dispatch=e}getDispatch(){return this._dispatch}async preFormatPayload(e){let t=Object(f.a)({},e);if(t.conversation){var s,i;if(null===(s=t.conversation.userId)||void 0===s||null===(i=s.startsWith)||void 0===i?void 0:i.call(s,R.GROUPID_PREFIX)){const e=t.conversation.userId,s=await Ds.a.GroupManager.get(e);if(s&&(t.conversation.topMember=s.topMembers,t.conversation.displayName=s.displayName),t.conversation.topMember)for(const i of t.conversation.topMember){const e=zt.default.getMiniInfo(i.id);e&&(i.dName=e.dName,i.avatar=e.avatar)}}else{const e=zt.default.getMiniInfo(t.conversation.userId);e&&(t.conversation.displayName=e.dName,t.conversation.avatar=e.avatar)}}return t}signalInfoChange(e){this.isWeb()}connectSignalToFriendWorker(){this._isConnectSignalChangeInfo||(this._isConnectSignalChangeInfo=!0,zt.default.connectSignalChangeDNameAndAvatar(this.signalInfoChange))}onAuthenticated(e){this._authEvent=e}_addSession(e){var t;return(e=Object(f.a)({},e)).session=null===(t=this._authEvent)||void 0===t?void 0:t.getSession(),e}async openPhotoViewer(e){var t;let s=await this.preFormatPayload(e);s=this._addSession(s),this.connectSignalToFriendWorker();const i=this.getDispatch();i&&i({type:Os.ChatBoxActions.SHOW_FULL_IMAGE,payload:s}),Ps.a.initLog(),Ns.a.startSession(),As.a.emitWithKey(js.d.userOnNewDeviceTracking,null!==(t=s)&&void 0!==t&&t.isVideo?js.d.openVideo:js.d.openPhoto)}async openImageCaptionEditor(e){let t=await this.preFormatPayload(e);t=this._addSession(t),this.connectSignalToFriendWorker();const s=this.getDispatch();s&&s({type:Os.ChatBoxActions.SHOW_MEDIA_CAPTION_EDITOR,payload:t})}})||Ls)||Ls)||Ls);var Us,ks=s("vQ8b"),Bs=s("smi1"),Gs=s("gEkt"),xs=s("yzMR");let zs=Object(i.injectable)()(Us=function(e,t){return i.ModuleContainer.inject(xs.j)(e,void 0,0)}(Us=function(e,t){return i.ModuleContainer.inject(xs.i)(e,void 0,1)}(Us=Reflect.metadata("design:type",Function)(Us=Reflect.metadata("design:paramtypes",[void 0===xs.j?Object:xs.j,void 0===xs.i?Object:xs.i])(Us=class{constructor(e,t){this.unreadDataManager=e,this.previewManager=t,this.menuRef=void 0,this.menuRef={}}deleteConversation(e,t=!0){e!=R.CONV_FILTER.STRANGER&&(Is.default.logCoreError(`[user call del conv] ${e}`),Bs.default.deleteConversation(e,t).then((e=>{e&&e.delConversationId&&Object(Lt.f)({type:Os.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{Is.default.logCoreError("Delete conversation fail - "+JSON.stringify(e))})))}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===Gs.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]&&this.menuRef[e].close()}showConvActionMenu(e,t){if(t&&t.friendItem)return;const s=Object(f.a)({},t),i=s.userId;if(s&&!Is.default.isFakeId(i)){const e=this.previewManager.getPreviewByIDSync(i),t=zt.default.getProfileFriendByIdSync(i)||{},a=this.unreadDataManager.getUnreadByConvIdSync(i);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.type=t.type,s.unreadMark=null==a?void 0:a.unreadMark,s.smsUnreadCount=null==a?void 0:a.smsUnreadCount}this.menuRef[Gs.b].updateTargetInfo(s),this.menuRef[Gs.b].showAction(Object(f.a)({},e))}})||Us)||Us)||Us)||Us)||Us;var Vs,Hs=s("rCQs"),$s=s("iZzu"),Ws=s("6Vk1"),qs=s("RojW"),Ks=s("rXIX"),Zs=s("EFQ6"),Qs=s("3xbP"),Js=s("l+Gc"),Ys=s("VTLO"),Xs=s("LJTV"),ei=s("Enw1"),ti=s("M7kw"),si=s("Ws4b"),ii=s("Ja3U"),ai=s("SdS7"),ni=s("WQAo"),ri=s("TeAh"),oi=s("Gm1y"),di=s("P6UB"),li=s("FEfs"),ci=s("h0S/"),hi=s("u1t/");const ui={typeFilter:$s.FilterType.ALL,labelFilters:[],loaded:!1,isEnableArchivedChat:!!li.a.isEnableArchivedChat(),typeFilterSrc:$s.FilterSrcType.ALL},gi="z_sendtome_bubbledot";Object(Hs.b)($s.ConvListController)(Vs=function(e,t){return i.ModuleContainer.inject(xs.b)(e,void 0,0)}(Vs=function(e,t){return i.ModuleContainer.inject(Ws.b)(e,void 0,1)}(Vs=function(e,t){return i.ModuleContainer.inject(xs.j)(e,void 0,2)}(Vs=function(e,t){return i.ModuleContainer.inject(xs.g)(e,void 0,3)}(Vs=function(e,t){return i.ModuleContainer.inject(xs.h)(e,void 0,4)}(Vs=function(e,t){return i.ModuleContainer.inject(xs.a)(e,void 0,5)}(Vs=Reflect.metadata("design:type",Function)(Vs=Reflect.metadata("design:paramtypes",[void 0===xs.b?Object:xs.b,void 0===Ws.b?Object:Ws.b,void 0===xs.j?Object:xs.j,void 0===xs.g?Object:xs.g,void 0===xs.h?Object:xs.h,void 0===xs.a?Object:xs.a])(Vs=class extends je.b{constructor(e,t,s,i,a,n){super(),this.convDataManager=e,this.labelDataManager=t,this.unreadDataManager=s,this.muteDataManager=i,this.pinDataManager=a,this.archivedChatManager=n,this.typeFilter=void 0,this.labelFilters=void 0,this.listRawAll=void 0,this.listVisible=void 0,this.listStrangers=void 0,this.listHiddens=void 0,this.listFiltered=void 0,this.newestStrangerId=void 0,this.menuRef=void 0,this.convUIListContainer=void 0,this.showedOnboarding=void 0,this.loaded=void 0,this.isEnableArchivedChat=void 0,this.typeFilterSrc=void 0,this._logger=void 0,this._pm=null,this._sbc=null,this.handleMuteChange=e=>{const t=e.convId,s=e.payload,i=this.listFiltered.includes(t);this.logger.zsymb(0,"2E_O6G","handleMuteChange",t,i,this.typeFilter,s),i&&(this.typeFilter===$s.FilterType.UNREAD||this.isEnableArchivedChat&&this.typeFilterSrc===$s.FilterSrcType.UNREAD)&&this.addConvToUnreadFilterV2(t)},this.deleteConversation=(e,t=!0)=>{e!=R.CONV_FILTER.STRANGER&&(this.logger.zsymb(18,"VVZwlw",`[user call del conv] ${e}`),Bs.default.deleteConversation(e,t).then((e=>{e&&e.delConversationId&&Object(Lt.f)({type:Os.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{this.logger.zsymb(18,"OK6oUF","Delete conversation fail - "+JSON.stringify(e))})))},this.name=$s.CONV_LIST_CONTROLLER,this.data=new Map,this.key="windowId",this.isEnableArchivedChat=!1,this.typeFilter=$s.FilterType.ALL,this.labelFilters=[],this.typeFilterSrc=$s.FilterSrcType.ALL,this.listRawAll=new Set,this.listVisible=[],this.listStrangers=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="",this.menuRef={},this.showedOnboarding=!1,this.loaded=!1,this.getRecentContactWithId=this.getRecentContactWithId.bind(this),this.selectConversation=this.selectConversation.bind(this),this.showBroadCastMsgModal=this.showBroadCastMsgModal.bind(this),this.markAsRead=this.markAsRead.bind(this),this.addListener()}get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.conversation,[ci.ZLoggerNametags.convList])),this._logger}get previewManager(){return this._pm||(this._pm=i.ModuleContainer.resolve(xs.i)),this._pm}get sidebarController(){return this._sbc||(this._sbc=i.ModuleContainer.resolve($s.SidebarController)),this._sbc}get currUser(){return Object(si.c)()}onTypeFilterChange(e,t){if(e===$s.FilterType.UNREAD){const e=this.labelFilters.length>0?1453215:1453214;Vt.default.logAction(e),setTimeout((()=>{this.scrollToTop(!1)}))}else e!==$s.FilterType.ARCHIVED&&e!==$s.FilterType.FOCUSED||this.typeFilter===e||setTimeout((()=>{this.scrollToTop(!1)}));const s=this.typeFilter,a=e,n=i.ModuleContainer.resolve(hi.TUnreadSubChatTabStateManager),r=n.convetFilterTypeToSubChatTabType(s),o=n.convetFilterTypeToSubChatTabType(a);n.isValidSubChatTabType(o)&&n.handleChangeSubtab(r,o),this.applyTypeFilter(e,t)}onLabelFilterChange(e){this.typeFilter===$s.FilterType.UNREAD&&setTimeout((()=>{this.scrollToTop(!1)})),this.applyLabelFilter(e)}rerenderList(){this.signalRenderList()}async onPreviewChange(e,t){if(!e||!t)return;const s=e.convId;if(this.listRawAll.add(s),Zs.a.isThreadHidden(s))return void(this.listHiddens.includes(s)||this.listHiddens.push(s));let i=s,a=!1,n=!1,r=!1;if(await qs.a.isOATypeAsync(s)){const e=this.convDataManager.getConvByIdSync(s);if(!e||!qs.a.popoutOA(e))return}else if(qs.a.isStrangerV2(s)&&(a=!0,this.listStrangers.includes(s)||(this.logger.zsymb(0,"mbOIMK",`first new stranger msg ${s}`),this.listStrangers.push(s)),!this.isUnboxStrangerAccount())){const t="0"==e.fromUid||this.convDataManager.isRespondedByMeSync(s),a=this.listVisible.includes(s);t||(a&&(r=!0,this.listVisible=this.listVisible.filter((e=>e!==s))),this.updateNewestStrangerId(this.listStrangers),i=R.CONV_FILTER.STRANGER),t&&!a&&(n=!0,this.listVisible.unshift(s),this.newestStrangerId===s&&this.updateNewestStrangerId(this.listStrangers))}const[o,d]=qs.a.insertToProperPosition(this.listVisible,i,this.getAlterId());this.listVisible=o,e.msgId!==R.FAKE_DRAFT_MSG_ID||e.draft||(this.listVisible=this.listVisible.filter((e=>e!==s)),r=!0);const l=Js.a.getLabelObjByConversaionId(s),c=l&&l.id&&this.labelFilters.includes(""+l.id),h=a&&this.labelFilters.includes(Gs.g),u=c||h,g=d||n||r;if(this.typeFilter===$s.FilterType.ALL)this.addTabAllFiltered(s,u,g);else if(this.typeFilter===$s.FilterType.UNREAD)this.addTabUnreadFiltered(s,u,a);else if(this.typeFilter===$s.FilterType.STRANGER){const e=c||!this.labelFilters.length,t=a&&e;this.addTabStrangerFiltered(s,t)}else if(this.isEnableArchivedChat){const e=this.typeFilter===$s.FilterType.ARCHIVED;this.typeFilterSrc===$s.FilterSrcType.UNREAD?(li.a.isArchivedChat(s)&&e||!li.a.isArchivedChat(s)&&!e)&&!Zs.a.isThreadHidden(s)&&this.addTabUnreadFiltered(s,u,a):this.listFiltered=this.genListArchivedChat(this.listVisible,e,this.labelFilters),this.signalRenderList()}}addTabAllFiltered(e,t,s){if(t){const[t,s]=qs.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());s&&(this.listFiltered=t,this.signalRenderList())}else s&&this.signalRenderList()}addTabUnreadFiltered(e,t,s){if(this.listFiltered.includes(e)||!di.b.isMyMessage(this.previewManager.getPreviewByIDSync(e)))if(t)this.addConvToUnreadFilterV2(e);else{if(this.labelFilters.length)return;this.isUnboxStrangerAccount()||!s?this.addConvToUnreadFilterV2(e):this.addConvToUnreadFilterV2(R.CONV_FILTER.STRANGER)}}addTabStrangerFiltered(e,t){if(!t)return;const[s,i]=qs.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());i&&(this.listFiltered=s,this.signalRenderList())}addConvToUnreadFilterV2(e){const[t,s]=qs.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());s&&(this.listFiltered=this.safeSortConvList(t,!1),this.signalRenderList())}onPinChange(e){let t=!1;for(let s=0;s<e.length;s++){const i=e[s].priority,a=e[s].id;i?(this.onPreviewChange({convId:a},[]),t=!1):(t=!0,(!this.previewManager.getPreviewByIDSync(a)||!this.convDataManager.isRespondedByMeSync(a)&&qs.a.isStrangerV2(a))&&(this.listVisible=this.listVisible.filter((e=>e!==a))))}t&&(this.listVisible=this.safeSortConvList(this.listVisible,!1),(this.typeFilter!==$s.FilterType.ALL||this.labelFilters.length)&&(this.listFiltered=qs.a.sortConvId(this.listFiltered,!1,!0))),this.signalRenderList()}onHiddenChat(e,t){const s=this.convDataManager.getConvByIdSync(e);if(this.logger.zsymb(0,"C96jif","onHiddenChat ",e,t,!!s),t)this.listHiddens.push(e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.signalRenderList();else{if(!s&&!Ds.a.PinDataManager.isPinned(e))return;if(this.listHiddens=this.listHiddens.filter((t=>t!==e)),this.isUnboxStrangerAccount()||!qs.a.isStrangerV2(e)||this.listStrangers.includes(e)){const[t,s]=qs.a.insertToProperPosition(this.listVisible,e,this.getAlterId());this.listVisible=t}else this.listStrangers.push(e);if(this.listFiltered){const[t,s]=qs.a.insertToProperPosition(this.listFiltered,e,this.getAlterId());this.listFiltered=t,this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===$s.FilterType.ARCHIVED,this.labelFilters))}}this.signalRenderList()}getCurrentFilter(){return{type:this.typeFilter,labels:this.labelFilters}}getRecentContacts(){const e=[];return this.listRawAll.forEach((t=>{const s=this.convDataManager.getConvByIdSync(t);s&&e.push(s)})),e}getRecentContactWithId(e){if(this.listRawAll.has(e)){return this.convDataManager.getConvByIdSync(e)||null}return null}addConvToLabel(e,t){let s=Js.a.getItem(t);Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.MANAGE_LABEL,params:{view:Ys.b.ADD_CONVERSATION,info:s}}),e&&(e.preventDefault(),e.stopPropagation()),Vt.default.logAction(14521)}selectConversation(e){if(Xs.b.startPerf(Xs.a),e.userId===R.CONV_FILTER.MEDIA)return void this.logger.zsymb(18,"wMsKJ0","No handler for mediabox. This feat disable!!!");if(e.userId===R.CONV_FILTER.STRANGER)return void(2==Number(mt.default.getConvUXVersion())?this.applyTypeFilter($s.FilterType.STRANGER):this.labelDataManager.onSelectLabel(Gs.g));const t=this.sidebarController.getState(Qs.c).selectedId;e.userId===t&&e.userId!==R.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object(Lt.f)({type:Os.ConversationListActions.SELECT_CONV_MINOR,payload:e}):(this.convUIListContainer&&this.convUIListContainer.focus(),e.userId===ms.default.sendToMeId&&(ei.g.getFlagForCurrentUser(this.currUser.userId,gi)||($e.p.getHasShownSendToMeTip()?ei.g.setFlagForCurrentUser(this.currUser.userId,gi,1):setTimeout((()=>{Cs.default.send(Os.ConversationListActions.SHOW_BUBBLE_DOT),$e.p.setHasShownSendToMeTip(!0)}),144e5)),ti.b.getCurrentStepKey()!==ti.a.UPLOAD_IMAGES||this.showedOnboarding||(ti.b.show(),this.showedOnboarding=!0),Vt.default.logAction(13901)),e.userId===R.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object(Lt.f)({type:Os.SideBarActions.SELECT_FRIEND_CENTER,payload:Object(f.a)({},e)}):i.ModuleContainer.resolve(ni.b).openConversation(e.userId,ni.c.fromConvItem(e))),this.logActionSelectConv(e.userId)}showBroadCastMsgModal(){var e;if(!mt.default.checkBroadcastTime())return void Ht.a.createError($t.default.str("STR_BROADCAST_OVER_LIMIT_TIP"));let t=!0;1===this.labelFilters.length&&(t=Js.a.getItem(this.labelFilters[0])||!0),null!==(e=ms.default.broadcast_resend_config)&&void 0!==e&&e.enable?Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.BROADCAST_RESEND,params:t}):Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.BROADCAST_COMPSE,params:{label:t}}),Vt.default.logAction(1453102)}markAsRead(e,t=null){e&&(e.preventDefault(),e.stopPropagation()),Vt.default.logAction(164),mt.default.isShowMarkAsReadAgain()?ii.ConfirmManagerV2.openConfirm({windowId:Qs.c,name:R.MODAL_CONFIRM.confirmIdentities,params:{message:$t.default.str("STR_MARK_READ_CONFIRM_TEXT"),okText:$t.default.str("STR_CONFIRM"),okType:"primary",cancelText:$t.default.str("STR_LOGOUT_NO"),onOk:e=>{mt.default.setShowMarkAsReadAgain(!(e&&e.dont_show_mark_as_read)),this.markConvsAsRead(t)},options:[{default_val:!1,key:"dont_show_mark_as_read",title:"STR_DONT_SHOW_AGAIN"}]}}):this.markConvsAsRead(t)}scrollToTop(e){const t=ai.b.instance().getConvList();t&&t.scrollToTop(e)}scrollToConv(e){const t=ai.b.instance().getConvList();t&&t.scrollToConversation(e)}openInNewWindow(e,t){if(!e||!e.userId)return;const s=this.menuRef[Gs.b];s&&s.openInNewWindow&&(s.updateTargetInfo(e),s.openInNewWindow(t))}getStrangerInfo(){let e="";if(this.newestStrangerId){const t=this.previewManager.getPreviewByIDSync(this.newestStrangerId);e=t?t.messageTime:""}return this.logger.zsymb(0,"23JFcG","getStrangerInfo ",this.newestStrangerId,e),{messageTime:e}}getTopMostConv(){return this.typeFilter!==$s.FilterType.ALL||this.labelFilters.length?this.listFiltered[0]:this.listVisible[0]}isPreviewLoaded(){return this.loaded}addListener(){setTimeout((()=>{this.labelDataManager.addEventListener(Ws.d.SelectedLabelChange,(e=>{this.onLabelFilterChange(e.payload)})),this.labelDataManager.addEventListener(Ws.d.LabelAddConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"add")})),this.labelDataManager.addEventListener(Ws.d.LabelRemoveConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"remove")}));const e=i.ModuleContainer.resolve(xs.i);e.addEventListener(Ks.b.DoneLoadPreview,(e=>{this.onLoadPreview(e.payload)})),e.addEventListener(Ks.b.DoneMigratePreview,(()=>{this.onMigratedPreview()})),e.addEventListener(Ks.b.PreviewChanged,(e=>{const{changedItem:t,all:s}=e.payload;this.onPreviewChange(t,s)})),e.addEventListener(Ks.b.DraftChanged,(e=>{})),this.convDataManager.addEventListener(Ks.b.DeleteConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(Ks.b.EmptyConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(Ks.b.LeaveGroup,(e=>{this.moveConvOutConvList(e.convId)})),this.pinDataManager.addEventListener(Ks.b.ChangePinConv,(e=>{this.onPinChange(e.payload)})),this.archivedChatManager.addEventListener(Ks.b.UpdateListArchivedChat,(e=>{this.updateListArchivedChat()})),this.archivedChatManager.addEventListener(Ks.b.OnOffArchivedChat,(e=>{this.onOffArchivedChat(e.payload.status)})),this.muteDataManager.addEventListener(Ks.b.MuteChanged,this.handleMuteChange),zt.default.subscribeEventFriend(R.EventFriend.ADD_FRIEND,(({userId:e})=>{let t=0;this.listStrangers.includes(e)&&(t++,this.listStrangers=this.listStrangers.filter((t=>t!==e)),e==this.newestStrangerId&&(t++,this.updateNewestStrangerId(this.listStrangers))),this.onPreviewChange({convId:e},[]);const s=zt.default.isFriend(e);this.logger.zsymb(0,"SzWMR0",`on add friend ${e} ${t} ${s}`)})),zt.default.subscribeEventFriend(R.EventFriend.REMOVE_FRIEND,(({userId:e})=>{let t=0;!this.listStrangers.includes(e)&&this.listVisible.some((t=>t===e))&&(t++,this.listStrangers.push(e)),this.logger.zsymb(0,"AJGfIz",`on remove friend ${e} ${t}`)})),zt.default.subscribeEventFriend(R.EventFriend.DOWNGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()})),zt.default.subscribeEventFriend(R.EventFriend.UPGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()}))}),0)}addToListFiltered(e,t=!1){e.forEach((e=>{if(t){const t=this.unreadDataManager.getUnreadByConvIdSync(e);if(!t||!t.smsUnreadCount&&!t.unreadMark)return}const[s]=qs.a.insertToProperPosition(this.listFiltered,e);this.listFiltered=s}))}applyTypeFilter(e,t=!1){if(this.typeFilter===e&&!t)return;this.logger.zsymb(0,"zJZndz","applyTypeFilter ",e,t);const s=this.typeFilter;switch(this.typeFilter=e,e){case $s.FilterType.ALL:if(0!==this.labelFilters.length){if(this.listFiltered=qs.a.filterByLabel(this.listVisible,this.labelFilters),this.labelFilters.includes(Gs.g)){let e=this.listStrangers;this.showStrangerNROnly()&&(e=qs.a.filterByResponsed(e,!1)),this.addToListFiltered(e)}else this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters);this.addLikeConvToFilterListV2(this.listFiltered,this.labelFilters)}break;case $s.FilterType.UNREAD:if(0!==this.labelFilters.length){const e=s==$s.FilterType.ALL?this.listFiltered:this.listVisible;this.listFiltered=qs.a.filterByLabel(e,this.labelFilters),this.labelFilters.includes(Gs.g)?this.addToListFiltered(this.listStrangers):this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.listFiltered=qs.a.filterByUnread(this.listFiltered),this.listFiltered=qs.a.sortConvId(this.listFiltered,!1,!0)}else this.listFiltered=qs.a.filterByUnread(this.listVisible),this.listFiltered=this.safeSortConvList(this.listFiltered,!1);break;case $s.FilterType.STRANGER:this.listFiltered=qs.a.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=qs.a.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=qs.a.filterByResponsed(this.listFiltered,!1));break;case $s.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,this.labelFilters);break;case $s.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,this.labelFilters)}this.signalRenderState(),this.signalRenderList()}applyLabelFilter(e){if(this.labelFilters!==e){switch(this.logger.zsymb(0,"gfLbqj","applyLabelFilter ",e.join("-")),this.labelFilters=e.map((e=>""+e)),this.typeFilter){case $s.FilterType.ALL:if(this.listFiltered=qs.a.filterByLabel(this.listVisible,this.labelFilters),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.addLikeConvToFilterListV2(this.listFiltered,e),this.labelFilters.some((e=>e==Gs.g))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=qs.a.filterByResponsed(e,!1)),this.addToListFiltered(e)}break;case $s.FilterType.UNREAD:if(this.listFiltered=qs.a.filterByLabel(this.listVisible,e),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.labelFilters.some((e=>e==Gs.g))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=qs.a.filterByResponsed(e,!1)),this.addToListFiltered(e)}this.listFiltered=qs.a.filterByUnread(this.listFiltered),this.listFiltered=this.safeSortConvList(this.listFiltered,!1);break;case $s.FilterType.STRANGER:this.listFiltered=qs.a.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=qs.a.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=qs.a.filterByResponsed(this.listFiltered,!1));break;case $s.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,e);break;case $s.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,e)}this.signalRenderState(),this.signalRenderList()}}showStrangerNROnly(){return!this.isUnboxStrangerAccount()}isUnboxStrangerAccount(){const e=ri.c.isUnboxStranger();return this.logger.zsymb(0,"Tbw-M0","isUnboxStrangerAccount ",e),e}doAddStrangerHasLabel(e,t){if(t.length){const s=qs.a.filterByLabel(this.listStrangers,t);if(s.length){const t=new Set(s);for(let s=0;s<e.length;s++)t.has(e[s])&&t.delete(e[s]);this.addToListFiltered(t)}}return e}isConvExists(e){const t=this.convDataManager.getConvByIdSync(e);return!!(null!=t&&t.firstSmsLocalId||null!=t&&t.lastSmsLocalId)}safeSortConvList(e,t=!0){const s=e.indexOf(R.CONV_FILTER.STRANGER);if(-1!==s){e[s]=this.newestStrangerId;const i=(e=qs.a.sortConvId(e,t,!0)).indexOf(this.newestStrangerId);e[i]=R.CONV_FILTER.STRANGER}else e=qs.a.sortConvId(e,t,!0);return e}isValidFakeConv(e,t,s){if(e.some((e=>e==s))||Zs.a.isThreadHidden(s))return!1;const i=Js.a.getLabelObjByConversaionId(s);return!(!i||!t.some((e=>e==i.id)))}isValidFakeConvV2(e,t){if(!t||e.some((e=>e==t))||Zs.a.isThreadHidden(t))return!1;return!(t&&t.startsWith(R.GROUPID_PREFIX))||!!oi.default.getGroupByIdSync(t)}addLikeConvToFilterListV2(e,t){if(t.length&&this.typeFilter!==$s.FilterType.UNREAD){this.logger.zsymb(0,"TbFOBS","addLikeConvToFilterListV2 ",t);for(const s of t){const t=this.labelDataManager.getLabelById(s);if(t&&t.conversations)for(const s of t.conversations)this.isValidFakeConvV2(e,s)&&e.push(s)}}}markConvsAsRead(e){const t=[],s=0===this.labelFilters.length;this.logger.zsymb(0,"yktmNz",`markConvsAsRead #1  ${null==e?void 0:e.join("-")}`),this.listRawAll.forEach((i=>{const a=this.unreadDataManager.getUnreadByConvIdSync(i);if(a&&(a.smsUnreadCount>0||a.unreadMark)){if(this.logger.zsymb(0,"1u4ki0",`markConvsAsRead #2, ${i}, ${a.smsUnreadCount}`),e&&!e.hasOwnProperty(i)||i===R.FAKE_CONVERSATION_ID.FRIEND_CENTER)return;const n=Js.a.getLabelObjByConversaionId(i)||{},r=this.convDataManager.getConvByIdSync(i)||{userId:i};(s||this.labelFilters.some((e=>e==n.id))||qs.a.isInStrangerBoxV2(i)&&this.typeFilter===$s.FilterType.STRANGER)&&t.push(r)}})),this.logger.zsymb(0,"VWJ-l4",`markConvsAsRead #3 ${t.length} ${t.map((e=>e.userId)).join("-")}`),t.length>0&&(Cs.default.send(Os.SideBarActions.MARK_AS_READ,{conversations:t}),Vt.default.logAction(1453304))}onLoadPreview(e){this.logger.zsymb(0,"MRyj4z",`onload Preview 1: ${this.listRawAll.size}`);let t=e.map((e=>e.convId));const s=mt.default.getConvUXVersion();this.isEnableArchivedChat=!!li.a.isEnableArchivedChat()&&"3"==s,this.typeFilter=this.isEnableArchivedChat?$s.FilterType.FOCUSED:$s.FilterType.ALL,this.listRawAll.size&&this.listRawAll.forEach((e=>{t.some((t=>t===e))||t.push(e)})),this.listRawAll=new Set(t);const i=ms.default.sendToMeId;this.listRawAll.has(i)||(t.push(i),this.listRawAll.add(i)),this.logger.zsymb(0,"6VkjKg",`onload Preview 2: ${t.length}`),qs.a.groupConversaion(t).then((e=>{if(this.logger.zsymb(0,"iTOuJN",`grouped list #1: \n\t\t\t\t${e.hidden.length}\n\t\t\t\t- ${e.stranger.length}\n\t\t\t\t- ${e.outdate.length}\n\t\t\t\t- ${e.visible.length}\n\t\t\t`),ms.default.stagingAccount)for(const i in e)this.logger.zsymb(0,"52h0-t",`${i}: ${e[i]}`);this.listStrangers=e.stranger,this.listHiddens=e.hidden;const t=this.addStrangersToVisible(e.visible,this.listStrangers);let s=t;if(this.listVisible.length){this.logger.zsymb(0,"JQhVuH",`preview changed while group csc #1: ${this.listVisible}`),s=this.listVisible;const e=new Set(this.listVisible);t.forEach((t=>{e.has(t)||s.push(t)}))}this.listVisible=this.safeSortConvList(s,!1),this.initMyCloud(),this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===$s.FilterType.ARCHIVED,this.labelFilters)),this.logger.zsymb(0,"tYgtAv",`visible sorted #1: ${this.listVisible}`),this.loaded=!0,this.signalRenderList(),this.signalRenderState(),this.dispatchEvent(new Ks.a(Ks.c.LoadPreviewDone,"",this.listVisible.slice()))}))}onMigratedPreview(){this.logger.zsymb(0,"8OfCDj",`onMigratedPreview #1: ${this.listVisible}`);const e=mt.default.getConvUXVersion();this.isEnableArchivedChat=!!li.a.isEnableArchivedChat()&&"3"==e,this.typeFilter=this.isEnableArchivedChat?$s.FilterType.FOCUSED:$s.FilterType.ALL;const t=ms.default.sendToMeId;this.listRawAll.has(t)||this.initMyCloud(),this.convDataManager.getConvByIdSync(t)&&!this.listVisible.includes(t)&&(this.logger.zsymb(0,"_riteI","onMigratedPreview #2"),this.onPreviewChange({convId:t},[])),this.loaded=!0,this.signalRenderList(),this.signalRenderState()}initMyCloud(){const e=ei.g.getFlagForCurrentUser(null,"z_sendtome"),t=ms.default.sendToMeId,s=!(ms.default.isOffSendToMe||e&&1!==e);if(this.logger.zsymb(0,"JTlwLi","initMyCloud",e,ms.default.isOffSendToMe),this.listVisible.some((e=>e===t))){const e=this.convDataManager.getConvByIdSync(t);e&&e.pinned?Vt.default.logAction(1390703):(ei.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),Vt.default.logAction(1390702))}else if(s){const e=Ds.a.PinDataManager.getTotalPinnedConversation()>=ms.default.limit_pin_messages,s=ms.default.auto_pin_send2me&&!ei.g.getFlagForCurrentUser(null,"z_sendtome_pinned")&&!e;this.convDataManager.createEmptyConvForUser(t,s?1:0,R.CONV_OT_STATE.none,{}),s&&(Ds.a.PinDataManager.pin([t]),ei.g.setFlagForCurrentUser(null,"z_sendtome_pinned",1)),ei.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),this.onPreviewChange({convId:t},[])}}addStrangersToVisible(e,t){if(!t||!t.length)return e;if(this.isUnboxStrangerAccount())return e.concat(t);{const s=qs.a.filterByResponsed(t,!1);if(s.length){this.newestStrangerId=qs.a.getNewestConvFromIds(s);e.includes(R.CONV_FILTER.STRANGER)||e.push(R.CONV_FILTER.STRANGER)}return t.forEach((t=>{this.convDataManager.isRespondedByMeSync(t)&&e.push(t)})),e}}onLabelChangeConvs(e,t,s){if(this.logger.zsymb(0,"a-y-3a","onLabelChangeConvs",t.length,e),t.length&&this.labelFilters.includes(e))if("add"==s){const e=t.filter((e=>!this.listFiltered.includes(e)&&!this.listHiddens.includes(e)));if(!e.length)return;this.listFiltered=[...this.listFiltered,...e],this.listFiltered=qs.a.sortConvId(this.listFiltered,!1,!1),this.signalRenderList()}else{let e=!1;t.forEach((t=>{const s=Js.a.getLabelObjByConversaionId(t),i=s?s.id:null;this.labelFilters.includes(""+i)||(this.listFiltered=this.listFiltered.filter((e=>e!==t)),e=!0)})),e&&this.signalRenderList()}}moveConvOutConvList(e){this.logger.zsymb(0,"jv5o5b","moveConvOutConvList",e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.listStrangers=this.listStrangers.filter((t=>t!==e)),e!==this.newestStrangerId||this.isUnboxStrangerAccount()||this.updateNewestStrangerId(this.listStrangers),this.signalRenderList()}getAlterId(){return new Map([[R.CONV_FILTER.STRANGER,this.newestStrangerId]])}updateNewestStrangerId(e){if(this.isUnboxStrangerAccount())return;const t=qs.a.filterByResponsed(e,!1),s=this.newestStrangerId;if(this.newestStrangerId=qs.a.getNewestConvFromIds(t),this.newestStrangerId||(this.listVisible=this.listVisible.filter((e=>e!==R.CONV_FILTER.STRANGER)),this.signalRenderList()),this.previewManager.updateStrangerBox(this.newestStrangerId),s!==this.newestStrangerId&&this.newestStrangerId){const[e,t]=qs.a.insertToProperPosition(this.listVisible,R.CONV_FILTER.STRANGER,this.getAlterId());this.listVisible=e,this.signalRenderList()}}rebuildList(){this.logger.zsymb(0,"RRnLVw",`rebuildList 1: ${this.listRawAll.size} ${this.listVisible.length} ${this.listStrangers.length}`),this.listStrangers=[],this.listVisible=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="";const e=Array.from(this.listRawAll),t=qs.a.groupConversaionSync(e);if(this.logger.zsymb(0,"i-Y41e",`grouped list #2: \n\t\t\t${t.hidden.length}\n\t\t\t- ${t.stranger.length}\n\t\t\t- ${t.outdate.length}\n\t\t\t- ${t.visible.length}\n\t\t`),ms.default.stagingAccount)for(const a in t)this.logger.zsymb(0,"YTheyU",`${a}:, ${t[a]}`);this.listStrangers=t.stranger,this.listHiddens=t.hidden;const s=this.addStrangersToVisible(t.visible,this.listStrangers),i=this.safeSortConvList(s,!1);this.listVisible=i,this.logger.zsymb(0,"nmohNN",`visible sorted #2: ${this.listVisible}`),this.labelFilters.length&&this.applyLabelFilter(this.labelFilters),this.typeFilter!==$s.FilterType.ALL&&this.applyTypeFilter(this.typeFilter,ms.default.should_force_genlist_conv),this.signalRenderList(),this.signalRenderState()}handleUserPackageChange(){this.logger.zsymb(0,"4suAgp",`handleUserPackageChange: ${zt.default.isMeBAAccount()}}`),this.rebuildList()}signalRenderList(e="all"){Object(Kt.i)(this.name,e)}signalRenderState(){Object(Kt.g)(this.name,Qs.c)}logActionSelectConv(e){const t=this.labelFilters.length>0;if(this.typeFilter===$s.FilterType.UNREAD?(Vt.default.logAction(1453103),t||Vt.default.logAction(1453107)):this.typeFilter===$s.FilterType.ALL?(Vt.default.logAction(1453104),t&&Vt.default.logAction(1453108)):this.typeFilter===$s.FilterType.FOCUSED?Vt.default.logAction(1453501):this.typeFilter===$s.FilterType.ARCHIVED&&Vt.default.logAction(1453502),t)Vt.default.logAction(1453105);else{Vt.default.logAction(1453106);for(let e=0;e<this.labelFilters.length;e++){if(parseInt(this.labelFilters[e])>0){Vt.default.logAction(1453109);break}}}this.typeFilter==$s.FilterType.ARCHIVED&&li.a.sendTrackSrc(e,4,!1)}init(){}getItem(e){return e.key===Qs.c?{labelFilters:this.labelFilters,typeFilter:this.typeFilter,loaded:this.loaded,isEnableArchivedChat:this.isEnableArchivedChat,typeFilterSrc:this.typeFilterSrc}:ui}getList(e){return e.key===Qs.c||this.typeFilter==$s.FilterType.ALL&&0===this.labelFilters.length?this.listVisible:this.listFiltered}onGetItemFailure(e){}onGetListFailure(e){}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===Gs.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]}showConvActionMenu(e,t){if(t&&t.friendItem)return;if(t.userId===R.CONV_FILTER.STRANGER||t.userId===R.CONV_FILTER.MEDIA)return;const s=Object(f.a)({},t),i=s.userId;if(s&&!Is.default.isFakeId(i)){const e=this.previewManager.getPreviewByIDSync(i),t=zt.default.getProfileFriendByIdSync(i)||{},a=this.unreadDataManager.getUnreadByConvIdSync(i);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.unreadMark=null==a?void 0:a.unreadMark,s.smsUnreadCount=null==a?void 0:a.smsUnreadCount}this.menuRef[Gs.b].updateTargetInfo(s),this.menuRef[Gs.b].showAction(Object(f.a)({},e))}bindUIContainer(e){this.convUIListContainer=e}cleanUpUIContainer(){this.convUIListContainer=null}getEnableArchivedChat(){return this.isEnableArchivedChat}getListFilterSrc(e){return this.typeFilterSrc===$s.FilterSrcType.UNREAD?qs.a.filterByUnread(e):e}setTypeFilterSrc(e){if(this.typeFilterSrc!==e&&(this.typeFilterSrc=e,this.applyTypeFilter(this.typeFilter,!0),e===$s.FilterSrcType.UNREAD)){const e=this.labelFilters.length>0?1453215:1453214;Vt.default.logAction(e)}}genListArchivedChat(e,t,s,i=!0,a=!0){let n=[];n=qs.a.filterByLabel(this.getListFilterSrc(e),s),s.length&&a&&this.typeFilterSrc!==$s.FilterSrcType.UNREAD&&this.addLikeConvToFilterListV2(n,s);let r=this.getListFilterSrc(this.listStrangers).filter((e=>(li.a.isArchivedChat(e)&&t||!li.a.isArchivedChat(e)&&!t)&&!Zs.a.isThreadHidden(e)));return s.includes(Gs.g)&&1==s.length?this.isUnboxStrangerAccount()||(r=qs.a.filterByResponsed(r,!1)):s.includes(Gs.g)||(r=qs.a.filterByLabel(r,s)),n=n.filter((e=>!(this.typeFilter===$s.FilterType.ARCHIVED||!r.length||e!=R.CONV_FILTER.STRANGER)||(li.a.isArchivedChat(e)&&t||!li.a.isArchivedChat(e)&&!t)&&e!==R.CONV_FILTER.STRANGER&&!qs.a.isStrangerV2(e)&&!Zs.a.isThreadHidden(e))),i&&(this.typeFilter===$s.FilterType.ARCHIVED?n=n.concat(r):this.isUnboxStrangerAccount()||s.length?(this.isUnboxStrangerAccount()&&(null==s||!s.length)||null!=s&&s.length)&&(n=n.concat(r)):n=this.addStrangersToVisible(n,r)),n=n.filter(((e,t)=>n.indexOf(e)==t)),this.safeSortConvList(n,!1)}updateListArchivedChat(){this.typeFilter==$s.FilterType.FOCUSED?this.onTypeFilterChange($s.FilterType.FOCUSED,!0):this.typeFilter==$s.FilterType.ARCHIVED&&this.onTypeFilterChange($s.FilterType.ARCHIVED,!0)}onOffArchivedChat(e){if(!ms.default.enable_archived_chat)return;const t=mt.default.getConvUXVersion();this.isEnableArchivedChat&&e&&"2"==t&&(this.isEnableArchivedChat=!1,this.signalRenderState()),this.isEnableArchivedChat!=e&&(e||this.typeFilter!==$s.FilterType.ARCHIVED&&this.typeFilter!==$s.FilterType.FOCUSED?e&&this.onTypeFilterChange($s.FilterType.FOCUSED,!0):this.onTypeFilterChange($s.FilterType.ALL,!0),this.labelDataManager.onClearFilter(),this.setTypeFilterSrc($s.FilterSrcType.ALL),this.isEnableArchivedChat=e&&"3"==t,this.signalRenderState())}})||Vs)||Vs)||Vs)||Vs)||Vs)||Vs)||Vs)||Vs);var mi,pi=s("EYv5"),fi=s("BR4E"),vi=s("AtyM"),bi=s("R5gT"),yi=s("Xzw3"),Ii=s("d+hT"),_i=s("uEOi"),Ci=s("rQsU"),Oi=s("kTC5"),Si=s("4wTQ"),Ei=s("ES/k"),Mi=s("uAQs"),Ti=s("WBqA"),wi=s("qa8q"),Ri=s("vAzq"),Li=s("rkiK");const Fi={isFocusSearchBox:!1,isFocusOnRecentSearch:!1,searchText:"",searchResult:{},searching:!1,conversation:null,highlightId:"",filter:{timeFrom:0,timeTo:Date.now()}},Di=new Is.LocalId;var Ai=function(e){return e[e.STEP_CONTACT=0]="STEP_CONTACT",e[e.STEP_MESSAGES=1]="STEP_MESSAGES",e[e.STEP_FILES=2]="STEP_FILES",e[e.STEP_DIRECTORY=3]="STEP_DIRECTORY",e}(Ai||{});Object(Hs.b)($s.SearchController)(mi=function(e,t){return i.ModuleContainer.inject(Ci.b)(e,void 0,0)}(mi=function(e,t){return i.ModuleContainer.inject(xs.b)(e,void 0,1)}(mi=function(e,t){return i.ModuleContainer.inject(xs.i)(e,void 0,2)}(mi=Reflect.metadata("design:type",Function)(mi=Reflect.metadata("design:paramtypes",[void 0===Ci.b?Object:Ci.b,void 0===xs.b?Object:xs.b,void 0===xs.i?Object:xs.i])(mi=class{constructor(e,t,s){this.convListController=e,this.convDataManager=t,this.previewDataManager=s,this.state=void 0,this.pageLoad=void 0,this.curQuery=void 0,this.cacheResSearch=void 0,this.countQuery=void 0,this.countTimeUseGlobalSearch=void 0,this.countSelectTopRes=void 0,this.cacheSearch=void 0,this.trackSearch=void 0,this.trackSearchVietnamese=void 0,this.lastTextSearch=void 0,this.lastTextSearchTs=void 0,this.isShowRecentSearch=void 0,this.isFirstLoadSuccess=void 0,this.isSearchingMsg=void 0,this.searchDelay=void 0,this.closeBySendingMsg=void 0,this.clearAdminMode=void 0,this.timeouResetDataMsg=void 0,this.searchResultList=void 0,this.recentSearchList=void 0,this.searchInput=void 0,this.loadingMore=void 0,this.loadingMoreFiles=void 0,this.oldestTime=void 0,this.functionSearchByName=void 0,this.timeoutLog=void 0,this._timeDebounceSearch=null,this.dataLoaded=void 0,this._sbc=null,this._removeSearchResult=(e,t)=>{const s=this.getSearchState();if(s&&!s.conversation&&s.searchResult)if(t){if(!s.searchResult.groups)return;const t=[...s.searchResult.groups];for(let i=0;i<t.length;i++)if(t[i].userId==e){t.splice(i,1),this.updateState(Object(f.a)(Object(f.a)({},s),{},{searchResult:Object(f.a)(Object(f.a)({},s.searchResult),{},{groups:t})}));break}}else{if(!s.searchResult.friends)return;const t=[...s.searchResult.friends];for(let i=0;i<t.length;i++)if(t[i].userId==e){t.splice(i,1),this.updateState(Object(f.a)(Object(f.a)({},s),{},{searchResult:Object(f.a)(Object(f.a)({},s.searchResult),{},{friends:t})}));break}}},this._recordedCPUUsageTs=void 0,this.name=$s.SEARCH_CONTROLLER,this.key="windowId",this.state=Fi,this.pageLoad=0,this.curQuery="",this.countQuery=0,this.countTimeUseGlobalSearch=0,this.countSelectTopRes=0,this.cacheSearch={items:[],keywords:null},this.trackSearch=!1,this.trackSearchVietnamese=!1,this.lastTextSearch="",this.lastTextSearchTs=0,this.isShowRecentSearch=!1,this.searchDelay=this._getSearchDelaySetting(),this.closeBySendingMsg=!1,this.loadingMore=!1,this.loadingMoreFiles=!1,this.oldestTime=0,this.timeoutLog=null,this.isFirstLoadSuccess=!1,this.isSearchingMsg=!1,this.dataLoaded=null,this._innerSearchFunc=this._innerSearchFunc.bind(this),this.functionSearchByName=Is.default.throttle(this._innerSearchFunc,this.searchDelay),this.onKeywordChange=this.onKeywordChange.bind(this),this.loadMoreMessagesV2=this.loadMoreMessagesV2.bind(this),this.loadMessagesV2=this.loadMessagesV2.bind(this),this.loadMoreFiles=this.loadMoreFiles.bind(this),this.onKeyPressInput=this.onKeyPressInput.bind(this),this.onFocusInput=this.onFocusInput.bind(this),this.onBlurInput=this.onBlurInput.bind(this),this.onclickCloseSearchButton=this.onclickCloseSearchButton.bind(this),this.onClickClearSearch=this.onClickClearSearch.bind(this),this.onSearchKeyword=this.onSearchKeyword.bind(this),this.setRecentSearchFocusState=this.setRecentSearchFocusState.bind(this),this.focusSearchBox=this.focusSearchBox.bind(this),this.selectResult=this.selectResult.bind(this),this.onFileSelect=this.onFileSelect.bind(this),this.selectTopRes=this.selectTopRes.bind(this),this.listenEvents()}get sidebarController(){return this._sbc||(this._sbc=i.ModuleContainer.resolve($s.SidebarController)),this._sbc}listenEvents(){Cs.default.subscribe(((e,t)=>{switch(e){case Os.SideBarActions.FOCUS_SEARCH_INPUT:this.focusSearchBox();break;case Os.FetchActions.FRIENDS_REMOVED:this._removeSearchResult(t,!1);break;case Os.FetchActions.GROUP_LEAVE:this._removeSearchResult(t,!0);break;case Os.SideBarActions.SEARCH_FILE_DONE:this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!1}));break;case Os.SideBarActions.CLEAR_SEARCH:this.clearSearch();break;case Os.ConversationListActions.SELECT_CONVERSATION:setTimeout((()=>{this.state.highlightId!==t.userId&&this.setRecentSearchFocusState(!1,!1,!0),t.callPoint!==ni.a.JumpMessage&&this.updateStateOf("highlightId",null==t?void 0:t.userId)}),0)}}))}logSearch(e){$e.p.getDebugSearch().showLogSearchFlow}updateState(e,t=!0){this.state=e,t&&Object(Kt.g)(this.name,Qs.c)}isTextKey(e){return e.match(/^[a-zA-Z0-9!@#$%^&*)(+=._-|\\\[\]{}~`"\';:?/<>,-\s\n]$/)}isMultipleKeyPressed(e){return e.ctrlKey||e.metaKey||e.altKey}isKeywordStale(e){return Ei.a.formatTextSearch(e)!==Ei.a.formatTextSearch(this.state.searchText)}bindUIList(e,t){this._updateListRef(e,t)}cleanUpUIList(e){this._updateListRef(e,null)}bindUISearchInput(e){this.searchInput=e}cleanUpUISearchInput(){this.searchInput=null}_updateListRef(e,t){switch(e){case Oi.c.SEARCH_RESULT:this.searchResultList=t;break;case Oi.c.RECENT_SEARCH:this.recentSearchList=t}}resetState(){this.searchInput.value="",this.updateState(Object(f.a)({},Fi))}updateStateOf(e,t){this.state.hasOwnProperty(e)&&this.state[e]!==t&&("searchText"===e&&(this.searchInput.value=t),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{[e]:t})))}onKeyPressInput(e){if(this._isSelectAllSearchText()&&this.searchResultList&&this.isTextKey(e.key)&&!this.isMultipleKeyPressed(e)&&(this.searchResultList.openTabAll(),this.searchResultList.resetContactList()),e.which==R.K_BACK_SPACE?this.state&&this.state.searchText&&""!==this.state.searchText&&Vt.default.logAction(12307):""===this.state.searchText&&!this.timeoutLog&&this.isTextKey(e.key)&&(this.timeoutLog=setTimeout((()=>{this.timeoutLog=null,Vt.default.logAction(1232002)}),3e3)),e.which==R.K_ESC)!0===this.isShowRecentSearch&&(this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{isFocusOnRecentSearch:!1,isFocusSearchBox:!1})),this.searchInput&&this.searchInput.blur(),this.onCloseSearch()),""!=this.searchInput.value?this.clearSearch(!1):this.clearSearch(!0);else if(e.which==R.K_ENTER){let e=this.searchResultList||this.recentSearchList;if(e&&this.state.searchText){let t=e.selectFocusedConversation(!0);setTimeout((()=>{this.state.conversation?this.focusSearchBox():Zs.a.isThreadHidden(t)||Cs.default.send(Os.ChatBoxActions.FOCUS_INPUT,{userId:t,windowId:Qs.c})}),0)}}else if(e.which==R.K_UP||e.which==R.K_DOWN){this.searchResultList&&Vt.default.logAction(12317);let t=this.searchResultList||this.recentSearchList;t&&(e.stopPropagation(),e.preventDefault(),e.which==R.K_UP?t.moveUp():t.moveDown())}}onAbortSearch(){bi.a.getInstance().abortSearch()}onKeywordChange(e,t){let s="";if(s=!e&&t?t:e.target.value,s&&(s=Is.default.ZSafeFunction((()=>s.normalize()),s)),this.countTimeUseGlobalSearch||(this.countTimeUseGlobalSearch=vi.a.now(),this.countSelectTopRes=0),s){const e=Ei.a.formatTextSearch(this.lastTextSearch),t=Ei.a.formatTextSearch(s);Is.default.log("searching: true"),ms.default.stagingAccount&&this._checkOnAdminMode(s),this.trackSearch||(this.trackSearch=!0,Vt.default.logAction(12318)),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchText:s})),this.countQuery=Di.next(),this.functionSearchByName(s,this.countQuery,e!==t)}else{this._resetCacheResultSearch();bi.a.getInstance().abortSearch(),this.clearSearch(!1)}}onFocusInput(){Ti.a.onNewSession(Qs.c),this.searchInput&&""!==this.searchInput.value&&this.searchInput.select(),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{isFocusSearchBox:!0})),Vt.default.logAction(1232001)}onBlurInput(){setTimeout((()=>{this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{isFocusSearchBox:!1})),this.searchInput&&""==this.searchInput.value&&this.qosLogSearch()}),20)}onclickCloseSearchButton(e){this.setRecentSearchFocusState(!1),this.onCloseSearch(),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),Vt.default.logAction(1232003),e&&(e.stopPropagation(),e.preventDefault())}onClickClearSearch(){$e.p.resetGlobalSearchMode(),this.state.conversation&&Vt.default.logAction(12314),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),this.focusSearchBox(),Vt.default.logAction(1232006)}onSearchKeyword(e){"string"==typeof e&&this.searchInput&&(this.searchInput.value=e,this.onKeywordChange(null,e),_i.a.addCacheKeyword(e))}onRemoveKeyword(e){"string"==typeof e&&_i.a.removeCacheKeyword(e)}onFileSelect(e){null!=e&&e.msgId&&(this.updateStateOf("highlightId",e.msgId),this.state.searchText&&_i.a.addCacheKeyword(this.state.searchText))}setRecentSearchFocusState(e,t=!1,s=!1){if(!s){const t=this.sidebarController.getSelectedId();if(this.state.isFocusOnRecentSearch===e||t&&this.state.highlightId===t&&!e)return}this.state.isFocusOnRecentSearch=e,e&&(this.closeBySendingMsg=!1),Object(Kt.g)(this.name,Qs.c)}onCloseSearch(){var e,t;Vt.default.logAction(1232004),0==(null===(e=this.state.searchResult)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.length)&&Vt.default.logAction(1232202),this.qosLogSearch()}focusSearchBox(e=!1){this.searchInput&&(this.searchInput.focus(),e&&setTimeout((()=>{this.searchInput.select()}),0))}openRecentSearch(){this.searchInput?this.searchInput.focus():this.setRecentSearchFocusState(!0)}loadCachedMessages(e,t,s){var i,a;if(!this.dataLoaded)return void(s&&s(null,-1));let n="";if(!this.state.searchText)return;n=this.state.searchText;const r=()=>!(!this.state.searchText||!this.isKeywordStale(n)),o=!(!e||!e.timeFrom&&!e.timeTo&&"string"!=typeof e.sender),d=[],l=t?this.dataLoaded.indexCurrent:0,c=Math.min(l+20,this.dataLoaded.allSearchedMsgs.length);if(t||delete this.dataLoaded.oldestIndex,e&&e.timeFrom&&this.dataLoaded.oldestIndex&&c>=this.dataLoaded.oldestIndex)return void(s&&s(null,-1,!1));if(c<=l)return void(s&&s(null,-1,!1));this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!0}));let h=this.dataLoaded.allSearchedMsgs.slice(l,c);this.dataLoaded.indexCurrent=c;const u=i=>{let a=[];if(this.loadingMore=!1,this.isSearchingMsg=!1,r())s&&s(null,-1);else if(i&&i.listConv&&i.arr){if(this.convListController.getRecentContacts().forEach((e=>{let t=i.listConv.indexOf(e.userId);if(t>=0&&!Zs.a.isThreadHidden(e.userId))for(let s=t;s<i.listConv.length;++s)i.listConv[s]==e.userId&&(i.arr[s].conversation=e)})),i.arr.forEach((t=>{if(o){if(!t.message)return;if(e&&"string"==typeof e.sender&&e.sender!==t.message.fromUid)return;if(e&&e.timeFrom&&e.timeFrom>t.message.sendDttm)return void(this.dataLoaded.oldestIndex=this.dataLoaded.indexCurrent);if(e&&e.timeTo&&e.timeTo<t.message.sendDttm)return}Object.keys(t.conversation).length>1&&a.push(t)})),Array.prototype.push.apply(d,a),!r()&&this.isFirstLoadSuccess){if(t&&this.state.searchResult.messages){var n;const e=null===(n=this.state.searchResult.messages[this.state.searchResult.messages.length-1])||void 0===n?void 0:n.message;e&&e.sendDttm<i.maxTime?(a=this.state.searchResult.messages.concat(a),a=a.sort(((e,t)=>t.message.sendDttm-e.message.sendDttm))):a=this.state.searchResult.messages.concat(a)}this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{isMoreMsg:c<this.dataLoaded.allSearchedMsgs.length,messages:a}),searching:!1}));const r=!(o&&e.timeFrom&&c>=this.dataLoaded.allSearchedMsgs.length);s&&s(d,this.pageLoad,r)}}};fi.a.logTrace(`load more msg with key ${n} - msgID length: ${h.length} - ${c}/${null===(i=this.dataLoaded)||void 0===i||null===(a=i.allSearchedMsgs)||void 0===a?void 0:a.length}`),this.isSearchingMsg=!0;bi.a.getInstance().getMessages(h,r).then((e=>{u(e)})).catch((e=>{s&&s(null,-1)})).finally((()=>{this.isSearchingMsg=!1,this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!1}))}))}loadMessagesV2(e,t=!1,s){return this.loadCachedMessages(e,t,s)}loadMoreMessagesWithMsgIdsLoaded(e,t=!1,s){return this.loadCachedMessages(e,t,s)}isCanLoadMoreWithMsgIdsLoaded(){return!!(this.dataLoaded&&Is.default.valueValid(this.dataLoaded.indexCurrent)&&Is.default.valueValid(this.dataLoaded.allSearchedMsgs))&&!(this.dataLoaded.allSearchedMsgs.length<=this.dataLoaded.indexCurrent)}loadMoreMessagesWithRange(e,t,s,i){var a,n,r;let o=this.state.searchText;if(!o)return;let d=null===(a=this.searchResultList)||void 0===a?void 0:a.getRange(!t);if(d.timeTo<this.oldestTime)return;const l=!(!i||!i.timeFrom&&!i.timeTo&&"string"!=typeof i.sender),c=()=>!(!this.state.searchText||!this.isKeywordStale(o));this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:t?null===(n=this.state.searchResult)||void 0===n?void 0:n.messages:null,isMoreMsg:!!t&&(null===(r=this.state.searchResult)||void 0===r?void 0:r.isMoreMsg)}),searching:!0}));const h=e=>{this.isSearchingMsg=!1;let a=[],n=[];if(c())return this.pageLoad++,void(s&&s(null,-1));if(!e||!e.listConv||!e.arr)return void(s&&s(null,-1));this.convListController.getRecentContacts().forEach((t=>{let s=e.listConv.indexOf(t.userId);if(s>=0&&!Zs.a.isThreadHidden(t.userId))for(let i=s;i<e.listConv.length;++i)e.listConv[i]==t.userId&&(e.arr[i].conversation=t)})),e.arr.forEach((e=>{l&&i&&"string"==typeof i.sender&&i.sender!==e.message.fromUid||Object.keys(e.conversation).length>1&&n.push(e)})),Array.prototype.push.apply(a,n),t&&(n=this.state.searchResult.messages.concat(n)),this.dataLoaded?(e.dataLoaded.allSearchedMsgs&&(this.dataLoaded.allSearchedMsgs=this.dataLoaded.allSearchedMsgs.concat(e.dataLoaded.allSearchedMsgs)),e.dataLoaded.indexCurrent&&(this.dataLoaded.indexCurrent+=e.dataLoaded.indexCurrent)):this.dataLoaded=e.dataLoaded;const r=!(l&&i.timeFrom&&n.length<this.dataLoaded.allSearchedMsgs.length);this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:n,isMoreMsg:!(!n.length&&!this.dataLoaded.allSearchedMsgs.length)&&n.length<this.dataLoaded.allSearchedMsgs.length}),searching:!1})),s&&s(a,this.pageLoad,r)};let u={totalItemReq:4};fi.a.logTrace(`load more msg with range: ${d.timeFrom} - ${d.timeTo}`),this.isSearchingMsg=!0;bi.a.getInstance().searchGlobalMessagesV3(o,c,void 0,null,ms.default.limit_result_msg_search+1,d,u).then((e=>h(e))).catch((e=>{this.loadingMore=!1,s&&s(null,-1),Is.default.logCoreError("searchGlobalMsg v2 "+e)})).finally((()=>{this.isSearchingMsg=!1,this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!1}))}))}loadMoreMessagesV2(e,t=!1,s,i){if(this.isFirstLoadSuccess&&!this.isSearchingMsg)return ms.default.enable_optimize_search&&!Mi.a.isSearchOnSqlite3()?this.loadCachedMessages(i,t,s):t&&this.isCanLoadMoreWithMsgIdsLoaded()?this.loadMoreMessagesWithMsgIdsLoaded(i,t,s):(t||(this.dataLoaded=null),this.loadMoreMessagesWithRange(e,t,s,i));s&&s(null,-1)}loadMoreMessages(){let e=this.state.searchResult;if(Mi.a.isSearchOnSqlite3()&&e&&e.rawSearchResult&&e.messageList&&e.rawSearchResult.length>e.lastOffset&&!this.loadingMore){this.loadingMore=!0;const t=this.state.conversation.userId;bi.a.getInstance().getMessageOfConversation(e.rawSearchResult,this.state.conversation.userId,20,e.lastOffset).then((s=>{let i=s.list;if(this.state.conversation&&t==this.state.conversation.userId){let t=Is.default.ZSafeFunction((()=>Math.max(0,e.rawSearchResult.length-e.lastOffset-20)+e.messageList.length+i.length),s.len);i.length>0?this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messageList:this.state.searchResult.messageList.concat(i.map((e=>({message:e,conversation:this.state.conversation})))),realLen:t,lastOffset:this.state.searchResult.lastOffset+20})})):this.state&&this.state.searchResult&&(this.state.searchResult.realLen!==t?this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{realLen:t,lastOffset:e.lastOffset+20})})):this.state.searchResult.lastOffset+=20)}this.loadingMore=!1}))}}loadMoreFiles(){let e=this.state.searchResult,t=this.state.searchText;if(e&&e.rawFileResult&&e.files&&e.rawFileResult.length>e.lastFileOffset&&!this.loadingMoreFiles){this.loadingMoreFiles=!0;const s=e.rawFileResult.slice(e.lastFileOffset,e.lastFileOffset+20),a=new Map;s.forEach((e=>{const t=e.convId;a.has(t)||a.set(t,[]),a.set(t,a.get(t).concat(e.msgId))}));const n=i.ModuleContainer.resolve(pi.a),r=[];a.forEach(((e,t)=>{r.push(n.getMultiMedias("file",t,e).then((e=>({convID:t,media:e}))))})),Promise.all(r).then((i=>{if(this.loadingMoreFiles=!1,this.isKeywordStale(t))return;e=this.state.searchResult;const a=s.map((e=>{const t=i.find((t=>t.convID===e.convId));if(t)return t.media.find((t=>t.msgId===e.msgId))})).filter(Boolean);let n=Is.default.ZSafeFunction((()=>Math.max(0,e.rawFileResult.length-e.lastFileOffset-20)+e.files.length+a.length),e.realFileLen),r=this.state.searchResult.files.concat(a);r.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm))),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{files:r,realFileLen:n,lastFileOffset:e.lastFileOffset+20})}))})).catch((e=>{this.loadingMoreFiles=!1,Is.default.logCoreError("_loadMoreFiles ",e)}))}}qosLogSearch(){this.countTimeUseGlobalSearch&&(fs.default.increaseSuccess(97111,0,vi.a.now()-this.countTimeUseGlobalSearch),this.countTimeUseGlobalSearch=0),this.countSelectTopRes>=0&&(fs.default.increaseSuccess(97112,0,this.countSelectTopRes),this.countSelectTopRes=-1)}selectTopRes(){this.countSelectTopRes>=0&&this.countSelectTopRes++}selectResult(e,t=!1,s=!1,i=!1){var a;const n=this.state.searchText;let r=!!this.state.conversation;Si.a.jumpToMessage(e.message,null===(a=e.conversation)||void 0===a?void 0:a.userId,Lt.f).then((t=>{const{groupMsgs:s=[]}=t;let i=null;Is.default.ZSafeFunction((()=>{if(s)for(let t=0;t<s.length;t++)if(s[t].msgId==e.message.msgId)return i=Object(f.a)({},s[t]),void(i.searchKeyWord=n)}),null),this.state.searchText&&_i.a.addCacheKeyword(this.state.searchText),Cs.default.send(Os.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:s,focusId:[""+e.message.msgId],conversation:e.conversation}),i&&Object(Lt.f)({type:Os.ChatBoxActions.UPDATE_MESSAGE_ATTRIBUTES,payload:i})})).catch((t=>{Is.default.logCoreError(t),Ht.a.createWarning($t.default.str("STR_MESSAGE_NOT_FOUND")),i||Cs.default.send(Os.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:[],focusId:[],conversation:e.conversation})})),r?(s&&this.focusSearchBox(),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{highlightId:e.message.msgId}))):t||this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{highlightId:e.message.msgId}))}getRecentSearchItems(){if(0===ms.default.recent_search.is_enable)return[];let e=_i.a.getLocalRecentSearchList();if(!e)return[];let t=oi.default.getGroupsListSync(),s=t||[];return e=e.filter((e=>{if(e&&e.userId&&!Zs.a.isThreadHidden(e.userId)){if(e.userId.startsWith(R.GROUPID_PREFIX)||1===e.type){let t=!1;1!==e.type||e.userId.startsWith(R.GROUPID_PREFIX)||(e.userId=R.GROUPID_PREFIX+e.userId);for(let i of s)if(i.userId&&e.userId==i.userId){t=!0;break}return!!t||(_i.a.removeLocalRecentSearchList(e.userId),!1)}return!0}return!1})),e}getCacheRecentSearch(){return this.cacheSearch.items=this.getRecentSearchItems(),ms.default.sync_recent_search.enable_kw&&(this.cacheSearch.keywords=_i.a.getLocalKeywordList()),this.cacheSearch}getPageLoad(){return this.pageLoad}getSearchInputRef(){return this.searchInput}getSearchState(){return this.state}clearSearch(e=!0){if(this._resetCacheResultSearch(),this.onAbortSearch(),this.dataLoaded=null,this.searchInput.value="",this.lastTextSearch="",e){if(yi.b.setMode(yi.a.NORMAL),this.updateState(Object(f.a)({},Fi)),this.sidebarController.getState(Qs.c).currentTab==$s.SidebarTab.FILE_TAB)return void this.functionSearchByName(null,this.countQuery,!0)}else this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchText:"",searching:!0,highlightId:""})),this.functionSearchByName("",this.countQuery,!0)}_resetCacheResultSearch(){this.curQuery="",this.cacheResSearch=null,this.trackSearch=!1,this.trackSearchVietnamese=!1}_checkOnAdminMode(e){let t=this.__checkOnAdminMode(e);t&&(1===t?(this.clearAdminMode&&clearTimeout(this.clearAdminMode),ms.default.adminMode=!0,this.sidebarController.togglePerfTab(!0),this.clearAdminMode=setTimeout((()=>{this.clearAdminMode=void 0,ms.default.adminMode=void 0,this.sidebarController.togglePerfTab()}),216e5)):2===t&&(this.clearAdminMode&&(clearTimeout(this.clearAdminMode),this.clearAdminMode=void 0),ms.default.adminMode=!1,this.sidebarController.togglePerfTab(!1)))}__checkOnAdminMode(e){if(e&&"string"==typeof e&&e.startsWith("$##")){return e.substring(3)===ms.default.zAminKey?1:2}return 0}_innerSearchFunc(e,t,s=!0){if(!Di.valid(t))return;if(this.sidebarController.getState(Qs.c).currentTab===$s.SidebarTab.FILE_TAB)Cs.default.send(Os.SideBarActions.SEARCH_FILE,{term:e});else if(this.state.conversation)this.filterByConversation(e,this.state.conversation);else{const t=s&&this.isKeywordStale(this.lastTextSearch),a=Ei.a.formatTextSearch(e);var i;if(this.logSearch(`[Search flow] start search-------: ${t}, ${a}`),!a)null===(i=this.searchResultList)||void 0===i||i.forceStopSearch(),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:null,files:[],rawFileResult:[]})}));this._searchGlobal(e,t)}}debounceSearchMsgAndFile(e,t){this._timeDebounceSearch&&clearTimeout(this._timeDebounceSearch),this._timeDebounceSearch=setTimeout((()=>{e()}),t)}getTimeDebounceSearchMsgAndFile(){bi.a.getInstance();return ms.default.debounce_search_msg_optimize}_searchGlobal(e,t=!0){var s,a,n,r,o,d;Li.default.createCPUUsageRecorder(Li.CPUMetricName.search_global).start().then((e=>this._trackCPUUsageOnSearching(e))),this.lastTextSearchTs=Date.now(),this.lastTextSearch=e;let l=2,c=0,h={},u=this.convDataManager.getAllConvSync(),g=this.previewDataManager.getAllPreviewsSync(),m=Is.default.simpleStripVietnamese(e,!1);const p=(s,i)=>{s!==Ai.STEP_DIRECTORY&&s!==Ai.STEP_FILES&&l--;let a,n=1==l&&s===Ai.STEP_CONTACT&&0==c;if(a=!!(l>1||n),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:i,searching:a})),s===Ai.STEP_CONTACT&&t&&(ms.default.enable_optimize_search?this.debounceSearchMsgAndFile((()=>{v()?fi.a.logTrace(`abort debound search msg: ${e}`):(fi.a.logTrace(`do search msg & file: ${e}`),y(i&&!i.all.length),ms.default.tabbedGlobalSearchResult&&yi.b.setMode(yi.a.SEARCHING),ms.default.enableFileGlobalSearch&&b())}),this.getTimeDebounceSearchMsgAndFile()):(y(i&&!i.all.length),ms.default.tabbedGlobalSearchResult&&yi.b.setMode(yi.a.SEARCHING),ms.default.enableFileGlobalSearch&&b())),0==l&&!this.isKeywordStale(e)){let e=Date.now()-this.lastTextSearchTs;e>2e3?this._upSearchDelay():e<600&&this._downSearchDelay()}this.isKeywordStale(e)||this._trackPerformanceSearch(s,i,Date.now()-this.lastTextSearchTs)},v=()=>!!this.isKeywordStale(e),b=()=>{if(ms.default.adminConfig&&ms.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&p(Ai.STEP_FILES,this.state.searchResult)}),100);const t=(t,s=!0)=>{var a,n;if(this.isKeywordStale(e))return;(null!=t&&t.length||!s)&&wi.a.fileUIVisible(vi.a.now(),(null==t?void 0:t.length)||0);let r=new Set;const o=[];var d,l,h,u,g,m;if((t.forEach((e=>{const t=e.msgId;t&&!r.has(t)&&(r.add(t),o.push({msgId:t,convId:e.convId}))})),(null===(a=this.state.searchResult)||void 0===a||null===(n=a.rawFileResult)||void 0===n?void 0:n.length)>=20&&(null==o?void 0:o.length)>=20)&&((null===(d=this.state.searchResult)||void 0===d||null===(l=d.rawFileResult[0])||void 0===l?void 0:l.msgId)==(null===(h=o[0])||void 0===h?void 0:h.msgId)&&(null===(u=this.state.searchResult)||void 0===u||null===(g=u.rawFileResult[19])||void 0===g?void 0:g.msgId)==(null===(m=o[19])||void 0===m?void 0:m.msgId)))return void this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{rawFileResult:o,realFileLen:o.length})}),!1);const v=o.slice(0,20),b=new Map;v.forEach((e=>{const t=e.convId;b.has(t)||b.set(t,[]),b.set(t,b.get(t).concat(e.msgId))}));const y=i.ModuleContainer.resolve(pi.a),I=[];b.forEach(((e,t)=>{I.push(y.getMultiMedias("file",t,e).then((e=>({convID:t,media:e}))))})),Promise.all(I).then((t=>{if(this.isKeywordStale(e))return;const s=v.map((e=>{const s=t.find((t=>t.convID===e.convId));if(s)return s.media.find((t=>t.msgId===e.msgId))})).filter(Boolean);let i=[],a=0,n=0;for(const e of s)e?(i.push(e),a++):n++;i.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm)));let r=this.state.searchResult;Is.default.log("search files: cur = "+r.searchKey+" this query = "+e,i.length),r=r?Object(f.a)({},r):{},r.files=i,r.realFileLen=o.length-n,r.rawFileResult=o,r.lastFileOffset=v.length,r.searchKey=e,c+=a,p(Ai.STEP_FILES,r)})).catch((t=>{Is.default.logCoreError("doSearchFiles "+t),this.state&&!this.isKeywordStale(e)&&p(Ai.STEP_FILES,this.state.searchResult)}))};wi.a.startQueryFile(vi.a.now());bi.a.getInstance().search(e,null,{msgType:R.MSG_FILE},t,{enableReject:!0}).then((e=>{t(e,!1)})).catch((e=>{this.state.searchResult.files&&this.state.searchResult.files.length||this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{files:[]})}),!0)}))},y=(t=!1)=>{if(ms.default.adminConfig&&ms.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&p(Ai.STEP_MESSAGES,this.state.searchResult)}),100);this.logSearch(`[Search flow] search msg: ${e}`);const s=(t,s=!1)=>{var i;if(s&&(this.isSearchingMsg=!1),this.logSearch(`[Search flow] search msg res first load: ${e}, ${null===(i=t.arr)||void 0===i?void 0:i.length}`),this.pageLoad=0,this.timeouResetDataMsg&&(clearTimeout(this.timeouResetDataMsg),this.timeouResetDataMsg=!1,this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:null})}),!1)),!this.isKeywordStale(e)&&t){let i=[],r=0;t&&t.listConv&&t.arr&&u.forEach((e=>{let s=t.listConv.indexOf(e.userId);if(s>=0&&!Zs.a.isThreadHidden(e.userId))for(let a=s;a<t.listConv.length;++a)t.listConv[a]==e.userId&&(t.arr[a].conversation=e,r+=1,i.push(t.arr[a]))}));let o=this.state.searchResult,d=i;var a;if(o.messages&&(d=o.messages.slice(),Array.prototype.push.apply(d,i)),d.sort(((e,t)=>parseInt(t.message.sendDttm)-parseInt(e.message.sendDttm))),o=o?Object(f.a)({},o):{},o.messages=d,o.searchKey=e,o.isMoreMsg=t.isMoreMsg,this.dataLoaded=t.dataLoaded,c+=r,s)this.isFirstLoadSuccess=!0,this.searchResultList&&n&&this.searchResultList.updateFirstLoadPos(n.timeFrom),Is.default.logCoreError("[Global search] check First data",e,null===(a=this.state.searchResult.messages)||void 0===a?void 0:a.length);else if(!i.length)return;p(Ai.STEP_MESSAGES,o)}};let i=null;var a;this.searchResultList&&(!this.timeouResetDataMsg&&this.state.searchResult.messages&&(this.timeouResetDataMsg=setTimeout((()=>{this.timeouResetDataMsg=!1,this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:null})})),this.searchResultList&&this.searchResultList.resetDataSearch()}),1e3)),this.searchResultList.resetDataSearch(),Mi.a.isSearchOnSqlite3()&&(i=null===(a=this.searchResultList)||void 0===a?void 0:a.getRange(),this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{filter:{timeFrom:i.timeFrom,timeTo:i.timeTo}}),!1)));const n=Object(f.a)({},i);this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{searching:!0,highlightId:"",searchResult:Object(f.a)(Object(f.a)({},this.state.searchResult),{},{messages:!this.lastTextSearch||e.length<this.lastTextSearch.length?null:this.state.searchResult.messages})})),this.loadingMore=!1,this.isFirstLoadSuccess=!1;let r={};t||(r.totalItemReq=4);const o=bi.a.getInstance();wi.a.startQueryMsg(vi.a.now(),o.isEnableSearchSqlite),this.isSearchingMsg=!0,o.searchGlobalMessagesV3(e,(()=>!(!Mi.a.isSearchOnSqlite3()||this.state.filter.timeFrom==n.timeFrom&&this.state.filter.timeTo==n.timeTo)||v()),void 0,s,ms.default.limit_result_msg_search+1,i,r).then((e=>s(e,!0))).catch((t=>{if(this.logSearch(`[Search flow] search msg fail: ${t}`),Is.default.logCoreError("searchGlobalMsg "+t),this.state&&!this.isKeywordStale(e)){this.searchResultList&&this.searchResultList.forceStopSearch(),this.timeouResetDataMsg&&(clearTimeout(this.timeouResetDataMsg),this.timeouResetDataMsg=!1);let e=this.state.searchResult;e.messages=[],p(Ai.STEP_MESSAGES,e)}})).finally((()=>{this.isSearchingMsg=!1}))};if(this.curQuery&&0!==e.indexOf(this.curQuery)&&this._resetCacheResultSearch(),!this.cacheResSearch){const e=e=>{for(const t of e){const e=t.userId||t.convId;t&&!h[e]&&(null!=t&&t.userId||(t.userId=e),null!=t&&t.infoSearch&&delete t.infoSearch,null!=t&&t.isDirectory&&delete t.isDirectory,h[e]=t)}};g.length&&e(g),e(zt.default.getFriendsSync()),e(oi.default.getGroupsListSync())}const I=vi.a.now();wi.a.setKeyword(e),wi.a.resetTracking(),Ii.a.search(e,this.cacheResSearch?this.cacheResSearch:h,{hasSection:!0,suggestGroupWithMember:!0,searchFriendInGroup:!0,isCalc:!0,updateLastChat:!this.cacheResSearch,searchPb:!0,searchZName:!0,searchNumPhone:!0,filterHidden:Zs.a.isKeyPIN(e)}).then((t=>{var s;wi.a.trackingContact(vi.a.now()-I,null==t||null===(s=t.all)||void 0===s?void 0:s.length);let i=this.state.searchResult;if(!this.isKeywordStale(e)){{var a;let s=[];if(Zs.a.isKeyPIN(e)){Vt.default.logAction(1970601);const e=Zs.a.getUidsHiddenChat();if(e.length)for(let t of e){let e=!1;for(let i of u)if(i&&i.userId==t){s.push(Object(f.a)(Object(f.a)({},i),{},{infoSearch:{}})),e=!0;break}if(!e){let e=null;e=t.startsWith(R.GROUPID_PREFIX)?oi.default.getGroupByIdSync(t):zt.default.getProfileFriendSync(t),e&&(e.lastMessageTime||(e.lastMessageTime=0),s.push(Object(f.a)(Object(f.a)({},e),{},{infoSearch:{}})))}}}this.curQuery||(this.curQuery=e),!this.cacheResSearch&&t.orderAll&&t.orderAll.constructor==Array&&t.orderAll.length>0&&(this.cacheResSearch=h),null!==(a=t.phone)&&void 0!==a&&a.length&&(t.phone=t.phone.filter((e=>e.userId))),i=i?Object(f.a)({},i):{},i.recentChat=t.recentChat,i.groups=t.groups,i.friends=t.friends,i.oa=t.oa,i.directory=t.directory,i.searchKey=e,i.phone=t.phone,i.hiddenChat=s,i.all=t.all,i.orderAll=t.orderAll,c+=(i.groups?i.groups.length:0)+(i.friends?i.friends.length:0)+(i.oa?i.oa.length:0),c+=(i.recentChat?i.recentChat.length:0)+i.hiddenChat.length}p(Ai.STEP_CONTACT,i)}})).catch((e=>{Is.default.logCoreError(e)})),0==(null===(s=this.state.searchResult)||void 0===s||null===(a=s.messages)||void 0===a?void 0:a.length)&&0==(null===(n=this.state.searchResult)||void 0===n||null===(r=n.all)||void 0===r?void 0:r.length)&&0==(null===(o=this.state.searchResult)||void 0===o||null===(d=o.files)||void 0===d?void 0:d.length)&&Vt.default.logAction(1232201),m===e||this.trackSearchVietnamese||(this.trackSearchVietnamese=!0,Vt.default.logAction(1232010))}filterByConversation(e,t){if(!e)return this.searchInput.value="",void this.updateState(Object(f.a)(Object(f.a)({},Fi),{},{conversation:t,searching:!1,highlightId:""}));let s=(s,i=!1)=>{if(this.isKeywordStale(e))return void Is.default.logCoreError("search: abort filtermode 1",this.state.searchText,e);if(i&&(!s||0==s.length))return;bi.a.getInstance().getMessageOfConversation(s,t.userId,20).then((a=>{if(this.isKeywordStale(e))return void Is.default.logCoreError("search: abort filtermode 2",this.state.searchText,e);let n=a.list;if(i&&(!n||0===n.length))return;let r=n.length<20&&s.length>20;n.length>0?(this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{conversation:t,searchResult:{messageList:n.map((e=>({message:e,conversation:t}))),realLen:a.len,rawSearchResult:s,lastOffset:20,progress:i},searching:!1,highlightId:n[0].msgId})),i||(this.focusSearchBox(),r&&this.loadMoreMessages()),!i&&this.searchResultList&&this.searchResultList.scrollToTop&&this.searchResultList.scrollToTop()):(this.updateState(Object(f.a)(Object(f.a)({},this.state),{},{conversation:t,searchResult:{messageList:[],realLen:0,lastOffset:0,progress:!1},searching:!1,highlightId:""})),this.focusSearchBox(),!i&&r&&this.loadMoreMessages())}))};bi.a.getInstance().search(e,null,{convId:t.userId+""},(e=>{s(e,!0)})).then((e=>{s(e)}))}_getSearchDelaySetting(){return 70}_upSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.min(400,Math.round(1.1*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_downSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.max(70,Math.round(.9*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_resetSearchFunction(){Is.default.logCoreError("__rssf__",this.searchDelay),this.functionSearchByName=Is.default.throttle(this._innerSearchFunc,this.searchDelay)}_isSelectAllSearchText(){if(this.searchInput){const e=this.searchInput.selectionStart,t=this.searchInput.selectionEnd;return!(!this.searchInput.value.length||0!=e||t!=this.searchInput.value.length)}return!1}_trackPerformanceSearch(e,t,s){var i,a,n,r,o;const d={[Ai.STEP_MESSAGES]:"msg",[Ai.STEP_FILES]:"file",[Ai.STEP_CONTACT]:"contact"}[e];let l={[Ai.STEP_MESSAGES]:null==t||null===(i=t.messages)||void 0===i?void 0:i.length,[Ai.STEP_FILES]:null==t||null===(a=t.files)||void 0===a?void 0:a.length,[Ai.STEP_CONTACT]:((null==t||null===(n=t.groups)||void 0===n?void 0:n.length)||0)+((null==t||null===(r=t.friends)||void 0===r?void 0:r.length)||0)+((null==t||null===(o=t.oa)||void 0===o?void 0:o.length)||0)}[e]||0;if(d&&l){Object(Ri.b)().logInfo(Ri.a.GlobalSearch,{duration:s,search_type:d,result_size:l})}}_trackCPUUsageOnSearching(e){if(!e||this._recordedCPUUsageTs&&this._recordedCPUUsageTs>=e.endAt)return;this._recordedCPUUsageTs=e.endAt;Object(Ri.b)().logInfo(Ri.a.CPU_GlobalSearch,{cpu:e.cpu,duration:e.endAt-e.startAt,process:e.processes.map((e=>({cpu:e.cpu,name:e.name,type:e.type})))})}init(){}getItem(e){return this.state}getList(e){throw new Error("No imp!!!")}onGetItemFailure(e){}onGetListFailure(e){}loadOldestTime(){this.loadOldestTimeWithRetry(ms.default.sqlite_mac.max_load_oldest_time_retry).then((e=>{this.oldestTime=e})).catch((e=>{fi.a.logError("loadOldestTime fail after retrying",e),this.oldestTime=0}))}async loadOldestTimeWithRetry(e){return new Promise(((t,s)=>{bi.a.getInstance().getOldestTime().then((e=>{e&&e.length&&!isNaN(e[0].ts)?t(+e[0].ts):t(0)})).catch((i=>{fi.a.logError("loadOldestTime fail",`remaining times: ${e}`,i),e>0?setTimeout((()=>{this.loadOldestTimeWithRetry(e-1).then(t).catch(s)}),0):s(i)}))}))}getOldestTime(){return this.oldestTime}getTotalQueriedMsgIds(){var e,t;return null===(e=this.dataLoaded)||void 0===e||null===(t=e.allSearchedMsgs)||void 0===t?void 0:t.length}})||mi)||mi)||mi)||mi)||mi);var ji,Pi=s("OlUt"),Ni=s("jnrz"),Ui=s("Anfm"),ki=s("BZLJ"),Bi=s("A9FD"),Gi=s("BKm0"),xi=s("iKSP");const zi={windowId:Qs.c,theme:Pi.a.default,currentTab:$s.SidebarTab.MESSAGE_TAB,previousTab:$s.SidebarTab.MESSAGE_TAB,selectedId:null,previousId:null,showExportImportEntry:!0},Vi="z_sendtome_bubbledot",Hi="SIDEBAR CONTROLLER";function $i(...e){Is.default.logCoreInfo(`[${Hi}] - `,e)}Object(ke.i)()(ji=Object(Hs.b)($s.SidebarController)(ji=function(e,t){return i.ModuleContainer.inject($s.ConvListController)(e,void 0,0)}(ji=function(e,t){return i.ModuleContainer.inject(Oi.b)(e,void 0,1)}(ji=Reflect.metadata("design:type",Function)(ji=Reflect.metadata("design:paramtypes",[void 0===$s.ConvListController?Object:$s.ConvListController,void 0===Oi.b?Object:Oi.b])(ji=class{constructor(e,t){this.convListController=e,this.searchController=t,this.changeTabFromSearch=void 0,this._firstTimePageLoad=void 0,this._querySelect=void 0,this._convsLoaded=void 0,this._exportImportFinished=void 0,this._exportImportProgressError=void 0,this._allowAutoJumpFC=void 0,this._es=void 0,this._onSendMsg=e=>{var t,s;const i=(null==e||null===(t=e.messages)||void 0===t||null===(s=t[0])||void 0===s?void 0:s.upSrc)&R.FILE_UP_SRC.TextEditor,a=this.getState();if(a.currentTab==$s.SidebarTab.TODO_TAB||a.currentTab==$s.SidebarTab.CATALOG_TAB||i||e.isChild)return;const n=this.searchController.getSearchState();a.currentTab!==$s.SidebarTab.MESSAGE_TAB||n&&n.searchText?(a.currentTab=$s.SidebarTab.MESSAGE_TAB,Object(Kt.g)(this.name,Qs.c),Object(Lt.f)({type:Os.SideBarActions.SHOW_CHAT_VIEW}),n&&n.searchText&&Vt.default.logAction(1232007),this.searchController.clearSearch(!0)):a.currentTab==$s.SidebarTab.MESSAGE_TAB&&this.searchController.setRecentSearchFocusState(!1,!1,!0),this.searchController.closeBySendingMsg=!0,setTimeout((()=>{this.convListController.scrollToTop(!1)}),100)},this.changeTab=(e,t=Qs.c)=>{const s=this._getStateByWindowId(t);let i=s.currentTab;s.currentTab!==e&&(s.currentTab=e,Object(Kt.g)(this.name,t)),this._onChangeTab(s.currentTab,i)},this.togglePerfTab=e=>{const t=this._getStateByWindowId(Qs.c);t.showPerfTab!==e&&(t.showPerfTab=e,Object(Kt.g)(this.name,Qs.c))},this.changeTheme=async e=>{const t=this._getStateByWindowId(Qs.c);t.theme!==e&&(t.theme=e,Object(Kt.g)(this.name,Qs.c))},this.selectMessageTab=()=>{this.changeTab($s.SidebarTab.MESSAGE_TAB)},this.selectTodoTab=()=>{this.changeTab($s.SidebarTab.TODO_TAB),Vt.default.logAction(171),ki.h.setViewPopupTodoSrc(ki.c.TAB_ICON)},this.selectContactFromSearch=async(e,t=!1)=>{if(!e)return $i("Select friend null!"),Promise.resolve(!1);const s=await i.ModuleContainer.resolve(ni.b).openConversation(e.userId,ni.c.fromSearchList(e));return!0===t?(this.searchController.onCloseSearch(),this.searchController.resetState()):this.searchController.updateStateOf("highlightId",e.userId),s?(e&&e.userId===ms.default.sendToMeId&&(ei.g.getFlagForCurrentUser(this.currUser.userId,Vi)||($e.p.getHasShownSendToMeTip()?ei.g.setFlagForCurrentUser(this.currUser.userId,Vi,1):setTimeout((()=>{Cs.default.send(Os.ConversationListActions.SHOW_BUBBLE_DOT),$e.p.setHasShownSendToMeTip(!0)}),144e5)),Vt.default.logAction(1390101)),Promise.resolve(!0)):($i("Open conv failure"),Promise.resolve(!1))},this.setupSelectConvOnPageLoad=()=>{if(!this._firstTimePageLoad)return;let e=this._getQueryParams();if(e.c){Is.default.logCoreInfo(`[${this.name}] - setup select conv c`);const t=e=>{const t={[e]:!0};this._querySelect=()=>{let s;s=e.startsWith(R.GROUPID_PREFIX)?ys.default.fetchGroupsIfNotExpire(t):ys.default.fetchFriendsIfNotExist(t),s.then((t=>{t&&t[e]?this.selectContactFromSearch(t[e]):Is.default.logCoreInfo(`[${this.name}] - auto open conv with id ${e} does not exist`)})).catch((e=>{Is.default.logCoreError(e)}))},this._autoSelectConv()},s=e.c;e.convert?ys.default.convertOAIds([s]).then((e=>{e&&e[s]&&t(e[s])})):t(s),this._firstTimePageLoad=!1}else if(e.g)Is.default.logCoreInfo(`[${this.name}] - setup select conv g`),xt.a.autoSelectGroupByLink(`https://${ms.default.CONFIG_DOMAIN}/g/`+encodeURIComponent(e.g));else if(e.zs);else if(e.phone){let t=e.phone,s=e.openConv;!t||isNaN(t)||this._querySelect||(Is.default.logCoreInfo(`[${this.name}] - setup select conv p`),this._querySelect=()=>{s?xt.a.autoOpenConversationByPhone(t,Lt.e):xt.a.autoSelectConversationByPhone(t,Lt.e)},this._autoSelectConv())}else if(e.alias){Is.default.logCoreInfo(`[${this.name}] - setup select conv a`);let t=e.alias;this._querySelect||(this._querySelect=()=>{xt.a.autoSelectConversationByAlias(t,Lt.e)},this._autoSelectConv())}},this.name=$s.SIDEBAR_CONTROLLER,this.data=new Map,this.key="windowId",this.changeTabFromSearch=!1,this._firstTimePageLoad=!0,this._convsLoaded=!1,this._allowAutoJumpFC=!1,this.selectConversationForFriend=this.selectConversationForFriend.bind(this),this.listenEvents()}get currUser(){return Object(si.c)()}get autoJumFC(){return this._allowAutoJumpFC}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}onStart(e){i.ModuleContainer.resolve(ni.b)}listenEvents(){Cs.default.subscribe(((e,t)=>{switch(e){case Os.ChatBoxActions.SEND_MSG:this._onSendMsg(t);break;case Os.ChatBoxActions.SELECT_FRIEND:this.selectConversationForFriend(t);break;case Os.SideBarActions.SHOW_FILE_MANAGER:this.getState().currentTab=$s.SidebarTab.FILE_TAB,Object(Kt.g)(this.name,Qs.c);break;case Os.SideBarActions.SELECT_TAB_MSG:this.changeTab($s.SidebarTab.MESSAGE_TAB);break;case Os.FetchActions.DELETE_CONVERSATION:case Os.FetchActions.GROUP_LEAVE:{const e=this.getState();e.previousId&&t===e.previousId&&(e.previousId=null);break}case Os.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:case Os.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH:this.getState().currentTab==$s.SidebarTab.FILE_TAB&&this.changeTab($s.SidebarTab.MESSAGE_TAB);break;case Os.TodoActions.OPEN_TODO_LIST:{const e=ai.b.instance().getTodoView();e?e.onCheckOpenTab():this.changeTab($s.SidebarTab.TODO_TAB);break}case Os.ActionList.ACT_OPEN_TAB_CHAT:this.selectMessageTab();break;case Os.ActionList.ACT_OPEN_TAB_CONTACT:this.changeTab($s.SidebarTab.CONTACT_TAB);break;case Os.ActionList.ACT_OPEN_GROUPLIST:if(this.getState().currentTab===$s.SidebarTab.CONTACT_TAB){const e=ai.b.instance().getContactList();e&&e.onJumpGroupCenter()}else this.changeTab($s.SidebarTab.CONTACT_TAB);break;case Gi.b.EXPORT_IMPORT_START:this._exportImportFinished=!1,this._exportImportProgressError=!1;break;case Gi.b.EXPORT_IMPORT_FINISHED:this._exportImportFinished=!0,this._exportImportProgressError=!1;break;case Gi.b.IMPORT_DB_PROGRESS:case Gi.b.IMPORT_PROGRESS:case Gi.b.EXPORT_PROGRESS:case Gi.b.EXPORT_DB_PROGRESS:t&&t.error&&(this._exportImportProgressError=!0);break;case Os.ConversationListActions.SELECT_CONVERSATION:{const e=this.getState();e.currentTab!==$s.SidebarTab.FILE_TAB&&e.currentTab!==$s.SidebarTab.CATALOG_TAB&&e.currentTab!==$s.SidebarTab.ZCLOUD_TAB||this.changeTab($s.SidebarTab.MESSAGE_TAB);break}}})),Ds.a.ConvInfoDataManager.addEventListener(Ks.b.DoneLoadDB,(e=>{this._convsLoaded=!0,this._autoSelectConv()})),Ds.a.UnreadDataManager.addEventListener(Ks.b.DoneLoadDB,(e=>{Ni.b.onDoneLoadUnreadDB(null==e?void 0:e.payload)}))}getState(e=Qs.c){return this._getStateByWindowId(e)}getSelectedId(e){return this.getState(e).selectedId||null}getCurrMainConvId(){const e=this.eventStore.getState();return e&&e.chatview.view===xi.c.CHAT_VIEW?this.getSelectedId():null}updateSelectedId(e,t=Qs.c){const s=this._getStateByWindowId(t);s.selectedId!==e&&(s.previousId=e?null:s.selectedId,s.selectedId=e,Object(Kt.g)(this.name,t))}updateSelectedIdWithoutPrevious(e,t=Qs.c){const s=this._getStateByWindowId(t);s.selectedId!==e&&(s.previousId=null,s.selectedId=e,Object(Kt.g)(this.name,t))}isInImportExportProcess(){const e=this._exportImportFinished||this._exportImportProgressError;return void 0!==e&&!e}openFriendCenter(){}selectConversationForFriend(e,t=!1){if(!e)return void Is.default.logCoreError("friend null");if(Lt.f&&(Object(Lt.f)({type:Os.ConversationListActions.SELECT_CONV_MINOR,payload:e}),Object(Lt.f)({type:Os.ChatBoxActions.READ_CONVERSATION,payload:{conversationId:e.userId}})),e.userId==this.currUser.userId)return void this._showMyProfile();let s=this.convListController.getRecentContactWithId(e.userId),i=!1;if(s)i=!0;else{let t=t=>{t&&t.includes(e.userId)&&(s=Object(f.a)({},t[e.userId]))};s||t(oi.default.getGroupsListSync()),s||t(zt.default.getFriendsSync()),s||(s={}),Object.assign(s,e),s.isFr=s.isFr||0,s.type=s.type||R.FRIEND_TYPE_NORMAL}e.byPassPIN?s.byPassPIN=1:s.byPassPIN&&delete s.byPassPIN,setTimeout((()=>{Object(Lt.f)({type:Os.ConversationListActions.SELECT_CONVERSATION,payload:s})}),0);const a=this.data.get(Qs.c);let n=null==a?void 0:a.currentTab;!0===t?(n=i?$s.SidebarTab.MESSAGE_TAB:$s.SidebarTab.CONTACT_TAB,n===$s.SidebarTab.CONTACT_TAB&&(Is.default.log("sidebar: select from search, should highlight thread"),this.changeTabFromSearch=!0),this.searchController.onCloseSearch(),this.searchController.resetState(),!e.userId||!e.byPassPIN&&Zs.a.isThreadHidden(e.userId)||setTimeout((()=>{Cs.default.send(Os.ChatBoxActions.FOCUS_INPUT,{userId:e.userId,windowId:Qs.c})}),0)):this.searchController.updateStateOf("highlightId",e.userId),this.updateState(Object(f.a)(Object(f.a)({},a),{},{currentTab:n,selectedId:e.userId})),e&&e.userId===ms.default.sendToMeId&&(ei.g.getFlagForCurrentUser(this.currUser.userId,Vi)||($e.p.getHasShownSendToMeTip()?ei.g.setFlagForCurrentUser(this.currUser.userId,Vi,1):setTimeout((()=>{Cs.default.send(Os.ConversationListActions.SHOW_BUBBLE_DOT),$e.p.setHasShownSendToMeTip(!0)}),144e5)))}showAddFriendModal(){Vt.default.logAction(1020203),Vt.default.logAction(12316),Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.FIND_FRIEND})}showGroupCompose(){Vt.default.logAction(1020202),Ui.c.markStart(Ui.a.CREATE_GROUP,Ui.b.Group.CREATE_GR_HEADER_ICON);const e=$e.p.getSessionUserId(),t=(e=!0)=>{Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.CREATE_GROUP_COMPOSE,params:{needInitE2ee:e},forceCloseAll:!1})};!ei.g.getTimeEntryPointE2eGroup(e,Ui.b.Group.CREATE_GR_HEADER_ICON)&&ms.default.e2ee.enable_group&&ms.default.e2ee.group.can_enable_right_in_creation_step?Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.E2EE_ONBOARDING,params:{entry:Bi.e.CREATE_GROUP,entrySrc:Ui.b.Group.CREATE_GR_HEADER_ICON,isGroup:!0,userId:"",callback:t,callbackCancel:t},forceCloseAll:!1}):t(!1)}enableAutoJupmFC(){this._allowAutoJumpFC=!0}disableAutoJupmFC(){this._allowAutoJumpFC=!1}init(){}getItem(e){const t=e.key;return this._getStateByWindowId(t)}getList(e){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}updateState(e,t=Qs.c,s=!0){this.data.set(t,e),s&&Object(Kt.g)(this.name,t)}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(f.a)({},zi),this.data.set(e,t)),t}_onChangeTab(e,t){switch(function(){switch(e){case $s.SidebarTab.MESSAGE_TAB:Vt.default.logAction(12801);break;case $s.SidebarTab.CONTACT_TAB:Vt.default.logAction(12802),3===ms.default.noti_center_config.entry_position&&Vt.default.logAction(1281205);break;case $s.SidebarTab.MENTION_TAB:Vt.default.logAction(12805);break;case $s.SidebarTab.STAR_TAB:Vt.default.logAction(12806);break;case $s.SidebarTab.FILE_TAB:Vt.default.logAction(133);break;case $s.SidebarTab.TODO_TAB:3===ms.default.noti_center_config.entry_position&&Vt.default.logAction(1281206)}}(),$e.p.resetGlobalSearchMode(),this.searchController.clearSearch(!0),e){case $s.SidebarTab.MESSAGE_TAB:{this._resetConversationList();const e=this.getState();!e.selectedId&&e.previousId&&this.updateSelectedId(e.previousId),Object(Lt.f)({type:Os.SideBarActions.SHOW_CHAT_VIEW});break}case $s.SidebarTab.STAR_TAB:case $s.SidebarTab.TODO_TAB:t===$s.SidebarTab.ZCLOUD_TAB&&Object(Lt.f)({type:Os.SideBarActions.SHOW_CHAT_VIEW})}}_showMyProfile(){Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:this.currUser.userId})}_resetConversationList(){}_getQueryParams(){let e={},t=window.location.search;if(t=t?t.substr(1).split("&"):null,t)for(let s=0;s<t.length;s++){let i=t[s].indexOf("=");if(i>=0){let a=t[s].slice(0,i),n=t[s].slice(i+1,t[s].length);a&&a.length>0&&n&&n.length>0&&(e[a]=decodeURIComponent(n))}}return e}_autoSelectConv(){this._querySelect&&this._convsLoaded&&(Is.default.logCoreInfo(`[${this.name}] - auto select conv start`),this._querySelect(),this._querySelect=null)}})||ji)||ji)||ji)||ji)||ji);var Wi;const qi={id:Gs.f,color:"#EA87FF",conversations:[],createTime:1634956772046,emoij:"",offset:100,text:"default"};var Ki=function(e){return e.ALL="all",e.SELECTED="selected",e}(Ki||{});Object(Hs.b)($s.LabelDataManager)(Wi=Reflect.metadata("design:type",Function)(Wi=Reflect.metadata("design:paramtypes",[])(Wi=class extends je.b{constructor(){super(),this.allLabels=void 0,this.selectedLabel=void 0,this.name=$s.LABEL_DATA_MANAGER,this.data=new Map,this.key="labelId",this.allLabels=[],this.selectedLabel=[]}onLabelChange(e){const{color:t,conversations:s,createTime:i,emoij:a,offset:n,text:r}=e,o=""+e.id,d=this.data.get(o);if(!o||d&&s===d.conversations&&i==(null==d?void 0:d.createTime)&&a==d.emoij&&n==d.offset&&r===d.text&&t==d.color||(this.data.set(o,e),Object(Kt.g)(this.name,o),Object(Kt.i)(this.name,"all")),d&&d.conversations&&d.conversations.length!==s.length){let e=[];s.length>d.conversations.length?(e=s.filter((e=>!d.conversations.includes(e))),this.dispatchEvent(new Ws.c(Ws.d.LabelAddConvs,{labelId:o,convIds:e}))):(e=d.conversations.filter((e=>!s.includes(e))),this.dispatchEvent(new Ws.c(Ws.d.LabelRemoveConvs,{labelId:o,convIds:e})))}}onFetchLabels(e){if(Array.isArray(e)&&!(e.length<0)){for(let t=0;t<e.length;t++)this.onLabelChange(e[t]);this.data.forEach((t=>{const s=""+t.id;e.some((e=>e.id==s))||this.data.delete(s)})),this._updateAllLabels(e.map((e=>e.id)))}}onLabelDeleted(e){if("string"!=typeof e&&(Is.default.logCoreError(`[${this.name}] - delete label invalid lid type ${e}`),e=""+e),!this.data.has(e))return void Is.default.logCoreError(this.name+"Deleted not exists item!!!");const t=this.data.get(e);let s=[];t&&t.conversations&&(s=[...t.conversations]),this.data.delete(e),this._updateAllLabels(this.allLabels.filter((t=>t!==e))),this.selectedLabel.includes(e)&&this.onDeSelectLabel(e),this.dispatchEvent(new Ws.c(Ws.d.RemoveLabel,{labelId:e,convs:s})),Object(Kt.e)(this.name,e)}_updateAllLabels(e){return!Is.default.shallowEqual(this.allLabels,e)&&(this.allLabels=e,Object(Kt.i)(this.name,Ki.ALL),!0)}onSelectLabel(e){this.selectedLabel=[""+e],Object(Kt.i)(this.name,Ki.SELECTED),this.selectedLabelChanged()}onDeSelectLabel(e){this.selectedLabel=this.selectedLabel.filter((t=>t!==e)),Object(Kt.i)(this.name,Ki.SELECTED),this.selectedLabelChanged()}onClearFilter(){this.selectedLabel=[],Object(Kt.i)(this.name,Ki.SELECTED),this.selectedLabelChanged()}getLabelById(e){return e?("string"!=typeof e&&(e=e.toString()),e==Gs.f?qi:e==Gs.g?{id:Gs.g}:this.data.get(e)||null):null}getAllLabels(){return Array.from(this.data.values())}getAllLabelIds(){return this.allLabels}applyNewFilter(e){this.selectedLabel=e,Object(Kt.i)(this.name,Ki.SELECTED),this.selectedLabelChanged()}selectedLabelChanged(){this.dispatchEvent(new Ws.c(Ws.d.SelectedLabelChange,this.selectedLabel))}init(){Js.a.getAll().then((e=>{this.onFetchLabels(e)}))}getItem(e){const t=e.key;return this.getLabelById(t)}getList(e){const t=e.key;return t===Ki.ALL?this.allLabels:t===Ki.SELECTED?this.selectedLabel:[]}onGetItemFailure(e){}onGetListFailure(e){}})||Wi)||Wi);i.ModuleContainer.register(ks.b,zs);var Zi=s("k+R1"),Qi=s("Py3H");let Ji=function(e){return e[e.FULL=0]="FULL",e[e.WINDOWED=1]="WINDOWED",e}({});var Yi=s("tQbm"),Xi=s("qzuk"),ea=s("NMlV"),ta=s("4HQc"),sa=s("GpwQ");const ia={message:{action:"recommened.link",childnumber:0,description:"Zalo cho my tnh gi file cc nhanh, chp mn hnh tin li, tr chuyn nhm khng gii hn.",href:`https://${ms.default.CONFIG_DOMAIN}/may-tinh?utm_source=chatview&utm_campaign=reinstallpc&utm_medium=web`,params:`{"mediaTitle":"Zalo cho my tnh  Windows, Mac, Ubuntu","artist":"","src":"${ms.default.CONFIG_DOMAIN}","stream_icon":"","streamUrl":"","type":0}`,thumb:"https://stc-chat.zdn.vn/images/banner/zalo-thumb-link.png",title:"Zalo cho my tnh  Windows, Mac, Ubuntu",type:"",copyLinkActionCode:null,confirmActionCode:null},msgType:6};var aa,na=s("OU7N"),ra=s("UYGI"),oa=s("X4fA"),da=s("V8Oy"),la=s("7WX+");let ca;Is.default.isWeb()||(ca=s("Dprd").default);const ha={conversationId:null,mode:Ji.FULL,windowId:Qs.c};Object(Hs.b)(Yi.b)(aa=function(e,t){return i.ModuleContainer.inject($s.SidebarController)(e,void 0,0)}(aa=Reflect.metadata("design:type",Function)(aa=Reflect.metadata("design:paramtypes",[void 0===$s.SidebarController?Object:$s.SidebarController])(aa=class extends je.b{constructor(e){super(),this.sidebar=e,this.data=new Map,this.onLogOut=()=>{if(na.c.isCalling())return void Ht.a.createWarning($t.default.str("STR_SIGNOUT_WITH_CALL"));let e=$e.p.getSessionUserId(),t="STR_LOGOUT_CONFIRM",s=+ra.a.isUploading();if(!s&&ca&&ca.isDownloading()&&(s=2),s>0){const e=1===s?$t.default.str("STR_TITLE_BAR_SEND"):$t.default.str("STR_TITLE_BAR_RECEIVE");t=$t.default.str("STR_LOGOUT_CANCEL_FILE")+` ${e} `+$t.default.str("STR_TITLE_BAR_EXIT_ZALO_P2")}oa.a.getLogoutToken(),ii.ConfirmManagerV2.openConfirm({windowId:Qs.c,name:R.MODAL_CONFIRM.confirmIdentities,params:{message:$t.default.str(t),okText:$t.default.str("STR_LOGOUT_YES"),cancelText:$t.default.str("STR_LOGOUT_NO"),onOk:this.doLogout,options:[{default_val:ei.g.isSetClearData(e),key:"del_history",title:"STR_LOGOUT_DEL_HISTORY"}],"data-id":{confirmBtn:"btn_Logout_Logout",cancelBtn:"btn_Logout_No"}}})},this.openConversationInNewWindow=async e=>{throw new Error("Method not implemented.")},this.openScreenCapture=async()=>{Vt.default.logAction(12808),Cs.default.send(Os.ChatBoxActions.SIDEBAR_CAPTURE)},this.openZaloSupport=async()=>{const e=ms.default.supportPage;return e?i.ModuleContainer.resolve(ni.b).openConversation(e,ni.c.fromSupport()):Promise.resolve(!1)},this.openUpdateMyProfile=async()=>{Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.UPDATE_PROFILE,params:{showCloseButton:!0}})},this.openUserInfo=async e=>{Qi.a.setFriendRequestSource(e,R.FRIEND_REQUEST_SRC_CONTACT_LIST_SUGGESTION),$e.p.setSelectConversationSource(178012),Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})},this.openEditAlias=async e=>{const t={windowId:Qs.c,name:R.ModalIdentitiesDefine.EDIT_ALIAS,params:Object(f.a)({},e)};Gt.ModalManagerV2.openModal(t)},this.sendFile=async(e,t)=>{const s=this._getStateByWindowId(Qs.c),i=Zi.default.getChatBoxControllerByConvId(t||s.conversationId);null==i||i._uploadDragFile(e,null,t)},this.getConvId=()=>this._getStateByWindowId(Qs.c).conversationId,this.sendDirectMsgToSendToMe=(e,t)=>{!ms.default.isOffSendToMe&&this.chatboxController&&mt.default.getConversation(ms.default.sendToMeId).then((s=>{if(e===R.MSG_GIF&&t.url){var i;let e={hd:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},original:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},normal:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url}};null===(i=this.chatboxController)||void 0===i||i._sendMessage(s,R.MSG_GIF,e,null,null,null,null,null)}Object(Lt.e)({type:Os.ConversationListActions.SELECT_CONVERSATION,payload:s}),this.sidebar.updateSelectedId(ms.default.sendToMeId)}))},this.handleSendMessageError=(e,t,s)=>{var i,a;if(mt.default.deleteMessageById(t.msgId,t.conversationId),null===(i=this.chatboxController)||void 0===i||i._cleanUpLocalTTLItem(t),$e.p.isDelSendingMsg(t.clientId))return;const n=t.convertToUIMessageObject();return null===(a=this.chatboxController)||void 0===a||a._handleMessageFailure(e,t,n,s,!0),e},this.broadCastMessage=(e,t,s,i)=>{if(e&&t)for(let o=0;o<e.length;o++){const d=e[o];if(d){let e=d.userId,o=e.startsWith(R.GROUPID_PREFIX);if(t.msgType===R.MSG_STICKER){var a;const l=ea.a.next();t&&t.sendSrc&&Ui.c.track(l,t.sendSrc);const c=Is.default.getMsgIdSendingFromCliMsgId(l),h=new ta.b($e.p.getSessionUserId(),e,c,l,R.MSG_STICKER,o),u=sa.a.instance().isOnE2ee(d.userId);if(h.updateMessageContentProp(ta.a.STICKER,t.message),u){var n;const e={id:h.content.sticker.id,catId:h.content.sticker.cateId,type:h.content.sticker.type};var r;if(null!==(n=t.message)&&void 0!==n&&n.fssInfo)e.extInfo=null===(r=t.message)||void 0===r?void 0:r.fssInfo;h.updateMessageContentProp(ta.a.STICKER,e),h.e2eeStatus=R.MSG_E2EE}ys.default.sendMsgObject(h,null,null,R.RETRY_MSG_TIMEOUT_DEFAULT).then((t=>{if(s){var a;const t=ea.a.next(),i=Is.default.getMsgIdSendingFromCliMsgId(t);let n=new ta.b($e.p.getSessionUserId(),e,i,t,R.MSG_TEXT,o);n.updateMessageContentProp(ta.a.TEXT,s),u&&(n.e2eeStatus=R.MSG_E2EE),ys.default.sendMsgObject(n,null,null,R.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{u&&(e=Is.default.parseE2eeResp(e),this.chatboxController._sentMessage(n,e))})).catch((e=>{this.handleSendMessageError(e,n,d)})),null===(a=this.chatboxController)||void 0===a||a._showLocalMessage(n,d)}u&&(t=Is.default.parseE2eeResp(t),this.chatboxController._sentMessage(h,t)),i&&i(t)})).catch((e=>{Is.default.logCoreError("BroadcastErr: ",e),this.handleSendMessageError(e,h,d),i&&i(e)})),null===(a=this.chatboxController)||void 0===a||a._showLocalMessage(h,d)}else if(t.msgType===R.MSG_TEXT&&s){const t=ea.a.next(),a=Is.default.getMsgIdSendingFromCliMsgId(t);let n=new ta.b($e.p.getSessionUserId(),e,a,t,R.MSG_TEXT,o);n.updateMessageContentProp(ta.a.TEXT,s);sa.a.instance().isOnE2ee(d.userId)&&(n.e2eeStatus=R.MSG_E2EE),ys.default.sendMsgObject(n,null,null,R.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{i&&i(e)})).catch((e=>{this.handleSendMessageError(e,n,d),i&&i(e)}))}}}},this.handleEvent=(e,t)=>{if(e===Os.ConversationListActions.SELECT_CONVERSATION){const e=this._getStateByWindowId(Qs.c);if(t.userId!==e.conversationId)return this._updateStateByWindowId(Qs.c,(e=>Object(f.a)(Object(f.a)({},e),{},{conversationId:t.userId}))),Object(Kt.g)(this.name,Qs.c),void this.dispatchEvent(new Xi.a(t.userId,Qs.c))}},this.name=Yi.a,this.key="windowId",this.init()}get chatboxController(){const e=this.sidebar.getState().selectedId;return Zi.default.getChatBoxControllerByConvId(e||Qs.b)}onInviteFriend(){const e=[ia];Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.SHARE_MSG_COMPOSE,params:{messages:e,title:$t.default.str("STR_INVITE_FRIEND_1"),disableGroup:!0,disablePcUser:!0,callback:(e,t)=>{Cs.default.send(Os.SideBarActions.SEND_INVITATION,{target:e,message:(null==t?void 0:t.length)>0?t[0]:"",link:`https://${ms.default.CONFIG_DOMAIN}/may-tinh`})}}})}onWhatNew(){Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.APP_UPDATE_INFO,params:{data:mt.default.getCacheRecentUpdate(),isManual:!0}})}showMyProfile(){let e=$e.p.getSessionUserId();Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})}get mainWindowConversationId(){return this._getStateByWindowId(Qs.c).conversationId}doLogout(e){let t=$e.p.getSessionUserId();e&&e.del_history?ei.g.setClearData(t,1):ei.g.setClearData(t,0),da.a.logout(),la.a.logout(),oa.a.logout().catch((e=>{e.error_code&&18032===e.error_code&&Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.CHANGE_PW})}))}init(){Cs.default.subscribe(this.handleEvent)}getItem(e,t){return this._getStateByWindowId(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(f.a)({},ha),this.data.set(e,t)),t}_updateStateByWindowId(e,t){const s=t(this._getStateByWindowId(e));this.data.set(e,s)}})||aa)||aa)||aa);var ua,ga=s("OI//");let ma=i.ModuleContainer.injectable()(ua=class{async get(e){return oi.default.getGroupById(e)}async getMulti(e){const t=await oi.default.getGroupsByIds(e);return Object.values(t)}async getAll(){return await oi.default.getGroupsList()}})||ua;var pa;let fa=i.ModuleContainer.injectable()(pa=function(e,t){return i.ModuleContainer.inject(ga.c)(e,void 0,0)}(pa=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,1)}(pa=Reflect.metadata("design:type",Function)(pa=Reflect.metadata("design:paramtypes",[void 0===ga.c?Object:ga.c,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(pa=class{constructor(e,t){this.groupRepository=e,this.logger=void 0,this.logger=t.createZLogger("groups",["group-manager"])}getAll(){return this.groupRepository.getAll().then((e=>e.map((e=>new ga.a(e))))).catch((e=>(this.logger.zsymb(18,"By5QU9",(()=>["getAll error. return [].",{reason:e}])),[])))}getMulti(e){return this.groupRepository.getMulti(e).then((e=>e.map((e=>new ga.a(e)))))}get(e){return this.groupRepository.get(e).then((e=>e?new ga.a(e):void 0)).catch((e=>{this.logger.zsymb(18,"co84DI",(()=>["get error. return undefined.",{reason:e}]))}))}})||pa)||pa)||pa)||pa)||pa;i.ModuleContainer.registerSingleton(ga.c,ma),i.ModuleContainer.registerSingleton(ga.b,fa);var va=s("MqnV");const ba=Object(i.define)("message-controller");var ya;let Ia=Object(i.injectable)()(ya=function(e,t){return Object(i.inject)(xs.e)(e,void 0,0)}(ya=function(e,t){return Object(i.inject)(ba)(e,void 0,1)}(ya=function(e,t){return Object(i.inject)(xs.g)(e,void 0,2)}(ya=Reflect.metadata("design:type",Function)(ya=Reflect.metadata("design:paramtypes",[void 0===xs.e?Object:xs.e,"undefined"==typeof IMessageController?Object:IMessageController,void 0===xs.g?Object:xs.g])(ya=class{constructor(e,t,s){this.conversationRepository=e,this.messageLocalController=t,this.muteManager=s}getAllConvIds(){return this.conversationRepository.getAllConvIds()}async get(e){const t=await this.conversationRepository.get(e).catch((()=>{}));if(t)return new xs.c(t,this,this.messageLocalController)}isPinned(e){return this.conversationRepository.get(e).then((e=>!(null==e||!e.pinned))).catch((()=>!1))}isMuted(e){return!!this.muteManager.isMuted(e)}})||ya)||ya)||ya)||ya)||ya)||ya;var _a;let Ca=i.ModuleContainer.injectable()(_a=function(e,t){return i.ModuleContainer.inject(xs.b)(e,void 0,0)}(_a=Reflect.metadata("design:type",Function)(_a=Reflect.metadata("design:paramtypes",[void 0===xs.b?Object:xs.b])(_a=class{constructor(e){this.convManager=e}getAllConvIds(){return this.convManager.getAllConvIds()}get(e){return this.convManager.getConvById(e)}})||_a)||_a)||_a)||_a;var Oa=s("SVh1");var Sa,Ea=new class{constructor(){}showMyProfile(){Gt.ModalManagerV2.openModal({windowId:Qs.c,name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:$e.p.getSessionUserId()})}},Ma=s("idnp"),Ta=s("44Ud"),wa=s("SWHF"),Ra=s("oMqy"),La=s("oq0C"),Fa=s("7gRy");const Da="[Conversation controller]";function Aa(...e){Is.default.logCoreInfo(`${Da} - `,e)}let ja=Object(i.singleton)()(Sa=Object(i.injectable)()(Sa=function(e,t){return Object(i.inject)(xs.i)(e,void 0,0)}(Sa=function(e,t){return Object(i.inject)(wa.b)(e,void 0,1)}(Sa=function(e,t){return Object(i.inject)(Ra.e)(e,void 0,2)}(Sa=function(e,t){return Object(i.inject)(Ra.o)(e,void 0,3)}(Sa=function(e,t){return Object(i.inject)($s.SidebarController)(e,void 0,4)}(Sa=function(e,t){return Object(i.inject)(xs.b)(e,void 0,5)}(Sa=Reflect.metadata("design:type",Function)(Sa=Reflect.metadata("design:paramtypes",[void 0===xs.i?Object:xs.i,void 0===wa.b?Object:wa.b,void 0===Ra.e?Object:Ra.e,void 0===Ra.o?Object:Ra.o,void 0===$s.SidebarController?Object:$s.SidebarController,void 0===xs.b?Object:xs.b])(Sa=class{constructor(e,t,s,i,a,n){this.previewManager=e,this.adminSettingController=t,this.communityController=s,this.groupLoadInfoController=i,this.sidebar=a,this.convDataManager=n,this.lastOpenConv=new Map,this._es=void 0,this.onRequestJumtoMsg=(e,t)=>{const s=t.conversation,i=e===Os.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT||Zs.a.getListChatBoxViewCurrent().includes(null==s?void 0:s.userId)||s.byPassPIN;if(!s)return;if(s&&!i&&Zs.a.isThreadHidden(s.userId))return Object(si.b)({type:e,payload:t},!0),void Aa("req jum to msg rejected because hidden chat");Li.default.Fps.record(Li.MetricName.fps_jump_to_msg),Aa("req jum to msg open on main"),Object(si.b)({type:e,payload:t},!0);const a=Ma.b.fromJumpMessage();this.openConversationForJump(s.userId,a)},this.tryToFocusChild=(e,t)=>!!Zi.default.isOpenChildWindowByConvId(e)&&(Aa("Open conv forward because already open in child => call focus"),Zi.default.focusOnChildWindow(e,null==t?void 0:t.callPoint),!0),this.handleOutConversation=e=>{this.closeConversation(e.convId,{removed:!0})},this.listenEvent()}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}listenEvent(){Cs.default.subscribe(((e,t)=>{switch(e){case Os.ConversationListActions.SELECT_CONVERSATION_HIDDEN:this.sidebar.updateSelectedId(t.userId);break;case Os.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH:this.onRequestJumtoMsg(Os.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH,t);break;case Os.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:this.onRequestJumtoMsg(Os.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT,t)}})),this.convDataManager.addEventListener(Ks.b.DeleteConv,this.handleOutConversation),this.convDataManager.addEventListener(Ks.b.EmptyConv,this.handleOutConversation),this.convDataManager.addEventListener(Ks.b.LeaveGroup,this.handleOutConversation)}isConvOpeningInMain(e){const t=this.eventStore.getState(),s=this.sidebar.getState().selectedId;return t&&t.chatview.view===xi.c.CHAT_VIEW&&s===e}openConversationForJump(e,t=Ma.a){return new Promise((async s=>{if(Aa(`Request open conv for jum: ${e}`),!e||this.isConvOpeningInMain(e)){if(Aa(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||Zi.default.focusOnMainWindow()}return s(!1)}if(!(await this.conversationWillOpen(e)))return s(!1);let i=!1;if(t.window===Oa.b.Child)return i=this.tryToFocusChild(e,t),s(i);if(t.window===Oa.b.PreferChild){if(i=this.tryToFocusChild(e,t),i)return s(!0)}else t.window===Oa.b.MainAndChild&&(i=this.tryToFocusChild(e,t));i||Zi.default.focusOnMainWindow(),Cs.default.send(Os.ConversationListActions.SELECT_CONV_MINOR,{userId:e}),Object(si.b)({type:Os.ConversationListActions.OPEN_CONV_FOR_JUMP,payload:{userId:e}}),this.sidebar.updateSelectedId(e),s(!0),this.conversationDidOpen(e)}))}openConversation(e,t=Ma.a){return new Promise((async(s,a)=>{if(Aa(`Request open conv from: ${e} - ${t.callPoint}`),!e||this.isConvOpeningInMain(e)&&!t.force){if(Aa(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||t.silently||Zi.default.focusOnMainWindow()}return s(!1)}const n=$e.p.getSessionUserId();if(e==n)return Ea.showMyProfile(),s(!1);Li.default.Fps.record(Li.MetricName.fps_switch_conv);if(!(await this.conversationWillOpen(e)))return s(!1);let r=!1;if(t.window===Oa.b.Child)return r=this.tryToFocusChild(e,t),s(r);if(t.window===Oa.b.PreferChild){if(r=this.tryToFocusChild(e,t),r)return s(!0)}else t.window===Oa.b.MainAndChild&&(r=this.tryToFocusChild(e,t));let o=t.credentConv;if(o||(o=await mt.default.getLikeConversation(e).catch((e=>{Aa(`Failure to load conv from store ${e}`)})),Aa(`Try to use storage conv: ${!!o}`)),o||(o=t.defaultConv,Aa(`Try to use default conv: ${!!o}`)),!o)return Aa(`Open conv not exists: ${e}`),s(!1);r||t.silently||Zi.default.focusOnMainWindow(),Cs.default.send(Os.ConversationListActions.SELECT_CONV_MINOR,o);const d=Zs.a.isThreadHidden(e);d&&Zs.a.checkShowUnreadHiddenChat(e),t.byPassPIN?(o=Object(f.a)({},o),o.byPassPIN=1):delete o.byPassPIN,this.eventStore.dispatch({type:Os.ConversationListActions.SELECT_CONVERSATION,payload:o}),Cs.default.send(Os.ConversationListActions.SELECT_CONVERSATION,{userId:o.userId,needScroll:t.callPoint!==Oa.a.ConvItem,callPoint:t.callPoint});(!d||t.byPassPIN||Zs.a.getListChatBoxViewCurrent().includes(o.userId))&&this.sidebar.updateSelectedId(e),s(!0),this.conversationDidOpen(e),i.ModuleContainer.resolve(Zt.b).promoteMigrateByOpenConv(e)}))}closeConversation(e,t={}){return new Promise((s=>{if(e&&this.sidebar.getState().selectedId!==e)return s(!1);const{windowId:i=Qs.c,removed:a}=t;if(i===Qs.c){const e={conversation:null,convId:null};this.eventStore.dispatch({type:Os.ConversationListActions.SELECT_CONVERSATION,payload:e}),Cs.default.send(Os.ConversationListActions.SELECT_CONVERSATION,e),a?this.sidebar.updateSelectedIdWithoutPrevious(null):this.sidebar.updateSelectedId(null)}s(!0)}))}closeAllConversations(){return Promise.resolve(!0)}deleteConversation(e,t=Qs.c){return new Promise((async s=>{if(this.conversationWillDelete(e),await Bs.default.deleteConversation(e,!0,t),t===Qs.c){const t={userId:null};this.eventStore.dispatch({type:Os.ConversationListActions.SELECT_CONVERSATION,payload:t}),Cs.default.send(Os.ConversationListActions.SELECT_CONVERSATION,t),this.sidebar.updateSelectedId(null),s(!0),this.conversationDidDelete(e)}else s(!1)}))}pinConversation(e){return Promise.resolve(!0)}renameConversation(e){return Promise.resolve(!0)}getLastOpenConv(e){return this.lastOpenConv.get(e)}isOpeningConversation(e){const t=this.sidebar.getSelectedId();return!(!t||t!=e)||Zi.default.isOpenChildWindowByConvId(e)}conversationWillOpen(e){return Ta.b.start(Ta.a.ART,{convId:e}),Aa(`Will open conv ${e}`),this.lastOpenConv.set(e,Date.now()),Promise.resolve(!0)}conversationDidOpen(e){Li.default.start(Li.MetricName.open_conversation,e),Li.default.start(Li.MetricName.open_conversation_no_preload,e),Aa(`Did open conv ${e}`),this.adminSettingController.onLoadSetting(e),this.communityController.onConversationDidOpen(e),this.groupLoadInfoController.onOpenConversation(e),i.ModuleContainer.resolve(La.a).onOpenConversation(e),i.ModuleContainer.resolve(Fa.a).onOpenConversation(e),setTimeout((()=>{this.previewManager.revalidate(e)}),0)}conversationWillDelete(e){return Aa(`Will delete conv ${e}`),Promise.resolve()}conversationDidDelete(e){Aa(`Did delete conv ${e}`),this.lastOpenConv.delete(e)}})||Sa)||Sa)||Sa)||Sa)||Sa)||Sa)||Sa)||Sa)||Sa)||Sa;var Pa,Na=s("s9sK"),Ua=s("TeMN"),ka=(s("EHdh"),s("Ln14")),Ba=s("bdot"),Ga=s("cfFl"),xa=s.n(Ga);const za={userId:R.CONV_FILTER.STRANGER,label:null,isGroup:!1,respondedByMe:!1,numMsg:0,pinned:0,outside:0,topOut:!1,infoCheckSearch:null},Va=["userId","label","firstSmsLocalId","lastSmsLocalId","isGroup","respondedByMe","numMsg","pinned","outside","lastActionId","topOutImprTimeOut","topOutTimeOut","syncFromMobile","topOut","localType","infoCheckSearch","preLastSmsLocalId"];Object(Hs.b)(ka.c)(Pa=function(e,t){return i.ModuleContainer.inject(Ua.b)(e,void 0,0)}(Pa=Reflect.metadata("design:type",Function)(Pa=Reflect.metadata("design:paramtypes",[void 0===Ks.IReactiveDB?Object:Ks.IReactiveDB])(Pa=class extends je.b{constructor(e){super(),this.DBConvInfo=e,this.name=void 0,this.key=void 0,this.data=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.fetchAllHolder=void 0,this.preloadCached=void 0,this._pm=void 0,this.pinEventQueue=void 0,this.labelEventQueue=void 0,this.doneEventQueue=void 0,this.name=ka.a,this.key="convId",this.data=new Map,this.didInit=!1,this.doneLoadDB=!1,this.fetchAllHolder=null,this.preloadCached=null,this._pm=null,this.pinEventQueue=[],this.labelEventQueue=[],this.doneEventQueue=!1}get previewManager(){return this._pm||(this._pm=i.ModuleContainer.resolve(xs.i)),this._pm}get unreadManager(){return Ds.a.UnreadDataManager}init(){if(this.didInit)return Promise.resolve();const e=Li.default.start(Li.MetricName.load_conversation_list),t=()=>{e.end(),Ds.a.ConvListController.removeEventListener(Ks.c.LoadPreviewDone,t)};return Ds.a.ConvListController.addEventListener(Ks.c.LoadPreviewDone,t),this.didInit=!0,this.loadData()}async loadData(){this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll());const e=await this.fetchAllHolder.catch((e=>{Is.default.logCoreInfo(`[${this.name}] - load conv from DB got error ${e}`)}))||[],t=await this.onLoadDataFromDB(e);Is.default.logCoreInfo(`[${this.name}] - done load db ${e.length}`),this.doneLoadDB=!0,this.doIdleTask(),this.broadcastEvent(Ks.b.DoneLoadDB,"",e),this.previewManager.migrate(t.map((e=>e.userId))),this.setCacheData(R.CONV_FILTER.STRANGER,za,!0)}async doIdleTask(){const e=this.pinEventQueue.slice(),t=this.labelEventQueue.slice();this.pinEventQueue=[],this.labelEventQueue=[];const s=xa.a.series(e),i=xa.a.series(t);return Promise.all([s,i]).then((e=>this.pinEventQueue.length||this.labelEventQueue.length?this.doIdleTask():(this.doneEventQueue=!0,e)))}getItem(e,t){return this.data.get(e.key)}getList(e,t){return e.key===ka.b.ALL?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}async onLoadDataFromDB(e){const t=await qs.a.filterOutdatedConv(e);Is.default.logCoreInfo(`[${this.name}] - done filter outdate ${e.length} ${t.length}`);const s=(new Date).getTime().toString(),i=[];Object(Kt.j)(s);for(let a=0;a<t.length;a++){if(!t[a].userId)continue;const e=Object(f.a)({},t[a]),n=this.data.get(e.userId);if(e.verified=!0,void 0===e.isGroup&&(e.isGroup=e.userId.startsWith(R.GROUPID_PREFIX)),n){if(!n.verified){const t=this.mergeConv(e,n);t.verified=!0,this.setCacheData(e.userId,t),Object(Kt.f)(s,this.name,e.userId),this.updateInDB(t)}}else this.setCacheData(e.userId,e),Object(Kt.f)(s,this.name,e.userId);e.infoCheckSearch&&(e.infoCheckSearch&&Is.default.msgTypeValid(e.infoCheckSearch.lastType)?Ii.a.pushCacheLastChat(e.userId,e.infoCheckSearch.lastMessageTime):e.numMsg&&e.numMsg>1&&i.push(e.userId))}return i.length>0&&Ii.a.cacheCheckLastChatInDb(i),Object(Kt.c)(s),t}onReceiveNewMessages(e,t,s={outside:void 0,isGroup:!1}){return new Promise(((i,a)=>{var n,r;if(!t||t.length<0)return a("Empty msgs");const o=t[t.length-1],d=t[0],l=this.data.get(e),c=qs.a.getLastValidMsg(t);let h,u;c&&(h={lastMessageTime:Number(c.sendDttm),lastType:c.msgType},Ii.a.pushCacheLastChat(e,h.lastMessageTime)),o.msgType===R.MSG_INFO&&(null==l||null===(n=l.infoCheckSearch)||void 0===n?void 0:n.lastMessageTime)>Number(o.sendDttm)&&(u=null==l?void 0:l.lastSmsLocalId);const g={userId:e,firstSmsLocalId:d.msgId,isGroup:s.isGroup||e.startsWith(R.GROUPID_PREFIX),numMsg:t.length,respondedByMe:di.b.includeMyMessage(t),pinned:0,label:null,topOut:o.topOut,verified:!1,lastSmsLocalId:u||o.msgId,outside:s.outside,cloudMore:!1,infoCheckSearch:h};if(this.preloadCached&&this.preloadCached.onNewMsg(e,o),l){const t=this.mergeConv(Object(f.a)({},l),g);this.setCacheData(e,t),this.shouldSignalUpdate(l,t)&&Object(Kt.g)(this.name,e),l.verified&&this.updateInDB(t),i(t)}else{const s=Js.a.getLabelObjByConversaionId(e);if(g.label=s?s.id:null,this.setCacheData(e,g,!0),this.doneLoadDB){g.verified=!0,this.updateInDB(g);return di.b.includeJoinEvent(t)&&(Is.default.logCoreInfo(`[${this.name}] - Detect join msg ${e} ${o.msgId}`),this.previewManager.forceChangeItem(e)),i(g)}this.DBConvInfo.getById(e).then((t=>{const s=this.data.get(e);if(!s)return a("Internal logic handle wrong");let n=Object(f.a)({},s);n.verified=!0,t?s.verified||(n=this.mergeConv(n,t),this.setCacheData(e,n),this.shouldSignalUpdate(n,s)&&Object(Kt.g)(this.name,e),this.updateInDB(n)):this.updateInDB(n),i(n)}))}l&&l.respondedByMe||null===(r=this.data.get(e))||void 0===r||!r.respondedByMe||(Is.default.logCoreInfo(`[${this.name}] - Detect first my msg ${e} ${o.msgId}`),this.previewManager.forceChangeItem(e))}))}async onDeleteMessages(e,t){const s=this.data.get(e);if(Is.default.logCoreInfo(`[${this.name}] - onDeleteMessages #1 ${e} ${t.length}`),s&&s.verified){let i=!1;if(t.find((({msgId:e})=>s.firstSmsLocalId===e))){const t=await(await Ba.b.getFirstMessage(e)).firstMsg;if(!t)return Is.default.logCoreInfo(`[${this.name}] - onDeleteMessages #4 ${e} `),this.forkDeleteCacheAndDB(e),{deletedId:e};s.firstSmsLocalId=null==t?void 0:t.msgId,i=!0}if(t.find((({msgId:e})=>s.lastSmsLocalId===e))){const t=await Ba.b.getLastMessage(e,s.lastSmsLocalId);if(!t||t.length<1)return Is.default.logCoreInfo(`[${this.name}] - onDeleteMessages #5 ${e} ${!!t}`),this.forkDeleteCacheAndDB(e),{deletedId:e};s.lastSmsLocalId=t[0].msgId,i=!0}return Is.default.logCoreInfo(`[${this.name}] - onDeleteMessages #6 ${e} ${i}`),i&&(this.setCacheData(e,Object(f.a)({},s)),this.updateInDB(s)),{conversation:s,updated:i}}{const t=await(await Ba.b.getFirstMessage(e)).firstMsg,s=await Ba.b.getLastMessage(e),i=s&&s[0];if(!t||!i)return Is.default.logCoreInfo(`[${this.name}] - onDeleteMessages #2 ${e} ${!!t} ${!!i}`),Ds.a.PinDataManager.isPinned(e)||this.onDeleteConversation(e),{deletedId:e};const a=await this.DBConvInfo.getById(e);let n=Is.default.msgTypeValid(i)?{lastMessageTime:i.sendDttm,lastType:i.msgType}:void 0;if(Is.default.logCoreInfo(`[${this.name}] - onDeleteMessages #3 ${e} ${!!a}`),a){let s=!1;a.firstSmsLocalId!==(null==t?void 0:t.msgId)&&(a.firstSmsLocalId=null==t?void 0:t.msgId,s=!0),a.lastSmsLocalId!==i.msgId&&(a.lastSmsLocalId=null==i?void 0:i.msgId,s=!0);const n=Object(f.a)(Object(f.a)({},a),{},{verified:!0});return this.setCacheData(e,n,!0),s&&this.updateInDB(n),{conversation:n,updated:!0}}{const s={userId:e,isGroup:e.startsWith(R.GROUPID_PREFIX),pinned:0,label:null,topOut:void 0,verified:!0,outside:null,cloudMore:!1,firstSmsLocalId:t.msgId,lastSmsLocalId:i.msgId,numMsg:2,respondedByMe:"0"==t.fromUid||"0"==i.fromUid,infoCheckSearch:n};return this.setCacheData(e,s,!0),this.updateInDB(s),{conversation:s,updated:!0}}}}mergeConv(e,t){const s=e=>null!=e&&("string"==typeof e?!e.includes("undefined")&&!e.includes("null"):"number"==typeof e&&!isNaN(e));let i=!1;return s(e.lastSmsLocalId)?s(t.lastSmsLocalId)&&(i=t.lastSmsLocalId>e.lastSmsLocalId):i=!0,i&&(e.preLastSmsLocalId=e.lastSmsLocalId||t.lastSmsLocalId,e.lastSmsLocalId=t.lastSmsLocalId,e.outside=t.outside),e.numMsg=(e.numMsg||0)+t.numMsg,e.respondedByMe=e.respondedByMe||t.respondedByMe,(!e.firstSmsLocalId||t.firstSmsLocalId&&t.firstSmsLocalId<e.firstSmsLocalId)&&(e.firstSmsLocalId=t.firstSmsLocalId),(!e.infoCheckSearch||!e.infoCheckSearch.lastMessageTime||t.infoCheckSearch&&t.infoCheckSearch.lastMessageTime>e.infoCheckSearch.lastMessageTime)&&(e.infoCheckSearch=t.infoCheckSearch),e.preLastSmsLocalId||(e.preLastSmsLocalId=t.lastSmsLocalId),!t.respondedByMe&&t.topOut&&(e.topOut=t.topOut),"string"!=typeof e.firstSmsLocalId&&(e.firstSmsLocalId=""+e.firstSmsLocalId),e}async onEmptyConversation(e){const t=await this.getConvById(e);if(Is.default.logCoreInfo(`[${this.name}] - onEmptyConversation ${e} ${!!t}`),!t)return;const s=Object(f.a)({},t);return delete s.firstSmsLocalId,delete s.lastSmsLocalId,s.numMsg=0,s.respondedByMe=!1,this.setCacheData(e,s,!0),this.broadcastEvent(Ks.b.EmptyConv,e),Object(Kt.g)(this.name,e),Ds.a.PinDataManager.isPinned(e)&&Ds.a.PinDataManager.unpin([e]),this.updateInDB(s)}onDeleteConversation(e){Is.default.logCoreInfo(`[${this.name}] - onDeleteConversation ${e}`);const t=this.data.get(e);return this.doDeleteConversation(e).then((s=>{this.broadcastEvent(Ks.b.DeleteConv,e,t)}))}doDeleteConversation(e){const t=this.data.get(e);return Is.default.logCoreInfo(`[${this.name}] - doDeleteConversation ${e} ${!!t}`),t&&(this.data.delete(e),Object(Kt.e)(this.name,e)),Ds.a.PinDataManager.isPinned(e)&&Ds.a.PinDataManager.unpinLocal([e]),this.deleteInDB(e)}onPinConversation(e,t){return new Promise((s=>{this.doneEventQueue?this.doUpdatePin(e,t).then(s):this.pinEventQueue.push((async()=>{const i=await this.doUpdatePin(e,t);s(i)}))}))}doUpdatePin(e,t){if(t&&qs.a.isStrangerV2(e))return Promise.resolve(null);if(!this.data.get(e)){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const s=new Map;return s.set("pinned",t),this.updateFields(e,s).then((s=>(this.broadcastEvent(Ks.b.ChangePinConv,e,t),s))).catch((t=>(Is.default.logCoreInfo(`[${this.name}] - doUpdatePin err`,t),this.data.get(e))))}onLeaveGroup(e){return Is.default.logCoreInfo(`[${this.name}] - onLeaveGroup ${e}`),this.doDeleteConversation(e).then((t=>{this.broadcastEvent(Ks.b.LeaveGroup,e)}))}async onChangeConvLabel(e,t){return new Promise((s=>{const i=this.data.get(e);if(i&&i.label===t)return s(i);this.doneEventQueue?this.doUpdateConvLabel(e,t).then(s):this.labelEventQueue.push((async()=>{const i=await this.doUpdateConvLabel(e,t);s(i)}))}))}doUpdateConvLabel(e,t){if(!e)return Is.default.logCoreInfo(`[${this.name}] - doUpdateConvLabel with undefined ${t}`),Promise.resolve(null);const s=this.data.get(e);if(s&&s.label===t)return Promise.resolve(s);if(!s){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const i=new Map;return i.set("label",t),this.updateFields(e,i).then((i=>(this.unreadManager.onChangeConvLabel(e,null==s?void 0:s.label,t),i)))}onFetchConvLabels(e){if(!e||!Array.isArray(e))return;Is.default.logCoreInfo(`[${this.name}] - onChangeConvLabel ${e.length}`);const t={};this.getAllConv().then((s=>{for(let e=0;e<s.length;e++)t[s[e].userId]=1;for(let i=0;i<e.length;i++){const s=e[i].id,a=e[i].conversations;if(a)for(let e=0;e<a.length;e++){const i=a[e];delete t[i],this.onChangeConvLabel(i,s)}}for(const e in t)Object.hasOwnProperty.call(t,e)&&this.onChangeConvLabel(e,null)}))}onDeleteConvLabels(e){Is.default.logCoreInfo(`[${this.name}] - onDeleteConvLabels ${e.length}`),e.forEach((e=>{const t=e.conversations;if(t&&t.length)for(let s=0;s<t.length;s++)this.data.has(t[s])&&this.onChangeConvLabel(t[s],null)}))}async onUpdateMsgId(e,t,s){if(!t||!s||t===s)return Promise.reject("[Conv-info-manager]- call update with invalid params!");const i=this.data.get(e);let a=i||{},n=!1;if(!i||!i.verified){const t=await this.DBConvInfo.getById(e);if(!i&&!t){const t=await this.createEmptyConvForUser(e,0,void 0,{firstSmsLocalId:s,lastSmsLocalId:s});return this.setCacheData(e,t),t}i&&t?(a=this.mergeConv(i,t),n=!0):(a=i||t,a.verified=!0,n=!0)}return a.firstSmsLocalId&&a.firstSmsLocalId!==t||(n=!0,a.firstSmsLocalId=s),a.lastSmsLocalId&&a.lastSmsLocalId!==t||(n=!0,a.lastSmsLocalId=s),n&&(this.setCacheData(e,a),this.updateInDB(a)),a}async addOrUpdateConv(e,t,s,i,a,n){"number"==typeof t&&(t=""+t),"number"==typeof s&&(s=""+s);const r=this.data.get(e);Is.default.logCoreInfo(`[${this.name}] - addOrUpdateConv ${e} ${!!r} ${s}`);const o=e=>((!e.firstSmsLocalId||t&&t<e.firstSmsLocalId)&&(e.firstSmsLocalId=t),(!e.lastSmsLocalId||s&&s>e.lastSmsLocalId)&&(e.lastSmsLocalId=s),e.cloudMore=i,e.respondedByMe=e.respondedByMe||a,e.numMsg=(e.numMsg||0)+n,e);if(r&&r.verified){const t=o(r);return this.setCacheData(e,Object(f.a)({},t)),this.updateInDB(t),t}{const r=await this.DBConvInfo.getById(e);if(Is.default.logCoreInfo(`[${this.name}] - addOrUpdateConv #2 ${e} ${!!r}`),r){const t=o(r);return this.setCacheData(e,Object(f.a)(Object(f.a)({},t),{},{verified:!0})),this.updateInDB(t),t}{const r={userId:e,firstSmsLocalId:t,lastSmsLocalId:s,isGroup:e.startsWith(R.GROUPID_PREFIX),respondedByMe:a,numMsg:n||2,label:null,pinned:0,verified:!0,cloudMore:i,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,r,!0),this.updateInDB(r),r}}}async addIfNotExistsConv(e,t,s,i,a,n){const r=this.data.get(e);if(Is.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #1 ${e} ${!!r} ${i}`),r)return!1;const o=await this.DBConvInfo.getById(e);if(Is.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #2 ${!!o}`),o)return!1;{const r={userId:e,firstSmsLocalId:s,lastSmsLocalId:i,isGroup:t||e.startsWith(R.GROUPID_PREFIX),respondedByMe:a,numMsg:n||1,label:null,pinned:0,verified:!0,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,r,!0),this.updateInDB(r),!0}}createEmptyConvForUser(e,t,s=R.CONV_OT_STATE.none,i){return new Promise(((a,n)=>{this.getConvById(e).then((a=>{let n;if(Is.default.logCoreInfo(`[${this.name}] - createEmptyConvForUser ${e} ${!!a}`),a){const i=new Map;return n=a,s!==R.CONV_OT_STATE.none&&void 0!==s&&(n.outside=s,i.set("outside",s)),t&&!Ds.a.PinDataManager.isPinned(n.userId)&&Ds.a.PinDataManager.pin([n.userId]),this.updateFields(e,i),n}return n=Object(f.a)({userId:e,lastMessageTime:t?0:bs.default.getTimeNow(),isGroup:e.startsWith(R.GROUPID_PREFIX)},i),s!==R.CONV_OT_STATE.none&&void 0!==s&&(n.outside=s),t&&Ds.a.PinDataManager.pin([n.userId]),n.verified=!0,this.setCacheData(e,n,!0),this.updateInDB(n),n})).then((e=>{a(e)})).catch((e=>{Is.default.logCoreError(e),n(e)}))}))}updateLastMsgId(e,t){const s=this.data.get(e);if(s&&s.lastSmsLocalId===t)return Promise.resolve(s);const i=new Map;return i.set("lastSmsLocalId",t),this.updateFields(e,i)}updateInfoCheckSearch(e,t,s){const i=this.data.get(e);if(i&&i.infoCheckSearch&&i.infoCheckSearch.lastMessageTime===t)return Promise.resolve(i);const a=new Map;return a.set("infoCheckSearch",{lastMessageTime:t,lastType:s}),this.updateFields(e,a)}updateConvSetting(e,t){let s=this.data.get(e);if(!s){const i=!!this.doneLoadDB;s={userId:e,verified:i},i||Is.default.logCoreInfo(`[${this.name}] - update conv setting before done load db ${e}`,t)}Is.default.shallowEqual(s.setting,t)||(s.setting=t,this.setCacheData(e,s,!0),Is.default.logCoreInfo(`[${this.name}] - update conv setting for conv ${e}`,t))}async isRespondedByMe(e){const t=await this.getConvById(e);return!!t&&Boolean(t.respondedByMe)}isRespondedByMeSync(e){const t=this.data.get(e);return!!t&&Boolean(t.respondedByMe)}isDoneLoadDB(){return this.doneLoadDB}getConvByIdSync(e){return"string"!=typeof e&&Is.default.logCoreInfo(`[${this.name}] - getConvByIdSync with invalid id type`,e,!!this.data.get(e),!!this.data.get(""+e)),this.data.get(e)}getConvById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvInfo.getById(e).then((e=>{t(e)})).catch(s)}))}getAllConvSync(){return Array.from(this.data.values())||[]}getAllConv(){return new Promise(((e,t)=>{if(this.doneLoadDB){return e(this.getAllConvSync())}this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll()),this.fetchAllHolder.then(e).catch(t)}))}getAllConvIds(){return this.getAllConv().then((e=>e.map((({userId:e})=>e))))}getAllConvIdsSync(){return Array.from(this.data.keys())}setPreloadCache(e){this.preloadCached=e}onDoneSyncMobile(){Is.default.logCoreInfo(`[${this.name}] - onDoneSyncMobile`),this.getAllConv().then((e=>{e&&this.previewManager.migrate(e.map((e=>e.userId)),!0)}))}setCacheData(e,t,s=!1){this.data.set(t.userId,t),s&&Object(Kt.g)(this.name,e)}updateFields(e,t){return new Promise(((s,i)=>{const a=this.data.get(e),n=a=>{Is.default.logCoreInfo(`[${this.name}] - updateFields #2`);const n=Object(f.a)({},a);t.forEach(((e,t)=>{n[t]=e})),this.setCacheData(e,n,!0),this.updateInDB(n).then((()=>{s(n)})).catch(i)};a?n(a):this.DBConvInfo.getById(e).then((e=>{e&&n(e)}))}))}forkDeleteCacheAndDB(e){if(Is.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e}`),!Ds.a.PinDataManager.isPinned(e)){const t=this.data.get(e);Is.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e} ${!!t}`),this.data.delete(e),Object(Kt.e)(this.name,e),this.deleteInDB(e).then((s=>{this.broadcastEvent(Ks.b.DeleteConv,e,t)}))}}broadcastEvent(e,t="",s){this.dispatchEvent(new Ks.a(e,t,s))}shouldSignalUpdate(e,t){return Ds.a.PinDataManager.isPinned(e.userId)!==Ds.a.PinDataManager.isPinned(t.userId)||e.label!==t.label||e.respondedByMe!==t.respondedByMe}cleanConversation(e){return Object.keys(e).forEach((t=>{Va.includes(t)||delete e[t]})),e}getEmptyConv(e){return{userId:e,isGroup:e.startsWith(R.GROUPID_PREFIX),numMsg:0,respondedByMe:!1,pinned:0,label:null,outside:null,infoCheckSearch:null,topOut:null}}updateInDB(e){const t=this.cleanConversation(Object(f.a)({},e));return this.DBConvInfo.addOrUpdate(t).catch((e=>{Is.default.logCoreInfo(`[${this.name}] - updateInDB got error ${e}`)}))}deleteInDB(e){return this.DBConvInfo.remove(e).catch((e=>{Is.default.logCoreInfo(`[${this.name}] - deleteInDB got error ${e}`)}))}})||Pa)||Pa)||Pa);var Ha=s("NSWB"),$a=s("1Abx"),Wa=s("XEtq"),qa=s("ZRfj"),Ka=s("oH3T"),Za=s("13iL"),Qa=s("mea/"),Ja=s("MPLC"),Ya=s("WK05");var Xa,en=s("dwTj"),tn=s("RVT8"),sn=s("hkvp"),an=s("6tnf"),nn=s("sg3c"),rn=s("ofhN"),on=s("D8f9"),dn=s("bgEr"),ln=s("PGx3");const cn="9999999999999999",hn="zum_m",un="1.0.0",gn="paucfoa_ts_key",mn=!1,pn="total",fn=e=>({convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"",lastSeenReactId:"",unreadMark:void 0}),vn={CALL_INIT:!1},bn=1,yn=2;Object(Hs.b)(tn.b)(Xa=function(e,t){return i.ModuleContainer.inject(sn.b)(e,void 0,0)}(Xa=Reflect.metadata("design:type",Function)(Xa=Reflect.metadata("design:paramtypes",[void 0===Ks.IReactiveDB?Object:Ks.IReactiveDB])(Xa=class extends je.b{constructor(e){super(),this.DBConvUnread=e,this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this.pendingMessage=void 0,this.previewMsgs=void 0,this.pendingClearUnread=void 0,this.fetchAllHolder=void 0,this.total=void 0,this.loadState=vn,this.isLoadDBStarted=void 0,this.updateTotalQueue=void 0,this._logger=void 0,this.setupQueue=()=>Object(Ga.queue)((async e=>{this.doneLoadDB&&await this.calculateComputeUnreadCount(e)}),1),this._getDeletedMsgByTTLItem=(e,t)=>{if(t)return t.find((t=>e.msgId?e.msgId===t.msgId:e.cliMsgId===t.cliMsgId))},this.name=tn.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.isLoadDBStarted=!1,this.pendingMessage=new Map,this.previewMsgs=[],this.pendingClearUnread=new Map,this.fetchAllHolder=null,this.total=this.getEmptyTotal(),this.updateTotalQueue=this.setupQueue(),this.resetToUnreadReddotOAIfNeeded_=this.resetToUnreadReddotOAIfNeeded_.bind(this),this.handleConvUnreadCountConfigChange_=this.handleConvUnreadCountConfigChange_.bind(this)}init(){this.didInit||(this.logger.zsymb(3,"dDoT0U",["call init unread","rYDsWU"]),this.didInit=!0,this.addListener(),this.onState("CALL_INIT"))}onState(e){this.loadState[e]=!0;const t=Object.values(this.loadState).every((e=>!0===e));t&&!this.isLoadDBStarted&&(this.logger.zsymb(3,"SZhdQG",["done all state, ready to load db...","bsbNpA"]),this.loadData())}get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.conversation,[ci.ZLoggerNametags.unread])),this._logger}getEmptyTotal(){return{convId:"total",smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:0,smsUnreadNomute:0}}loadData(){const e=S.default.getInstance().getItemForCurrentUser(hn);if(e===un)this.isLoadDBStarted=!0,this.logger.zsymb(3,"bYY-KM",["start load unread {}","OBCb6a"],e),this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((e=>{this.onLoadUnreadFromDBV2(yn,e),this.doDoneLoadDBTask()}));else{Ds.a.ConvInfoDataManager.isDoneLoadDB()&&(this.isLoadDBStarted=!0,this.migrateV2())}}async resetToUnreadReddotOAIfNeeded_(){try{let e=dn.b().enable_for_oa,t=await S.default.getInstance().getItemForCurrentUserAsync(gn),s=!1,i=!1;if(null==t)this.logger.zsymb(0,"lyTxA3","Force reset to unread reddot OA at first time."),s=!0;else{const[s,a]=t.split("_").map(Number);if(e===s)return;const n=!e&&1==s,r=Boolean(e)&&0==s;i=n||r,this.logger.zsymb(3,"GietSn",["shouldResetToUnreadReddotByRule by mainRule: {} - subRule: {}","oeKxXd"],n,r)}if(s||i){if(this.data.size>0){this.logger.zsymb(0,"azg9J5","perf reset to default unread reddot OA.");const e=e=>{const t=e.smsUnreadCount||0;let s=e.smsUnreadNotCount||0;const i=t-s;return i>0?(this.logger.zsymb(3,"oLIipP",["resetToDefaultUnreadReddotItemIfNeeded - OAConvId: {} - count: {} - smsUnreadNotCount: {}","X5kTeg"],e.convId,i,s),s=s||1,{shouldReset:!0,data:Object(f.a)(Object(f.a)({},e),{},{smsUnreadCount:s,smsUnreadNotCount:s,strangerUnreadCount:s})}):{shouldReset:!1,data:e}},t=Array.from(this.data.values()),s=new Map;t.forEach((e=>s.set(e.convId,Object(f.a)({},e))));const i=t.map((e=>e.convId));this.logger.zsymb(3,"gm4xrv",["before verify oa convs: {}","gnd75R"],Date.now());const a=(await qs.a.verifyOATypeAsync(i)).reduce(((t,i)=>{if(i.isOA&&s.has(i.cid)){const a=s.get(i.cid),{shouldReset:n,data:r}=e(a);n&&t.push(r)}return t}),[]);if(this.logger.zsymb(3,"BvtNCI",["Reset to default unread reddot OA - count: {} - ts: {}","K5tSve"],a.length,Date.now()),a.length){const e=Date.now().toString();Object(Kt.j)(e),a.forEach((t=>{this.data.set(t.convId,t),Object(Kt.f)(e,this.name,t.convId),this.updateInDB(t)})),Object(Kt.c)(e),this.unreadChanged("reset")}}}const a=`${e}_${Date.now()}`;this.logger.zsymb(3,"-pLFh1",["apply new unread count for OA config - newAppliedConfigAndTS: {}","5STY-e"],a),S.default.getInstance().setItemForCurrentUserAsync(gn,a)}catch(e){this.logger.zsymb(21,"9xpF87",["reset to unread reddot OA if needed error: {}","_8iaMV"],null==e?void 0:e.message)}}handleConvUnreadCountConfigChange_(e){const{prevConfig:t,nextConfig:s}=e;t.enable_for_oa!==s.enable_for_oa&&this.doneLoadDB&&this.resetToUnreadReddotOAIfNeeded_()}shouldForceShowReddotForOAMessages_(e,t=!1){const s=dn.b().enable_for_oa;return Boolean(!s&&(t||e&&qs.a.isOAType({userId:e})))}async migrateV2(){const e=S.default.getInstance(),t=e.getItemForCurrentUser(hn)===un;if(this.logger.zsymb(3,"drRBAz",["call migrate unread {}","Gap0bx"],t),t)return;const s=Ds.a.ConvInfoDataManager.getAllConvSync(),i=[];s.forEach((e=>{const t=e.smsUnreadCount||0,s=e.smsUnreadNotCount||0,a=e.mentionUnreadCount||0,n=e.unreadMark||null;if(!(e&&e.userId&&(t||s||a||n)))return;const r={convId:e.userId,smsUnreadCount:t,smsUnreadNotCount:s,strangerUnreadCount:0,mentionUnreadCount:a,lastProcessMsgId:e.lastMessageIdFromServerv2||"0",lastSeenReactId:e.lastSeenReactId||"0",unreadMark:n};i.push(r)})),this.onLoadUnreadFromDBV2(bn,i),this.doDoneLoadDBTask(),this.logger.zsymb(3,"61aFfQ",["done migrate unread {}","ebdluZ"],i.length),e.setItemForCurrentUser(hn,un)}async doDoneLoadDBTask(){await this.resetToUnreadReddotOAIfNeeded_();const e=Array.from(this.data.values());this.doneLoadDB=!0,this.broadcastEvent(Ks.b.DoneLoadDB,"total",e),this.logger.zsymb(3,"6U1VtC",["done load unread {}","9FUh69"],e.length),Object(ln.e)(e),setTimeout((()=>{this.unreadChanged("init")}),200)}addListener(){Ds.a.MuteDataManager.addEventListener(Ks.b.MuteChanged,(e=>{this.onMuteConversation(e.convId,!!e.payload)})),Ds.a.ConvInfoDataManager.addEventListener(Ks.b.LeaveGroup,(e=>{this.doDeleteUnread(e.convId)})),Ds.a.ConvInfoDataManager.addEventListener(Ks.b.DeleteConv,(e=>{this.doDeleteUnread(e.convId)})),Ds.a.ConvInfoDataManager.addEventListener(Ks.b.EmptyConv,(e=>{this.doDeleteUnread(e.convId)})),Ds.a.ConvInfoDataManager.addEventListener(Ks.b.DoneLoadDB,(e=>{this.onState("CALL_INIT")})),Ds.a.ArchivedChatManager.addEventListener(Ks.b.UpdateListArchivedChat,(e=>{this.onArchivedChat(e.convId)})),Cs.default.subscribe(((e,t)=>{if(null!=t&&t.length&&e===Os.ConversationListActions.CLEAR_MARK_AS_UNREAD)t.forEach((e=>{this.updateUnreadMark(e,null)}));else if(null!=t&&t.length&&e===Os.GeneralActions.UPDATE_HIDDEN_CHAT)for(let s=0;s<t.length;s++){const e=t[s];this.onHiddenConversation(e.uid,e.isHide)}})),dn.a(this.handleConvUnreadCountConfigChange_)}getItem(e,t){if(e.key===pn)return this.total;return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){throw new Error("Method not implemented.")}onMuteConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||Zs.a.isThreadHidden(e)||this.shouldForceShowReddotForOAMessages_(e)||(this.logger.zsymb(0,"wiPUwN","onMuteConversation:",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onHiddenConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||mt.default.isMuted(e)||this.shouldForceShowReddotForOAMessages_(e)||(this.logger.zsymb(0,"xiW7HI","onHiddenConversation: ",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onArchivedChat(e){const t=this.data.get(e);!t||t.smsUnreadCount<1&&!t.unreadMark||mt.default.isMuted(e)||this.shouldForceShowReddotForOAMessages_(e)||this.unreadChanged(e)}onChangeConvLabel(e,t,s){const i=this.data.get(e);t===s||!i||i.smsUnreadCount<1||mt.default.isMuted(e)||this.unreadChanged(e)}onReceivePreviewMessages(e){e.length>0&&(this.previewMsgs=[...this.previewMsgs,...e])}onReceiveNewMessagesOld(e,t,s){if(!s||!t)return;const i=this.data.get(e);if(i)this.logger.zsymb(0,"I0K74W","receive msg",e,i.lastProcessMsgId,s),(!i.lastProcessMsgId||i.lastProcessMsgId<t)&&this.handleNewMessages(e,s,t).then((()=>{Object(Kt.g)(this.name,e)}));else{const t=this.pendingMessage.get(e),i=t?s.concat(t):s;this.pendingMessage.set(e,i),i.length===s.length&&this.DBConvUnread.getById(e).then((t=>{if(!t){const t=this.pendingMessage.get(e);if(t){const s=t.filter(((e,t,s)=>s.indexOf(e)===t)),i=di.b.getLastMessageInList(s);if(!i)return;this.pendingMessage.delete(e),this.handleNewMessages(e,s,i.msgId).then((()=>{Object(Kt.g)(this.name,e)}))}}}))}}onReceiveNewMessages(e,t,s){if(!s||!s.length||!t)return;const a=this.data.get(e);if(this.doneLoadDB){if(!a||!a.lastProcessMsgId||a.lastProcessMsgId<t){const i=s.map((e=>e.msgId)).join("-");this.logger.zsymb(0,"Sl24L0",`onReceiveNewMessages: ${null==a?void 0:a.lastProcessMsgId} ${e} ${t} ${i}`),this.handleNewMessages(e,s,t).then((()=>{Object(Kt.g)(this.name,e)}))}}else{const t=this.pendingMessage.get(e),i=t?s.concat(t):s;this.pendingMessage.set(e,i)}i.ModuleContainer.resolve(hi.TUnreadSubChatTabStateManager).handleReceiveLatestMessage({convId:e,msgId:t})}onDoneOffLineMessages(){this.logger.zsymb(0,"rUBqIF","ph7 done offline"),Ni.b.onDoneEntry(Ni.a.FIRST_FETCH),this.previewMsgs.length>0&&setTimeout((()=>{this.handlePreviewMsgs()}),0)}doDeleteUnread(e){if(!e)return;Object(ln.a)([e]);const t=this.data.get(e);this.logger.zsymb(0,"XcKayl",`doDeleteUnread ${!!t}`),this.data.delete(e)&&(Object(Kt.e)(this.name,e),this.unreadChanged(e)),this.deleteInDB(e)}onReceiveDeleteConvMsg(e,t){if(this.doneLoadDB){const s=this.safeGetUnreadCached(e);if(0===s.smsUnreadCount)return;if(t>=+s.lastProcessMsgId){const t=Object(f.a)(Object(f.a)({},s),{},{smsUnreadCount:0,smsUnreadNotCount:0});this.data.set(t.convId,t),Object(Kt.g)(this.name,e),this.unreadChanged(e)}}else this.pendingClearUnread.set(e,t)}onClearUnreadConversations(e){if(!e||e.length<0)return;let t=[];for(let s=0;s<e.length;s++){const i=e[s],a=this.data.get(i.userId)||fn(i.userId);this.logger.zsymb(0,"wHCyrQ","onClearUnreadConversations",!!i,null==a?void 0:a.smsUnreadCount),i&&(t.push(i.userId),a.smsUnreadCount>0&&mt.default.getLastMessageFrom(i.userId,i.lastSmsLocalId,cn,a.smsUnreadCount,!0).then((e=>{let t={};if(e&&e.length>0)for(let i=0;i<e.length;i++){let s=e[i];Is.default.validMessageFromOther(s)&&(t[s.msgId]=s)}const s={userId:i.userId,lastSmsLocalId:i.lastSmsLocalId,smsUnreadCount:a.smsUnreadCount};this.clearUnreadConversation(s,t),this.resetUnreadToZero(i.userId,a.lastProcessMsgId)})).catch((e=>{this.logger.zsymb(21,"Et5mue",["clear unread conv failure {}","w3CFrz"],e)})),Ya.a.clearUnreadIfExist({userId:i.userId,lastSeenReactId:a.lastSeenReactId}))}Object(ln.a)(t,e.length>0)}onReadConversation(e,t){var s;if(ms.default.mark_unread.enable&&!Object(ln.c)(e))return this.logger.zsymb(0,"ItHxuh",`[read-message] dont clear ${e}`,ms.default.mark_unread.enable,Object(ln.c)(e)),!1;Object(ln.b)(e)&&(e.startsWith(R.GROUPID_PREFIX)?Vt.default.logAction(2160024):Vt.default.logAction(2160023),Vt.default.logAction(2160022));const i=this.data.get(e)||fn(e),a=i.smsUnreadCount;if(!t&&!a){this.logger.zsymb(0,"yg5trC",`[read-message] dont clear ${e} unread `,a,t);const s=Ya.a.sendClearUnread(e,i.lastSeenReactId);return Object(ln.a)([e],!1),s!=i.lastSeenReactId&&(i.lastSeenReactId=s,this.data.set(e,Object(f.a)({},i)),Object(Kt.g)(this.name,e),this.updateInDB(i)),!1}const n=this.acquireConvManager().getConvByIdSync(e);if(!n)return this.logger.zsymb(0,"dOq06K",`[read-message] convinfo not exists ${e}`),!1;const r=[],o={},d=n.lastSmsLocalId?n.lastSmsLocalId.toString().split("_")[0]:"";let l=!1;const c=null===(s=Ja.b.messageCache)||void 0===s?void 0:s.getLast({userId:e},a);for(let g=c.length-1;g>-1;g--){let e=c[g];if(Is.default.validMessageFromOther(e)&&!r.includes(e.msgId)&&(r.push(e.msgId),o[e.msgId]=e,e.msgId==d&&(l=!0),r.length==a))break}const h={userId:e,lastSmsLocalId:n.lastSmsLocalId,smsUnreadCount:a};var u;!d||l||o[d]?this.clearUnreadConversation(h,o):(this.logger.zsymb(0,"LHQPGP",`[read-message] append lastMsgIdInConv ${d} ${Object.keys(o).length}`),null===(u=Ja.b.messageCache)||void 0===u||u.getMessageByMsgIdAsync(d,e).then((e=>{o[d]=Object(f.a)({},e),this.clearUnreadConversation(h,o)})).catch((e=>{this.clearUnreadConversation(h,o)})));return Object(ln.a)([e],!1),i.lastSeenReactId=Ya.a.sendClearUnread(e,i.lastSeenReactId),this.resetUnreadToZero(e,i.lastProcessMsgId),!0}getUnreadByConvIdSync(e){return this.data.get(e)}getUnreadByConvId(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.getUnreadByConvIdSync(e));this.DBConvUnread.getById(e).then((e=>t(e))).catch(s)}))}getAllUnreadsSync(){return Array.from(this.data.values())}getAllUnreads(){return new Promise(((e,t)=>{if(this.doneLoadDB)return e(this.getAllUnreadsSync());this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((t=>e(t))).catch(t)}))}resetUnreadToZero(e,t){return this.getUnreadByConvId(e).then((s=>{if(Ka.b.onClearUnreadConv(e),!s||!s.smsUnreadCount&&!s.smsUnreadNotCount)return!1;if(this.logger.zsymb(3,"QTUx5s",["resetUnreadToZero {} {} {}","qkwhIN"],e,t,s.smsUnreadCount),!qs.b.assertString(t,this.logger))return!1;const i={convId:e,smsUnreadCount:0,mentionUnreadCount:0,strangerUnreadCount:0,smsUnreadNotCount:0,lastProcessMsgId:t,lastSeenReactId:s.lastSeenReactId||"",unreadMark:s.unreadMark};return s.smsUnreadCount>0&&qa.a.notiMainClearunread(e),this.forkUpdateCacheAndDB(i).then((t=>(this.broadcastEvent(Ks.b.ReadConv,e),!0))).catch((t=>(this.logger.zsymb(21,"Ec_hoY",["resetUnreadToZero failure {} {}","BwcTit"],e,t),!1)))}))}isUnreadMessage(e){const{message:t,convId:s,lastProcessMsgId:i}=e,a=di.b.isMyMessage(t),n=$a.b.isRead({userId:s,msgId:t.msgId,msgSendDttm:t.ts||t.serverTime||t.sendDttm,msgLocalId:void 0,e2eeStatus:Object(nn.f)(t)}),r=!t.msgId||!i||t.msgId<=i;return!n&&r&&!a}_updateTTLUnreadCount(e,t,s){const i=this.data.get(e)||null;if(this.logger.zsymb(0,"ATLzRU","_updateTTLUnreadCount",e,null==i?void 0:i.smsUnreadCount),i&&i.smsUnreadCount===t&&i.smsUnreadNotCount===s)return;let a=this.safeGetUnreadCached(e);a.smsUnreadCount=t,a.smsUnreadNotCount=s,this.forkUpdateCacheAndDB(a)}updateUnreadTTLConversation(e,t,s){const i=this.getUnreadByConvIdSync(e);if(i){let a=i.smsUnreadCount,n=i.smsUnreadNotCount;t.filter((t=>t.ttlType===on.a.Message&&this.isUnreadMessage({message:this._getDeletedMsgByTTLItem(t,s),convId:e,lastProcessMsgId:i.lastProcessMsgId}))).forEach((e=>{const t=this._getDeletedMsgByTTLItem(e,s),i=Is.default.getDataReminder(t),r=di.b.isMyMessage(t);i&&r&&(t.idTo===ms.default.sendToMeId||r)?(n-=1,a-=1):a-=1})),this._updateTTLUnreadCount(e,Math.max(a,0),Math.max(n,0))}}updateUnreadCount(e,t){const s=this.data.get(e)||null;if(this.logger.zsymb(0,"aBr2Ho","updateUnreadCount",e,null==s?void 0:s.smsUnreadCount),s&&s.smsUnreadCount===t)return;let i=this.safeGetUnreadCached(e);i.smsUnreadCount=t,this.forkUpdateCacheAndDB(i)}updateMentionCount(e,t){this.logger.zsymb(0,"MkXV3s","updateMentionCount",e,t);let s=this.safeGetUnreadCached(e);s.mentionUnreadCount=t,this.forkUpdateCacheAndDB(s,!1),an.a.updateUnreadMentions(this.getTotalMentionCount())}updateLastSeenReactId(e,t){let s=this.safeGetUnreadCached(e);s.lastSeenReactId=t,this.forkUpdateCacheAndDB(s,!1)}updateUnreadMark(e,t){let s=this.safeGetUnreadCached(e);s.unreadMark||(s.unreadMark=null),t||(t=null),t!==s.unreadMark&&(this.total.unreadMark+=t?1:-1,Object(Kt.g)(this.name,pn),s.unreadMark=t,this.forkUpdateCacheAndDB(s))}shouldClearUnread(e,t){const s=this.data.get(e),i=null==s?void 0:s.smsUnreadCount,a=null==s?void 0:s.lastProcessMsgId;return!!i&&!!(a&&t&&+t>=+a)}async forkUpdateCacheAndDB(e,t=!0){this.data.set(e.convId,e),Object(Kt.g)(this.name,e.convId),t&&this.isValidConvKey(e.convId)&&this.unreadChanged(e.convId),await this.updateInDB(e)}safeGetUnreadCached(e){const t=this.data.get(e);let s;return s=t?Object(f.a)({},t):{convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:null},s}getTotalMentionCount(){let e=0;return this.data.forEach((t=>{e+=t.mentionUnreadCount})),e}isValidConvKey(e){return!(!e||e.length<3)&&("null"!=e&&(e!==R.CONV_FILTER.STRANGER&&e!==pn))}unreadChanged(e){"null"!=e&&(this.updateTotalQueue.remove((e=>!0)),this.updateTotalQueue.push(e))}async calculateComputeUnreadCount(e){try{var t;const a=this.getEmptyTotal(),n=(null===(t=this.data.get(R.CONV_FILTER.STRANGER))||void 0===t?void 0:t.smsUnreadCount)||0;let r=0;const o=i.ModuleContainer.resolve(hi.TUnreadSubChatTabStateManager),d=o.getAllSeenMilestones(),l={[hi.SubChatTabType.FOCUSED]:!1,[hi.SubChatTabType.ARCHIVED]:!1},c=new Map,h=new Map,u=new Map;Ds.a.LabelDataManager.getAllLabelIds().map((e=>{const t=""+e;u.set(t,t)}));const g=new Map,m=[];for(let e of Array.from(this.data.keys())){if(!this.isValidConvKey(e))continue;const t=this.data.get(e);if(!t)continue;if(!(Boolean(t.smsUnreadCount)||Boolean(t.smsUnreadNotCount)||Boolean(t.unreadMark)))continue;const s=o.getSubtabTypeOfConv(e),i=mt.default.isMuted(e),a=t.lastProcessMsgId;!i&&o.isValidSubChatTabType(s)&&a>d[s]&&(l[s]=!0);if(Zs.a.isThreadHidden(e))continue;li.a.isArchivedChat(e)||(g.set(e,t),m.push(e))}mn;if((await qs.a.verifyOATypeAsync(m)).forEach((({cid:e,isOA:t})=>{const s=g.get(e),i=s.convId,n=this.acquireConvManager().getConvByIdSync(i),o=mt.default.isMuted(i);const d=s.smsUnreadCount||0,l=s.smsUnreadNotCount||0;if(a.smsUnreadCount+=d,n&&!o&&!this.shouldForceShowReddotForOAMessages_(i,t)&&n.userId!==R.FAKE_CONVERSATION_ID.FRIEND_CENTER){const e=Math.max(d-l,0);a.smsUnreadNomute+=e;const t=n.label?""+n.label:"",o="0"==t||!!t;if(o&&(c.has(t)?c.set(t,c.get(t)+e):c.set(t,e)),s.unreadMark){const e=a.unreadMark||0;a.unreadMark=e+1,o&&(h.has(t)?h.set(t,h.get(t)+1):h.set(t,1))}e>0&&this.isInStrangerBox(i)&&(r+=e)}})),this.total.smsUnreadCount!==a.smsUnreadCount||this.total.smsUnreadNomute!==a.smsUnreadNomute||this.total.unreadMark!==a.unreadMark){var s;const t=null===(s=this.data.get(e))||void 0===s?void 0:s.smsUnreadCount,i=mt.default.isMuted(e);this.total=a,this.dispatchEvent(new Ks.a(Ks.b.ChangeUnreadCount,pn,{unreadNoMute:a.smsUnreadNomute,totalUnread:a.smsUnreadCount,convId:e,currentUnread:t,curentUnreadNoMute:i?0:t})),this.data.set(pn,a),Object(Kt.g)(this.name,pn)}if(o.handleShowReddotsAtSubChatTab(l),n!==r){const e=this.safeGetUnreadCached("");e.smsUnreadCount=r,e.convId=R.CONV_FILTER.STRANGER,this.data.set(R.CONV_FILTER.STRANGER,e),Object(Kt.g)(this.name,R.CONV_FILTER.STRANGER)}for(let e of Array.from(c.keys())){const t=this.safeGetUnreadCached("");t.smsUnreadCount=c.get(e),t.unreadMark=h.get(e),this.data.set(e,t),u.delete(e),Object(Kt.g)(this.name,e)}for(let e of Array.from(u.keys()))this.data.delete(e)&&Object(Kt.g)(this.name,e)}catch(a){this.logger.zsymb(21,"DRmGrK",[" unread err - contact phucnh7 please!!! {}","hZIjDE"],a)}}acquireConvManager(){return Ds.a.ConvInfoDataManager}onLoadUnreadFromDBV2(e,t){if(this.logger.zsymb(0,"SEm-Cd","onLoadUnreadFromDB",t.length),t.length<1)return;const s=(new Date).getTime().toString();Object(Kt.j)(s);for(let i=0;i<t.length;i++){const a=t[i];if("object"==typeof a.lastProcessMsgId||"string"==typeof a.lastProcessMsgId&&a.lastProcessMsgId.includes("object")?(a.lastProcessMsgId="0",this.logger.zsymb(18,"z9FmYu","Corrected lastProcessMsgId!"),fs.default.increaseFailed(151101,0,0,0,Date.now())):$a.b.isRead({userId:a.convId,msgId:+a.lastProcessMsgId,e2eeStatus:void 0,msgSendDttm:void 0,msgLocalId:void 0})&&(a.smsUnreadCount||a.smsUnreadNotCount)&&(this.logger.zsymb(0,"wheLPv","clear offline",a.convId,a.smsUnreadCount),a.smsUnreadCount=0,a.strangerUnreadCount=0,a.smsUnreadNotCount=0),this.pendingClearUnread.has(a.convId)){const e=this.pendingClearUnread.get(a.convId);e&&e>=+a.lastProcessMsgId&&(this.logger.zsymb(0,"2F5EH7","clear pending",this.pendingClearUnread.size,a.convId),a.smsUnreadCount=0,a.strangerUnreadCount=0,a.smsUnreadNotCount=0)}"null"===a.lastProcessMsgId&&(a.lastProcessMsgId=""),this.data.set(a.convId,a),Object(Kt.f)(s,this.name,a.convId),e===bn&&this.updateInDB(a),a.unreadMark&&this.total.unreadMark++}this.pendingClearUnread.clear(),this.processPendingMessages(),Object(Kt.c)(s)}processPendingMessages(){this.logger.zsymb(0,"MJShnW","start processPendingMessages",this.pendingMessage.size),this.pendingMessage.forEach(((e,t)=>{const s=new Map,i=this.data.get(t);e.forEach((e=>{var t;(!i||i.lastProcessMsgId<e.msgId)&&s.set(`${(t=e).uidFrom||t.fromUid}_${t.idTo||t.toUid}_${t.cliMsgId}`,e)})),this.logger.zsymb(0,"cyWHlR","check processPendingMessages #2",t,null==i?void 0:i.smsUnreadCount,e.map((e=>e.msgId)),s.keys());const a=Array.from(s.values()),n=di.b.getLastMessageInList(a);this.handleNewMessages(t,a,null==n?void 0:n.msgId)})),this.pendingMessage.clear()}async handleNewMessages(e,t,s){var i,a;if(!t||!t.length)return;if(!qs.b.assertString(s,this.logger))return;let n=!1;const r={convId:e,strangerUnreadCount:0,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,lastProcessMsgId:s,lastSeenReactId:"0"},o=Date.now(),d=new Set,{isOA:l}=null!==(i=null===(a=await qs.a.verifyOATypeAsync([e]))||void 0===a?void 0:a[0])&&void 0!==i?i:{isOA:!1};if(t.forEach((t=>{const i=di.b.isMyMessage(t);if(t.status!==R.MSG_READ&&!i){const s=t.ts||t.serverTime||t.sendDttm;$a.b.isRead({userId:e,msgId:t.msgId,msgSendDttm:s,msgLocalId:void 0,e2eeStatus:Object(nn.f)(t)})&&(ms.default.stagingAccount&&this.logger.zsymb(0,"f7kwUp",`mark msg status as read ${e} ${t.msgId}`),t.status=R.MSG_READ)}let a=Wa.a.get(t.msgId,t.status);a!=t.status&&ms.default.stagingAccount&&this.logger.zsymb(0,"1ty6iz",`change msg status ${t.status} => ${a}`),t.status=a;let c=!1;if("chat.todo"===t.msgType){let e=t.content;if(e){"todo.remind"===e.action&&(c=!0)}}let h=Is.default.getDataReminder(t);if(t.status!==R.MSG_READ&&!i||!0===c){if(t.paramsExt&&Is.default.valueValid(t.paramsExt.countUnread)){const s=this.shouldForceShowReddotForOAMessages_(e,l);(0==t.paramsExt.countUnread||1==t.paramsExt.countUnread&&s)&&(r.smsUnreadNotCount+=1)}this.isCallTimeMessage(t)||(r.smsUnreadCount+=1,r.strangerUnreadCount+=1),Ha.b.isMessageMentionMe(t)&&r.mentionUnreadCount++}else h&&i&&(t.idTo===ms.default.sendToMeId||i)?(r.smsUnreadCount+=1,r.smsUnreadNotCount+=1,this.logger.zsymb(0,"wp6iq2",`new unread #2: ${o} ${e} ${t.msgId} ${t.idTo} ${t.toUid} ${t.src} ${s}`)):!(u=t)||"0"==u.uidFrom&&(null===(g=u.paramsExt)||void 0===g?void 0:g.platformType)==Bi.i.DeviceIds.SYSTEM?(d.add(t.msgId),this.logger.zsymb(0,"4ez7Kh","_addMessages: skipped clear unread for",t.idTo)):t.isCallMessage||(r.smsUnreadCount=0,r.strangerUnreadCount=0,r.mentionUnreadCount=0,n=!0);var u,g;r.smsUnreadCount>0&&Ni.b.markGotUnread(e,t.msgId),Ni.b.isLastMsgV2(t)&&this.onDoneOffLineMessages()})),d.has(s))for(let h=t.length-1;h>=0;h--){const s=t[h];if(Is.default.validMessageFromServer(s)&&!d.has(s.msgId)){if(this.logger.zsymb(0,"_d1xeF","update last process id",e,r.lastProcessMsgId,s.msgId),r.lastProcessMsgId=s.msgId,!qs.b.assertString(s.msgId,this.logger))return;break}var c;0==h&&(r.lastProcessMsgId=(null===(c=this.data.get(e))||void 0===c?void 0:c.lastProcessMsgId)||"0")}return Object(ln.a)([e]),this.updateUnread(e,n,r)}handlePreviewMsgs(){if(!this.previewMsgs.length)return;const e=[...this.previewMsgs];this.previewMsgs=[],this.logger.zsymb(0,"UL-8vD","handle preview",e.map((e=>e.msgId))),e.forEach((e=>{const t=e.toUid,s=en.default.checkDuplicate(t,{uidFrom:e.fromUid,cliMsgId:e.cliMsgId});s&&s.src&&s.msgId!==e.msgId&&(this.logger.zsymb(0,"V8SdHo","detect dup msg",e.msgId,s.msgId),e.msgId=s.msgId),this.onReceiveNewMessages(t,e.msgId,[e])}))}updateUnread(e,t,s){let i=this.data.get(e);if(i){const e=i.lastSeenReactId||"0";t?i=s:(i.smsUnreadNotCount+=s.smsUnreadNotCount,i.smsUnreadCount+=s.smsUnreadCount,i.strangerUnreadCount+=s.strangerUnreadCount,i.mentionUnreadCount+=s.mentionUnreadCount,i.lastProcessMsgId=s.lastProcessMsgId),i.lastSeenReactId=e}else{if(i=s,!i)return void this.logger.zsymb(18,"t1SO-w",`updateUnread undefined item ${e}`);i.lastSeenReactId=rn.b.getLastSeen(e)||"0"}this.data.set(e,Object.assign({},i)),this.updateInDB(i),0!=s.mentionUnreadCount&&an.a.updateUnreadMentions(this.getTotalMentionCount()),this.unreadChanged(e)}isInStrangerBox(e){const t=Ds.a.ConvInfoDataManager.getConvByIdSync(e);return qa.a.isInStrangerBox(t)}isCallTimeMessage(e){if("chat.recommended"===e.msgType&&e.content){if(e.content.action===R.CallMessageAction.CallTime)return!0;if(e.content.action===R.CallMessageAction.MissCall){let s=e.content.params;if("string"==typeof s)try{s=JSON.parse(e.content.params)}catch(t){}if(s&&3===s.reason)return!0}}return!1}clearUnreadConversation(e,t={}){if(e&&e.smsUnreadCount)try{let s=!0,i=Object.keys(t);i&&0!=i.length||(s=!1,this.logger.zsymb(0,"l6wQbA",`[read-message] actually, no need send seen in that case 2: ${i.length}`)),!s&&ms.default.chat_aggressive_send_seen&&(s=!0),s?(i&&0!==i.length?this.sendClearUnreadToServer(t,e.userId):mt.default.getLastMessageFrom(e.userId,e.lastSmsLocalId,cn,e.smsUnreadCount,!0).then((t=>{let s=[],i={};if(t&&t.length)for(let e=0;e<t.length;e++){let a=t[e];Is.default.validMessageFromOther(a)&&(s.push(a.msgId),i[a.msgId]=a)}0===s.length?this.logger.zsymb(3,"w8XDm4",["- [read-message] get ids.length == 0 {}","X7jSSc"],e.userId):this.sendClearUnreadToServer(i,e.userId)})).catch((e=>{this.logger.zsymb(21,"PgUsqe",[" [read-message] get msgs err {}","1A-Eai"],e)})),As.a.emitWithKey(js.d.userOnNewDeviceTracking,js.d.clearUnreadMessages,{convId:e.userId})):this.logger.zsymb(3,"x8Qj9A",["[read-message] no send {}","8xyktH"],e.userId)}catch(s){this.logger.zsymb(21,"zUC_iJ",["[read-message] err {}","vuwU_G"],s)}else this.logger.zsymb(0,"uq_sVC",`[read-message] actually, no need send seen in that case 1: ${null==e?void 0:e.userId}`)}async sendClearUnreadToServer(e={},t){const s=Object.keys(e),i=qa.a.isGroup(t),a=Qa.a.newReq();try{await ys.default.sendSeen(e,t,i,a),ms.default.stagingAccount&&this.logger.zsymb(0,"sxLbf6",`[read-message] done ${t} msgId:\n\t\t\t\t\t${s&&s.length?s[s.length-1]:0}`)}catch(n){if(this.logger.zsymb(21,"C9AW0a",["[read-message] err {}","vuwU_G"],n),!(s&&s.length>0))throw this.logger.zsymb(21,"Qn0PLn",["[read-message] send seen fail!!! convId:{} msgId len = 0","KH7oWj"],t),n;if(this.logger.zsymb(21,"ly8UJ-",["[read-message] send seen fail!! convId:{} msgId:{}","bmC0RU"],t,s[s.length-1]),n&&(114===n.error_code||-69===n.error_code))throw this.logger.zsymb(21,"pwkhLZ",["[read-message] send seen fail!!! no need retry {}","QU133P"],n.error_code),n;throw ms.default.retrySendSeen?(this.logger.zsymb(21,"wxh6nF",["[read-message] send seen fail!!! retry","pdOjs0"]),Za.b.retryAction(Za.a.SEND_SEEN_V2,[e,t,i,a],{startedTime:Date.now(),duration:ms.default.retrySendSeen.timeout})):this.logger.zsymb(21,"ac9CB9",["[read-message] send seen fail!!! not retry","g4fPxi"]),n}}broadcastEvent(e,t,s){this.dispatchEvent(new Ks.a(e,t,s))}updateInDB(e){null==e.lastSeenReactId&&(e.lastSeenReactId=rn.b.getLastSeen(e.convId)||"0",this.logger.zsymb(18,"xUYIZs",`update invalid lastSeen ${e.convId}`)),qs.b.assertString(e.lastProcessMsgId,this.logger)&&this.DBConvUnread.addOrUpdate(e)}deleteInDB(e){this.DBConvUnread.remove(e)}})||Xa)||Xa)||Xa);var In=s("8Nax"),_n=s("GSHL"),Cn=s("w5bt");let On;var Sn,En;(Sn=On||(On={})).modelToEntity=function(e){if(!e)throw new Error("[PreviewHelper] Convert undefined model to entity");return{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties?{type:e.properties.type}:null,mentions:e.mentions?e.mentions:null,ttl:e.ttl,cliMsgId:e.cliMsgId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon}},Sn.entityToModel=function(e){return e?{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties,mentions:e.mentions,ttl:e.ttl,cliMsgId:e.cliMsgId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon,src:"db.preview",verified:!1}:null};const Mn="zpm_m",Tn="1.0.0";Object(Hs.b)(Cn.b)(En=function(e,t){return i.ModuleContainer.inject(_n.b)(e,void 0,0)}(En=Reflect.metadata("design:type",Function)(En=Reflect.metadata("design:paramtypes",[void 0===Ks.IReactiveDB?Object:Ks.IReactiveDB])(En=class extends je.b{constructor(e){super(),this.DBConvPreview=e,this.name=void 0,this.key=void 0,this.didInit=void 0,this.data=void 0,this.list=void 0,this.deleteQueue=void 0,this.doneLoadDB=void 0,this.migrating=void 0,this.fetchAllHolder=void 0,this._Logger=void 0,this.name=Cn.a,this.key="convId",this.didInit=!1,this.data=new Map,this.list=new Map,this.deleteQueue=[],this.doneLoadDB=!1,this.migrating=!1,this.fetchAllHolder=null}init(){return this.didInit?Promise.resolve():(this.didInit=!0,this.loadData())}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}signalRenderItem(e,t){Object(Kt.g)(e,t),this.broadcastEvent(Ks.b.PreviewChanged,t,{changedItem:this.data.get(t),all:Array.from(this.data.values())}),Object(Kt.i)(e,"all")}loadData(){return new Promise(((e,t)=>{S.default.getInstance().getItemForCurrentUser(Mn)!==Tn||this.migrating?e():(this.Logger.zsymb(3,"L1ZoMF",["start load preview","vXN14z"]),this.fetchAllHolder||(this.fetchAllHolder=this.DBConvPreview.getAll()),this.fetchAllHolder.then((t=>{this.onLoadPreviewsFromDB(t).then(e).catch((t=>{this.Logger.zsymb(21,"WY6a6a",["load previews from db failure #1! {}","QYyOhp"],t),e()}))})).catch((t=>{this.Logger.zsymb(21,"l3QFBb",["load preview from db failure #2! {}","QCwQ3G"],t),e()})))}))}async revalidate(e){const t=!!this.getPreviewByIDSync(e),s=await Ba.b.getPreviewMessage(e).catch((s=>(this.Logger.zsymb(21,"07H-V2",["revalidate failure #1 {} {} {}","lz2XMi"],e,t,s),{previewMsg:void 0})));return!!s.previewMsg&&this.onReceiveNewMessage("db.message",s.previewMsg).then((s=>(this.Logger.zsymb(3,"zdlvn3",["revalidate success {} {} {}","BxBnc8"],e,t,s),!0))).catch((s=>(this.Logger.zsymb(21,"qIihy-",["revalidate failure #2 {} {} {}","RcWXNt"],e,t,s),!1)))}migrate(e,t=!1){return new Promise((s=>{const i=S.default.getInstance().getItemForCurrentUser(Mn);if(i===Tn&&!t)return;if(this.Logger.zsymb(3,"DLGfAQ",["start migrate {} {}","fYvBKj"],i,t),this.migrating=!0,0===e.length)return this.doneMigratePreivew(0),s(0);let a=0,n=0;const r=()=>{if(a++,a===e.length)return this.doneMigratePreivew(n),s(n)},o=()=>{n++,r()},d=()=>{for(let t=0;t<e.length;t++)Ba.b.getPreviewMessage(e[t]).then((s=>{s&&s.previewMsg?this.onReceiveNewMessage("db.message",s.previewMsg).then(o).catch(r):(this.Logger.zsymb(3,"k-eGUG",["migrate not exists msg {}","LHvT0Z"],e[t]),r())})).catch((s=>{r(),this.Logger.zsymb(21,"3dQfH2",["migrate failure for conv {} {}","vg5b8Q"],e[t],s)}))};let l=e.filter((e=>e!==R.FAKE_CONVERSATION_ID.FRIEND_CENTER&&e!==R.FAKE_CONVERSATION_ID.GROUP_CENTER&&!e.startsWith(R.GROUPID_PREFIX)));if(l.length>0)return zt.default.getProfileFriendByIds(l,R.SRC_GET_PROFILE.FETCH_MINI_INFO).then((()=>{d()})).catch((()=>{d()}));d()}))}doneMigratePreivew(e){this.Logger.zsymb(3,"TN5lPr",["done migrate preview {}","BpYTJW"],e);S.default.getInstance().setItemForCurrentUser(Mn,Tn),this.broadcastEvent(Ks.b.DoneMigratePreview,"")}upgradeItemsVersion(e=[]){this.Logger.zsymb(3,"GoNWDY",["upgradeItemsVersion","PQDYZw"]);const t=(new Date).getTime().toString();Object(Kt.j)(t),0!==e.length?e.forEach((e=>{Object(Kt.f)(t,this.name,e)})):this.data.forEach((e=>{Object(Kt.f)(t,this.name,e.convId)})),Object(Kt.c)(t)}updateStrangerBox(e){const t=this.data.get(e);t&&(this.data.set(R.CONV_FILTER.STRANGER,Object(f.a)({},t)),Object(Kt.g)(this.name,R.CONV_FILTER.STRANGER))}forceChangeItem(e){this.signalRenderItem(this.name,e)}getItem(e,t){const s=this.data.get(e.key);return s||this.Logger.zsymb(5,"CP-LCi",["try to get item not exist in cache {}","NCiEjF"],e.key),s}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){this.Logger.zsymb(11,"aW0Dcz",["onGetItemFailure {}","7QdTJ7"],e)}onGetListFailure(e,t){this.Logger.zsymb(11,"mBflgP",["onGetListFailure {} {}","hKFo8g"],e,t)}onLoadPreviewsFromDB(e){return new Promise(((t,s)=>{if(this.Logger.zsymb(3,"0iqhwE",["onLoadPreviewsFromDB {}","ACB-sf"],null==e?void 0:e.length),!e||0===e.length)return this.doneLoadPreview(0),t();let i=0;const a=()=>{i++,i===e.length&&(this.doneLoadPreview(i),t())};for(let n=0;n<e.length;n++){const t=On.entityToModel(e[n]);t&&!In.a.instance.filterExpiredPreview(t)&&(t.messageType=R.MSG_VANISH,t.message="",this.updateInDB(t)),this.addPreviewToManager(t).then((()=>{a()})).catch((e=>{a(),this.Logger.zsymb(21,"EmCT0C",["onload preview failure for item {} {}","DWU4jU"],null==t?void 0:t.convId,e)}))}}))}doneLoadPreview(e){this.Logger.zsymb(3,"X2_yLO",["doneLoadPreview {}","kil920"],e),this.doneLoadDB=!0,this.broadcastEvent(Ks.b.DoneLoadPreview,"",Array.from(this.data.values())),Object(Kt.i)(this.name,"all")}onReceiveNewMessage(e,t){return new Promise(((s,i)=>{if(!t)return s(!1);const a=this.convertDBMessageToPreviewItem(e,t);this.addPreviewToManager(a).then((e=>e?(this.signalRenderItem(this.name,t.toUid),s(!0)):s(!1))).catch(i)}))}onReceiveNewMessages(e,t){return new Promise((s=>{if(!t)return s(!1);const i=this.groupMessageByConvId(t),a=[];for(const e in i){if(!Object.prototype.hasOwnProperty.call(i,e))continue;const t=i[e];for(let e=t.length-1;e>=0;e--){if(di.b.isValidPreviewMessage(t[e])){a.push(t[e]);break}this.Logger.zsymb(3,"QRw2lE",["receive msg but not preview {}","HOsK6x"],t[e].msgId)}}return a.length?Promise.all(a.map((async t=>this.onReceiveNewMessage(e,t)))).then((e=>{const t=e.some((e=>1==e));s(t)})).catch((e=>{this.Logger.zsymb(21,"DEKJmg",["add messages to preview got error {}","5xoMcE"],e),s(!1)})):s(!1)}))}onUndoMessage(e,t){if(!t)return;this.Logger.zsymb(3,"eTfLFm",["onUndoMessage {}","FLSebh"],t.msgId);const s=this.convertDBMessageToPreviewItem(e,t);s.messageType=R.MSG_UNDO,s.message="",this.addPreviewToManager(s).then((e=>{e&&this.signalRenderItem(this.name,t.toUid)}))}onUpdateE2EEMessage(e,t){if(!t)return;const s=t.toUid,i=this.data.get(s);if(this.Logger.zsymb(3,"PahAXY",["onUpdateE2EEMessage {} {} {}","a5kiTy"],s,null==i?void 0:i.msgId,t.msgId),i&&(i.msgId!==t.msgId||!Ha.b.isSameMsg(i,t)))return;const a=this.convertDBMessageToPreviewItem(e,t),n=Is.default.normalizeMessageTypeFromSubState(null==t?void 0:t.e2eeStatus)||t.msgType;a.message=a.message||di.b.getPlainText({msgType:n}),a.verified=!0,a.messageType=n,this.data.set(t.toUid,a),this.updateInDB(a),this.signalRenderItem(this.name,t.toUid)}onDeleteMessage(e,t){return new Promise(((e,s)=>{if(!t)return e(!1);this.Logger.zsymb(3,"X-uKSk",["onDeleteMessage {}","YViG5e"],t.msgId);const i=this.convertDBMessageToPreviewItem("db.message",t);this.deleteMessageInManager(i).then((s=>{s?(this.Logger.zsymb(3,"U2coAq",["onDeleteMessage success {}","FCkqas"],t.msgId),this.signalRenderItem(this.name,t.toUid),e(!0)):e(!1)}))}))}onDeleteMessages(e,t){if(!t||t.length<1)return;const s=this.groupMessageByConvId(t);for(const i in s)if(Object.prototype.hasOwnProperty.call(s,i)){const t=s[i];let a=this.convertDBMessageToPreviewItem(e,t[0]),n=0;for(let s=1;s<t.length;s++){const i=this.convertDBMessageToPreviewItem(e,t[s]);this.isSecondItemNewer(a,i)&&(n=s,a=i)}this.onDeleteMessage(e,t[n])}}onDeleteConversation(e){e&&(this.Logger.zsymb(3,"UfCfTm",["onDeleteConversation {}","3qyQ_g"],e),this.data.delete(e)&&Object(Kt.e)(this.name,e),this.deleteInDB(e))}onChangeDraft(e,t){let s=this.getPreviewByIDSync(e);return!e||!s||s.draft===t||s.draft&&t&&s.draft.draftTime===t.draftTime?(!s&&t&&(this.data.set(e,{convId:e,msgId:R.FAKE_DRAFT_MSG_ID,draft:t,messageTime:-1}),this.signalRenderItem(this.name,e)),void this.Logger.zsymb(3,"P0QZnV",["onChangeDraft - reject {}","TjuosQ"],!!s)):(this.Logger.zsymb(3,"SHWZ1q",["onChangeDraft - call update {}","zslae5"],!!s),s.msgId!==R.FAKE_DRAFT_MSG_ID||t?(s=Object(f.a)(Object(f.a)({},s),{},{draft:t}),this.data.set(e,s),this.signalRenderItem(this.name,e),void this.broadcastEvent(Ks.b.DraftChanged)):(this.data.set(e,{convId:e,msgId:R.FAKE_DRAFT_MSG_ID,draft:void 0,messageTime:-1}),this.signalRenderItem(this.name,e),void this.data.delete(e)))}getPreviewById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvPreview.getById(e).then((s=>{s||this.Logger.zsymb(3,"IjMMz0",["get item not exist with id {}","oXkW9g"],e);const i=On.entityToModel(s);t(i||void 0)})).catch(s)}))}getPreviewByIDSync(e){return this.data.get(e)}getAllPreviews(){return new Promise(((e,t)=>{if(this.doneLoadDB)return e(this.getAllPreviewsSync());this.fetchAllHolder||(this.fetchAllHolder=this.DBConvPreview.getAll()),this.fetchAllHolder.then((t=>{const s=t.map((e=>On.entityToModel(e)));e(s)})).catch(t)}))}getAllPreviewsSync(){return Array.from(this.data.values())||[]}setPreview(e,t,s,i,a,n=1,r={}){const o=this.data.get(e);this.Logger.zsymb(3,"US5Fdu",["call set preview {} {}","7hDdNB"],e,!!o);const d={convId:e,msgId:r.msgId||"unset",src:"ui",dName:r.dName||"",message:t,messageType:"",isGroup:e.startsWith(R.GROUPID_PREFIX),messageTime:s,fromUid:i,toUid:a,urgencyLevel:r.urgencyLevel,properties:null,verified:!0,status:n,computedMessage:t,computedIcon:r.icon};this.data.set(e,d),this.signalRenderItem(this.name,e),this.updateInDB(d)}async addPreviewToManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);let i=!1;if(s){const a=!(s.messageType||s.message||!e.messageType||!e.message);a&&(s.verified=!0,this.Logger.zsymb(3,"E9qnkz",["force update new preview item {}","ENjZKx"],t)),(a||this.isSecondItemNewer(s,e))&&(this.data.set(t,e),i=!0,s.verified?(e.verified=!0,this.updateInDB(e)):i=await this.compareCacheWithDBAndUpdate(t,e))}else this.data.set(t,e),i=!0,"db.preview"!==e.src&&(i=await this.compareCacheWithDBAndUpdate(t,e));return i}async deleteMessageInManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);if(!s||!Ha.b.isSameMsg(e,s)&&this.isSecondItemNewer(e,s))return 0!==this.deleteQueue.length&&this.deleteQueue.push(e),!1;const i=async()=>{const e=await Ba.b.getPreviewMessage(t),i=this.deleteQueue.find((t=>{var s;return t.msgId===(null===(s=e.previewMsg)||void 0===s?void 0:s.msgId)}));if(i)return this.data.set(t,i),await this.deleteMessageInManager(i);this.deleteQueue=[];const a=this.data.get(t);if(a&&this.isSecondItemNewer(s,a))return!1;if(e.previewMsg){const s=this.convertDBMessageToPreviewItem("db.message",e.previewMsg);return s.verified=!0,this.data.set(t,s),this.updateInDB(s),!0}return this.data.delete(t),this.deleteInDB(t),Object(Kt.e)(this.name,t),!1};if(s.verified)return await i();{const s=await this.DBConvPreview.getById(t),a=s&&On.entityToModel(s);return a&&this.isSecondItemNewer(e,a)?(this.data.set(t,a),!0):await i()}}convertDBMessageToPreviewItem(e,t){let s=t.sendDttm||t.serverTime;s=s?s.toString():"";const i=t.fromUid||t.uidFrom,a=t.toUid||t.idTo,n=a&&a.startsWith(R.GROUPID_PREFIX);return{convId:t.toUid,msgId:t.msgId,src:e,dName:t.dName||"",message:t.message,messageType:t.msgType,mentions:t.mentions,isGroup:n,messageTime:s,fromUid:i,properties:t.properties,urgencyLevel:t.urgency,verified:!1,ttl:t.ttl,status:t.status||1,substate:t.e2eeStatus,cliMsgId:t.cliMsgId,toUid:t.toUid}}isSecondItemNewer(e,t){return!e||(t.msgId===e.msgId&&t.messageTime===e.messageTime||Ha.b.isSameMsg(e,t)?t.messageType===R.MSG_UNDO&&e.messageType!==R.MSG_UNDO||qs.a.comparePreviewStt(t.status,e.status)>0:e.messageTime!==t.messageTime?t.messageTime>e.messageTime:t.msgId>e.msgId)}compareCacheWithDBAndUpdate(e,t){return new Promise(((s,i)=>{this.DBConvPreview.getById(e).then((i=>{this.Logger.zsymb(3,"i-etDL",["compareCacheWithDBAndUpdate {} {}","jiD2gM"],e,!!i);const a=On.entityToModel(i),n=this.data.get(e);if(JSON.stringify(n)!==JSON.stringify(t))return s(!1);!a&&n||a&&n&&this.isSecondItemNewer(a,n)?(n.verified=!0,this.updateInDB(n)):a&&this.data.set(e,a),s(!0)})).catch(i)}))}groupMessageByConvId(e){const t={};for(let s=0;s<e.length;s++)t[e[s].toUid]?t[e[s].toUid].push(e[s]):t[e[s].toUid]=[e[s]];return t}broadcastEvent(e,t="",s){this.dispatchEvent(new Ks.a(e,t,s))}updateInDB(e){this.Logger.zsymb(3,"AxqUPM",["update in db {}","IoocWn"],e.msgId);try{const t=On.modelToEntity(e);this.DBConvPreview.addOrUpdate(t)}catch(t){this.Logger.zsymb(21,"eO5rRj",["update in db got err{}","NLU0t0"],t)}}deleteInDB(e){this.DBConvPreview.remove(e).catch((e=>{this.Logger.zsymb(18,"H1xm7r",`[${this.name}] - deleteInDB got error ${e}`)}))}})||En)||En)||En);var wn=s("rKwX"),Rn=s("SWKE");const Ln="z_ml";class Fn{constructor(){this.cache=void 0,this.cache={}}localKey(e){return Ln+"_"+e}muteConversation(e,t){const s=S.default.getInstance(),i=Ln+"_"+e;t?t.constructor===Object?s.setItemForCurrentUser(this.localKey(e),JSON.stringify(t)):s.setItemForCurrentUser(this.localKey(e),`${t}`):s.removeItemForCurrentUser(i),this.cache[e]=t||!1}isMuted(e){if(this.cache.hasOwnProperty(e))return this.cache[e];let t,s=S.default.getInstance().getItemForCurrentUser(this.localKey(e));if(!s)return null;try{return t=JSON.parse(s),this.cache[e]=t,t}catch(i){Is.default.logCoreError(i)}return this.cache[e]=!1,!1}setMutedConversations(e){let t=[];e.chatEntries&&e.chatEntries.length>0&&e.chatEntries.reduce(((e,t)=>(e.push(t),e)),t),e.groupChatEntries&&e.groupChatEntries.length>0&&e.groupChatEntries.reduce(((e,t)=>(t.id=R.GROUPID_PREFIX+t.id,e.push(t),e)),t);Rn.a.getInstance().cleanupLocalStorageMatchConditions((e=>{const t=S.default.getInstance().getKeyNameForCurrentUser(this.localKey(""));return e.startsWith(t)})),this.cache={};for(let s=0;s<t.length;s++)this.muteConversation(t[s].id,t[s]);return t}}var Dn;Object(Hs.b)(xs.g)(Dn=Reflect.metadata("design:type",Function)(Dn=Reflect.metadata("design:paramtypes",[])(Dn=class extends je.b{constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this._muteManager=void 0,this.userId=void 0,this.mapTimeout=void 0,this.name=xs.f,this.key="id",this.didInit=!1,this.userId="",this.mapTimeout={}}init(e){this.didInit||(this.didInit=!0,this.userId=e)}get muteManager(){return this._muteManager&&""!==this.userId||(this.userId,this._muteManager=new Fn),this._muteManager}getItem(e,t){return this.muteManager.isMuted(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e){}onGetListFailure(e,t){}onMute(e,t){return new Promise(((s,i)=>{this._clearTimeout(e);let a=-1;switch(t){case 1:a=3600;break;case 2:a=14400;break;case 3:a=Math.round(this._getNowTo8Am()/1e3)}Is.default.logCoreInfo(`[${this.name}] - onMute ${e} ${a}`),wn.a.lock(e,a,!0).then((t=>{this.muteManager.muteConversation(e,{id:e,startTime:t.startTime,duration:t.duration,systemTime:t.systemTime,currentTime:t.currentTime,muteMode:t.muteMode}),s(!0)})).catch(i)}))}onUnMute(e,t=!0,s=!1){return new Promise(((i,a)=>{this._clearTimeout(e),Is.default.logCoreInfo(`[${this.name}] - onUnMute ${e} ${t} ${s}`),wn.a.unlock(e,t,s).then((t=>{this.muteManager.muteConversation(e,0),i(!!t)})).catch(a)}))}onFetchMute(e){Is.default.logCoreInfo(`[${this.name}] - onFetchMute`);let t=this.muteManager.setMutedConversations(e);return this.processFetchData(e),t}onCtrMute(e,t){t?(this.doLock(t,!1),this.muteManager.muteConversation(e,t),this.muteChanged(e,!!t)):this.onUnMute(e,!1).then((s=>{this.muteChanged(e,!!t)}))}isMuted(e){return this.muteManager.isMuted(e)}processFetchData(e){try{e.chatEntries&&(e.chatEntries.forEach((e=>{this.doLock(e,!0)})),e.groupChatEntries.forEach((e=>{this.doLock(e,!0)})))}catch(t){Is.default.logCoreError(t)}}doLock(e,t=!0){if(this.mapTimeout.hasOwnProperty(e.id)&&(t=!0),this._clearTimeout(e.id),-1!=e.duration){Is.default.log("setTimer",e);let s=e.duration-(e.currentTime-e.systemTime);s>=0?(Is.default.log("setTimer: lock1",e.id),Is.default.logCoreInfo("[Unmute timeout] setTimer: lock1",e.id,s),this.mapTimeout[e.id]=setTimeout((()=>{this.onUnMute(e.id,t,!0),Is.default.logCoreInfo("[Unmute timeout] setTimer: unlock1",e.id)}),1e3*s)):(Is.default.log("setTimer: unlock",s),Is.default.logCoreInfo("[Unmute timeout] setTimer: unlock",e.id),this.onUnMute(e.id,t))}}_clearTimeout(e){this.mapTimeout.hasOwnProperty(e)&&(clearTimeout(this.mapTimeout[e]),delete this.mapTimeout[e])}_getNowTo8Am(){let e=(new Date).getTime(),t=new Date(e);return t.setHours(8,0,0,0),t.getTime()<=e?t.getTime()+864e5-e:t.getTime()-e}muteChanged(e,t){Object(Kt.g)(this.name,e),this.broadcastEvent(Ks.b.MuteChanged,e,t)}broadcastEvent(e,t="",s){this.dispatchEvent(new Ks.a(e,t,s))}})||Dn)||Dn);var An,jn=s("kCOK"),Pn=s("qvRd"),Nn=s("fBUP"),Un=s("gwig");const kn="zpinc",Bn="ver_pin",Gn=0,xn=1,zn=2;Object(Hs.b)(Pn.b)(An=Reflect.metadata("design:type",Function)(An=Reflect.metadata("design:paramtypes",[])(An=class extends je.b{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this._Logger=void 0,this.reFetchCount=void 0,this.retryTimeout=void 0,this.refetchInterval=void 0,this.lastFetchTime=void 0,this.isDataLastest=void 0,this.requestingIds=void 0,this.name=Pn.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.reFetchCount=0,this.isDataLastest=!1,this.lastFetchTime=0,this.requestingIds=new Map}init(){this.didInit||(this.didInit=!0,this._loadData(),this._fetchPinnedConversations(),this._addListener())}_loadData(){const e=S.default.getInstance().getItemForCurrentUser(kn);if(e&&e.length)try{const s=JSON.parse(e);Object.keys(s).map((e=>{this._verifyPin(s[e].id)&&this.data.set(s[e].id,{id:s[e].id,priority:+s[e].priority||bs.default.getTimeNow()})}));try{this.Logger.zsymb(0,"8n71HX","pin conversations loaded from local",JSON.stringify(Object.fromEntries(this.data)))}catch(t){this.Logger.zsymb(18,"DLYuiV","stringify fail")}this.doneLoadDB=!0;const i=this.getAllPinnedConversations();i.length&&this._broadcastEvent(Ks.b.ChangePinConv,i)}catch(s){0}}_addListener(){zt.default.subscribeEventFriend(R.EventFriend.REMOVE_FRIEND,(e=>{this.Logger.zsymb(0,"zu_M58","remove friend - unpin",e.userId),this.updateListPin([e.userId],zn)})),this._setFetchInterval()}_setFetchInterval(){this.refetchInterval&&clearTimeout(this.refetchInterval),this.refetchInterval=setInterval((()=>{this._fetchPinnedConversations()}),864e5)}_broadcastEvent(e,t){this.dispatchEvent(new Ks.e(e,t))}_newPinItem(e,t){return{id:e,priority:t}}_syncServer(e,t){return this._updatePinnedConversationsV2(e,t)}getLastFetchTime(){return this.lastFetchTime}isPinned(e){return this.data.has(e)}getPinTime(e){const t=this.data.get(e);return t?t.priority:0}async _checkAndSyncDataBeforeAction(){if(!this.isDataLastest)try{return await this._fetchPinnedConversations(),!0}catch(e){return!1}return!0}pin(e){return this.Logger.zsymb(0,"UgiJi_","client pin",e),new Promise((async(t,s)=>{const i=await this._checkAndSyncDataBeforeAction();if(!e||!e.length)return s(null);if(i){if(this.data.size+e.length>ms.default.limit_pin_messages)return s(null);let i=[];for(let t=0;t<e.length;++t)this.isPinned(e[t])||i.push(e[t]);if(i.length>0)try{const s=await this._syncServer(i,xn);return this.updateListPin(e,xn),t(s)}catch(a){return s(a)}}return s(null)}))}pinLocal(e){this.updateListPin(e,xn)}unpin(e,t=!1){return this.Logger.zsymb(0,"Jmlo_H","client unpin",e,"force sync",t),new Promise((async(s,i)=>{if(!e||!e.length)return i(null);if(await this._checkAndSyncDataBeforeAction()){let n=[];for(let s=0;s<e.length;++s)(this.isPinned(e[s])||t)&&n.push(e[s]);if(n.length>0)try{await this._syncServer(n,zn),this.updateListPin(e,zn),s(1)}catch(a){i(a)}}return i(null)}))}unpinLocal(e){this.Logger.zsymb(0,"Be7Rkl","unpin local",e),this.updateListPin(e,zn)}getAllPinnedConversations(){return Array.from(this.data.values())}getAllPinnedConversationsSync(){return Array.from(this.data.values())}getTotalPinnedConversation(){return this.data.size+Array.from(this.requestingIds.values()).filter((e=>e===xn)).length}_verifyPin(e){return this.Logger.zsymb(0,"LktO3B","verify conversation",e,zt.default.isFriend(e),!!oi.default.getGroupByIdSync(e),e===ms.default.sendToMeId),zt.default.isFriend(e)||!!oi.default.getGroupByIdSync(e)||e===ms.default.sendToMeId}updateListPin(e,t){if(this.Logger.zsymb(0,"Ea1T_S","updateListPin",e,t),!e||!e.length)return;const s=[];switch(t){case xn:let t=bs.default.getTimeNow();for(let i=0;i<e.length;i++)if(this._verifyPin(e[i])&&!this.data.has(e[i])){++t,this.requestingIds.get(e[i])&&this.requestingIds.set(e[i],Gn);const a=this._newPinItem(e[i],t);this.data.set(e[i],a),s.push(a),Object(Kt.g)(this.name,e[i])}break;case zn:for(let i=0;i<e.length;i++)if(this.data.has(e[i])){this.requestingIds.get(e[i])&&this.requestingIds.set(e[i],Gn),this.data.delete(e[i]);const t=this._newPinItem(e[i],0);s.push(t),Object(Kt.g)(this.name,e[i])}break;default:return}s.length&&this._broadcastEvent(Ks.b.ChangePinConv,s),this._updateInDB()}_retryFetch(e){if(this.reFetchCount>5)return;let t=0;switch(e){case"ERR_NO_NETWORK":case-69:break;case 212:this.Logger.zsymb(20,"2aoNUM","hasn't pinned conversation from server");S.default.getInstance().setItemForCurrentUser(Bn,"0"),this._sendToServer();break;case"ERR_CONNECTION_TIMED_OUT":case 112:t=5e3*this.reFetchCount;break;default:t=36e5}this.Logger.zsymb(21,"Q2NTxk",["Handle request error fail with error: {}, retry after time= {}","4IbWlj"],e,t),this.retryTimeout||t>0&&(this.retryTimeout=setTimeout((()=>{this._fetchPinnedConversations(),this.retryTimeout=void 0}),t))}_parseData(e){let t=[];for(let s=0;s<e.length;++s)"m1"===e[s]||(e[s].startsWith("g")?t.push(e[s]):t.push(e[s].slice(1)));return t}_fetchPinnedConversations(){return this.reFetchCount++,this.Logger.zsymb(0,"IVNRqz","_fetchPinnedConversations",this.reFetchCount),new Promise(((e,t)=>{Nn.default.getPinnedConversations().then(jn.a).then((t=>{if(t&&t.conversations){const e=S.default.getInstance();void 0===t.version&&null===t.version||e.setItemForCurrentUser(Bn,t.version),this._onFetchPin(this._parseData(t.conversations))}e(t)})).catch((e=>{this.isDataLastest=!1,e&&(e.error_code?this._retryFetch(e.error_code):e.code?this._retryFetch(e.code):this._retryFetch("UNKNOWN_ERROR")),t(e)}))}))}_updatePinnedConversationsV2(e,t){return new Promise(((s,i)=>{if(!ms.default.enable_sync_pinned)return;if(!Un.b.getStateNetwork())return void i(t===xn?$t.default.str("STR_ERR_NETWORK_PIN_CONVERSATION"):$t.default.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));let a=[];for(let n=0;n<e.length;++n)e[n].startsWith("g")||e[n].startsWith("u")||(e[n]="u"+e[n]),a.includes(e[n])||this.requestingIds.has(e[n])&&this.requestingIds.get(e[n])!==Gn||(a.push(e[n]),this.requestingIds.set(e[n],t));a.length&&Nn.default.updatePinnedConversationsV2(a,t).then(jn.a).then((()=>{a.forEach((e=>{this.requestingIds.set(e,Gn)})),s(!0)})).catch((e=>{a.forEach((e=>{this.requestingIds.set(e,Gn)})),this.Logger.zsymb(20,"9-NrBj","Update sync pin conv v2 FAIL: "+e);let s="";if(e)if(e.error_code)if(160===e.error_code)this._fetchPinnedConversations();else s=$t.default.str("STR_ERR_PIN_CONVERSATION")+" ("+e.error_code+")";else"ERR_NO_NETWORK"===e.code&&Un.b.getStateNetwork()==Un.a.DISCONNECT&&(s=t===xn?$t.default.str("STR_ERR_NETWORK_PIN_CONVERSATION"):$t.default.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));i(s)}))}))}_isRemoteDataChanged(e){const t=Array.from(this.data.values()).sort(((e,t)=>t.priority-e.priority)).map((e=>e.id));if(e.length!==t.length)return!0;let s=!1;return e.forEach(((e,i)=>{e!==t[i]&&(s=!0)})),s}_onFetchPin(e){this.Logger.zsymb(0,"V9BGmX","onFetchPin",e),this.isDataLastest=!0,this.lastFetchTime=bs.default.getTimeNow(),this.reFetchCount=0;let t=bs.default.getTimeNow();this._setFetchInterval();const s=[],i=[];for(let a=0;a<e.length;a++)this._verifyPin(e[a])?i.push(e[a]):this.unpin([e[a]],!0);if(this._isRemoteDataChanged(i)){for(const e of Array.from(this.data.values()))i.find((t=>t===e.id))||(this.data.delete(e.id),Object(Kt.g)(this.name,e.id),s.push({id:e.id,priority:0}));for(let e=0;e<i.length;e++){const a=this._newPinItem(i[e],t),n=this.isPinned(i[e]);this.data.set(i[e],a),n||Object(Kt.g)(this.name,i[e]),t--,s.push(a)}this.Logger.zsymb(0,"t79ywL","[After Fetch]",Array.from(this.data.values())),s.length&&this._broadcastEvent(Ks.b.ChangePinConv,s),this._updateInDB()}}_sendToServer(){this._syncServer(Array.from(this.data.keys()),xn)}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){this.Logger.zsymb(18,"8toPyZ","onGetItemFailure - key:",e," - error",t)}onGetListFailure(e,t){this.Logger.zsymb(18,"YjwV6v","onGetItemFailure - key:",e," - error",t)}_updateInDB(){if(!this.data)return;const e=S.default.getInstance();this.data.size?e.setItemForCurrentUser(kn,JSON.stringify(Array.from(this.data.values()))):e.removeItemForCurrentUser(kn)}})||An)||An);var Vn,Hn=s("MnJw");Object(Hs.b)(Hn.a)(Vn=Reflect.metadata("design:type",Function)(Vn=Reflect.metadata("design:paramtypes",[])(Vn=class extends je.b{constructor(){super()}onUpdateListArchivedChat(e){this.dispatchEvent(new Ks.a(Ks.b.UpdateListArchivedChat,e))}onOffArchivedChat(e){this.dispatchEvent(new Ks.a(Ks.b.OnOffArchivedChat,"",{status:e}))}})||Vn)||Vn);i.ModuleContainer.registerSingleton(va.b,Ca),i.ModuleContainer.registerSingleton(Na.a,ja),i.ModuleContainer.registerSingleton(va.a,Ia);var $n,Wn=s("Xvw2"),qn=s("5uwv"),Kn=s("lCn6"),Zn=s("kg13"),Qn=s("dJFb");const Jn=2,Yn={userId:"",friendRequestType:Jn,friendRequestSource:85};var Xn=function(e){return e.SUGGEST="suggest",e.REQUEST="request",e.UNREADREQ="unread-req",e}(Xn||{});Object(Hs.b)(Wn.b)($n=Reflect.metadata("design:type",Function)($n=Reflect.metadata("design:paramtypes",[])($n=class extends je.b{constructor(){super(),this.sugguestList=void 0,this.requestList=void 0,this.unreadFRList=void 0,this._ebFriendRequestSend=e=>{const t=this.unreadFRList.filter((t=>t!==e));t.length!==this.unreadFRList.length&&(mt.default.changeFriendsToStranger(e),Is.default.logCoreError("[reddot-check] SEND_FRIEND_REQUEST: "+JSON.stringify(e)),this.unreadFRList=t,Object(Kt.i)(this.name,Xn.UNREADREQ))},this._ebFriendFetch=e=>{for(let t in e)if(e.hasOwnProperty(t)){const e=this.requestList.slice();for(let s=0;s<e.length;s++)if(e[s]===t){e.splice(s,1);break}e.length!==this.requestList.length&&(this.requestList=e,Object(Kt.i)(this.name,Xn.REQUEST))}},this._ebFrReqFetch=e=>{Is.default.log("friendNotificationAction: friend requests fetched",e);const t=this.requestList.reduce(((e,t)=>(e[t]||(e[t]=!0),e)),{}),s=this.requestList.slice();for(let i of e)t[i.userId]||s.unshift(i);this.requestList=s,Object(Kt.i)(this.name,Xn.REQUEST)},this._ebFrReqRemove=e=>{Is.default.log("friendNotificationAction: friend requests removed",e);const t=this.requestList.filter((t=>-1===e.indexOf(t)));t.length!==this.requestList.length&&(this.requestList=t,Object(Kt.i)(this.name,Xn.REQUEST)),this.onFriendListNotificationsChange({action:"remove",ids:e})},this.name=Wn.a,this.data=new Map,this.key="userId",this.sugguestList=[],this.requestList=[],this.unreadFRList=[],this.listenEvents()}listenEvents(){Cs.default.subscribe(((e,t)=>{switch(e){case Os.ChatBoxActions.SEND_FRIEND_REQUEST:this._ebFriendRequestSend(t);break;case Os.FetchActions.FRIENDS_FETCHED:this._ebFriendFetch(t);break;case Os.FetchActions.FRIEND_REQUESTS_FETCHED:this._ebFrReqFetch(t);break;case Os.FetchActions.FRIEND_REQUESTS_REMOVED:this._ebFrReqRemove(t)}}))}onAddFriend(e){Zn.a.removeSuggest(e.userId),this.onFriendListNotificationsChange({action:"remove",ids:[e.userId]})}onReceiveFriendRequests(e){if(!e||e.length<1)return;for(let s=0;s<e.length;s++){let t=e[s];t&&Zn.a.removeSuggest(t.userId)}Qn.d.setUnreadRequest(1);for(let s=0;s<e.length;s++)e[s]&&$e.p.addNewFriendItem(e[s].userId);Ds.a.UnreadDataManager.updateUnreadCount(R.FAKE_CONVERSATION_ID.FRIEND_CENTER,Qn.d.getUnreadRequest());let t=e.map((e=>({dataInfo:Object(f.a)(Object(f.a)({},e),{},{recommInfo:{message:e.friendRequestMsg,source:e.friendRequestSource},recommType:Jn}),recommItemType:e.friendRequestType})));Zn.a.addRequest(t),this.broadcastEvent(qn.b.ReceiveRequest,"",{uids:e.map((e=>e.userId))})}onRemoveSuggest(e,t,s){return Zn.a.removeSuggestFriend(e,t,s).then((t=>{this.broadcastEvent(qn.b.RemoveSuggest,e)}))}onPromoteFriends(){Ds.a.UnreadDataManager.updateUnreadCount(R.FAKE_CONVERSATION_ID.FRIEND_CENTER,1)}onFriendRequestFetched(){}onFriendListNotificationsChange(e){if(!e.ids||!e.ids.length)return void("clear"===e.action&&(this.unreadFRList=[],Object(Kt.i)(this.name,Xn.UNREADREQ)));let t=this.unreadFRList;if("remove"===e.action)t=t.filter((t=>-1===e.ids.indexOf(t)));else if("add"===e.action){const s=[];for(let i of e.ids)-1===t.indexOf(i)&&s.push(i);s.length&&(t=t.concat(s))}t.length!==this.unreadFRList.length&&(this.unreadFRList=t,Object(Kt.i)(this.name,Xn.UNREADREQ))}acceptFriendRequest(e,t=Qs.c){return new Promise(((s,i)=>{const a=this.data.get(e);if(!a)return Qi.a.acceptAddFriend(e).then((i=>{Gt.ModalManagerV2.openModal({windowId:t,name:R.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch(i);let n;if(a.friendRequestType===R.FRIEND_REQUEST_TYPE_SUGGEST){if(a.requested)return n=104097,Vt.default.logAction(n),s(!1);const r=$t.default.trans("STR_MSG_DEFAULT_REQ_ADD_FR",zt.default.getMiniProfileMe().zaloName);Qi.a.requestAddFriend(e,r,a.friendRequestSource).then((()=>{Gt.ModalManagerV2.openModal({windowId:t,name:R.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),mt.default.changeFriendsToStranger(e),Zn.a.removeSuggest(e);const i=Object(f.a)(Object(f.a)({},a),{},{requested:!0});this.broadcastEvent(qn.b.SentFriendReq,e),this.data.set(e,i),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),i(e)})),n=104096}else Qi.a.acceptAddFriend(e).then((()=>{this.data.delete(e),Object(Kt.e)(this.name,e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),this.broadcastEvent(qn.b.AcceptRequest,e),Kn.a.getUser(e).then((t=>{Cs.default.send(Os.FetchActions.FRIENDS_FETCHED,{[e]:Object(f.a)(Object(f.a)({},Is.default.reformatConversationFromFriend(t)),{},{isFr:1})})})),mt.default.getAcceptNewFriend(a),Gt.ModalManagerV2.openModal({windowId:t,name:R.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),i(e)})),n=104095;n&&Vt.default.logAction(n)}))}async rejectFriendRequest(e){const t=this.data.get(e),s=()=>{Ht.a.createSuccess($t.default.str("STR_TOAST_REJECT_REQUEST")),mt.default.changeFriendsToStranger(e),Zn.a.removeSuggest(e),this.broadcastEvent(qn.b.RejectRequest,e)},i=e=>{Is.default.logCoreError(e),e&&e.error_message&&Ht.a.createError(e.error_message)};t&&t.friendRequestSource?ys.default.removeRecommendedFriend(e,t.friendRequestSource).then(s).catch(i):Qi.a.rejectRequestAddFriend(e).then(s).catch(i),this.data.delete(e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),Vt.default.logAction(104094)}undoRequestFriend(e){e&&Qi.a.undoRequestAddFriend(e).catch((e=>{e.error_message&&Ht.a.createError(e.error_message)}))}clearUnreadFriendRequest(){Ds.a.UnreadDataManager.updateUnreadCount(R.FAKE_CONVERSATION_ID.FRIEND_CENTER,0),this.unreadFRList=[],Object(Kt.i)(this.name,Xn.UNREADREQ)}getAllFriendRequests(){return new Promise(((e,t)=>{const s=Zn.a.getRecommendedFriendsV2(!1,!1);if(!s)return e({});e(this.filterFriendRequest(s))}))}getAllFriendRequestsSync(){const e=Zn.a.getRecommendedFriendsSync();return e?this.filterFriendRequest(e):{}}init(){mt.default.getFriends(null,!0).then((e=>{if(e){const t=mt.default.getLastContactListOpenTime(),s=e.filter((e=>e&&e.friendRequestFetchTime>t)).map((e=>e.userId));s.length&&this.onFriendListNotificationsChange({action:"add",ids:s})}}))}getItem(e){return Yn}getList(e){return e.key===Xn.UNREADREQ?this.unreadFRList:[]}onGetItemFailure(e){}onGetListFailure(e){}handleFailureFriendRq(e){if(Is.default.logCoreError(e),e&&e.error_message){let t=e.error_message;[224,251].includes(e.error_code)&&(t=$t.default.trans(`STR_FRIEND_REQUEST_FAIL_${e.error_code}`,[""+ms.default.limitFriends])),Ht.a.createMessage(t,3e3)}}filterFriendRequest(e){const t={};for(let s in e)if(e.hasOwnProperty(s)){let i=e[s];i&&i.dataInfo.recommType===Jn&&(t[s]=i,t[s].friendRequestType=i.dataInfo.recommType)}return t}broadcastEvent(e,t,s){this.dispatchEvent(new qn.a(e,t,s)),this.dispatchEvent(new qn.a(qn.b.FriendCenterChange,t,Object(f.a)(Object(f.a)({},s),{},{act:e})))}})||$n)||$n);var er=s("5cla"),tr=s("WV6O");class sr{static resetNewFriendList(){delete this.newListFriend,this.newListFriend=void 0}static addNewFriendUid(e){void 0===this.newListFriend&&this.getNewFriendList(),this.newListFriend.push(e)}static getNewFriendList(){mt.default.removeNewFriend("",!0);let e=[];try{const t=S.default.getInstance().getItemForCurrentUser("f_nf");t&&(e=JSON.parse(t))}catch(t){}this.newListFriend=e.map((e=>e.userId))}static getFriendList(e){const{userId:t}=e,s=[];return new Promise(((e,i)=>{zt.default.getFriends().then((i=>{if(i){const a=Boolean(ei.g.getConfigShowAllUser(t));for(let e=0;e<i.length;e++)(1===i[e].isFr||i[e].isFr||i[e].userId===ms.default.supportPage)&&i[e].userId!=t&&i[e].isValid&&i[e].userId!=ms.default.sendToMeId&&(a||i[e].isActive||i[e].isActivePC||i[e].isActiveWeb)&&s.push(i[e].userId);e(s)}else e([])})).catch((e=>i(e)))}))}static getFriendInfo(e){var t;const{userId:s}=e,i=zt.default.getProfileFriendSync(s);return i?(void 0===this.newListFriend&&this.getNewFriendList(),{userId:i.userId,avatar:i.avatar,displayName:i.displayName,isFr:i.isFr,zaloName:i.zaloName,bizPkg:i.bizPkg,bizInfo:i.bizInfo,isNewFriend:(null===(t=this.newListFriend)||void 0===t?void 0:t.includes(s))||!1,isBlocked:i.isBlocked}):null}}sr.newListFriend=void 0;class ir{static getGroupList(){return oi.default.getGroupsList()}static getGroupInfo(e){const{userId:t}=e;return new Promise(((e,s)=>{oi.default.getGroupById(t).then((t=>{e({userId:t.userId,avatar:t.avatar,displayName:t.displayName,topMember:t.topMember,totalMember:t.totalMember,creatorId:t.creatorId})})).catch(s)}))}static getGroupInfoSync(e){const{userId:t}=e,s=oi.default.getGroupByIdSync(t);return s?{userId:s.userId,avatar:s.avatar,displayName:s.displayName,topMember:s.topMember,totalMember:s.totalMember,creatorId:s.creatorId}:null}}class ar{static getRecommendFriendList(){return new Promise(((e,t)=>{ys.default.getRecommendedFriends().then((t=>e(t.recommItems))).catch(t)}))}static getRelatedGroup(e){return new Promise(((t,s)=>{ys.default.getRelatedGroup(e).then(t).catch(s)}))}static getRequestedFriendList(){return new Promise(((e,t)=>{ys.default.getRequestedFriends().then(e).catch(t)}))}static acceptAddFriend(e){return Qi.a.acceptAddFriend(e)}static rejectAddFriend(e){return Qi.a.rejectRequestAddFriend(e)}static makeUndoSentRequestFriend(e){return Qi.a.undoRequestAddFriend(e.userId)}static removeSuggestFriend(e){return new Promise(((t,s)=>{ys.default.removeRecommendedFriendV2(e.uid,e.src,e.type).then(t).catch(s)}))}}var nr;const rr={currentView:tr.f.FRIEND_LIST,unread:{newFriendRequests:[],newGroupRequests:[],newGroupInvitations:new Set,isUnread:!1}},or="1",dr="ctt_l_a",lr="ctt_l_r",cr="ctt_u_ginv";Object(Hs.b)(er.b)(nr=Reflect.metadata("design:type",Function)(nr=Reflect.metadata("design:paramtypes",[])(nr=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.currentTab=void 0,this.data=new Map,this._Logger=void 0,this.name=er.a,this.key=er.a,this.data.set(or,rr),this.currentTab=""}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_updateState(e,t=or,s=!0){this.data.set(t,e),s&&Object(Kt.g)(this.name,t)}_getState(e=or){return this.data.get(e)}_getAccessTime(){try{return JSON.parse(S.default.getInstance().getItemForCurrentUser(dr))}catch(e){return this.Logger.zsymb(18,"GezFbm","[_getAccessTime], error: "+JSON.stringify(e)),null}}_setAccessTime(e){S.default.getInstance().setItemForCurrentUser(dr,JSON.stringify(e))}_setLastRequestFriendTime(e,t,s){let i=[];try{i=JSON.parse(S.default.getInstance().getItemForCurrentUser(lr))||[]}catch(n){this.Logger.zsymb(18,"1557Pu","[_setLastRequestFriendTime], error: "+JSON.stringify(n))}let a=[];switch(e){case"NEW":i.find((e=>(null==e?void 0:e.userId)===s))?(a=i.filter((e=>e.userId!==s)),a=[{ts:t,userId:s},...i]):a=[{ts:t,userId:s},...i];break;case"REMOVE":a=i.filter((e=>e.userId!==s))}S.default.getInstance().setItemForCurrentUser(lr,JSON.stringify(a))}_setLastReceivedGroupInvitationTime(e,t,s){let i=[];try{const e=S.default.getInstance().getItemForCurrentUser(cr);i=e&&JSON.parse(e)||[]}catch(n){this.Logger.zsymb(18,"T-JTLr","[_setListReceivedGroupInvitationTime], error: "+JSON.stringify(n))}let a=[];switch(e){case"NEW":i.some((e=>(null==e?void 0:e.groupId)==s))&&(a=i.filter((e=>e.groupId!=s))),a=[{ts:t,groupId:s},...i];break;case"REMOVE":a=i.filter((e=>(null==e?void 0:e.groupId)!==s))}S.default.getInstance().setItemForCurrentUser(cr,JSON.stringify(a))}_getLastRequestAddFriendTime(){let e;try{e=JSON.parse(S.default.getInstance().getItemForCurrentUser(lr))}catch(t){this.Logger.zsymb(18,"610jzf","[_getLastRequestAddFriendTime], error: "+JSON.stringify(t))}return e?e[0]:null}_getLastReceivedGroupInvitationTime(){let e;try{const t=S.default.getInstance().getItemForCurrentUser(cr);e=t?JSON.parse(t):null}catch(t){this.Logger.zsymb(18,"-D-4ol","[_getLastReceivedGroupInvitationTime], error: "+JSON.stringify(t))}return e?e[0]:null}_onChangeView(e){switch(i.ModuleContainer.resolve($s.SidebarController).updateSelectedId(null),e){case tr.f.FRIEND_LIST:Object(Lt.f)({type:Os.SideBarActions.SELECT_FRIEND_LIST,payload:{userId:"999"}});break;case tr.f.GROUP_LIST:Object(Lt.f)({type:Os.SideBarActions.SELECT_GROUP_CENTER,payload:{userId:"999"}});break;case tr.f.FRIEND_REQUEST:Object(Lt.f)({type:Os.SideBarActions.SELECT_FRIEND_CENTER,payload:{userId:"999"}}),this._clearUnreadOnOpenView();break;case tr.f.GROUP_INVITATION:Object(Lt.f)({type:Os.SideBarActions.SELECT_GROUP_INVITATION_CENTER,payload:{userId:"999"}}),this._clearUnreadOnOpenView()}}_onUpdateUnreadRequest(e,t){const s=this._getState();if(!s)return;let i=s.unread;switch(t){case"FRIEND":s.currentView!==tr.f.FRIEND_REQUEST&&(i.newFriendRequests.push(e),i.isUnread=!0);break;case"GROUP":i.newGroupRequests.push(e);break;case"GROUP_INV":ms.default.group_privacy.invitation_box.enable&&s.currentView!==tr.f.GROUP_INVITATION&&(i.newGroupInvitations.add(e),i.isUnread=!0)}this._updateState(Object(f.a)(Object(f.a)({},s),{},{unread:i}),or,!0)}_clearUnreadOnOpenView(){const e=this._getState();if(!e)return;let t=e.unread;if(e.currentView===tr.f.GROUP_INVITATION){t.newGroupInvitations.size>0&&(t.isUnread=!1),t.newGroupInvitations.clear();const e=this._getLastReceivedGroupInvitationTime();e&&S.default.getInstance().setItemForCurrentUser(cr,JSON.stringify([e]))}else t.newFriendRequests.length+t.newGroupRequests.length>0&&(t.isUnread=!1),t.newFriendRequests=[],t.newGroupRequests=[];this._updateState(Object(f.a)(Object(f.a)({},e),{},{unread:t}),or,!0)}_clearGroupInvitationUnreadItem(e){const t=this._getState();if(!t)return;let s=t.unread;s.newGroupInvitations.delete(e);0===s.newGroupInvitations.size+s.newFriendRequests.length+s.newGroupRequests.length&&(s.isUnread=!1),this._updateState(Object(f.a)(Object(f.a)({},t),{},{unread:s}),or,!0)}_clearFriendRequestUnreadItem(){const e=this._getState();if(!e)return;let t=e.unread;t.newFriendRequests=[],t.newGroupRequests=[],0===t.newGroupInvitations.size&&(t.isUnread=!1),this._updateState(Object(f.a)(Object(f.a)({},e),{},{unread:t}),or,!0)}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this._getState(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetTabData(){this.currentTab="",sr.resetNewFriendList(),i.ModuleContainer.resolve(er.b).resetData(),i.ModuleContainer.resolve(er.f).resetData(),i.ModuleContainer.resolve(er.e).resetData(),i.ModuleContainer.resolve(er.k).resetData(),i.ModuleContainer.resolve(er.i).resetData(),i.ModuleContainer.resolve(er.n).resetData()}resetData(){const e=this._getState();e&&this._updateState(Object(f.a)(Object(f.a)({},e),{},{currentView:tr.f.FRIEND_LIST}))}changeView(e){const t=this._getState();t&&this._updateState(Object(f.a)(Object(f.a)({},t),{},{currentView:e}),or,!0),this.currentTab=e,this._onChangeView(e)}onClickContabTabEntry(){if(document.getElementById("ContactTabV2")){const e=this._getState(),t=(null==e?void 0:e.currentView)||rr.currentView;this._onChangeView(t)}}onContactTab(e){this._setAccessTime(e),this._clearUnreadOnOpenView()}getDefaultView(){if(this.currentTab)return this.currentTab;const e=this._getAccessTime(),t=this._getLastRequestAddFriendTime(),s=this._getLastReceivedGroupInvitationTime();if(!t)return ms.default.group_privacy.invitation_box.enable&&s&&s.ts>=bs.default.getTimeNow()-ms.default.group_privacy.invitation_box.max_auto_focus_time?this.currentTab=tr.f.GROUP_INVITATION:this.currentTab=tr.f.FRIEND_LIST,this.currentTab;const i=!ms.default.contactTabV2.enable_rule_last_view_friend_req||e&&t.ts<e,a=t.ts<bs.default.getTimeNow()-864e5;return ms.default.group_privacy.invitation_box.enable&&s&&s.ts>t.ts&&s.ts>=bs.default.getTimeNow()-ms.default.group_privacy.invitation_box.max_auto_focus_time?(this.currentTab=tr.f.GROUP_INVITATION,this.currentTab):(this.currentTab=a&&i?tr.f.FRIEND_LIST:tr.f.FRIEND_REQUEST,this.currentTab)}onUpdateRequestTracking(e,t,s,i){switch("NEW"===t?this._onUpdateUnreadRequest(i,e):"REMOVE"===t&&(ms.default.group_privacy.invitation_box.enable&&"GROUP_INV"===e&&i?this._clearGroupInvitationUnreadItem(i):this._clearFriendRequestUnreadItem()),e){case"FRIEND":this._setLastRequestFriendTime(t,s||0,i);break;case"GROUP":default:break;case"GROUP_INV":ms.default.group_privacy.invitation_box.enable&&this._setLastReceivedGroupInvitationTime(t,s||0,i)}}onInitUnreadRequest(){const e=this._getState();let t=(null==e?void 0:e.unread)||rr.unread;const s=(null==e?void 0:e.currentView)||rr.currentView,i=this._getAccessTime(),a=this._getLastRequestAddFriendTime(),n=this._getLastReceivedGroupInvitationTime();a&&i&&(i<a.ts&&t.newFriendRequests.push(a.userId),ms.default.group_privacy.invitation_box.enable&&i<n.ts&&t.newGroupInvitations.add(n.groupId),t.isUnread=t.newFriendRequests.length>0||t.newGroupInvitations.size>0,this._updateState({currentView:s,unread:t},or,!0))}})||nr)||nr);var hr=s("iq5K");const ur=(e,t)=>{const s=Is.default.simpleStripVietnamese(t).split(" "),i=Is.default.simpleStripVietnamese(e).split(" ");return(()=>{const e=[];for(const t of s){let s=!1;for(let a=0;a<i.length;++a)if(i[a].startsWith(t)&&!e.includes(a)){e.push(a),s=!0;break}if(!s)return!1}return!0})()},gr=e=>new Promise(((t,s)=>{if(!e)return t(e);setTimeout((()=>{t(e)}),e)}));var mr;Object(Hs.b)(er.f)(mr=Object(i.injectable)()(mr=function(e,t){return i.ModuleContainer.inject(er.e)(e,void 0,0)}(mr=function(e,t){return i.ModuleContainer.inject($s.LabelDataManager)(e,void 0,1)}(mr=Reflect.metadata("design:type",Function)(mr=Reflect.metadata("design:paramtypes",[void 0===er.e?Object:er.e,void 0===$s.LabelDataManager?Object:$s.LabelDataManager])(mr=class{constructor(e,t){this.friendInfoManager=e,this.labelDataManager=t,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listFriend=void 0,this.initListFriend=void 0,this.currentPage=void 0,this.didSort=void 0,this.eventBusInstance=void 0,this._Logger=void 0,this.name=er.d,this.key=er.d,this.listState=hr.d,this.listFriend=[],this.initListFriend=[],this.currentPage=1,this.didSort=!1,this.eventBusInstance=null,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(Kt.i)(this.name,"all")}_signalRenderItem(){Object(Kt.g)(this.name,"all")}_signalRenderBoth(){Object(Kt.g)(this.name,"all"),Object(Kt.i)(this.name,"all")}_onRemoveFriend(e){this.listFriend.includes(e.userId)&&(this.listFriend.splice(this.listFriend.indexOf(e.userId),1),this.initListFriend.splice(this.initListFriend.indexOf(e.userId),1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth())}_onAddFriend(e){this.listFriend.includes(e.userId)||(this.listFriend.unshift(e.userId),this.initListFriend.unshift(e.userId),sr.addNewFriendUid(e.userId),this._signalRenderList())}_getItemInfo(e){return this.friendInfoManager.getItem({key:e,version:1,extraData:null},null)||this.friendInfoManager.loadInfoNotRender({userId:e})}_onBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onUnBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onEditAlias(e){this.friendInfoManager.onLoadInfo({userId:e.userId}),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!this.isDidSort(),!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth()}_onUpdateTagConv(e,t="add"){let s=!1;e.convIds.forEach((i=>{if(this.friendInfoManager.onLoadInfo({userId:i}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listFriend.findIndex((e=>e===i));"remove"===t&&-1!==e?(this.listFriend.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listFriend.push(i),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1,!1),this.listState.totalRecord=this.listFriend.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.friendInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}addComponentListeners(){zt.default.subscribeEventFriend(R.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),zt.default.subscribeEventFriend(R.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),zt.default.subscribeEventFriend(R.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),zt.default.subscribeEventFriend(R.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance=Cs.default.on(Os.FetchActions.UPDATE_NAME,this._onEditAlias.bind(this)),this.labelDataManager.addEventListener($s.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener($s.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener($s.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){zt.default.unsubscribeEventFriend(R.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),zt.default.unsubscribeEventFriend(R.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),zt.default.unsubscribeEventFriend(R.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),zt.default.unsubscribeEventFriend(R.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance&&this.eventBusInstance.remove(),this.labelDataManager.removeEventListener($s.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener($s.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener($s.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}async onLoadList(e){try{const t=await sr.getFriendList(e);this.listFriend=t,this.initListFriend=t,this.listState.totalRecord=t.length,this.listFriend=this._handleFilter(hr.g.searching.searchText,hr.g.searching.sorter,hr.g.searching.filter,!0,!1),this.initListFriend=this._handleFilter(hr.g.searching.searchText,hr.g.searching.sorter,hr.g.searching.filter,!0,!0),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}catch(t){this.Logger.zsymb(18,"hb_hdn","[FriendListController] -> [onLoadList], error: "+JSON.stringify(t))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListFriend];return[...this.initListFriend].filter((t=>{const s=this._getItemInfo(t);return ur((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterAll(e){return e}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!Zs.a.isThreadHidden(e)))}onSortAlpha(e,t){if(e===hr.p.DEFAULT)return t;return t.sort(((t,s)=>{const i=this._getItemInfo(t),a=this._getItemInfo(s);return((t,s)=>{const i=/^[a-zA-Z]/,a=i.test(Is.default.simpleStripVietnamese(t)),n=i.test(Is.default.simpleStripVietnamese(s));switch(e){case hr.p.ALPHA_INCREASE:return!a&&n?1:a&&!n?-1:t.localeCompare(s);case hr.p.ALPHA_DECREASE:return!a&&n?-1:a&&!n?1:s.localeCompare(t);default:return 0}})((null==i?void 0:i.displayName.toLowerCase())||(null==i?void 0:i.zaloName.toLowerCase())||"",(null==a?void 0:a.displayName.toLowerCase())||(null==a?void 0:a.zaloName.toLowerCase())||"")}))}onMovingNewFriend(e){let t=[],s=[];for(let i=e.length-1;i>=0;i--){const a=this._getItemInfo(e[i]);null!=a&&a.isNewFriend?t.unshift(null==a?void 0:a.userId):s.unshift(null==a?void 0:a.userId)}return[...t,...s]}_handleFilter(e,t,s,i,a){var n;let r=[];return r=this.onFilterByName(e),r=this.onFilterByLabel(null==s||null===(n=s.label)||void 0===n?void 0:n.convs,r),r=this.onFilterAll(r),r=this.onSortAlpha(t,r),r=this.onFilterHidden(a,e,r),i&&(r=this.onMovingNewFriend(r)),r}_checkDidSort(e){return e!==hr.p.ALPHA_INCREASE?this.didSort=!0:this.didSort=!1,this.didSort}isDidSort(){return this.didSort}_updateInitListFriendWithoutDockNewFriends(){this.initListFriend=this._handleFilter(hr.g.searching.searchText,hr.g.searching.sorter,hr.g.searching.filter,!1,!0),this.listState.totalRecord=this.listFriend.length}onFilter(e,t,s){const i=this._checkDidSort(t);i&&this._updateInitListFriendWithoutDockNewFriends(),this.listFriend=this._handleFilter(e,t,s,!i,!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}getList(e,t){return this.listFriend}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listFriend=[],this.initListFriend=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:hr.p.ALPHA_INCREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1,this.didSort=!1}})||mr)||mr)||mr)||mr)||mr);var pr;Object(Hs.b)(er.e)(pr=Reflect.metadata("design:type",Function)(pr=Reflect.metadata("design:paramtypes",[])(pr=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=er.c,this.key=er.c}init(e){throw new Error("Method not implemented.")}onLoadInfo(e){const t=sr.getFriendInfo(e);t&&(this.data.set(e.userId,t),Object(Kt.g)(this.name,e.userId))}loadInfoNotRender(e){const t=sr.getFriendInfo(e);return t?(this.data.set(e.userId,t),t):null}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||pr)||pr);var fr;Object(Hs.b)(er.k)(fr=Object(i.injectable)()(fr=function(e,t){return i.ModuleContainer.inject(er.i)(e,void 0,0)}(fr=function(e,t){return i.ModuleContainer.inject(xs.i)(e,void 0,1)}(fr=function(e,t){return i.ModuleContainer.inject($s.LabelDataManager)(e,void 0,2)}(fr=Reflect.metadata("design:type",Function)(fr=Reflect.metadata("design:paramtypes",[void 0===er.i?Object:er.i,void 0===xs.i?Object:xs.i,void 0===$s.LabelDataManager?Object:$s.LabelDataManager])(fr=class{constructor(e,t,s){this.groupInfoManager=e,this.previewDataManager=t,this.labelDataManager=s,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listGroup=void 0,this.initListGroup=void 0,this.currentPage=void 0,this._Logger=void 0,this.name=er.h,this.key=er.h,this.listState=hr.e,this.listGroup=[],this.initListGroup=[],this.currentPage=1,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(Kt.i)(this.name,"all")}_signalRenderItem(){Object(Kt.g)(this.name,"all")}_signalRenderBoth(){Object(Kt.g)(this.name,"all"),Object(Kt.i)(this.name,"all")}_getItemInfo(e){return this.groupInfoManager.getItem({key:e,version:1,extraData:null},null)||this.groupInfoManager.loadInfoNotRender({userId:e})}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}async onLoadList(){try{const e=await ir.getGroupList(),t=e.map((e=>e.userId));this.listGroup=t,this.initListGroup=t,this.listState.totalRecord=t.length,this.groupInfoManager.setMultiGroupInfo(e),this.listGroup=this._handleFilter(hr.h.searching.searchText,hr.h.searching.sorter,hr.h.searching.filter,!1),this.initListGroup=this._handleFilter(hr.h.searching.searchText,hr.h.searching.sorter,hr.h.searching.filter,!0),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}catch(e){this.Logger.zsymb(18,"rczn_n","[GroupListController] -> [onLoadList], error: "+JSON.stringify(e))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListGroup];return this.initListGroup.filter((t=>{const s=this._getItemInfo(t);return ur((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterMyAdminGroup(e,t){if(!e)return t;return t.filter((t=>{const s=this._getItemInfo(t);return(null==s?void 0:s.creatorId)===e}))}onFilterAll(e){return e}onSortAlpha(e,t){return e===hr.p.DEFAULT||e===hr.p.ACTION_INCREASE||e===hr.p.ACTION_DECREASE?t:t.sort(((t,s)=>{const i=this._getItemInfo(t),a=this._getItemInfo(s),n=(null==i?void 0:i.displayName.toLowerCase())||"",r=(null==a?void 0:a.displayName.toLowerCase())||"";switch(e){case hr.p.ALPHA_INCREASE:return n.localeCompare(r);case hr.p.ALPHA_DECREASE:return r.localeCompare(n);default:return 0}}))}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!Zs.a.isThreadHidden(e)))}onSortActionTime(e,t){return e===hr.p.DEFAULT||e===hr.p.ALPHA_INCREASE||e===hr.p.ALPHA_DECREASE?t:t.sort(((t,s)=>{var i,a;const n=(null===(i=this.previewDataManager.getPreviewByIDSync(t))||void 0===i?void 0:i.messageTime)||0,r=(null===(a=this.previewDataManager.getPreviewByIDSync(s))||void 0===a?void 0:a.messageTime)||0;switch(e){case hr.p.ACTION_DECREASE:if(r&&n){if(r>n)return 1;if(r<n)return-1}return r&&!n?1:!r&&n?-1:0;case hr.p.ACTION_INCREASE:if(r&&n){if(r<n)return 1;if(r>n)return-1}return!r&&n?1:r&&!n?-1:0;default:return 0}}))}_handleFilter(e,t,s,i){var a;let n=[];return n=this.onFilterByName(e),n=this.onFilterByLabel(null==s||null===(a=s.label)||void 0===a?void 0:a.convs,n),n=this.onFilterMyAdminGroup((null==s?void 0:s.admin)||"",n),n=this.onFilterAll(n),n=this.onSortAlpha(t,n),n=this.onSortActionTime(t,n),n=this.onFilterHidden(i,e,n),n}onFilter(e,t,s){this.listGroup=this._handleFilter(e,t,s,!1),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}_onUpdateTagConv(e,t="add"){let s=!1;e.convIds.forEach((i=>{if(this.groupInfoManager.onLoadInfo({userId:i}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listGroup.findIndex((e=>e===i));"remove"===t&&-1!==e?(this.listGroup.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listGroup.push(i),this.listGroup=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1),this.listState.totalRecord=this.listGroup.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.groupInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}_onLeaveGroup(e){for(let t=0;t<e.length;t++){if(!this.listGroup.includes(e[t]))return;this.listGroup.splice(this.listGroup.indexOf(e[t]),1),this.initListGroup.splice(this.listGroup.indexOf(e[t]),1),this.listState.totalRecord=this.listGroup.length}this._signalRenderBoth()}addComponentListeners(){oi.default.subscribeEventGroup(R.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.addEventListener($s.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener($s.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener($s.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){oi.default.unsubscribeEventGroup(R.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.removeEventListener($s.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener($s.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener($s.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}getList(e,t){return this.listGroup}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listGroup=[],this.initListGroup=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:hr.p.ACTION_DECREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1}})||fr)||fr)||fr)||fr)||fr)||fr);var vr;Object(Hs.b)(er.i)(vr=Reflect.metadata("design:type",Function)(vr=Reflect.metadata("design:paramtypes",[])(vr=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=er.g,this.key=er.g}init(e){throw new Error("Method not implemented.")}async onLoadInfo(e){const t=ir.getGroupInfoSync(e);t&&(this.data.set(e.userId,t),Object(Kt.g)(this.name,e.userId))}loadInfoNotRender(e){const t=ir.getGroupInfoSync(e);return t?(this.data.set(e.userId,t),t):null}loadMultiGroupInfo(e){for(const t of e)this.loadInfoNotRender({userId:t})}setMultiGroupInfo(e){for(const t of e)this.data.set(t.userId,t)}openGroupMemberPopup(e){const t=this.data.get(e);Gt.ModalManagerV2.openModal({windowId:"1",name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:{group_member:t}})}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||vr)||vr);let br=function(e){return e[e.RECOMMEND=1]="RECOMMEND",e[e.RECEIVE=2]="RECEIVE",e}({});const yr=500,Ir=500;var _r;Object(Hs.b)(er.n)(_r=function(e,t){return i.ModuleContainer.inject(er.b)(e,void 0,0)}(_r=Reflect.metadata("design:type",Function)(_r=Reflect.metadata("design:paramtypes",[void 0===er.b?Object:er.b])(_r=class extends je.b{constructor(e){super(),this.contactTabController=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this._Logger=void 0,this.name=er.l,this.key=er.l,this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}}),this.addPublicListeners()}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderItem(){Object(Kt.g)(this.name,"all")}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.data.get(e.key)}_updateLoadingState(e,t){const{listFriendReceived:s=[],listFriendSuggest:i=[],listFriendSent:a=[]}=this.data.get("all")||{};let{isLoadingRecommendFriendList:n,isLoadingRequestedFriendList:r}=this.data.get("all")||{};if("RecommendFriendList"===e)switch(t){case"ON":n||0!==s.length||0!==i.length||(n=!0);break;case"OFF":n&&(n=!1)}if("RequestedFriendList"===e)switch(t){case"ON":r||0!==a.length||(r=!0);break;case"OFF":r&&(r=!1)}this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{isLoadingRecommendFriendList:n,isLoadingRequestedFriendList:r})),this._signalRenderItem()}async onLoadRequestedFriendList(){const e=Date.now();try{this._updateLoadingState("RequestedFriendList","ON");const t=await ar.getRequestedFriendList();Date.now()-e<yr&&await gr(Ir),this._updateLoadingState("RequestedFriendList","OFF");const s=Object.keys(t).map((e=>t[e])).sort(((e,t)=>{var s,i;const a=null===(s=e.fReqInfo)||void 0===s?void 0:s.time,n=null===(i=t.fReqInfo)||void 0===i?void 0:i.time;return n>a?1:n<a?-1:0})),{listFriendReceived:i=[],listFriendSuggest:a=[],mapRelatedGroup:n={}}=this.data.get("all")||{};this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:i,listFriendSent:s,listFriendSuggest:a,mapRelatedGroup:n})),this._signalRenderItem()}catch(t){Date.now()-e<yr&&await gr(Ir),this._updateLoadingState("RequestedFriendList","OFF"),this.Logger.zsymb(18,"76_2M3","[InvitationController] -> [onLoadRequestedFriendList], error: "+JSON.stringify(t))}}async onLoadRecommendFriendList(){const e=Date.now();try{this._updateLoadingState("RecommendFriendList","ON");const t=await ar.getRecommendFriendList();if(Date.now()-e<yr&&await gr(Ir),this._updateLoadingState("RecommendFriendList","OFF"),Array.isArray(t)&&t.length>0){const e=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===br.RECEIVE})),s=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===br.RECOMMEND})),{listFriendSent:i=[],mapRelatedGroup:a={}}=this.data.get("all")||{};this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:i,listFriendSuggest:s,mapRelatedGroup:a})),s.length>0&&this.dispatchEvent(new tr.e(tr.d.LoadRelatedGroups,"",{})),this._signalRenderItem()}}catch(t){Date.now()-e<yr&&await gr(Ir),this._updateLoadingState("RecommendFriendList","OFF"),this.Logger.zsymb(18,"y8i0Cf","[InvitationController] -> [onLoadRecommendFriendList], error: "+JSON.stringify(t))}}_handleSortFriendSuggestList(e,t){return 0===e.length?e:e.sort(((e,s)=>{var i,a,n,r,o,d;const l=t[null===(i=e.dataInfo)||void 0===i?void 0:i.userId]&&t[null===(a=e.dataInfo)||void 0===a?void 0:a.userId].length,c=(null===(n=e.dataInfo)||void 0===n?void 0:n.displayName)||"",h=t[null===(r=s.dataInfo)||void 0===r?void 0:r.userId]&&t[null===(o=s.dataInfo)||void 0===o?void 0:o.userId].length,u=(null===(d=s.dataInfo)||void 0===d?void 0:d.displayName)||"";return l&&h?l===h?c.localeCompare(u):h>l?1:-1:l&&!h?-1:!l&&h?1:l||h?0:c.localeCompare(u)}))}async onLoadRelatedGroupList(){try{const{listFriendSuggest:e=[]}=this.data.get("all")||{},t=e.map((e=>{var t;return null==e||null===(t=e.dataInfo)||void 0===t?void 0:t.userId})),s=await ar.getRelatedGroup(t),{listFriendReceived:i=[],listFriendSent:a=[]}=this.data.get("all")||{},n=this._handleSortFriendSuggestList(e,s.groupRelateds);this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:i,listFriendSent:a,listFriendSuggest:n,mapRelatedGroup:s.groupRelateds||{}})),this._signalRenderItem()}catch(e){this.Logger.zsymb(18,"8CfzPz","[InvitationController] -> [onLoadRelatedGroupList], error: "+JSON.stringify(e))}}handleFriendProfileChange(e){const{listFriendReceived:t=[],listFriendSuggest:s=[],listFriendSent:i=[]}=this.data.get("all")||{};Object.keys(e).forEach((e=>{const a=zt.default.getDName(e),n=t.findIndex((t=>t.dataInfo.userId===e));-1!==n&&(t[n].displayName=a);const r=s.findIndex((t=>t.dataInfo.userId===e));-1!==r&&(s[r].displayName=a);const o=i.findIndex((t=>t.userId===e));-1!==o&&(i[o].displayName=a)})),this._signalRenderItem()}handlePublicFriendEvents(e){const t=e.payload;if(t)for(let i=0;i<t.length;i++){var s;const a=t[i].ts,n="add"===t[i].act&&t[i].data||(null===(s=t[i].data)||void 0===s?void 0:s.fromUid),r=n===e.userId;if(a&&n&&!r&&"fr"===t[i].act_type)switch(t[i].act){case"req_v2":this.contactTabController.onUpdateRequestTracking("FRIEND","NEW",a,n);break;case"undo_req":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",a,n),this.dispatchEvent(new tr.e(tr.d.UndoAddFriendEvent,"",n));break;case"add":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",a,n),this.dispatchEvent(new tr.e(tr.d.AcceptAddFriendEvent,"",n));break;case"reject":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",a,n),this.dispatchEvent(new tr.e(tr.d.RejectAddFriendEvent,"",n))}}}handlePublicAddFriendEvent(e){let t=[];const s=e.payload;if(s){for(let e=0;e<s.length;e++){let i={};i.userId=s[e].userId,i.zaloName=s[e].zaloName,i.avatar=s[e].avatar,i.displayName=s[e].displayName,i.recommInfo={message:s[e].friendRequestMsg,source:s[e].friendRequestSource},i.recommTime=s[e].friendRequestFetchTime,i.recommType=s[e].friendRequestType,t.push({dataInfo:i,recommItemType:1})}this.dispatchEvent(new tr.e(tr.d.ReceiveAddFriendEvent,"",t))}}addPublicListeners(){this.addEventListener(tr.d.PublicInvitationEvents,this.handlePublicFriendEvents.bind(this)),this.addEventListener(tr.d.PublicReceiveAddFriendEvent,this.handlePublicAddFriendEvent.bind(this)),zt.default.connectSignalChangeDNameAndAvatar(this.handleFriendProfileChange.bind(this))}addComponentListeners(){}removeComponentListeners(){}_addFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:a={}}=this.data.get("all")||{},n=e.concat(t);this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:n,listFriendSent:s,listFriendSuggest:i,mapRelatedGroup:a})),this._signalRenderItem()}_removeFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:a={}}=this.data.get("all")||{},n=t.filter((t=>{var s;return(null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:n,listFriendSent:s,listFriendSuggest:i,mapRelatedGroup:a})),this._signalRenderItem()}onUpdateFriendRequests(e,t){switch(t){case"ADD":this._addFriendReceived(e);break;case"REMOVE":this._removeFriendReceived(e)}}async onRejectFriend(e){return new Promise(((t,s)=>{ar.rejectAddFriend(e).then((()=>{this._removeFriendReceived(e),t(e)})).catch((e=>{this.Logger.zsymb(18,"7PZ5Op","[InvitationController] -> [onRejectFriend], error: "+JSON.stringify(e)),s(e)}))}))}async onAddFriend(e){return new Promise(((t,s)=>{ar.acceptAddFriend(e).then(t).catch((e=>{this.Logger.zsymb(18,"OS5Cax","[InvitationController] -> [onAddFriend], error: "+JSON.stringify(e)),s(e)}))}))}removeFriendSent(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:a={}}=this.data.get("all")||{},n=s.filter((t=>(null==t?void 0:t.userId)!==e));this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:n,listFriendSuggest:i,mapRelatedGroup:a})),this._signalRenderItem()}onRemoveFriendSent(e){ar.makeUndoSentRequestFriend(e).then((()=>{this.removeFriendSent(e.userId)})).catch((e=>{this.Logger.zsymb(18,"R7NM-j","[InvitationController] -> [onRemoveFriendSent], error: "+JSON.stringify(e)),e&&301==e.error_code?Ht.a.createError($t.default.str("STR_UNDO_REQUEST_ERROR_301")):e&&"ERR_NO_NETWORK"===e.code?Ht.a.createError($t.default.str("STR_CHECK_NET")):Ht.a.createError($t.default.str("STR_UNDO_REQUEST_ERROR_UNKNOWN"))}))}_removeFriendSuggest(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:i=[],mapRelatedGroup:a={}}=this.data.get("all")||{},n=i.filter((t=>{var s;return(null==t||null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:s,listFriendSuggest:n,mapRelatedGroup:a})),this._signalRenderItem()}onAddFriendSuggest(e){Kn.a.doAddFriend(e.uid,e.src,null,e.windowId).then((()=>{this._removeFriendSuggest(e.uid),this.onLoadRequestedFriendList()})).catch((e=>{this.Logger.zsymb(18,"zK71dB","[InvitationController] -> [onAddFriendSuggest], error: "+JSON.stringify(e))}))}onRemoveFriendSuggest(e){ar.removeSuggestFriend(e).then((()=>{this._removeFriendSuggest(e.uid)})).catch((e=>{this.Logger.zsymb(18,"q1sCZF","[InvitationController] -> [onRemoveFriendSuggest], error: "+JSON.stringify(e))}))}openMutualGroupPopup(e){Gt.ModalManagerV2.openModal({windowId:"1",name:R.ModalIdentitiesDefine.FRIEND_PROFILE,params:{userId:e,showMutualGroups:!0}})}resetData(){this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}})}makeExpiredReceivedFriendRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:i={}}=this.data.get("all")||{};if(0!==e.length){for(let t=0;t<e.length;t++)e[t].dataInfo.recommTime=-1,e[t].dataInfo.recommInfo.source=-1,e[t].dataInfo.recommInfo.message="";this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:i})),this._signalRenderItem()}}makeExpiredSentFriendSentRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:i={}}=this.data.get("all")||{};if(0!==t.length){for(let e=0;e<t.length;e++)t[e].fReqInfo.time=-1,t[e].fReqInfo.src=-1,t[e].fReqInfo.message="";this.data.set("all",Object(f.a)(Object(f.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:i})),this._signalRenderItem()}}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||_r)||_r)||_r);var Cr,Or=s("2x/M"),Sr=s("FhUL"),Er=s("zU/x"),Mr=s("dhU0"),Tr=s("2e02"),wr=s("HnA5");function Rr(e){return{avatar:e.avatar,displayName:zt.default.getDName(e.id)||e.dName||e.zaloName,userId:e.id,zaloName:e.zaloName,type:e.type}}Object(Hs.b)(Tr.b)(Cr=Reflect.metadata("design:type",Function)(Cr=Reflect.metadata("design:paramtypes",[])(Cr=class extends je.b{constructor(){super(),this.name=void 0,this.key=void 0,this._Logger=void 0,this.data=void 0,this.metadata=void 0,this.timer=void 0,this.isOpeningInvitationBox=void 0,this.handleNetworkStatusChange=e=>{e===Un.a.CONNECTED&&0===this.data.size&&this.getReceivedInvitations({page:0})},this.name=Tr.a,this.key="groupId",this.data=new Map,this.metadata={total:0,page:0,hasMore:!0,loading:!0},this.timer={instance:new ds.b,intervalId:null},this.isOpeningInvitationBox=!1}init(){throw new Error("Method not implemented.")}getList(){return Array.from(this.data.keys())}getItem(e){const t=this.data.get(e.key);return t||this.Logger.zsymb(5,"QXKrhM",["try to get item not exist in cache {}","NCiEjF"],e.key),t}onGetItemFailure(e){this.Logger.zsymb(18,"-0JLmm","Get group invitation item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(18,"VisRTQ","Get group invitation list failed",e)}signalUpdateList(){Object(Kt.i)(this.name,"all")}signalUpdateItem(e){Object(Kt.g)(this.name,e)}signalUpdateListMeta(){this.dispatchEvent(new tr.c(tr.a.UpdateUIListMetadata,this.metadata))}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}async getCreatorInfos(e){const t=await zt.default.getProfileFriendForGroup(Object.fromEntries(e.map((e=>[e.creatorId||e,0]))));return new Map(e.map((e=>[e.groupId,t[e.creatorId]])))}async getCreatorInfoForGroup(e){return zt.default.getProfileFriendForGroup({[e]:0})}startTimer(){this.stopTimer(),this.timer.intervalId=window.setInterval((()=>this.timer.instance.publish(bs.default.getTimeNow())),tr.b.COUNT_INTERVAL)}stopTimer(){null!==this.timer.intervalId&&window.clearInterval(this.timer.intervalId),this.timer.intervalId=null}getTimer(){return this.timer.instance}isValidInvitation(e){var t;return!!(null!==(t=e.groupInfo)&&void 0!==t&&t.groupId&&e.grCreatorInfo&&e.inviterInfo)&&e.expiredTs-bs.default.getTimeNow()>0}convertToGroupInvitation(e){const t=R.GROUPID_PREFIX+e.groupInfo.groupId,s=function(e){return{avatar:e.avt,creatorId:e.creatorId,displayName:e.name,name:e.name,setting:e.setting,adminIds:e.adminIds,totalMember:e.totalMember,userId:e.groupId,type:e.type,topMember:e.currentMems.map(Rr),isGroup:!0}}(e.groupInfo),i=Rr(e.inviterInfo),a=Rr(e.grCreatorInfo);return Object(f.a)(Object(f.a)({},e),{},{groupId:t,groupInfo:s,inviterInfo:i,grCreatorInfo:a})}async loadServerReceivedInvitations(){var e;const{invitations:t,hasMore:s,total:i}=await ys.default.getGroupInvitationList(this.metadata.page,ms.default.group_privacy.invitation_box.paging_limit,ms.default.group_privacy.invitation_box.mcount_item,null===(e=this.metadata)||void 0===e?void 0:e.lastGroupId);this.metadata=Object(f.a)(Object(f.a)({},this.metadata),{},{hasMore:s,total:i});const a=await this.getCreatorInfos(t.map((e=>e.groupInfo))),n=[];for(let r=0;r<t.length;r++){const e=t[r];if(e.grCreatorInfo||(e.grCreatorInfo=a.get(e.groupInfo.groupId)),this.isValidInvitation(e)){const s=R.GROUPID_PREFIX+e.groupInfo.groupId,i=this.convertToGroupInvitation(e);n.push(i),r===t.length-1&&(this.metadata.lastGroupId=s)}}return n}onInvitationListUIAppear(){this.isOpeningInvitationBox=!0,this.startTimer(),this.getReceivedInvitations({page:0}).catch((e=>{this.Logger.zsymb(18,"n2fv6b","Init load invitation failed",e)})).finally((()=>{this.metadata.loading&&(this.metadata.loading=!1,setTimeout((()=>{this.signalUpdateListMeta()}),300))})),$e.p.listenEvent($e.j,this.handleNetworkStatusChange)}onInvitationListUIDisappear(){this.stopTimer(),this.metadata={total:0,page:0,hasMore:!0,loading:!0},this.data.clear(),$e.p.removeListenEvent($e.j,this.handleNetworkStatusChange),this.isOpeningInvitationBox=!1}getUIListMeta(){return this.metadata}async getReceivedInvitations(e={}){const{page:t=0}=e;if(!this.metadata.hasMore)return[];this.metadata.page=t,this.data=new Map(this.data);const s=await this.loadServerReceivedInvitations();return s.forEach((e=>{this.data.set(e.groupId,e)})),this.signalUpdateListMeta(),this.signalUpdateList(),s}async loadMoreReceivedInvitations(){const e=ms.default.group_privacy.invitation_box.paging_limit,t=Math.trunc(this.data.size/e);return this.getReceivedInvitations({page:t})}handleNewInvitation(e,t){this.metadata.total+=1,this.data=new Map([[e,t],...Array.from(this.data.entries())]),this.signalUpdateListMeta(),this.signalUpdateList()}async acceptInvitation(e,t){try{if(e.type===Sr.a.PENDING_REVIEW)throw{error_code:Er.a.WAITING_APPROVE};const t=Is.default.getRawGroupId(e.groupId);await ys.default.joinGroupFromInvitation(t),this.Logger.zsymb(2,"ehIbH_","Join group success",e.groupId),i.ModuleContainer.resolve(ni.b).openConversation(e.groupId,ni.c.fromGroupInvitation()),this.deleteInvitationsFromCache([e.groupId])}catch(s){this.Logger.zsymb(18,"bOkXoW","Join group failed",e.groupId,s),this.handleJoinInvitationError(e,null==s?void 0:s.error_code,t)}}async rejectInvitation(e,t={}){try{if(e.type===Sr.a.PENDING_REVIEW)throw{error_code:Er.a.WAITING_APPROVE};const s=Is.default.getRawGroupId(e.groupId);await ys.default.deleteGroupInvitation([{grid:s}],t.blockGroup),this.Logger.zsymb(2,"RhCPZ-","Reject group invitation success",e.groupId,t),t.blockInviter&&zt.default.blockFriend(e.inviterInfo.userId,R.SET_BLOCK),this.deleteInvitationsFromCache([e.groupId]),Ht.a.createInfo($t.default.str(wr.a.get("STR_GROUP_INVITATION_DELETED",e.groupInfo)))}catch(s){this.Logger.zsymb(18,"IGG8q6","Reject group invitation failed",e.groupId,s),Ht.a.createError($t.default.str("STR_ERROR_OCCUR"))}}async deleteInvitations(e){const t=e.map((e=>({grid:Is.default.getRawGroupId(e.groupId)})));try{await ys.default.deleteGroupInvitation(t,!1),this.Logger.zsymb(2,"y_YPYX","Delete group invitations success",t),this.deleteInvitationsFromCache(e.map((e=>e.groupId)))}catch(s){this.Logger.zsymb(18,"qugPfj","Delete group invitations failed",t,s),Ht.a.createError($t.default.str("STR_ERROR_OCCUR"))}}deleteInvitationsFromCache(e){let t=0;for(const s of e)this.data.has(s)&&(this.data.delete(s),t+=1);0!==t&&(this.metadata.total=Math.max(this.metadata.total-t,0),this.signalUpdateListMeta(),this.signalUpdateList(),this.metadata.hasMore&&this.data.size<ms.default.group_privacy.invitation_box.paging_limit&&this.loadMoreReceivedInvitations())}getInvitationSync(e){return this.data.get(e)||null}getInvitation(e){return new Promise((t=>{const s=Is.default.getRawGroupId(e);ys.default.getGroupInvitationInfo(s).then((e=>{e.grCreatorInfo?t(this.convertToGroupInvitation(e)):this.getCreatorInfoForGroup(e.groupInfo.creatorId).then((s=>{e.grCreatorInfo=s,t(this.convertToGroupInvitation(e))})).catch((()=>t(null)))})).catch((s=>{this.Logger.zsymb(18,"M4gjSQ","Get invitation info failed",e,s),t(null)}))}))}updateInvitationFromCache(e){const{groupId:t}=e;this.data.has(t)&&this.data.set(t,e)}updateInvitationStatus(e,t){const s=this.data.get(e);if(s){const i=Object(f.a)(Object(f.a)({},s),{},{type:t});this.updateInvitationFromCache(i),this.data.set(e,i),this.signalUpdateItem(e)}}onReceivedInvitationEvents(e,t){const s=t.groupId;if(!s)return;const a=R.GROUPID_PREFIX+s;switch(this.Logger.zsymb(0,"Dh1zGp","Received new event",e,a),e){case Or.b.NEW_INVITATION:this.isOpeningInvitationBox&&this.getInvitation(a).then((e=>{e&&this.handleNewInvitation(a,e)})).catch((e=>{this.Logger.zsymb(18,"TClEQU","Load new invitation item by event failed",a,e)})),i.ModuleContainer.resolve(Mr.b).onUpdateRequestTracking("GROUP_INV","NEW",bs.default.getTimeNow(),a);break;case Or.b.UPDATE_INVITATION:const e=this.data.get(a);"number"==typeof t.invitationType&&(null==e?void 0:e.type)!==t.invitationType&&this.updateInvitationStatus(a,t.invitationType);break;case Or.b.REMOVE_INVITATION:this.deleteInvitationsFromCache([a]),i.ModuleContainer.resolve(Mr.b).onUpdateRequestTracking("GROUP_INV","REMOVE",bs.default.getTimeNow(),a)}}handleJoinInvitationError(e,t,s){switch(t){case Er.a.WAITING_APPROVE:this.updateInvitationStatus(e.groupId,Sr.a.PENDING_REVIEW),Ht.a.createInfo($t.default.str(wr.a.get("STR_GROUP_INVITATION_JOIN_ERR_240",e.groupInfo)));break;case Er.a.EXCEED_MAX_GROUP:case Er.a.CANNOT_CHANGE:case Er.a.BANNED:case Er.a.NOT_PERMITTED:Ht.a.createInfo($t.default.str(wr.a.get("STR_GROUP_INVITATION_JOIN_ERR_"+t,e.groupInfo)));break;case Er.a.NOT_EXIST:case Er.a.ALREADY_MEMBER:case Er.a.EXPIRED:this.deleteInvitationsFromCache([e.groupId]),Ht.a.createInfo($t.default.str(wr.a.get("STR_GROUP_INVITATION_JOIN_ERR_"+t,e.groupInfo)));break;case R.GROUP_MEMBER_ERROR.REACHED_LIMIT_MEMBER_GROUP:case R.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE:ms.default.group_privacy.community.enable_upgrade?i.ModuleContainer.resolve(Ra.e).onReceivedCommunityError({errorCode:t,windowId:s,groupId:e.groupId}):Ht.a.createError($t.default.str("STR_ERROR_OCCUR"));break;default:Ht.a.createError($t.default.str("STR_ERROR_OCCUR"))}}})||Cr)||Cr);var Lr,Fr=s("hLuk");Object(ke.i)()(Lr=class{onStart(){Fr.default.init()}});var Dr,Ar=s("xdZB"),jr=s("hWjG"),Pr=s("mE25"),Nr=s("mlG1");let Ur=Object(i.singleton)()(Dr=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(Dr=Reflect.metadata("design:type",Function)(Dr=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Dr=class extends jr.a{constructor(e){super("Core","Message","",e)}countMessages(e,t={from:[],to:[Pr.b,Pr.a]}){return this._dbCollection.count({from:[e,...t.from],to:[e,...t.to]},{index:"userId_sendDttm_msgId",partition:e})}async getLastMessage(e){var t;let s=null;const i={from:[e,"",""],to:[e,Pr.b,Pr.a],excludeFrom:!0,excludeTo:!0},a={index:"userId_sendDttm_msgId",direction:Fe.CursorDirection.PREV,limit:1,predicate:t=>{!s&&t&&(s=t);const i=Nr.d.reduceDeleteMsgs(e,[t],!0);return di.b.isValidPreviewMessage(t)&&0!==i.length},partition:e},n=await this._dbCollection.getAll(i,a);return null!==(t=null==n?void 0:n[0])&&void 0!==t?t:s}async getPrevMessageIds(e,t,s){const i={from:[e,"",""],to:[e,(await this.get(t)).sendDttm,t],excludeFrom:!0,excludeTo:!0},a={index:"userId_sendDttm_msgId",direction:Fe.CursorDirection.PREV,limit:s,predicate:e=>!isNaN(Number(e.msgId)),partition:e};return(await this._dbCollection.getAll(i,a)).map((e=>e.msgId))}})||Dr)||Dr)||Dr)||Dr;const kr=(e,t)=>{if(e)throw t};var Br=s("Uzj0"),Gr=s("S8fy");class xr extends Error{constructor(e,t,s,i=[]){super(s),this.code=void 0,this.qosParams=void 0,this.name=e,this.qosParams=[s,...i],this.code=t}setStack(e){const t=`${this.name}: ${this.message}`;this.stack=t+(e||"")}toObject(){return{name:this.name,code:this.code,message:this.message,stack:this.stack,qosParams:this.qosParams}}static createFromObject(e){const{name:t="ZError Unknown",code:s=-1,message:i,stack:a,qosParams:n=[]}=e,r=new xr(t,s,i,n);return r.setStack(a),r}}let zr=function(e){return e[e.FETCH_ERROR=0]="FETCH_ERROR",e[e.FETCH_CONV_HAS_MSG_OFFLINE_ERROR=1]="FETCH_CONV_HAS_MSG_OFFLINE_ERROR",e[e.INVALID_RESPONSE=2]="INVALID_RESPONSE",e[e.INSERT_MULTI_ERROR=3]="INSERT_MULTI_ERROR",e}({});class Vr extends xr{constructor(e,t,s,i){super("FetchMessageCloudError",zr.FETCH_ERROR,`ConvId: ${e}. RequestMsgId: ${t}. OriginError: ${JSON.stringify(s)}`,i)}}class Hr extends xr{constructor(e,t){super("InvalidResponse",zr.INVALID_RESPONSE,e,t)}}class $r extends xr{constructor(e,t){super("FetchConvHasMessageOfflineError",zr.FETCH_CONV_HAS_MSG_OFFLINE_ERROR,e,t)}}var Wr;let qr=Object(Gr.g)()(Wr=class{async fetchMessagesCloud(e,t,s,i,a){const n=Qa.a.newReq(),[r,o]=await Br.b.catchPromise(Nn.default.getCM(e,Number(t),0,s,n,a,i));kr(r,new Vr(e,t,r));const[d,l]=await Br.b.catchPromise(Object(jn.a)(o));kr(d,new Hr(`ConvId: ${e}. RequestMsgId: ${t}. Cannot handle response: ${JSON.stringify(d)}`));const[c,h]=Br.b.catchFn((()=>JSON.parse(l)));return kr(c,new Hr(`ConvId: ${e}. RequestMsgId: ${t}. Cannot parse json object`)),h}async fetchListConvHasMessageOffline(e,t,s){const[i,a]=await Br.b.catchPromise(Nn.default.getConvHasMessageOffline(e,t,s));kr(i,new $r(JSON.stringify(i)));const[n,r]=await Br.b.catchPromise(Object(jn.a)(a));return kr(n,new Hr(`Cannot handle response: ${JSON.stringify(n)}`)),r}})||Wr;var Kr,Zr=s("/Bne");class Qr{constructor(e,t){this.convId=e,this.messageCloudRaw=t,this.userId=void 0,this.idTo=void 0,this.uidFrom=void 0,this.uin=void 0,this.cliMsgId=void 0,this.msgId=void 0,this.content=void 0,this.dName=void 0,this.msgType=void 0,this.status=void 0,this.ts=void 0,this.isFromCloud=void 0,this.msgKey=void 0,this.isGroup=void 0,this.mentions=void 0,this.quote=void 0,this.st=void 0,this.at=void 0,this.ttl=void 0,this.src=void 0,this.cmd=void 0,this.footer=void 0,this.footerv2=void 0,this.previewThumb=void 0,this.property=void 0,this.propertyExt=void 0,this.specialMsgType=void 0,this.topOut=void 0,this.topOutImprTimeOut=void 0,this.topOutTimeOut=void 0,this.userId=t.userId,this.idTo=t.idTo,this.uidFrom=t.uidFrom,this.uin=t.uin,this.cliMsgId=t.cliMsgId,this.msgId=t.msgId,this.content=t.content,this.dName=t.dName,this.msgType=t.msgType,this.status=t.status,this.ts=t.ts,this.mentions=t.mentions,this.quote=t.quote,this.st=t.st,this.at=t.at,this.ttl=t.ttl,this.cmd=t.cmd,this.footer=t.footer,this.footerv2=t.footerv2,this.previewThumb=t.previewThumb,this.property=t.property,this.propertyExt=t.propertyExt,this.specialMsgType=t.specialMsgType,this.topOut=t.topOut,this.topOutImprTimeOut=t.topOutImprTimeOut,this.topOutTimeOut=t.topOutTimeOut,this.isFromCloud=!0,this.msgKey=e,this.isGroup=t.isGroup}toEntity(){return Zr.a.transformMessageFromServer(this.messageCloudRaw,this.convId)}setSrc(e){this.src=e}}let Jr=Object(Gr.g)()(Kr=Reflect.metadata("design:type",Function)(Kr=Reflect.metadata("design:paramtypes",[])(Kr=class{constructor(){this.apiAdapter=void 0,this.apiAdapter=i.ModuleContainer.resolveToken(qr)}async fetchMessagesCloud(e,t,s,i){var a;const[n,r]=await Br.b.catchPromise(this.apiAdapter.fetchMessagesCloud(e,t,s,i));kr(n,n);const o=(null!==(a=r.groupMsgs)&&void 0!==a?a:[]).map((t=>new Qr(e,t)));return Object(f.a)(Object(f.a)({},r),{},{groupMsgs:o})}async fetchConvHasMessageOffline(e,t,s){return await this.apiAdapter.fetchListConvHasMessageOffline(e,t,s)}})||Kr)||Kr)||Kr;var Yr;Object(i.singleton)(ba)(Yr=Reflect.metadata("design:type",Function)(Yr=Reflect.metadata("design:paramtypes",[])(Yr=class{constructor(){this.messageRespository=void 0,this.messageService=void 0,this.messageRespository=i.ModuleContainer.resolveToken(Ur),this.messageService=i.ModuleContainer.resolveToken(Jr)}async fetchMessagesCloud(e,t,s,i){return await this.messageService.fetchMessagesCloud(e,t,s,i)}async getLastMessage(e){return await this.messageRespository.getLastMessage(e)}async getPrevMessageIds(e,t,s){return this.messageRespository.getPrevMessageIds(e,t,s)}async countMessages(e,t){return await this.messageRespository.countMessages(e,t)}async getGroupHasMessageOffline(e,t,s){const i=await this.messageService.fetchConvHasMessageOffline(e,t,s);return{listConvIds:i.grids.map((e=>R.GROUPID_PREFIX+e)),evict:!!i.evict}}reloadMessage(e){var t;null===(t=Ja.b.messageCache)||void 0===t||t.deleteConversation(e);Ar.a.getExistConvIds().includes(e)&&Si.a.getLastMessagesForConversation(e,{})}})||Yr)||Yr);var Xr=s("ZCU6");const eo=Object(i.define)("cloud-segment-controller");var to=s("npvr"),so=s("t3h5");let io=function(e){return e[e.UPDATE_FAILED=0]="UPDATE_FAILED",e}({});class ao extends xr{constructor(e,t){super("UpdateSegmentError",io.UPDATE_FAILED,e,t)}}var no;let ro=Object(i.singleton)()(no=class{async get(e){return so.a.getSegmentByConvId(e)}async update(e,t){const[s]=await Br.b.catchPromise(to.b.updateSegmentDB(e,t));return kr(s,new ao(JSON.stringify(s))),so.a.setSegmentCacheByConvId(e,t),t}})||no;var oo;Object(i.injectable)()(oo=Object(i.singleton)(eo)(oo=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(oo=Reflect.metadata("design:type",Function)(oo=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(oo=class{constructor(e){this.logger=void 0,this.repository=void 0,this.repository=i.ModuleContainer.resolveToken(ro),this.logger=e.createZLogger(ci.ZLoggerNametags.messageCloudSegment,[ci.ZLoggerNametags.controller])}async get(e){return this.repository.get(e)}async update(e){return await this.repository.update(e.conversationId,e)}async updateSegment(e,t){const s=Xr.a.addOrUpdateSegmentCache(e.conversationId,t.messages,e,{requestMsgId:t.requestMsgId,lastMsgId:t.lastMsgId,checkLoadTop:t.checkLoadTop,hasMore:t.hasMore}).segmentObj;return await this.repository.update(e.conversationId,s)}})||oo)||oo)||oo)||oo);const lo=Object(i.define)("cloud-segment-repository"),co=Object(i.define)("cloud-segment-manager"),ho=Object(i.define)("cloud-message-manager");class uo{constructor(e){this.entity=e}get conversationId(){return this.entity.conversationId}get cloudFirstSmsLocalId(){return this.entity.cloudFirstSmsLocalId}get cloudSegmentCheck(){return this.entity.cloudSegmentCheck}get hasMore(){return this.entity.hasMore}get lastCloudVerifiedDttm(){return this.entity.lastCloudVerifiedDttm}get lastDeletedMsgID(){return this.entity.lastDeletedMsgID}get lastGetMaxRecentTs(){return this.entity.lastGetMaxRecentTs}get maxCloudMsgId(){return this.entity.maxCloudMsgId}}var go;let mo=i.ModuleContainer.injectable()(go=Reflect.metadata("design:type",Function)(go=Reflect.metadata("design:paramtypes",[])(go=class{constructor(){}get(e){return so.a.getSegmentByConvId(e)}})||go)||go)||go;var po,fo=s("D8Ji");let vo=i.ModuleContainer.injectable()(po=function(e,t){return i.ModuleContainer.inject(lo)(e,void 0,0)}(po=Reflect.metadata("design:type",Function)(po=Reflect.metadata("design:paramtypes",[void 0===lo?Object:lo])(po=class{constructor(e){this.segmentRepository=e}get(e){return this.segmentRepository.get(e).then((e=>e&&new uo(e))).catch((e=>{}))}async createOrExtendSegment(e,t){const s=await this.segmentRepository.get(e);s.cloudSegmentCheck=fo.a.mergeNewSegment(t.verifiedRange,null==s?void 0:s.cloudSegmentCheck),s.maxCloudMsgId=Math.max(s.maxCloudMsgId||0,t.verifiedRange[1]),so.a.setSegmentCacheByConvId(e,s),await to.b.updateSegmentDB(e,s)}})||po)||po)||po)||po;class bo extends Error{constructor(e,t,s){super(s),this.code=e,this.data=t}}var yo;let Io=i.ModuleContainer.injectable()(yo=function(e,t){return i.ModuleContainer.inject(_.a)(e,void 0,0)}(yo=Reflect.metadata("design:type",Function)(yo=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a])(yo=class{constructor(e){this.config=e}get settings(){return this.config.get("cloud.auto_download")}async crawlMissingMessage(e,t={nRetry:0,count:50}){let s=e.conversationId;s.startsWith("g")&&(s=s.slice(1));const i=`${s}_${e.requestMsgId}`;let a=this.settings.limit.minMsgDttm,n=this.settings.limit.maxMsgFirstSegment;const r={groupId:s,fromMsgId:e.requestMsgId,globalMsgIds:e.globalMsgIds,curTotalMsgs:e.curTotalMsgs,tsJoinGroup:e.tsJoinGroup,minMsgTs:a,maxTotalSyncMsg:n};return await Nn.default.crawlMissingMessage(i,r,{requestTimeout:this.settings.fetching.timeout,count:t.count,nRetry:t.nRetry,usePostApi:!0}).then((e=>Object(jn.a)(e))).then((e=>{try{return JSON.parse(e)}catch(t){throw{error_code:-1,error_message:"invalid response"}}})).then((e=>{const t=e[s];if(t.error>0)throw{error_code:t.error,error_message:"inner error"};return t})).catch((e=>{if("number"==typeof e.error_code){let s=e.data;try{s=JSON.parse(s)}catch(t){}throw new bo(e.error_code,s,e.error_message)}throw e}))}})||yo)||yo)||yo)||yo;var _o,Co=s("yEZN"),Oo=s("EO3V"),So=s("enz2");const Eo={totalMsgCount:0,fetchedMsgCount:0,serverMsgCount:0,newMsgCount:0,phaseDone:!1,isFilteredByTimeJoin:!1,done:!0,tsJoinGroup:"0"};let Mo=i.ModuleContainer.injectable()(_o=function(e,t){return i.ModuleContainer.injectToken(Io)(e,void 0,0)}(_o=function(e,t){return i.ModuleContainer.inject(co)(e,void 0,1)}(_o=function(e,t){return i.ModuleContainer.inject(Co.c)(e,void 0,2)}(_o=function(e,t){return i.ModuleContainer.inject(Co.b)(e,void 0,3)}(_o=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,4)}(_o=Reflect.metadata("design:type",Function)(_o=Reflect.metadata("design:paramtypes",[void 0===Io?Object:Io,void 0===co?Object:co,void 0===Co.c?Object:Co.c,void 0===Co.b?Object:Co.b,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(_o=class{constructor(e,t,s,i,a){this.api=e,this.segmentManager=t,this.messageRepository=s,this.messageManager=i,this.logger=void 0,this.logger=a.createZLogger("cld-msg",["manager"])}async crawlMissingMessage(e,t,s){const i=await this.segmentManager.get(e),a=(()=>{var e;let t=s.minMsgId&&Number.parseInt(s.minMsgId);return i&&i.lastDeletedMsgID&&(t=t?Math.max(i.lastDeletedMsgID,t):i.lastDeletedMsgID),null===(e=t)||void 0===e?void 0:e.toString()})(),n="0"!==t,r=n?s.count+1:s.count;if(n&&t<=a)return Eo;const o=await this.messageManager.findPrevMessagesFromMsgId(e,{maxMsgId:"0"!==t?t:void 0,minMsgId:a,limit:r}).then((e=>e.map((e=>e.entity)))),d=new Set;o.forEach((e=>{try{const t=Number.parseInt(e.msgId);Number.isInteger(t)&&d.add(t.toString())}catch(t){}}));const l=Array.from(d.values()),c=await this.api.crawlMissingMessage({conversationId:e,requestMsgId:t,globalMsgIds:l,curTotalMsgs:s.curTotalMsgs,tsJoinGroup:s.tsJoinGroup},{nRetry:s.nRetry,count:s.count});if(0===c.groupMsgs.length&&"0"===c.maxMsgId)return Eo;let h=Oo.a.checkDupMessageFromCloud(e,c.groupMsgs);a&&a>"0"&&(h=h.filter((e=>e.msgId>a)));const u=[...o,...h];if(0===u.length)return Eo;const g=Number.parseInt(c.lastMsgId,10);let m=Number.parseInt(t);const p=Oo.a.findMinMaxGroupMsg(u,m,g,null==i?void 0:i.lastDeletedMsgID),{groupMsgsToView:v,groupMsgsAddDb:b,groupMsgsSearch:y}=So.a.findMsgsAddDb(t,h,[],o,Object(f.a)({apiType:2,conversationId:e},p));b.forEach((e=>{e.src=R.MSG_SRC.AUTO_LOADER})),await this.messageRepository.saveMessages(e,b),await So.a.updateSearchV3(y,e);const I=!!c.isFilteredByPhase,_=c.maxMsgId;p.minMsgId&&p.maxMsgId&&await this.segmentManager.createOrExtendSegment(e,{verifiedRange:[p.minMsgId,p.maxMsgId]});let C="0";Number.isInteger(Number.parseInt(c.tsJoinGroup))?C=c.tsJoinGroup:this.logger.zsymb(18,"YrxC5N",(()=>["api res invalid ts join group",{tsJoinGroup:c.tsJoinGroup}]));const O=!!c.isFilteredByTimeJoin,S={totalMsgCount:v.length,fetchedMsgCount:b.length,serverMsgCount:h.length,newMsgCount:b.length,phaseDone:I,isFilteredByTimeJoin:O,done:!(I||!O&&c.hasMore),minMsgId:a,maxMsgId:_.toString(),tsJoinGroup:C};return this.logger.zsymb(3,"v9wPCX",["[auto-dl-msg] crawl result","TdtFkG"],S),S}})||_o)||_o)||_o)||_o)||_o)||_o)||_o)||_o;i.ModuleContainer.registerSingleton(lo,mo),i.ModuleContainer.registerSingleton(co,vo),i.ModuleContainer.registerSingleton(ho,Mo);var To,wo=s("rfrl"),Ro=s("KP/S"),Lo=s("wiGx"),Fo=s("ttnr");const Do={screen:Lo.a.Hidden,error:Ro.b.NO_ERROR,progress:0,totalProgress:0,numOfSyncedConv:0,popupVisible:!1,startSyncTime:0,closing:!1,syncingConversation:null};Object(Hs.b)(Lo.b)(To=Reflect.metadata("design:type",Function)(To=Reflect.metadata("design:paramtypes",[])(To=class{constructor(){this.progressRecording=void 0,this.downloadBackupTime=void 0,this.state=Object(f.a)({},Do),this.name="sync-message-ui",this.key="window_id",this.progressRecording=new Map,this.initialRecordProgress(),this.downloadBackupTime=null}initialRecordProgress(){this.progressRecording.set(Lo.a.DownloadingBackup,0),this.progressRecording.set(Lo.a.DecryptingBackup,0),this.progressRecording.set(Lo.a.SyncInProgress,0)}recordProgress(e){const t=this.state.screen,s=e=>e>100?100:e;switch(t){case Lo.a.DownloadingBackup:this.progressRecording.set(t,s(e));break;case Lo.a.DecryptingBackup:this.progressRecording.set(Lo.a.DownloadingBackup,100),this.progressRecording.set(t,s(e));break;case Lo.a.SyncInProgress:this.progressRecording.set(Lo.a.DownloadingBackup,100),this.progressRecording.set(Lo.a.DecryptingBackup,100),this.progressRecording.set(t,s(e))}}calculateTotalProgressTransfer(){const e=this.state.screen,t=this.progressRecording.get(Lo.a.DownloadingBackup)||0,s=this.progressRecording.get(Lo.a.DecryptingBackup)||0,i=this.progressRecording.get(Lo.a.SyncInProgress)||0,a=(e,t)=>{let s=0;switch(t){case Lo.a.DownloadingBackup:s=Fo.a.getPercentDownload();break;case Lo.a.DecryptingBackup:s=Fo.a.getPercentDecrypt();break;case Lo.a.SyncInProgress:s=Fo.a.getPercentRestore()}return Math.round(e*s/100)};switch(e){case Lo.a.DownloadingBackup:return a(t,e);case Lo.a.DecryptingBackup:return a(t,Lo.a.DownloadingBackup)+a(s,e);case Lo.a.SyncInProgress:return a(t,Lo.a.DownloadingBackup)+a(s,Lo.a.DecryptingBackup)+a(i,e);default:return 0}}showPopup(){this.setState((e=>{e.popupVisible=!0}))}setSyncingConversation(e){this.setState((t=>{t.syncingConversation=e}))}hidePopup(){this.setState((e=>{e.popupVisible=!1}))}hideAllUI(){this.setState((e=>{e.screen=Lo.a.Hidden,e.closing=!1}))}showError(e){this.setState((t=>{t.error=e,t.screen=Lo.a.Error,t.syncingConversation=null}))}showSuggestNewSync(e){this.setState((t=>{t.screen=Lo.a.SuggestNewSync,t.popupVisible=e}))}showSuggestResume(){this.setState((e=>{e.screen=Lo.a.SuggestResume,e.popupVisible=!1}))}showSyncGuide(){this.setState((e=>{e.screen=Lo.a.SyncGuide,e.popupVisible=!0}))}showWaitForBackup(){this.setState((e=>{e.screen=Lo.a.WaitForBackup}))}showMobileIdleInBackup(){this.setState((e=>{e.screen=Lo.a.MobileIdleInBackup}))}showDownloadingBackup(){this.setDownloadBackupTime(performance.now()),this.setState((e=>{e.screen=Lo.a.DownloadingBackup,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showDecryptingBackup(){this.setState((e=>{e.screen=Lo.a.DecryptingBackup,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showInProgress(){this.setState((e=>{e.screen=Lo.a.SyncInProgress,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showCloseNotice(){this.setState((e=>{e.closing=!0}))}showSuccessMessage(){this.setState((e=>{e.screen=Lo.a.SyncSuccess,e.syncingConversation=null}))}showWaitForNetwork(){this.setState((e=>{e.screen=Lo.a.WaitForNetwork}))}setProgress(e){this.recordProgress(e),this.setState((t=>{t.progress=e,t.totalProgress=this.calculateTotalProgressTransfer()}))}setNumOfSyncedConv(e){this.setState((t=>{t.numOfSyncedConv=e}))}resetStartSyncTime(){this.setState((e=>{e.startSyncTime=Date.now()}))}clearError(){this.setState((e=>{e.error=Ro.b.NO_ERROR}))}getStartSyncTime(){return this.state.startSyncTime}getCurrentError(){return this.state.error}getCurrentScreen(){return this.state.screen}getPopupVisible(){return this.state.popupVisible}setDownloadBackupTime(e){this.downloadBackupTime=e}getDownloadBackupTime(){return this.downloadBackupTime}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(wo.a)(this.state,e);this.state!==t&&(this.state=t,Object(Kt.g)(this.name,"current"))}})||To)||To);var Ao,jo=s("cPHW");let Po=i.ModuleContainer.injectable()(Ao=class{start(){}isEnable(){return!1}canSync(){return Ro.a.DISABLED}delayedSuggestSync(){throw new Error("Method not implemented.")}suggestSync(){throw new Error("Method not implemented.")}suggestResume(){throw new Error("Method not implemented.")}sync(){throw new Error("Method not implemented.")}resume(){throw new Error("Method not implemented.")}cancel(){throw new Error("Method not implemented.")}confirmCancelSyncInSuggestingPopup(){throw new Error("Method not implemented.")}cleanupInMobileBusyBackup(){throw new Error("Method not implemented.")}closeCancelSyncInSuggestingPopup(){throw new Error("Method not implemented.")}pause(){throw new Error("Method not implemented.")}retry(){throw new Error("Method not implemented.")}rejectSuggest(){throw new Error("Method not implemented.")}showSuggestPopup(){throw new Error("Method not implemented.")}closeSuggestPopup(){throw new Error("Method not implemented.")}setRequestBackupTimeout(){throw new Error("Method not implemented.")}setMobileTransferConfirmTimeout(){throw new Error("Method not implemented.")}clearRequestBackupTimeout(){throw new Error("Method not implemented.")}setAutoCloseSuccessTimeout(){throw new Error("Method not implemented.")}clearAutoCloseSuccessTimeout(){throw new Error("Method not implemented.")}resendRequest(){throw new Error("Method not implemented.")}reset(){throw new Error("Method not implemented.")}hideProgress(){throw new Error("Method not implemented.")}handleCtrlEvents(){}handleTransferAfterLoginCtrlEvents(){}makeMobileIdle(){throw new Error("Method not implemented.")}makeMobileActive(){throw new Error("Method not implemented.")}set tempKeySource(e){throw new Error("Method not implemented.")}get tempKeySource(){throw new Error("Method not implemented.")}})||Ao;i.ModuleContainer.registerSingleton(jo.a,Po);var No=s("Erqw");const{setTimeoutUnlimited:Uo,clearTimeoutUnlimited:ko}=function(e={}){var t,s;const i=null!==(t=e.step)&&void 0!==t&&t?1e4:36e5,a=null!==(s=e.registry)&&void 0!==s?s:{};return{setTimeoutUnlimited:(e,t,...s)=>{const n=(e=>{var t;const s=e.step,i=e.registry;let a=null!==(t=e.timeout)&&void 0!==t?t:0;const n=e.callback,r=e.args,o=performance.now()+a;let d;function l(){let e=Math.min(o-performance.now(),s);return performance.now()>o?i[d]=setTimeout(n,0,r):i[d]=setTimeout(l,e),i[d]}return function(){let e=Math.min(o-performance.now(),s);return d=setTimeout(l,e),i[d]=d,d}()})({step:i,registry:a,callback:e,timeout:t,args:s});return n},clearTimeoutUnlimited:e=>{(e=>{const t=e.id,s=e.registry;clearTimeout(s[t]),delete s[t]})({id:e,registry:a})}}}({registry:{}});var Bo,Go=s("1p+n"),xo=s("UYft"),zo=s("AULX");Object(i.injectable)()(Bo=Object(i.singleton)(zo.a)(Bo=Object(ke.g)()(Bo=Object(ke.e)()(Bo=function(e,t){return Object(i.inject)(re)(e,void 0,0)}(Bo=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(Bo=Reflect.metadata("design:type",Function)(Bo=Reflect.metadata("design:paramtypes",[void 0===ne?Object:ne,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Bo=class{constructor(e,t){this.kvCacheFactory=e,this.loggerFactory=t,this._logger=void 0,this._authEvent=void 0,this.__cache=void 0,this._renewRegistry={},this.updateEmitter=new Go.a,this._logger=this.loggerFactory.createZLogger("feat",["group-link"])}onAuthenticated(e){this._authEvent=e}_makeCache(){if(!this._authEvent)throw new Error("Not authenticated");return this.kvCacheFactory.createCache(`group-link-v3-${this._authEvent.getSession().userId}`,{maxSize:50})}get _cache(){return this.__cache||(this.__cache=this._makeCache()),this.__cache}_scheduleRenew(e,t){if(this._clearRenewSchedule(e),!t.enabled)return this;if(!ms.default.groupLink.enableScheduleRenew)return this._logger.debug(["_scheduleRenew skipped, enableScheduleRenew:",ms.default.groupLink.enableScheduleRenew]),this;let s=t.expirationDate-bs.default.getTimeNow(),i=Uo((()=>{this._clearRenewSchedule(e),this._emitGroupLinkUpdated(e,!0)}),s);return this._renewRegistry[e]=()=>{ko(i),delete this._renewRegistry[e]},this}_clearRenewSchedule(e){var t,s;return null===(t=(s=this._renewRegistry)[e])||void 0===t||t.call(s),this}onDispose(){this._authEvent=void 0,this.__cache=void 0}async _getFromCache(e){if(!ms.default.groupLink.enableCache)return void this._logger.debug(["cache skipped, enableCache:",ms.default.groupLink.enableCache]);e=Vo(e);let t=await this._cache.getItem(e);if(t){if(function(e){if(!e)return!1;let{data:t,meta:s}=e;if(!t)return!1;if(!s)return!1;if(No.a.isOverflowAtTime(s.ts))return!1;const i=bs.default.getTimeNow();if(s.ts+ms.default.groupLink.maxCacheDuration<i)return!1;if(t.enabled&&t.expirationDate<i)return!1;return!0}(t))return t.data;await this._cache.removeItem(e)}}async _fetchAndPutToCache(e,t){const s=bs.default.getTimeNow(),i=await t(),a={enabled:i.enabled,expirationDate:i.expiration_date,link:i.link};let n={ts:s};return await this._cache.setItem(e,{data:a,meta:n}),a}async _deleteCache(e){await this._cache.removeItem(e)}async getGroupLinkDetail(e,t=!1){this._logger.zsymb(12,"wxEpo3",["getting",e]);let s=Vo(e),i=await this._getFromCache(s);if(i&&!t)return this._logger.zsymb(12,"9VYuYH",["cache hit",s]),this._scheduleRenew(s,i),i;this._logger.zsymb(12,"yU9jQc",["fetching",s]);let a=Is.default.getRawGroupId(s);let n=await this._fetchAndPutToCache(s,(()=>ys.default.getGroupLinkDetail(a))).catch(xo.a.catch((e=>this._logger.zsymb(18,"jUDyxM",["get failed",s,e]))));return this._scheduleRenew(s,n),t&&await this._emitGroupLinkUpdated(e),this._logger.zsymb(12,"GIxN5s",["done",s]),n}async renewGroupLink(e){this._logger.zsymb(12,"K96VBV",["renewing",e]);let t=Vo(e),s=Is.default.getRawGroupId(t);let i=await this._fetchAndPutToCache(t,(()=>ys.default.renewGroupLink(s))).catch(xo.a.catch((e=>this._logger.zsymb(18,"RpK7rv",["renew failed",t,e]))));return this._scheduleRenew(t,i),await this._emitGroupLinkUpdated(t),this._logger.zsymb(12,"tGbBra",["renew done",e]),i}async disableGroupLink(e){this._logger.zsymb(12,"zpqQ_S",["disabling",e]);let t=Vo(e),s=Is.default.getRawGroupId(t);await ys.default.disableGroupLink(s).catch(xo.a.catch((e=>this._logger.zsymb(18,"XImMli",["disable failed",t,e])))),await this._emitGroupLinkUpdated(t,!0),this._logger.zsymb(12,"qStQEh",["disable done",e])}async _emitGroupLinkUpdated(e,t=!1){const s=Vo(e);t&&await this._deleteCache(s),this.updateEmitter.emit(s,s),this.updateEmitter.emit("*",s)}async emitGroupLinkUpdated(e){return await this._emitGroupLinkUpdated(e,!0)}})||Bo)||Bo)||Bo)||Bo)||Bo)||Bo)||Bo);function Vo(e){return R.GROUPID_PREFIX+Is.default.getRawGroupId(e)}var Ho,$o=s("TO4U");const Wo={loading:!0};Object(Hs.b)($o.a)(Ho=function(e,t){return Object(i.inject)(zo.a)(e,void 0,0)}(Ho=Reflect.metadata("design:type",Function)(Ho=Reflect.metadata("design:paramtypes",[void 0===zo.a?Object:zo.a])(Ho=class e{constructor(e){this._groupLink=e,this.type=void 0,this.name="group-link-ui",this.key="group-link-ui",this._cache=new ce.default({maxSize:50}),this._handleUpdate=e=>{const t=qo(e);this._cache.delete(t),this._startFetchAndSetToSession(t)},this._groupLink.updateEmitter.on("*",this._handleUpdate)}init(){}getItem(e,t){if(!e.key.startsWith(R.GROUPID_PREFIX))return;const s=qo(e.key);this._startFetchAndSetToSession(s);let i=this._cache.get(s);return i||Wo}static shouldSignal(e,t){var s,i,a,n,r,o;return!e||(null==e||e.error,null==t||t.error,null==t||null===(s=t.data)||void 0===s||s.enabled,null==t||null===(i=t.data)||void 0===i||i.enabled,null!=e&&null!==(a=e.data)&&void 0!==a&&a.enabled&&null!=t&&null!==(n=t.data)&&void 0!==n&&n.enabled&&(null==e||null===(r=e.data)||void 0===r||r.link,null==t||null===(o=t.data)||void 0===o||o.link),!1)}signalIfNeeded(t,s,i){e.shouldSignal(s,i)&&Object(Kt.g)(this.name,t)}_startFetchAndSetToSession(e){const t=this._cache.get(e);setTimeout((()=>{this._groupLink.getGroupLinkDetail(e).then((s=>{const i={loading:!1,data:s};this._cache.set(e,i),this.signalIfNeeded(e,t,i)})).catch((s=>{const i={loading:!1,error:s};this._cache.set(e,i),this.signalIfNeeded(e,t,i)}))}),0)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||Ho)||Ho)||Ho);function qo(e){return R.GROUPID_PREFIX+Is.default.getRawGroupId(e)}var Ko=s("akSd"),Zo=s("xQyS"),Qo=s("fqRP"),Jo=s("L904"),Yo=s("EiAw"),Xo=s("IoRb");let ed;class td{static get instance(){return ed||(ed=new td),ed}get _eventStore(){return this.__eventStore||(this.__eventStore=s("emRR").default),this.__eventStore}constructor(){this.__eventStore=void 0,this._emitConversationDeleted=e=>{let t,s,i=[];if(e.ok?({conversation:t,toUid:s,allItems:i}=e.value):({conversation:t,toUid:s,allItems:i}=e.error),t)return;if(i.length&&i.every((e=>e.ttlType===on.a.Quote)))return;const a={type:Os.FetchActions.DELETE_CONVERSATION,payload:s};this._eventStore.dispatch(a),Bt.a.dispatch(a),Cs.default.send(a.type,a.payload)},this._emitDeletedMsgs=e=>{let t,s;e.ok?({allItems:s,conversation:t}=e.value):({allItems:s,conversation:t}=e.error);const i=s.filter((e=>e.ttlType===on.a.Message)),a=i.map((e=>e.msgId));Object(Yo.a)({msgId:a,conversation:t,messages:i.map((e=>JSON.parse(JSON.stringify(e)))),trackingSource:"ttlPrune"})},this._emitUpdateUnread=(e,t)=>{let s,i=[];e.ok?({toUid:s,allItems:i}=e.value):({toUid:s,allItems:i}=e.error),Ds.a.UnreadDataManager.updateUnreadTTLConversation(s,i,null==t?void 0:t.get(s))},this.emitPerConversation=async(e,t)=>{let s=await Object(Zo.a)(this._emitConversationDeleted,e);s.ok||Object(Xo.a)("_emitConversationDeleted failed",s.error),s=await Object(Zo.a)(this._emitDeletedMsgs,e),s.ok||Object(Xo.a)("_emitDeletedMsgs failed",s.error),s=await Object(Zo.a)(this._emitUpdateUnread,e,t),s.ok||Object(Xo.a)("_emitUpdateUnread failed",s.error)}}}var sd,id=s("LA52"),ad=s("GSaP");const nd=e=>null==e?void 0:e.toUid,rd=e=>null!=e&&e.ok?"success":"error";Object(i.singleton)(id.a)(sd=Reflect.metadata("design:type",Function)(sd=Reflect.metadata("design:paramtypes",[])(sd=class{constructor(){this._pruning=!1,this._task=void 0,this._ttl=i.ModuleContainer.resolve(Qo.a),this._logger=void 0,this.dispose=()=>{},this.prune=async()=>this._pruning?await this._task:(this._pruning=!0,this._task=this._pruneFromDB(),this._pruning=!1,this._task),this._pruneFromDB=async()=>{const e=bs.default.getTimeNow();this._logger.zsymb(0,"LR6c2Y","Pruner execute task",e);const t=await Object(Zo.b)(this._ttl.getExpireItemsBefore,e);if(!t.ok)return this._logger.zsymb(18,"PBE3n2","Pruner getExpireItemsBefore failed",t.error),{ok:!1,error:null};const s=t.ok?t.value:[];return await this._pruneTTLItems(s)},this._pruneByMsgsBatch=[],this.pruneByMsgs=async e=>{const t=Object(Ss.a)(e);this._pruneByMsgsBatch.push(...t),setTimeout((()=>{const e=this._pruneByMsgsBatch;this._pruneByMsgsBatch=[],e.length&&(this._logger.zsymb(15,"MNgzrD",["running a batch {}","B56OZw"],e.length),this._pruneByMsgs(e))}),2e3)},this._pruneByMsgs=async e=>{const t=bs.default.getTimeNow();this._logger.zsymb(15,"e1YHHD",["deriving {}","DUSqhK"],e.length);let s=ad.a.createFromCurrentSession().deriveTTLItems(e);this._logger.zsymb(15,"R5o3s-",["ttlItems count: {}","ammSVP"],s.length),s=s.filter((e=>{const s=+e.expireOn+ms.default.ttl.enable_delete_on_filter_minimum_overtime;return!isNaN(s)&&s<t})),this._logger.zsymb(15,"H-b9Sq",["expired count: {}","iQimsq"],s.length),s=s.filter((e=>!this._hasPruneMsgCache(e))),s.forEach((e=>{this._setPruneMsgCache(e)})),this._logger.zsymb(15,"KkCjDS",["no cache count: {}","MpJvbK"],s.length),s.length?(this._logger.zsymb(3,"DmN6Sv",["pruning {}, {}","SIhRmR"],s.length,s),await this._deleteMsgsAndEmit(s)):this._logger.zsymb(15,"ur0V_6",["no items to prune","BO0eHL"])},this._pruneMsgCache=new ce.default({maxSize:1e4}),this._pruneTTLItems=async e=>{const t=e.map((e=>[e.msgId,e.ttlType]));this._logger.zsymb(3,"7bXaTM",["pruning {} items: {}","6hGQId"],t.length,t),await this._deleteMsgsAndEmit(e);const s=await Object(Zo.b)(this._ttl.deletes,t);return s.ok||this._logger.zsymb(18,"GwTi8_","Pruner deletes ttl failed",s.error),s},this._retryErrorMsgsIfNeeded=e=>{for(const s of e){var t;if(s.ok)continue;const{errorItems:e,toUid:i}=s.error;this._logger.zsymb(0,"QDfCmH","_retryErrorDelete "+i,null==e||null===(t=e[0])||void 0===t?void 0:t.msgId),setTimeout((()=>{Object(Zo.b)(this._deleteMsgsBelongToTTLItems,e)}),5e3)}},this._retryErrorDelete=e=>setTimeout((async()=>{const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(Zo.b)(this._deleteMsgsBelongToTTLItems,e);!s.ok&&this._logger.zsymb(18,"Ak-tE_","Pruner _retryErrorDelete",s.error),s.ok&&this._emitPruneResult(s.value,t)}),5e3),this._emitPruneResult=async(e,t)=>{for(const s of e)await Object(Zo.b)(td.instance.emitPerConversation,s,t)},this._deletePerConversation=async(e,t=[])=>{var s,i,a,n,r,o,d,l,c;const h=await Object(Zo.b)(Ba.b.vanishMessages,e,t);if(!h.ok)return{ok:!1,error:{toUid:e,allItems:[],errorItems:t,successItems:[]}};const u=null===(s=h.value.vanish)||void 0===s?void 0:s[0],g=null===(i=h.value.quote)||void 0===i?void 0:i[0];if(!u&&!g)return{ok:!1,error:{toUid:e,conversation:{},allItems:[],errorItems:t,successItems:[]}};const m=null===(a=h.value.vanish)||void 0===a||null===(n=a[0])||void 0===n||null===(r=n.conv)||void 0===r?void 0:r.conversation;let p=[...null!==(o=null===(d=h.value.vanish)||void 0===d?void 0:d.map((e=>e.res)).flat())&&void 0!==o?o:[],...null!==(l=null===(c=h.value.quote)||void 0===c?void 0:c.flat())&&void 0!==l?l:[]];p=p.filter((e=>e));const{success:f=[],error:v=[]}=Object(Jo.a)(p,rd),b=f.map((e=>e.info)),y=v.map((e=>e.info)),I=[...b,...y];return y.length?{ok:!1,error:{toUid:e,conversation:m,allItems:I,successItems:b,errorItems:y}}:{ok:!0,value:{toUid:e,conversation:m,allItems:I,successItems:b}}},this._deleteMsgsBelongToTTLItems=async e=>{const t=Object(Jo.a)(e,nd),s=Object.keys(t).map((async e=>(Object(Zo.b)(this._sideEffect,e,t[e]),this._deletePerConversation(e,t[e]))));return await Promise.all(s)},this._sideEffect=async(e,t=[])=>setTimeout((async()=>{const s=await Object(Zo.b)(this._cancelSendingPerConversation,e,t);s.ok||this._logger.zsymb(18,"jo0RxB","cancelSendingPerConversation failed",s.error);const i=await Object(Zo.b)(this._syncDeletePerConversation,e,t);i.ok||this._logger.zsymb(18,"d0tjz6","syncDeletePerConversation failed",i.error)}),0),this._cancelSendingPerConversation=async(e,t=[])=>{t.forEach((t=>Object(Zo.b)((()=>{}),e,null==t?void 0:t.cliMsgId)))},this._syncDeletePerConversation=async(e,t=[])=>{if(!ms.default.ttl.enable_sync_delete)return;const s=t=>{+t.msgId&&Object(Ko.e)(e,{cliMsgId:t.cliMsgId,msgId:t.msgId,sendDttm:t.sendDttm,toUid:e,fromUid:t.fromUid})};t.forEach((e=>Object(Zo.b)(s,e)))},this._pruning=!1,this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("utils",["ttl","destructor","pruner"])}_getPruneMsgKey(e){return e?`${e.msgId}|${e.ttlType}`:""}_hasPruneMsgCache(e){return this._pruneMsgCache.has(this._getPruneMsgKey(e))}_setPruneMsgCache(e){this._pruneMsgCache.set(this._getPruneMsgKey(e),void 0)}async _deleteMsgsAndEmit(e){const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(Zo.b)(this._deleteMsgsBelongToTTLItems,e);s.ok||(this._logger.zsymb(18,"ENr2sf","Pruner","deleteMessages failed"),this._retryErrorDelete(e)),s.ok&&this._retryErrorMsgsIfNeeded(s.value),s.ok&&this._emitPruneResult(s.value,t)}})||sd)||sd);function od(e,t){return e.reduce(((e,s,i,a)=>(e[t(s,i,a)?0:1].push(s),e)),[[],[]])}var dd;const ld=R.MessageConstants.MAX_MSG_ID;Object(i.singleton)(Qo.a)(dd=Reflect.metadata("design:type",Function)(dd=Reflect.metadata("design:paramtypes",[])(dd=class{constructor(){this._logger=void 0,this.dispose=()=>{},this.correctTTLItemEntity=e=>{function t(e,t){return null==e?t:e}const s=Object(f.a)({},e);return s.beginTime=t(s.beginTime,0),s.cliMsgId=t(s.cliMsgId,""),s.expireOn=t(s.expireOn,Date.now()),s.fromUid=t(s.fromUid,""),s.mediaType=t(s.mediaType,""),s.msgId=t(s.msgId,""),s.sendDttm=t(s.sendDttm,"")+"",s.serverTime=t(s.serverTime,"")+"",s.toUid=t(s.toUid,""),s.ttl=t(s.ttl,0),s.ttlType=t(s.ttlType,""),s},this._safePut=async e=>{const t=[],s=[],i=ze.default.getInstance();for(const n of e)try{const e=this.correctTTLItemEntity(n);await i.MsgInfo.TTLItem.insert(e,{replace:!0}),t.push(n)}catch(a){s.push([n,a])}return[t,s]},this.putMsgs=async e=>{let t=e.map((e=>ud(e)));const[s,i]=od(t,(e=>e.ok)),a=s.map((e=>e.value));let n=[],r=[];[r,n]=await this._safePut(a);const o=i.map((e=>e.error));return n.lastItem||o.length?{ok:!1,error:{invalidItems:o,errorItems:n}}:{ok:!0,value:r}},this.deletes=e=>ze.default.getInstance().MsgInfo.TTLItem.deleteMulti(e),this.getExpireItemsBefore=async(e,t)=>{const s=t?{from:[t.expireOn,t.toUid,t.msgId,t.ttlType],to:[e,R.MessageConstants.MAX_CONVERSATION_ID,ld],excludeFrom:!1,excludeTo:!0}:{to:[e],excludeTo:!1},i={limit:50,index:"expireOn_toUid_pk"},a=ze.default.getInstance();return await a.MsgInfo.TTLItem.getAll(s,i)},this.getYoungestExpiredItem=async()=>{const e={to:[Number.MAX_VALUE],excludeTo:!0},t=ze.default.getInstance();return(await t.MsgInfo.TTLItem.getAll(e,{limit:1,index:"expireOn_toUid_pk"}))[0]},this.getMappedMsgsByConvIdFromTTLItems=async e=>{const t=Ja.b.messageCache;let s;return t&&(s=await t.getMappedMessagesByConvIdAsync(e)),s},this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("utils",["ttl","destructor","ttl"])}})||dd)||dd);const cd=e=>"number"==typeof e?String(e):e,hd=[on.a.Message,on.a.Quote],ud=(e={})=>{const t=Object(f.a)({},e);return t.cliMsgId=cd(t.cliMsgId),t.cliMsgId?(t.fromUid=cd(t.fromUid),t.fromUid?(t.toUid=cd(t.toUid),t.toUid?(t.msgId=cd(t.msgId),s=t.ttlType,hd.includes(s)?(t.expireOn=+t.expireOn,"number"!=typeof t.expireOn?{ok:!1,error:e}:{ok:!0,value:t}):{ok:!1,error:e}):{ok:!1,error:e}):{ok:!1,error:e}):{ok:!1,error:e};var s};var gd=s("oOjv"),md=s("bB26"),pd=s("lteq");const fd={[Qs.c]:{}};i.ModuleContainer.registerSingleton(gd.b,class{constructor(){this.state=fd,this.animationControllers=new Map,this._manuallyOff=!1,this.name=gd.a,this.key="convId",this.isFeatEnabled=()=>!this._manuallyOff&&ms.default.preview_msg_time.enable,this.state=fd}offFeature(){this._manuallyOff=!0}enableFeature(){this._manuallyOff=!1}getAnimController(e){if(!this.isFeatEnabled())return null;if(!this.animationControllers.has(e)){const t=new md.a(e);this.animationControllers.set(e,t)}return this.animationControllers.get(e)||null}setScrollDirection(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.setScrollDirection(t)}hasNewMsgInView(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasNewMsgInView(t)}hasViewOverflowMsg(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasViewOverflowMsg(t)}hitBottom(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hitBottom(t)}triggerActiveScroll(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.triggerActiveScroll(t)}onChangeConversation(e){var t;const s=this.getAnimController(e);null==s||s.resetAnimation(),null===(t=pd.a.getInViewController(e))||void 0===t||t.resetPreviewTimestamp(),Ti.a.onNewSession(e)}clearAnimations(e){const t=this.getAnimController(e);null==t||t.clearAnimations()}onMouseEnterPreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.pause())}onMouseLeavePreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.resume())}setTopMost(e,t,s){if(!this.isFeatEnabled())return;const i=this.getAnimController(e);null==i||i.setTopMost(t,s)}setSecondTopMost(e,t,s){if(!this.isFeatEnabled())return;const i=this.getAnimController(e);null==i||i.setSecondTopMost(t,s)}init(){}getItem(e){return this.state[e.key]}getList(e){return Object.keys(this.state)}onGetItemFailure(e){}onGetListFailure(e){}});const vd=Object(i.define)("IMAGE_REGENERATOR_NAME");var bd,yd=s("AqnK"),Id=s("3Rxw"),_d=(s("xwfN"),s("qSdT")),Cd=s("V2fg"),Od=s("RUx3");let Sd=Object(i.injectable)()(bd=class{constructor(){this.MAX_REGEN_TASKS=10,this.requests=[],this.availableTask=this.MAX_REGEN_TASKS,this.regenImageFromLocal=async e=>{try{await this.acquireTaskLock();try{const t=await this.regenImageFromLocalUsingNativelibs(e);return fs.default.increaseSuccess(Od.a,0,0),fs.default.increaseSuccess(Od.c,0,0),t}catch(t){fs.default.increaseFailed(Od.a,0,0,Object(Od.k)(),Date.now())}try{const t=await this.regenImageFromUrlUsingNativeElectron(e);return fs.default.increaseSuccess(Od.c,0,0),t}catch(t){throw t}}catch(t){throw fs.default.increaseFailed(Od.c,0,0,Object(Od.i)(),Date.now()),t}finally{this.releaseTaskLock()}},this.regenImageFromLocalUsingNativelibs=async e=>{const{getSourcePath:t,getGenThumbPath:s,sizes:i={width:void 0,height:void 0},removeOriginalAfterGenerate:a=!1,priority:n=-1}=e;Object(K.a)(!!t,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(K.a)(!!s,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const r=await s();if($znode.fs.existsSync(r))return yd.k.Success({mediaURL:r});const o={width:i.width,height:i.height},d=await t(),l=$znode.path.extname(d);try{var c,h;const t=await $zFileManager.getFileArrayBuffer(d);Cd.a.log(null===(c=e.log)||void 0===c?void 0:c.clientId,{msgFormat:l,originalSize:t.byteLength});let s=new Blob([t],{type:".jxl"===l?"image/jxl":"image/jpeg"});s=await Object(Id.a)(s,{width:o.width,height:o.height,priority:n});const i=$znode.path.dirname(r);await this.ensureDir(i),await $zFileManager.writeBufferToPath(r,await s.arrayBuffer()),Cd.a.endLog(null===(h=e.log)||void 0===h?void 0:h.clientId,{regenStatus:1,localSize:t.byteLength,hdSize:t.byteLength,normalSize:720===o.width?s.size:void 0,thumbSize:300===o.width?s.size:void 0})}catch(g){var u;throw Cd.a.endLog(null===(u=e.log)||void 0===u?void 0:u.clientId,{regenStatus:0}),g}if(a)try{$znode.fs.unlinkSync(d)}catch(m){}return yd.k.Success({mediaURL:r})},this.regenImageFromUrlUsingNativeElectron=async e=>{const{getSourcePath:t,getGenThumbPath:s,sizes:i,removeOriginalAfterGenerate:a=!1,priority:n=-1}=e;Object(K.a)(!!t,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(K.a)(!!s,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const r=await s();if($znode.fs.existsSync(r))return yd.k.Success({mediaURL:r});const o={width:i.width||-1,height:i.height||-1},d=await t(),l=$znode.path.extname(d);let c=null,h=null;try{const e=await $zFileManager.getFileArrayBuffer(d);let t=new Blob([e],{type:".jxl"===l?"image/jxl":"image/jpeg"});c=URL.createObjectURL(t);const s=new Image;s.src=c,await new Promise(((e,t)=>{s.onload=e,s.onerror=t}));let i=o.width,a=o.height,n=s.width,u=s.height;if(-1==a&&-1==i)i=n,a=u;else if(-1==a||-1==i)-1==a?a=Math.min(yd.f,n,i)*u/n:i=Math.min(yd.f,a,u)*n/u;else{const{width:e,height:t}=Object(_d.a)(n,u,yd.f,yd.f);i=e,a=t}h=document.createElement("canvas"),h.width=i,h.height=a;const g=h.getContext("2d");null==g||g.drawImage(s,0,0,i,a);const m=await new Promise(((e,t)=>{h.toBlob((s=>{const i=new FileReader;i.onload=()=>{e(i.result)},i.onerror=t,i.readAsArrayBuffer(s)}),"image/jpeg",1)})),p=$znode.path.dirname(r);await this.ensureDir(p),await $zFileManager.writeBufferToPath(r,m)}catch(g){throw zconsole.error("[JXL]: regen erorr",g),g}finally{var u;c&&URL.revokeObjectURL(c);const e=null===(u=h)||void 0===u?void 0:u.getContext("2d");e&&e.clearRect(0,0,h.width,h.height),h&&(h.width=0,h.height=0)}if(a)try{$znode.fs.unlinkSync(d)}catch(m){}return yd.k.Success({mediaURL:r})},this.ensureDir=e=>Promise.resolve(),this.createDeferred=()=>{let e,t;return{promise:new Promise(((s,i)=>{e=s,t=i})),resolve:e,reject:t}},this.acquireTaskLock=async()=>{if(this.availableTask<=0){const e=this.createDeferred();this.requests.push(e),await e.promise}this.availableTask--},this.releaseTaskLock=()=>{if(this.availableTask=Math.min(this.MAX_REGEN_TASKS,this.availableTask+1),this.availableTask>0&&this.requests.length>0){this.requests.shift().resolve()}}}})||bd;i.ModuleContainer.registerSingleton(vd,Sd);var Ed=s("tDXj"),Md=s("KweF");const Td=Object(i.define)("JIT_MEDIA_CODEC");var wd,Rd=s("DhYn");let Ld=Object(i.injectable)()(wd=class{constructor(){this._blobURLMapping=new Map,this._conversationCache=new Map}async preload(e,t,s){let i=e;if(this._isHttpURL(e))try{if(this._blobURLMapping.has(e))return yd.k.Success({mediaURL:e});const t=Object(Md.i)().toString(),s=await Object(Md.h)(t,e,Md.a.dev,void 0,{useDiskCache:!1});if(s.error)return yd.k.Failure({code:yd.d.FAILURE_BY_FETCH,error:s.error});i=s.data}catch(a){return yd.k.Failure({code:yd.d.FAILURE_BY_FETCH,error:a})}else if(this._isBlobURL(e)){if(this._blobURLMapping.has(e))return yd.k.Success({mediaURL:e});if(!(await this.isBlobURLAlive(e)))return yd.k.Failure({code:yd.d.FAILURE_BY_FETCH,error:"blob url expired"})}return this._cache(i,t,s),yd.k.Success({mediaURL:i})}async isBlobURLAlive(e,t){const s=null!=t&&t.document?t.document.createElement("img"):new Image;s.src=e;try{return await s.decode(),!0}catch(i){return!1}}async preloadImageDOM(e,t){let s=0,a=null,n=1,r=t&&"async"!==(null==t?void 0:t.mode)&&"auto"!==(null==t?void 0:t.mode)?"sync":"async";const o=e.src,d=null==o?void 0:o.endsWith("jxl"),l=(Rd.a.jxl.enable_native_electron_jxl,!1);if(d&&!l)try{var c,h;const t=null===(c=e.rawSrc)||void 0===c||null===(h=c.replace("file://",""))||void 0===h?void 0:h.replace("zfile://",""),s=await i.ModuleContainer.resolve(Td).decodeLocalImage(t);if(!s)throw new Error("JXL decode failed. Empty url");e.src=s}catch(u){zconsole.zsymb(21,"1eItm-",["Failed to decode JXL image","ZAdbGs"],u)}if("async"===r){n=2;try{return await this._preloadImageAsync(e)}catch(u){s++,a=u}}try{return await this.preloadImageSync(e)}catch(u){s++,a=u}if(s===n)throw new Error(`preloadImageDOM failed ${a}`);return null}async _preloadImageAsync(e){try{const t=new Image;t.draggable=!1;for(const s in e)s&&e[s]&&t.setAttribute(s,e[s]);return await t.decode(),t}catch(t){throw t}}async preloadImageSync(e){const t=new Image;t.draggable=!1;for(const a in e)a&&e[a]&&t.setAttribute(a,e[a]);const s=new Promise(((e,s)=>{t.onload=e,t.onerror=s}));try{return await s,t}catch(i){throw i}}_cache(e,t,s){if(this._blobURLMapping.set(e,{blobURL:e,cacheMode:t,convId:s}),s){const t=this._conversationCache.get(s)||[];t.push(e),this._conversationCache.set(s,t)}}_isHttpURL(e){return e.startsWith("http")||e.startsWith("https")}_isBlobURL(e){return e.startsWith("blob")}})||wd;i.ModuleContainer.registerSingleton(Ed.a,Ld);var Fd=s("UeuQ"),Dd=s("XDVU");function Ad(e){return e.startsWith("http")||e.startsWith("https")}function jd(e){return e.startsWith("blob")}var Pd=s("tqrY");var Nd,Ud=s("Q8nW"),kd=s("Ageb"),Bd=s("qvbK");let Gd=Object(i.injectable)()(Nd=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(Nd=Reflect.metadata("design:type",Function)(Nd=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Nd=class{constructor(e){this.Logger=void 0,this.Logger=e.createZLogger(ci.ZLoggerNametags.imageLoader,[ci.ZLoggerNametags.mediaBlobFetcher])}async fetch(e){let{mediaId:t,source:s,options:i={}}=e;Object(Dd.a)("string"==typeof s&&Ad(s),`Media source must be a (http|https) URL. Got ${s}`);const a=Date.now();try{const e=te(Md.h,{min:Pd.a.image_loader.retryMin,max:Pd.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:Pd.a.image_loader.lastTryDelayTime.min,max:Pd.a.image_loader.lastTryDelayTime.max},afterRetry:async({success:e,shouldRetry:t,nTry:s,duration:i})=>{e||this.Logger.zsymb(0,"Mv9evB",`MediaBlobFetcher: Try ${s}: failed. Should retry: ${t} after ${i}ms`),e||t||this.Logger.zsymb(0,"QL4sMZ",`MediaBlobFetcher: Download failed after ${s} tries`)}});null!=i&&i.regenerateFromSource&&delete i.regenerateFromSource.getLocalPath;const d=Object(f.a)(Object(f.a)({cacheControl:"cache",useMemCache:!0,useDiskCache:!1},i),{},{convertible:Object(Ud.g)(s)});if(null!=i&&i.regenerateFromSource){var n;d.regenerateJXL={outputWidth:null===(n=i.regenerateFromSource)||void 0===n?void 0:n.outputWidth};const e=i.regenerateFromSource.regenId;s=Object(Ud.b)(i.regenerateFromSource.url,"regenw",i.regenerateFromSource.outputWidth.toString()),"cache"===d.cacheControl&&(d.useDiskCache="thumb"===e,d.useDiskCache&&(s=Object(kd.d)(s)))}const l=await e(Object(Md.i)().toString(),s,"dev",void 0,d,void 0,(e=>{if(!e)return null;const[t,s,i]=e.split(".");return{cliMsgId:t,fromUid:s,toUid:i}||null})(t),Md.c.IMAGE_COMPONENT);if(Object(Ud.g)(s)&&l.data&&(fs.default.increaseSuccess(Od.b,0,0),fs.default.increaseSuccess(Od.a,0,0)),l.error||!l.data){var r;if(this.Logger.zsymb(0,"xuniL1",`MediaBlobFetcher: fetch failed. ${t} ${s}. took: ${Date.now()-a}`,l.error,l.data,null==l||null===(r=l.error)||void 0===r?void 0:r.code),Object(Bd.k)(l.error)){var o;const e=Object(Bd.l)(null===(o=l.error)||void 0===o?void 0:o.code);if(e){const{qosCommand:t,errorCode:s}=e;fs.default.increaseFailed(t,0,0,s,a)}return fs.default.increaseFailed(Od.a,0,0,Object(Od.k)(),Date.now()),yd.k.Failure({code:yd.d.LIBJXL_ERROR,mediaURL:s,error:l.error})}return yd.k.Failure({code:yd.d.FAILURE_BY_FETCH,error:{mediaURL:s,error:l.error}})}return yd.k.Success({mediaURL:l.data})}catch(d){return this.Logger.zsymb(0,"KfDa_X",`MediaBlobFetcher: fetch caught error. ${t} ${s}. took: ${Date.now()-a}`,d,null==d?void 0:d.code),yd.k.Failure({code:yd.d.FAILURE_BY_FETCH,error:{mediaURL:s,error:d}})}}})||Nd)||Nd)||Nd)||Nd;var xd;i.ModuleContainer.registerSingleton(Fd.a,Gd);let zd=Object(i.injectable)()(xd=class extends je.b{async fetch(e){const{mediaId:t,source:s,diskFetcherConfig:a,sendDttm:n,isLastFallbackUrl:r=!1,regenerateFromSource:o}=e;let d;Object(Dd.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(Dd.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`),d=yd.i.MemoryCache;const l=Ad(s),c=jd(s);if(!l&&c)return yd.k.Success({mediaURL:s});if(d===yd.i.MemoryCache)try{return await i.ModuleContainer.resolve(Fd.a).fetch({mediaId:t,source:s,options:{cacheControl:"cache",sendDttm:n,regenerateFromSource:o,isLastFallbackUrl:r,useDiskCache:!1,useMemCache:!0}})}catch(g){return Promise.reject(g)}Object(Dd.a)("object"==typeof a&&"string"==typeof a.savePath&&!!a.downloadEntrySerial,`MediaFetcherImpl: invalid diskFetcherConfig. Got ${a}`);const{savePath:h,downloadEntrySerial:u}=a;return i.ModuleContainer.resolve(Fd.b).fetch({mediaId:t,source:s,options:{entrySerial:u,savePath:h,sendDttm:n,regenerateFromSource:o,isLastFallbackUrl:r}})}async fetchSocialMediaStandalone(e){const{mediaId:t,source:s}=e;Object(Dd.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(Dd.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`);const a=Ad(s),n=jd(s);if(!a&&n)return yd.k.Success({mediaURL:s});try{return await i.ModuleContainer.resolve(Fd.a).fetch({mediaId:t,source:s,options:{cacheControl:"noCache"}})}catch(r){return Promise.reject(r)}}})||xd;i.ModuleContainer.registerSingleton(Fd.c,zd);var Vd,Hd=s("Evs5");let $d=Object(i.injectable)()(Vd=class{constructor(){this.loadMedia=async(e,t)=>{const{mediaId:s,entry:i,qualityFallback:a,fetchStrategy:n}=e,{fetcher:r,diskCacheConfig:o,disableLocalCache:d}=n,l=null==t?void 0:t.onFirstAvailable;let c=a,h=null;const u=new Set;let g=!1;for(;c;){const t=c.data.url,a=c.data.getLocalPath;let n=c.data.regenerateFromSource;if(!t){c=c.nextOR||c.next;continue}const p=!c.nextOR&&!c.next;if(u.has(t)&&!p){c=c.nextOR||c.next;continue}g=!0;const f=await this._buildFetchConfig({mediaId:s,entry:i,source:t,getLocalPath:()=>null==a?void 0:a(t),downloadEntrySerial:null==o?void 0:o.downloadEntrySerial,autoDownload:!!h,sendDttm:e.sendDttm,isLastFallbackUrl:p,regenerateFromSource:n,disableLocalCache:d}),v=await r(f);if("ERROR"==v.type){if(v.data.error&&Object(Bd.k)(v.data.error))return yd.k.Failure({code:yd.d.LIBJXL_ERROR,error:v.data.error});u.add(t),c=c.nextOR||c.next;continue}let b=null,y=null,I=null;try{const t=e.mediaId.split(".");3===t.length&&(b=t[0],y=t[1],I=t[2])}catch(m){}if(b&&Cd.b.log(b,{msgFormat:Object(Ud.g)(t)?".jxl":".jpg"}),!h){h={mediaURL:v.data.mediaURL},null==l||l(yd.k.Success(h));break}c=c.next}return g?null===h?yd.k.Failure({code:yd.d.FAILURE_BY_FETCH,error:s}):yd.k.Success(h):yd.k.Failure({code:yd.d.EMPTY_SOURCE,error:s})},this._buildFetchConfig=async e=>{Object(Dd.a)(!!e&&"object"==typeof e,`_buildDownloadConfig: config must be object, got ${e}`);const t=Object(e);Object(Dd.a)("string"==typeof t.mediaId,`_buildDownloadConfig: mediaId must be string, got ${null==t?void 0:t.mediaId}`),Object(Dd.a)(t.entry in yd.j,`_buildDownloadConfig: entry must be MediaDisplayTarget, got ${null==t?void 0:t.entry}`),Object(Dd.a)("string"==typeof t.source,`_buildDownloadConfig: source must be string, got ${null==t?void 0:t.source}`);const s={mediaId:t.mediaId,source:t.source,sendDttm:t.sendDttm,isLastFallbackUrl:t.isLastFallbackUrl,regenerateFromSource:t.regenerateFromSource,entry:t.entry};if(t.getLocalPath&&!t.disableLocalCache){const e=await t.getLocalPath();s.diskFetcherConfig={savePath:e,downloadEntrySerial:t.downloadEntrySerial,autoDownload:t.autoDownload}}return s}}abort(e,t){}})||Vd;i.ModuleContainer.registerSingleton(Hd.a,$d);var Wd=s("UD1y"),qd=s("OgkW"),Kd=s.n(qd);const Zd={FORWARD_MESSAGE:"FORWARD_MESSAGE",DOWNLOAD_MESSAGE:"DOWNLOAD_MESSAGE",ROTATE_LEFT:"ROTATE_LEFT",ROTATE_RIGHT:"ROTATE_RIGHT",ZOOM_IN:"ZOOM_IN",RESET_ZOOM:"RESET_ZOOM",MORE_MEDIA_ACTION:"MORE_MEDIA_ACTION",RELOAD_MEDIA:"RELOAD_MEDIA"};var Qd,Jd=s("fB1t"),Yd=s("Ms/M"),Xd=s("c3KS");class el{constructor(){this.aborted=void 0,this.aborted=!0}}class tl{constructor(e,t=[]){this._task=e,this.args=t,this._abortController=void 0,this._aborted=!1,this._fulfilled=!1,this._promise=null,this._abortableTask=void 0,this.abort=()=>{this._abortController.abort()},this._abortController=new AbortController,this._abortableTask=(...e)=>new Promise(((t,s)=>{const i=()=>{this._aborted=!0,s(new el),this._abortController.signal.removeEventListener("abort",i)};this._abortController.signal.addEventListener("abort",i),this._task(...e).then(t).catch(s).finally((()=>{this._abortController.signal.removeEventListener("abort",i),this._fulfilled=!0}))}))}get aborted(){return this._aborted}get fulfilled(){return this._fulfilled}get promise(){return this._promise||(this._promise=this._abortableTask(...this.args)),this._promise}}function sl(e,...t){return new tl(e,t)}class il{constructor(e,t){this.taskId=e,this.executor=t}}class al{constructor(e){this.limit=void 0,this.runningTasks=void 0,this.taskQueue=void 0,this.taskMap=void 0,this.isRunning=e=>this.runningTasks.has(e),this.abortTask=e=>{const t=this.taskMap.get(e);t&&(t.executor.abort(),this.removeTask(e))},this.limit=e,this.runningTasks=new Set,this.taskQueue=[],this.taskMap=new Map}addTask(e){this.runningTasks.has(e.taskId)||(this.taskMap.has(e.taskId)&&(this.taskQueue=this.taskQueue.filter((t=>t.taskId!==e.taskId))),this.taskQueue.push(e),this.taskMap.set(e.taskId,e),this._tryToRunTasks())}removeTask(e){this.runningTasks.has(e)||this.taskMap.has(e)&&(this.taskQueue=this.taskQueue.filter((t=>t.taskId!==e)),this.taskMap.delete(e))}_tryToRunTasks(){if(!(this.runningTasks.size>=this.limit))for(;this.runningTasks.size<this.limit&&this.taskQueue.length>0;){const e=this.taskQueue.pop();e&&(this.taskMap.delete(e.taskId),this._runTask(e))}}_runTask(e){this.runningTasks.add(e.taskId),e.executor.promise.then((()=>{this._taskFinished(e.taskId)})).catch((()=>{this._taskFinished(e.taskId)}))}_taskFinished(e){this.runningTasks.delete(e),this._tryToRunTasks()}}Object(i.injectable)()(Qd=Object(Hs.b)(Wd.b)(Qd=function(e,t){return Object(i.inject)(Hd.a)(e,void 0,0)}(Qd=function(e,t){return Object(i.inject)(ke.a)(e,void 0,1)}(Qd=function(e,t){return Object(i.inject)(Fd.c)(e,void 0,2)}(Qd=Reflect.metadata("design:type",Function)(Qd=Reflect.metadata("design:paramtypes",[Object,void 0===ke.a?Object:ke.a,Object])(Qd=class{constructor(e,t,s){this.mediaPackageManager=e,this.application=t,this.mediaFetcher=s,this._revokedBlobURL=new Map,this._activeContextWindow=null,this._retryItems=new ce.default({maxSize:1e3}),this.TaskQueue=new al(300),this._eventEmitter=new Kd.a,this.MAX_RETRIES=4,this.setActiveWindowContext=e=>("WeakRef"in globalThis?this._activeContextWindow=new globalThis.WeakRef(e):this._activeContextWindow=e,this.removeActiveWindowContext),this.removeActiveWindowContext=()=>{this._activeContextWindow=null},this.getActiveWindowContext=()=>this._activeContextWindow instanceof globalThis.WeakRef?this._activeContextWindow.deref():this._activeContextWindow,this.manualRetry=async(e,t,s=!1)=>{var i,a,n;const r=this.data.get(e),o=`${e}-${t}`;(null==r||null===(i=r.failure)||void 0===i?void 0:i.code)===yd.d.FORCE_EXPIRE||this.TaskQueue.isRunning(o)||(this._retryable(o)||s?r&&(s&&this._retryItems.set(o,0),this._handleRevokeURL({payload:{blobURL:null==r||null===(a=r.view[t])||void 0===a?void 0:a.actual,mediaId:e}}),this._handleRevokeURL({payload:{blobURL:null==r||null===(n=r.view[t])||void 0===n?void 0:n.expected,mediaId:e}}),null==r||delete r.view[t],null==r||delete r.failure,this.data.set(e,r),this.emit(Zd.RELOAD_MEDIA,{mediaId:e,entry:t,hotSwapSource:!0})):this.forceError(e,t))},this.forceError=(e,t)=>{const s=this.data.get(e)||{mediaId:e,view:{}},i=(null==s?void 0:s.view)||{};this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{view:Object(f.a)(Object(f.a)({},i),{},{[t]:{failure:{code:yd.d.FORCE_ERROR,message:"Force error"}}})})),this._signalRenderItem(this.name,e)},this.loadMedia=async(e,t={})=>{const s=sl(this._loadMedia,e,t),i=`${e.mediaId}-${e.entry}`,a=new il(i,s);this.TaskQueue.addTask(a)},this._loadMedia=async(e,t={})=>{var s,i,a;const{forceLoad:n=!1}=t,r=(e.mediaId,e.entry,this.data.get(e.mediaId));if(globalThis.__alwaysForcePhotoExpired)return this.forceExpire(e.mediaId);const o=this._revokedBlobURL.get(e.mediaId),d=null==r||null===(s=r.view)||void 0===s?void 0:s[e.entry],l=!(null==d||!d.actual||null!=o&&o.has(d.actual)),c=[yd.e.EmptySource,yd.e.ZaloSource,yd.e.ExpiredSource];if(l&&c.some((e=>e===d.dataSrcId))||null!=r&&r.failure&&!1===n)return;if(this._mayInitState(e,!0),null!==(i=e.uploadSource)&&void 0!==i&&null!==(a=i.oriUrl)&&void 0!==a&&a.startsWith("blob:"))return void this._updateViewUpload(e.mediaId,e.entry,e.uploadSource);let h=null,u=null,g=null;try{const t=e.mediaId.split(".");3===t.length&&(h=t[0],u=t[1],g=t[2])}catch(m){}h&&Cd.b.log(h,{clientId:h,dest_id:g,srcId:u});try{let s=!1;const i=this.data.get(e.mediaId),a=Object(f.a)(Object(f.a)({},t),{},{expiryCheck:e.expiryCheck}),n=await this.mediaPackageManager.loadMedia(e,{hasHd:null==i?void 0:i.hasHd,skipHdCheck:null==i?void 0:i.hasHd,onFirstAvailable:t=>{s=!0,this._handleLoadResponse(e.mediaId,e.entry,t,a)}});s||this._handleLoadResponse(e.mediaId,e.entry,n,a)}catch(m){h&&Cd.b.endLog(h,{clientId:h,dest_id:g,srcId:u,renderStatus:0})}},this._retryable=e=>!((this._retryItems.get(e)||0)>=this.MAX_RETRIES||this.TaskQueue.isRunning(e)),this.runFullflow=(e,t)=>{var s;const i=this.data.get(e),a=`${e}-${t}`;if((null==i||null===(s=i.failure)||void 0===s?void 0:s.code)===yd.d.FORCE_EXPIRE||this.TaskQueue.isRunning(a))return;if(!this._retryable(a))return void this.forceError(e,t);this.abanbonMedia(e,t);const n=this._retryItems.get(a)||0;this._retryItems.set(a,n+1),this.manualRetry(e,t)},this.loadDOMSuccess=(e,t)=>{try{const t=e.split(".");if(t.length){const e=t[0];Cd.b.endLog(e,{renderStatus:1})}}catch(s){}this._retryItems.delete(`${e}-${t}`)},this.loadDOMError=(e,t)=>{},this._signalRenderItem=(...e)=>{Object(Kt.h)(...e)},this._triggerError=e=>{0},this._triggerExpired=e=>{const t=Jd.a.get(e.mediaId);if(t){const s=e.mediaId.split(".");"0"==s[1]&&(s[1]=$e.p.getSessionUserId()),"0"==s[2]&&(s[2]=$e.p.getSessionUserId());const i=s.join("_"),a=Object(f.a)({metaId:i},t);Yd.a.dispatchEvent(new Xd.a(Xd.b.WriteDB,{message:a,result:{isExpired:!0,autoDownloadPath:""}}))}},this._handleRevokeURL=e=>{const t=null==e?void 0:e.payload;Object(Dd.a)(!!t,"ImageLoaderController: revoke event payload undefined");const{blobURL:s,mediaId:i}=t;s&&URL.revokeObjectURL(s)},this.listenEvents=()=>{this.application.addEventListener(ke.b.Exit,this._cleanupEvents)},this._cleanupEvents=()=>{this.application.removeEventListener(ke.b.Exit,this._cleanupEvents)},this.name=Wd.a,this.data=new Map,this.key="mediaId",this.init=()=>{this.listenEvents(),this._eventEmitter.setMaxListeners(50)},this.init()}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter&&e in Zd&&this._eventEmitter.emit(e,t)}getViewState(e,t){var s,i;return null===(s=this.data.get(e))||void 0===s||null===(i=s.view)||void 0===i?void 0:i[t]}allowOutviewUpdate(e,t){const s=this.data.get(e),i=null==s?void 0:s.view[t];i&&(i.dataSrcId!==yd.e.Upload||i.expected)?i.actual!==i.expected&&Boolean(i.expected)&&(this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{view:Object(f.a)(Object(f.a)({},null==s?void 0:s.view),{},{[t]:Object(f.a)(Object(f.a)({},i),{},{actual:i.expected,dataSrcId:yd.e.ZaloSource})})})),this._signalRenderItem(this.name,e),this._runCleanup(e,i.actual)):this.emit("RELOAD_MEDIA",{mediaId:e,entry:t,hotSwapSource:!0,forceLoad:!0})}forceExpire(e){var t;const s=this.data.get(e)||{mediaId:e,view:{}};(null==s||null===(t=s.failure)||void 0===t?void 0:t.code)!==yd.d.FORCE_EXPIRE&&(this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{failure:{code:yd.d.FORCE_EXPIRE,message:"Force expire"},view:{}})),this._signalRenderItem(this.name,e))}abort(e){const t=this._retryItems.get(e)||0;this._retryItems.set(e,Math.max(t-1,0)),this.TaskQueue.abortTask(e)}rotateMedia(e,t){let s=this.data.get(e);if(!s)throw new Error(`rotateMedia failed with ${e}: ${t}`);let i=s.rotateDeg||0;i+=t,s=Object(f.a)(Object(f.a)({},s),{},{rotateDeg:i}),this.data.set(e,s),this._signalRenderItem(this.name,e)}abanbonMedia(e,t){if(!this.data.has(e))return;const s=this.data.get(e);null!=s&&s.view[t]&&(delete s.view[t],this.data.set(e,Object(f.a)({},s)),this._signalRenderItem(this.name,e))}clearItemData(e,t,s){const i=this.data.get(e);i&&(delete i.view[t],this.data.set(e,i),!0===(null==s?void 0:s.signalRenderItem)&&this._signalRenderItem(this.name,e))}_runCleanup(e,t){if(!t||!t.startsWith("blob:"))return;const s=this.data.get(e);if(!s)return void URL.revokeObjectURL(t);const i=s.view;Object.values(i).forEach((e=>{e.actual!==t&&e.expected})),URL.revokeObjectURL(t)}_mayInitState(e,t=!0){let s=this.data.get(e.mediaId);s||(s={mediaId:e.mediaId,view:{},rotateDeg:90*e.vOrient},this.data.set(e.mediaId,s)),t||this._signalRenderItem(this.name,e.mediaId)}_handleLoadResponse(e,t,s,i){switch(s.type){case"ERROR":this._handleLoadError(s,e,t,i);break;case"SUCCESS":this._handleLoadSuccess(s,e,t,i);break;default:throw new Error(`Unknown response type: ${e} ${t} got ${null==s?void 0:s.type}`)}}_handleLoadError(e,t,s,i={}){const a=e.data;switch(a.code){case yd.d.FAILURE_BY_FETCH:{var n;const e=this.data.get(t);e.view=Object(f.a)(Object(f.a)({},e.view),{},{[s]:Object(f.a)(Object(f.a)({},e.view[s]),{},{failure:{code:a.code,message:a.error}})}),this.data.set(t,e);!0===(null==i||null===(n=i.expiryCheck)||void 0===n?void 0:n.call(i))?this._triggerExpired({mediaId:t}):this._triggerError({mediaId:t}),this._signalRenderItem(this.name,t);break}case yd.d.FAILURE_BY_PRELOAD:{const e=this.data.get(t);e.view=Object(f.a)(Object(f.a)({},e.view),{},{[s]:Object(f.a)(Object(f.a)({},e.view[s]),{},{failure:{code:a.code,message:a.error}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case yd.d.EMPTY_SOURCE:{const e=this.data.get(t);e.view=Object(f.a)(Object(f.a)({},e.view),{},{[s]:Object(f.a)(Object(f.a)({},e.view[s]),{},{failure:{code:a.code,message:a.error}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case yd.d.LIBJXL_ERROR:this.forceError(t,s)}}async _updateViewUpload(e,t,s){var a,n,r,o,d,l,c;if(null==s||!s.oriUrl)return;let h=this.data.get(e);const u=await i.ModuleContainer.resolve(Ed.a).isBlobURLAlive(s.oriUrl,this.getActiveWindowContext());let g=s.oriUrl;if(u||!s.file||null!==(a=h)&&void 0!==a&&null!==(n=a.view)&&void 0!==n&&null!==(r=n[t])&&void 0!==r&&r.actual){if(null!==(o=h)&&void 0!==o&&null!==(d=o.view)&&void 0!==d&&null!==(l=d[t])&&void 0!==l&&l.actual)return}else g=URL.createObjectURL(s.file);h?(null===(c=h.view[t])||void 0===c?void 0:c.actual)!==g&&Boolean(g)&&(h=Object(f.a)(Object(f.a)({},h),{},{view:Object(f.a)(Object(f.a)({},h.view),{},{[t]:{actual:g,expected:g,dataSrcId:yd.e.Upload}})})):h={mediaId:e,view:{[t]:{actual:g,expected:g,dataSrcId:yd.e.Upload}}},this.data.set(e,h),this._signalRenderItem(this.name,e)}_updateView(e,t,s,i){if(!s)return;const a=this.data.get(e),n=a.view[t],r=this._revokedBlobURL.get(e);if(!n||!Boolean(n.actual)||n.actual&&null!=r&&r.has(n.actual))a.view=Object(f.a)(Object(f.a)({},a.view),{},{[t]:{actual:s,expected:s,dataSrcId:yd.e.ZaloSource}}),this.data.set(e,a);else if(Boolean(n.actual)&&n.actual!==s){const i=Object(f.a)(Object(f.a)({},n),{},{expected:s});a.view=Object(f.a)(Object(f.a)({},a.view),{},{[t]:i}),this.data.set(e,a)}if(null!=i&&i.hotSwapSource){var o;const i=this.data.get(e);this.data.set(e,Object(f.a)(Object(f.a)({},i),{},{view:Object(f.a)(Object(f.a)({},null==i?void 0:i.view),{},{[t]:Object(f.a)(Object(f.a)({},null==i||null===(o=i.view)||void 0===o?void 0:o[t]),{},{actual:s,expected:s,dataSrcId:yd.e.ZaloSource})})}))}this._signalRenderItem(this.name,e)}_handleLoadSuccess(e,t,s,i){const a=e.data;this._updateView(t,s,a.mediaURL,i)}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||Qd)||Qd)||Qd)||Qd)||Qd)||Qd);var nl,rl=s("7nHs");const ol={isShown:!1,modalTitle:"",guideTitle:"",errorCode:"",guideItems:[],showPrimaryBtn:!0,primaryBtnName:"STR_BU_CONFIRM_TEXT_4",showSecondaryBtn:!0,secondaryBtnName:"STR_BU_CANCEL_TEXT_4",adapterType:ye.b};Object(Hs.b)(rl.a)(nl=class{constructor(){this.name=rl.b,this.key="",this.state=ol}setState(e){const t=Object(wo.a)(this.state,e);this.state!==t&&(this.state=t,Object(Kt.g)(this.name,""))}showModal(e){this.state.isShown||this.setState((t=>Object(f.a)(Object(f.a)(Object(f.a)({},t),e),{},{isShown:!0})))}closeModal(){this.state.isShown&&this.setState((e=>Object(f.a)(Object(f.a)(Object(f.a)({},e),ol),{},{isShown:!1})))}init(e){}getItem(e,t){return this.state}getList(e,t){return[]}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}});var dl,ll=s("Mf7h"),cl=s("8c0e"),hl=s("alF8");const ul=new Is.LocalId;Object(i.injectable)()(dl=Object(i.singleton)(cl.a)(dl=class{constructor(){this._linkPreviewDatas=new Map,this._lastCheckLinks=new Map,this._listeners=new Map}addListenerAtConv(e,t){if(e&&"function"==typeof t){const s=this._listeners.get(e);this._listeners.set(e,[...s||[],t])}}removeListenerAtConv(e,t){let s=this._listeners.get(e);s&&s.length>0&&(s=s.filter((e=>e!==t)),this._listeners.set(e,s))}removeAllListenerAtConv(e){this._listeners.delete(e)}setLastCheckLinkByConvId(e,t){this._lastCheckLinks.set(e,t)}isLastCheckLinkOfConv(e,t){const s=this._lastCheckLinks.get(e);return!!s&&hl.a.isEqualUrl(s,t)}getLinkPreviewDataByConvId(e){return this._linkPreviewDatas.get(e)||null}addLinkDataToConv(e,t){const s=this._prepareLinkPreviewData(e,t);this._linkPreviewDatas.set(e,Object(f.a)({},s));const i={action:Os.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(f.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,i),ll.a.emit(Os.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(f.a)({},s)})}createLoadingLinkPreview(e,t){const s={id:ul.next(),convId:e,content:{title:$t.default.str("STR_GETTING_LINK_INFO"),src:t,desc:"",thumb:"",loading:!0},link:t,shouldParseLinkOrContact:!0};e&&this._linkPreviewDatas.set(e,Object(f.a)({},s));const i={action:Os.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(f.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,i),ll.a.emit(Os.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(f.a)({},s)})}removeLinkPreviewData(e){if(!e)return;this._linkPreviewDatas.delete(e);const t={action:Os.LinkPreviewActions.HIDE_LINK_PREVIEW,payload:null};this._notifyLinkPreviewDataChangeToConv(e,t),ll.a.emit(Os.LinkPreviewActions.HIDE_LINK_PREVIEW,null)}_notifyLinkPreviewDataChangeToConv(e,t){const s=this._listeners.get(e);null==s||s.forEach((e=>{"function"==typeof e&&e({action:t.action,payload:t.payload})}))}_prepareLinkPreviewData(e,t){return{id:ul.next(),convId:e,link:t.link,content:t.content,shouldParseLinkOrContact:!1}}})||dl);var gl,ml=s("iy3m"),pl=s("twqL");Object(ke.i)()(gl=Object(i.singleton)(pl.a)(gl=Reflect.metadata("design:type",Function)(gl=Reflect.metadata("design:paramtypes",[])(gl=class{constructor(){this.changeTimeFlushNotiReactWhenResumeApp=this.changeTimeFlushNotiReactWhenResumeApp.bind(this),this.changeTimeFlushNotiReactWhenDisNetwork=this.changeTimeFlushNotiReactWhenDisNetwork.bind(this),this.changeTimeFlushNotiReactWhenStartApp=this.changeTimeFlushNotiReactWhenStartApp.bind(this)}onStart(e){this.changeTimeFlushNotiReactWhenStartApp()}changeTimeFlushNotiReactWhenResumeApp(){this.changeTimeFlushNotiReact(Object(ml.d)())}setupTimer(e){rn.b.TimeFlushNotiReact=e,rn.b.TimeMaxWaiting=Object(ml.a)(),rn.b.setupIntervalToFlushNotiReact(),rn.b.setupTimeoutToGoBackNormalCondition()}changeTimeFlushNotiReactWhenDisNetwork(e){if(e===Un.a.CONNECTED){const e=Un.b.getPreStateNetwork();e!==Un.a.CONNECTED&&e!==Un.a.NOT_SET&&this.changeTimeFlushNotiReact(Object(ml.b)())}}changeTimeFlushNotiReactWhenStartApp(){this.changeTimeFlushNotiReact(Object(ml.e)())}changeTimeFlushNotiReact(e){rn.b.notiReactTimeoutId?(rn.b.TimeFlushNotiReact!==e&&(rn.b.TimeFlushNotiReact=e,rn.b.setupIntervalToFlushNotiReact()),rn.b.TimeMaxWaiting!==Object(ml.a)()&&(rn.b.TimeMaxWaiting=Object(ml.a)(),rn.b.setupTimeoutToGoBackNormalCondition())):this.setupTimer(e)}})||gl)||gl)||gl);var fl,vl=s("K0f4"),bl=s("buT3");Object(ke.i)()(fl=Object(ke.e)()(fl=class{onAuthenticated(e){const{userId:t}=e.getSession();if(t){const e=Object(Ie.d)(t),s=`${e}_${vl.m}`,i=bl.a.getItem(s);if(!(null!==i))return;const a=97124,n="1"===i,r=`${e}_${vl.g}`,o=+(bl.a.getItem(r)||"-1"),d=isNaN(o)?-1:o,l=`${e}_${vl.i}`,c=+(bl.a.getItem(l)||"-1"),h=isNaN(c)?-1:c;if(n)fs.default.increaseSuccess(a,0,d,[h]);else{const t=`${e}_${vl.c}`,s=bl.a.getItem(t),i=Number(s);fs.default.increaseFailed(a,0,d,i,Date.now(),[h])}bl.a.removeItem(s),bl.a.removeItem(r),bl.a.removeItem(l)}}onStart(){const e=vl.l,t=bl.a.getItem(e);if(!(null!==t))return;const s="1"===t,i=vl.f,a=+(bl.a.getItem(i)||"-1"),n=isNaN(a)?-1:a,r=vl.h,o=+(bl.a.getItem(r)||"-1"),d=isNaN(o)?-1:o;if(s)fs.default.increaseSuccess(97123,0,n,[d]);else{const e=bl.a.getItem(vl.b),t=Number(e);fs.default.increaseFailed(97123,0,n,t,Date.now(),[d])}bl.a.removeItem(e),bl.a.removeItem(i),bl.a.removeItem(r)}})||fl);var yl,Il=s("l9L4"),_l=s("CDcE");Object(ke.d)()(yl=Object(i.injectable)()(yl=Object(i.singleton)(Il.a)(yl=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(yl=Reflect.metadata("design:type",Function)(yl=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(yl=class{constructor(e){this._isFirstLoginMap=new Map,this._firstLoginTimeMap=new Map,this._logger=void 0,this._logger=e.createZLogger("utils",["first-login-checker"])}getFirstLoginTime(e){if(this.firstLoginTimeMap.has(e))return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime();try{const t=S.default.getInstance().getItemForCurrentUser(R.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME);null!=t&&this.firstLoginTimeMap.set(e,parseInt(t))}catch(t){this.logger.zsymb(21,"MY_p5u",["getFirstLoginTime error {} - {}","-4OviS"],e,Object(_l.f)(t,2))}return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime()}isFirstLogin(e){return!!this._isFirstLoginMap.get(e)}onApplicationReady(e){this.removeFirstLoginFlag()}setFirstLogin(e,t){this._isFirstLoginMap.set(e,t)}setFirstLoginTime(e,t){this.firstLoginTimeMap.set(e,t);try{S.default.getInstance().setItemForCurrentUser(R.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME,t&&t.toString()||"")}catch(s){this.logger.zsymb(21,"oa4QzE",["setFirstLoginTime error {} - {} - {}","9dPWn0"],e,t,Object(_l.f)(s,2))}}removeFirstLoginFlag(){const e=zt.default.getUidMe(),t=S.default.getInstance();t.getItem(R.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)===e&&t.removeItem(R.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)}getDefaultFirstLoginTime(){return bs.default.getTimeNow()}get firstLoginTimeMap(){return this._firstLoginTimeMap}get logger(){return this._logger}})||yl)||yl)||yl)||yl)||yl);const Cl=Object(i.define)("transfer-data-suggestion-loader");var Ol=s("cgeJ"),Sl=s("XVri"),El=s("bAqL");var Ml=class{constructor(e){this._logger=void 0,this._moduleName=void 0,this._moduleName=e}log(){this.Logger.zsymb(0,"xVXSyJ",this.moduleTagName,...arguments)}logError(e,t){const s=null==t?"":this.stringifyDepthLevel(t);this.Logger.zsymb(18,"1q6x4p",this.moduleTagName,e,s)}stringifyDepthLevel(e){return Object(El.g)(e,Object(El.c)())}get Logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("msg-sync",[Sl.a])),this._logger}get moduleTagName(){return this._moduleName+" - "}};var Tl,wl=class{constructor(e){this.moduleName=e,this._logger=void 0,this._logger=new Ml(this.moduleName)}get Logger(){return this._logger}};function Rl(e){try{return JSON.stringify(e)}catch(t){return""}}function Ll(e){return JSON.parse(e)}Object(i.injectable)()(Tl=Object(i.singleton)(Cl)(Tl=Reflect.metadata("design:type",Function)(Tl=Reflect.metadata("design:paramtypes",[])(Tl=class extends wl{constructor(){super(Ol.e.LOADER),this._friendManager=void 0,this._groupManager=void 0}async loadLastCloseBannerDownloadPC(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load last close banner download pc failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(Ol.b);return null!=t?Ll(t):(this.Logger.logError("Load last close banner download pc failed null"),null)}catch(t){return this.Logger.logError("Load last close banner download pc failed",t),t}}async loadListConversationsFromDB(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load list conversations from DB failed cause invalid storage"),Promise.reject([]);try{const t=await e.getItemForCurrentUserAsync(Ol.d);return null!=t?Ll(t):(this.Logger.logError("Load list conversations from DB failed null"),[])}catch(t){return this.Logger.logError("Load list conversations from DB failed",t),[]}}async loadListFriends(){const e=this.getFriendManagerModule();if(e)try{return await e.getFriends()}catch(t){return this.Logger.logError("Load list friends failed",t),[]}return this.Logger.log("Load list friends empty"),[]}async loadListGroups(){const e=this.getGroupManagerModule();if(e)try{return await e.getGroupsList()}catch(t){return this.Logger.logError("Load list groups failed",t),[]}return this.Logger.log("Load list groups empty"),[]}async loadRegisteredData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load registered data failed cause invalid storage"),Promise.reject();try{let t=e.getItemForCurrentUser(R.RegisterLocalStorageKeys.IS_REGISTERED_ON_THIS_DEVICE);return null!=t?{isRegisteredOnThisDevice:Ll(t)}:(this.Logger.log("Load registered data null"),null)}catch(t){return this.Logger.logError("Load registered data failed",t),t}}async loadSyncMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load sync messages data failed cause invalid storage"),Promise.reject();try{const t=e.getItemForCurrentUser("sync_cross_settings");return t?Ll(t):(this.Logger.log("Load sync messages data null"),null)}catch(t){return this.Logger.logError("Load sync messages data failed",t),t}}async loadTransferMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load transfer messages data failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(Ol.l);return t?Ll(t):(this.Logger.logError("Load transfer messages data failed null"),null)}catch(t){return this.Logger.logError("Load transfer messages data failed",t),t}}async setLastCloseBannerDownloadPC(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Ol.b,Rl(e)):Promise.reject("Invalid storage")}async setLastCloseFirstLoginTransferModal(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Ol.c,Rl(e)):Promise.reject("Invalid storage")}async setListConversationsFirstLoginToDB(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Ol.d,Rl(e)):Promise.reject("Invalid storage")}async updateTransferMessagesData(e){const t={lastTransferSuccessTime:e.lastTransferSuccessTime||Date.now()};try{return await this.getSecureLocalStorageDB().setItemForCurrentUserAsync(Ol.l,Rl(t))}catch(s){return s}}getFriendManagerModule(){var e;this._friendManager||(this._friendManager=null===(e=s("UiPd"))||void 0===e?void 0:e.default);return this._friendManager}getGroupManagerModule(){var e;this._groupManager||(this._groupManager=null===(e=s("Gm1y"))||void 0===e?void 0:e.default);return this._groupManager}getSecureLocalStorageDB(){return S.default.getInstance()}})||Tl)||Tl)||Tl);var Fl=s("n09q"),Dl=s("31cx"),Al=s("a1r1"),jl=s("BO4k");var Pl,Nl=class extends wl{constructor(e,t){super(Sl.c.MANAGER),this._eventMap=new Map,this._fistLoginTime=void 0,this._listConversationsBeforeLogin=[],this._isTransferAfterLogin=void 0,this._moduleLoader=void 0,this._moduleUIManager=void 0,this._moduleLoader=e,this._moduleUIManager=t,this._isTransferAfterLogin=!1,this.handleUpdateConfigs=this.handleUpdateConfigs.bind(this),this.isDisplayedBannerDownloadPCSuggestion=this.isDisplayedBannerDownloadPCSuggestion.bind(this),this.isDisplayedBubbleInfoEcard=this.isDisplayedBubbleInfoEcard.bind(this),this.isDisplayedCloseButtonBannerDownloadPC=this.isDisplayedCloseButtonBannerDownloadPC.bind(this),this.isDisplayedConversationFooter=this.isDisplayedConversationFooter.bind(this),this.isDisplayedGlobalSearchFooter=this.isDisplayedGlobalSearchFooter.bind(this),this.isDisplayedSearchInConversationFooter=this.isDisplayedSearchInConversationFooter.bind(this),this.isDisplayedMilestoneInPreviewMedia=this.isDisplayedMilestoneInPreviewMedia.bind(this),this.isDisplayedSuggestionInMediaList=this.isDisplayedSuggestionInMediaList.bind(this),this.isDisplayedTransferModal=this.isDisplayedTransferModal.bind(this),this.isValidForTransferMessages=this.isValidForTransferMessages.bind(this)}addEventListeners(e,t){this.eventMap.set(e,[...this.eventMap.get(e)||[],t])}callTransferMessages(e){}closeBannerDownloadPCSuggestion(){}getConversationFooterRendererHeight(){return this.isDisplayedConversationFooter()?Sl.b.CONVERSATION:0}getFirstLoginTime(){return this.firstLoginTime}getGlobalSearchFooterRendererHeight(){return this.isDisplayedConversationFooter()?Sl.b.GLOBAL_SEARCH:0}getLogger(){return this.Logger}getUrlDownloadPC(){return""}getIsTransferAfterLogin(){return this.isTransferAfterLogin}hasConversationBeforeFirstLogin(e){return this._listConversationsBeforeLogin.includes(e)}hideTransferMessagesModal(){}async initialize(){this.firstLoginTime=i.ModuleContainer.resolve(Al.a).getFirstLoginTime(this.getUserId()),this.handleUpdateConfigs(jl.a()),this.registerSubscriptions(),await this.initializeListConversationsBeforeFirstLogin()}isDisplayedBannerDownloadPCSuggestion(){return!!this.isEnabledFeature()&&jl.g()}isDisplayedBubbleInfoEcard(e){return!!this.isEnabledFeature()&&(!!jl.h()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedCloseButtonBannerDownloadPC(){return!!this.isEnabledFeature()&&jl.k()}isDisplayedConversationFooter(){return!!this.isEnabledFeature()&&jl.l()}isDisplayedCTADownloadPC(){return!!this.isEnabledFeature()&&jl.i()}isDisplayedCTATransferMessages(){return!!this.isEnabledFeature()&&jl.j()}isDisplayedGlobalSearchFooter(){return!!this.isEnabledFeature()&&jl.m()}isDisplayedSearchInConversationFooter(e){return!!this.isEnabledFeature()&&(!!jl.p()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedMilestoneInPreviewMedia(e){return!!this.isEnabledFeature()&&(!!jl.o()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedSuggestionInMediaList(e){return!!this.isEnabledFeature()&&(!!jl.n()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedTransferModal(){return!!this.isEnabledFeature()&&jl.q()}isEnabledFeature(){return jl.r()}isValidSupportDownloadPC(){return!1}isValidForTransferMessages(){return this.isEnabledFeature()}needTransferMessages(){}removeEventListeners(e,t){const s=this.eventMap.get(e);if(Array.isArray(s)){const e=s.findIndex((e=>e===t));-1!==e&&s.splice(e,1)}}setFirstLoginTime(e){this.firstLoginTime=e}setIsTransferAfterLogin(e){this.isTransferAfterLogin=e}shouldTransferMessages(){return!1}showTransferMessagesModal(){}registerSubscriptions(){ms.$AppConfig.subscribe(this.handleUpdateConfigs)}isFirstLogin(){return i.ModuleContainer.resolve(Al.a).isFirstLogin(this.getUserId())}async initializeListConversationsBeforeFirstLogin(){this._listConversationsBeforeLogin=await this.loadListConversationsBeforeFirstLogin()}handleUpdateConfigs(e={}){const{data_content:t}=jl.b(e),{first_time_login_device:s}=e;t&&this.UIManager.updateDataContent(Object(Dl.a)(t)),null!=s&&(this.firstLoginTime=s)}async loadListConversations(){const e=[],t=await this.loaderModule.loadListFriends();Array.isArray(t)&&t.forEach((t=>{e.push(t.userId)}));const s=await this.loaderModule.loadListGroups();return Array.isArray(s)&&s.forEach((t=>{e.push(t.userId)})),e}async loadListConversationsBeforeFirstLogin(){let e;if(this.isFirstLogin())e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e);else{const t=await this.loaderModule.loadListConversationsFromDB();e=t,(t||[]).length||(e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e))}return e}notifyEvent(e,...t){const s=this.eventMap.get(e);Array.isArray(s)&&s.forEach((e=>Promise.resolve((()=>e(...t)))))}get firstLoginTime(){return this._fistLoginTime}set firstLoginTime(e){this._fistLoginTime=e}get isTransferAfterLogin(){return this._isTransferAfterLogin}set isTransferAfterLogin(e){this._isTransferAfterLogin=e}get eventMap(){return this._eventMap}get loaderModule(){return this._moduleLoader}get UIManager(){return this._moduleUIManager}getUserId(){const e=i.ModuleContainer.resolve(ke.a),{userId:t}=e.getSession()||{};return t||""}},Ul=s("mgoj"),kl=s("JCvM");Object(i.injectable)()(Pl=Object(ke.d)()(Pl=Object(i.singleton)(Fl.a)(Pl=function(e,t){return Object(i.inject)(Cl)(e,void 0,0)}(Pl=function(e,t){return Object(i.inject)(Ul.a)(e,void 0,1)}(Pl=Reflect.metadata("design:type",Function)(Pl=Reflect.metadata("design:paramtypes",[Object,void 0===kl.ITransferDataSuggestionUIManager?Object:kl.ITransferDataSuggestionUIManager])(Pl=class extends Nl{constructor(e,t){super(e,t),this._lastCloseBannerTimestamp=0,this.handleBeforeUnload=this.handleBeforeUnload.bind(this)}closeBannerDownloadPCSuggestion(){const e=bs.default.getTimeNow();this.lastCloseBannerTimestamp=e,this.UIManager.closeBannerDownloadPCSuggestion(),this.loaderModule.setLastCloseBannerDownloadPC(e)}getUrlDownloadPC(){return Object(jl.f)()}async initialize(){await super.initialize(),await this.loadLastCloseBannerTimestamp()}isDisplayedBannerDownloadPCSuggestion(){if(!super.isDisplayedBannerDownloadPCSuggestion())return!1;if(!this.isValidSupportDownloadPC())return!1;const e=Object(jl.e)();return this.lastCloseBannerTimestamp+e<=bs.default.getTimeNow()}isValidSupportDownloadPC(){const e=Object(El.d)().toLowerCase();return null!=Object(jl.d)().find((t=>e.indexOf(t)>-1))}isValidForTransferMessages(){return!1}onApplicationReady(e){this.isDisplayedBannerDownloadPCSuggestion()&&El.a.logAction(El.a.BannerDownloadPC.DISPLAYED),this.isEnabledFeature()&&El.a.logAction(El.a.Common.DISPLAYED_NOT_ENOUGH_DATA_MESSAGE)}handleBeforeUnload(){this.logActionBeforeUnload()}async loadLastCloseBannerTimestamp(){try{const e=await this.loaderModule.loadLastCloseBannerDownloadPC();e&&(this.lastCloseBannerTimestamp=e)}catch(e){}}logActionBeforeUnload(){const e=Object(El.b)();El.a.logActionInfo(e,!0)}registerSubscriptions(){super.registerSubscriptions(),i.ModuleContainer.resolve(ke.a).addEventListenerOnce(ke.b.BeforeUnload,this.handleBeforeUnload)}get lastCloseBannerTimestamp(){return this._lastCloseBannerTimestamp}set lastCloseBannerTimestamp(e){this._lastCloseBannerTimestamp=e}})||Pl)||Pl)||Pl)||Pl)||Pl)||Pl);var Bl,Gl=class extends wl{constructor(){super(Sl.c.UI),this.key=kl.c,this.name=kl.c,this.dataState=Object(f.a)({},Sl.f),this.UIState=Object(f.a)({},Sl.g)}closeBannerDownloadPCSuggestion(){}hideTransferMessagesModal(){}init(e){}initialize(){const{data_content:e}=Object(jl.b)(Object(jl.a)());this.handleUpdateContent(e)}getItem(e,t){return e.key===Sl.e?this.dataState:e.key===Sl.h?this.UIState:{}}getList(e,t){return[]}turnOffDisplayingEntryPoints(){this.handleUpdateRenderer({isDisplayedEntryPoints:!1})}onGetItemFailure(e,t){}onGetListFailure(e,t){}showTransferMessagesModal(){}updateDataContent(e){this.handleUpdateContent(e)}setDataState(e){const t=Object(wo.a)(this.dataState,e);this.dataState!==t&&(this.dataState=t,Object(Kt.g)(this.name,Sl.e))}setUIState(e){const t=Object(wo.a)(this.UIState,e);this.UIState!==t&&(this.UIState=t,Object(Kt.g)(this.name,Sl.h))}handleUpdateContent(e){this.setDataState((t=>{t.version=e.version,t.content=e.content}))}handleUpdateRenderer(e){this.setUIState((t=>{for(const s in e)t[s]=e[s]}))}};Object(Hs.b)(kl.b)(Bl=class extends Gl{closeBannerDownloadPCSuggestion(){this.setUIState((e=>{e[Ol.k.BANNER_DOWNLOAD].isDisplayed=!1}))}getItem(e,t){const s=super.getItem(e,t);if(!s)return;let i={};if(e.key===Ol.g){const{content:e={}}=s;for(const t in e){const s=e[t];if(s)for(const e in s){var a;i[t]||(i[t]={}),i[t][e]=null===(a=s[e])||void 0===a?void 0:a.web}}}else i=s;return i}});var xl=Object(i.define)("forward-message-pool-factory"),zl=s("oAAg");var Vl=class{createPool(e,t){return Object(zl.createPool)(e,t)}};i.ModuleContainer.register(xl,Vl);var Hl=s("iuM+"),$l=s("WOYD"),Wl=s("qWd+");function ql(e){const t={success:[],failed:[]};for(const s of e)s.success&&s.success.length&&t.success.push(...s.success),s.failed&&s.failed.length&&t.failed.push(...s.failed);return t}function Kl(e){let t=[],s=[],i="";return e.forEach((e=>{e===ms.default.sendToMeId?i=e:e.startsWith(R.GROUPID_PREFIX)?t.push(e):s.push(e)})),{groups:t,oneOnes:s,sendToMe:i}}function Zl(e,t=50){let s=[];for(let i=0;i<e.length;i+=t)s.push(e.slice(i,i+t));return s}function Ql(e,t,s,a){const{userId:n}=i.ModuleContainer.resolve(ke.a).getSession()||{};let r=Is.default.getMsgIdSendingFromCliMsgId(t),o=e.startsWith(R.GROUPID_PREFIX);const d=new ta.b(n,e,r,t,s,o,a);return sa.a.instance().isOnE2ee(e)&&(d.e2eeStatus=R.MSG_E2EE),d}var Jl=s("Eyfw");var Yl=async function(e,t,s){const i=Zi.default.getChatBoxControllerByWindowId(Qs.c);if(s.failed.length){const a=s.failed[0].error,n=s.failed[0].clientId;i._handleForwardedMessageFailure(a,{toUid:t.userId,message:e,clientId:n},t)}};const Xl={USER:3,GROUP:6,OA:5};function ec(e){let t=e;return t&&t.startsWith(R.GROUPID_PREFIX)&&(t=t.substr(R.GROUPID_PREFIX.length)),t}function tc(e,t,s){if(!(e.fromUid&&e.cliMsgId&&e.msgId&&e.sendDttm&&t))return{};if(s!==ms.default.sendToMeId)return{};let i=e.toUid||e.userId,a=function(e){if(!e)return!1;let t=e.userId||e.id;return"string"==typeof t&&!t.startsWith(R.GROUPID_PREFIX)&&e.type>=1}({userId:s})?Xl.OA:i.startsWith(R.GROUPID_PREFIX)?Xl.GROUP:Xl.USER;return{tId:ec(i),srcType:a,srcId:"0"==e.fromUid?t:e.fromUid,cmi:e.cliMsgId,gmi:e.msgId,ts:e.sendDttm+""}}function sc(e){const t=Zi.default.getChatBoxControllerByWindowId(Qs.c)._getConversationInfo(e);if(!t){if(e.startsWith(R.GROUPID_PREFIX)){return oi.default.getGroupByIdSync(e)}return zt.default.getProfileFriendByIdSync(e)}return t}var ic=async function(e,t,s){const i=(null==s?void 0:s.retry)||!1,a=i?e.cliMsgId:ea.a.next(),n=(i&&e.msgId,Jl.a.preprocessMessage(a+"",e,void 0,!1,null)),r=sc(t),o={success:[],failed:[]};try{const e=await Jl.a.forward(a+"",n,r);if(e){const s=e.msgId||e.minGlobalMsgId;o.success.push({clientId:a+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else o.failed.push({clientId:a+"",error:"invalid response",toUid:t})}catch(d){o.failed.push({clientId:a+"",error:d,toUid:t})}return Yl(n,r,o),o},ac=s("/5+7"),nc=s("sANj"),rc=s("UyAE");var oc=async function(e,t,s=[],a=!1){const n={},r={},o=a?e.msgId:"";for(let d=0;d<t.length;d++){let a=s[d]||ea.a.next();const l=t[d];n[l]=a;const c=Ql(l,a,R.MSG_FILE,Object(f.a)({},e.message));c.localPath=e.localPath,c.folderPath=e.folderPath,r[l]=c;const h=Zi.default.getChatBoxControllerByWindowId(Qs.c),u=sc(l);if(ms.default.forward_messages.enable_tracking_log){i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("forward-log",["track forward file"]).zsymb(18,"5TNEb8","call _showLocalMessage: ",JSON.stringify(c))}h._showLocalMessage(c,u,null,o,R.MSG_CHECKING_EXIST);const g=`${a}_${$e.p.getSessionUserId()}_${t[d]}`;ac.a.dispatch(nc.FileActionType.ExtraInfo,{fileKey:ac.a.getFileKey(g),extraInfo:{sendFileError:void 0}}),rc.a.set(null==a?void 0:a.toString(),{localPath:e.localPath,folderPath:e.folderPath})}return{localMsgs:r}},dc=s("D5jy");var lc=async function(e,t){const s=Zi.default.getChatBoxControllerByWindowId(Qs.c),i={};for(const a in e)e[a]&&e[a].clientId&&(i[e[a].clientId]=e[a]);t.success.length&&t.success.forEach((e=>{s&&s._sentMessage(i[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{!async function(e,t,s){const i=t.error;i===R.FORWARD_ERR_CODE.EXPIRED||i===dc.a.FILE_EXPIRED||i===R.FORWARD_ERR_CODE.SERVER_YAWNING||R.FORWARD_ERR_CODE.SEND_FAIL,s._handleForwardedMessageFailure(i,e,sc(e.conversationId))}(i[e.clientId],e,s)}))};var cc=async function(e,t,s){const i={success:[],failed:[]},a=null!=s&&s.retry?parseInt(e.cliMsgId):ea.a.next(),{localMsgs:n}=await oc(e,[t],[a],null==s?void 0:s.retry);try{const s=await ys.default.forwardMessage(t,e,a,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,n[t],null);if(s){const e=s.msgId||s.minGlobalMsgId;i.success.push({clientId:a+"",msgId:e+"",minGlobalMsgId:s.minGlobalMsgId+"",toUid:t})}else i.failed.push({clientId:a+"",error:"invalid response",toUid:t})}catch(r){i.failed.push({clientId:a+"",error:r,toUid:t})}return await lc(n,i),i},hc=function(e){return async function(e,t,s={}){const i=Wl.a.checkIsMessageFileE2ee(e),a=[];for(let n=0;n<t.length;n++){const r=sa.a.instance().isOnE2ee(t[n]);Wl.a.checkIsForwardCrossConversation(i,r)?a.push(ic(e,t[n],s)):a.push(cc(e,t[n],s))}return ql(await Promise.all(a))}(e.message,e.toUids,e.options)},uc=s("dm9D"),gc=s("iEwR");var mc=async function(e,t,s={}){const{userId:a}=i.ModuleContainer.resolve(ke.a).getSession()||{},n={},r={},o=(null==s?void 0:s.retry)||!1,d=o?e.msgId:"";for(let i=0;i<t.length;i++){let s=o?e.cliMsgId:ea.a.next();const l=t[i],c=tc(e,a||"",l);r[l]=c;const h=Ql(l,s,R.MSG_PHOTO,Object(f.a)({},e.message));h.updateMessageProp("properties",e.properties),h.updateMessageProp("localPath",e.localPath),n[l]=h;const u=Zi.default.getChatBoxControllerByWindowId(Qs.c),g=sc(l);u._showLocalMessage(h,g,null,d,R.MSG_CHECKING_EXIST)}return{localMsgs:n,additionalList:r}};var pc=async function(e,t){const s=Zi.default.getChatBoxControllerByWindowId(Qs.c),i={};for(const a in e)e[a]&&e[a].clientId&&(i[e[a].clientId]=e[a]);t.success.length&&t.success.forEach((e=>{s&&s._sentMessage(i[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{!async function(e,t,s){const i=t.error;if(i===R.FORWARD_ERR_CODE.EXPIRED||i===dc.a.FILE_EXPIRED);else{if(i===R.FORWARD_ERR_CODE.SERVER_YAWNING)return;if(i===R.FORWARD_ERR_CODE.SEND_FAIL)return}s._handleForwardedMessageFailure(i,e,sc(e.conversationId))}(i[e.clientId],e,s)}))};var fc=async function(e,t,s){const{localMsgs:a,additionalList:n}=await mc(e,t,s),r={success:[],failed:[]},o=i.ModuleContainer.resolve(gc.TAIStickerMessageAppService);for(let i=0;i<t.length;i++){const s=a[t[i]].clientId,l=Object(f.a)({},e);sa.a.instance().isOnE2ee(t[i])&&(l.e2eeStatus=R.MSG_E2EE);try{const e=await o.forwardAIStickerMessage(t[i],s,l,{retryTimeout:R.RETRY_MSG_TIMEOUT_DEFAULT,lowPriority:!1,fwAdditional:n[t[i]]});r.success.push(Object(f.a)(Object(f.a)({},e),{},{clientId:s+"",toUid:t[i]}))}catch(d){r.failed.push({clientId:s+"",error:d,toUid:t[i]})}}return await pc(a,r),r},vc=s("Ullg");var bc=async function(e,t,s){const{localMsgs:i,additionalList:a}=await mc(e,t,s),n={success:[],failed:[]};for(let o=0;o<t.length;o++){const s=t[o],d=i[s].clientId,l=Object(f.a)({},e);sa.a.instance().isOnE2ee(s)&&(l.e2eeStatus=R.MSG_E2EE);try{const e=await vc.a.Helper.forwardPhotoSticker(s,l,d,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,a[s]);n.success.push(Object(f.a)(Object(f.a)({},e),{},{toUid:s,clientId:d+""}))}catch(r){n.failed.push({clientId:d+"",error:r,toUid:s})}}return await pc(i,n),n};var yc=async function(e,t,s){const a=(null==s?void 0:s.retry)||!1?e.cliMsgId:ea.a.next(),n=Jl.a.preprocessMessage(a+"",e,s.photoBundle),r=sc(t),o=async function(e,t){const{userId:s}=i.ModuleContainer.resolve(ke.a).getSession()||{};return tc(e,s||"",t)}(e,t),d={success:[],failed:[]};try{const e=await Jl.a.forward(a+"",n,r,o);if(e){let s=e.msgId||e.minGlobalMsgId;d.success.push({clientId:a+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else d.failed.push({clientId:a+"",error:"invalid response",toUid:t})}catch(l){d.failed.push({clientId:a+"",error:l,toUid:t})}return Yl(n,r,d),d};var Ic=async function(e,t,s){var i;const a={success:[],failed:[]};let n=Is.default.safeParseJson(null==e||null===(i=e.message)||void 0===i?void 0:i.params)||{};null!=n&&n.group_layout_id&&(delete n.group_layout_id,delete n.id_in_group,delete n.is_group_layout,delete n.total_item_in_group),s.photoBundle&&Object.assign(n,{is_group_layout:1,group_layout_id:s.photoBundle.groupLayoutId,id_in_group:s.photoBundle.idInGroup,total_item_in_group:s.photoBundle.totalItemInGroup});const r=Object(f.a)({},e.message);r.params=JSON.stringify(n);const o=Object(f.a)(Object(f.a)({},e),{},{message:r}),{localMsgs:d,additionalList:l}=await mc(o,[t],s),c=d[t].clientId+"";try{let i=!1;s.photoBundle&&(i=Object(f.a)(Object(f.a)({},s.photoBundle),{},{clientId:c}));const n=await ys.default.forwardMessage(t,Object(f.a)(Object(f.a)({},e),{},{message:r,forwardInGroup:i}),c,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,d[t],l[t]);if(n){let e=n.msgId||n.minGlobalMsgId;a.success.push({clientId:c,msgId:e+"",minGlobalMsgId:n.minGlobalMsgId+"",toUid:t,thumbUrl:n.thumbUrl,oriUrl:n.oriUrl||n.hdUrl||n.rawUrl,hdUrl:n.hdUrl})}else a.failed.push({clientId:c,error:"invalid response",toUid:t})}catch(h){a.failed.push({clientId:c,error:h,toUid:t})}return await pc(d,a),a};var _c=async function(e,t,s){const i=Wl.a.checkIsMessageFileE2ee(e),a=[];for(let n=0;n<t.length;n++){const r=sa.a.instance().isOnE2ee(t[n]);Wl.a.checkIsForwardCrossConversation(i,r)?a.push(yc(e,t[n],s)):a.push(Ic(e,t[n],s))}return ql(await Promise.all(a))},Cc=function(e){return async function(e,t,s={}){return Object(uc.a)(e)?await fc(e,t,s):Is.default.isPhotoStickerMessage(e)?await bc(e,t,s):await _c(e,t,s)}(e.message,e.toUids,e.options)};var Oc=async function(e,t,s){const i={success:[],failed:[]},a=(null==s?void 0:s.retry)||!1?e.cliMsgId:ea.a.next(),n=Jl.a.preprocessMessage(a+"",e,s.photoBundle),r=sc(t);try{const e=await Jl.a.forward(a+"",n,r);if(e){const s=e.msgId||e.minGlobalMsgId;i.success.push({clientId:a+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else i.failed.push({clientId:a+"",error:"invalid response",toUid:t})}catch(o){i.failed.push({clientId:a+"",error:o,toUid:t})}return Yl(n,r,i),i};var Sc=async function(e,t,s){const i=(null==s?void 0:s.retry)||!1,a=i?e.msgId:"",n=i?e.cliMsgId:ea.a.next(),r=Jl.a.preprocessMessage(n+"",e,s.photoBundle),o=Ql(t,n,R.MSG_VIDEO,Object(f.a)({},r.message));o.localPath=e.localPath;const d=Zi.default.getChatBoxControllerByWindowId(Qs.c),l=sc(t);return d._showLocalMessage(o,l,null,a,R.MSG_CHECKING_EXIST),[o,r]};var Ec=async function(e,t){const s=Zi.default.getChatBoxControllerByWindowId(Qs.c),i={};for(const a in e)e[a]&&e[a].clientId&&(i[e[a].clientId]=e[a]);t.success.length&&t.success.forEach((e=>{s&&s._sentMessage(i[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{!async function(e,t,s){const i=t.error;i===R.FORWARD_ERR_CODE.EXPIRED||i===dc.a.FILE_EXPIRED||i===R.FORWARD_ERR_CODE.SERVER_YAWNING||R.FORWARD_ERR_CODE.SEND_FAIL,s._handleForwardedMessageFailure(i,e,sc(e.conversationId))}(i[e.clientId],e,s)}))};var Mc=async function(e,t,s){const i={success:[],failed:[]},[a,n]=await Sc(e,t,s),r=a.clientId+"";let o=!1;s.photoBundle&&(o=Object(f.a)(Object(f.a)({},s.photoBundle),{},{clientId:r}));try{const e=await ys.default.forwardMessage(t,n,r,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,a,null);if(e){const s=e.msgId||e.minGlobalMsgId;i.success.push({clientId:r,msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t,_msgObject:e._msgObject||null})}else i.failed.push({clientId:r,error:"invalid response",toUid:t})}catch(d){i.failed.push({clientId:r,error:d,toUid:t})}return await Ec({[t]:a},i),i};var Tc=async function(e,t,s={}){const i=[];for(let a=0;a<t.length;a++){const n=t[a],r=sa.a.instance().isOnE2ee(n),o=Wl.a.checkIsMessageFileE2ee(e);Wl.a.checkIsForwardCrossConversation(o,r)?i.push(Oc(e,t[a],s)):i.push(Mc(e,t[a],s))}return ql(await Promise.all(i))};var wc=async function(e){return Tc(e.message,e.toUids,e.options)};var Rc=async function(e,t,s={}){const i=e.message,a=[];for(let n=0;n<t.length;n++){const e=t[n];let r=ea.a.next();for(let t=0;t<i.length;t++){const n=i[t],o={isGroupLayout:1,groupLayoutId:r,totalItemInGroup:i.length,idInGroup:t};s.photoBundle=o,n.msgType===R.MSG_VIDEO?a.push(wc({message:n,toUids:[e],options:s})):a.push(Cc({message:n,toUids:[e],options:s}))}}return ql(await Promise.all(a))},Lc=function(e){return Rc(e.message,e.toUids,e.options)},Fc=s("Hllb"),Dc=s("KZut"),Ac=s("nWXR");var jc=async function(e,t,s={}){var i;const a=e.message&&"object"==typeof e.message&&"rtf"===e.message.action,n=Is.default.getSubtypeMessage(e);let r=null;const o=(null==s?void 0:s.retry)||!1,d=o?e.msgId:"",l={},c={};let h=Is.default.ZSafeFunction((()=>-1==n||n==R.MSG_SUBTYPE_LINK||a?Is.default.stripInvalidChar(e.message):e.message&&"object"==typeof e.message?e.message.title:""),"");if(!h)throw Object(Fc.createForwardError)("Empty message",Fc.ForwardErrorCode.EmptyString,e);let u=di.b.findFirstUrl(h,!0,!1);u&&Dc.a.checkValidSuffix(u)&&e.shouldParseLinkOrContact&&(e.containType=2),a&&"object"==typeof e.message&&null!==(i=e.message)&&void 0!==i&&i.params&&(l.rtfProps=function(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return""}}(e.message.params),l.styles=l.rtfProps);for(let g=0;g<t.length;g++){const s=t[g];const i=Ql(s,(o?e.cliMsgId:ea.a.next())+"",R.MSG_TEXT);a&&"object"==typeof e.message?(i.updateMessageContentProp(ta.a.RTF,e.message),i.updateMessageContentProp(ta.a.TEXT,e.message.title)):i.updateMessageContentProp(ta.a.TEXT,h),e.containType&&(i.containType=e.containType,i.shouldParseLinkOrContact=e.shouldParseLinkOrContact),c[s]=i;const n=Zi.default.getChatBoxControllerByWindowId(Qs.c),l=sc(s);if(n._showLocalMessage(i,l,null,d),u&&e.shouldParseLinkOrContact){const t=Ac.c.create(u).withTimeout(Ds.a.ParserConfig.get("max_delay_send_message"));Ds.a.ParserConfig.get("enable_upload_thumb_for_delay_send")?t.do("full-process",[Ac.a.SHARE_MESSAGE,s]):t.do("parse",[Ac.a.SHARE_MESSAGE]);const a=await t.exec().toPromise();a&&(i.type=R.MSG_LINK_CLIENT,i.updateMessageContentProp(ta.a.LINK,Object(f.a)({},a)),c[s]=i,r=i.convertToUIMessageObject(),n._showLocalMessage(i,l,null,d)),Ac.b.getInstance().report({key:null==e?void 0:e.msgId,href:u,entry:Ac.a.SHARE_MESSAGE,preview:a})}}return{localMsgs:c,additional:l,updatedForwardMsgItem:r}};async function Pc(e,t){const s=Zi.default.getChatBoxControllerByWindowId(Qs.c),i={};for(const a in e)e[a]&&e[a].clientId&&(i[e[a].clientId]=e[a]);t.success.length&&t.success.forEach((e=>{s&&s._sentMessage(i[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{if(s){const t=i[e.clientId],a=t.conversationId;mt.default.deleteMessageById(Is.default.getMsgIdSendingFromCliMsgId(e.clientId),a),s._handleForwardedMessageFailure(e.error,t,sc(a))}}))}const Nc={USER:3,GROUP:6,OA:5};function Uc(e){let t=e;return t&&t.startsWith(R.GROUPID_PREFIX)&&(t=t.substr(R.GROUPID_PREFIX.length)),t}function kc(e,t){if(!(t&&e.fromUid&&e.cliMsgId&&e.msgId&&e.sendDttm))return{};let s=e.toUid||t,i=Nc.USER;s.startsWith(R.GROUPID_PREFIX)?i=Nc.GROUP:function(e){if(!e)return!1;const t=zt.default.getProfileFriendSync(e);return t&&t.type>=1}(t)&&(i=Nc.OA);let a=e.fromUid;return"0"==a&&(a=zt.default.getProfileMeSync().userId),{tId:Uc(s),srcType:i,srcId:a,cmi:e.cliMsgId,gmi:e.msgId+"",ts:e.sendDttm}}async function Bc(e,t,s){const i=ms.default.sendToMeId||"";let a=kc(e,i),n=s?Object(f.a)(Object(f.a)({},s),a):a,r=t.clientId;const o={success:[],failed:[]};try{const t=await ys.default.forwardMultiMessage([{clientId:r,toUid:i}],e,!1,1e4,!1,n);t.success&&t.success.length&&t.success.forEach((e=>{o.success.push(Object(f.a)(Object(f.a)({},e),{},{toUid:i}))})),t.failed&&t.failed.length&&t.failed.forEach((e=>{o.failed.push(Object(f.a)(Object(f.a)({},e),{},{toUid:i}))}))}catch(d){o.failed.push({clientId:""+r,error:d,toUid:i})}return o}async function Gc(e,t,s,i){const a=[],n=[],r={success:[],failed:[]};if(t.forEach((e=>{const t=oi.default.getGroupByIdSync(e);var i;t&&t.totalMember>=ms.default.forward_group_limit_mem?n.push(e):a.push({clientId:(null===(i=s[e])||void 0===i?void 0:i.clientId)||ea.a.next(),grid:Uc(e)})})),n.length)for(let d=0;d<n.length;d++){const e=n[d];try{const t=await ys.default.sendMsgObject(s[e],null,null,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,i);r.success.push({clientId:s[e].clientId,msgId:t.msgId,toUid:R.GROUPID_PREFIX+e})}catch(o){r.failed.push({clientId:s[e].clientId,error:o,toUid:R.GROUPID_PREFIX+e})}}if(a.length){const t=Zl(a),s={};a.forEach((e=>{s[e.clientId]=e.grid}));try{for(let a=0;a<t.length;a++){const n=await ys.default.forwardMultiMessage(t[a],e,!0,1e4,!1,i);n.success&&n.success.length&&n.success.forEach((e=>{r.success.push(Object(f.a)(Object(f.a)({},e),{},{toUid:R.GROUPID_PREFIX+s[e.clientId]}))})),n.failed&&n.failed.length&&n.failed.forEach((e=>{r.failed.push(Object(f.a)(Object(f.a)({},e),{},{toUid:R.GROUPID_PREFIX+s[e.clientId]}))}))}}catch(o){for(let e=0;e<a.length;e++)r.failed.push({clientId:""+a[e].clientId,error:o,toUid:R.GROUPID_PREFIX+a[e].grid})}}return r}async function xc(e,t,s,i){const a=[];t.forEach((e=>{var t;a.push({clientId:(null===(t=s[e])||void 0===t?void 0:t.clientId)||ea.a.next(),toUid:e})}));const n={success:[],failed:[]},r=Zl(a),o={};a.forEach((e=>{o[e.clientId]=e.toUid}));for(let l=0;l<r.length;l++){const t=r[l];try{const s=await ys.default.forwardMultiMessage(t,e,!1,1e4,!1,i);s.success&&s.success.length&&s.success.forEach((e=>{n.success.push(Object(f.a)(Object(f.a)({},e),{},{toUid:o[e.clientId]}))})),s.failed&&s.failed.length&&s.failed.forEach((e=>{n.failed.push(Object(f.a)(Object(f.a)({},e),{},{toUid:o[e.clientId]}))}))}catch(d){for(let e=0;e<t.length;e++)n.failed.push({clientId:""+t[e].clientId,error:d,toUid:t[e].toUid})}}return n}var zc=async function(e,t,s={}){const{groups:i,oneOnes:a,sendToMe:n}=Kl(t),{localMsgs:r,additional:o,updatedForwardMsgItem:d}=await jc(e,t,s),l=d||e,c=[];if(n){const e=await Bc(l,r[n],o);c.push(e)}if(i.length){const e=await Gc(l,i,r,o);c.push(e)}if(a.length){const e=await xc(l,a,r,o);c.push(e)}const h=({success:[],failed:[]}=ql(c));return await Pc(r,h),h};var Vc=async function(e){return zc(e.message,e.toUids,e.options)};var Hc=async function(e,t,s={}){const a={},n={},{userId:r}=i.ModuleContainer.resolve(ke.a).getSession()||{},o=Zi.default.getChatBoxControllerByWindowId(Qs.c),d=(null==s?void 0:s.retry)||!1,l=d?e.msgId:"";for(let i=0;i<t.length;i++){const s=t[i];const a=Ql(s,d?e.cliMsgId:ea.a.next(),R.MSG_STICKER);a.updateMessageContentProp(ta.a.STICKER,e.message),n[s]=a;const r=sc(s);o._showLocalMessage(a,r,null,l)}for(let i=0;i<t.length;i++){const s=tc(e,r||"",t[i]);a[t[i]]=s}return{localMsgs:n,additionalList:a}};var $c=async function(e,t,s={}){const{groups:i,oneOnes:a,sendToMe:n}=Kl(t),{localMsgs:r,additionalList:o}=await Hc(e,t,s),d=[];if(n){const t=await Bc(e,r[n]);d.push(t)}if(i.length){const t=await Gc(e,i,r);d.push(t)}if(a.length){const t=await xc(e,a,r);d.push(t)}const l=({success:[],failed:[]}=ql(d));return await Pc(r,l),l};var Wc=async function(e){return $c(e.message,e.toUids,e.options)};var qc=async function(e,t,s={}){const[i,a]=di.b.shouldReparseLink(e),n=Zi.default.getChatBoxControllerByWindowId(Qs.c),r=(null==s?void 0:s.retry)||!1,o=r?e.msgId:"";let d={localMsgs:{},preview:null};d=i&&s.isForwardSingleMsg?await async function(e,t,s,i){var a;const n=di.b.isLongUrl(e||""),r=Ds.a.LinkPreviewRespository.getKey("meta-data",[e]),o=null===(a=Ds.a.LinkPreviewRespository.metaData.get(r))||void 0===a?void 0:a.value,d={localMsgs:{},preview:null};for(let g=0;g<s.length;g++){const a=s[g],r=Ql(a,i?t.cliMsgId:ea.a.next(),R.MSG_LINK_CLIENT);o&&!n?(r.updateMessageContentProp(ta.a.TEXT,t.message.title),r.updateMessageContentProp(ta.a.LINK,o)):(r.updateMessageContentProp(ta.a.TEXT,t.message.title||t.message.href),r.type=R.MSG_TEXT);let m=new Promise((e=>e(null)));if(n){Ac.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Ac.a.SHARE_MESSAGE,preview:null}),d.localMsgs[a]=r;continue}if(o){let t=!1;const s=Ac.c.create(e);if(Ds.a.ParserConfig.get("enable_upload_thumb_for_delay_send")){var l,c;const i=Ds.a.LinkPreviewRespository.getKey("meta-data",[e]);t=!(null===(l=Ds.a.LinkPreviewRespository.metaData.get(i))||void 0===l||null===(c=l.value)||void 0===c||!c.thumbOrigin),t&&s.do("download-thumb")}else{var h,u;const s=Ds.a.LinkPreviewRespository.getKey("thumb-local",[e]);t=!(null===(h=Ds.a.LinkPreviewRespository.thumbLocal.get(s))||void 0===h||null===(u=h.value)||void 0===u||!u.thumbLocal)}t&&(m=s.do("upload-thumb",[a]).exec().toPromise())}else if(null!==o){const t=Ac.c.create(e).withTimeout(Ds.a.ParserConfig.get("max_delay_send_message"));Ds.a.ParserConfig.get("enable_upload_thumb_for_delay_send")?t.do("full-process",[Ac.a.SHARE_MESSAGE,a]):t.do("parse",[Ac.a.SHARE_MESSAGE]),m=t.exec().toPromise()}const p=await m;Ac.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Ac.a.SHARE_MESSAGE,preview:p}),p&&(r.type=R.MSG_LINK_CLIENT,r.updateMessageContentProp(ta.a.LINK,Br.e.clone(p)),d.preview=p),d.localMsgs[a]=r}return d}(a||"",e,t,r):await async function(e,t,s,i){const a={localMsgs:{},preview:null},n=di.b.isLongUrl(e||""),[,r]=Br.e.safeParseJson(t.message.params);for(let o=0;o<s.length;o++){const d=i?t.cliMsgId:ea.a.next(),l=s[o],c=Ql(l,d,R.MSG_TEXT);n||(c.type=R.MSG_LINK_CLIENT,c.updateMessageContentProp(ta.a.LINK,{width:r.width,height:r.height,desc:t.message.description,href:t.message.href,src:r.src,media:r,thumb:t.message.thumb,title:r.mediaTitle})),Ac.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Ac.a.SHARE_MESSAGE,preview:null}),t.message.title&&c.updateMessageContentProp("text",t.message.title),a.localMsgs[l]=c}return a}(a||"",e,t,r);for(let l in d.localMsgs){const e=d.localMsgs[l],t=sc(l);n._showLocalMessage(e,t,null,o)}return d};var Kc=async function(e,t,s={}){const{localMsgs:i,preview:a}=await qc(e,t,s),n=Object(f.a)({},e);if(a){var r;const t=a.media||{};let s="";Object.keys(t).length>0?s=JSON.stringify(t):(s=e.message.params,"string"!=typeof s&&(s=JSON.stringify(s))),n.message={action:"recommened.link",childnumber:0,description:a.desc||"",href:a.href,params:s,thumb:a.thumb||"",title:e.message.title,type:(null===(r=a.media)||void 0===r?void 0:r.type)||""}}const{groups:o,oneOnes:d,sendToMe:l}=Kl(t),c=[];if(l){const e=await Bc(n,i[l]);c.push(e)}if(o.length){const e=await Gc(n,o,i);c.push(e)}if(d.length){const e=await xc(n,d,i);c.push(e)}const h=({success:[],failed:[]}=ql(c));return await Pc(i,h),h};var Zc=async function(e){return Kc(e.message,e.toUids,e.options)};var Qc=async function(e,t,s){const i={localMsgs:{}},a=Zi.default.getChatBoxControllerByWindowId(Qs.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"";for(let o=0;o<t.length;o++){const s=t[o];const d=Ql(s,(n?e.cliMsgId:ea.a.next())+"",e.msgType,e.message);i.localMsgs[s]=d;const l=sc(s);a._showLocalMessage(d,l,null,r)}return i};var Jc=async function(e,t,s={}){const{localMsgs:i}=await Qc(e,t,s),a={success:[],failed:[]};for(let r=0;r<t.length;r++){const s=t[r],o=i[s];try{const i=await ys.default.forwardMessage(t[r],e,o.clientId,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,o,null);a.success.push({clientId:o.clientId+"",msgId:(i.msgId||i.minGlobalMsgId)+"",minGlobalMsgId:i.minGlobalMsgId+"",toUid:s})}catch(n){a.failed.push({clientId:o.clientId+"",error:n,toUid:s})}}return await Pc(i,a),a};var Yc=async function(e){return Jc(e.message,e.toUids,e.options)};var Xc=async function(e,t,s={}){const i=[];for(let n=0;n<t.length;n++){const r={success:[],failed:[]},o=s.retry?e.cliMsgId:ea.a.next(),d=Jl.a.preprocessMessage(o+"",e,null),l=sc(t[n]);try{const e=await Jl.a.forward(o+"",d,l);e?r.success.push({clientId:o+"",msgId:(e.msgId||e.minGlobalMsgId)+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t[n]}):r.failed.push({clientId:o+"",error:"invalid response",toUid:t[n]})}catch(a){r.failed.push({clientId:o+"",error:a,toUid:t[n]})}Yl(d,l,r),i.push(r)}return ql(i)};var eh=async function(e){return Xc(e.message,e.toUids,e.options)};var th=async function(e,t,s={}){const i={},a=Zi.default.getChatBoxControllerByWindowId(Qs.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"";for(let o=0;o<t.length;o++){const s=t[o];const d=Ql(s,n?e.cliMsgId:ea.a.next(),R.MSG_GIF);let{oriUrl:l,normalUrl:c,params:h}=e.message;if(h){let e=ac.a.utils.safeParseJSON(h);const{width:t=0,height:s=0}=e,i={};l&&(i.original={width:t,height:s,url:l}),c&&(i.normal={width:t,height:s,url:c}),d.updateMessageContentProp(ta.a.GIF,i)}i[s]=d;const u=sc(s);a._showLocalMessage(d,u,null,r)}return{localMsgs:i}};var sh=async function(e,t,s={}){const i={success:[],failed:[]},{localMsgs:a}=await th(e,t,s);for(let r=0;r<t.length;r++){const s=t[r],o=a[s];try{const t=await ys.default.forwardMessage(s,e,o.clientId,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,o,null);t?i.success.push({clientId:o.clientId+"",msgId:(t.msgId||t.minGlobalMsgId)+"",minGlobalMsgId:t.minGlobalMsgId+"",toUid:s}):i.failed.push({clientId:o.clientId+"",error:"invalid response",toUid:s})}catch(n){i.failed.push({clientId:o.clientId+"",error:n,toUid:s})}}return await Pc(a,i),i};var ih=async function(e){return sh(e.message,e.toUids,e.options)};var ah=async function(e,t,s,i={}){const{localMsgs:a,additionalList:n}=s,r={success:[],failed:[]};for(let d=0;d<t.length;d++){const s=t[d],i=a[s];try{const a=await ys.default.forwardMessage(t[d],e,i.clientId,R.RETRY_MSG_TIMEOUT_DEFAULT,!1,i,n[s]);r.success.push({clientId:i.clientId+"",msgId:(a.msgId||a.minGlobalMsgId)+"",minGlobalMsgId:a.minGlobalMsgId+"",toUid:s})}catch(o){r.failed.push({clientId:i.clientId+"",error:o,toUid:s})}}return r};var nh=class{constructor(e,t,s){this.message=e,this.toUids=t,this.options=s,this.preprocessResult=void 0,this.result=void 0,this.preprocessResult={},this.result={success:[],failed:[]}}async execute(){return this.preprocessResult=await this.preprocess(),this.result=await this.process(),this.postprocess(),this.result}};var rh=async function(e,t,s){const i={localMsgs:{},additionalList:{}},a=Zi.default.getChatBoxControllerByWindowId(Qs.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"";for(let o=0;o<t.length;o++){const s=t[o];const d=Ql(s,(n?e.cliMsgId:ea.a.next())+"",e.msgType,e.message);i.localMsgs[s]=d;const l=sc(s);a._showLocalMessage(d,l,null,r)}return i};class oh extends nh{async preprocess(){return rh(this.message,this.toUids,this.options)}async process(){return ah(this.message,this.toUids,this.preprocessResult,this.options)}async postprocess(){return Pc(this.preprocessResult.localMsgs,this.result)}}var dh=async function(e){return new oh(e.message,e.toUids,e.options).execute()};$l.a.registerHandler(Hl.a.PHOTO,Cc),$l.a.registerHandler(Hl.a.FILE,hc),$l.a.registerHandler(Hl.a.VIDEO,wc),$l.a.registerHandler(Hl.a.TEXT,Vc),$l.a.registerHandler(Hl.a.STICKER,Wc),$l.a.registerHandler(Hl.a.LINK,Zc),$l.a.registerHandler(Hl.a.CONTACT,Yc),$l.a.registerHandler(Hl.a.VOICE,eh),$l.a.registerHandler(Hl.a.GIF,ih),$l.a.registerHandler(Hl.a.GROUP_PHOTO,Lc),$l.a.registerHandler(Hl.a.DEFAULT,dh);class lh{constructor(e){this._state=lh.PENDING,this._resolve=void 0,this._reject=void 0,this._promise=void 0,this._reject=void 0,this._promise=new e(((e,t)=>{this._resolve=e,this._reject=t}))}reject(e){this._state===lh.PENDING&&(this._state=lh.REJECTED,this._reject(e))}resolve(e){this._state===lh.PENDING&&(this._state=lh.FULFILLED,this._resolve(e))}get state(){return this._state}get promise(){return this._promise}}lh.PENDING="PENDING",lh.FULFILLED="FULFILLED",lh.REJECTED="REJECTED";var ch=lh;const hh={cancelledReason:"Task cancelled",timeoutReason:"Task timeout"};class uh extends ch{constructor(e,t=void 0,s=hh){super(Promise),this.executor=e,this.ttl=t,this.options=s,this._events=new Map,this._creationTimestamp=0,this._timeout=0,this.creationTimestamp=performance.now(),this.timeout=0,void 0!==t&&this.setTimeout()}addEventListener(e,t){let s=this.events.get(e);s||(s=[],this.events.set(e,s)),s.push(t)}cancel(){this.reject(this.getOptions().cancelledReason)}execute(...e){return this.executor.apply(this,e).then(this.resolve.bind(this)).catch(this.reject.bind(this)),this.promise}removeEventListener(e,t){const s=this.events.get(e);if(!s)return;this.events.set(e,s.filter((e=>e!==t)))}getOptions(){return Object(f.a)(Object(f.a)({},hh),this.options)}removeTimeout(){this.timeout&&clearTimeout(this.timeout),this.timeout=0}setTimeout(){if(this.state!==uh.PENDING)return;if(isNaN(this.ttl)||this.ttl<=0)throw new Error("delay must be a positive int");const e=performance.now()-this.creationTimestamp;this.timeout&&this.removeTimeout(),this.timeout=window.setTimeout((()=>this.reject(this.getOptions().timeoutReason)),Math.max(this.ttl-e,0))}get events(){return this._events}get creationTimestamp(){return this._creationTimestamp}set creationTimestamp(e){this._creationTimestamp=e}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var gh=uh,mh=s("gOiJ"),ph=s("1OYu");var fh=function(e){const t=e.msgType;return t===R.MSG_PHOTO_GROUP?[Hl.a.GROUP_PHOTO,$l.a.getHandler(Hl.a.GROUP_PHOTO)]:t===R.MSG_PHOTO||t===R.MSG_PHOTO_2||t===R.MSG_DOODLE?[Hl.a.PHOTO,$l.a.getHandler(Hl.a.PHOTO)]:t===R.MSG_FILE?[Hl.a.FILE,$l.a.getHandler(Hl.a.FILE)]:t===R.MSG_VIDEO?[Hl.a.VIDEO,$l.a.getHandler(Hl.a.VIDEO)]:t===R.MSG_TEXT?[Hl.a.TEXT,$l.a.getHandler(Hl.a.TEXT)]:t===R.MSG_STICKER?[Hl.a.STICKER,$l.a.getHandler(Hl.a.STICKER)]:t===R.MSG_CONTACT&&"recommened.link"==e.message.action||"link"===e.type?[Hl.a.LINK,$l.a.getHandler(Hl.a.LINK)]:t!==R.MSG_CONTACT||"recommened.user"!=e.message.action&&"recommened.vip"!=e.message.action?t===R.MSG_VOICE?[Hl.a.VOICE,$l.a.getHandler(Hl.a.VOICE)]:t===R.MSG_GIF?[Hl.a.GIF,$l.a.getHandler(Hl.a.GIF)]:[Hl.a.DEFAULT,$l.a.getHandler(Hl.a.DEFAULT)]:[Hl.a.CONTACT,$l.a.getHandler(Hl.a.CONTACT)]};var vh,bh=class{constructor(e,t){this.messages=e,this.toUids=t,this.startTime=0,this._Logger=void 0}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("forward-log",["track forward message"])),this._Logger}startForward(){this.startTime=performance.now()}endForward(e){for(let t=0;t<e.length;t++)this.logForMsg(this.messages[t],e[t]);this.logForwardDone()}logForwardDone(){let e=0,t=0,s=0,i=0;for(let a=0;a<this.toUids.length;a++){const n=this.toUids[a];n.startsWith(R.GROUPID_PREFIX)?e++:n===ms.default.sendToMeId?i++:(t++,zt.default.isFriend(n)||s++)}for(let a=0;a<this.messages.length;a++){const n=this.messages[a];Vt.default.logActionInfoV2(Vt.FeaturesInfo.ForwardMessage,0,{src_id:n.toUid||n.userId,msgType:n.msgType,gapTime:Date.now()-+n.sendDttm,duration:performance.now()-this.startTime,totalConv:this.toUids.length,chatgroup:e,chat11:t,stranger:s,mycloud:i})}}logForMsg(e,t){t.success.length>0&&this.logSuccess(e,t.success),t.failed.length>0&&this.logFail(e,t.failed)}logSuccess(e,t){}logFail(e,t){const s=e.toUid||e.userId,i=sa.a.instance().isOnE2ee(s);for(let a=0;a<t.length;a++){const{error:n,toUid:r}=t[a],o=sa.a.instance().isOnE2ee(r);let d=0;d=i||o?i&&o?1:2:0;let l=1;r.startsWith(R.GROUPID_PREFIX)?l=2:r===ms.default.sendToMeId&&(l=3);let c=0;c="string"==typeof n||"number"==typeof n?n:(null==n?void 0:n.code)||(null==n?void 0:n.errorCode)||(null==n?void 0:n.error_code);const h={fail_error:c,e2ee:d,msgtype:e.msgType,src_id:s,chat_type:l,duration:performance.now()-this.startTime,number_conversation:this.toUids.length};ms.default.forward_messages.enable_tracking_log?this.Logger.zsymb(21,"GsBH0V",["forwardMessageFromLocal fail : {} {}","IloIKk"],JSON.stringify(h),e):this.Logger.zsymb(21,"5dzS8S",["forwardMessageFromLocal fail : {}","fK11AI"],JSON.stringify(h)),Vt.default.logActionInfoV2(Vt.FeaturesInfo.ForwardMsgFail,0,h)}}};Object(i.injectable)()(vh=Object(i.singleton)(ph.a)(vh=function(e,t){return Object(i.inject)(xl)(e,void 0,0)}(vh=Reflect.metadata("design:type",Function)(vh=Reflect.metadata("design:paramtypes",[Object])(vh=class{constructor(e){this.poolFactory=e,this._pool=void 0}async forwardMessages(e,t,s={}){this.pool||this.initializePool(),e.forEach((e=>{e.toUid||(e.toUid=e.userId)}));const i=this.buildTask(e,t,s||{});return this.pool.use(i).then((e=>Promise.resolve(e)))}async retryForwardMessages(e,t={}){const s=Object(f.a)(Object(f.a)({},t),{},{retry:!0});this.pool||this.initializePool();const i=e.map((e=>e.toUid)),a=this.buildTask(e,i,s);return this.pool.use(a).then((e=>Promise.resolve(e)))}buildTask(e,t,s){return async()=>{try{return await this.runTaskInSerialization(e,t,s)}catch(i){return Promise.reject(i)}}}cleanUp(){this.pool&&this.pool.drain(),this.pool=void 0}initializePool(){const e={max:Object(mh.getMaximumPoolSize)(),min:Object(mh.getMinimumPoolSize)(),autostart:!0};this.pool=this.poolFactory.createPool({create:async()=>({}),destroy:async()=>{}},e)}async runSubTask(e,t,s){const[i,a]=fh(e);if(null==a)return Promise.reject("Invalid handler");try{const i=new gh(a,Object(mh.getForwardMessageTaskTimeout)());return await i.execute({message:e,toUids:t,options:s})}catch(n){return Promise.reject(n)}}async runTaskInSerialization(e,t,s){const i=[];e.forEach((e=>{i.push(this.runSubTask.bind(null,Object(f.a)(Object(f.a)({},e),{},{mentions:null}),t,s))}));const a=new bh(e,t);a.startForward();const n=await async function(e){if(!Array.isArray(e))return Promise.reject("Params functions is invalid");const t=[...e],s=[];for(const a of t)try{const e=await a();s.push({isSuccess:!0,data:e})}catch(i){s.push({isSuccess:!1,error:i})}return s}(i);try{const e=n.map(((e,t)=>e.data));a.endForward(e)}catch(o){}const r=n.map(((t,s)=>({id:e[s].msgId,isSuccess:t.isSuccess,data:t.data,error:t.error})));return Promise.resolve(r)}get pool(){return this._pool}set pool(e){this._pool=e}})||vh)||vh)||vh)||vh);var yh=Object(i.define)("pin-topic-message-loader");var Ih=Object(i.define)("pin-topic-storage"),_h=Ih,Ch=s("UIHX"),Oh=s("0URt"),Sh=s("DRpF");function Eh(e){return!(-1===Object(Oh.g)().indexOf(e.msgType))&&!Object(Sh.a)(e)}var Mh=s("3ZdV");var Th=s("YYsv");function wh(e,t,s){return s===e?1:s<t?0:-1}function Rh(e){const t={needFetch:!1,reason:""};if(null==e||null==e||!e.lastFetch)return t.needFetch=!0,t.reason="empty",t;const{lastFetch:s}=e,i=function(e){return No.a.isOverflowAtTime(e)}(s);if(i)return t.needFetch=!0,t.reason="overflow",t;const a=function(e){return Date.now()-e>Object(Mh.e)()}(s);if(a)return t.needFetch=!0,t.reason="expired",t;const n=function(e){const t=S.default.getInstance().getItemForCurrentUser(Th.g.FORCE_FETCH_MILESTONE);return!(!t||isNaN(+t))&&e<+t}(s);return n?(t.needFetch=!0,t.reason="forcedByServer",t):t}function Lh(e){const t=[];return e.forEach((e=>{t.push({topicId:e.id,topicType:e.type})})),t}function Fh(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.client_msg_id)||""}function Dh(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.global_msg_id)||""}function Ah(e,t,s){let i=t;const{topics:a}=s;if(!Array.isArray(a))return i;switch(e){case Ch.a.ADD:{const{index:e}=s;i=null==e?[...a,...t]:[...t.slice(0,e),...a,...t.slice(e)];break}case Ch.a.REMOVE:{const e={};a.forEach((t=>{e[t.id]=t.type})),i=[],t.forEach((t=>{(!e.hasOwnProperty(t.id)||e.hasOwnProperty(t.id)&&e[t.id]!==t.type)&&i.push(t)}));break}}return i}function jh(e){const t=e=>{if(!Array.isArray(e))return e;const t=[];for(let s=0;s<e.length;s++){const i=e[s];i&&(null!=i.id&&(i.id=i.id.toString()),null!=i.topicId&&(i.topicId=i.topicId.toString()),null!=i.type&&(i.type=parseInt(i.type)),null!=i.topicType&&(i.topicType=parseInt(i.topicType)),t.push(i))}return t},s=Object(f.a)({},e);return null!=s.oldTopic&&(s.oldTopic=t([s.oldTopic])[0]),null!=s.topic&&(s.topic=t([s.topic])[0]),null!=s.topics&&(s.topics=t(s.topics)),s}function Ph(e){let t={};if(!e.params)return e;try{t=JSON.parse(e.params)}catch(s){return}if(t.extra&&t.extra.constructor===String)try{t.extra=JSON.parse(t.extra)}catch(s){return}return e.params=t,e}var Nh,Uh=function(){const e={};return{clear:()=>{for(const t in e)delete e[t]},get:t=>e[t],getCache:()=>e,set:(t,s)=>{e[t]=s},has:t=>e.hasOwnProperty(t),remove:t=>{delete e[t]}}};var kh=Object(i.injectable)()(Nh=function(e,t){return Object(i.inject)(_h)(e,void 0,0)}(Nh=Reflect.metadata("design:type",Function)(Nh=Reflect.metadata("design:paramtypes",[Object])(Nh=class{constructor(e){this.storage=e,this.clientMsgCache=void 0,this.globalMsgCache=void 0,this.globalMsgCache=Uh(),this.clientMsgCache=Uh()}clear(e){switch(e){case Ch.g.GLOBAL:return void this.globalMsgCache.clear();case Ch.g.CLIENT:return void this.clientMsgCache.clear();default:return this.globalMsgCache.clear(),void this.clientMsgCache.clear()}}loadMessages(e,t){return new Promise(((s,i)=>{t&&0!==t.length||i("Invalid topics");const a=t.length;for(let n=0;n<a;n++){const s=t[n];if(!s)continue;let a=Dh(s);if(a&&"0"!==a)this.getMessage(e,Ch.g.GLOBAL,a).then().catch((e=>{i(e)}));else{let t=Fh(s);if(t){let a=s.params&&s.params.senderUid;this.getMessage(e,Ch.g.CLIENT,t,{userId:a}).then().catch((e=>{i(e)}))}}}s()}))}getMessageFromTopic(e){if(e.type!==Ch.i.MESSAGE||!e.params)return{};let t=Dh(e);if(this.globalMsgCache&&this.globalMsgCache.has(t))return this.globalMsgCache.get(t)||{};let s=Fh(e);return this.clientMsgCache&&this.clientMsgCache.has(s)&&this.clientMsgCache.get(s)||{}}removeMessages(e){Array.isArray(e)&&e.forEach((e=>{const t=Dh(e),s=Fh(e);this.globalMsgCache.remove(t),this.clientMsgCache.remove(s)}))}getMessage(e,t,s,i={}){return new Promise(((a,n)=>{switch(t){case Ch.g.GLOBAL:{let i=this.globalMsgCache.get(s);i?a(i):this.storage.getMessagesByIds(e,[s]).then((e=>{e?(this.setMessage(t,s,e),a(e)):n("Not found")})).catch((e=>{n(e)}));break}case Ch.g.CLIENT:{const{userId:r}=i;let o=this.clientMsgCache.get(s);o?a(o):this.storage.getMessageByCliMsgId(e,s,{myUID:zt.default.getUidMe(),userId:r}).then((e=>{e?(this.setMessage(t,s,e),a(e)):n("Not found")})).catch((e=>{n(e)}));break}default:n("Unknown")}}))}setMessage(e,t,s){switch(e){case Ch.g.GLOBAL:return void this.globalMsgCache.set(t,s);case Ch.g.CLIENT:return void this.clientMsgCache.set(t,s);default:return}}})||Nh)||Nh)||Nh)||Nh;i.ModuleContainer.register(yh,kh);var Bh=Object(i.define)("pin-topic-data-repository"),Gh=s("ZsEe");var xh=function(){const e={},t=t=>e[t]||null;return{clear:()=>{for(const t in e)delete e[t]},get:t,getAll:()=>e,getLastFetch:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastFetch)||0},getLastModified:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastModified)||0},getTopics:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.topics)||[]},getVersion:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.version)||0},has:t=>!!e[t],remove:t=>{delete e[t]},set:(t,s)=>{e[t]=s}}};var zh=function(e){const t=[];let s=!1;const i=e||(()=>{}),a=()=>t.length,n=e=>{s=e},r=()=>{if(s)return;if(!a())return void i();const e=t.shift();e&&(n(!0),e().then((()=>{n(!1),r()})).catch((()=>{n(!1),r()})))};return{enqueue:e=>{t.push(e),r()},dequeue:r,getLength:a}};var Vh=function(){const e=[];let t;const s=()=>e.length,i=(a,n)=>{if(n&&(t=n),!s())return t&&t(a);const r=e.shift();r&&((e,t)=>{const{callback:s}=e;let a;"function"==typeof s&&(a=s(e.data,t)),i(a)})(r,a)};return{enqueue:t=>{e.push(t)},dequeue:i,getLength:s}},Hh=s("u+F0");var $h=Object(i.define)("pin-topic-request-handler");function Wh(e){return new Promise((t=>{let s=0,i=0,a={};for(let n in e)s++,e[n].then((e=>{a[n]=e,i++,i===s&&t(a)})).catch((()=>{a[n]=null,i++,i===s&&t(a)}));0===s&&t({})}))}function qh(e,t){return Object(_l.f)(e,Number.isInteger(+t)?t:1/0)}var Kh=class{constructor(e,t){this.moduleName=e,this.instanceNames=t,this.instanceMap=new Map}error(e,...t){const s=this.getLogger(e);void 0!==s&&s.zsymb(18,"mQRKXX",...t)}info(e,...t){const s=this.getLogger(e);void 0!==s&&s.zsymb(0,"aIHL5f",...t)}getLogger(e){if(this.instanceNames.includes(e)&&void 0===this.instanceMap.get(e)){const t=this.LoggerFactory.createZLogger(ci.ZLoggerNametags.pinTopic,[this.moduleName,e]);this.instanceMap.set(e,t)}return this.instanceMap.get(e)}get LoggerFactory(){return i.ModuleContainer.resolve(Me.ZLoggerFactory)}},Zh=function(e){return e.CONTROL="control",e.CREATE="create",e.FETCH="fetch",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin",e}(Zh||{});var Qh,Jh=class extends Kh{constructor(){super(Ch.f.DataRepository,[Zh.CONTROL,Zh.CREATE,Zh.FETCH,Zh.LOAD,Zh.REORDER,Zh.UNPIN])}infoControl(...e){this.logInfo(Zh.CONTROL,...e)}infoCreate(...e){this.logInfo(Zh.CREATE,...e)}infoFetch(...e){this.logInfo(Zh.FETCH,...e)}infoLoad(...e){this.logInfo(Zh.LOAD,...e)}infoReorder(...e){this.logInfo(Zh.REORDER,...e)}infoUnpin(...e){this.logInfo(Zh.UNPIN,...e)}errorControl(...e){this.logError(Zh.CONTROL,...e)}errorCreate(...e){this.logError(Zh.CREATE,...e)}errorFetch(...e){this.logError(Zh.FETCH,...e)}errorLoad(...e){this.logError(Zh.LOAD,...e)}errorReorder(...e){this.logError(Zh.REORDER,...e)}errorUnpin(...e){this.logError(Zh.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Mh.h)()}};var Yh=Object(i.injectable)()(Qh=function(e,t){return Object(i.inject)(_h)(e,void 0,0)}(Qh=function(e,t){return Object(i.inject)($h)(e,void 0,1)}(Qh=Reflect.metadata("design:type",Function)(Qh=Reflect.metadata("design:paramtypes",[Object,Object])(Qh=class{constructor(e,t){this.storage=e,this.fetcher=t,this.cache=void 0,this.eventQueue=void 0,this.logger=void 0,this.pendingWhenLoadQueue=void 0,this.requestID=void 0,this.cache=xh(),this.eventQueue={},this.pendingWhenLoadQueue={},this.logger=new Jh,this.requestID=new Gh.a}clear(){this.cache.clear();for(const e in this.pendingWhenLoadQueue)delete this.pendingWhenLoadQueue[e];for(const e in this.eventQueue)delete this.eventQueue[e]}clearPinTopicsForConversation(e,t=!1){this.cache.remove(e),delete this.pendingWhenLoadQueue[e],delete this.eventQueue[e],this.Storage.clearTopics(e,t)}createPinTopic(e,t,s={}){return new Promise(((i,a)=>{const n=this.getRequestID();this.Logger.infoCreate(n,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((r=>{const{checkEnableToCreate:o}=s||{};let d=null;if(o){const{enable:s,oldTopic:i}=o(e,t,r);if(!s)return this.Logger.infoCreate(n,`cId:${e} react limit`),a({code:Hh.a.PINBOARD_OVER_MAXIMUM,message:"",data:{cache:r}});i&&(d=i)}const{version:l}=r;this.Logger.infoCreate(n,`cId:${e}`,l),this.Fetcher.createTopic(e,t,l).then((t=>{this.Logger.infoCreate(n,`cId:${e}, create topic success`);let s=t.response.data;s.oldVersion=l,d&&(s.oldTopic={topicId:d.id,topicType:d.type}),s=jh(s),this.enqueueEvent(e,this.addTopic.bind(this,e,s,(e=>i(e))))})).catch((t=>{const s=t.error;s.data=Object(f.a)(Object(f.a)({},null==s?void 0:s.data),{},{cache:r}),this.Logger.errorCreate(n,`cId:${e}, create topic fail`,qh(t,Object(Mh.b)())),a(s)}))}))}))}getEntryPointPromotionalTooltipShowedStatus(){return this.Storage.getEntryPointPromotionalTooltipShowedStatus()}handleReceivingEvent(e,t){return new Promise(((s,i)=>{if(this.Logger.infoControl(`call ${e}`,qh(t,Object(Mh.b)())),e===Ch.c.FORCE_SYNC){const{conversationIds:e}=t;if(!Array.isArray(e))return i("Invalid conversationIds for force all");if(0===e.length)this.Storage.setForcedFetchMilestone(Date.now());else for(let t=0;t<e.length;t++){var a;const n=null===(a=e[t])||void 0===a?void 0:a.toString();n&&(this.clearPinTopicsForConversation(n),this.fetchTopics(n).then((e=>{s(e)})).catch(i))}}else{const{conversationId:a}=t;this.loadDataFromCacheOrDB(a).then((a=>{this.processEventControl(e,t,a,s,i)}))}}))}loadPinTopics(e,t){return new Promise(((s,i)=>{e||i({status:Ch.h.ERROR,error:{code:Hh.a.INVALID_PARAMETERS,message:"ConversationId not valid"}});const a=this.getRequestID();if(this.Logger.infoLoad(a,`call cId:${e}`),t&&t!==Ch.d.NONE)return this.Logger.infoLoad(a,`force fetch cId:${e}`,t),this.fetchTopics(e).then((e=>{s(e)}));this.loadDataFromCacheOrDB(e).then((n=>{if(this.Logger.infoLoad(a,`cId:${e}`),t===Ch.d.NONE)return s(n);this.doCheckAndFetchData(n).then((e=>{s(e)})).catch(i)}))}))}reorderPinTopics(e,t){return new Promise(((s,i)=>{const a=this.getRequestID();this.Logger.infoReorder(a,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((n=>{const{version:r}=n,o=Lh(t);this.Logger.infoReorder(a,`cId:${e}`,r),this.Fetcher.reorderTopics(e,o,r).then((i=>{this.Logger.infoReorder(a,`cId:${e}, reorder topic success`);let n=i.response.data;n.oldVersion=r,n.topics=t,n=jh(n),this.enqueueEvent(e,this.setTopics.bind(this,e,n,(e=>s(e))))})).catch((t=>{this.Logger.errorReorder(a,`cId:${e}, reorder topic fail`,qh(t,Object(Mh.b)())),i(t.error)}))}))}))}setEntryPointPromotionalTooltipShowedStatus(e){this.Storage.setEntryPointPromotionalTooltipShowedStatus(e)}unpinTopics(e,t){return new Promise(((s,i)=>{const a=this.getRequestID();this.Logger.infoUnpin(a,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((n=>{const{version:r}=n,o=Lh(t);this.Logger.infoUnpin(a,`cId:${e}`,r),this.Fetcher.unpinTopics(e,o,r).then((i=>{this.Logger.infoUnpin(a,`cId:${e} unpin topic success`);let n=i.response.data;n.oldVersion=r,n.topics=t,n=jh(n),this.enqueueEvent(e,this.removeTopics.bind(this,e,n,(e=>s(e))))})).catch((t=>{this.Logger.errorUnpin(a,`cId:${e}, unpin topic fail`,qh(t,Object(Mh.b)())),i(t.error)}))}))}))}setPendingQueue(e,t){t&&!this.pendingWhenLoadQueue[e]?this.pendingWhenLoadQueue[e]=Vh():delete this.pendingWhenLoadQueue[e]}isInPending(e){return!!this.pendingWhenLoadQueue[e]}openPendingQueue(e){this.setPendingQueue(e,!0)}closePendingQueue(e){this.setPendingQueue(e,!1)}enqueuePending(e,t){this.pendingWhenLoadQueue[e]&&this.pendingWhenLoadQueue[e].enqueue(t)}loadTopicsFromDB(e){this.openPendingQueue(e);return new Promise((t=>{const s=this.getRequestID();this.Logger.infoLoad(s,`DB call cId:${e}`),this.Storage.loadTopics(e).then((i=>{const a=this.handleLoadDBFinish(e,i);this.Logger.infoLoad(s,`DB cId:${e} success`),t({status:Ch.h.SUCCESS,response:{data:a}})})).catch((i=>{const a=this.handleLoadDBFinish(e,null);this.Logger.errorLoad(s,`DB cId:${e} fail`,qh(null==i?void 0:i.error,Object(Mh.b)())),t({status:Ch.h.ERROR,response:{data:a}})}))}))}getRequestID(){return this.requestID.next()}handleLoadDBFinish(e,t){var s;let i;var a;t&&(i={conversationId:(a=t).conversationId,topics:a.topics,version:a.boardVersion,lastFetch:a.lastFetch,lastModified:Date.now()}),t&&(null===(s=i)||void 0===s?void 0:s.conversationId)===e||(i=function(e){return{conversationId:e,topics:[],version:0,lastFetch:0,lastModified:0}}(e));let n=i;if(!Rh(n).needFetch&&this.isInPending(e)){const t=e=>{e&&(n=e)};this.pendingWhenLoadQueue[e].dequeue(i,t)}return this.closePendingQueue(e),n}fetchTopics(e,t=0){this.openPendingQueue(e);return new Promise(((s,i)=>{const a=this.getRequestID();this.Logger.infoFetch(a,`call cId:${e}`,t),this.Fetcher.fetchTopics(e,t).then((t=>{this.Logger.infoFetch(a,`cId:${e} success`),this.closePendingQueue(e);const{response:i}=t,n=i.data.topics;for(let e=0;e<n.length;e++)n[e]=Ph(n[e]);this.loadExtraDataForTopics(n).then((t=>{const a={conversationId:e,topics:t,version:i.data.version,lastFetch:Date.now(),lastModified:Date.now()};this.setToCache(e,a),this.setTopicsToDB(a),s(a)}))})).catch((t=>{this.Logger.errorFetch(a,`cId:${e} fail`,qh(t,Object(Mh.b)())),this.closePendingQueue(e)}))}))}doCheckAndFetchData(e){return new Promise(((t,s)=>{const i=Rh(e);if(this.Logger.infoFetch(`cId:${e.conversationId} needFetch:${i.needFetch} reason:${i.reason}`),!i.needFetch)return t(e);this.fetchTopics(e.conversationId).then((s=>{t(s||e)})).catch(s)}))}getDataInPendingQueueAfterMutation(e,t){if(e.conversationId!==t.conversationId)return t;if(e.oldVersion!=t.version)return t;return{topics:Ah(e.type,t.topics,{index:e.index,topics:e.topics}),version:e.version,conversationId:e.conversationId,lastModified:Date.now(),lastFetch:t.lastFetch}}setToCache(e,t){return null==t.lastModified&&(t.lastModified=Date.now()),this.cache.set(e,t),t}addToCache(e,t,s=0){const i=this.getCache(e),{topic:a,version:n}=t;let r=Date.now(),o=[];i?(o=Ah(Ch.a.ADD,i.topics,{topics:[a],index:s}),r=i.lastFetch):o.push(a),t.lastFetch&&(r=t.lastFetch);const d={conversationId:e,topics:o,version:n,lastModified:Date.now(),lastFetch:r};return this.setToCache(e,d)}removeInCache(e,t,s=0){if(!this.cache.has(e))return null;const i=this.getCache(e),{topics:a}=i;if(t.topic)for(let r=0;r<a.length;r++){const e=a[r];if(e.id===t.topic.id&&e.type===t.topic.type){a.splice(r,1);break}}else a.splice(s,1);const n={conversationId:e,topics:a,version:t.version,lastModified:Date.now(),lastFetch:i.lastFetch};return this.setToCache(e,n)}enqueueEvent(e,t){if(!this.eventQueue[e]){const t=()=>{delete this.eventQueue[e]};this.eventQueue[e]=zh(t)}this.eventQueue[e].enqueue(t)}addTopic(e,t,s){return new Promise(((i,a)=>{if(this.isInPending(e)){const s={data:{type:Ch.a.ADD,conversationId:e,oldTopic:t.oldTopic,topics:[t.topic],version:t.version,oldVersion:t.oldVersion,index:t.index},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const n=a=>{const{oldVersion:n,version:r}=t,o=wh(n,r,a.version);if(this.Logger.infoCreate(`add call cId:${e} actCode:${o}`,n,r,a.version),1===o){const{oldTopic:a,index:n,topic:o}=t;a&&a.topicId&&this.removeInCache(e,{topic:{id:a.topicId,type:a.topicType},version:r}),Ph(o),this.loadExtraDataForTopics([o]).then((a=>{const r={topic:a[0],version:t.version},o=this.addToCache(e,r,n);this.setTopicsToDB(o),i(),s&&s(this.getCache(e))})).catch((()=>{i()}))}else 0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{n(e)}))}))}removeTopics(e,t,s){return new Promise((i=>{if(this.isInPending(e)){const s={data:{type:Ch.a.REMOVE,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const a=a=>{const{oldVersion:n,version:r}=t,o=wh(n,r,a.version);if(this.Logger.infoUnpin(`remove call cId:${e} actCode:${o}`,n,r,a.version),1===o){const{topics:n}=t;let o=a;for(let t=0;t<n.length;t++)o=this.removeInCache(e,{topic:n[t],version:r});return this.setTopicsToDB(o),s&&s(this.getCache(e)),i()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{a(e)}))}))}setTopics(e,t,s){return new Promise((i=>{if(this.isInPending(e)){const s={data:{type:Ch.a.REORDER,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),i()}const a=a=>{const{oldVersion:n,version:r}=t,o=wh(n,r,a.version);if(this.Logger.infoReorder(`set call cId:${e} actCode:${o}`,n,r,a.version),1===o){const n=a.topics,r=[];for(let e=0;e<t.topics.length;e++){const s=t.topics[e],i=n.find((e=>e.id===s.id&&e.type===s.type));i&&r.push(i)}const o={conversationId:e,topics:r,version:t.version,lastModified:Date.now(),lastFetch:(null==a?void 0:a.lastFetch)||0};return this.setToCache(e,o),this.setTopicsToDB(o),s&&s(this.getCache(e)),i()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),i()})).catch((()=>{s&&s(this.getCache(e)),i()})):i()};this.loadDataFromCacheOrDB(e).then((e=>{a(e)}))}))}loadDataFromCacheOrDB(e){return new Promise((t=>{const s=this.getCache(e);s?t(s):this.loadTopicsFromDB(e).then((s=>{const i=s.response.data;this.setToCache(e,i),t(i)}))}))}setTopicsToDB(e){return new Promise(((t,s)=>{const i={conversationId:e.conversationId,boardVersion:e.version,topics:e.topics,lastFetch:e.lastFetch};this.Storage.setTopics(i).then(t).catch(s)}))}processEventControl(e,t,s,i,a){const{conversationId:n}=t;let r={oldVersion:t.oldVersion,version:t.version};const o=jh(t);switch(e){case Ch.c.CREATE:r=Object(f.a)(Object(f.a)({},r),{},{oldTopic:o.oldTopic,topic:o.topic,index:0}),this.enqueueEvent(n,this.addTopic.bind(this,n,r,(e=>i(e))));break;case Ch.c.UNPIN:{const e=o.topic,t=[];e&&null!=e.topicId&&null!=e.topicType&&t.push({id:e.topicId,type:e.topicType}),r=Object(f.a)(Object(f.a)({},r),{},{topics:t}),this.enqueueEvent(n,this.removeTopics.bind(this,n,r,(e=>i(e))));break}case Ch.c.REORDER:{var d;const e=[],t=(null===(d=o.topics)||void 0===d?void 0:d.length)||0;for(let i=0;i<t;i++){var l;const t=null===(l=o.topics)||void 0===l?void 0:l[i];if(t&&null!=t.topicId&&null!=t.topicType){const i=s.topics.find((e=>e.id===t.topicId&&e.type===t.topicType));i&&e.push(i)}}r=Object(f.a)(Object(f.a)({},r),{},{topics:e}),this.enqueueEvent(n,this.setTopics.bind(this,n,r,(e=>i(e))));break}}}loadStickerThumb(e){const t=e=>`${e.id}_${e.type}`;return new Promise((s=>{const i={};for(let o=0;o<e.length;o++){var a,n;const s=e[o];if((null===(a=s.params)||void 0===a?void 0:a.msg_type)===R.MSG_STICKER||(null===(n=s.params)||void 0===n?void 0:n.msg_type)===R.CLI_MSG_TYPE_STICKER){var r;const e=null===(r=s.params)||void 0===r?void 0:r.extra;e&&null!=e.catId&&null!=e.id&&(i[t(s)]=this.StickerManager.getStickerIfNotExist(e.catId,e.id))}}Object.keys(i).length>0?Wh(i).then((i=>{for(let s=0;s<e.length;s++){const a=e[s],n=i[t(a)];n&&n.id===parseInt(a.params.extra.id)&&n.cateId===parseInt(a.params.extra.catId)&&(a.params.thumb=n.stickerUrl||"",e[s]=a)}s(e)})):s(e)}))}loadExtraDataForTopics(e){return new Promise((t=>{this.loadStickerThumb(e).then((e=>{t(e)}))}))}getCache(e){return this.cache.get(e)}get Fetcher(){return this.fetcher}get Logger(){return this.logger}get StickerManager(){return _s.g}get Storage(){return this.storage}})||Qh)||Qh)||Qh)||Qh)||Qh;i.ModuleContainer.register(Bh,Yh);var Xh=class{createOneOnOneTopic(e="",t,s=0,i="vi"){let a={conversationId:e,topic:t,version:s,lang:i};Is.default.logCoreInfo("[PinTopic] - createOneOnOneTopic params: ",a);const n=cs.b.getFriendBoardDomain()+"/api/friendboard/create?"+this.getCommonParams()+"&params="+this.getEncodedParams(a);return this.getRequest(n,null,12067)}getListOneOnOnePinTopics(e="",t=0){let s={conversationId:e,version:t};Is.default.logCoreInfo("[PinTopic] - getListOneOnOnePinTopics params: ",s);const i=cs.b.getFriendBoardDomain()+"/api/friendboard/list?"+Nn.default._getCommonParams()+"&params="+this.getEncodedParams(s);return this.getRequest(i,null,12065)}reorderOneOnOnePinTopics(e="",t,s=0,i="vi"){let a={conversationId:e,topics:t,version:s,lang:i};Is.default.logCoreInfo("[PinTopic] - reorderOneOnOnePinTopics params: ",a);const n=cs.b.getFriendBoardDomain()+"/api/friendboard/reorder?"+this.getCommonParams()+"&params="+this.getEncodedParams(a);return this.getRequest(n,null,12068)}unpinOneOnOneTopics(e="",t,s=0,i="vi"){let a={conversationId:e,topics:t,version:s,lang:i};Is.default.logCoreInfo("[PinTopic] - unpinOneOnOneTopics params: ",a);const n=cs.b.getFriendBoardDomain()+"/api/friendboard/multi_unpin?"+this.getCommonParams()+"&params="+this.getEncodedParams(a);return this.getRequest(n,null,12069)}getCommonParams(){return Nn.default._getCommonParams()}getEncodedParams(e){return Nn.default.getEncodedParams(e)}getRequest(e,t,s,i,a,n,r,o,d){return Nn.default._get(e,t,s,i,a,n,r,o,d)}};var eu=function(){let e;function t(){return e||(e=new Xh),e}const s=e=>new Promise(((t,s)=>{e.then(jn.a).then(t).catch(s)}));return{createOneOnOneTopic:(e,i,a=0)=>{const n=Object(f.a)({},i),{params:r}=n;r&&r.extra&&r.extra.constructor===Object&&(r.extra=JSON.stringify(r.extra)),r&&(n.params=JSON.stringify(r)),null==n.src&&(n.src=-1),null==n.pinAct&&(n.pinAct=1);const o=$t.default.getCurrentLanguageName();return s(t().createOneOnOneTopic(e,n,a,o))},getListOneOnOnePinTopics:(e,i=0)=>s(t().getListOneOnOnePinTopics(e,i)),reorderOneOnOnePinTopics:(e,i,a=0)=>{const n=$t.default.getCurrentLanguageName();return s(t().reorderOneOnOnePinTopics(e,i,a,n))},unpinOneOnOneTopics:(e,i,a=0)=>{const n=$t.default.getCurrentLanguageName();return s(t().unpinOneOnOneTopics(e,i,a,n))}}},tu=function(e){return e.CREATE="create",e.FETCH="fetch",e.REORDER="reorder",e.UNPIN="unpin",e}(tu||{});var su=class extends Kh{constructor(){super(Ch.f.Network,[tu.CREATE,tu.FETCH,tu.REORDER,tu.UNPIN])}infoCreate(...e){this.logInfo(tu.CREATE,...e)}infoFetch(...e){this.logInfo(tu.FETCH,...e)}infoReorder(...e){this.logInfo(tu.REORDER,...e)}infoUnpin(...e){this.logInfo(tu.UNPIN,...e)}errorCreate(...e){this.logError(tu.CREATE,...e)}errorFetch(...e){this.logError(tu.FETCH,...e)}errorReorder(...e){this.logError(tu.REORDER,...e)}errorUnpin(...e){this.logError(tu.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Mh.i)()}};var iu,au=class{constructor(){this.apiClient=void 0,this.logger=void 0,this.requestID=void 0,this.apiClient=eu(),this.logger=new su,this.requestID=new Gh.a}async fetchTopics(e,t=0){const s=this.getRequestId();this.Logger.infoFetch(s,`call cId:${e}`,t);try{const i=await this.apiClient.getListOneOnOnePinTopics(e,t);return this.Logger.infoFetch(s,`cId:${e} success`,i.version),{status:Ch.h.SUCCESS,response:{data:{topics:i.data,version:i.version}}}}catch(i){return this.Logger.errorFetch(s,`cId:${e} fail`,qh(i,Object(Mh.d)())),Promise.reject({status:Ch.h.ERROR,error:{code:i.code||i.error_code,message:i.error_message}})}}async createTopic(e,t,s=0){const i=this.getRequestId();this.Logger.infoCreate(i,`call cId:${e}`,s);try{const a=await this.apiClient.createOneOnOneTopic(e,t,s);return this.Logger.infoCreate(i,`cId:${e} success`,a.version),{status:Ch.h.SUCCESS,response:{data:{topic:a.data,version:a.version}}}}catch(a){return this.Logger.errorCreate(i,`cId:${e} fail`,qh(a,Object(Mh.d)())),Promise.reject({status:Ch.h.ERROR,error:{code:a.code||a.error_code,message:a.error_message}})}}async unpinTopics(e,t,s=0){const i=this.getRequestId();this.Logger.infoUnpin(i,`call cId:${e}`,s);try{const a=await this.apiClient.unpinOneOnOneTopics(e,t,s);return this.Logger.infoUnpin(i,`cId:${e} success`,a.version),{status:Ch.h.SUCCESS,response:{data:a}}}catch(a){return this.Logger.errorUnpin(i,`cId:${e} fail`,qh(a,Object(Mh.d)())),Promise.reject({status:Ch.h.ERROR,error:{code:a.code||a.error_code,message:a.error_message}})}}async reorderTopics(e,t,s=0){const i=this.getRequestId();this.Logger.infoReorder(i,`call cId:${e}`,s);try{const a=await this.apiClient.reorderOneOnOnePinTopics(e,t,s);return this.Logger.infoReorder(i,`cId:${e} success`,a.version),{status:Ch.h.SUCCESS,response:{data:a}}}catch(a){return this.Logger.errorUnpin(i,`cId:${e} fail`,qh(a,Object(Mh.d)())),Promise.reject({status:Ch.h.ERROR,error:{code:a.code||a.error_code,message:a.error_message}})}}getRequestId(){return this.requestID.next()}get Logger(){return this.logger}};i.ModuleContainer.register($h,au);var nu=Object(i.singleton)(Ih)(iu=class{constructor(){this._storage=void 0}async clearTopics(e,t=!1){try{let s;if(t)s=this.storage.removeConversationTopics(e);else{const t={conversationId:e,topics:[]},i=["topics"];s=this.storage.updateGroupTopic(t,i)}return await s,e}catch(s){return Promise.reject(s)}}async loadTopics(e){try{return(await this.loadTopicsFromDB(e)).response.data}catch(t){return Promise.reject(t)}}async setTopics(e){try{return await this.setTopicsToDB(e)}catch(t){return Promise.reject(t)}}getEntryPointPromotionalTooltipShowedStatus(){const e=S.default.getInstance().getItemForCurrentUser(Ch.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED);if(null===e)return null;try{return JSON.parse(e)}catch(t){return!1}}async getMessagesByIds(e,t){try{const s=await this.storage.getMessagesByIds(e,t);let i;t&&t.length>0&&(i=t[0]);let a=null;return i&&(a=s[i]),a||Promise.reject("Not found")}catch(s){return Promise.reject(s)}}async getMessageByCliMsgId(e,t,s={}){try{const{myUID:i,userId:a}=s;if(a){let s=a;i==a&&(s="0");const n=await this.storage.getMessageByCliMsgIdOwnerId(e,t,s);return n||Promise.reject("Not found")}const n=await this.storage.getMessageByCliMsgId(t,e);if(!n||!n.length)return Promise.reject("Not found");n.length;const r=n&&n[0];return r||Promise.reject("Not found")}catch(i){return Promise.reject(i)}}setEntryPointPromotionalTooltipShowedStatus(e){S.default.getInstance().setItemForCurrentUser(Ch.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED,JSON.stringify(e))}setForcedFetchMilestone(e){S.default.getInstance().setItemForCurrentUser(Ch.e.FORCE_FETCH_MILESTONE,e.toString())}async loadTopicsFromDB(e){try{const t=await this.storage.getGroupTopic(e);return{status:Ch.h.SUCCESS,response:{data:t}}}catch(t){return Promise.reject({status:Ch.h.ERROR,error:{code:null==t?void 0:t.code,message:(null==t?void 0:t.message)||(null==t?void 0:t.error_message),data:t}})}}async setTopicsToDB(e){return await this.storage.setGroupTopic(e)}get storage(){return this._storage||(this._storage=s("XS0u").default),this._storage}})||iu;i.ModuleContainer.register(_h,nu);var ru=s("+3r3");var ou=Object(i.define)("pin-topic-one-on-one-controller"),du=function(e){return e.CONTROL="control",e.CREATE="create",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin",e}(du||{});var lu,cu=class extends Kh{constructor(){super(Ch.f.OneOnOneController,[du.CONTROL,du.CREATE,du.LOAD,du.REORDER,du.UNPIN])}infoControl(...e){this.logInfo(du.CONTROL,...e)}infoCreate(...e){this.logInfo(du.CREATE,...e)}infoLoad(...e){this.logInfo(du.LOAD,...e)}infoReorder(...e){this.logInfo(du.REORDER,...e)}infoUnpin(...e){this.logInfo(du.UNPIN,...e)}errorControl(...e){this.logError(du.CONTROL,...e)}errorCreate(...e){this.logError(du.CREATE,...e)}errorLoad(...e){this.logError(du.LOAD,...e)}errorReorder(...e){this.logError(du.REORDER,...e)}errorUnpin(...e){this.logError(du.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Mh.g)()}};Object(i.injectable)()(lu=Object(i.singleton)(ou)(lu=function(e,t){return Object(i.inject)(Bh)(e,void 0,0)}(lu=function(e,t){return Object(i.inject)(yh)(e,void 0,1)}(lu=Reflect.metadata("design:type",Function)(lu=Reflect.metadata("design:paramtypes",[Object,Object])(lu=class{constructor(e,t){this.dataRepository=e,this.messageLoader=t,this.events={},this.logger=void 0,this.requestID=void 0,this.initialize(),this.logger=new cu,this.requestID=new Gh.a}getPinTopic(e,t,s){return new Promise(((i,a)=>{this.loadPinTopics(e).then((e=>{const{topics:n}=e,r=n.find((e=>e.id===(null==t?void 0:t.toString())&&e.type===s));r?i(r):a(null)})).catch(a)}))}getMessageFromTopic(e){return this.MessageLoader.getMessageFromTopic(e)}displayEntryPointPromotionalTooltip(){this.DataRepository.setEntryPointPromotionalTooltipShowedStatus(!0)}isDisplayedEntryPointPromotionalTooltip(){if(!Object(Mh.l)())return!0;const e=this.DataRepository.getEntryPointPromotionalTooltipShowedStatus();return null!==e&&Boolean(e)}async loadPinTopics(e,t=!1){if(!Object(Mh.k)())return Promise.reject({code:Th.c.OFF_FEATURE,message:""});const s=this.getRequestID();try{var i;let a;t&&(a=Th.e.OPEN_DIALOG),this.Logger.infoLoad(s,`call cId:${e}`,t);const n=await this.DataRepository.loadPinTopics(e,a);return this.Logger.infoLoad(s,`res cId:${e}`,!!n,n.conversationId,null===(i=n.topics)||void 0===i?void 0:i.length),{conversationId:n.conversationId,topics:n.topics}}catch(a){return this.Logger.errorLoad(s,`err cId:${e}`,qh(a,Object(Mh.a)())),Promise.reject(a)}}addEventListener(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}removeEventListener(e,t){const s=this.events[e],i=(this.events[e]||[]).length;for(let a=0;a<i;a++)if(s[a]===t){s.splice(a,1);break}0===s.length&&delete this.events[e]}removeEventListeners(e){delete this.events[e]}handleEventControl(e){if(!Object(Mh.k)())return;const t=this.getRequestID();this.Logger.infoControl(t,"recv",e.act,qh(e.data,Object(Mh.a)())),this.DataRepository.handleReceivingEvent(e.act,e.data).then((s=>{if(this.Logger.infoControl(t,"res",e.act,qh(s,Object(Mh.a)())),e.act===Th.d.UNPIN){let t=[];if(Array.isArray(e.data.topics)&&e.data.topics.forEach((e=>{s.topics.find((t=>t.id===e.topicId&&t.type===e.topicType))||t.push({topicId:e.topicId,topicType:e.topicType})})),t.length>0){const s={};t.forEach((t=>{s[`${t.topicId}_${t.topicType}`]=this.getPinTopic(e.data.conversationId,t.topicId,t.topicType)})),Wh(s).then((e=>{const t=Object.keys(e).map((t=>e[t]));this.MessageLoader.removeMessages(t)}))}}this.MessageLoader.loadMessages(s.conversationId,s.topics),this.notifyChangeEvent(s.conversationId,s.topics)})).catch((s=>{this.Logger.errorControl(t,"err",e.act,qh(s,Object(Mh.a)()))}))}async createPinTopic(e,t,s=2){if(!Object(Mh.k)())return Promise.reject({code:Th.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var a;if(this.Logger.infoCreate(i,`call cId:${e}`,!!t,s),!this.isValidNetwork())return Promise.reject({code:Th.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processCreatePinTopic(e,t,s)));return this.Logger.infoCreate(i,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(a=n.topics)||void 0===a?void 0:a.length),n}catch(n){return this.Logger.errorCreate(i,`err cId:${e}`,qh(n,Object(Mh.a)())),Promise.reject(n)}}async reorderPinTopics(e,t,s=2){if(!Object(Mh.k)())return Promise.reject({code:Th.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var a;if(this.Logger.infoReorder(i,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:Th.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processReorderPinTopics(e,t,s)));return this.Logger.infoReorder(i,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(a=n.topics)||void 0===a?void 0:a.length),n}catch(n){return this.Logger.errorReorder(i,`err cId:${e}`,qh(n,Object(Mh.a)())),Promise.reject(n)}}async unpinPinTopics(e,t,s=2){if(!Object(Mh.k)())return Promise.reject({code:Th.c.OFF_FEATURE,message:""});const i=this.getRequestID();try{var a;if(this.Logger.infoUnpin(i,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:Th.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processUnpinPinTopics(e,t,s)));return this.Logger.infoUnpin(i,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(a=n.topics)||void 0===a?void 0:a.length),n}catch(n){return this.Logger.errorUnpin(i,`err cId:${e}`,qh(n,Object(Mh.a)())),Promise.reject(n)}}isMessagePinnable(e){return function(e){return Eh(e)}(e)}initialize(){this.FriendManager.subscribeEventFriend(R.EventFriend.REMOVE_FRIEND,(e=>{const{userId:t}=e;t&&this.clearTopics(t)})),Object(ru.b)(this.clear)}clear(){this.DataRepository.clear(),this.MessageLoader.clear()}checkEnableToCreate(e,t,s){const i=(()=>{if(t.type===Th.i.MESSAGE){const i=s.topics,a=t.params.global_msg_id,n=t.params.client_msg_id,r=t.params.senderUid;for(let t=0;t<i.length;t++){const s=i[t];if(s.type===Th.i.MESSAGE){const t=this.MessageLoader.getMessageFromTopic(s);if(null!=t&&null!=a&&t.msgId===a)return s;if(null!=t&&null!=n&&t.cliMsgId===n&&t.fromUid===r&&t.toUid===e)return s}}}return null})();return s.topics.length<Object(Mh.c)()||i?{enable:!0,oldTopic:i}:{enable:!1,oldTopic:null}}clearTopics(e){this.DataRepository.loadPinTopics(e,Th.e.NONE).then((t=>{this.DataRepository.clearPinTopicsForConversation(e,!0),this.MessageLoader.removeMessages(t.topics),this.notifyChangeEvent(e,[])})).catch()}getRequestID(){return this.requestID.next()}async fetchTopicsForHandleTopLevelErrors(e,t){return await this.DataRepository.loadPinTopics(e,t)}async handleTopLevelErrorInvalidBoardVersion(e,t,s){const{conversationId:i}=t;try{const e=await this.fetchTopicsForHandleTopLevelErrors(i,Th.e.OUT_OF_DATE);return s?await s():e}catch(a){return Promise.reject(e)}}async handleTopLevelErrorRolledData(e,t){const{conversationId:s}=t;try{const t=await this.fetchTopicsForHandleTopLevelErrors(s,Th.e.ROLLED_DATA);return this.notifyChangeEvent(t.conversationId,t.topics),Promise.reject({code:Th.c.TOPIC_NOT_IN_PIN_LIST,message:e.message||"STR_PIN_GENERAL_ERROR"})}catch(i){return Promise.reject(e)}}async handleTopLevelErrorUserBlockFriend(e){return Promise.reject({code:Th.c.USER_BLOCK_FRIEND,message:e.message||"STR_TOAST_BLOCK"})}async handleTopLevelErrorUserNonFriend(e){return Promise.reject({code:Th.c.USER_NON_FRIEND,message:e.message||"STR_PIN_NOT_ZALO_FRIEND"})}async handleTopLevelErrors(e,t,s){return e.code===Th.c.INVALID_BOARD_VERSION?await this.handleTopLevelErrorInvalidBoardVersion(e,t,s):e.code===Th.c.TOPIC_NOT_IN_PIN_LIST?await this.handleTopLevelErrorRolledData(e,t):e.code===Th.c.USER_BLOCK_FRIEND?await this.handleTopLevelErrorUserBlockFriend(e):e.code===Th.c.USER_NON_FRIEND?await this.handleTopLevelErrorUserNonFriend(e):Promise.reject(e)}isValidNetwork(){return Un.b.getStateNetwork()===Un.a.CONNECTED}notifyEvent(e,...t){const s=this.events[e],i=(this.events[e]||[]).length;for(let a=0;a<i;a++)"function"==typeof s[a]&&s[a](...t)}notifyChangeEvent(e,t){this.notifyEvent("onchange",e,t)}notifyExceedEvent(e,t,s){this.notifyEvent("onexceed",e,t,s)}async processCreatePinTopic(e,t,s=2){if(!this.FriendManager.isFriend(e))return Promise.reject({code:Th.c.USER_NON_FRIEND,message:"STR_PIN_NOT_ZALO_FRIEND"});if(this.FriendManager.isBlocked(e))return Promise.reject({code:Th.c.USER_BLOCK_FRIEND,message:"STR_TOAST_BLOCK"});try{const s=await this.DataRepository.createPinTopic(e,t,{checkEnableToCreate:this.checkEnableToCreate.bind(this)});return this.MessageLoader.loadMessages(e,s.topics),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(a){try{const i=await this.handleTopLevelErrors(a,{conversationId:e},this.createPinTopic.bind(this,e,t,s-1));return{conversationId:i.conversationId,topics:i.topics}}catch(n){if(n.code===Th.c.PINBOARD_OVER_MAXIMUM){var i;const s=null==n||null===(i=n.data)||void 0===i?void 0:i.cache;this.notifyExceedEvent(e,(null==s?void 0:s.topics)||[],t)}return Promise.reject(n)}}}async processReorderPinTopics(e,t,s=2){try{const s=await this.DataRepository.reorderPinTopics(e,t);return this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(i){try{const a=await this.handleTopLevelErrors(i,{conversationId:e},this.reorderPinTopics.bind(this,e,t,s-1));return{conversationId:a.conversationId,topics:a.topics}}catch(a){return Promise.reject(a)}}}async processUnpinPinTopics(e,t,s=2){try{const s=await this.DataRepository.unpinTopics(e,t);return this.MessageLoader.removeMessages(t),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(i){try{const a=await this.handleTopLevelErrors(i,{conversationId:e},this.unpinPinTopics.bind(this,e,t,s-1));return{conversationId:a.conversationId,topics:a.topics}}catch(a){return Promise.reject(a)}}}async retryable(e,t){return null!=e&&e<0?Promise.reject({code:Th.c.STOP_RETRY_CLIENT,message:"STR_PIN_GENERAL_ERROR"}):await t()}get DataRepository(){return this.dataRepository}get FriendManager(){return zt.default}get Logger(){return this.logger}get MessageLoader(){return this.messageLoader}})||lu)||lu)||lu)||lu)||lu);var hu,uu=s("74m0");Object(i.injectable)()(hu=Object(i.singleton)(uu.a)(hu=function(e,t){return Object(i.inject)(ou)(e,void 0,0)}(hu=Reflect.metadata("design:type",Function)(hu=Reflect.metadata("design:paramtypes",[Object])(hu=class{constructor(e){this.oneOnOneController=e}addEventListener(e,t){this.OneOnOneController.addEventListener(e,t)}createPinTopic(e,t){return Object(Sh.d)(e)?Promise.resolve():this.OneOnOneController.createPinTopic(e,t)}displayOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.displayEntryPointPromotionalTooltip()}getPinTopic(e,t,s){return Object(Sh.d)(e)?Promise.resolve():this.OneOnOneController.getPinTopic(e,t,s)}getMessageFromTopic(e,t){if(!Object(Sh.d)(e))return this.OneOnOneController.getMessageFromTopic(t)}handleEventControl(e){}handleOneOnOneEventsControl(e){this.OneOnOneController.handleEventControl(e)}isDisplayedOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.isDisplayedEntryPointPromotionalTooltip()}isEnablePinTopicOneOnOneFeature(){return Mh.k()}isEnablePinTopicOneOnOneEntryPoint(){return Mh.j()}isMessagePinnable(e,t){return!!this.isMessagePinnableForAllConversations(e)&&(t!==R.CONVERSATION_TYPE.FRIEND||this.OneOnOneController.isMessagePinnable(e))}loadPinTopics(e,t){return Object(Sh.d)(e)?Promise.resolve():this.OneOnOneController.loadPinTopics(e,t)}removeEventListener(e,t){this.OneOnOneController.removeEventListener(e,t)}removeEventListeners(e){this.OneOnOneController.removeEventListeners(e)}reorderPinTopics(e,t){return Object(Sh.d)(e)?Promise.resolve():this.OneOnOneController.reorderPinTopics(e,t)}unpinPinTopics(e,t){return Object(Sh.d)(e)?Promise.resolve():this.OneOnOneController.unpinPinTopics(e,t)}isMessagePinnableForAllConversations(e){return Eh(e)}get OneOnOneController(){return this.oneOnOneController}})||hu)||hu)||hu)||hu);var gu=s("t5n0"),mu=s("aQZC");var pu,fu=new class{constructor(){this.focusManager=void 0,this.focusStatus=void 0,this.focusService=void 0}get FSV(){return this.focusService||(this.focusService=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.appStatus,[ci.ZLoggerNametags.focusDetectorManager])),this.focusService}get FM(){return this.focusManager||(this.focusManager=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.appStatus,[ci.ZLoggerNametags.focusDetectorManager])),this.focusManager}get FSTT(){return this.focusStatus||(this.focusStatus=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.appStatus,[ci.ZLoggerNametags.focusStatus])),this.focusStatus}};let vu=Object(i.injectable)()(pu=Object(ke.e)()(pu=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(pu=Reflect.metadata("design:type",Function)(pu=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a])(pu=class extends je.b{constructor(e){super(),this.config=e,this.detectors=void 0,this.lostFocusHandler=void 0,this.reFocusHandler=void 0,this.lastFirer=void 0,this.enableLog=void 0,this.listenDetector=(e,t)=>{t&&(this.detectors.set(e,t),this.lostFocusHandler.set(e,(()=>{this.onLostFocus(e)})),this.reFocusHandler.set(e,(()=>{this.onRefocus(e)})),t.idle(this.lostFocusHandler.get(e)),t.wakeup(this.reFocusHandler.get(e)))},this.disposeDetector=e=>{const t=this.detectors.get(e);this.enableLog&&fu.FM.zsymb(0,"Q_xH3P","disposeDetector",e,!!t),t&&(t.removeIdle(this.lostFocusHandler.get(e)),t.removeWakeup(this.reFocusHandler.get(e)),t.ifvisible=null,t._window=null,t.removeAllIpc(),this.lostFocusHandler.delete(e),this.reFocusHandler.delete(e),this.detectors.delete(e))},this.onLostFocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&fu.FM.zsymb(0,"RNgy-f","onlostFocus",e);let t=!0,s=Number.MAX_SAFE_INTEGER,i="unknown";this.detectors.forEach((e=>{if(e.isActive())t=!1;else{const t=e.getIdleInfo();t.idleFor<s&&(s=t.idleFor,i=t.idleByTimeout?"no-action-timeout":"unknown")}})),t&&this.dispatchEvent(new gu.a(gu.b.LostFocus,{scope:"app",reason:i})),this.lastFirer=null}),200)},this.onRefocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&fu.FM.zsymb(0,"YnLceh","onRefocus",e),this.dispatchEvent(new gu.a(gu.b.Focus,e)),this.lastFirer=null}),200)},this.detectors=new Map,this.lostFocusHandler=new Map,this.reFocusHandler=new Map,this.enableLog=!0}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&fu.FM.zsymb(0,"xkbr9H","onAuthenticated",t),this.init()}acquire(e,t,s){if(!e||e==Qs.c)return mu.b;if(this.detectors.has(e))return fu.FM.zsymb(0,"yiOuJb","acquire exists",e),this.detectors.get(e);this.enableLog&&fu.FM.zsymb(0,"Y5wQtN","acquire new",e);const i=new mu.a(e,t,s);return this.listenDetector(e,i),i}release(e){this.disposeDetector(e)}getAppIdleTime(){let e=Number.MAX_SAFE_INTEGER;return this.detectors.forEach((t=>{const s=t.getIdleInfo();s.idleFor<e&&(e=s.idleFor)})),e}updateIdleTimeout(e){this.detectors.forEach((t=>{t.setIdleTimeout(e)}))}isAppFocus(){let e=!1;return this.detectors.forEach((t=>{t.isActive()&&(e=!0)})),e}init(){this.listenDetector(Qs.c,mu.b)}})||pu)||pu)||pu)||pu)||pu;const bu=Object(i.define)("lost-focus-service"),yu=Object(i.define)("active-service");var Iu,_u=s("cHDa"),Cu=function(e){return e[e.Focus=0]="Focus",e[e.LostFocus=1]="LostFocus",e}(Cu||{});let Ou=Object(i.injectable)()(Iu=Object(ke.e)()(Iu=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(Iu=function(e,t){return Object(i.inject)(bu)(e,void 0,1)}(Iu=Reflect.metadata("design:type",Function)(Iu=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===bu?Object:bu])(Iu=class{constructor(e,t){this.config=e,this.service=t,this.enableLog=void 0,this.currentState=void 0,this.enableLog=!0,this.currentState=Cu.LostFocus}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&fu.FSTT.zsymb(0,"iO5PdS","onAuthenticated",t),this.init()}init(){const e=i.ModuleContainer.resolve(gu.c);e.addEventListener(gu.b.LostFocus,(e=>{const{scope:t,reason:s}=e.payload;this.currentState==Cu.Focus&&"app"===t&&(this.service.notiLostFocus(),this.config.get("online_configs.enable_focus_manager")&&_u.b.setAppStatus(_u.a.BACKGROUND),this.currentState=Cu.LostFocus)})),e.addEventListener(gu.b.Focus,(e=>{this.currentState==Cu.LostFocus&&this.config.get("online_configs.enable_focus_manager")&&_u.b.setAppStatus(_u.a.FOREGROUND),this.currentState=Cu.Focus}))}})||Iu)||Iu)||Iu)||Iu)||Iu)||Iu;var Su;let Eu=Object(i.injectable)()(Su=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(Su=Reflect.metadata("design:type",Function)(Su=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a])(Su=class{constructor(e){this.config=e}notiLostFocus(){this.config.get("online_configs.enable_lost_focus")?Nn.default.lostFocus().then(jn.a).then((()=>{fu.FSV.zsymb(0,"SiOxVZ","send noti lost success")})).catch((e=>{fu.FSV.zsymb(0,"CxebhY","send noti lost fail",JSON.stringify(e))})):fu.FSV.zsymb(0,"50tlHT","call send noti lost but feat disable")}})||Su)||Su)||Su)||Su;var Mu=s("a8HX"),Tu=s("LLK0");class wu{constructor(){this.interpreter=void 0}create(e){this.interpreter=new Tu.a(this.createMachine(e),e)}get status(){var e;return(null===(e=this.interpreter)||void 0===e?void 0:e.status)||Tu.b.NotStarted}start(){var e;null===(e=this.interpreter)||void 0===e||e.start()}stop(){var e;null===(e=this.interpreter)||void 0===e||e.stop()}send(e){return this.interpreter.send(e)}onChange(e){this.interpreter.onChange(e)}onTransition(e){this.interpreter.onTransition(e)}onStop(e){this.interpreter.onStop(e)}onDone(e){this.interpreter.onDone(e)}off(e){var t,s;null===(t=this.interpreter)||void 0===t||null===(s=t.off)||void 0===s||s.call(t,e)}}var Ru,Lu=s("G15u");let Fu=Object(i.injectable)()(Ru=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(Ru=function(e,t){return Object(i.inject)(yu)(e,void 0,1)}(Ru=Reflect.metadata("design:type",Function)(Ru=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,void 0===yu?Object:yu])(Ru=class extends wu{constructor(e,t){super(),this.loggerFactory=e,this.service=t}createMachine(){return e=this.loggerFactory.createZLogger(ci.ZLoggerNametags.activeDeactive,[ci.ZLoggerNametags.stateMachine]),t=this.service,Object(Lu.a)({strict:!0,id:"active-deactive",context:{},initial:"unset",states:{unset:{entry:()=>e.zsymb(3,"UTjZHT",["unset","UjwKff"]),on:{FOCUS:{actions:()=>{e.zsymb(3,"ecVcWL",["start life cycle normal case!","0KROzU"])},target:"foreground_active"},APP_UNLOCK:{actions:()=>{e.zsymb(3,"oFth2r",["start life cycle app auto lock case!","3TJ_w-"])},target:"foreground_active"},LOST_FOCUS:{actions:()=>{e.zsymb(3,"xDHBFK",["start life cycle lost focus case!","YsQ54h"])},target:"background_active"}}},foreground_active:{entry:s=>{e.zsymb(3,"Ic0LxB",["state: foreground_active","92mMte"]),t.startForegroundMode()},on:{IDLE:{actions:()=>{},target:"background_deactive"},LOST_FOCUS:{actions:()=>{},target:"background_active"},INAPP_INTERACT:{actions:()=>{t.keepForegroundMode()}},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},APP_LOCK:{target:"background_deactive"},APP_UNLOCK:{actions:()=>{t.startForegroundMode()}},LOG_OFF:{target:"background_deactive"},OUTAPP_IDLE:{target:"background_deactive"}}},background_active:{entry:s=>{e.zsymb(3,"3ocYAt",["state: background_active","SB-1ZY"]),t.startBackgroundMode()},on:{FOCUS:{target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},OUTAPP_IDLE:{target:"background_deactive"},APP_LOCK:{target:"background_deactive"},LOG_OFF:{target:"background_deactive"}}},background_deactive:{entry:(s,i)=>{e.zsymb(3,"gXEKo2",["state: background_deactive","Q8NBUH"],i.status),t.startDeactive(i.status)},on:{FOCUS:{actions:()=>{},target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)},target:"background_active"},APP_UNLOCK:{target:"foreground_active"}}}},on:{RESET:{target:"unset",actions:()=>{}}}});var e,t}isUnset(){var e;return"unset"===(null===(e=this.interpreter)||void 0===e?void 0:e.state.value)}onceDeactive(e){var t;if("background_deactive"===(null===(t=this.interpreter)||void 0===t?void 0:t.state.value))e();else{let t=()=>{var s,i;"background_deactive"===(null===(s=this.interpreter)||void 0===s?void 0:s.state.value)&&(null===(i=this.interpreter)||void 0===i||i.off(t),e())};this.onChange(t)}}})||Ru)||Ru)||Ru)||Ru)||Ru;var Du,Au=s("4zJP");const ju=new Map([["0","LOCK_SCREEN"],["1","UNLOCK_SCREEN"],["2","LOG_ON"],["3","LOG_OFF"],["4","SLEEP"],["5","RESUME"]]);let Pu=Object(i.injectable)()(Du=Object(ke.i)()(Du=Object(ke.g)()(Du=Object(i.singleton)(Mu.a)(Du=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(Du=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(Du=function(e,t){return Object(i.inject)(yu)(e,void 0,2)}(Du=Reflect.metadata("design:type",Function)(Du=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,void 0===yu?Object:yu])(Du=class{constructor(e,t,s){this.config=e,this.service=s,this.logger=void 0,this.machine=void 0,this.authenticated=void 0,this.appLocked=void 0,this.isRunning=void 0,this.lastConfig=void 0,this.onAppLock=()=>{this.logger.zsymb(0,"T1wdoY","app locked",this.authenticated),this.appLocked=!0,this.authenticated&&(this.machine.send({type:"APP_LOCK",status:2}),$zInAppPayment.closeInAppPayment())},this.onAppUnLock=()=>{this.logger.zsymb(0,"zDiGVp","app unlocked",this.authenticated),this.appLocked=!1,this.authenticated&&this.machine.send({type:"APP_UNLOCK",status:0})},this.onConfigChanged=e=>{ms.default.stagingAccount&&(window._activeController=this),e&&this.config.set("online_configs",e);const t=this.isConfigsReallyChanged();if(this.logger.zsymb(0,"L3dumO","onConfigChanged",t),!t)return;this.lastConfig=this.config.get("online_configs");const s=this.config.get("online_configs.idle_time");i.ModuleContainer.resolve(gu.c).updateIdleTimeout(s/1e3),this.service.onConfigUpdated(),this.isEnable()?this.setup():this.onDispose()},this.onLostFocus=async e=>{const{scope:t,reason:s}=e.payload;"app"===t&&(this.logger.zsymb(0,"KFjzDH","lost focus",s),"no-action-timeout"!=s||await this.service.isUserHasAction(this.idleTime)?this.machine.send({type:"LOST_FOCUS"}):this.machine.send({type:"IDLE",status:0}))},this.onFocus=e=>{this.isUsingApp()&&(this.logger.zsymb(0,"JsvMYf","active-deactive focus"),this.machine.send({type:"FOCUS"}))},this.onActiveFromBackground=(e,t)=>{this.logger.zsymb(0,"7LswYU","onActiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_INTERACT",isOsEvt:t})},this.onDeactiveFromBackground=(e,t)=>{this.logger.zsymb(0,"i5lf0y","onDeactiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_IDLE",status:t})},this.machine=i.ModuleContainer.resolveToken(Fu),this.logger=t.createZLogger(ci.ZLoggerNametags.activeDeactive,[ci.ZLoggerNametags.controller]),this.config=e,this.service=s,this.authenticated=!1,this.appLocked=!1,this.isRunning=!1,this.lastConfig={},$e.p.listenEvent($e.m,this.onConfigChanged);try{this.machine.create()}catch(a){return void this.logger.zsymb(18,"KbUGF0",(()=>["create error",{error:a}]))}}createMachine(){}onStart(){this.isEnable()||this.logger.zsymb(0,"cY7vw6","feature is not enable")}setup(){if(this.logger.zsymb(0,"2bTeWW","setup",this.isRunning),this.clearBackgroundTracking(),this.isEnableBackgroundTrack()&&this.setupBackgroundTracking(),this.isRunning)return;this.isRunning=!0,this.machine.start();const e=i.ModuleContainer.resolve(gu.c);this.machine.isUnset()&&(e.isAppFocus()?this.machine.send({type:"FOCUS"}):this.machine.send({type:"LOST_FOCUS"})),e.addEventListener(gu.b.LostFocus,this.onLostFocus),e.addEventListener(gu.b.Focus,this.onFocus),this.appLocked=$e.p.getAppLock(),Au.b.on(Au.a.APP_LOCKED,this.onAppLock),Au.b.on(Au.a.APP_UNLOCKED,this.onAppUnLock)}onAuthenticated(){this.authenticated=!0,this.isEnable()&&this.service.onLogin()}onDispose(){if(!this.isRunning)return;this.isRunning=!1,this.machine.stop();const e=i.ModuleContainer.resolve(gu.c);e.removeEventListener(gu.b.LostFocus,this.onLostFocus),e.removeEventListener(gu.b.Focus,this.onFocus),Au.b.off(Au.a.APP_LOCKED,this.onAppLock),Au.b.off(Au.a.APP_UNLOCKED,this.onAppUnLock),this.clearBackgroundTracking()}isConfigsReallyChanged(){for(const e in this.config.get("online_configs"))if(e&&this.lastConfig[e]!==this.config.get(`online_configs.${e}`))return!0;return!1}setupBackgroundTracking(){}clearBackgroundTracking(){}onUserSendMessage(){this.isEnable()&&this.machine.send("INAPP_INTERACT")}onUserLogOff(){return new Promise((e=>{if(!this.isEnable()||!this.isUsingApp())return e(!1);this.machine.onceDeactive((()=>{e(!0)})),this.machine.send({type:"LOG_OFF",status:3}),this.onDispose(),setTimeout((()=>{e(!0)}),1e3)}))}onOSEvent(e){if(!this.isEnable())return;const t=ju.get(e);Cs.default.send(Os.GeneralActions.USER_ACTIVE_CHANGED,t),this.logger.zsymb(3,"D-RuD4",["handle event os ","mhotK0"],t)}isUsingApp(){const e=this.appLocked||$e.p.getWaitRestart();return this.authenticated&&!e}isEnable(){return this.config.get("online_configs.enable_active_deactive_v2")}isEnableBackgroundTrack(){return!1}isEnableFullBackgroundTrack(){return!1}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get idleTime(){return this.config.get("online_configs.idle_time")}})||Du)||Du)||Du)||Du)||Du)||Du)||Du)||Du)||Du;var Nu,Uu=s("8RMw"),ku=s("UkBb"),Bu=s("oQzU"),Gu=function(e){return e[e.ActiveBackground=0]="ActiveBackground",e[e.KeepActiveForeground=1]="KeepActiveForeground",e[e.FirstActiveForeground=2]="FirstActiveForeground",e[e.ToBackground=3]="ToBackground",e[e.KeepActiveBackground=4]="KeepActiveBackground",e}(Gu||{}),xu=function(e){return e[e.Idle=0]="Idle",e[e.ComputerLock=1]="ComputerLock",e[e.AppLock=2]="AppLock",e[e.LogOff=3]="LogOff",e}(xu||{}),zu=function(e){return e[e.Foreground=0]="Foreground",e[e.BackgroundActive=1]="BackgroundActive",e[e.BackgroundDeactive=2]="BackgroundDeactive",e}(zu||{});const Vu={[zu.Foreground]:Gu.KeepActiveForeground,[zu.BackgroundActive]:Gu.KeepActiveBackground};let Hu=Object(i.injectable)()(Nu=function(e,t){return Object(i.inject)(_.a)(e,void 0,0)}(Nu=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(Nu=function(e,t){return Object(i.inject)(gu.c)(e,void 0,2)}(Nu=Reflect.metadata("design:type",Function)(Nu=Reflect.metadata("design:paramtypes",[void 0===_.a?Object:_.a,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,void 0===gu.c?Object:gu.c])(Nu=class{constructor(e,t,s){this.config=e,this.focusManager=s,this.logger=void 0,this.pingTimer=void 0,this.deactiveTimer=void 0,this.status=void 0,this.configChanged=void 0,this.countPingWssFail=0,this.logger=t.createZLogger(ci.ZLoggerNametags.activeDeactive,[ci.ZLoggerNametags.service]),this.status=zu.Foreground,this.configChanged=!1}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get deactiveTimeout(){return this.config.get("online_configs.idleTime")}get enableSendDeactiveOnBgIdle(){return this.config.get("online_configs.enable_deact_on_bg_idle")}get enableSendDeactiveOnFgIdle(){return this.config.get("online_configs.enable_deact_on_fg_idle")}get enSendActiveToKeepAlive(){return this.config.get("online_configs.send_active_to_keep_live")}get enActiveUsingSocket(){return this.config.get("online_configs.send_active_using_socket")}get enableBackgroundTracking(){return this.config.get("online_configs.enable_background_tracking")}get enableFeature(){return this.config.get("online_configs.enable_active_deactive_v2")}get enableFullBackgroundTrack(){return!1}onLogin(){this.sendActiveToServer(Gu.ActiveBackground)}startTrackIdle(e=!0){this.enableBackgroundTracking?this.logger.zsymb(0,"5B4g4I","startTrackIdle"):this.logger.zsymb(0,"O2w1HB","in startTrackIdle but flag off")}stopTrackIdle(){this.logger.zsymb(0,"sv8O1B","stopTrackIdle")}startForegroundMode(){this.status=zu.Foreground,this.sendActiveToServer(Gu.FirstActiveForeground),this.clearPingTimer(),this.createPingTimer(),this.enableFullBackgroundTrack||this.stopTrackIdle()}keepForegroundMode(){this.sendActiveToServer(Gu.KeepActiveForeground,{additionText:"[Send Msg] "})}startBackgroundMode(){this.status=zu.BackgroundActive,this.clearPingTimer(),this.startTrackIdle()}activeInBackground(e){const t=e?Gu.ActiveBackground:Gu.KeepActiveBackground;this.pingTimer?this.logger.zsymb(0,"QKzjBk","user action bg but dont need ping because in ping interval"):this.sendActiveToServer(t)}startDeactive(e){let t=-1;switch(e){case 0:t=xu.Idle;break;case 1:t=xu.ComputerLock;break;case 2:t=xu.AppLock;break;case 3:t=xu.LogOff}this.clearPingTimer(),-1!==t&&this.canSendDeactive(t)&&this.sendDeactiveToServer(t),this.status===zu.Foreground&&t==xu.Idle&&this.startTrackIdle(!1),t!=xu.ComputerLock&&t!=xu.AppLock||this.stopTrackIdle(),this.status=zu.BackgroundDeactive}onConfigUpdated(){this.configChanged=!0,this.enableFeature||this.clearPingTimer()}getStatus(){return this.status}createPingTimer(){!this.pingTimer&&this.enableFeature&&(this.logger.zsymb(0,"q0xgM5","createPingTimer"),this.configChanged=!1,this.pingTimer=setInterval((()=>{const e=Vu[this.status];e?this.sendPingActive(e):this.logger.zsymb(0,"loAPtK","call ping invalid state!"),this.configChanged&&(this.clearPingTimer(),this.createPingTimer())}),this.pingInterval))}clearPingTimer(){this.logger.zsymb(0,"KUFOqX","clearPingTimer"),clearInterval(this.pingTimer),this.pingTimer=null}async isUserHasAction(e){return this.focusManager.getAppIdleTime()<e}canSendDeactive(e){return e!==xu.Idle||(this.status===zu.Foreground&&this.enableSendDeactiveOnFgIdle||this.status===zu.BackgroundActive&&this.enableSendDeactiveOnBgIdle)}async sendPingActive(e){await this.isUserHasAction(this.pingInterval)?this.sendActiveToServer(e):this.logger.zsymb(3,"vYh_M-",["call ping but discard, because the user don't have action!","-ALpGf"])}sendActiveToServer(e,t={additionText:""}){const{additionText:s}=t;if(!this.enActiveUsingSocket||ku.default.getMsgSrcType()!==R.MsgSources.SOCKET)return fs.default.increaseFailed(88888,0,0,e,Date.now()),this.sendActiveViaHttp(e,s).then((e=>(e&&(this.countPingWssFail=0),e)));let i=null;return i=this.enSendActiveToKeepAlive?Uu.default.pingActiveViaKeepAlive(e):Bu.a.instance().pingActive(e),i.then((()=>(this.countPingWssFail=0,this.logger.zsymb(3,"BYmEZW",["{}Call active app SUCCESS: socket - {}","h71YGv"],s,e),!0))).catch((t=>(this.logger.zsymb(21,"GmsLzG",["{}Call active fail: socket - {} - {}","pf8mXZ"],s,e,JSON.stringify(t)),this.countPingWssFail++,fs.default.increaseFailed(88888,1,0,e,Date.now()),this.sendActiveViaHttp(e).then((t=>(t&&this.countPingWssFail>=3&&(this.countPingWssFail=0,fs.default.increaseFailed(88888,2,0,e,Date.now())),t))))))}sendActiveViaHttp(e,t=""){return new Promise((s=>{Nn.default.active(e).then(jn.a).then((()=>{this.logger.zsymb(3,"r2lCpr",["{}Call active app SUCCESS: http - {}","G1T17c"],t,e),s(!0)})).catch((i=>{this.logger.zsymb(21,"EBwYTd",["{}Call active fail: http - {} - {}","5yjcbI"],t,e,JSON.stringify(i)),s(!1)}))}))}sendDeactiveToServer(e){return Nn.default.deactiveV2().then(jn.a).then((()=>(this.logger.zsymb(3,"1ctte7",["Call deactive app SUCCESS {}","6MXQxN"],e),!0))).catch((e=>(this.logger.zsymb(21,"iNzwGz",["Call deactive fail: ","gMGWfa"],JSON.stringify(e)),!1)))}})||Nu)||Nu)||Nu)||Nu)||Nu)||Nu;i.ModuleContainer.registerSingleton(bu,Eu),i.ModuleContainer.registerSingleton(gu.c,vu),i.ModuleContainer.registerSingleton(yu,Hu),i.ModuleContainer.resolve(gu.c),i.ModuleContainer.resolveToken(Ou),i.ModuleContainer.resolveToken(Pu);var $u,Wu=s("Vp9m"),qu=s("CPou"),Ku=s("MnxE"),Zu=s("1rNO"),Qu=s("NDwn");Object(Hs.b)(wa.b)($u=Reflect.metadata("design:type",Function)($u=Reflect.metadata("design:paramtypes",[])($u=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.onlyAdminChatSettings,[this.name])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.settings=new Map,this.me="",this._Logger=void 0,this.name=wa.a,this.key=wa.a,1===ms.default.only_admin_chat_setting.enable_only_admin_chat_setting&&this._addPublicGroupSettingEventListener(),this._addPublicFriendEventListener(),Qu.a||Ku.a.signalCallback(this.onSettingsUpdate.bind(this))}_filterSettingKeys(e,t,s){let i={lockSendMsg:!1};for(let a in e)Object.keys(qu.a).includes(a)&&a===qu.a.lockSendMsg&&(i[qu.a.lockSendMsg]=!t&&!s&&Boolean(e[qu.a.lockSendMsg]));return i}_onUpdateSettings(e,t,s,i){this.me||(this.me=zt.default.getUidMe());const a=this.me===t,n=this._filterSettingKeys(i,a,s);return this.settings.set(e,n),Object(Kt.g)(this.name,e),n}showNoti(e){if("TOAST"===e.type)Wu.ZToastManagerHolder.getZToastManagerByWindowId(e.windowId||Qs.c).show(Object(f.a)({},e.config))}verifySetting(e){const{convId:t,field:s,showNoti:i}=e,a=this.settings.get(t);return a?(i&&i.triggerValue===a[s]&&this.showNoti(i),a&&a[s]):null}onSettingsUpdate(e,t){let s=this.settings.get(e)||{lockSendMsg:!1};for(let i in t)Object.keys(qu.a).includes(i)&&(s[i]=t[i]);this.settings.set(e,s),Object(Kt.g)(this.name,e)}_addPublicGroupSettingEventListener(){oi.default.subscribeEventGroup(R.EventGroup.CHANGE_OWNER,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),oi.default.subscribeEventGroup(R.EventGroup.ADD_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),oi.default.subscribeEventGroup(R.EventGroup.REMOVE_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),oi.default.subscribeEventGroup(R.EventGroup.GROUP_INFO_CHANGED,(e=>{if(null!=e&&e.length)for(let t=0;t<e.length;t++)this.onLoadGroupSetting(e[t])})),Zi.default.subscribe(Qs.a.CHILD_WINDOW_ALIVE,(e=>{null!=e&&e.windowId&&this.onLoadSetting(e.windowId)})),Cs.default.subscribe(((e,t)=>{switch(e){case Os.FetchActions.UPDATE_GROUP_SETTING:{var s,i;const e=null!=t&&null!==(s=t.data)&&void 0!==s&&null!==(i=s.groupId)&&void 0!==i&&i.startsWith("g")?t.data.groupId:"g"+t.data.groupId;e&&this.onLoadGroupSetting(e);break}}}))}updateFriendBLockSetting(e,t){const s=t||zt.default.isBlocked(e),i=1===ms.default.block_msg_call_setting.enable_block_msg_call_setting;let a=Boolean(s)&&i;if(!a&&zt.default.isOA(e,!1)){const t=Zu.a(zt.default.getOAStatus(e));t&&t.enable&&(a=!0)}this.onSettingsUpdate(e,{[qu.a.lockSendMsg]:a})}_addPublicFriendEventListener(){zt.default.subscribeEventFriend(R.EventFriend.BLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!0)})),zt.default.subscribeEventFriend(R.EventFriend.UNBLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!1)})),Cs.default.subscribe(((e,t)=>{if(e===Os.FriendsAction.FRIENDS_CHANGE_INFO)t&&Array.isArray(t)&&t.forEach((({userId:e})=>{this.updateFriendBLockSetting(e)}))}))}_checkGroupAdmin(e){var t;return this.me||(this.me=zt.default.getUidMe()),(null==e||null===(t=e.topMember)||void 0===t?void 0:t.filter((e=>e.id===this.me&&e.isAdmin)).length)>0}onLoadGroupSetting(e){return new Promise(((t,s)=>{oi.default.getFullInfoGroupById(e).then((s=>{if(!s)return this.Logger.zsymb(18,"iTY3Sy","[GroupSetting]: Load GroupInfo from manager faily "+s+", GroupId: "+e),t(null);const i=s.setting,a=s.creatorId,n=this._checkGroupAdmin(s),r=this._onUpdateSettings(e,a,n,i);i&&!i.hasOwnProperty("lockSendMsg")&&this.Logger.zsymb(18,"hGijJj","[GroupSetting]: Dont have field lockSendMsg in setting data"),t(r)})).catch((s=>{this.Logger.zsymb(18,"dHDki4","[GroupSetting]: Have error in loadiing GroupInfo from manager: "+JSON.stringify(s)+", GroupId: "+e),t(null)}))}))}async onLoadSetting(e){return e.startsWith("g")?1!==ms.default.only_admin_chat_setting.enable_only_admin_chat_setting?null:await this.onLoadGroupSetting(e):(this.updateFriendBLockSetting(e),Qu.a?null:void Ku.a.signalIfUnlock(e))}init(e){throw new Error("Method not  .")}getCurrentItem(e){return this.settings.get(e)}getItem(e,t){return this.settings.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||$u)||$u);const Ju=Object(i.define)("media-primary-key-convertor");var Yu;let Xu=Object(i.injectable)()(Yu=class{async toMediaPKFromMessagePK(e,t){if(!t)return"";const s=await ze.default.getInstance().Core.Message.get(t,{partition:e});return s&&(s.cliMsgId||s.fromUid||s.toUid)?`${s.cliMsgId}_${s.fromUid}_${s.toUid}`:""}async toMessagePKFromMediaPK(e){const[t,s,i]=this._getThreePartsFromMediaPK(e);if(!t||!s||!i)return"";const a=await this._getMessagesByCliMsgIdRange(t,i);let n="";return a.forEach((e=>{e.fromUid===s&&e.toUid===i&&(n=e.msgId)})),n}_getMessagesByCliMsgIdRange(e,t){const s={from:e,to:e,excludeFrom:!1,excludeTo:!1},i={index:"cliMsgIdIndex",partition:t};return ze.default.getInstance().Core.Message.getAll(s,i)}_getThreePartsFromMediaPK(e){if("string"!=typeof e||!e)return[];const[t,s,i]=e.split("_");return[t,s,i]}})||Yu;i.ModuleContainer.register(Ju,Xu);const eg=Object(i.define)("utils-media-mapper"),tg=Object(i.define)("file-media-mapper"),sg=Object(i.define)("image-media-mapper"),ig=Object(i.define)("link-media-mapper");var ag;let ng=Object(i.injectable)()(ag=class{toUtilsMediaDTOFromDomain(e){return{id:e.id,convId:e.convId,mediaType:e.mediaType,senderIds:e.senderIds,fileTypes:e.fileTypes}}})||ag;i.ModuleContainer.register(eg,ng);var rg,og=s("v6qY"),dg=s("IZCB");function lg(e){try{const t=JSON.parse(e),{fileExt:s,fType:i}=t;return"zip"===s&&2===i}catch(t){return!1}}function cg(e){try{if(lg(e))return"folder";const t=JSON.parse(e);if(!t)return"";const{fileExt:s}=t;return s.toLowerCase()}catch(t){return""}}function hg(e){try{const t=JSON.parse(e);if(!t)return{width:null,height:null};const{width:s,height:i}=t;return{width:s,height:i}}catch(t){return{width:null,height:null}}}let ug=Object(i.injectable)()(rg=class{toDomainFromOldDomain(e,t=`${og.c.UNKNOWN}${og.d.FROM_OLD_DB}`){if(!e||!e.message)throw Error("This oldImageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This oldImageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${i}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},type:"number"==typeof e.subType?e.subType:-1,src:t,sendDttm:s,ttl:e.ttl,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:e.updateTime||s,metadata:Object(f.a)(Object(f.a)({},hg(e.message.params)),{},{vOrient:dg.a.None})}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This imageDTO isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This imageDTO doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,s="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:s,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},type:"number"==typeof e.subType?e.subType:-1,sendDttm:t,src:e.src,ttl:"number"==typeof e.ttl?e.ttl:0,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:"number"==typeof e.updateTime?e.updateTime:t,metadata:Object(f.a)(Object(f.a)({},hg(e.message.params)),{},{vOrient:e.vOrient||dg.a.None})}}toDomainFromTMessage(e,t,s=`${og.c.UNKNOWN}${og.d.FROM_MSG}`){if(!e||!e.message)throw Error("This messageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.toUid){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid},s=`This messageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const i="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,a="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${a}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:a,content:{title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null},src:s,type:t,sendDttm:i,ttl:e.ttl||0,localPath:e.localPath||"",previewThumb:e.previewThumb||"",modifiedTime:i,metadata:Object(f.a)(Object(f.a)({},hg(e.message.params)),{},{vOrient:dg.a.None})}}async toDTO(e,t=!0){if(!e||!e.mediaId)throw Error("This imageEntity isn't valid!");const s=e.msgId?e.msgId:t?await i.ModuleContainer.resolve(Ju).toMessagePKFromMediaPK(e.mediaId):"";return{mediaId:e.mediaId,msgId:s,cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,description:"",childnumber:0,action:"",params:e.content.params,type:"",thumbUrl:e.content.thumbUrl,oriUrl:e.content.oriUrl,hdUrl:e.content.hdUrl,normalUrl:e.content.normalUrl,duration:e.content.duration||null,thumb:"",href:""},sendDttm:e.sendDttm,src:e.src,ttl:e.ttl,type:"image",subType:e.type,id:0,localPath:e.localPath,previewThumb:e.previewThumb,updateTime:e.modifiedTime,width:e.metadata.width,height:e.metadata.height,vOrient:e.metadata.vOrient}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"image",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts is undefined or not valid!");const t={};var s,i;(e.hasOwnProperty("message")&&"object"==typeof e.content&&(t.message={title:e.content.title,description:"",childnumber:0,action:"",params:e.content.params,type:"",thumbUrl:e.content.thumbUrl,oriUrl:e.content.oriUrl,hdUrl:e.content.hdUrl,normalUrl:e.content.normalUrl,duration:e.content.duration||null,thumb:"",href:""}),e.hasOwnProperty("subType")&&(t.subType=e.type),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("previewThumb")&&(t.previewThumb=e.previewThumb||""),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),e.hasOwnProperty("metadata"))&&(t.width=null===(s=e.metadata)||void 0===s?void 0:s.width,t.height=null===(i=e.metadata)||void 0===i?void 0:i.height);return t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts is undefined or not valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:e.message.title||null,thumbUrl:e.message.thumbUrl||"",hdUrl:e.message.hdUrl||"",normalUrl:e.message.normalUrl||"",oriUrl:e.message.oriUrl,params:e.message.params,duration:e.message.duration||null}),e.hasOwnProperty("subType")&&(t.type=e.subType),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("previewThumb")&&(t.previewThumb=e.previewThumb||""),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("width")&&e.hasOwnProperty("height")&&e.hasOwnProperty("vOrient")&&(t.metadata={width:e.width,height:e.height,vOrient:e.vOrient||0}),t}})||rg;var gg;i.ModuleContainer.register(sg,ug);let mg=Object(i.injectable)()(gg=class{toDomainFromOldDomain(e,t=`${og.c.UNKNOWN}${og.d.FROM_OLD_DB}`){if(!e||!e.message)throw Error("This oldFileEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This oldFileEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${i}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:lg(e.message.params)?og.a.FOLDER:og.a.FILE,src:t,extType:cg(e.message.params),sendDttm:s,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||s,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:Object(f.a)({},e.dimension.orientation),bigRes:e.dimension.bigRes}:null}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This fileDTO isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This fileDTO doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,s="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:s,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:e.fileType||lg(e.message.params)?og.a.FOLDER:og.a.FILE,src:e.src,extType:e.extType||cg(e.message.params),sendDttm:t,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||t,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:Object(f.a)({},e.dimension.orientation),bigRes:e.dimension.bigRes}:null}}async toDTO(e){if(!e||!e.mediaId||!e.content)throw Error("This fileEntity isn't valid!");const t=e.msgId?e.msgId:await i.ModuleContainer.resolve(Ju).toMessagePKFromMediaPK(e.mediaId);return{mediaId:e.mediaId,msgId:t,cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,href:e.content.href,params:e.content.params,thumb:e.content.thumb,childnumber:0,action:"",description:"",type:"",thumbUrl:"",oriUrl:""},sendDttm:e.sendDttm,ttl:e.ttl,src:e.src,type:"file",fileType:e.type,extType:e.extType,id:0,updateTime:e.modifiedTime,localPath:e.localPath||"",folderPath:e.folderPath||"",downloadError:!1,dimension:"object"==typeof e.thumbMetadata?e.thumbMetadata:null,previewThumb:""}}toDomainFromMessage(e,t=`${og.c.UNKNOWN}${og.d.FROM_MSG}`){if(!e||!e.msgId||!e.message)throw Error("This messageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.toUid){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid},s=`This messageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${i}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""},type:lg(e.message.params)?og.a.FOLDER:og.a.FILE,src:t,extType:cg(e.message.params),sendDttm:s,ttl:e.ttl||0,modifiedTime:s,localPath:e.localPath||"",folderPath:e.folderPath||"",thumbMetadata:null}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"file",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts isn't valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.content&&(t.message={title:e.content.title,href:e.content.href,params:e.content.params,thumb:e.content.thumb,childnumber:0,action:"",description:"",type:"",thumbUrl:"",oriUrl:""}),e.hasOwnProperty("sendDttm")&&(t.sendDttm=e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("folderPath")&&(t.folderPath=e.folderPath||""),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),e.hasOwnProperty("dimension")&&(t.dimension=e.thumbMetadata?{width:e.thumbMetadata.width,height:e.thumbMetadata.height,type:e.thumbMetadata.type,orientation:e.thumbMetadata.orientation,bigRes:e.thumbMetadata.bigRes}:null),t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts isn't valid!");const t={};return e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:e.message.title,href:e.message.href,params:e.message.params,thumb:e.message.thumb||""}),e.hasOwnProperty("fileType")&&(t.type=e.fileType),e.hasOwnProperty("extType")&&(t.extType=e.extType||""),e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("localPath")&&(t.localPath=e.localPath||""),e.hasOwnProperty("folderPath")&&(t.folderPath=e.folderPath||""),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("dimension")&&(t.thumbMetadata=e.dimension?{width:e.dimension.width,height:e.dimension.height,type:e.dimension.type,orientation:e.dimension.orientation,bigRes:e.dimension.bigRes}:null),t}})||gg;var pg;i.ModuleContainer.register(tg,mg);let fg=Object(i.injectable)()(pg=class{toDomainFromOldDomain(e,t=`${og.c.UNKNOWN}${og.d.FROM_OLD_DB}`){if(!e||!e.message)throw Error("This oldLinkEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This oldLinkEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${i}_${e.userId}`,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:"object"==typeof e.message.title?e.message.title.title||"":e.message.title,params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type||""},type:-1,src:t,sendDttm:s,ttl:e.ttl,modifiedTime:e.updateTime||s,parsedInfo:null}}toDomainFromDTO(e){if(!e||!e.message)throw Error("This linkDTO isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.userId){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,userId:e.userId},s=`This linkDTO doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const t="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,s="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:e.mediaId,convId:e.userId,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:s,content:{title:"object"==typeof e.message.title?e.message.title.title:e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type},src:e.src,type:"number"==typeof e.linkType?e.linkType:-1,sendDttm:t,ttl:"number"==typeof e.ttl?e.ttl:0,modifiedTime:e.updateTime||t,parsedInfo:null}}async toDTO(e){if(!e||!e.mediaId)throw Error("This linkEntity isn't valid!");const t=e.msgId?e.msgId:await i.ModuleContainer.resolve(Ju).toMessagePKFromMediaPK(e.mediaId);return{mediaId:e.mediaId,msgId:t,cliMsgId:parseInt(e.cliMsgId),fromUid:e.fromUid,userId:e.convId,message:{title:e.content.title,params:e.content.params,href:e.content.href,thumb:e.content.thumb,description:e.content.description,type:e.content.type,action:"",childnumber:0,oriUrl:"",thumbUrl:""},sendDttm:e.sendDttm,type:"link",ttl:e.ttl,src:e.src,linkType:e.type,id:0,updateTime:e.modifiedTime,previewThumb:"",parsedInfo:"object"==typeof e.parsedInfo?Object(f.a)({},e.parsedInfo):null}}toDomainFromMessage(e,t=`${og.c.UNKNOWN}${og.d.FROM_MSG}`){if(!e)throw Error("This messageEntity isn't valid!");if(!e.cliMsgId||"0"!=e.fromUid&&!e.fromUid||!e.toUid){0;const t={cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid},s=`This messageEntity doesn't have key_from_to valid: ${JSON.stringify(t)}`;throw Error(s)}const s="string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm,i="number"==typeof e.fromUid?e.fromUid.toString():e.fromUid;return{mediaId:`${e.cliMsgId}_${i}_${e.toUid}`,convId:e.toUid,cliMsgId:"number"==typeof e.cliMsgId?e.cliMsgId.toString():e.cliMsgId,fromUid:i,content:{title:"object"===e.message.title?e.message.title.title:e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type},type:-1,src:t,sendDttm:s,ttl:e.ttl||0,modifiedTime:s,parsedInfo:null}}toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e){return{convId:e.convId,fromUid:e.fromUid,mediaType:"link",content:{params:e.content.params}}}toOldEAttsFromNewEAtts(e){if(!e||"object"!=typeof e)throw Error("newEAtts isn't valid!");const t={};return e.hasOwnProperty("content")&&"object"==typeof e.content&&(t.message={title:e.content.title,params:e.content.params,href:e.content.href,thumb:e.content.thumb,description:e.content.description,type:e.content.type,action:"",childnumber:0,oriUrl:"",thumbUrl:""}),e.hasOwnProperty("sendDttm")&&(t.sendDttm=e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("updateTime")&&(t.updateTime=e.modifiedTime||Date.now()),t}toNewEAttsFromDTOAtts(e){if(!e||"object"!=typeof e)throw Error("dtoAtts isn't valid!");const t={};var s;e.hasOwnProperty("message")&&"object"==typeof e.message&&(t.content={title:"object"==typeof e.message.title?(null===(s=e.message.title)||void 0===s?void 0:s.title)||"":e.message.title||"",params:e.message.params||"",href:e.message.href||"",thumb:e.message.thumb||"",description:e.message.description||"",type:e.message.type||""});return e.hasOwnProperty("sendDttm")&&(t.sendDttm="string"==typeof e.sendDttm?+e.sendDttm:e.sendDttm),e.hasOwnProperty("ttl")&&(t.ttl=e.ttl||0),e.hasOwnProperty("linkType")&&(t.type=e.linkType),e.hasOwnProperty("updateTime")&&(t.modifiedTime=e.updateTime||Date.now()),e.hasOwnProperty("parsedInfo")&&(t.parsedInfo=e.parsedInfo?{protocol:e.parsedInfo.protocol||"",host:e.parsedInfo.domain||""}:null),t}})||pg;i.ModuleContainer.register(ig,fg);var vg=s("GbHB");let bg=function(e){return e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN",e}({}),yg=function(e){return e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN",e}({}),Ig=function(e){return e[e.OLD=0]="OLD",e[e.NEW=1]="NEW",e[e.UNKNOWN=2]="UNKNOWN",e}({});const _g="DONE",Cg="NOT_DONE",Og="UNKNOWN",Sg="GET_FROM_OLD_DB",Eg="ADD_TO_NEW_DB",Mg="DELETE_FROM_OLD_DB",Tg="DONE",wg="FAILED",Rg="NEW",Lg="RUNNING",Fg="FAILED",Dg="persisted_job_desc_summaries",Ag="migration_state";class jg{constructor(e,t,s,i,a,n){this._dbInstance=void 0,this._mediaMigrationManager=void 0,this._dalInstance=ze.default.getInstance(),this.dbTable=void 0,this.logger=void 0,this.mediaType=void 0,this.dbTable=this._dalInstance[e][t],this._dbInstance=this._dalInstance[e],this.mediaType=s,this._mediaMigrationManager=a,this.logger=n.createZLogger(`${e}-${t}-repository`,[i])}async insert(e,t){if(!e)throw Error("[insert]: item is undefined!");if(!e.cliMsgId||!e.fromUid||!e.convId)throw Error(`[insert]: item doesn't have valid key_from_to: ${e.cliMsgId}_${e.fromUid}_${e.convId}`);return e.mediaId=`${e.cliMsgId}_${e.fromUid}_${e.convId}`,!!(await this.dbTable.insert(e,t))}insertMulti(e,t){if(!e||!e.length)throw Error("[insertMulti]: items is undefined or empty!");const s=[];return e.forEach((e=>{e.cliMsgId&&e.fromUid&&e.convId?(e.mediaId=`${e.cliMsgId}_${e.fromUid}_${e.convId}`,s.push(e)):this.logger.zsymb(21,"KWzaCy",["[insertMulti]: media doesn't have valid key_from_to: {}_{}_{}","hNTdsf"],e.cliMsgId,e.fromUid,e.convId)})),this.dbTable.insertMulti(s,t)}async update(e,t){if(!jg.isNewMediaIdFormat(e))throw Error("[update]: mediaId doesn't have new media id format!");return!!(await this.dbTable.update(e,t))}async updateMedia(e,t,s=bg.UNKNOWN){if(!e)throw Error("[updateMedia]: mediaIdObj is undefined!");const{newId:i,oldId:a}=e;if((s===bg.NEW||await this._isMigrationDone())&&i)return!!(await this.dbTable.update(i,t));if(s===bg.OLD&&a){let e;if(t){const s=this.getMediaMapper().toOldEAttsFromNewEAtts(t.value||{});return e=Object(f.a)(Object(f.a)({},t),{},{attributes:Object.keys(s),value:s}),!!(await this.getOldDBTable().update(a,e))}throw Error("options is undefined!")}try{if(i){if(await this.dbTable.get(i))return!!(await this.dbTable.update(i,t))}if(a){let e;if(t){const s=this.getMediaMapper().toOldEAttsFromNewEAtts(t.value||{});return e=Object(f.a)(Object(f.a)({},t),{},{attributes:Object.keys(s),value:s}),!!(await this.getOldDBTable().update(a,e))}throw Error("options is undefined!")}throw Error(`${i} or ${a} isn't valid!`)}catch(n){throw Error(`[updateMedia] - err: ${n.message}`)}}async updateMulti(e){return await this.dbTable.updateMulti(e)}async updateMultiMedias(e){throw Error("This updateMultiMedias isn't implemented!")}delete(e,t){if(!jg.isNewMediaIdFormat(e))throw Error("[delete]: mediaId doesn't have new media id format!");return this.dbTable.delete(e,t)}deleteMulti(e,t){if(!e||!e.length)throw Error("[deleteMulti]: mediaIds is undefined or empty!");if(e.some((e=>!jg.isNewMediaIdFormat(e))))throw Error("[deleteMulti]: mediaIds contains an id which doesn't have new media id format!");return this.dbTable.deleteMulti(e,t)}async deleteMedia(e,t,s=Ig.UNKNOWN){if(!e)throw Error("[deleteMedia]: mediaObj is undefined!");const{newId:i,oldId:a}=e;if((s===Ig.NEW||await this._isMigrationDone())&&i)return this.dbTable.delete(i);if(s===Ig.OLD&&a)return this.getOldDBTable().delete(a,t);{const e=[];i&&e.push(this.dbTable.delete(i,t)),a&&e.push(this.getOldDBTable().delete(a,t));return(await Promise.allSettled(e)).every((e=>"fulfilled"===e.status&&e.value))}}async deleteMultiMedias(e,t){if(!e||!e.length)throw Error("[deleteMultiMedias]: mediaIdObjs is undefined or empty!");const s={success:[],fail:[]},i=[];for(const{newId:a,oldId:n,deleteTo:r}of e){const e=(r===Ig.NEW?a:r===Ig.OLD?n:a||n||"")||"",o=async()=>{try{await this.deleteMedia({newId:a,oldId:n},t,r)&&s.success.push(e)}catch(o){var i;const t=[null==o||null===(i=o.toString)||void 0===i?void 0:i.call(o),null==o?void 0:o.stack].join("\n");this.logger.zsymb(18,"NgAtmt",t),s.fail.push(e)}};i.push(o)}return await Promise.allSettled(i.map((e=>e()))),s}async get(e,t){if(!jg.isNewMediaIdFormat(e))throw Error("[get]: mediaId doesn't have new media id format!");return this.dbTable.get(e,t)}async getMulti(e,t){const{newIdFormats:s,oldIdFormats:i}=e.reduce(((e,t)=>(jg.isNewMediaIdFormat(t)&&e.newIdFormats.push(t),e)),{newIdFormats:[],oldIdFormats:[]});let a=[];if(s.length){const e=await this.dbTable.getMulti(s,t);e.length&&a.push(...e)}return a}async getMedia(e,t,s=yg.UNKNOWN){if(!e)throw Error("[getMedia]: mediaIdObj params is undefined!");const{newId:i,oldId:a}=e;if((s===yg.NEW||await this._isMigrationDone())&&i)return this.dbTable.get(i,t);if(s===yg.OLD&&a){const e=await this.getOldDBTable().get(a,t);if(e)return this.getMediaMapper().toDomainFromOldDomain(e)}else{if(i){const e=await this.dbTable.get(i,t);if(e)return e}if(a){const e=await this.getOldDBTable().get(a,t);if(e)return this.getMediaMapper().toDomainFromOldDomain(e)}}}async getMultiMedias(e,t){if(!e||!e.length)throw Error("[getMultiMedias]: mediaIdObjs is undefined or empty!");let s=[];const i=[];for(const{newId:a,oldId:n,getFrom:r}of e)i.push(this.getMedia({newId:a,oldId:n},t,"number"==typeof r?r:yg.UNKNOWN));return s=(await Promise.allSettled(i)).map((e=>"fulfilled"===e.status?e.value:void 0)),s}getAll(e,t){if(!e)throw Error("[getAll]: keyRange is undefined!");return this.dbTable.getAll(e,t)}async getAllInOldDB(e,t){if(await this._isMigrationDone())return[];if(!e)throw Error("[getAllInOldDB]: keyRange is undefined!");const s=await this.getOldDBTable().getAll(e,t);return null!=s&&s.length?s.map((e=>this.getMediaMapper().toDomainFromOldDomain(e))):[]}static isNewMediaIdFormat(e){if(!e)return!1;const t=e.split("_");return 3===t.length&&t.every(Boolean)}static filterMedia(e,t){if(!(t&&(t.member||t.date&&(t.date.start||t.date.end)||t.name||t.ext)))return!0;if(!t.member||e.fromUid&&e.fromUid===t.member){let i,a,n;if(t.name){if(e.message.params&&e.message.href)try{let t=JSON.parse(e.message.params);i=t.mediaTitle?Is.default.simpleStripVietnamese(t.mediaTitle):Is.default.simpleStripVietnamese(e.message.title),a=t.src}catch(s){return Is.default.logCoreError(s),!1}n=Is.default.simpleStripVietnamese(t.name)}if(!t.name||n.length<=i.length&&Is.default.searchContent(i,n)){let i=!1;if(t.ext&&(i=R.fileExt[t.ext].some((t=>{if(!e.message.title){const t=vg.a.decrypt(e.message,mt.default.UIN,!1);try{e.message=JSON.parse(t)}catch(s){e.message={title:""}}}return e.message.title.endsWith(t)}))),!t.ext||i)return null==t.date.start&&null==t.date.end||(e.sendDttm>=t.date.start?e.sendDttm<=t.date.end:0)}}return!1}async isExistedMedia(e){let t=!1;if(e){const{newId:s,oldId:i}=e;s&&(t=!!(await this.dbTable.get(s))),i&&!t&&(t=!!(await this.getOldDBTable().get(i)))}return t}async getLastMediasOfConv(e,t,s=100){if(!e||!t)throw Error(`[getLastMediasOfConv]: convId: ${e}, lastItemOptions:${JSON.stringify(t)} isn't valid!`);const{sendDttm:i,cliMsgId:a,msgId:n}=t,r=await this.getLastMediasOfConvInNewDB(e,{sendDttm:i,cliMsgId:a},s);return r.length<s&&!(await this._isMigrationDone())&&r.push(...await this.getLastMediasOfConvInOldDB(e,{msgId:n},s-r.length)),r}async countMediaOfConv(e,t){let s=0;if(!(e&&t&&t.from&&t.to))throw Error(`[countMediaOfConv]: convId: ${e}, options: ${JSON.stringify(t)} isn't valid!`);const{from:i,to:a}=t;return s=await this.countMediaOfConvInNewDB(e,{from:{sendDttm:i.sendDttm,cliMsgId:i.cliMsgId},to:{sendDttm:a.sendDttm,cliMsgId:a.cliMsgId}}),await this._isMigrationDone()||(s+=await this.countMediaOfConvInOldDB(e,{from:{msgId:i.msgId},to:{msgId:a.msgId}})),s}countMediaOfConvInNewDB(e,t){const{from:s,to:i}=t,a={from:[e,s.sendDttm,s.cliMsgId],to:[e,i.sendDttm,i.cliMsgId],excludeFrom:!1,excludeTo:!1};return this.dbTable.count(a,{index:"convId_sendDttm_cliMsgId"})}async countMediaOfConvInOldDB(e,t){if(await this._isMigrationDone())return 0;const{from:s,to:i}=t,a={from:[e,s.msgId.length,s.msgId],to:[e,i.msgId.length,i.msgId],excludeFrom:!1,excludeTo:!1};return this.getOldDBTable().count(a,{index:"userId_sendDttm_msgId"})}async getMediasOfConv(e,t,s,i){if(!e||!t||!s)return Promise.resolve([]);let a=[];if(ms.default.load_media.optimize_mode&&(a=await this._isMigrationDone()?await this.getMediasOfConvOptimizeMode(e,t,s,i):await this.getMediasOfConvOptimizeModeInMixedDB(e,t,s,i)),null!=i&&i.deletePointOfConv){const{lastId:e,lastSendDttm:t,lastCliMsgId:s}=i.deletePointOfConv;return a.filter((i=>!(e&&i.msgId&&i.msgId<=e)&&(!(t&&i.sendDttm<=t)&&!(s&&i.cliMsgId<=s))))}return a}async getMediasOfConvOptimizeModeInMixedDB(e,t,s,i){let a=!1,n=!1;i&&i.date&&(null!==i.date.start||null!==i.date.end)&&(a=!0);const r=[],{sendDttm:o,cliMsgId:d}=await this.getSendDttmOfLatestMediaInOldDB(e),{sendDttm:l,cliMsgId:c,msgId:h}=t,u={from:[e,0,""],to:[e,l,c],excludeFrom:!0,excludeTo:!0},g={index:"convId_sendDttm_cliMsgId",limit:s,direction:Fe.CursorDirection.PREV,useLGKeyRange:!0,predicate:e=>{if(!e)return!1;if(!Is.default.mapHasItem(e.content))return!1;if(!In.a.instance.filterDBMessage(e))return!1;let t=jg.filterMedia({message:e.content,fromUid:e.fromUid,sendDttm:e.sendDttm},i);return 0===t&&(n=!0),!!t&&(e.sendDttm>o&&e.cliMsgId>d||(r.push(e),!1))},aborted:a?()=>n:void 0};try{let t=await this.dbTable.getAll(u,g);if(t.length<s){const a=await this.getMediasOfConvOptimizeModeInOldDB(e,{msgId:h},s-t.length,i),n=[];a.length>0?r.length>0?(a.forEach((e=>{const t=r[0];t&&e.sendDttm<=t.sendDttm&&e.cliMsgId<=t.cliMsgId?(n.push(t),r.shift()):n.push(e)})),r.length>0&&n.push(...r),t.push(...n.slice(0,s-t.length))):t.push(...a):r.length>0&&t.push(...r)}return t}catch(m){const t=[e,this.mediaType,s,l,c,!!i].join("_");throw this.logger.zsymb(21,"ZOhVql",["[getMediasOfConvOptimizeModeInMixedDB] errInfo: {}","yo23UW"],t),m}}async getSendDttmOfLatestMediaInOldDB(e){const t={from:[e,0,""],to:[e,R.MessageConstants.MAX_SENDDTTM,R.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},s={index:"userId_sendDttm_msgId",limit:1,direction:Fe.CursorDirection.PREV},i=await this.getOldDBTable().getAll(t,s);if(!i||!i[0])return{sendDttm:0,cliMsgId:"0"};return{sendDttm:"string"==typeof i[0].sendDttm?parseInt(i[0].sendDttm):i[0].sendDttm,cliMsgId:""+(i[0].cliMsgId||0)}}async getMediasOfConvOptimizeMode(e,t,s,i){if(!e||!t||!s)throw Error(`[getMediasOfConvOptimizeMode]: convId: ${e}, lastItemOptions: ${JSON.stringify(t)}, limit: ${s} isn't valid!`);const{sendDttm:a,cliMsgId:n,msgId:r}=t,o=await this.getMediasOfConvOptimizeModeInNewDB(e,{sendDttm:a,cliMsgId:n},s,i);return o.length<s&&!(await this._isMigrationDone())&&o.push(...await this.getMediasOfConvOptimizeModeInOldDB(e,{msgId:r},s-o.length,i)),o}getMediasOfConvOptimizeModeInNewDB(e,t,s,i){let a=!1,n=!1;i&&i.date&&(null!==i.date.start||null!==i.date.end)&&(a=!0);const{sendDttm:r,cliMsgId:o}=t,d={from:[e,0,""],to:[e,r,o],excludeFrom:!0,excludeTo:!0},l={index:"convId_sendDttm_cliMsgId",limit:s,direction:Fe.CursorDirection.PREV,predicate:e=>{if(!e)return!1;if(!Is.default.mapHasItem(e.content))return!1;if(!In.a.instance.filterDBMessage(e))return!1;let t=jg.filterMedia({message:e.content,fromUid:e.fromUid,sendDttm:e.sendDttm},i);return 0===t&&(n=!0),!!t},aborted:a?()=>n:void 0};try{return this.dbTable.getAll(d,l)}catch(c){const t=[e,this.mediaType,s,r,o,!!i].join("_");throw this.logger.zsymb(21,"Rz75ij",["[getMediasOfConvOptimizeModeInNewDB] errInfo: {}","VnoU0Z"],t),c}}async getMediasOfConvOptimizeModeInOldDB(e,t,s,i){if(await this._isMigrationDone())return[];let a=!1,n=!1;i&&i.date&&(null!=i.date.start||null!=i.date.end)&&(a=!0);const{msgId:r}=t,o={from:[e,0,""],to:[e,r.length,r],excludeFrom:!0,excludeTo:!0},d={index:"userId_sendDttm_msgId",limit:s,direction:Fe.CursorDirection.PREV,useLGKeyRange:!0,predicate:e=>{if(e){if(e.msgId&&e.msgId.includes("_"))return!1;if(!Is.default.mapHasItem(e.message))return!1}if(!In.a.instance.filterDBMessage(e))return!1;let t=jg.filterMedia(e,i);return 0===t&&(n=!0),!!t},aborted:a?()=>n:void 0};try{const e=await this.getOldDBTable().getAll(o,d);return(await this.correctMediasInOldDB(e)).map((e=>this.getMediaMapper().toDomainFromOldDomain(e)))}catch(l){const t=[e,this.mediaType,s,r,!!i].join("_");throw this.logger.zsymb(21,"gk1jop",["[getMediasOfConvOptimizeModeInOldDB] errInfo: {}","uhkAuA"],t),l}}getLastMediasOfConvInNewDB(e,t,s){const{sendDttm:i,cliMsgId:a}=t,n={from:[e,0,""],to:[e,i,a],excludeFrom:!1,excludeTo:!1},r={index:"convId_sendDttm_cliMsgId",limit:s,direction:Fe.CursorDirection.PREV};return this.dbTable.getAll(n,r)}async getLastMediasOfConvInOldDB(e,t,s){if(await this._isMigrationDone())return[];const{msgId:i}=t,a={from:[e,0,""],to:[e,i.length,i],excludeFrom:!1,excludeTo:!1},n={index:"userId_sendDttm_msgId",limit:s,direction:Fe.CursorDirection.PREV},r=await this.getOldDBTable().getAll(a,n);return r.length>0?r.map((e=>Object(f.a)(Object(f.a)({},this.getMediaMapper().toDomainFromOldDomain(e)),{},{msgId:e.msgId}))):[]}correctMediasInOldDB(e,t={saveBack:!0}){return e&&e.length?new Promise((s=>{let i=[],a={},n=[];if(e.forEach((e=>{if(e&&e.msgId&&e.sendDttm){const t=null==e.fromUid;e.type&&e.cliMsgId&&!t?n.push(e):(i.push(e.msgId),a[e.msgId]=e)}})),!i.length)return s(n);{let r="";const o=(e,t)=>{let s=!0;switch(t.msgType){case R.MSG_PHOTO:case R.MSG_PHOTO_2:r="image",e.subType=R.MSG_SUBTYPE_PHOTO;break;case R.MSG_VIDEO:r="image",e.subType=R.MSG_SUBTYPE_MEDIA_VIDEO;break;case R.MSG_FILE:r="file";break;case R.MSG_CONTACT:"object"==typeof t.message&&"recommened.link"===t.message.action&&(r="link")}e.cliMsgId=t.cliMsgId,e.type=r;return""!==t.fromUid&&null!=t.fromUid?(s=!0,e.fromUid=t.fromUid+""):s=!1,{isSuccess:s,data:s?e:null}},d=e[0].userId;mt.default.getConvMessagesByIdsInQueue(i,d).then((e=>{const i=[],r=[];if(e){for(let s in e)if(e[s]){const t=a[s];delete a[s];const{isSuccess:n,data:d}=o(t,e[s]);n&&d?i.push(d):r.push(s)}const t=Object.getOwnPropertyNames(a);t.length&&t.forEach((e=>{r.push(e)}))}let d=n.concat(i);return d.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm))),i.length&&t.saveBack&&this.deleteAndInsertInOldDB(i),r.length&&this.getOldDBTable().deleteMulti(r),s(d)})).catch((e=>s(n)))}})):Promise.resolve([])}async deleteAndInsertInOldDB(e){if(!e||!e.length)throw Error(`[deleteAndInsertInOldDB]: oldItems: ${JSON.stringify(e)} isn't valid!`);return this.getOldDBTable().insertMulti(e,{replace:!0})}async _isMigrationDone(){return(await this._mediaMigrationManager.getMediaMigrationState()).stateName===_g}}class Pg extends jg{constructor(e,t,s,i,a,n){super(e,t,s,i,a,n)}async getImageMessagesForPhotoViewer(e,t,s,i,a,n){const r=await this.getMsgIdsOfImageMediaForPhotoViewer(e,s,t,i,a,n);if(null==r||!r.length)return[];const o=await Promise.all(r.map((e=>this.getMediaMapper().toDTO(e)))),d=[];let l=[];for(const c of o)d.push(ze.default.getInstance().Core.Message.get(c.msgId,{partition:e}).then((e=>{e?l.push(Object(f.a)(Object(f.a)({},c),e)):c.message&&l.push(c)})));return await Promise.all(d),l.reverse(),mt.default._fillExifBeforeShow(l),l}async getMsgIdsOfImageMediaForPhotoViewer(e,t,s,i,a,n){const{cliMsgId:r,sendDttm:o,msgId:d}=t,l=i&&a;let c=!1;const h=()=>c,u=e=>{if(!(n&&(n.member||n.date&&(n.date.start||n.date.end)||n.name||n.ext)))return!0;if(!n.member||e.fromUid&&e.fromUid===n.member){let s,i,a;if(n.name){if(e.message.params&&e.message.href)try{let t=JSON.parse(e.message.params);s=t.mediaTitle?Is.default.simpleStripVietnamese(t.mediaTitle):Is.default.simpleStripVietnamese(e.message.title),i=t.src}catch(t){return this.logger.zsymb(18,"D5NMOe",t),!1}a=Is.default.simpleStripVietnamese(n.name)}if(!n.name||Is.default.searchContent(s,a)||Is.default.searchContent(i,a)){let t=!1;if(n.ext&&(t=R.fileExt[n.ext].some((t=>e.message.title.endsWith(t)))),!n.ext||t)return!n.date.start||!n.date.end||(n.date.end<e.sendDttm?e.sendDttm<n.date.start+864e5:(c=!0,!1))}}return!1};let g=[];if(i){const t=async()=>{let t=[];if(!(await this._isMigrationDone())){const i={from:[e,d.length,d],to:[e,R.MessageConstants.MAX_MSG_ID.length,R.MessageConstants.MAX_MSG_ID],excludeFrom:!l,excludeTo:!l},a={limit:s,index:"userId_sendDttm_msgId",direction:Fe.CursorDirection.NEXT,predicate:e=>u({fromUid:e.fromUid,message:e.message,sendDttm:"string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm}),aborted:h,useLGKeyRange:!0};t=await this.getAllInOldDB(i,a)}if(t.length<s){const i={from:[e,o,r],to:[e,parseInt(R.MessageConstants.MAX_SENDDTTM),R.MessageConstants.MAX_MSG_ID],excludeFrom:!l,excludeTo:!l},a={limit:s-t.length,index:"convId_sendDttm_cliMsgId",direction:Fe.CursorDirection.NEXT,predicate:e=>u({fromUid:e.fromUid,message:e.content,sendDttm:e.sendDttm}),aborted:h,useLGKeyRange:!0};t.push(...await this.getAll(i,a))}return t};g.push(t())}if(a){const t=async()=>{let t=[];const i={from:[e,0,""],to:[e,o,r],excludeFrom:!l,excludeTo:!l},a={limit:s,index:"convId_sendDttm_cliMsgId",direction:Fe.CursorDirection.PREV,predicate:e=>u({fromUid:e.fromUid,message:e.content,sendDttm:e.sendDttm}),aborted:h,useLGKeyRange:!0};if(t=await this.getAll(i,a),t.length<s&&!(await this._isMigrationDone())){const i={from:[e,0,""],to:[e,d.length,d],excludeFrom:!l,excludeTo:!l},a={limit:t?s-t.length:s,index:"userId_sendDttm_msgId",direction:Fe.CursorDirection.PREV,predicate:e=>u({fromUid:e.fromUid,message:e.message,sendDttm:"string"==typeof e.sendDttm?parseInt(e.sendDttm):e.sendDttm}),aborted:h,useLGKeyRange:!0};t.push(...await this.getAllInOldDB(i,a))}return t};g.push(t())}try{const e=await Promise.all(g);if(2===e.length){let t=e[0].reverse();return t.pop(),t=t.concat(e[1]),t}return a?e[0]:e[0].reverse()}catch(m){return this.logger.zsymb(18,"aJ1Y1M",m),[]}}}const Ng=Object(i.define)("image-media-repository");var Ug,kg=s("H8Z7");Object(i.injectable)()(Ug=Object(i.singleton)(Ng)(Ug=function(e,t){return Object(i.inject)(sg)(e,void 0,0)}(Ug=function(e,t){return Object(i.inject)(kg.c)(e,void 0,1)}(Ug=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,2)}(Ug=Reflect.metadata("design:type",Function)(Ug=Reflect.metadata("design:paramtypes",[Object,void 0===kg.IMediaMigrationManager?Object:kg.IMediaMigrationManager,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Ug=class extends Pg{constructor(e,t,s){super("Media","Image","image","crud-image-media",t,s),this.imageMediaMapper=void 0,this.oldDBTable=void 0,this.imageMediaMapper=e,this.oldDBTable=this._dalInstance.Core.Image}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=ze.default.getInstance().Core.Image),this.oldDBTable}getMediaMapper(){return this.imageMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,s){throw Error("Currently, this method isn't supported!")}})||Ug)||Ug)||Ug)||Ug)||Ug)||Ug);class Bg extends jg{constructor(e,t,s,i,a,n){super(e,t,s,i,a,n)}async getLastestAddedFiles(e,t){if(!e||"number"!=typeof t)throw Error(`[getLastestAddedFiles]: ${JSON.stringify(e)} or ${t} isn't valid!`);const s=await this.getLastestAddedFilesInNewDB(e,t);return s.length<t&&!(await this._isMigrationDone())&&s.push(...await this.getLastestAddedFilesInOldDB({sendDttm:e.sendDttm},t-s.length)),s}async getLastestAddedFilesInNewDB(e,t){const{convId:s,sendDttm:i,cliMsgId:a}=e;return this.dbTable.getAll({from:["",0,0],to:[s,i,a],excludeFrom:!0,excludeTo:!0},{index:"convId_sendDttm_cliMsgId",limit:t,direction:Fe.CursorDirection.PREV})}async getLastestAddedFilesInOldDB(e,t){if(await this._isMigrationDone())return[];const s=await this.getOldDBTable().getAll({from:0,to:e.sendDttm,excludeFrom:!0,excludeTo:!0},{index:"sendDttm",limit:t,direction:Fe.CursorDirection.PREV});return s.length>0?s.map((e=>this.getMediaMapper().toDomainFromOldDomain(e))):[]}}const Gg=Object(i.define)("file-media-repository");var xg;Object(i.injectable)()(xg=Object(i.singleton)(Gg)(xg=function(e,t){return Object(i.inject)(tg)(e,void 0,0)}(xg=function(e,t){return Object(i.inject)(kg.c)(e,void 0,1)}(xg=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,2)}(xg=Reflect.metadata("design:type",Function)(xg=Reflect.metadata("design:paramtypes",[Object,void 0===kg.IMediaMigrationManager?Object:kg.IMediaMigrationManager,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(xg=class extends Bg{constructor(e,t,s){super("Media","File","file","crud-file-media",t,s),this.fileMediaMapper=void 0,this.oldDBTable=void 0,this.fileMediaMapper=e,this.oldDBTable=this._dalInstance.Core.File}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=ze.default.getInstance().Core.File),this.oldDBTable}getMediaMapper(){return this.fileMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,s){throw Error("Currently, this method isn't supported!")}})||xg)||xg)||xg)||xg)||xg)||xg);class zg extends jg{constructor(e,t,s,i,a,n){super(e,t,s,i,a,n)}}const Vg=Object(i.define)("link-media-repository");var Hg;Object(i.injectable)()(Hg=Object(i.singleton)(Vg)(Hg=function(e,t){return Object(i.inject)(ig)(e,void 0,0)}(Hg=function(e,t){return Object(i.inject)(kg.c)(e,void 0,1)}(Hg=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,2)}(Hg=Reflect.metadata("design:type",Function)(Hg=Reflect.metadata("design:paramtypes",[Object,void 0===kg.IMediaMigrationManager?Object:kg.IMediaMigrationManager,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Hg=class extends zg{constructor(e,t,s){super("Media","Link","link","crud-link-media",t,s),this.linkMediaMapper=void 0,this.oldDBTable=void 0,this.linkMediaMapper=e,this.oldDBTable=this._dalInstance.Core.Link}getOldDBTable(){return this.oldDBTable||(this.oldDBTable=ze.default.getInstance().Core.Link),this.oldDBTable}getMediaMapper(){return this.linkMediaMapper}deleteMatch(e,t){throw Error("Currently, this method isn't supported!")}getAllKey(e,t){throw Error("Currently, this method isn't supported!")}put(e,t){throw Error("Currently, this method isn't supported!")}runTransaction(e,t,s){throw Error("Currently, this method isn't supported!")}})||Hg)||Hg)||Hg)||Hg)||Hg)||Hg);const $g=Object(i.define)("utils-media-repository");class Wg{constructor(e){this._lruCache=void 0,this._lruCache=new ce.default(e)}get(e){return this._lruCache.get(e)}getAll(e="ASC"){const t="ASC"===e?this._lruCache.entriesAscending():this._lruCache.entriesDescending();return Object.values(t)}getAllKey(e="ASC"){const t="ASC"===e?this._lruCache.entriesAscending():this._lruCache.entriesDescending();return Object.keys(t)}set(e,t){this._lruCache.set(e,t)}delete(e){return this._lruCache.delete(e)}clear(){this._lruCache.clear()}}var qg;Object(i.injectable)()(qg=Object(i.singleton)($g)(qg=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(qg=Reflect.metadata("design:type",Function)(qg=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(qg=class extends jr.b{constructor(e){super("Media","UtilsMedia","utils-media-repo",e,"id",og.b),this._cache=new Wg({maxSize:og.b})}async isExisted(e){if(!e)return!1;const t=this._cache.get(e);if(!t){const t=await this._dbCollection.get(e);return t&&this._cache.set(e,t),!!t}return!!t}async update(e,t){if(await this._dbCollection.update(e,t)){const t=await this._dbCollection.get(e);if(t)return this._cache.set(e,t),!0}return!1}async updateReturnEntity(e,t){if(await this._dbCollection.update(e,t)){const t=await this._dbCollection.get(e);if(t)return this._cache.set(e,t),t}throw Error(`[update]: cannot update record with id: ${e}`)}async updateMulti(e){const t=await this._dbCollection.updateMulti(e);return t.success.forEach((e=>this._cache.set(e.id,e))),t}getAllSenderIds(e,t=!0){if(!e)throw Error(`[getAllSenderIds]: id: ${e} isn't valid!`);return this._getItemListByField(e,"senderIds",t)}getAllFileTypes(e,t){if(!e)throw Error(`[getAllFileTypes]: id: ${e} isn't valid!`);return this._getItemListByField(e,"fileTypes",t)}saveSender(e,t){if(!e)throw Error(`[saveSender]: id: ${e} isn't valid!`);return this._saveValueOnField(e,"senderIds",t)}saveFileType(e,t){if(!e)throw Error(`[saveFileType]: id: ${e} isn't valid!`);return this._saveValueOnField(e,"fileTypes",t)}saveSenders(e,t){if(!e)throw Error(`[saveSenders]: id: ${e} isn't valid!`);return this._saveValuesOnField(e,"senderIds",t)}saveFileTypes(e,t){if(!e)throw Error(`[saveSenders]: id: ${e} isn't valid!`);return this._saveValuesOnField(e,"fileTypes",t)}deleteSender(e,t){if(!e)throw Error(`[deleteSender]: id: ${e} isn't valid!`);return this._deleteValueOnField(e,"senderIds",t)}deleteFileType(e,t){if(!e)throw Error(`[deleteFileType]: id: ${e} isn't valid!`);return this._deleteValueOnField(e,"fileTypes",t)}deleteSenders(e,t){if(!e)throw Error(`[deleteSenders]: id: ${e} isn't valid!`);return this._deleteValuesByField(e,"senderIds",t)}deleteFileTypes(e,t){if(!e)throw Error(`[deleteFileTypes]: id: ${e} isn't valid!`);return this._deleteValuesByField(e,"fileTypes",t)}async _saveValueOnField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){i[t].some((e=>e===s))||(i[t].push(s),await this.update(e,{value:{[t]:i[t]},attributes:[t]}))}return!0}async _saveValuesOnField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){const a=s.filter((e=>!i[t].includes(e)));a.length&&(i[t].push(...a),await this.update(e,{value:{[t]:i[t]},attributes:[t]}))}return!0}async _deleteValueOnField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){const a=i[t].indexOf(s);-1!==a&&(i[t].splice(a,1),await this.update(e,{value:{[t]:i[t]},attributes:[t]}))}return!0}async _deleteValuesByField(e,t,s){const i=this._cache.get(e)||await this._dbCollection.get(e);if(i){const a=i[t].filter((e=>!s.includes(e)));a.length<i[t].length&&(i[t]=a,await this.update(e,{value:{[t]:a},attributes:[t]}))}return!0}async _getItemListByField(e,t,s=!0){var i;const a=this._cache.get(e);var n;if(s)return a&&null!==(n=a[t])&&void 0!==n&&n.length?a[t].slice():[];const r=await this._dbCollection.get(e);return r&&!a&&this._cache.set(e,Object(f.a)({},r)),r&&null!==(i=r[t])&&void 0!==i&&i.length?r[t].slice():[]}})||qg)||qg)||qg)||qg);const Kg=Object(i.define)("media-mapper-factory");var Zg;Object(i.injectable)()(Zg=Object(i.singleton)(Kg)(Zg=class{getMediaMapper(e){switch(e){case"image":return i.ModuleContainer.resolve(sg);case"file":return i.ModuleContainer.resolve(tg);case"link":return i.ModuleContainer.resolve(ig);default:return}}})||Zg);const Qg=Object(i.define)("media-repository-factory");var Jg;Object(i.injectable)()(Jg=Object(i.singleton)(Qg)(Jg=class{getMediaRepository(e){switch(e){case"image":return i.ModuleContainer.resolve(Ng);case"link":return i.ModuleContainer.resolve(Vg);case"file":return i.ModuleContainer.resolve(Gg);default:return}}})||Jg);const Yg="utils-media-domain-service",Xg=Object(i.define)(Yg);function em(e){const t=e;return function(e,s,i="error"){const a=`${e} ${i}: ${s}`;switch(i){case"error":t.zsymb(18,"3_mDZr",a);break;case"debug":t.zsymb(12,"lD8RuK",a);break;case"info":t.zsymb(0,"pBFxAx",a)}}}var tm;Object(i.injectable)()(tm=Object(i.singleton)(Xg)(tm=function(e,t){return Object(i.inject)($g)(e,void 0,0)}(tm=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(tm=Reflect.metadata("design:type",Function)(tm=Reflect.metadata("design:paramtypes",[Object,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(tm=class{constructor(e,t){this._log=void 0,this._logger=void 0,this._utilsMediaRepository=void 0,this._utilsMediaRepository=e,this._logger=t.createZLogger(`${Yg}`,["mn-utils-media-de"]),this._log=em(this._logger)}async create(e){if(!e)throw Error(`utilsMedia(${e}) isn't existed!`);if(!e.convId||!e.mediaType)throw Error(`cannot create utilsMedia with convId(${e.convId}) and mediaType(${e.mediaType})`);if(await this._utilsMediaRepository.isExisted(`${e.convId}_${e.mediaType}`))throw this._log("[create]",`existed utilsMedia have convId(${e.convId}) and mediaType(${e.mediaType})`,"info"),Error(`existed utilsMedia have convId(${e.convId}) and mediaType(${e.mediaType})`);return{id:`${e.convId}_${e.mediaType}`,convId:e.convId,mediaType:e.mediaType,senderIds:e.senderIds||[],fileTypes:e.fileTypes||[]}}addSenders(e,t){if(!e)throw Error("[addFileTypes] utilsMediaEntity isn't existed!");if(!t||!t.length)return Object(f.a)({},e);return Object(f.a)(Object(f.a)({},e),{},{senderIds:t.reduce(((e,t)=>(e.includes(t)||e.push(t),e)),[...e.senderIds]||!1)})}addFileTypes(e,t){if(!e)throw Error("[addFileTypes] utilsMediaEntity isn't existed!");if(!t||!t.length)return Object(f.a)({},e);const s=Object(f.a)(Object(f.a)({},e),{},{fileTypes:t.reduce(((e,t)=>(e.includes(t)||e.push(t),e)),[...e.fileTypes]||!1)});return s}})||tm)||tm)||tm)||tm)||tm);const sm="utils-media-app-service",im=Object(i.define)(sm);var am;Object(i.injectable)()(am=Object(i.singleton)(im)(am=function(e,t){return Object(i.inject)(Xg)(e,void 0,0)}(am=function(e,t){return Object(i.inject)($g)(e,void 0,1)}(am=function(e,t){return Object(i.inject)(eg)(e,void 0,2)}(am=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,3)}(am=Reflect.metadata("design:type",Function)(am=Reflect.metadata("design:paramtypes",[Object,Object,Object,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(am=class{constructor(e,t,s,i){this._utilsMediaDomainService=void 0,this._utilsMediaRepository=void 0,this._mapper=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaDomainService=e,this._utilsMediaRepository=t,this._mapper=s,this._logger=i.createZLogger(sm,["manage-utils-media-in-app"]),this._log=em(this._logger)}async create(e){try{const t=await this._utilsMediaDomainService.create(e);return this._mapper.toUtilsMediaDTOFromDomain(await this._utilsMediaRepository.insert(t))}catch(t){return void this._log("[create]",t.message)}}async createOrUpdate(e){try{const t=`${e.convId}_${e.mediaType}`;let s=await this._utilsMediaRepository.get(t);if(s){const{senderIds:i,fileTypes:a}=e;let n=s.senderIds,r=s.fileTypes;if(i&&i.length&&(n=this._utilsMediaDomainService.addSenders(s,i).senderIds),a&&a.length&&(r=this._utilsMediaDomainService.addFileTypes(s,a).fileTypes),n.length!==s.senderIds.length||r.length!==s.fileTypes.length){const e=await this._utilsMediaRepository.updateReturnEntity(t,{value:{senderIds:n,fileTypes:r},attributes:["senderIds","fileTypes"]});return this._mapper.toUtilsMediaDTOFromDomain(e)}return this._mapper.toUtilsMediaDTOFromDomain(s)}return this.create(e)}catch(t){return void this._log("[createOrUpdate]",t.message)}}async deleteUtilsMediasByConvId(e){try{if(!e)return[];const t=Object.values(og.e).map((t=>`${e}_${t}`));return(await this._utilsMediaRepository.deleteMulti(t)).success}catch(t){return this._log("[deleteUtilsMediasByConvId]",t.message),[]}}async createOrUpdateFromMedias(e){try{if(!e||!e.length)return[];const t=new Map;e.forEach((e=>{let s=t.get(e.convId);if("image"===e.mediaType||"link"===e.mediaType)if(s){-1===s.senderIds.indexOf(e.fromUid)&&(s.senderIds.push(e.fromUid),t.set(e.convId,s))}else s={convId:e.convId,mediaType:e.mediaType,senderIds:[e.fromUid],fileTypes:[]},t.set(e.convId,s);else if("file"===e.mediaType){const i=this._getFileType(e.content.params);if(s){-1===s.fileTypes.indexOf(i)&&(s.fileTypes.push(i),t.set(e.convId,s))}else s={convId:e.convId,mediaType:e.mediaType,senderIds:[e.fromUid],fileTypes:[i]},t.set(e.convId,s)}}));const s=Array.from(t.values());return(await Promise.all(s.map((e=>this.createOrUpdate(e))))).filter(Boolean)}catch(t){return this._log("[createOrUpdateFromMedias]",t.message),[]}}_getFileType(e){try{const t=JSON.parse(e);if(!t)throw Error(`paramsObj is ${t}!`);const{fileExt:s,fType:i}=t;return"zip"===s&&2===i?"folder":s.toLowerCase()}catch(t){return this._log("[_getFileType]",t.message),""}}})||am)||am)||am)||am)||am)||am)||am);const nm=Object(i.define)("media-migration-state-persist");var rm;Object(i.injectable)()(rm=Object(i.singleton)(nm)(rm=class{constructor(){this._localStorage=S.default.getInstance()}async saveMigrationState(e){e&&await this._localStorage.setItemForCurrentUserAsync(Ag,JSON.stringify(e))}async getMigrationState(){try{const e=await this._localStorage.getItemForCurrentUserAsync(Ag);return e?JSON.parse(e):{stateName:Og,mediaTableNamesToMigrate:[]}}catch(e){return{stateName:Og,mediaTableNamesToMigrate:[]}}}async saveJobDescSummaries(e){Array.isArray(e)&&await this._localStorage.setItemForCurrentUserAsync(Dg,JSON.stringify(e))}async getSavedJobDescSummaries(){try{const e=await this._localStorage.getItemForCurrentUserAsync(Dg);if(!e)return[];return JSON.parse(e)}catch(e){return[]}}async clearPersistedJobDescSummaries(){await this._localStorage.removeItemForCurrentUserAsync(Dg)}})||rm);var om=s("mH7l"),dm=s.n(om);const lm=e=>"GET_FROM_OLD_DB"===e.name,cm=e=>"ADD_TO_NEW_DB"===e.name,hm=e=>"DELETE_FROM_OLD_DB"===e.name;function um(){return ms.default.media_migration_db.should_stop_migration}function gm(){return ms.default.media_migration_db.max_running_concurrency_job}function mm(){return ms.default.media_migration_db.delay_time_per_job}function pm(){return ms.default.media_migration_db.delay_time_each_k_jobs}function fm(){return ms.default.media_migration_db.media_limit_per_job}function vm(){return ms.default.media_migration_db.min_retry_after}function bm(){return ms.default.media_migration_db.max_retry_after}var ym=s("1erv");const Im={MAX_RETRY:0,INVALID_CONFIG_JITTER:1,INVALID_CONFIG_MIN:2,TIMEOUT:3,RETRY_ON_ERROR_CONDITION_FAIL:4};class _m extends Error{constructor(e){super(`ExpBackoff error:${e}`),this.code=e}}function Cm({step:e,nTry:t,jitter:s,min:i,max:a}){let n=i*Math.pow(e,t);if(s){const e=Math.random(),t=Math.floor(e*s*n);n=1&Math.floor(10*e)?n+t:n-t}return 0|Math.min(n,a)}function Om(e,t){return async function(...s){for await(const{sleep:a,duration:n,nTry:r}of function*(e){var t,s,i,a,n;const r=null!==(t=null==e?void 0:e.retries)&&void 0!==t?t:3,o=null!==(s=null==e?void 0:e.min)&&void 0!==s?s:100,d=null!==(i=null==e?void 0:e.max)&&void 0!==i?i:1e4,l=null!==(a=null==e?void 0:e.step)&&void 0!==a?a:2,c=null!==(n=null==e?void 0:e.jitter)&&void 0!==n?n:0;if(o<=0)throw new _m(Im.INVALID_CONFIG_MIN);if(c<0||c>1)throw new _m(Im.INVALID_CONFIG_JITTER);let h=0;for(;h<=r;){const e=Cm({nTry:h,step:l,jitter:c,min:o,max:d});yield{nTry:h,duration:e,sleep:()=>new Promise((t=>{setTimeout(t,e)}))},h++}}(t))try{const i=await e(...s);return null!=t&&t.afterRetry&&(null==t||t.afterRetry({nTry:r,duration:n,sleep:a,success:!0,shouldRetry:!1})),i}catch(i){const e=null!=t&&t.shouldRetryOnError?null==t?void 0:t.shouldRetryOnError:()=>Promise.resolve(!0),o=await e({error:i,currentState:{nTry:r,duration:n,sleep:a},input:s});if(null!=t&&t.afterRetry&&(null==t||t.afterRetry({nTry:r,duration:n,sleep:a,shouldRetry:o,success:!1})),!o)throw new _m(Im.RETRY_ON_ERROR_CONDITION_FAIL);await a()}throw new _m(Im.MAX_RETRY)}}var Sm;const Em=new Gh.a,Mm=999999,Tm=1/0;Object(ke.d)()(Sm=Object(i.injectable)()(Sm=Object(i.singleton)(kg.c)(Sm=function(e,t){return Object(i.inject)(nm)(e,void 0,0)}(Sm=function(e,t){return Object(i.inject)(ke.a)(e,void 0,1)}(Sm=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,2)}(Sm=Reflect.metadata("design:type",Function)(Sm=Reflect.metadata("design:paramtypes",[Object,void 0===ke.a?Object:ke.a,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Sm=class{constructor(e,t,s){this._isLoadData=!1,this._forceStop=!1,this._mediaMigrationStatePersist=void 0,this._maxWorkerPoolNum=gm(),this._worker=new dm.a({concurrency:this._maxWorkerPoolNum,autoStart:!1}),this._delayTimePerJob=mm(),this._delayTimeEachKJobs=pm(),this._mediaNumLimitPerJob=fm(),this._minRetryAfter=vm(),this._maxRetryAfter=bm(),this._currentJobDescs=[],this._currentJobHolders=[],this._currentMsgIdCursor=R.MessageConstants.MAX_MSG_ID,this._mediaMigrationState=void 0,this._failedGetJob=!1,this._failedAddJob=!1,this._failedDeleteJob=!1,this._hasDBError=!1,this._logger=void 0,this._application=void 0,this._mediaMigrationStatePersist=e,this._onApplicationIdle=this._onApplicationIdle.bind(this),this._onApplicationActive=this._onApplicationActive.bind(this),this._onApplicationExit=this._onApplicationExit.bind(this),this._application=t,this._logger=s.createZLogger(kg.b,["manage-media-migration"])}onApplicationReady(e){this._listenEvents(),this._isLoadData||this._loadData().then((()=>{this._runMigration()})),this.toggleDBError(this._getTestMediaMigrationFlag("[mm]:db_error")),this.toggleGetJobFailed(this._getTestMediaMigrationFlag("[mm]:get_failed")),this.toggleAddJobFailed(this._getTestMediaMigrationFlag("[mm]:add_failed")),this.toggleDeleteJobFailed(this._getTestMediaMigrationFlag("[mm]:delete_failed"))}async getMediaMigrationState(){if(!Object(ym.a)()||um())return{stateName:Og,mediaTableNamesToMigrate:[]};if(!this._mediaMigrationState){const{stateName:e,remainingTableNames:t}=await this._statsMediaMigration();this._mediaMigrationState={stateName:e,mediaTableNamesToMigrate:t}}return this._mediaMigrationState}pauseMigration(e){this._logger.zsymb(3,"e8Bc8x",["[mm] pause migration - reason: {}","KiiTnA"],e),this.flushHoldingJobs(),this._forceStop=!0,this._worker.pause()}async resumeMigration(e){this._logger.zsymb(3,"JouYrW",["[mm] resume migration - reason: {}","qukbdO"],e),this._forceStop=!1,Object(ym.a)()&&!um()&&(this._isLoadData||await this._loadData(),this._currentJobDescs.forEach((e=>{if(e.state===Fg){e.state=Rg;const t=this._createJob(e);if(t){const s=this._scheduleJob(e.id,t);this._worker.add(s,{priority:Mm})}}})),this._worker.size>0?this._worker.isPaused&&this._worker.start():this._runMigration())}flushHoldingJobs(){this._currentJobHolders.forEach((e=>{clearTimeout(e.timeoutId),e.resolver()})),this._currentJobHolders=[]}toggleGetJobFailed(e){this._failedGetJob=e}toggleAddJobFailed(e){this._failedAddJob=e}toggleDeleteJobFailed(e){this._failedDeleteJob=e}toggleDBError(e){this._hasDBError=e}_createJob(e){const{id:t,currentStep:s}=e;return this._updateStateOfCurrentJobByJobId(t,Lg),lm(s)?this._createJobFromGetFromOldDBCurrentStep(t,s):cm(s)?this._createJobFromAddToNewDBCurrentStep(t,s):hm(s)?this._createJobFromDeleteFromOldDBCurrentStep(t,s):void 0}_createJobFromGetFromOldDBCurrentStep(e,t){const s=Object(f.a)({},t),{mediaTableName:i,amount:a,lastMsgId:n}=s.dataToRun;return async()=>{try{await this._withRetry((async()=>{const t=this._createStep(s);if(!t)return void this._logger.zsymb(21,"cf90Qf",["[mm] getFromOldDBStep is undefined!","hQp_ZG"]);let r=await t();if(r.state===wg)throw r.data.jobId=e,r.data.jobType="GET_FROM_OLD_DB",r.data;const{data:o}=r;if(this._logger.zsymb(3,"i48nrx",["[mm] getFromOldDBStep - DONE - jobId: {}, {}","P8xwvV"],e,o.length),o.length>=a?this._currentMsgIdCursor=o[o.length-1].msgId:this._mediaMigrationState&&this._mediaMigrationState.mediaTableNamesToMigrate.length&&(this._mediaMigrationState.mediaTableNamesToMigrate.shift(),this._currentMsgIdCursor=R.MessageConstants.MAX_MSG_ID),this._runMigration(),o.length){const t={name:Eg,dataToRun:{mediaTableName:i,amount:a,lastMsgId:n,data:o}};this._updateCurrentStepByJobId(e,t);const s=this._createJobFromAddToNewDBCurrentStep(e,t);await s()}}))()}catch(t){this._logger.zsymb(3,"TPj0-d",["[mm] throw error from get from old DB step - jobId: {}, {}","BszQCG"],e,null==t?void 0:t.message)}}}_createJobFromAddToNewDBCurrentStep(e,t){const s=Object(f.a)({},t),{mediaTableName:i,amount:a,lastMsgId:n}=s.dataToRun;return async()=>{try{await this._withRetry((async()=>{await this._persistCurrentJobDescs();const s=this._createStep(t);if(!s)return void this._logger.zsymb(18,"srEGJs","[mm] addToNewDBStep is undefined!");const r=await s();if(r.state===wg)throw r.data.jobId=e,r.data.jobType="ADD_TO_NEW_DB",r.data;const{data:o}=r;if(this._logger.zsymb(3,"Nib9Ep",["[mm] addToNewDBStep - jobId: {}, {}","bYOg19"],e,o.length),o.length){const t={name:Mg,dataToRun:{mediaTableName:i,amount:a,lastMsgId:n,data:o}};this._updateCurrentStepByJobId(e,t);const s=this._createJobFromDeleteFromOldDBCurrentStep(e,t);await s()}}))()}catch(s){this._logger.zsymb(3,"0fevue",["[mm] throw error from add to new DB step - jobId: {}, {}","AkLfEr"],e,null==s?void 0:s.message)}}}_createJobFromDeleteFromOldDBCurrentStep(e,t){const s=Object(f.a)({},t);return async()=>{try{await this._withRetry((async()=>{await this._persistCurrentJobDescs();const t=this._createStep(s);if(!t)return void this._logger.zsymb(21,"GD9jEK",["[mm] deleteFromOldDBStep is undefined!","uZi8kk"]);const i=await t();if(i.state===wg)throw i.data.jobId=e,i.data.jobType="DELETE_FROM_OLD_DB",i.data;this._logger.zsymb(3,"7Wb-mu",["[mm] deleteFromOldDBStep - DONE - jobId: {}","7ZUUX6"],e),this._currentJobDescs=this._currentJobDescs.filter((t=>t.id!==e)),this._currentJobHolders=this._currentJobHolders.filter((t=>t.jobId!==e)),this._persistCurrentJobDescs()}))()}catch(t){this._logger.zsymb(3,"ksR02Y",["[mm] throw error from delete from old DB step - jobId: {} - err: {}","nHirRt"],e,null==t?void 0:t.message)}}}_updateCurrentStepByJobId(e,t){const s=this._currentJobDescs.find((t=>t.id===e));s&&(s.currentStep=t)}_updateStateOfCurrentJobByJobId(e,t){const s=this._currentJobDescs.find((t=>t.id===e));s&&(s.state=t)}async _persistCurrentJobDescs(){await this._mediaMigrationStatePersist.saveJobDescSummaries(this._currentJobDescs.reduce(((e,t)=>(t.currentStep.name!==Sg&&e.push(this._toJobDescSummary(t)),e)),[]))}_createStep(e){return lm(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedGetJob)throw Error("[SIMULATE]: Failed to get job from old DB!");const{mediaTableName:t,amount:s,lastMsgId:a}=e.dataToRun,n=t,r=i.ModuleContainer.resolve(pi.a),o=await r.getMediasFromOldDB(n,s,a);return{state:Tg,data:o}}catch(t){return this._logger.zsymb(21,"PaH6sf",["[mm] get from old db step err: {}","MCKVYF"],null==t?void 0:t.message),{state:wg,data:t}}}:cm(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedAddJob)throw Error("[SIMULATE]: Failed to add job to new DB!");let{mediaTableName:t,data:s,lastMsgId:a,amount:n}=e.dataToRun;const r=t,o=i.ModuleContainer.resolve(pi.a);let d=s;d||(d=await o.getMediasFromOldDB(r,n,a));const l=await o.addMediasFromOldDB(r,d);return{state:Tg,data:l}}catch(t){return this._logger.zsymb(21,"SbXCOV",["[mm] add to new db step err: {}","jRmLdy"],null==t?void 0:t.message),{state:wg,data:t}}}:hm(e)?async()=>{try{if(this._hasDBError)this._throwDBError();else if(this._failedDeleteJob)throw Error("[SIMULATE]: Failed to delete job from old DB!");const{mediaTableName:t,data:s,lastMsgId:a,amount:n}=e.dataToRun,r=t,o=i.ModuleContainer.resolve(pi.a);return s?{state:Tg,data:await o.deleteMediasFromOldDB(r,s)}:{state:Tg,data:await o.deleteMediasFromOldDBByRange(r,n,a)}}catch(t){return this._logger.zsymb(21,"SU6B6D",["[mm] delete from old db step err: {}","VzPs9D"],null==t?void 0:t.message),{state:wg,data:t}}}:void 0}async _loadData(){if(um()||!Object(ym.a)())return;const e=await this.getMediaMigrationState();this._logger.zsymb(3,"SvENn_",["[mm] MEDIA MIGRATION STATE after load data: {}","tsDsMe"],e.stateName),this._mediaMigrationState=e;const t=await this._mediaMigrationStatePersist.getSavedJobDescSummaries();t.length>0&&t.forEach((e=>{const t=this._toJobDesc(e);this._currentJobDescs.push(t);const s=this._createJob(t);if(s){const e=this._scheduleJob(t.id,s);this._worker.add(e,{priority:Mm})}})),this._isLoadData=!0}async _statsMediaMigration(){const e=i.ModuleContainer.resolve(pi.a),t=await Promise.all([e.countTotalMediaInOldDB("image"),e.countTotalMediaInOldDB("file"),e.countTotalMediaInOldDB("link")]);let s=Cg,a=[];return s=t.reduce(((e,t,s)=>(0===s&&t>0?a.push("image"):1===s&&t>0?a.push("file"):2===s&&t>0&&a.push("link"),e+t)),0)>0?Cg:_g,{stateName:s,remainingTableNames:a}}async _runMigration(){if(this._logger.zsymb(0,"SICFPu","[mm] ====================RUN MIGRATION===================="),!Object(ym.a)())return void this._logger.zsymb(0,"c-6GWd","[mm] ==========STOP MIGRATION: not use new media DB flow (cfsv)==========");if(um())return void this._logger.zsymb(0,"IA1ZqG","[mm] ==========STOP MIGRATION: stop migration (cfsv)==========");if(this._forceStop)return void this._logger.zsymb(0,"i9umT6","[mm] ==========STOP MIGRATION: force stop (in app)==========");if(!this._isLoadData&&(await this._loadData(),!this._isLoadData))return;if(this._mediaMigrationState.stateName===_g)return void this._logger.zsymb(0,"T3tcfR","[mm] ==========STOP MIGRATION: migration done==========");const e=this._mediaMigrationState.mediaTableNamesToMigrate.length>0?this._mediaMigrationState.mediaTableNamesToMigrate[0]:"";if(!e){if(!this._currentJobDescs.length)return this._logger.zsymb(0,"T8FXLM","[mm] ==========STOP MIGRATION: no media table to migrate=========="),this._stopListenEvents(),void(await this._mediaMigrationStatePersist.clearPersistedJobDescSummaries());this._logger.zsymb(0,"6C8eZ8","[mm] ==========STOP MIGRATION: no media table to migrate, but still have running jobs==========")}if(this._logger.zsymb(3,"zFAxkS",["[mm] worker pending: ","Srj0CY"],this._worker.pending),this._logger.zsymb(3,"4QUmr0",["[mm] worker size: ","uaZdCO"],this._worker.size),e){if(Em.value%this._maxWorkerPoolNum==0&&(await this._waitIn(this._delayTimeEachKJobs),this._forceStop||!Object(ym.a)()||um()))return;const t={id:Em.next(),state:Rg,currentStep:{name:Sg,dataToRun:{mediaTableName:e,amount:this._mediaNumLimitPerJob,lastMsgId:this._currentMsgIdCursor}}},s=this._createJob(t);if(s){this._currentJobDescs.push(t);const e=this._scheduleJob(t.id,s);this._worker.add(e)}}else if(!this._currentJobDescs.length)return;this._worker.isPaused&&this._worker.start()}_listenEvents(){this._application.addEventListener(ke.b.Idle,this._onApplicationIdle),this._application.addEventListener(ke.b.Active,this._onApplicationActive),this._application.addEventListener(ke.b.Exit,this._onApplicationExit)}_stopListenEvents(){this._application.removeEventListener(ke.b.Idle,this._onApplicationIdle),this._application.removeEventListener(ke.b.Active,this._onApplicationActive),this._application.removeEventListener(ke.b.Exit,this._onApplicationExit)}_onApplicationIdle(){this._setupMigrationConfig({maxWorkerPoolNum:gm(),mediaNumLimitPerJob:fm(),delayTimePerJob:mm(),delayTimeEachKJobs:pm(),minRetryAfter:vm(),maxRetryAfter:bm()})}_onApplicationActive(){this._setupMigrationConfig({maxWorkerPoolNum:gm(),mediaNumLimitPerJob:fm(),delayTimePerJob:mm(),delayTimeEachKJobs:pm(),minRetryAfter:vm(),maxRetryAfter:bm()})}_onApplicationExit(){this.pauseMigration("EXIT_APP")}_toJobDescSummary(e){const{currentStep:t}=e;return{currentStep:{name:t.name,summaryData:{mediaTableName:t.dataToRun.mediaTableName,amount:t.dataToRun.amount,lastMsgId:t.dataToRun.lastMsgId}}}}_toJobDesc(e){let{currentStep:t}=e;return{id:Em.next(),state:Rg,currentStep:{name:t.name,dataToRun:Object(f.a)(Object(f.a)({},t.summaryData),{},{data:void 0})}}}_setupMigrationConfig(e){"number"==typeof e.maxWorkerPoolNum&&(this._worker.concurrency=e.maxWorkerPoolNum),"number"==typeof e.mediaNumLimitPerJob&&(this._mediaNumLimitPerJob=e.mediaNumLimitPerJob),"number"==typeof e.delayTimePerJob&&(this._delayTimePerJob=e.delayTimePerJob),"number"==typeof e.delayTimeEachKJobs&&(this._delayTimeEachKJobs=e.delayTimeEachKJobs),"number"==typeof e.minRetryAfter&&(this._minRetryAfter=e.minRetryAfter),"number"==typeof e.maxRetryAfter&&(this._maxRetryAfter=e.maxRetryAfter)}_scheduleJob(e,t){return async()=>new Promise((t=>{const s=setTimeout((()=>{this._currentJobHolders=this._currentJobHolders.filter((t=>t.jobId!==e)),t()}),1e3*this._delayTimePerJob);this._currentJobHolders.push({jobId:e,timeoutId:s,resolver:t})})).then((()=>t()))}_withRetry(e){return Om(e,{retries:Tm,min:1e3*this._minRetryAfter,max:1e3*this._maxRetryAfter,shouldRetryOnError:async({error:e,currentState:t})=>this._forceStop||um()||!Object(ym.a)()?(this._updateStateOfCurrentJobByJobId(e.jobId,Fg),!1):"UnknownError"===e.name||"QuotaExceededError"===e.name||22===e.code?(this._updateStateOfCurrentJobByJobId(e.jobId,Fg),this.pauseMigration("DB_ERROR"),!1):(this._logger.zsymb(21,"jhHDie",["[mm]: Retry - jobId: {} - jobType: {} - error: {}","dOVHza"],e.jobId,e.jobType,e.message),!0)})}async _waitIn(e){return this._logger.zsymb(3,"68gS7l",["[mm]: waiting in {} seconds","_kLY3c"],e),new Promise((t=>{setTimeout(t,1e3*e)}))}_getTestMediaMigrationFlag(e){const t=S.default.getInstance().getItemForCurrentUser(e);try{return!!t&&JSON.parse(t)}catch(s){return!1}}_throwDBError(){const e=new Error("[SIMULATE]: DB is corrupted or quota is exceeded!");throw e.name="UnknownError",e.code=22,e}})||Sm)||Sm)||Sm)||Sm)||Sm)||Sm)||Sm);var wm,Rm=s("zLd2");Object(i.injectable)()(wm=Object(i.singleton)(Rm.c)(wm=function(e,t){return Object(i.inject)(im)(e,void 0,0)}(wm=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(wm=Reflect.metadata("design:type",Function)(wm=Reflect.metadata("design:paramtypes",[Object,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(wm=class{constructor(e,t){this._utilsMediaAppService=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaAppService=e,Ds.a.ConvInfoDataManager.addEventListener(Ks.b.DeleteConv,this._onDeleteConversation.bind(this)),Ds.a.ConvInfoDataManager.addEventListener(Ks.b.EmptyConv,this._onEmptyConversation.bind(this)),this._logger=t.createZLogger(Rm.b,["manage-utils-media-in-ui"]),this._log=em(this._logger)}create(e){return this._utilsMediaAppService.create(e)}createOrUpdate(e){return this._utilsMediaAppService.createOrUpdate(e)}async createOrUpdateFromMedias(e){return this._utilsMediaAppService.createOrUpdateFromMedias(e)}_onDeleteConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}_onEmptyConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}})||wm)||wm)||wm)||wm)||wm);var Lm,Fm=s("Mlp7");Object(i.injectable)()(Lm=Object(i.singleton)(pi.a)(Lm=function(e,t){return Object(i.inject)(Rm.c)(e,void 0,0)}(Lm=function(e,t){return Object(i.inject)(Qg)(e,void 0,1)}(Lm=function(e,t){return Object(i.inject)(Kg)(e,void 0,2)}(Lm=function(e,t){return Object(i.inject)(Ju)(e,void 0,3)}(Lm=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,4)}(Lm=Reflect.metadata("design:type",Function)(Lm=Reflect.metadata("design:paramtypes",[void 0===Rm.IUtilsMediaManager?Object:Rm.IUtilsMediaManager,Object,Object,Object,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Lm=class{constructor(e,t,s,i,a){this._utilsMediaManager=void 0,this._mediaMapperFactory=void 0,this._mediaRepositoryFactory=void 0,this._mediaPrimaryKeyConvertor=void 0,this._logger=void 0,this._utilsMediaManager=e,this._mediaRepositoryFactory=t,this._mediaMapperFactory=s,this._mediaPrimaryKeyConvertor=i,this._logger=a.createZLogger("media-manager",[""])}filter(e,t){return Object(ym.a)()?jg.filterMedia(e,t):Fm.a.filter(e,t)}getMediaRepository(e,t=!0){const s=this._mediaRepositoryFactory.getMediaRepository(e);if(!s&&t)throw Error(`[getMediaRepository]: can't get mediaRepository has mediaType: ${e}!`);return s}getMediaMapper(e,t=!0){const s=this._mediaMapperFactory.getMediaMapper(e);if(!s&&t)throw Error(`[getMediaMapper]: can't get mediaMapper has mediaType: ${e}!`);return s}async _isMigrationDone(){return(await i.ModuleContainer.resolve(kg.c).getMediaMigrationState()).stateName===_g}async isExistedMedia(e,t){try{if(!e)throw Error("mediaType is invalid!");if(!t)throw Error("mediaIdObj is invalid!");const s=this.getMediaRepository(e);return await s.isExistedMedia({newId:t.newId||"",oldId:t.oldId||""})}catch(i){var s;const e=[null==i||null===(s=i.toString)||void 0===s?void 0:s.call(i),null==i?void 0:i.stack].join("\n");return this._logger.zsymb(21,"ZP0fdu",["[isExistedMedia] - error: {}","6vpzFN"],e),!1}}async addMedias(e,t,s=`${og.c.UNKNOWN}${og.d.UNKNOWN}`){try{if(!e)throw Error("mediaType is undefined!");if(!t||!t.length)return;const i=this.getMediaRepository(e),a=this.getMediaMapper(e),n=t.map((t=>(t.src=s,"image"===e&&(t.subType=R.MSG_SUBTYPE_MEDIA_DOODLE),a.toDomainFromDTO(t)))),r=(await i.insertMulti(n)).success.map((t=>this.getMediaMapper(e).toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(t)));await this._utilsMediaManager.createOrUpdateFromMedias(r)}catch(a){var i;const e=[null==a||null===(i=a.toString)||void 0===i?void 0:i.call(a),null==a?void 0:a.stack].join("\n");this._logger.zsymb(21,"pYiw2v",["[addMedias] - error: {}","uHCSGJ"],e)}}addMediaToConvOnly(e,t=`${og.c.UNKNOWN}${og.d.UNKNOWN}`){var s,i,a;if(!Object(ym.a)())return Fm.a.addMediaToConversationOnly(e);let n=[];if(null!=e&&null!==(s=e.image)&&void 0!==s&&s.length){const s=this.getMediaRepository("image"),i=this.getMediaMapper("image");n.push(null==s?void 0:s.insertMulti(e.image.map((e=>(e.src=t,i.toDomainFromDTO(e))))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("image").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}if(null!=e&&null!==(i=e.link)&&void 0!==i&&i.length){const s=this.getMediaRepository("link"),i=this.getMediaMapper("link");n.push(null==s?void 0:s.insertMulti(e.link.map((e=>{e.src=t;return i.toDomainFromDTO(e)}))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("link").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}if(null!=e&&null!==(a=e.file)&&void 0!==a&&a.length){const s=this.getMediaRepository("file"),i=this.getMediaMapper("file");n.push(s.insertMulti(e.file.map((e=>(e.src=t,i.toDomainFromDTO(e))))).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("file").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}})))}return Promise.all(n)}async deleteMediasById(e,t,s){try{if(!s)throw Error("mediaIdObjs is undefined!");const o=Array.isArray(s)?[...s]:[s];for(const e of o){const{newId:s,oldId:i}=e;if(!s&&i){const s=await this.getMediaFieldsByMsgId(t,i);e.newId=s?`${s.cliMsgId}_${s.fromUid}_${s.toUid}`:""}}const d=this.getMediaRepository(e,!1),l=[];for(const e of o)l.push(Object(f.a)(Object(f.a)({},e),{},{deleteTo:await this._isMigrationDone()?Ig.NEW:Ig.UNKNOWN}));if(d)await d.deleteMultiMedias(l);else{var a,n,r;const e=[];e.push(null===(a=i.ModuleContainer.resolve(Ng))||void 0===a?void 0:a.deleteMultiMedias(l),null===(n=i.ModuleContainer.resolve(Gg))||void 0===n?void 0:n.deleteMultiMedias(l),null===(r=i.ModuleContainer.resolve(Vg))||void 0===r?void 0:r.deleteMultiMedias(l)),await Promise.all(e)}}catch(d){var o;const e=[null==d||null===(o=d.toString)||void 0===o?void 0:o.call(d),null==d?void 0:d.stack].join("\n");this._logger.zsymb(21,"Orxb-C",["[deleteMediasById] - error: {}","JbmCpb"],e)}}async getValidMediasOfConv(e,t,s,i,a,n){try{if(!t)return Promise.resolve([]);const r=vi.a.now(),o={cliMsgId:R.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(R.MessageConstants.MAX_SENDDTTM),msgId:i||R.MessageConstants.MAX_MSG_ID};if(null!=n&&n.lastItemOpts)o.cliMsgId=n.lastItemOpts.cliMsgId,o.sendDttm=n.lastItemOpts.sendDttm;else if(i){const e=await this.getMediaFieldsByMsgId(t,i);e&&(o.cliMsgId=e.cliMsgId,o.sendDttm=e.sendDttm)}const d=Fm.a.getLastDeleteConv(t,e),l=this.getMediaRepository(e),c=await l.getMediasOfConv(t,o,s,Object(f.a)(Object(f.a)({},a),{},{deletePointOfConv:d}));if(!c.length)return[];const h=this.getMediaMapper(e),u=await Promise.all(c.map((e=>h.toDTO(e))));return this._trackDBPerformance({executionTime:vi.a.now()-r,actionName:"getByConv",mediaType:e,resultSize:u.length}),u}catch(o){var r;const e=[null==o||null===(r=o.toString)||void 0===r?void 0:r.call(o),null==o?void 0:o.stack].join("\n");return this._logger.zsymb(21,"jqDH1A",["[getValidMediasOfConv] - error: {}","TNIyEy"],e),Promise.resolve([])}}async getLastMediasOfConvWithoutCorrectData(e,t,s,i=100,a){if(!Object(ym.a)())return Fm.a.getLastMediaFromConversation(t,e,i,s);try{if(!t)return Promise.resolve([null,Error("convId is undefined!")]);const n={cliMsgId:R.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(R.MessageConstants.MAX_SENDDTTM),msgId:s||ms.default.load_media.use_max_id||R.MessageConstants.MAX_MSG_ID};if(null!=a&&a.lastItemOpts)n.cliMsgId=a.lastItemOpts.cliMsgId,n.sendDttm=a.lastItemOpts.sendDttm;else if(s){const e=await this.getMediaFieldsByMsgId(t,s);e&&(n.cliMsgId=e.cliMsgId,n.sendDttm=e.sendDttm)}const r=this.getMediaRepository(e),o=await r.getLastMediasOfConv(t,n,i);return[await Promise.all(o.map((t=>this.getMediaMapper(e).toDTO(t)))),null]}catch(r){var n;const e=[null==r||null===(n=r.toString)||void 0===n?void 0:n.call(r),null==r?void 0:r.stack].join("\n");return this._logger.zsymb(21,"Bxi6VR",["[getLastMediasOfConvWithoutCorrectData] - error: {}","lsHVl_"],e),[null,r]}}async updateMedia(e,t,s,i,a){if(!Object(ym.a)()){const t=Object(f.a)(Object(f.a)({},i),{},{msgId:s});return Fm.a.updateMedia(t,e,a)}return this._updateMedia(e,t,s,i,a)}async countMediaOfConv(e,t,s){try{t||Promise.resolve({ok:!0,result:0,error:null});const{from:i,to:a}=s;i.cliMsgId=i.cliMsgId?i.cliMsgId:"",i.sendDttm=i.sendDttm?i.sendDttm:0,i.msgId=i.msgId?i.msgId:"",a.cliMsgId=a.cliMsgId?a.cliMsgId:R.MessageConstants.MAX_MSG_ID,a.sendDttm=a.sendDttm?a.sendDttm:parseInt(R.MessageConstants.MAX_SENDDTTM),a.msgId=a.msgId?a.msgId:R.MessageConstants.MAX_MSG_ID;const n=this.getMediaRepository(e);return{ok:!0,result:await n.countMediaOfConv(t,{from:Object(f.a)({},i),to:Object(f.a)({},a)}),error:null}}catch(a){var i;const e=[null==a||null===(i=a.toString)||void 0===i?void 0:i.call(a),null==a?void 0:a.stack].join("\n");return this._logger.zsymb(21,"R_qUh2",["[countMediaOfConv] - error: {}","tstlwW"],e),{ok:!1,result:0,error:a}}}async getMediaFieldsByMsgId(e,t){if(!t)return Promise.resolve(void 0);const s=await ze.default.getInstance().Core.Message.get(t,{partition:e});return s?{cliMsgId:"number"==typeof s.cliMsgId?s.cliMsgId.toString():s.cliMsgId,fromUid:s.fromUid,toUid:s.toUid,sendDttm:"string"==typeof s.sendDttm?parseInt(s.sendDttm):s.sendDttm}:Promise.resolve(void 0)}async getAllValidPhotoAndVideosOfConv(e){if(!Object(ym.a)())return Fm.a.getAllMediaFromConv(e);let t=!0,s={cliMsgId:R.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(R.MessageConstants.MAX_SENDDTTM)},i=R.MessageConstants.MAX_MSG_ID,a="",n=[],r=[];for(;t;){const o=await this.getValidMediasOfConv("image",e,50,i,{},{lastItemOpts:{cliMsgId:s.cliMsgId,sendDttm:s.sendDttm}});t=o.length>=50;let d=s,l=a,c=i;if(o.length){if(o.forEach((e=>{e&&e.subType==R.MSG_SUBTYPE_MEDIA_VIDEO?n.push(e):!e||e.subType!=R.MSG_SUBTYPE_PHOTO&&e.subType!==R.MSG_SUBTYPE_MEDIA_DOODLE||r.push(e)})),d={cliMsgId:o[o.length-1].cliMsgId,sendDttm:o[o.length-1].sendDttm},c=o[o.length-1].msgId,l=o[o.length-1].mediaId,c&&i&&c==i||l&&a&&l==a)break;s=d,a=l,i=c}}return{photos:r,videos:n}}async getAllValidPhotoAndVideosOfConvV2(e){if(!Object(ym.a)())return Fm.a.getAllMediaFromConv(e);let t=[],s=[];const i=vi.a.now();let a=!1,n={cliMsgId:R.MessageConstants.MAX_MSG_ID,sendDttm:parseInt(R.MessageConstants.MAX_SENDDTTM)};do{const i=await this.getMediaRepository("image").getLastMediasOfConvInNewDB(e,n,50),r=[],o=i.map((e=>e.cliMsgId)),d={index:"cliMsgIdIndex",partition:e},l=ze.default.getInstance(),c=(await l.Core.Message.getMultiIfExists(o,d)).reduce(((e,t)=>(t&&(e[`${t.cliMsgId}_${t.fromUid}_${t.toUid}`]=t),e)),{}),h=[];for(const e of i)h.push(new Promise((async t=>{try{var s,i;const t=Object(f.a)(Object(f.a)({},e),{},{msgId:null!==(s=null===(i=c[e.mediaId])||void 0===i?void 0:i.msgId)&&void 0!==s?s:""}),a=await this.getMediaMapper("image").toDTO(t,!1);r.push(a)}catch(a){}t()})));if(await Promise.all(h),r.length){r.forEach((e=>{e.subType==R.MSG_SUBTYPE_MEDIA_VIDEO?s.push(e):e.subType!=R.MSG_SUBTYPE_PHOTO&&e.subType!=R.MSG_SUBTYPE_MEDIA_DOODLE||t.push(e)}));let e={cliMsgId:r[r.length-1].cliMsgId,sendDttm:r[r.length-1].sendDttm};if(e.cliMsgId&&n.cliMsgId==e.cliMsgId||e.sendDttm&&n.sendDttm==e.sendDttm)break;n=e}a=r.length>=50}while(a);a=!1;let r=R.MessageConstants.MAX_MSG_ID;do{const i=await this.getMediaRepository("image").getLastMediasOfConvInOldDB(e,{msgId:r},50),n=await Promise.all(i.map((e=>this.getMediaMapper("image").toDTO(e,!1))));if(n.length){n.forEach((e=>{e.subType==R.MSG_SUBTYPE_MEDIA_VIDEO?s.push(e):e.subType!=R.MSG_SUBTYPE_PHOTO&&e.subType!=R.MSG_SUBTYPE_MEDIA_DOODLE||t.push(e)}));let e=n[n.length-1].msgId;if(e&&r==e)break;r=e}a=n.length>=50}while(a);return this._trackDBPerformance({executionTime:vi.a.now()-i,actionName:"getAllByConv",mediaType:"all",resultSize:t.length+s.length}),{photos:t,videos:s}}async getImageMessagesForPhotoViewer(e,t,s,a,n,r){if(!Object(ym.a)())return mt.default.getImagesForPhotoViewer({userId:e},t,s,a,n,r);try{var o;if(!e||!t)throw Error("convId or lastMsgId is undefined!");const d=await this.getMediaFieldsByMsgId(e,t);return await(null===(o=i.ModuleContainer.resolve(Ng))||void 0===o?void 0:o.getImageMessagesForPhotoViewer(e,s,{sendDttm:(null==d?void 0:d.sendDttm)||parseInt(R.MessageConstants.MAX_SENDDTTM),cliMsgId:(null==d?void 0:d.cliMsgId)||R.MessageConstants.MAX_MSG_ID,msgId:t},a,n,r))}catch(l){var d;const e=[null==l||null===(d=l.toString)||void 0===d?void 0:d.call(l),null==l?void 0:l.stack].join("\n");return this._logger.zsymb(21,"FRnodh",["[getImageMessagesForPhotoViewer] - error: {}","tiu9Ru"],e),[]}}async getLastestAddedFiles(e,t=40){if(!Object(ym.a)())return mt.default.getLatestFiles(e,t);try{if(!e){e=Date.now();let t=bs.default.getTimeNow();e=e>t?e:t}const s=R.MessageConstants.MAX_CONVERSATION_ID,a=parseInt(R.MessageConstants.MAX_MSG_ID),n=i.ModuleContainer.resolve(Gg),r=await n.getLastestAddedFiles({convId:s,sendDttm:e,cliMsgId:a},t);if(r.length>0){const e=this.getMediaMapper("file");return await Promise.all(r.map((t=>e.toDTO(t))))}return[]}catch(a){var s;const e=[null==a||null===(s=a.toString)||void 0===s?void 0:s.call(a),null==a?void 0:a.stack].join("\n");return this._logger.zsymb(21,"5Md6qD",["[getLastestAddedFiles] - error: {}","s997rQ"],e),Promise.resolve([])}}async getMultiMedias(e,t,s){if(!Object(ym.a)())return mt.default.getMediaByIds(e,s);try{if(!s||s.length<0)throw Error("msgIds is undefined or empty!");const i=vi.a.now(),a=[],n=s.map((e=>this.getMediaFieldsByMsgId(t,e).then((async t=>{a.push({newId:t?`${t.cliMsgId}_${t.fromUid}_${t.toUid}`:"",oldId:e,getFrom:await this._isMigrationDone()?yg.NEW:yg.UNKNOWN})}))));if(await Promise.all(n),!a.length)return[];const r=(await this.getMediaRepository(e).getMultiMedias(a)).filter(Boolean);return r.length>0?(this._trackDBPerformance({executionTime:vi.a.now()-i,actionName:"getByIds",mediaType:e,resultSize:r.length}),await Promise.all(r.map((t=>this.getMediaMapper(e).toDTO(t))))):[]}catch(a){var i;const e=[null==a||null===(i=a.toString)||void 0===i?void 0:i.call(a),null==a?void 0:a.stack].join("\n");return this._logger.zsymb(21,"YXOlTW",["[getMultiMedias] - error: {}","C8at9_"],e),[]}}async getMediaById(e,t,s){try{if(!s)throw Error("mediaId is undefined!");const i=await this.getMediaFieldsByMsgId(t,s),a=this.getMediaRepository(e),n=await a.getMedia({newId:i?`${i.cliMsgId}_${i.fromUid}_${i.toUid}`:"",oldId:s},void 0,await this._isMigrationDone()?yg.NEW:yg.UNKNOWN);return n?await this.getMediaMapper(e).toDTO(n):void 0}catch(a){var i;const e=[null==a||null===(i=a.toString)||void 0===i?void 0:i.call(a),null==a?void 0:a.stack].join("\n");return this._logger.zsymb(21,"2BPXrk",["[getMediaById] - error: {}","vEkwUS"],e),Promise.resolve(void 0)}}async _updateMedia(e,t,s,i,a){try{if(!t)throw Error("chatID isn't valid!");if(!s)throw Error("mediaId isn't valid!");if(!i)throw Error("mediaValue isn't valid!");const a=this.getMediaRepository(e),n=await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(t,s),r=this.getMediaMapper(e).toNewEAttsFromDTOAtts(i);return await a.updateMedia({newId:n,oldId:s},{attributes:Object.keys(r),value:r,ignoreNotFound:!0},await this._isMigrationDone()?bg.NEW:bg.UNKNOWN)}catch(r){var n;const e=[null==r||null===(n=r.toString)||void 0===n?void 0:n.call(r),null==r?void 0:r.stack].join("\n");return this._logger.zsymb(21,"Ljp3UK",["[_updateMedia] - error: {}","NmkUFR"],e),!1}}async _addMediasWhenTransferMessageOldFlow(e){try{const t=[],s=[],i=[];for(let n=0;n<e.length;n++){const a=e[n],r=a.msgType,o=Number(a.sendDttm);switch(r){case R.MSG_PHOTO:case R.MSG_PHOTO_2:case R.MSG_DOODLE:if(!Object(uc.a)(a)&&!Is.default.isPhotoStickerMessage(a)){const e=a.message.thumb||a.message.oriUrl,t=r==R.MSG_DOODLE?Object(f.a)(Object(f.a)({},a.message),{},{thumbUrl:e}):a.message;s.push({sendDttm:o,msgId:a.msgId,userId:a.toUid,message:t,fromUid:a.fromUid,subType:R.MSG_SUBTYPE_PHOTO,type:"image",ttl:a.ttl,cliMsgId:a.cliMsgId})}break;case R.MSG_FILE:t.push({sendDttm:o,msgId:a.msgId,userId:a.toUid,message:a.message,fromUid:a.fromUid,type:"file",ttl:a.ttl,cliMsgId:a.cliMsgId});break;case R.MSG_CONTACT:"recommened.link"===a.message.action&&i.push({sendDttm:o,msgId:a.msgId,userId:a.toUid,message:a.message,fromUid:a.fromUid,type:"link",ttl:a.ttl,cliMsgId:a.cliMsgId});break;case R.MSG_VIDEO:s.push({sendDttm:o,msgId:a.msgId,userId:a.toUid,message:a.message,fromUid:a.fromUid,subType:R.MSG_SUBTYPE_MEDIA_VIDEO,type:"image",ttl:a.ttl,cliMsgId:a.cliMsgId})}}let a=[];return s.length>0&&a.push(ze.default.getInstance().Core.Image.insertMulti(s,{replace:!1})),i.length>0&&a.push(ze.default.getInstance().Core.Link.insertMulti(i,{replace:!1})),t.length>0&&a.push(ze.default.getInstance().Core.File.insertMulti(t,{replace:!1})),await Promise.all(a)}catch(s){var t;const e=[null==s||null===(t=s.toString)||void 0===t?void 0:t.call(s),null==s?void 0:s.stack].join("\n");this._logger.zsymb(21,"oN7fs_",["[_addMediasWhenTransferMessageOldFlow] - error: {}","r2ziVF"],e)}}async _addMediasFromMessages(e,t){try{if(!e||!e.length)return;t=t||`${og.c.UNKNOWN}${og.d.FROM_MSG}`;const s=[],i=[],a=[],n=this.getMediaMapper("image"),r=this.getMediaMapper("file"),o=this.getMediaMapper("link");e.forEach((e=>{const d=e.msgType;switch(d){case R.MSG_PHOTO:case R.MSG_PHOTO_2:case R.MSG_DOODLE:if(d===R.MSG_DOODLE){let i=e.message;if(e.message){const t=e.message.thumb||e.message.oriUrl;i=Object(f.a)(Object(f.a)({},e.message),{},{thumbUrl:t})}s.push(n.toDomainFromTMessage(Object(f.a)(Object(f.a)({},e),{},{message:i}),R.MSG_SUBTYPE_MEDIA_DOODLE,t))}else Object(uc.a)(e)||Is.default.isPhotoStickerMessage(e)||s.push(n.toDomainFromTMessage(e,R.MSG_SUBTYPE_PHOTO,t));break;case R.MSG_FILE:i.push(r.toDomainFromMessage(e,t));break;case R.MSG_CONTACT:"recommened.link"===e.message.action&&a.push(o.toDomainFromMessage(e,t));break;case R.MSG_VIDEO:s.push(n.toDomainFromTMessage(e,R.MSG_SUBTYPE_MEDIA_VIDEO,t))}}));let d=[];return s.length>0&&d.push(this.getMediaRepository("image").insertMulti(s).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("image").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),i.length>0&&d.push(this.getMediaRepository("file").insertMulti(i).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("file").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),a.length>0&&d.push(this.getMediaRepository("link").insertMulti(a).then((e=>{if(e.success.length){const t=e.success.map((e=>this.getMediaMapper("link").toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));this._utilsMediaManager.createOrUpdateFromMedias(t)}}))),await Promise.all(d)}catch(i){var s;const e=[null==i||null===(s=i.toString)||void 0===s?void 0:s.call(i),null==i?void 0:i.stack].join("\n");this._logger.zsymb(21,"tVptgX",["[_addMediasFromMessages] - error: {}","mdjXxe"],e)}}async _addMediasAtExportImportFlowOldFlow(e){if(!e||!e.length)return;const t=[],s=[],i=[];e.forEach((e=>{if(e.msgType===R.MSG_FILE)s.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,localPath:e.localPath,fromUid:e.fromUid,type:"file",ttl:e.ttl});else if(e.msgType===R.MSG_CONTACT)"recommened.link"===e.message.action&&i.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"link",ttl:e.ttl});else if(e.msgType!==R.MSG_PHOTO&&e.msgType!==R.MSG_PHOTO_2&&e.msgType!==R.MSG_DOODLE||Object(uc.a)(e)||Is.default.isPhotoStickerMessage(e))e.msgType===R.MSG_VIDEO&&t.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"image",subType:R.MSG_SUBTYPE_MEDIA_VIDEO,ttl:e.ttl});else{const s={msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,type:"image",subType:R.MSG_SUBTYPE_PHOTO,ttl:e.ttl};if(e.msgType===R.MSG_DOODLE){const e=s.message.thumb||s.message.oriUrl;s.subType=R.MSG_SUBTYPE_MEDIA_DOODLE,s.message=Object(f.a)(Object(f.a)({},s.message),{},{thumbUrl:e})}t.push(s)}})),s.length&&mt.default.addFilesToConversation(s),i.length&&mt.default.addLinksToConversation(i),t.length&&mt.default.addOrUpdateImagesToConversation(t)}async _addMediasFromMessagesWhenBackupOldFlow(e){if(!e||!e.length)return;const t=[],s=[],i=[];e.forEach((e=>{if(e.msgType===R.MSG_FILE)s.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,localPath:e.localPath,fromUid:e.fromUid,ttl:e.ttl});else if(e.msgType===R.MSG_CONTACT&&"recommened.link"===e.message.action)i.push({msgId:e.msgId,userId:e.toUid,message:e.message,sendDttm:e.sendDttm,fromUid:e.fromUid,ttl:e.ttl});else if(!(e.msgType!==R.MSG_PHOTO&&e.msgType!==R.MSG_PHOTO_2&&e.msgType!==R.MSG_DOODLE||Object(uc.a)(e)||Is.default.isPhotoStickerMessage(e))){let s=e.message;if(e.msgType===R.MSG_DOODLE){const t=e.message.thumb||e.message.oriUrl;s=Object(f.a)(Object(f.a)({},e.message),{},{thumbUrl:t})}t.push({msgId:e.msgId,userId:e.toUid,message:s,sendDttm:e.sendDttm,fromUid:e.fromUid,ttl:e.ttl})}})),s.length&&mt.default.addFilesToConversation(s),i.length&&mt.default.addLinksToConversation(i),t.length&&mt.default.addOrUpdateImagesToConversation(t)}async _emptyOldMediaStore(e,t){const s={from:[t,0,""],to:[t,R.MessageConstants.MAX_MSG_ID.length,R.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},i={index:"userId_sendDttm_msgId",direction:Fe.CursorDirection.PREV},a=await e.getAllKey(s,i);null!=a&&a.length&&await e.deleteMulti(a)}async _emptyNewMediaStore(e,t){const s={from:[t,0,""],to:[t,parseInt(R.MessageConstants.MAX_SENDDTTM),R.MessageConstants.MAX_MSG_ID],excludeFrom:!1,excludeTo:!1},i={index:"convId_sendDttm_cliMsgId",direction:Fe.CursorDirection.PREV},a=await e.getAllKey(s,i);null!=a&&a.length&&await e.deleteMulti(a)}async updateFile(e,t,s,i){return Object(ym.a)()?this._updateMedia("file",e,t,s,i):!!(await mt.default.updateFile(t,s,i))}getMediaFromConversation(e,t,s,i,a){if(!Object(ym.a)())return Fm.a.getMediaFromConversation({userId:t},e,s,i,a);const n=e.substring(0,e.length-1);return this.getValidMediasOfConv(n,t,s,i,a)}async deleteMediaWhenDeleteMsg(e,t,s){if(!Object(ym.a)())return void mt.default.deleteMediaItem(t);let i="";if(null!=s&&s.mediaIdKeys){const{cliMsgId:e,fromUid:t,convId:a}=s.mediaIdKeys;i=`${e}_${t}_${a}`}else i=await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(e,t);this.deleteMediasById("",e,{newId:i,oldId:t})}async deleteMediaItems(e,t,s,i){if(!s)return[];if(!Object(ym.a)())return Fm.a.deleteMediaItem(s,e);let a=[];a=null!=i&&i.mediaIdKeysArr&&i.mediaIdKeysArr.length?i.mediaIdKeysArr.map((e=>`${e.cliMsgId}_${e.fromUid}_${e.convId}`)):await Promise.all(s.map((e=>this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(t,e))));const n=s.map(((e,t)=>({oldId:e,newId:a[t]})));return this.deleteMediasById(e,t,n)}async addLinksToConversation(e){Object(ym.a)()?this.addMedias("link",e):mt.default.addLinksToConversation(e)}async getFilesFromConversation(e,t,s){return Object(ym.a)()?this.getValidMediasOfConv("file",e,t,s,null):mt.default.getFilesFromConversation({userId:e},t,s)}async addMediasWhenTransferMessage(e,t,s){return s?this._addMediasFromMessages(e,t):this._addMediasWhenTransferMessageOldFlow(e)}async addMediasAtExportImportFlow(e,t){return Object(ym.a)()?this._addMediasFromMessages(e,t):this._addMediasAtExportImportFlowOldFlow(e)}async addMediasFromMessagesWhenBackup(e,t){return Object(ym.a)()?this._addMediasFromMessages(e,t):this._addMediasFromMessagesWhenBackupOldFlow(e)}async deleteImageByMsgId(e,t,s){if(!Object(ym.a)())return mt.default.deleteImageByMsgId(t);let i="";return i=null!=s&&s.mediaIdKeys?`${s.mediaIdKeys.cliMsgId}_${s.mediaIdKeys.fromUid}_${s.mediaIdKeys.convId}`:await this._mediaPrimaryKeyConvertor.toMediaPKFromMessagePK(e,t),await this.deleteMediasById("image",e,{newId:i,oldId:t}),!0}async doAddMediaToConversation(e,t){return Object(ym.a)()?this.addMedias(e,t):Fm.a.doAddMediaToConversation(t,e)}async updateMsgIdForRelativeMedia(e,t,s){if(Object(ym.a)()){const i=(t,s,i)=>{this.getMediaById(t,e,i).then((a=>{a&&(a.msgId=s,this.deleteMediasById(t,e,{newId:void 0,oldId:i}).then((()=>{this.addMedias(t,[a])})))}))};i("file",t,s),i("image",t,s),i("link",t,s)}else{const e=(e,t,s)=>{e.get(s).then((i=>{i&&(i.msgId=t,e.delete(s).then((()=>{e.insert(i)})))}))},i=ze.default.getInstance();e(i.Core.File,t,s),e(i.Core.Image,t,s),e(i.Core.Link,t,s)}}async emptyMediaStores(e,t){e&&t&&t.length&&(Object(ym.a)()?t.forEach((t=>{"file"===t?this._emptyNewMediaStore(ze.default.getInstance().Media.File,e):"image"===t?this._emptyNewMediaStore(ze.default.getInstance().Media.Image,e):"link"===t&&this._emptyNewMediaStore(ze.default.getInstance().Media.Link,e)})):t.forEach((t=>{"file"===t?this._emptyOldMediaStore(ze.default.getInstance().Core.File,e):"image"===t?this._emptyOldMediaStore(ze.default.getInstance().Core.Image,e):"link"===t&&this._emptyOldMediaStore(ze.default.getInstance().Core.Link,e)})))}async addMediasFromOldDB(e,t){if(!t||!t.length)return[];const s=this.getMediaRepository(e),i=Fm.a.getAllDeleteConv();let a=t,n=t.map((e=>e.msgId));if(i){const s=t.reduce(((t,s)=>{var a;const{userId:n}=s;if(null!==(a=i[n])&&void 0!==a&&a[e]){const a=s.msgId,r=i[n][e].lastId;r&&a&&r<a&&t.oldMediaEntitiesShouldAddToNewDB.push(s)}else t.oldMediaEntitiesShouldAddToNewDB.push(s);return t.oldMediaIdsShouldDeleteFromOldDB.push(s.msgId),t}),{oldMediaEntitiesShouldAddToNewDB:[],oldMediaIdsShouldDeleteFromOldDB:[]});a=s.oldMediaEntitiesShouldAddToNewDB,n=s.oldMediaIdsShouldDeleteFromOldDB}const r=await s.correctMediasInOldDB(a,{saveBack:!1}),o=this.getMediaMapper(e),d=r.map((e=>o.toDomainFromOldDomain(e))),l=await s.insertMulti(d);if(l.success.length){const e=l.success.map((e=>o.toMediaToCreateOrUpdateUtilsMediaDTOFromDomain(e)));return this._utilsMediaManager.createOrUpdateFromMedias(e),n}return[]}async getMediasFromOldDB(e,t,s){if(await this._isMigrationDone())return[];const i={from:"",to:s,excludeFrom:!0,excludeTo:!0},a={index:"primary",direction:Fe.CursorDirection.PREV,limit:t};return this.getMediaRepository(e).getOldDBTable().getAll(i,a)}async deleteMediasFromOldDB(e,t){const s=this.getMediaRepository(e);return(await s.getOldDBTable().deleteMulti(t)).success}async deleteMediasFromOldDBByRange(e,t,s){const i={from:"",to:s,excludeFrom:!0,excludeTo:!0},a={index:"primary",direction:Fe.CursorDirection.PREV,limit:t},n=this.getMediaRepository(e),r=await n.getOldDBTable().getAllKey(i,a);return(await n.getOldDBTable().deleteMulti(r)).success}async countTotalMediaInOldDB(e){try{return this.getMediaRepository(e).getOldDBTable().count()}catch(s){var t;const e=[null==s||null===(t=s.toString)||void 0===t?void 0:t.call(s),null==s?void 0:s.stack].join("\n");return this._logger.zsymb(21,"Li2quU",["[countTotalMediaInOldDB] - error: {}","4Dga3n"],e),0}}async _testAddMedias(e,t=50){let s=[];const i=2*Date.now()+Math.round(1e5*Math.random())+1e3,a=5*Date.now()+Math.round(1e7*Math.random())+1e3,n=["0","123456123111111456","12345111111345","111111111111111","12345111111167890","2121212121112222121","1231231231232222123","22222222222222222","2111111111111222111","322222222222222222","12341234212341123","9753434346787646","1234123412341234","987651235545454545","123123455432123432","21212123443434545","5454544531321323","98909087567564545645"],r=["4037840159631073270",...JSON.parse('["101598415","124139871","147333052","169079931","194945127","200868372","225822710","276214855","355712826","361879215","910825795994501468","g100588026","g112969450","g1149397433596350988","g1352476194718464059","g147262698","g149205131","g158719108","g158754949","g160924468","g164283274","g175572981","g194334627","g230291933","g2426404535463764819","g245533229","g25193586","g257364624","g263690118","g285979907","g285992315","g28757702","g288999008","g289367881","g293290840","g301757910","g302249930","g302577276","g309222362","g312505929","g317894641","g318028102","g320951866","g321466298","g322706780","g325920125","g325933426","g328827910","g331912501","g34509241","g47431271","g5355130437069108654","g55402697","g6911969691454201107","g85951308"]')];switch(e){case"image":for(let e=0;e<t;e++){const t=n[Math.round(Math.random()*(n.length-1))],o=r[Math.round(Math.random()*(r.length-1))],d=i+e,l=a+e;s.push({userId:o,cliMsgId:d,fromUid:t,msgId:l.toString(),message:{hdUrl:"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln",oriUrl:"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln",params:'{"width":800,"height":800,"hd":"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg?e2esession=QIqxr2vdpiBkZh0yizDjKzJIO2LACOAaSb+KBDlUkbwlil6lySe5/p1RncUJJLfTJj1Co/AkPZAOh6ln","rawThumbUrl":"https://b-f62-zpg-r.zdn.vn/8236607293085145247/0d5e94a8fc3726697f26.jpg"}',thumbUrl:"https://f62-zpg-r.zdn.vn/1518777612491889561/5571c987a1187b462209.jpg?e2esession=YBl+XgC1U90bnMk4yPcU519rhnRW4KoItoeNXLpRsl/secNpaT3Nxkal57Nj3UZhy2rUFgxhf8Pcjwah",title:void 0},type:"image",isExpired:!1,isExpiredAll:!1,subType:Math.round(Math.random())?R.MSG_SUBTYPE_PHOTO:R.MSG_SUBTYPE_MEDIA_VIDEO,sendDttm:Date.now()+e,ttl:0,localPath:null,previewThumb:void 0,updateTime:Date.now(),width:0,height:0})}break;case"file":for(let e=0;e<t;e++){const t=n[Math.round(Math.random()*(n.length-1))],o=r[Math.round(Math.random()*(r.length-1))],d=i+e,l=a+e;s.push({userId:o,cliMsgId:d,fromUid:t,msgId:l.toString(),message:{href:"https://f27-group-zfr.zdn.vn/7f8b522a54e0babee3f1/117090926800068678?e2esession=RSHmz0Kj28vN9gMz6oFilBjFxVFqisUPnj3XpjlolXXpTo3bwJ0hqlUl5uR6Sr/wtHrtcyXqXj/mLYl3",params:'{"fileSize":8178,"checksum":"78c2c03eeab27abbdf28b0fe25088e30","checksumSha":"","fileExt":"xlsx","fdata":"{}","fType":1}',title:"program_matrix_laP5chSikftFYc_LmERud.xlsx"},type:"file",fileType:-1,extType:"",sendDttm:Date.now()+e,ttl:0,updateTime:Date.now(),localPath:null,folderPath:null,previewThumb:"",dimension:null,downloadError:!1,isExpired:!1,isExpiredAll:!1})}break;case"link":for(let e=0;e<t;e++){const t=n[Math.round(Math.random()*(n.length-1))],o=r[Math.round(Math.random()*(r.length-1))],d=i+e,l=a+e;s.push({userId:o,cliMsgId:d,fromUid:t,msgId:l.toString(),message:{action:"recommened.link",childnumber:0,description:"http://tinhte.vn",href:"http://tinhte.vn",oriUrl:"http://tinhte.vn",params:'{"mediaTitle":"http://tinhte.vn","artist":"","src":"tinhte.vn","stream_icon":"","streamUrl":"","type":0,"subType":3}',thumb:"",thumbUrl:"",title:"tinhte.vn",type:""},type:"link",sendDttm:Date.now()+e,ttl:0,updateTime:Date.now(),previewThumb:""})}}const o=this._getMediaDB(e,!1);await(null==o?void 0:o.insertMulti(s))}_getMediaDB(e,t){const s=ze.default.getInstance();switch(e){case"image":return t?s.Media.Image:s.Core.Image;case"file":return t?s.Media.File:s.Core.File;case"link":return t?s.Media.Link:s.Core.Link}}_trackDBPerformance(e){Object(Ri.b)().logInfo(Ri.a.LoadMedia,{duration:e.executionTime,action_name:e.actionName,media_type:e.mediaType,result_size:e.resultSize})}})||Lm)||Lm)||Lm)||Lm)||Lm)||Lm)||Lm)||Lm);var Dm,Am=s("lT2C"),jm=s("C8zZ"),Pm=s("wmCV");let Nm=Object(Hs.b)(jm.GroupPollManager)(Dm=function(e,t){return i.ModuleContainer.inject(xs.b)(e,void 0,0)}(Dm=Reflect.metadata("design:type",Function)(Dm=Reflect.metadata("design:paramtypes",[void 0===xs.b?Object:xs.b])(Dm=class{constructor(e){this.convDataManager=e,this._Logger=void 0,this.pollCache=void 0,this.pollCache=new ce.default({maxSize:1e4}),this.setUpEvent()}get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.pollV3,[ci.ZLoggerNametags.groupPollManager])),this._Logger}updatePollCache(e,t){this.pollCache.set(e,t)}removePollCacheBelongsToConv(e){Array.from(this.pollCache.entriesAscending()).forEach((([t,s])=>{s.group_id===Is.default.getGroupIdFromConversationId(e)&&this.pollCache.delete(t)}))}setUpEvent(){this.convDataManager.addEventListener(Ks.b.DeleteConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(Ks.b.EmptyConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(Ks.b.LeaveGroup,(e=>{this.removePollCacheBelongsToConv(e.convId)}))}isAdmin(e,t){var s;const i=oi.default.getGroupByIdSync(e);if(!i)return!1;if(t===i.creatorId)return!0;let a=!1;return null===(s=i.topMember)||void 0===s||s.forEach((e=>{e.id===t&&e.isAdmin&&(a=!0)})),a}isAllowSetTopic(e){var t;const s=oi.default.getGroupByIdSync(e);return!!s&&!(!ms.default.group_topics.enable||null!==(t=s.setting)&&void 0!==t&&t.setTopicOnly)}isEnablePin(e){return this.isAdmin(e,zt.default.getUidMe())||this.isAllowSetTopic(e)}isEnableClose(e,t){const s=zt.default.getUidMe();return this.isAdmin(e,s)||s===t}createPollRequestData(e){const{pollData:t,groupId:s,src:i}=e,a={question:t.question,options:t.options,expired_time:t.expiredTime,pinAct:t.pinAct,allow_multi_choices:t.allowMultiChoices,allow_add_new_option:t.allowAddNewOption,is_hide_vote_preview:t.isHideVotePreview,is_anonymous:t.isAnonymous,poll_type:t.pollType};return{groupId:Is.default.getGroupIdFromConversationId(s),pollData:a,src:i}}async createPoll(e){const t=e.pollData.pinAct,{groupId:s,pollData:i,src:a}=this.createPollRequestData(e);try{const n=await ys.default.createPoll(s,i,a);t&&this.pinPoll(n.poll_id,e.groupId,n.question)}catch(n){throw this.Logger.zsymb(18,"N2AUz4",n),n}}getPollDetailSync(e){return this.pollCache.get(e)}async getPollDetail(e,t){let s=this.getPollDetailSync(e);if(s)return s;if(s=await mt.default.getPollInfo(e),!s){if(t)return this.getPollDetailFromServer(e);throw Error("Poll isn't existed in DB")}return this.pollCache.set(e,s),s}async getPollDetailFromServer(e,t){const s=await ys.default.getPollDetail(t,e,!1);if(!s)throw Error("Poll isn't existed in Server");return this.pollCache.set(e,s),s}async pinPoll(e,t,s){let i=s;if(!i){let t=this.getPollDetailSync(e);if(t||(t=await this.getPollDetail(e)),!t)throw Error("Poll isn't existed");i=t.question}Pm.a.pinFromBoard({userId:t},{poll_id:e,isPoll:!0,question:i},null,null,Ar.a.getWinIdByConvId(t))}unpinPoll(e,t){Pm.a.unpinFromBoard(t,{poll_id:e,isPoll:!0})}async lockPoll(e){const t=this.getPollDetailSync(e);if(!t||!t.closed)try{ys.default.lockPoll(e)}catch(s){this.Logger.zsymb(18,"A61bGB","[lockPoll] ",e,s)}}async sharePollInGroup(e){try{ys.default.sharePoll(e)}catch(t){this.Logger.zsymb(18,"R9sB5_","[sharePollInGroup] ",e,t)}}async votePoll(e){const{newOptions:t,pollId:s,votedOptionIds:i}=e,a=Is.default.getGroupIdFromConversationId(e.groupId);try{t.length>0?await ys.default.addNewOptionPoll(a,s,JSON.stringify(t),i):await ys.default.vote(a,s,i)}catch(n){throw this.Logger.zsymb(18,"sHSG1j","[votePoll] ",n,s),n}}})||Dm)||Dm)||Dm)||Dm;var Um,km=s("ILDi");let Bm=Object(Hs.b)(jm.GroupPollInfoManager)(Um=Reflect.metadata("design:type",Function)(Um=Reflect.metadata("design:paramtypes",[])(Um=class{constructor(){this.updateEmitter=void 0,this.viewedMoreFromMsgIds=void 0,this.updateEmitter=new Go.a,this.viewedMoreFromMsgIds=new Set}getPollParams(e){let t=null;try{var s;t=JSON.parse(null==e||null===(s=e.message)||void 0===s?void 0:s.params)}catch(i){t={}}return t}getLastMessagePoll(e,t,s){let i=t;return s.forEach((s=>{s.msgType!==t.msgType||this.getPollParams(s).pollId!==e||(i=s)})),i}getContinuosPollInfoSection(e,t){const s=[];let i=0;return t.forEach((t=>{var a;t.msgType===R.MSG_POLL&&this.getPollParams(t).pollId===e?(s[i]||(s[i]=[]),s[i].push(t)):null!==(a=s[i])&&void 0!==a&&a[0]&&(i+=1)})),s.filter((e=>e.length>ms.default.groupPoll.max_info_msg_display))}isShowPollCard(e,t,s){const i=this.getLastMessagePoll(e,t,s);return Ha.b.isSameMsg(t,i)}getPollInfoShowStatus(e,t,s){const i=this.getContinuosPollInfoSection(e,s);for(const a of i)for(let e=a.length-1;e>=0;e--)if(Ha.b.isSameMsg(t,a[e]))return e!==a.length-1?"HIDE":a[e-1]&&this.viewedMoreFromMsgIds.has(a[e-1].msgId)?"SHOW":"SHOW_VIEW_MORE";return"SHOW"}viewMore(e,t,s){let i=[];const a=this.getContinuosPollInfoSection(e,s);for(const n of a)if(n[n.length-1].msgId===t){i=n.map((e=>e.msgId));break}this.updateEmitter.emit("EXPAND_MSG_INFO",{msgIds:i}),this.viewedMoreFromMsgIds.add(t)}clearViewedMoreHistory(e){this.viewedMoreFromMsgIds.delete(e)}})||Um)||Um)||Um;i.ModuleContainer.registerSingleton(Am.a,Nm),i.ModuleContainer.registerSingleton(km.a,Bm);var Gm=s("3+ZU"),xm=s("MEZx");i.ModuleContainer.registerSingleton(Gm.a,class{getDebugMenu(){return ms.default.mediaStatus.debug.enable?{type:xm.MENU_ITEM_TYPE.SUBMENU,text:"Media Status",items:[{text:"Disable expired soon status",onclick:()=>{ms.default.mediaStatus.enable_expired_soon=!ms.default.mediaStatus.enable_expired_soon},checked:!ms.default.mediaStatus.enable_expired_soon},{text:"Revert media status",onclick:()=>{ms.default.mediaStatus.enable_media_status=!ms.default.mediaStatus.enable_media_status},checked:!ms.default.mediaStatus.enable_media_status},{text:"Disable view in folder for auto download",onclick:()=>{ms.default.mediaStatus.enable_view_folder_option_for_auto_download=!ms.default.mediaStatus.enable_view_folder_option_for_auto_download},checked:!ms.default.mediaStatus.enable_view_folder_option_for_auto_download},{text:"Disable inview file download",onclick:()=>{ms.default.mediaStatus.enable_file_inview_download=!ms.default.mediaStatus.enable_file_inview_download},checked:!ms.default.mediaStatus.enable_file_inview_download},{text:"Open Media Status Debugger Modal",onclick:()=>{const e=s("h0sc");e&&e.ModalManagerV2&&e.ModalManagerV2.openModal({windowId:"1",name:R.ModalIdentitiesDefine.MEDIA_STATUS_DEBUGGER,params:{show:!0}})}},{text:"Enable force expired photo",onclick:()=>{globalThis.__alwaysForcePhotoExpired=!globalThis.__alwaysForcePhotoExpired},checked:1==globalThis.__alwaysForcePhotoExpired},{text:"Enable force expired voice",onclick:()=>{globalThis.__alwaysForceVoiceExpired=!globalThis.__alwaysForceVoiceExpired},checked:1==globalThis.__alwaysForceVoiceExpired}]}:null}});var zm,Vm=s("tw7i");let Hm=Object(i.injectable)()(zm=function(e,t){return Object(i.inject)(Vm.e)(e,void 0,0)}(zm=Reflect.metadata("design:type",Function)(zm=Reflect.metadata("design:paramtypes",[Object])(zm=class{constructor(e){this.queue=e}push(e,t,s){const i={convId:e,msgId:t,action:s};this.queue.push(i)}})||zm)||zm)||zm)||zm;class $m extends Error{constructor({message:e,name:t,options:s}){super(e),this.code=void 0,this.name=void 0,this.name=t,s&&s.code&&(this.code=s.code),s&&s.stack&&(this.stack=(new Error).stack),Object.setPrototypeOf(this,$m.prototype)}}var Wm=(e,t)=>{const s={code:e.code,stack:t};return new $m({name:e.name,options:s,message:e.message})};const qm={name:"CANNOT_GET_MSG_FROM_DB",code:1,message:"Cannot get message from Message Core database"},Km={name:"QUEUE_TASK_EMPTY",code:2,message:"Action log info queue is empty"},Zm={name:"TASK_IS_RUNNING",code:3,message:"Media action log info queue has task is running"},Qm={name:"TEMP_DISABLE_LOG_PHOTO_SUBTYPE_2",code:4,message:"Temporary disable actionlog info for photo in subType 2"};var Jm=s("JJxn"),Ym=s("tmLI"),Xm=s("UQla"),ep=s("jjJf"),tp=s("eZ5W");function sp(e){return e===R.MSG_E2EE?Jm.e.YES:Jm.e.NO}function ip(e){return"0"!=e?Jm.f.RECEIVER:Jm.f.SENDER}var ap=s("HPXo");class np{build(e,t){var s,i;const a={msg_type:Jm.l[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:sp(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:ip(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:Jm.j[e.convType],sync_source:Jm.k[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(a.group_size=e.groupSize),t){case Jm.p.MediaExpiredWhenAction:a.original_status=ap.a.get(e.msg.msgId);break;case Jm.p.MediaStatusInView:null!=e&&e.forceStatus?a.file_status=null==e?void 0:e.forceStatus:a.file_status=null==e?void 0:e.mediaStatus}return a}}class rp{build(e,t){var s,i;const a={msg_type:Jm.l[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:sp(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:ip(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:Jm.j[e.convType],sync_source:Jm.k[e.msg.src],is_zCloud:e.isZCloud};switch(null!=e&&e.groupSize&&(a.group_size=e.groupSize),t){case Jm.p.MediaExpiredWhenAction:a.original_status=ap.a.get(e.msg.msgId);break;case Jm.p.MediaStatusInView:a.file_status=null==e?void 0:e.forceStatus}return a}}class op{build(e,t){var s,i;const a={msg_type:Jm.l[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:sp(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:ip(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:Jm.j[e.convType],sync_source:Jm.k[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(a.group_size=e.groupSize),t){case Jm.p.MediaExpiredWhenAction:a.original_status=ap.a.get(e.msg.msgId);break;case Jm.p.MediaStatusInView:a.file_status=e.mediaStatus}return a}}class dp{build(e,t){var s,i;const a={msg_type:Jm.l[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:sp(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:ip(null===(i=e.msg)||void 0===i?void 0:i.fromUid),conv_type:Jm.j[e.convType],sync_source:Jm.k[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(a.group_size=e.groupSize),t){case Jm.p.MediaExpiredWhenAction:a.original_status=ap.a.get(e.msg.msgId);break;case Jm.p.MediaStatusInView:a.file_status=e.mediaStatus}return a}}class lp{constructor(){this.msg=void 0,this.subType=void 0,this.entryPoint=void 0,this.convType=void 0,this.mediaStatus=void 0,this.forceStatus=void 0,this.isZCloud=void 0}withMessage(e){return this.msg=e,this}withSubType(e){return this.subType=e,this}withEntryPoint(e){return this.entryPoint=e,this}withStatus(e){return this.mediaStatus=e&&function(e){var t,s,i,a,n,r,o;let d="";var l,c,h,u,g,m;return null!==(t=e)&&void 0!==t&&t.isExpired&&(d=Xm.s.Expired),null!==(s=e)&&void 0!==s&&s.isExpiredSoon&&(d=Xm.s.ExpiredSoon),Object(ep.b)().isEnableViewPCloudFileStatus()&&null!==(i=e)&&void 0!==i&&i.personalCloud&&null!==(l=e)&&void 0!==l&&null!==(c=l.personalCloud)&&void 0!==c&&null!==(h=c.status)&&void 0!==h&&h.isUncloud&&e===Xm.s.ExpiredSoon&&(e=Xm.s.ExpiredSoon),Object(ep.b)().isEnableViewPCloudFileStatus()&&null!==(a=e)&&void 0!==a&&a.personalCloud&&null!==(u=e)&&void 0!==u&&null!==(g=u.personalCloud)&&void 0!==g&&null!==(m=g.status)&&void 0!==m&&m.isClouded&&(d=Xm.q.CloudSaved),null!==(n=e)&&void 0!==n&&n.autoDownloadPath&&(d=Xm.s.DownloadedAuto),(null!==(r=e)&&void 0!==r&&r.localPath||null!==(o=e)&&void 0!==o&&o.folderPath)&&(d=Xm.s.DownloadedManual),d}(e),this}withForceStatus(e=""){return this.forceStatus=e,this}withZCloud(e=0){return this.isZCloud=e?1:0,this}build(){var e,t;const s=function(e){const t=Object(Ym.n)(null==e?void 0:e.params)||"";return t?(null==t?void 0:t.fileSize)&&+t.fileSize/1024:-1}(this.msg.message),i=(null===(e=this.msg)||void 0===e?void 0:e.toUid)&&(a=null===(t=this.msg)||void 0===t?void 0:t.toUid,Is.default.isOAType(zt.default.getProfileFriendSync(a))?Jm.a.OA:Is.default.getConversationType(a));var a;const n=i===Jm.a.GROUP&&function(e){let t;const s=oi.default.getGroupByIdSync(e);return null!=s&&s.topMember&&(null==s?void 0:s.topMember.length)>0&&(t=null==s?void 0:s.topMember.length),t}(this.msg.toUid),r=i===Jm.a.CLOUD?function(e,t){let s=e;return e!==Xm.q.DownloadedAuto&&e!==Xm.q.DownloadedManual&&t<=tp.b.getCloudLimitBigFileInBytes()&&(s=Xm.q.CloudSaved),s}(this.mediaStatus,s):this.mediaStatus;let o={};const d={msg:this.msg,size:s,isZCloud:this.isZCloud,mediaStatus:r,convType:i,forceStatus:this.forceStatus,entryPoint:this.entryPoint,groupSize:n};switch(this.msg.msgType){case R.MSG_PHOTO:case R.MSG_PHOTO_2:o=(new rp).build(d,this.subType);break;case R.MSG_FILE:o=(new np).build(d,this.subType);break;case R.MSG_VIDEO:o=(new op).build(d,this.subType);break;case R.MSG_VOICE:o=(new dp).build(d,this.subType)}return o}}var cp=class{verify(e){return!!e.file_status&&(!!Object.values(Jm.e).includes(e.is_e2ee)&&(!!Object.values(Jm.f).includes(e.is_sender)&&(!!Object.values(Jm.f).includes(e.is_sender)&&(!!Object.values(Jm.j).includes(e.conv_type)&&(!!Object.values(Jm.k).includes(e.sync_source)&&!!Object.values(Jm.l).includes(e.msg_type))))))}},hp=s("a4lh"),up=s("o1u6"),gp=s("lJL2");const mp=[R.MSG_FILE,R.MSG_VIDEO,R.MSG_VOICE],pp=[R.MSG_PHOTO,R.MSG_PHOTO_2];var fp;let vp=Object(i.injectable)()(fp=function(e,t){return Object(i.inject)(Vm.e)(e,void 0,0)}(fp=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,1)}(fp=function(e,t){return Object(i.inject)(Vm.b)(e,void 0,2)}(fp=Reflect.metadata("design:type",Function)(fp=Reflect.metadata("design:paramtypes",[Object,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,Object])(fp=class{constructor(e,t,s){this.queue=e,this.mediaActionLogInfoCronToGroupData=s,this.logger=void 0,this.DB=void 0,this.isRunning=void 0,this.logger=t.createZLogger(ci.ZLoggerNametags.mediaStatus,["action-log-consumer"]),this.DB=ze.default.getInstance(),this.isRunning=!1}async run(){if(!(this.queue.length<=0)){if(this.isRunning)return Wm(Zm);this.isRunning=!0,requestAnimationFrame((async()=>{try{const e=this.queue.pop();if(!e)return Wm(Km);const t=e.msgId,s=e.action,i=e.convId,a=await this.DB.Core.Message.get(t,{partition:i});let n;if(!a)return Wm(qm);if((a.msgType===R.MSG_PHOTO||a.msgType===R.MSG_PHOTO_2)&&!ms.default.mediaStatus.actionLogInfo.enable_sub_type_2_for_photo&&s.subType===Jm.p.MediaStatusInView)return Qm;if(null==s||!s.forceStatus){let e=t;a.msgType!==R.MSG_FILE&&(e=a),n=mp.includes(a.msgType)&&(gp.a.get(t)||await up.a.status(e,[]))}const r=(new lp).withEntryPoint(s.entryPoint).withSubType(s.subType).withMessage(a).withStatus(n).withForceStatus((null==s?void 0:s.forceStatus)||"").withZCloud((null==s?void 0:s.isZCloud)||0).build();if((new cp).verify(r))if(pp.includes(a.msgType)){const e=Object(f.a)({},r);delete e.sent_time,delete e.size;const t=JSON.stringify(e);this.mediaActionLogInfoCronToGroupData.runCron({key:t,data:Object(f.a)(Object(f.a)({},r),{},{subType:s.subType})})}else hp.a.LogActionInfo(s.subType,r)}catch(e){this.logger.zsymb(3,"M0zPo4",["error {}","P5GWL0"],JSON.stringify(e))}finally{this.isRunning=!1,this.run()}}))}}})||fp)||fp)||fp)||fp)||fp)||fp;var bp;let yp=Object(i.injectable)()(bp=function(e,t){return Object(i.inject)(Vm.d)(e,void 0,0)}(bp=function(e,t){return Object(i.inject)(Vm.a)(e,void 0,1)}(bp=Reflect.metadata("design:type",Function)(bp=Reflect.metadata("design:paramtypes",[Object,Object])(bp=class{constructor(e,t){this.producer=e,this.consumer=t}run(e,t,s){(s.subType!==Jm.p.MediaExpiredWhenAction||ms.default.mediaStatus.actionLogInfo.enable_sub_type_1)&&(s.subType!==Jm.p.MediaStatusInView||ms.default.mediaStatus.actionLogInfo.enable_sub_type_2)&&(this.producer.push(e,t,s),this.consumer.run())}})||bp)||bp)||bp)||bp)||bp;var Ip=s("z97J");const _p=new class{constructor(e){this.lru=void 0,this.lru=new ce.default({maxSize:e.maxSize()})}set(e,t){if(t)if(this.has(e)){const s=this.lru.get(e);s.sent_time=`${parseInt(s.sent_time)+parseInt(t.sent_time)}`,s.size&&t.size&&(s.size=`${parseInt(s.size)+parseInt(t.size)}`),++s.count,this.lru.set(e,s)}else this.lru.set(e,Object(f.a)(Object(f.a)({},t),{},{count:1}))}get(e){return this.lru.get(e)}has(e){return this.lru.has(e)}delete(e){return this.lru.delete(e)}getAll(){return[...this.lru.values()]}clear(){this.lru.clear()}}({maxSize:()=>ms.default.maxSizeMemCacheMediaStatusPhotoActionLogInfo});i.ModuleContainer.registerSingleton(Vm.e,class{constructor(){this.queue=void 0,this.queue=[]}push(e){this.queue.push(e)}pop(){return this.queue.pop()}get length(){return this.queue.length}}),i.ModuleContainer.registerSingleton(Vm.d,Hm),i.ModuleContainer.registerSingleton(Vm.b,class{constructor(){this.startCron=void 0,this.startCron=!1}setStart(){this.startCron||(this.startCron=!0)}isStartCron(){return this.startCron}runCron(e){const t=new Ip.CronJob(ms.default.mediaStatus.actionLogInfo.time_to_log_photo,(()=>{const e=_p.getAll();if(e.length){for(const s of e){var t;const e=s.subType;delete s.subType,s.sent_time=Math.round(s.sent_time/s.count),s.size=(null!==(t=s.size)&&void 0!==t?t:0)/s.count,hp.a.LogActionInfo(e,s)}_p.clear()}}));this.isStartCron()?_p.set(e.key,e.data):(_p.set(e.key,e.data),t.start(),this.setStart())}}),i.ModuleContainer.registerSingleton(Vm.a,vp),i.ModuleContainer.registerSingleton(Vm.c,yp);var Cp=s("imbw"),Op=s("1EWQ");const Sp=1,Ep=2,Mp=3;let Tp=function(e){return e[e.TEXT=0]="TEXT",e[e.STICKER=1]="STICKER",e[e.PHOTO=2]="PHOTO",e[e.LINK=3]="LINK",e[e.FILE=4]="FILE",e[e.GIF=5]="GIF",e[e.CONTACT=6]="CONTACT",e}({}),wp=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({}),Rp=function(e){return e[e.SINGLE=0]="SINGLE",e[e.GROUP=1]="GROUP",e}({}),Lp=function(e){return e[e.CONTEXT_MENU=0]="CONTEXT_MENU",e[e.BUBBLE=1]="BUBBLE",e}({}),Fp=function(e){return e[e.RESEND=1]="RESEND",e[e.DELETE=2]="DELETE",e}({}),Dp=function(e){return e[e.NO_RESEND=1]="NO_RESEND",e[e.RESEND_SINGLE=2]="RESEND_SINGLE",e[e.RESEND_ALL=3]="RESEND_ALL",e}({}),Ap=function(e){return e[e.NO_DELETE=1]="NO_DELETE",e[e.DELETE_SINGLE=2]="DELETE_SINGLE",e[e.DELETE_ALL=3]="DELETE_ALL",e}({});var jp;let Pp=Object(Hs.b)(Cp.a)(jp=Reflect.metadata("design:type",Function)(jp=Reflect.metadata("design:paramtypes",[])(jp=class{constructor(){this.lastNetworkBannerAppearTime=void 0,this.logger=void 0,this.lastNetworkBannerAppearTime=null}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("auto-retry",["action-log"])),this.logger}logAction999(e){const{type:t,payload:s}=e;let i;switch(t){case"ShowManualRetry":i=Sp;break;case"InteractManualRetry":i=Ep;break;case"ShowBannerNetwork":i=Mp}Vt.default.logActionInfoV2(Vt.FeaturesInfo.AutoRetry,i,s)}getChatTypeFromConvId(e){return Is.default.isGroup(e)?wp.CHAT_GROUP:Op.a.isSendToMe(e)?wp.MY_CLOUD:wp.CHAT_11}getRetryMsgType(e){switch(e){case R.MSG_TEXT:return Tp.TEXT;case R.MSG_GIF:return Tp.GIF;case R.MSG_FILE:case R.MSG_VIDEO:return Tp.FILE;case R.MSG_PHOTO:case R.MSG_PHOTO_GROUP:return Tp.PHOTO;case R.MSG_CONTACT:return Tp.CONTACT;case R.MSG_STICKER:case R.MSG_STICKER_GROUP:case R.MSG_STICKER_2:return Tp.STICKER;case R.MSG_LINK_CLIENT:return Tp.LINK;default:return}}getMsgCombineType(e){return[R.MSG_PHOTO_GROUP,R.MSG_STICKER_GROUP].includes(e)?Rp.GROUP:Rp.SINGLE}showManualRetryReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"ShowManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),error_id:e.errorCode,is_groupping:this.getMsgCombineType(e.msgType)}})}networkBannerAppearCapture(){this.lastNetworkBannerAppearTime=bs.default.getTimeNow()}networkBannerDisappearReport(){const e=bs.default.getTimeNow();if(null===this.lastNetworkBannerAppearTime)return;const t=e-this.lastNetworkBannerAppearTime;t<=0||(this.logAction999({type:"ShowBannerNetwork",payload:{showed_time:this.lastNetworkBannerAppearTime,off_time:e,duration:t}}),this.lastNetworkBannerAppearTime=null)}resendErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:Lp[e.source],is_resend:this.getMsgCombineType(e.msgType)===Rp.GROUP?Dp.RESEND_ALL:Dp.RESEND_SINGLE,is_deleted:Ap.NO_DELETE,action_type:Fp.RESEND}})}deleteErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:Lp[e.source],is_resend:Dp.NO_RESEND,is_deleted:this.getMsgCombineType(e.msgType)===Rp.GROUP?Ap.DELETE_ALL:Ap.DELETE_SINGLE,action_type:Fp.DELETE}})}})||jp)||jp)||jp;i.ModuleContainer.registerSingleton(Cp.a,Pp);var Np,Up=s("Z1oQ"),kp=s("QbTC"),Bp=s("xtzN"),Gp=s("n32m"),xp=s("hKna");let zp=Object(Hs.b)(Gp.RetryErrorController)(Np=Reflect.metadata("design:type",Function)(Np=Reflect.metadata("design:paramtypes",[])(Np=class{constructor(){this.logger=void 0,this.errNetworkCounterMap=void 0,this.errNetworkCounterMap=new Map}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.autoRetry,["retry-error-controller"])),this.logger}getErrNetworkRetryCount(e){if(!e)return 0;const t=this.errNetworkCounterMap.get(e);if(void 0!==t)return 0===t?(this.errNetworkCounterMap.delete(e),0):t;const s=ms.default.retryConfig.max_err_network_retry_count;return this.errNetworkCounterMap.set(e,s),s}decreaseErrNetworkRetryCount(e){if(!e)return;const t=this.getErrNetworkRetryCount(e);t>0?this.errNetworkCounterMap.set(e,t-1):this.errNetworkCounterMap.delete(e)}deleteErrNetworkRetryCountItem(e){e&&this.errNetworkCounterMap.delete(e)}logRetryError(e,t){this.Logger.zsymb(18,"SEfkKW",e,t)}shouldRetry(e,t,s){if(!e||xp.a.includes(e.code))return!1;if(!xp.c.includes(e.code))return!1;const i=xp.d.NO_NETWORK_ERROR_CODE.includes(e.code);if(i&&(!ms.default.retry_err_no_network||Un.b.getStateNetwork()!==Un.a.CHECKING&&Un.b.getStateNetwork()!==Un.a.DISCONNECT))return!1;const a=this.getRetryErrorCodeGroupName(e.code);if(a&&this.getRetryErrorCodeMapping()[a].off)return!1;const n=i&&this.getErrNetworkRetryCount(s)>0;if(0===t.count&&!n)return!1;const r=this.getRetryTimeout(t);return!!(r&&bs.default.getTimeNow()-t.timestamp<r)&&(t.count&&!i&&t.count--,i&&this.decreaseErrNetworkRetryCount(s),!0)}getRetryTimeout(e){let t=0;return ms.default.retryConfig&&ms.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===R.RETRY_MSG_TIMEOUT_DEFAULT?t=ms.default.retryConfig.time_retry_default:e.timeout===R.RETRY_MSG_TIMEOUT_LONG&&(t=ms.default.retryConfig.time_retry_long)),t}getRetryErrorCodeGroupName(e){return Object.keys(xp.d).find((t=>xp.d[t].includes(e)))}getNoRetryErrorCodeGroupName(e){return Object.keys(xp.b).find((t=>xp.b[t].includes(e)))}getRetryErrorCodeMapping(){return ms.default.retryConfig.retry_strategy&&"object"==typeof ms.default.retryConfig.retry_strategy?Object.keys(ms.default.retryConfig.retry_strategy).reduce(((e,t)=>(e[t.toUpperCase()]=ms.default.retryConfig.retry_strategy[t],e)),{}):xp.e}})||Np)||Np)||Np;var Vp,Hp=s("yoj5"),$p=s("Qtro");let Wp=Object(Hs.b)(kp.a)(Vp=Reflect.metadata("design:type",Function)(Vp=Reflect.metadata("design:paramtypes",[])(Vp=class{constructor(){this.logger=void 0,this.waitingSocketOpenQueue=void 0,this.retryCountMapping=void 0,this.isDoneOffline=void 0,this.handleWaitingConnectionRetry=()=>{const e=[...this.waitingSocketOpenQueue];this.waitingSocketOpenQueue=[];for(const t of e){const e=Hp.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.unlockProcessOffline=()=>{this.isDoneOffline=!0,Uu.default.getSocketState()===xp.g.OPEN&&this.handleWaitingConnectionRetry()},this.waitingSocketOpenQueue=[],this.retryCountMapping=new Map,this.isDoneOffline=!1,Cs.default.subscribe(((e,t)=>{if(e===Os.WebsocketActions.CONNECTION_STATE_CHANGE){const{state:e,prevState:s}=t;void 0!==s&&e===xp.g.OPEN&&this.isDoneOffline&&this.handleWaitingConnectionRetry()}})),Uu.default.getChatHandler().subcribe($p.b.ON_DONE_OFFLINE,this.unlockProcessOffline)}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("auto-retry-socket",["retry-error-controller"])),this.logger}getRetryTimeout(e){let t=0;return ms.default.retryConfig&&ms.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===R.RETRY_MSG_TIMEOUT_DEFAULT?t=ms.default.retryConfig.time_retry_default:e.timeout===R.RETRY_MSG_TIMEOUT_LONG&&(t=ms.default.retryConfig.time_retry_long)),t}getErrorCode(e){let t=e.code;return e.code===xp.f.ERR_CONNECTION_TIMED_OUT&&Un.b.getStateNetwork()!==Un.a.CONNECTED&&(t=xp.f.ERR_NO_NETWORK),t}shouldRetry(e,t,s){if(!e||!t||!s||s.count<=0)return!1;let i=this.getErrorCode(e);if(i===xp.f.ERR_CONNECTION_TIMED_OUT||i===xp.f.ERR_SOCKET_CLOSED||i===xp.f.ERR_NO_NETWORK){var a;const e=null!==(a=this.retryCountMapping.get(t))&&void 0!==a?a:0;let n=ms.default.retryConfig.max_retry_count;if(i===xp.f.ERR_SOCKET_CLOSED&&(n=ms.default.retryConfig.max_err_network_retry_count),void 0!==e&&e<n){const e=this.getRetryTimeout(s);return!!(e&&bs.default.getTimeNow()-s.timestamp<e)&&(s.count&&s.count--,!0)}return!1}return!1}pushToRetryQueue(e,t,s){const a=i.ModuleContainer.resolve(Up.a).getRetryErrorCodeMapping();this.logRetryError(e.code,s);const n=this.getErrorCode(e);if(n!==xp.f.ERR_CONNECTION_TIMED_OUT){var r;if(n===xp.f.ERR_SOCKET_CLOSED||n===xp.f.ERR_NO_NETWORK)return this.retryCountMapping.set(s,null!==(r=this.retryCountMapping.get(s))&&void 0!==r?r:1),void this.waitingSocketOpenQueue.push(t)}else{var o,d;const e=(null!==(o=this.retryCountMapping.get(s))&&void 0!==o?o:0)+1,i=(null!==(d=a.CONNECTION_TIMED_OUT_ERROR_CODE.delay)&&void 0!==d?d:3e4)*e+Hp.getGapTime();setTimeout((()=>{this.retryCountMapping.set(s,e),t()}),i)}}logRetryError(e,t){this.Logger.zsymb(18,"BbP87L",e,t)}cleanUpItemQueue(e){this.retryCountMapping.delete(e)}})||Vp)||Vp)||Vp;i.ModuleContainer.registerSingleton(Up.a,zp),i.ModuleContainer.registerSingleton(kp.a,Wp),i.ModuleContainer.registerSingleton(Bp.a,class{constructor(){this.waitingNetworkQueue=void 0,this.waitingCheckStatusQueue=void 0,this.waitingTimeout=void 0,this.onConnectionBack=()=>{const e=[...this.waitingNetworkQueue];this.waitingNetworkQueue=[];for(const t of e){const e=Hp.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.clearWaitingStatusTimeout=()=>{null!==this.waitingTimeout&&(window.clearTimeout(this.waitingTimeout),this.waitingTimeout=null)},this.moveWaitingCheckStatusToWaitingConnection=()=>{this.clearWaitingStatusTimeout(),this.waitingNetworkQueue.push(...this.waitingCheckStatusQueue),this.waitingCheckStatusQueue=[]},this.processWaitingCheckStatus=()=>{this.clearWaitingStatusTimeout();const e=[...this.waitingCheckStatusQueue];this.waitingCheckStatusQueue=[];for(const t of e){const e=Hp.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.waitingNetworkQueue=[],this.waitingCheckStatusQueue=[],this.waitingTimeout=null,$e.p.listenEvent($e.j,(e=>{e===Un.a.CONNECTED?(this.processWaitingCheckStatus(),this.onConnectionBack()):e===Un.a.DISCONNECT&&this.moveWaitingCheckStatusToWaitingConnection()}))}pushToRetryQueue(e){Un.b.getStateNetwork()===Un.a.CONNECTED?(this.waitingCheckStatusQueue.push(e),null===this.waitingTimeout&&(this.waitingTimeout=window.setTimeout((()=>{this.waitingTimeout=null,this.processWaitingCheckStatus()}),ms.default.retryConfig.max_waiting_check_status_time))):this.waitingNetworkQueue.push(e)}});var qp=s("dhS6"),Kp=s("WzIS"),Zp=s("sLvT");const Qp=e=>new Promise(((t,s)=>{setTimeout((()=>{t(e||3e3)}),e||3e3)}));var Jp;let Yp=Object(Hs.b)(qp.a)(Jp=Reflect.metadata("design:type",Function)(Jp=Reflect.metadata("design:paramtypes",[])(Jp=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.uiBannerController,[ci.ZLoggerNametags.uiBannerQueue])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.queue=void 0,this.uiState=new Map,this.isFirtTriggerShowOnQueueCycle=void 0,this.timeoutNextBanner=void 0,this._Logger=void 0,this.name=qp.b,this.key="convId",this.queue=[],this.isFirtTriggerShowOnQueueCycle=!0,this.timeoutNextBanner=null}enBannerQueue(e,t){const s=this.queryBannerQueueItem(e.key);switch(s&&this.doRemoveBannerQueueItem(s.key),t){case Kp.a.NORMAL:this.queue.push(e);break;case Kp.a.HIGH:this.queue.unshift(e)}}isEmptySyncSourceQueue(){return 0===this.queue.length}deBannerQueue(){return this.queue.shift()}removeBannerQueueItem(e){this.queue=[...this.queue].filter((t=>t.key!==e))}doRemoveBannerQueueItem(e){this.removeBannerQueueItem(e),0===this.queue.length&&(this.isFirtTriggerShowOnQueueCycle=!0)}queryBannerQueueItem(e){return this.queue.find((t=>t.key===e))}handleShowUIBanner(e,t){Object(Zp.b)().isEnableSingleUIBanner()?this.showSingleUI(e,t):this.showMultiUI(e,t)}isExistingShow(){try{const e=Object.fromEntries(this.uiState);for(const t in e)if(e[t])return t;return null}catch(e){return null}}async showSingleUI(e,t){let s;this.enBannerQueue({key:e,priority:t},t);const i=this.isExistingShow();if(i&&(s=this.queryBannerQueueItem(i)),Object(Zp.b)().isEnableForceCloseNormalBanner()&&i&&t===Kp.a.HIGH&&s)return this.uiState.set(s.key,!1),Object(Kt.g)(this.name,s.key),this.uiState.set(e,!0),void Object(Kt.g)(this.name,e);i||(this.uiState.set(e,!0),Object(Kt.g)(this.name,e),this.Logger.zsymb(0,"sh3cFm","[showSingleUI] Dont have displaying banner so show: "+e+", current queue = "+JSON.stringify(this.queue)))}showMultiUI(e,t){this.enBannerQueue({key:e,priority:t},t),this.uiState.set(e,!0),Object(Kt.g)(this.name,e)}handleHideUIBanner(e){Object(Zp.b)().isEnableSingleUIBanner()?this.hideSingleUI(e):this.hideMultiUI(e)}hideSingleUI(e){this.doRemoveBannerQueueItem(e),this.uiState.get(e)&&(this.uiState.set(e,!1),Object(Kt.g)(this.name,e),this.timeoutNextBanner&&clearTimeout(this.timeoutNextBanner),this.timeoutNextBanner=setTimeout((()=>{const e=this.queue[0];e&&!this.isExistingShow()&&(this.uiState.set(e.key,!0),Object(Kt.g)(this.name,e.key),this.Logger.zsymb(0,"0qQQj-","[hideSingleUI] Pop next banner to show: "+e.key+", current queue = "+JSON.stringify(this.queue)))}),Object(Zp.b)().getTimeDelayOnNextBanner()))}hideMultiUI(e){this.doRemoveBannerQueueItem(e),this.uiState.set(e,!1),Object(Kt.g)(this.name,e)}async onShowBanner(e,t,s){s&&await Qp(s);const i=Object(Zp.b)().getTimeDelayOnStartApp();this.isFirtTriggerShowOnQueueCycle&&i?(await Qp(i),this.handleShowUIBanner(e,t)):this.handleShowUIBanner(e,t),this.isFirtTriggerShowOnQueueCycle=!1}async onHideBanner(e,t){t&&await Qp(t),this.handleHideUIBanner(e)}getBannerList(){return this.queue}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.uiState.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||Jp)||Jp)||Jp;i.ModuleContainer.registerSingleton(qp.a,Yp);var Xp=s("rBV8");class ef{constructor(e,t,s=!0){this.useDefaultList=s,this.type=void 0,this.name=void 0,this.key=void 0,this.data=void 0,this.name=e,this.key=t,this.data=this.getInitialData()}init(){}getInitialData(){return new Map}updateItem(e,t,s=!1){const i=Object(wo.a)(this.data.get(t)||{},e);this.data.set(t,i),s||(Object(Xp.f)(this.name,t),this.useDefaultList&&Object(Xp.h)(this.name,""))}removeItem(e,t=!1){this.data.delete(e),t||(Object(Xp.c)(this.name,e),Object(Xp.h)(this.name,""))}getItem(e,t){const s=e.key;return this.data.get(s)}getList(e,t){return this.getDefaultList()}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){return{value:null}}getDefaultList(){return this.useDefaultList?Array.from(this.data.keys()):[]}}var tf=s("kZZr"),sf=s("VteK"),af=s("zNPY"),nf=s("UwMY"),rf=s("YbKq"),of=s("85uQ"),df=s("Ilka"),lf=s("bWos"),cf=s("/YHU");class hf{constructor(e){var t,s,i,a,n,r;this.noiseId=void 0,this.zCloudKey=void 0,this.size=void 0,this.ts=void 0,this.extraInfo=void 0,this.message=void 0,this.isDuplicated=void 0,this.noiseId=e.noiseId,this.zCloudKey=lf.a.getZCloudKeyFromCloudItem(e),this.size=e.mediaInfo.mediaSize,this.ts=e.msgInfo.ts,this.isDuplicated=e.isDuplicated||!1;const o=(null==e||null===(t=e.msgInfo)||void 0===t?void 0:t.destId)==ms.default.sendToMeId?null===(s=e.mediaInfo)||void 0===s||null===(i=s.mediaExtInfo)||void 0===i?void 0:i.data:null===(a=e.mediaInfo)||void 0===a||null===(n=a.mediaExtInfo)||void 0===n?void 0:n.decryptedData;if(o){const e=Object(cf.a)(o);e&&(this.extraInfo={title:e.title,thumbUrl:e.thumbUrl,params:o})}const d=Is.default.normalizeMessageType(e.msgInfo.msgType);var l;(this.message={cliMsgId:e.msgInfo.cliMsgId+"",fromUid:e.msgInfo.srcId+"",toUid:lf.a.getConversationIdFromCloudItem(e,mt.default.getUserId()),msgType:d,msgId:e.msgInfo.glbMsgId+"",isE2EE:!!e.msgInfo.isE2EE},null!==(r=this.extraInfo)&&void 0!==r&&r.thumbUrl)&&(this.message.message={thumbUrl:null===(l=this.extraInfo)||void 0===l?void 0:l.thumbUrl})}static transfer(e){const t=new hf(e);return Object.assign({},t)}}var uf,gf=s("JP/W"),mf=s("na98"),pf=s("Qf4l"),ff=s("lGS6"),vf=s("iA9X"),bf=s("4LiO"),yf=s("oG6Z");const If="cloud",_f={verifyQueueDone:!1,cloudItems:null,displayData:null,selectedItems:{},lastClickSelectItem:null,currentFilter:rf.e.ALL,currentSort:rf.g.SIZE_DESCENDING,status:null,cloud:{total:0,usageServer:null,myCloudUsage:null,myCloudAllTypesUsage:null,used:{all:0,photo:0,video:0,file:0,voice:0},plan:-1,remove_ts:0,service_usage:{cloud_media:0,message_backup:0,my_cloud:0}},fetching:!1,fetchLimit:null,hasMore:!1,lastItemInfo:null,queryError:null};Object(i.injectable)()(uf=Object(i.singleton)(tf.b)(uf=Object(Hs.b)(tf.b)(uf=function(e,t){return Object(i.inject)(af.a)(e,void 0,0)}(uf=function(e,t){return Object(i.inject)(af.b)(e,void 0,1)}(uf=Reflect.metadata("design:type",Function)(uf=Reflect.metadata("design:paramtypes",[void 0===af.a?Object:af.a,void 0===af.b?Object:af.b])(uf=class extends ef{constructor(e,t){super(),this.zCloudConversationController=e,this.zCloudSideBarController=t,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.cloudViewItems=void 0,this.name=tf.a,this.key=tf.a,this.data.set(If,_f),this.cloudViewItems=null}_getState(e=If){return this.data.get(e)}async _sort(e){this.updateItem((t=>{t.currentSort=e}),If)}_filter(e){try{this.updateItem((t=>{t.currentFilter=e}),If)}catch(t){}}_getCurrentSort(){const{currentSort:e}=this._getState();return e}get isInZCloudScope(){if(!Object(ep.b)().isEnableUserPCloud())return!1;return[pf.b.MEDIA_TYPE,pf.b.CONVERSATION,pf.b.MY_CLOUD].includes(this.zCloudSideBarController.getCurrentView())}_getSettledUsage(e,t){return t?"fulfilled"===e.status&&e.value[t]?e.value[t]:0:"fulfilled"===e.status&&null!==(s=e.value)&&void 0!==s?s:0;var s}async _getAllCloudTypeUsage(e){try{const t=nf.a.map((t=>sf.a.getInstance().getCloudUsageByType(t,e||"")));return t.push(sf.a.getInstance().getCloudUsage()),await Promise.allSettled(t)}catch(t){throw t}}_getCloudInfoFromUsage(e){var t,s;if(!e)return null;const[i,a,n,r,o,d,l]=e,c={used:{photo:this._getSettledUsage(i)+this._getSettledUsage(a)+this._getSettledUsage(n),video:this._getSettledUsage(r),file:this._getSettledUsage(o),voice:this._getSettledUsage(d)},total:this._getSettledUsage(l,"quota")||0},h=this._getSettledUsage(l,"usage"),u=this._getSettledUsage(l,"plan"),g=this._getSettledUsage(l,"abuse_info"),m=this._getSettledUsage(l,"service_usage");c.used.all=c.used.photo+c.used.video+c.used.file+c.used.voice,c.usageServer=h,c.plan=u,c.remove_ts=null!=g&&g.remove_ts?g.remove_ts:0;const p=(null===(t=this._getState())||void 0===t||null===(s=t.cloud)||void 0===s?void 0:s.myCloudUsage)||0,f={message_backup:(null==m?void 0:m.message_backup)||0,my_cloud:p,cloud_media:h-p-((null==m?void 0:m.message_backup)||0)};return c.service_usage=f,c}async _getCloudUsage(e){try{const{cloud:r}=this._getState(),o=await this._getAllCloudTypeUsage(e);((...e)=>{Object(gf.a)("[cloud-item-list-controller]",...e)})("usageResult: ",o);const d=this._getCloudInfoFromUsage(o);if(!d||null==d||!d.used)return;if(e)return void this.updateItem((e=>{e.cloud=Object(f.a)(Object(f.a)({},e.cloud),d)}),If);const l=e=>"number"==typeof e&&e>=0?e:0;var t,s,i,a,n;if(null!=r&&r.myCloudAllTypesUsage)d.used.all=l(d.used.all-r.myCloudAllTypesUsage.total),d.used.photo=l(d.used.photo-((null===(t=r.myCloudAllTypesUsage.type)||void 0===t?void 0:t[R.MSG_PHOTO])||0)-((null===(s=r.myCloudAllTypesUsage.type)||void 0===s?void 0:s[R.MSG_PHOTO_2])||0)),d.used.video=l(d.used.video-((null===(i=r.myCloudAllTypesUsage.type)||void 0===i?void 0:i[R.MSG_VIDEO])||0)),d.used.file=l(d.used.file-((null===(a=r.myCloudAllTypesUsage.type)||void 0===a?void 0:a[R.MSG_FILE])||0)),d.used.voice=l(d.used.voice-((null===(n=r.myCloudAllTypesUsage.type)||void 0===n?void 0:n[R.MSG_VOICE])||0));this.updateItem((e=>{e.cloud=Object(f.a)(Object(f.a)({},e.cloud),d)}),If)}catch(r){throw Error(r)}}_calculateStatusFromUsage(){let e=of.a.NORMAL;const t=this._getState(),s=(null==t?void 0:t.cloud)||{},i=(null==s?void 0:s.total)||0,a=(null==s?void 0:s.usageServer)||0;if(i&&a){const t=i-a,n=Object(df.m)(),r=Object(df.j)();a>n&&(e=of.a.NEARY_FULL),t>0&&t<=r&&(e=of.a.ALMOST_FULL),t<=0&&(e=null!=s&&s.remove_ts?of.a.DELETE_SOON:of.a.FULL)}return e}_getCurrentCloudStatus(){const e=this._calculateStatusFromUsage();this.updateItem((t=>{t.status=e}),If)}_isInCloudViewItems(e){if(!Array.isArray(this.cloudViewItems))return!1;const t=lf.a.getZCloudKeyFromQueryItem(e);return!!this.cloudViewItems.find((e=>e.zCloudKey===t))}isSortedBySize(e){return[rf.g.SIZE_ASCENDING,rf.g.SIZE_DESCENDING].includes(e)}isSortedByTime(e){return[rf.g.TIME_ASCENDING,rf.g.TIME_DESCENDING].includes(e)}getMappingTypeFromFilter(e){switch(e){case rf.e.ALL:return[R.MSG_PHOTO,R.MSG_PHOTO_2,R.MSG_DOODLE,R.MSG_VIDEO,R.MSG_FILE,R.MSG_VOICE];case rf.e.PHOTO:return[R.MSG_PHOTO,R.MSG_PHOTO_2,R.MSG_DOODLE];case rf.e.VIDEO:return[R.MSG_VIDEO];case rf.e.FILE:return[R.MSG_FILE];case rf.e.VOICE:return[R.MSG_VOICE]}}isSameFilterType(e){const{currentFilter:t}=this._getState(),s=this.getMappingTypeFromFilter(t),i=Is.default.normalizeMessageType(e.msgInfo.msgType);return s&&Array.isArray(s)&&s.includes(i)}getConsideredItems(e){if(!e||!Array.isArray(e))return null;let t=[...e];this.zCloudSideBarController.getCurrentView()!==pf.b.MY_CLOUD&&(t=t.filter((e=>e.zConv!==ms.default.sendToMeId)));const s=this.zCloudConversationController.getCurrentSelectedConvId();return s&&(t=t.filter((e=>e.zConv===s))),t=t.filter((e=>!Zs.a.isThreadHidden(e.zConv))),t=t.filter((e=>this.isSameFilterType(e))),t}checkIsInRange(e,t,s){return e>=t&&e<=s}addCloudItemSizeDescending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const a=s[0].size,n=s[s.length-1].size;i=e.filter((e=>{const s=e.size;return!!this.checkIsInRange(s,n,a)||(s>a||!!(null!=t&&t.isStopIndex&&s<n))}))}if(!i||!Array.isArray(i)||0===i.length)return;const a=[...s,...i].sort(((e,t)=>{const s=e.size;return t.size-s}));this.updateItem((e=>{e.displayData=a}),If)}addCloudItemSizeAscending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const a=s[0].size,n=s[s.length-1].size;i=e.filter((e=>{const s=e.size;return!!this.checkIsInRange(s,a,n)||(s<a||!!(null!=t&&t.isStopIndex&&s>n))}))}if(!i||!Array.isArray(i)||0===i.length)return;const a=[...s,...i].sort(((e,t)=>{const s=e.size;return-(t.size-s)}));this.updateItem((e=>{e.displayData=a}),If)}addCloudItemTimeDescending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const a=s[0].ts,n=s[s.length-1].ts;i=e.filter((e=>{const s=e.ts;return!!this.checkIsInRange(s,n,a)||(s>a||!!(null!=t&&t.isStopIndex&&s<n))}))}if(!i||!Array.isArray(i)||0===i.length)return;const a=[...s,...i].sort(((e,t)=>{const s=e.ts;return t.ts-s}));this.updateItem((e=>{e.displayData=a}),If)}addCloudItemTimeAscending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let i;if(0===s.length)i=e;else{const a=s[0].ts,n=s[s.length-1].ts;i=e.filter((e=>{const s=e.ts;return!!this.checkIsInRange(s,a,n)||(s<a||!!(null!=t&&t.isStopIndex&&s>n))}))}if(!i||!Array.isArray(i)||0===i.length)return;const a=[...s,...i].sort(((e,t)=>{const s=e.ts;return-(t.ts-s)}));this.updateItem((e=>{e.displayData=a}),If)}filter(e){this._filter(e)}sort(e){this._sort(e)}getCurrentFilter(){const{currentFilter:e}=this._getState();return e}async getCloudUsage(e){await this.getOnlyMyCloudUsageClient(),this.isInZCloudScope&&await this.getMyCloudAllTypesUsageByClient();const t=this.zCloudConversationController.getCurrentSelectedConvId();await this._getCloudUsage(null!=e?e:t),this._getCurrentCloudStatus()}async getMyCloudAllTypesUsageByClient(){try{var e;const t=await sf.a.getInstance().getClientUsage();if(null==t||null===(e=t.usageByConversation)||void 0===e||!e[ms.default.sendToMeId+""])return;this.updateItem((e=>{e.cloud.myCloudAllTypesUsage=t.usageByConversation[ms.default.sendToMeId+""]}),If)}catch(t){throw t}}setVerifyQueueDone(e){this.updateItem((t=>{t.verifyQueueDone=e}),If)}setViewPortItemInfo(e){this.updateItem((t=>{t.viewPortItemInfo=e}),If)}async addCloudItems(e){const{currentSort:t}=this._getState();let s=this.getConsideredItems(e);if(!s||!Array.isArray(s))return;Object(ep.b)().isEnableSubmitExtraInfoEntry("view_on_quota_tool")&&sf.a.getInstance().updateExtMediaInfo(s),i.ModuleContainer.resolve(ep.c).calculateZCloudStatusByCloudItems(s);const a=s.map((e=>hf.transfer(e)));t===rf.g.SIZE_DESCENDING?this.addCloudItemSizeDescending(a):t===rf.g.SIZE_ASCENDING?this.addCloudItemSizeAscending(a):t===rf.g.TIME_DESCENDING?this.addCloudItemTimeDescending(a):t===rf.g.TIME_ASCENDING&&this.addCloudItemTimeAscending(a)}updateCloudItems(e){const{displayData:t}=this._getState();if(!t||!Array.isArray(t))return;const s=this.getConsideredItems(e);if(!s||!Array.isArray(s))return;const i=t.flatMap((t=>{const i=s.findIndex((e=>lf.a.getZCloudKeyFromCloudItem(e)===t.zCloudKey));return-1===i?t:hf.transfer(e[i])}));i&&Array.isArray(i)&&this.updateItem((e=>{e.displayData=i}),If)}removeCloudItems(e){if(!e||!Array.isArray(e))return;const{displayData:t}=this._getState();if(!t||!Array.isArray(t))return;const s=e;Object(gf.b)("removeCloudItems | displayData before remove: ",t);const i=t.filter((e=>!s.includes(e.zCloudKey)));this.updateItem((e=>{e.displayData=i}),If),Object(gf.b)("removeCloudItems | displayData after remove: ",t)}async getOnlyMyCloudUsageClient(){try{const e=await sf.a.getInstance().getCloudUsageByConversation(ms.default.sendToMeId);this.updateItem((t=>{t.cloud.myCloudUsage=e}),If)}catch(e){throw Error(e)}}getCurrentQueryIdentity(){const e=this.zCloudSideBarController.getCurrentView(),{currentFilter:t,currentSort:s}=this._getState();return`${e||e+""}_${t}_${s}`}async getAllByTypeSizeOrDate(e,t,s,i,a=!0){try{const{currentSort:n,currentFilter:r,lastItemInfo:o}=this._getState(),d=r===rf.e.ALL;let l=null;switch(n){case rf.g.SIZE_DESCENDING:l=d?await sf.a.getInstance().getAllByTypeSize("",a?mf.c:t,s,i,Fe.CursorDirection.PREV,o?o.offset:0):await sf.a.getInstance().getAllByTypesSize(e,a?mf.c:t,s,i,Fe.CursorDirection.PREV,o?o.offset:0);break;case rf.g.SIZE_ASCENDING:l=d?await sf.a.getInstance().getAllByTypeSize("",t,s,i,Fe.CursorDirection.NEXT,o?o.offset:0):await sf.a.getInstance().getAllByTypesSize(e,t,s,i,Fe.CursorDirection.NEXT,o?o.offset:0);break;case rf.g.TIME_DESCENDING:l=d?await sf.a.getInstance().getAllByTypeDate("",a?mf.b:t,s,i,Fe.CursorDirection.PREV,o?o.offset:0):await sf.a.getInstance().getAllByTypesDate(e,a?mf.b:t,s,i,Fe.CursorDirection.PREV,o?o.offset:0);break;case rf.g.TIME_ASCENDING:l=d?await sf.a.getInstance().getAllByTypeDate("",t,s,i,Fe.CursorDirection.NEXT,o?o.offset:0):await sf.a.getInstance().getAllByTypesDate(e,t,s,i,Fe.CursorDirection.NEXT,o?o.offset:0);break;default:l=null}return{result:l,identity:this.getCurrentQueryIdentity()}}catch(n){throw{error:n,identity:this.getCurrentQueryIdentity()}}}async getAllConvByTypeSizeOrDate(e,t,s,i,a,n=!0){try{const{currentFilter:r,currentSort:o,lastItemInfo:d}=this._getState(),l=r===rf.e.ALL;let c=null;switch(o){case rf.g.SIZE_DESCENDING:c=l?await sf.a.getInstance().getAllByConversationTypeSize(e,"",n?mf.c:s,i,a,Fe.CursorDirection.PREV,d?d.offset:0):await sf.a.getInstance().getAllByConversationTypesSize(e,t,n?mf.c:s,i,a,Fe.CursorDirection.PREV,d?d.offset:0);break;case rf.g.SIZE_ASCENDING:c=l?await sf.a.getInstance().getAllByConversationTypeSize(e,"",s,i,a,Fe.CursorDirection.NEXT,d?d.offset:0):await sf.a.getInstance().getAllByConversationTypesSize(e,t,s,i,a,Fe.CursorDirection.NEXT,d?d.offset:0);break;case rf.g.TIME_DESCENDING:c=l?await sf.a.getInstance().getAllByConversationTypeDate(e,"",n?mf.b:s,i,a,Fe.CursorDirection.PREV,d?d.offset:0):await sf.a.getInstance().getAllByConversationTypesDate(e,t,n?mf.b:s,i,a,Fe.CursorDirection.PREV,d?d.offset:0);break;case rf.g.TIME_ASCENDING:c=l?await sf.a.getInstance().getAllByConversationTypeDate(e,"",s,i,a,Fe.CursorDirection.NEXT,d?d.offset:0):await sf.a.getInstance().getAllByConversationTypesDate(e,t,s,i,a,Fe.CursorDirection.NEXT,d?d.offset:0);break;default:c=null}return{result:c,identity:this.getCurrentQueryIdentity()}}catch(r){throw{error:r,identity:this.getCurrentQueryIdentity()}}}updateLastItemInfo(e,t){if(!e)return;const s=this._getCurrentSort();this.updateItem((i=>{i.lastItemInfo={type:e.zType,sizeOrDate:this.isSortedBySize(s)?e.zSize:e.zDate,noiseId:e.noiseId,offset:t}}),If)}setLastItemFromQueryData(e){if(!e||!Array.isArray(e))return;const t=e[e.length-1];Object(gf.b)("currLastItem: ",t);const{lastItemInfo:s}=this._getState();(null==t?void 0:t.noiseId)!==(null==s?void 0:s.noiseId)&&this.updateLastItemInfo(t,((null==s?void 0:s.offset)||0)+e.length)}checkHasMoreCloudMedia(e,t){return e&&Array.isArray(e)&&e.length>=t}setHasMoreFromQueryData(e,t){if(!e||!Array.isArray(e))return;const s=this.checkHasMoreCloudMedia(e,t);Object(gf.b)("hasMore: ",s),this.updateItem((e=>{e.hasMore=s}),If)}filterNonMyCloudMediaItem(e){return e&&Array.isArray(e)?e.filter((e=>e.zConv!==ms.default.sendToMeId)):null}filterInvalidCloudItems(e){if(!e||!Array.isArray(e))return null;let t;t=e.filter((e=>!Zs.a.isThreadHidden(e.zConv)));return this.zCloudSideBarController.getCurrentView()!==pf.b.MY_CLOUD&&(t=this.filterNonMyCloudMediaItem(t)),t}setDisplayDataFromQueryData(e,t,s){if(!e||!Array.isArray(e))return;const i=e,{displayData:a}=this._getState();!t&&a&&Array.isArray(a)?this.updateItem((e=>{e.displayData=[...a,...i]}),If):this.updateItem((e=>{e.displayData=i}),If)}filterDuplicatedItems(e){if(!e||e.length<=0)return e;let t={},s=[];for(let i=0;i<e.length;i++){let a=e[i];if(!a)continue;let{zKey:n}=a;if(n)if(t.hasOwnProperty(n)){let{index:e}=t[n],{actionType:i}=a;Object(vf.b)("found dup item",n,a,e),i===nf.d.add_new?s.splice(e,1,Object(f.a)(Object(f.a)({},a),{},{isDuplicated:!0})):s[e].isDuplicated=!0}else s.push(a),t[n]=Object(f.a)(Object(f.a)({},a),{},{index:s.length-1})}return s}async fetchAllCloudMedia(e,t,s,a,n,r=!1,o=-1){try{var d;const l=this.zCloudSideBarController.getCurrentView();this.updateItem((e=>{e.fetching=!0,e.fetchLimit=n,e.queryError=null,r&&(e.selectedItems={}),a||(e.lastItemInfo=null)}),If);let c=null;if(l===pf.b.MEDIA_TYPE?c=await this.getAllByTypeSizeOrDate(t,s,a,n,r):l===pf.b.CONVERSATION?c=await this.getAllConvByTypeSizeOrDate(e+"",t,s,a,n,r):l===pf.b.MY_CLOUD&&(c=await this.getAllConvByTypeSizeOrDate(ms.default.sendToMeId+"",t,s,a,n,r)),Object(gf.b)("fetchAllCloudMedia | data from db: ",c),!c)return void this.updateItem((e=>{e.fetching=!1}),If);let{result:h,identity:u}=c;if(!h||!Array.isArray(h))return void this.updateItem((e=>{e.fetching=!1}),If);if(this.setHasMoreFromQueryData(h,n),this.setLastItemFromQueryData(h),h=this.filterInvalidCloudItems(h),l!==pf.b.CONVERSATION&&(h=this.filterDuplicatedItems(h)),!h||!Array.isArray(h))return void this.updateItem((e=>{e.fetching=!1}),If);Object(ep.b)().isEnableSubmitExtraInfoEntry("view_on_quota_tool")&&sf.a.getInstance().updateExtMediaInfo(h),i.ModuleContainer.resolve(ep.c).calculateZCloudStatusByCloudItems(h);const g=h.map((e=>hf.transfer(e)));this.setDisplayDataFromQueryData(g,r,u),-1==o?o=g.length:o+=g.length,null!==(d=this._getState())&&void 0!==d&&d.hasMore&&o<n?this.handleFetchMore(n,o):this.updateItem((e=>{e.fetching=!1}),If)}catch(l){this.updateItem((e=>{e.fetching=!1,r&&(e.queryError=l)}),If)}}forceGetCloudMedia(){const{currentFilter:e,fetchLimit:t}=this._getState(),s=this.zCloudConversationController.getCurrentSelectedConvId();if(!e||null===s||!t)return;const i=ff.a.getCurrentMappingQueryType(e);this.fetchAllCloudMedia(s,i,0,"",t,!0)}handleFetchMore(e,t=-1){const{currentFilter:s,lastItemInfo:i,hasMore:a,fetching:n}=this._getState(),r=ff.a.getCurrentMappingQueryType(s),o=this.zCloudConversationController.getCurrentSelectedConvId();Object(gf.b)("call fetch more... ",i),n&&-1===t||!i||!a||this.fetchAllCloudMedia(o,r,i.sizeOrDate,i.noiseId,e,!1,t)}isSelectedAll(){const{displayData:e,selectedItems:t}=this._getState();return Object.keys(t).length===(null==e?void 0:e.length)}handleSelectAll(){const{displayData:e,selectedItems:t}=this._getState();if(!e)return;const s=Object(f.a)({},t);e.forEach((e=>{const t=e.zCloudKey;s[t]||(s[t]=e)})),this.updateItem((e=>{e.selectedItems=s}),If)}handleDeselectAll(){this.resetSelectedItem()}handleToggleSelectAll(){this.isSelectedAll()?this.handleDeselectAll():this.handleSelectAll()}handleSelectItem(e){const{selectedItems:t,currentFilter:s}=this._getState(),i=Object(f.a)({},t);let a;const n=e.zCloudKey;if(i[n])delete i[n],a=null,Object(ep.b)().isEnableUserPCloud()&&bf.a.logClickUncheckItem({unselect_type:"single_unselect"});else{var r;if((null===(r=Object.keys(i))||void 0===r?void 0:r.length)>ms.default.max_msg_per_del-1)return void Ht.a.createSuccess($t.default.trans("STR_MY_CLOUD_MAX_SELECTED_ITEMS",[ms.default.max_msg_per_del.toString()]));if(i[n]=e,a=e,Object(ep.b)().isEnableUserPCloud()){var o;const{extension:t}=Object(yf.b)((null==e||null===(o=e.extraInfo)||void 0===o?void 0:o.title)||"");bf.a.logClickCheckItem({tab_filter:s,file_extension:t,file_size:e.size})}}this.updateItem((e=>{e.selectedItems=i,e.lastClickSelectItem=a}),If)}resetSelectedItem(){this.updateItem((e=>{e.selectedItems={}}),If)}resetAllStates(){this.data.set(If,_f),Object(Kt.g)(this.name,If)}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this._getState(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||uf)||uf)||uf)||uf)||uf)||uf);var Cf,Of=s("tP1L"),Sf=s("9XoL"),Ef=s("bO3J"),Mf=s("cCVI"),Tf=s("k+eZ"),wf=s("CBkG");const Rf="1",Lf="zcloud-promo",Ff={showPromoTooltip:!1,showPromoPopover:!1,showTip:!1,showEntry:!1};Object(i.injectable)()(Cf=Object(i.singleton)(Tf.b)(Cf=Object(Hs.b)(Tf.b)(Cf=function(e,t){return Object(i.inject)(Sf.b)(e,void 0,0)}(Cf=function(e,t){return Object(i.inject)(Mf.a)(e,void 0,1)}(Cf=function(e,t){return Object(i.inject)($s.SidebarController)(e,void 0,2)}(Cf=Reflect.metadata("design:type",Function)(Cf=Reflect.metadata("design:paramtypes",[void 0===Sf.b?Object:Sf.b,void 0===Mf.a?Object:Mf.a,void 0===$s.SidebarController?Object:$s.SidebarController])(Cf=class extends ef{constructor(e,t,s){super(),this.eventsResolver=e,this.onboardEventsResolver=t,this.sidebarController=s,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=Tf.a,this.key=Tf.a,this.data.set(Rf,Ff),this.blockOnboardingHandler=this.blockOnboardingHandler.bind(this),this.triggerOnboardingHandler=this.triggerOnboardingHandler.bind(this),this.pcDoneOnboardingHandler=this.pcDoneOnboardingHandler.bind(this),this.offPlanHandler=this.offPlanHandler.bind(this),this.upgradePlanHandler=this.upgradePlanHandler.bind(this),this.receiveKeyHandler=this.receiveKeyHandler.bind(this)}save(){S.default.getInstance().setItemForCurrentUser(Lf,JSON.stringify(this.getState()))}load(){let e=S.default.getInstance().getItemForCurrentUser(Lf);e&&this.data.set(Rf,JSON.parse(e))}getLocal(){let e=S.default.getInstance().getItemForCurrentUser(Lf);return e?JSON.parse(e):void 0}getState(e=Rf){return this.data.get(e)}blockOnboardingHandler(e){this.updateItem((e=>{e.showEntry=!1,e.showTip=!1}),Rf),this.save()}triggerOnboardingHandler(e){if(Object(gf.a)("trigger onboarding event: ",e),e.type===Ef.b.MOBILE_COMPLETED_BEFORE)this.updateItem((e=>{e.showEntry=!0,e.showTip=!0}),Rf),this.save()}pcDoneOnboardingHandler(e){this.updateItem((e=>{e.showEntry=!0,e.showTip=!1}),Rf),this.save()}offPlanHandler(e){Object(gf.a)("off plan | current: FREE"),this.sidebarController.changeTab($s.SidebarTab.MESSAGE_TAB),this.sidebarController.updateSelectedId(null),this.removeSubmitOnboaringDoneKey(),this.updateItem((e=>{e.showEntry=!1,e.showTip=!1,e.showPromoTooltip=Object(ep.b)().isEnablePromoTooltip()&&Object(ep.b)().isInFreePlan(),e.showPromoPopover=Object(ep.b)().isEnablePromoPopover()&&Object(ep.b)().isInFreePlan()}),Rf),this.save()}upgradePlanHandler(e){Object(gf.a)("upgrade plan | current: PAID"),this.updateItem((e=>{e.showPromoTooltip=!1,e.showPromoPopover=!1}),Rf),this.save()}receiveKeyHandler(e){Object(gf.a)("receive zCloud key"),this.updateItem((e=>{e.showEntry=!0,e.showTip=!0}),Rf),this.save()}doesSubmitOnboardingDoneBefore(){return!!S.default.getInstance().getItemForCurrentUser("zcl_sm_ob")}setSubmitOnboardingDone(){S.default.getInstance().setItemForCurrentUser("zcl_sm_ob","true")}removeSubmitOnboaringDoneKey(){S.default.getInstance().removeItemForCurrentUser("zcl_sm_ob")}setShowPromoTooltip(e){this.updateItem((t=>{t.showPromoTooltip=e}),Rf),this.save()}setShowPromoPopover(e){this.updateItem((t=>{t.showPromoPopover=e}),Rf),this.save()}initPromoStates({showPromoTooltip:e,showPromoPopover:t}){this.updateItem((s=>{s.showPromoTooltip=e,s.showPromoPopover=t}),Rf),this.save()}initShouldShowEntry(e){Object(gf.a)("init check zcloud user: ",e),this.updateItem((t=>{t.showEntry=e}),Rf),this.save()}addListener(){this.onboardEventsResolver.addEventListener(Ef.b.MOBILE_COMPLETED_BEFORE,this.triggerOnboardingHandler),this.onboardEventsResolver.addEventListener(Ef.b.PC_COMPLETED_BEFORE,this.pcDoneOnboardingHandler),this.eventsResolver.addEventListener(wf.a.UPGRADE_ZCLOUD_PLAN,this.upgradePlanHandler),this.eventsResolver.addEventListener(wf.a.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.addEventListener(wf.g.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.addEventListener(wf.a.OFF_PERSONAL_CLOUD_PLAN,this.offPlanHandler)}removeListener(){this.onboardEventsResolver.removeEventListener(Ef.b.MOBILE_COMPLETED_BEFORE,this.triggerOnboardingHandler),this.onboardEventsResolver.removeEventListener(Ef.b.PC_COMPLETED_BEFORE,this.pcDoneOnboardingHandler),this.eventsResolver.removeEventListener(wf.a.UPGRADE_ZCLOUD_PLAN,this.upgradePlanHandler),this.eventsResolver.removeEventListener(wf.a.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.removeEventListener(wf.g.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.removeEventListener(wf.a.OFF_PERSONAL_CLOUD_PLAN,this.offPlanHandler)}onDoneOnboarding(){this.submitDoneOnboarding(),this.updateItem((e=>{e.showTip=!1}),Rf),this.save()}async submitDoneOnboarding(){Object(gf.a)("submit done onboarding");try{if(this.doesSubmitOnboardingDoneBefore())return;await Of.a.submitOnboardingInfo(),this.setSubmitOnboardingDone()}catch(e){}}})||Cf)||Cf)||Cf)||Cf)||Cf)||Cf)||Cf);var Df,Af=s("NoK8");const jf="1",Pf={currentView:null,pageStack:[]};Object(i.injectable)()(Df=Object(i.singleton)(Af.b)(Df=Object(Hs.b)(Af.b)(Df=Reflect.metadata("design:type",Function)(Df=Reflect.metadata("design:paramtypes",[])(Df=class extends ef{constructor(){super(),this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.lastMediaView=void 0,this.name=Af.a,this.key=Af.a,this.data.set(jf,Pf),this.lastMediaView=null}_getState(e=jf){return this.data.get(e)}setInitView(e){this.updateItem((t=>{t.currentView=e}),jf)}changeView(e){this.updateItem((t=>{t.currentView=e}),jf),e!==pf.b.SETTING&&(this.lastMediaView=e)}closeSetting(){this.changeView(this.lastMediaView||pf.b.MEDIA_TYPE)}getCurrentView(){const{currentView:e}=this._getState();return e}getPageStack(){const{pageStack:e}=this._getState();return e}pushPageStack(e){const{pageStack:t}=this._getState();this.updateItem((s=>{s.pageStack=[...t,e]}),jf)}setPageStack(e){e&&Array.isArray(e)&&this.updateItem((t=>{t.pageStack=e}),jf)}popPageStack(){const{pageStack:e}=this._getState(),t=[...e];t.pop(),this.updateItem((e=>{e.pageStack=t}),jf)}})||Df)||Df)||Df)||Df);var Nf,Uf=s("/wRJ");const kf="1",Bf={currentSelectedConvId:null,currentConversationInfo:null,forceBackToConvList:!1,convUsageData:null,sorter:rf.d.SIZE_DESCENDING,searchText:"",lastScrollTopOffset:null};Object(i.injectable)()(Nf=Object(i.singleton)(Uf.b)(Nf=Object(Hs.b)(Uf.b)(Nf=function(e,t){return Object(i.inject)(xs.i)(e,void 0,0)}(Nf=Reflect.metadata("design:type",Function)(Nf=Reflect.metadata("design:paramtypes",[void 0===xs.i?Object:xs.i])(Nf=class extends ef{constructor(e){super(),this.previewDataManager=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.originalConvList=void 0,this.name=Uf.a,this.key=Uf.a,this.data.set(kf,Bf),this.originalConvList=[]}_getState(e=kf){return this.data.get(e)}_getMiniInfo(e){const t=qa.a.isGroup(e),s=t?oi.default.getMiniInfoGroup(e):zt.default.getMiniInfo(e);return Object(f.a)(Object(f.a)({},s),{},{isGroup:t,convName:t?null==s?void 0:s.displayName:null==s?void 0:s.dName})}_getNormalizedList(e){return e&&Array.isArray(Object.keys(e))&&Object.keys(e).flatMap((t=>{var s;return t===ms.default.sendToMeId||Zs.a.isThreadHidden(t)||0===(null===(s=e[t])||void 0===s?void 0:s.total)?[]:{convId:t,miniInfo:this._getMiniInfo(t),usage:e[t].total}}))}_getNormalizedListWithEmptyConversation(e){return e&&Array.isArray(Object.keys(e))&&Object.keys(e).flatMap((t=>t===ms.default.sendToMeId||Zs.a.isThreadHidden(t)?[]:{convId:t,miniInfo:this._getMiniInfo(t),usage:e[t].total}))}_getFilteredList(e,t){let s=[];return s=this._search([...this.originalConvList],e),s=this._sort(s,t),s}_search(e,t){if(!t)return e;return e.filter((e=>{var s;return ur((null==e||null===(s=e.miniInfo)||void 0===s?void 0:s.convName)||"",t.toLowerCase())}))}_sort(e,t){if(!t)return e;switch(t){case rf.d.SIZE_ASCENDING:case rf.d.SIZE_DESCENDING:return e.sort(((e,s)=>{const i=e.usage,a=s.usage-i;return t===rf.d.SIZE_DESCENDING?a:-a}));case rf.d.ACTIVIY_ASCENDING:case rf.d.ACTIVIY_DESCENDING:return e.sort(((e,s)=>{var i,a;const n=+((null===(i=this.previewDataManager.getPreviewByIDSync(e.convId))||void 0===i?void 0:i.messageTime)||0),r=+((null===(a=this.previewDataManager.getPreviewByIDSync(s.convId))||void 0===a?void 0:a.messageTime)||0)-n;return t===rf.d.ACTIVIY_DESCENDING?r:-r}))}}async loadAllConversationUsage(e=!1){try{const{searchText:t,sorter:s,currentSelectedConvId:i}=this._getState(),a=await sf.a.getInstance().getClientUsage();if(!a||null==a||!a.usageByConversation)return;Object(gf.b)("original conv list: ",a.usageByConversation);const n=this._getNormalizedList(a.usageByConversation);Object(gf.b)("normalized conv list: ",n),this.originalConvList=n;const r=this._getFilteredList(t,s);if(this.updateItem((e=>{e.convUsageData=r}),kf,e),!i)return;const o=this._getNormalizedListWithEmptyConversation(a.usageByConversation).find((e=>e.convId===i));if(!o)return void this.updateItem((e=>{e.currentSelectedConvId=null,e.currentConversationInfo=null,e.forceBackToConvList=!0}),kf);this.updateItem((e=>{e.currentConversationInfo=o}),kf)}catch(t){}}setSearchText(e){"string"==typeof e&&this.updateItem((t=>{t.searchText=e}),kf)}setSorter(e){e&&this.updateItem((t=>{t.sorter=e}),kf)}setSelectedConversation(e){this.updateItem((t=>{t.currentSelectedConvId=e}),kf)}setLastScrollTopOffset(e){this.updateItem((t=>{t.lastScrollTopOffset=e}),kf)}setForceBackToConvList(e){this.updateItem((t=>{t.forceBackToConvList=e}),kf)}getConversationList(){const{convUsageData:e}=this._getState();return e}getCurrentSelectedConvId(){const{currentSelectedConvId:e}=this._getState();return e}updateCurrentConversationInfo(e){const{currentSelectedConvId:t}=this._getState();if(!t||!e)return;const s=this._getNormalizedListWithEmptyConversation(e).find((e=>e.convId===t));s?this.updateItem((e=>{e.currentConversationInfo=s}),kf):this.updateItem((e=>{e.currentSelectedConvId=null,e.forceBackToConvList=!0}),kf)}filterList(e,t){const s=this._getFilteredList(e,t);this.updateItem((e=>{e.convUsageData=s}),kf)}resetStates(){this.data.set(kf,Bf)}})||Nf)||Nf)||Nf)||Nf)||Nf);var Gf=s("5y3u");i.ModuleContainer.registerSingleton(Gf.a,Gf.b);var xf=s("iyDo"),zf=s("UDME"),Vf=s("A9no"),Hf=s("bKXo"),$f=s("tIXy");var Wf=class{constructor(){this.data=void 0,this.data=new Map}startCapture(e,t={}){this.data.set(e,{start:bs.default.getTimeNow(),end:null,params:t})}finishCapture(e,t={}){const s=this.data.get(e);if(s){const i=Object(f.a)(Object(f.a)({},s),{},{end:bs.default.getTimeNow(),params:Object(Dl.a)(s.params,t)});return this.data.set(e,i),i}return s}getItem(e){return this.data.get(e)}clearItem(e){this.data.delete(e)}};let qf=function(e){return e[e.NORMAL=0]="NORMAL",e[e.SILENTLY=1]="SILENTLY",e[e.BLOCKING=2]="BLOCKING",e[e.SILENTLY_BLOCKING=3]="SILENTLY_BLOCKING",e}({}),Kf=function(e){return e[e.OFF=0]="OFF",e[e.ON=1]="ON",e}({}),Zf=function(e){return e[e.MEMBER=0]="MEMBER",e[e.OWNER=1]="OWNER",e[e.ADMIN=2]="ADMIN",e}({}),Qf=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({}),Jf=function(e){return e[e.MANUAL=0]="MANUAL",e[e.DEFAULT=1]="DEFAULT",e[e.NOT_SILENTLY=-1]="NOT_SILENTLY",e}({}),Yf=function(e){return e[e.LEAVE_GROUP=1]="LEAVE_GROUP",e[e.CHANGE_HIDE_MEMBER_SETTING=1]="CHANGE_HIDE_MEMBER_SETTING",e[e.CLICK_GROUP_LINK=1]="CLICK_GROUP_LINK",e[e.UPGRADE_COMMUNITY=1]="UPGRADE_COMMUNITY",e[e.VERIFY_ACCOUNT=2]="VERIFY_ACCOUNT",e[e.CLICK_LEARN_MORE=3]="CLICK_LEARN_MORE",e[e.ENTER_UPGRADE_FLOW=4]="ENTER_UPGRADE_FLOW",e[e.ENTER_KYC_FLOW=5]="ENTER_KYC_FLOW",e}({});i.ModuleContainer.registerSingleton(xf.a,class{constructor(){this.upgradeCommunityCapture=void 0,this.verificationCapture=void 0,this.upgradeCommunityCapture=new Wf,this.verificationCapture=new Wf}logAction999(e){const{type:t,payload:s,noisedIds:i}=e;let a;switch(t){case"LEAVE_GROUP":a=Yf.LEAVE_GROUP,Vt.default.logActionInfoV2(Vt.FeaturesInfo.LeaveGroupSilently,a,s,i);break;case"CHANGE_HIDE_MEMBER_SETTING":a=Yf.CHANGE_HIDE_MEMBER_SETTING,Vt.default.logActionInfoV2(Vt.FeaturesInfo.HideMemberPresence,a,s,i);break;case"CLICK_GROUP_LINK":a=Yf.CLICK_GROUP_LINK,Vt.default.logActionInfoV2(Vt.FeaturesInfo.ClickGroupLink,a,s,i);break;case"UPGRADE_COMMUNITY":a=Yf.UPGRADE_COMMUNITY,Vt.default.logActionInfoV2(Vt.FeaturesInfo.Community,a,s,i);break;case"VERIFY_ACCOUNT":a=Yf.VERIFY_ACCOUNT,Vt.default.logActionInfoV2(Vt.FeaturesInfo.Community,a,s,i);break;case"CLICK_LEARN_MORE":a=Yf.CLICK_LEARN_MORE,Vt.default.logActionInfoV2(Vt.FeaturesInfo.Community,a,s,i);break;case"ENTER_KYC_FLOW":a=Yf.ENTER_KYC_FLOW,Vt.default.logActionInfoV2(Vt.FeaturesInfo.Community,a,s,i);break;case"ENTER_UPGRADE_FLOW":a=Yf.ENTER_UPGRADE_FLOW,Vt.default.logActionInfoV2(Vt.FeaturesInfo.Community,a,s,i)}}getChatTypeFromConvId(e){return Is.default.isGroup(e)?Qf.CHAT_GROUP:Op.a.isSendToMe(e)?Qf.MY_CLOUD:Qf.CHAT_11}getMemberRole(e,t){return zf.GroupSettingHelper.isOwner(e,t)?Zf.OWNER:zf.GroupSettingHelper.isAdmin(e,t)?Zf.ADMIN:Zf.MEMBER}isDefaultLeaveSilently(e){return!(!ms.default.group_privacy.hide_member.enable||!zf.GroupSettingHelper.isLockViewMember(e))||!(!ms.default.group_privacy.leave_group_silently.enable||!Vf.isCommunity(e))}getLeaveGroupSilentlyType(e,t){return this.isDefaultLeaveSilently(e)?Jf.DEFAULT:"SILENTLY"===t?Jf.MANUAL:Jf.NOT_SILENTLY}changeHideMemberSettingReport(e){const t=Is.default.getGroupIdFromConversationId(e.groupId),s=zt.default.getUidMe();this.logAction999({type:"CHANGE_HIDE_MEMBER_SETTING",payload:{mode:e.value?Kf.ON:Kf.OFF,des_id:t,src_id:s},noisedIds:[t,s]})}clickGroupLinkReport(e){const t=Is.default.getGroupIdFromConversationId(e.groupId),s=zt.default.getUidMe();this.logAction999({type:"CLICK_GROUP_LINK",payload:{chat_type:e.conversationId?this.getChatTypeFromConvId(e.conversationId):null,src_id:s,des_id:t,lobby_version:ms.default.group_privacy.hide_member.enable?1:0},noisedIds:[s,t]})}leaveGroupReport(e){let t=e.groupId;t.startsWith(R.GROUPID_PREFIX)||(t=R.GROUPID_PREFIX+t);const s=Is.default.getGroupIdFromConversationId(e.groupId),a=zt.default.getUidMe(),n=this.getMemberRole(t,a);this.logAction999({type:"LEAVE_GROUP",payload:{des_id:s,src_id:a,user_role:n,status:this.isDefaultLeaveSilently(t)?qf.SILENTLY:qf[e.leaveType],silent_default:this.getLeaveGroupSilentlyType(t,e.leaveType)},noisedIds:[s,a]}),i.ModuleContainer.resolve(Hf.b).onLeaveGroup({groupId:t,actorId:a,memberId:a,leaveType:e.leaveType,memberRole:n})}openPopupUpgradeCommunityReport(e){const{groupId:t,entryPoint:s}=e;this.upgradeCommunityCapture.startCapture(t,{entryPoint:s})}getVerificationStatusLogNumber(e){switch(e){case $f.b.NEED_VERIFY:return 0;case $f.b.VERIFIED:return 1;default:return 3}}closePopupUpgradeCommunityReport(e){const{groupId:t,verificationStatus:s,upgradeStatus:i,errorCode:a}=e,n=this.upgradeCommunityCapture.finishCapture(t);if(!n)return;const r=Is.default.getGroupIdFromConversationId(t);this.logAction999({type:"UPGRADE_COMMUNITY",payload:{des_id:r,upgrade_status:i,fail_error:a,duration:n.end-n.start,is_kyc:this.getVerificationStatusLogNumber(s),entrypoint:n.params.entryPoint,action:a?"confirm_upgrade":"close"},noisedIds:[r]}),this.upgradeCommunityCapture.clearItem(t)}openPopupVerificationReport(e){const{groupId:t,entryPoint:s}=e;this.verificationCapture.startCapture(t,{entryPoint:s})}closePopupVerificationReport(e){const{groupId:t,verificationStatus:s,action:i}=e,a=this.verificationCapture.finishCapture(t);if(!a)return;const n=Is.default.getGroupIdFromConversationId(t);this.logAction999({type:"VERIFY_ACCOUNT",payload:{des_id:n,duration:a.end-a.start,is_kyc:this.getVerificationStatusLogNumber(s),entrypoint:a.params.entryPoint,action:i||"close"},noisedIds:[n]}),this.verificationCapture.clearItem(t)}clickCommunityLearnMoreReport(e){const{groupId:t,entryPoint:s}=e,i=Is.default.getGroupIdFromConversationId(t);this.logAction999({type:"CLICK_LEARN_MORE",payload:{des_id:i,entrypoint:s},noisedIds:[i]})}mapGroupEntryToCommunity(e){switch(e){case"gr_add_member":return"comm_add_member";case"gr_member_approval":return"comm_member_approval";case"message_info":return"msg_info";default:return e}}openPreventAddMemberReport(e){const{entryPoint:t,groupId:s,type:i}=e,a=Is.default.getGroupIdFromConversationId(s);this.logAction999({type:"need_kyc"===i?"ENTER_KYC_FLOW":"ENTER_UPGRADE_FLOW",payload:{des_id:a,entrypoint:this.mapGroupEntryToCommunity(t)},noisedIds:[a]})}});var Xf=s("sEfC"),ev=s.n(Xf);var tv,sv=class{constructor(e){this.key=void 0,this._data=void 0,this.key=e}get data(){if(!this._data){const e=S.default.getInstance().getItemForCurrentUser(this.key);let t=[];if(null!==e){try{t=JSON.parse(e)}catch{t=[]}Array.isArray(t)||(t=[])}this._data=new Set(t)}return this._data}addItem(e){this.data.has(e)||(this.data.add(e),S.default.getInstance().setItemForCurrentUser(this.key,JSON.stringify(Array.from(this.data.values()))))}removeItem(e){this.data.has(e)&&(this.data.delete(e),S.default.getInstance().setItemForCurrentUser(this.key,JSON.stringify(Array.from(this.data.values()))))}clear(){this.data.clear(),S.default.getInstance().removeItemForCurrentUser(this.key)}hasItem(e){return this.data.has(e)}};Object(i.injectable)()(tv=Object(ke.i)()(tv=Object(ke.g)()(tv=Object(Hs.b)(Ra.e)(tv=function(e,t){return Object(i.inject)(Ra.h)(e,void 0,0)}(tv=Reflect.metadata("design:type",Function)(tv=Reflect.metadata("design:paramtypes",[void 0===Ra.h?Object:Ra.h])(tv=class{constructor(e){this.onboardController=e,this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.verification=void 0,this.hiddenChatBoxBannerGroups=void 0,this.handleUpdateDataItemImmediately=({groupId:e})=>{const t={groupId:e,bannerStatus:this.getBannerStatusForItem(e)};this.data.set(e,t),this.signalUpdateItem(e)},this.handleUpdateDataItem=ev()(this.handleUpdateDataItemImmediately,300,{leading:!1,trailing:!0}),this.handleUsagedGroupInfoChange=({groupId:e},t)=>{if(!t&&!zf.GroupSettingHelper.isOwner(e,zt.default.getUidMe()))return;const s=Zi.default.isOpenChildWindowByConvId(e),a=e==i.ModuleContainer.resolve($s.SidebarController).getCurrMainConvId();(s||a)&&(this.shouldLoadVerificationStatus(e)?(this.getAccountVerificationStatus((()=>{this.handleUpdateDataItem({groupId:e})})),this.verification.loaded=!0):this.handleUpdateDataItem({groupId:e}))},this.handleChangeOwnnerEvent=({groupId:e,ownerId:t})=>{(t==zt.default.getUidMe()||this.data.has(e))&&this.handleUsagedGroupInfoChange({groupId:e},!0)},this.handleMultiGroupInfoChange=e=>{for(const t of e)this.handleUsagedGroupInfoChange({groupId:t})},this.handleProfileVerificationChange=e=>{this.verification={loaded:!0,status:e};const t=[];this.data.forEach((e=>{t.push([e.groupId,Object(f.a)(Object(f.a)({},e),{},{bannerStatus:this.getBannerStatusForItem(e.groupId)})])})),this.data=new Map(t),this.signalUpdateAllItems()},this.handleLeaveGroupEvent=e=>{for(const t of e)this.data.delete(t),this.hiddenChatBoxBannerGroups.removeItem(t)},this.name=Ra.a,this.key="groupId",this.data=new Map,this.verification={loaded:!1,status:null},this.hiddenChatBoxBannerGroups=new sv(Ra.c)}init(){throw new Error("Method not implemented.")}onStart(){oi.default.subscribeEventGroup(R.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),oi.default.subscribeEventGroup(R.EventGroup.UPGRADE_COMMUNITY,this.handleUsagedGroupInfoChange),oi.default.subscribeEventGroup(R.EventGroup.CHANGE_OWNER,this.handleChangeOwnnerEvent),oi.default.subscribeEventGroup(R.EventGroup.SIZE_CHANGE,this.handleUsagedGroupInfoChange),oi.default.subscribeEventGroup(R.EventGroup.GROUP_INFO_CHANGED,this.handleMultiGroupInfoChange),zt.default.subscribeEventFriend(R.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}onDispose(){oi.default.unsubscribeEventGroup(R.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),oi.default.unsubscribeEventGroup(R.EventGroup.UPGRADE_COMMUNITY,this.handleUsagedGroupInfoChange),oi.default.unsubscribeEventGroup(R.EventGroup.CHANGE_OWNER,this.handleUsagedGroupInfoChange),oi.default.unsubscribeEventGroup(R.EventGroup.SIZE_CHANGE,this.handleUsagedGroupInfoChange),oi.default.unsubscribeEventGroup(R.EventGroup.GROUP_INFO_CHANGED,this.handleMultiGroupInfoChange),zt.default.unsubscribeEventFriend(R.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}getList(){return Array.from(this.data.keys())}signalUpdateItem(e){Object(Kt.g)(this.name,e)}signalUpdateAllItems(){this.data.forEach((e=>{this.signalUpdateItem(e.groupId)}))}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.community,[this.name])),this.logger}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"FQYzqy","Get community data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"eWuWf8","Get community data list failed",e)}getOwnedCommunities(){const e=oi.default.getGroupsListSync(),t=zt.default.getUidMe(),s=[];for(const i of e)i.creatorId===t&&Ra.q.isCommunityFromInfo(i)&&s.push(i);return s}getJoinedCommunities(){const e=oi.default.getGroupsListSync(),t=[];for(const s of e)Ra.q.isCommunityFromInfo(s)&&t.push(s);return t}getProfileVerificationStatus(){return this.verification.status}getBannerStatusForItem(e){if(null===this.verification.status)return{show:!1};const t=oi.default.getGroupByIdSync(e);if("number"!=typeof(null==t?void 0:t.totalMember)||t.creatorId!=zt.default.getUidMe())return{show:!1};const s=Ra.q.isCommunityFromInfo(t);let i,a=!1;const n=new Set([Ra.f.CHAT_BOX,Ra.f.RIGHT_BAR]);return this.verification.status===$f.b.VERIFIED?(a=!s&&t.totalMember>=ms.default.group_privacy.community.grouptype_threshold,i=Ra.g.REACHED_UPGRADE):(a=s||t.totalMember>=ms.default.group_privacy.community.minimum_warn_upgrade,i=s?Ra.g.UPGRADED_VERIFY:t.totalMember>=ms.default.group_privacy.community.grouptype_threshold?Ra.g.REACHED_VERIFY:Ra.g.NEARLY_REACH_VERIFY),this.hiddenChatBoxBannerGroups.hasItem(e)&&n.delete(Ra.f.CHAT_BOX),{show:a,type:i,position:n}}getAccountVerificationStatus(e){zt.default.getVerificationStatusMe().then((t=>{this.verification.status=t,null==e||e(t)})).catch((e=>{this.Logger.zsymb(18,"CMSGKi","Get account verification status failed",e)}))}upgradeToCommunity(e){return new Promise(((t,s)=>{ys.default.upgradeGroupToCommunity(e).then((()=>{this.Logger.zsymb(18,"BgAAmX","Upgrade community succeed",e),t()})).catch((t=>{this.Logger.zsymb(18,"ShKeD8","Upgrade community failed",e,t),s(t)}))}))}shouldLoadVerificationStatus(e){if(this.verification.loaded&&this.verification.status===$f.b.VERIFIED)return!1;const t=oi.default.getGroupByIdSync(e);return"number"==typeof(null==t?void 0:t.totalMember)&&(Ra.q.isCommunityFromInfo(t)||t.totalMember>=ms.default.group_privacy.community.minimum_warn_upgrade)}onConversationDidOpen(e){this.onboardController.onConversationDidOpen(e),qa.a.isGroup(e)&&zf.GroupSettingHelper.isOwner(e,zt.default.getUidMe())&&(this.shouldLoadVerificationStatus(e)?(this.getAccountVerificationStatus((()=>{this.handleUpdateDataItemImmediately({groupId:e})})),this.verification.loaded=!0):this.data.has(e)||this.handleUpdateDataItemImmediately({groupId:e}))}onReceivedCommunityError({groupId:e,errorCode:t,windowId:s,src:a}){switch(t){case R.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE:case R.GROUP_MEMBER_ERROR.REACHED_LIMIT_MEMBER_GROUP:Gt.ModalManagerV2.openModal({windowId:s,name:R.ModalIdentitiesDefine.COMMUNITY_PREVENT_ADD_MEMBER,params:{groupId:e,errorCode:t,src:a}}),a&&zf.GroupSettingHelper.isOwner(e,zt.default.getUidMe())&&i.ModuleContainer.resolve(Ra.p).openPreventAddMemberReport({groupId:e,type:t==R.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE?"need_kyc":"need_upgrade",entryPoint:a})}}closeChatBoxBanner(e){this.hiddenChatBoxBannerGroups.addItem(e),this.handleUpdateDataItemImmediately({groupId:e})}async checkCommunityQuota(e){const t=await ys.default.getQuotaCommunity(e);if(t&&t.canUpgr)return!0;throw{data:t}}async checkCommunityMemberQuota(e,t){try{const s=await ys.default.checkQuotaCommunityMember(e,t);this.Logger.zsymb(0,"EntYTh","check member quota ok",e,t,s);const i={isQualified:s.canUpgr,content:s.content};if(s.canUpgr||s.othersCanUpgr)return i;throw{data:i}}catch(s){throw this.Logger.zsymb(18,"R08-gP","check member quota fail",e,t,s),s}}})||tv)||tv)||tv)||tv)||tv)||tv);var iv,av=s("7Ull");Object(ke.i)()(iv=Object(ke.g)()(iv=Object(i.singleton)(Ra.h)(iv=Reflect.metadata("design:type",Function)(iv=Reflect.metadata("design:paramtypes",[])(iv=class{constructor(){this.onboardedGroups=void 0,this.lastOnboardedGroupId=void 0,this.onboardingCounter=void 0,this.status=void 0,this.emitter=void 0,this.recentUpgradedGroups=void 0,this.closeOnboard=e=>{this.status[e]&&(this.status=Object(f.a)(Object(f.a)({},this.status),{},{[e]:!1}),this.emitter.emit("change",this.status))},this.isCanShowOnboard=e=>{const t=this.onboardingCounter.getItem(e);return"number"!=typeof t||t<ms.default.group_privacy.community.max_onboard_times},this.handleGroupUpgradeEvent=({groupId:e})=>{this.recentUpgradedGroups.add(e);const t=Zi.default.isOpenChildWindowByConvId(e),s=e==i.ModuleContainer.resolve($s.SidebarController).getCurrMainConvId();ms.default.group_privacy.community.enable_ui&&(t||s)&&(zf.GroupSettingHelper.isOwner(e,zt.default.getUidMe())?(this.status=Object(f.a)(Object(f.a)({},this.status),{},{popup:!0,tip:!1}),this.emitter.emit("change",this.status),this.onDoneNewOnboardingLevel(e,Ra.i.POPUP)):this.isCanShowOnboard(Ra.i.TIP)&&(this.status=Object(f.a)(Object(f.a)({},this.status),{},{tip:!0,popup:!1}),this.emitter.emit("change",this.status),setTimeout((()=>{this.closeOnboard("tip")}),ms.default.group_privacy.community.onboard_tip_time),this.onDoneNewOnboardingLevel(e,Ra.i.TIP)))},this.handleLeaveGroupEvent=e=>{for(const t of e)this.recentUpgradedGroups.delete(t)},this.handleOpenChildWindow=({windowId:e})=>{const t=Zi.default.getConvIdFromWindowId(e);this.onConversationDidOpen(t)},this.onboardedGroups=new Set,this.lastOnboardedGroupId=null,this.onboardingCounter=new av.a(Ra.d),this.status={tip:!1,popup:!1},this.recentUpgradedGroups=new Set,this.emitter=new Go.a}onStart(){oi.default.subscribeEventGroup(R.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),oi.default.subscribeEventGroup(R.EventGroup.UPGRADE_COMMUNITY,this.handleGroupUpgradeEvent),Zi.default.subscribe(Qs.a.CHILD_WINDOW_ALIVE,this.handleOpenChildWindow)}onDispose(){oi.default.unsubscribeEventGroup(R.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),oi.default.unsubscribeEventGroup(R.EventGroup.UPGRADE_COMMUNITY,this.handleGroupUpgradeEvent),Zi.default.unsubscribe(Qs.a.CHILD_WINDOW_ALIVE,this.handleOpenChildWindow),this.recentUpgradedGroups.clear()}getStatus(){return this.status}hasOnboardedGroupId(e){return this.onboardedGroups.has(e)}getLastOnboardedGroupId(){return this.lastOnboardedGroupId}isDoneOnboard(){return!Object.values(Ra.i).some(this.isCanShowOnboard)}getStatusForGroup(e){return this.recentUpgradedGroups.has(e)?{tip:!1,popup:this.isCanShowOnboard(Ra.i.POPUP)}:{tip:this.isCanShowOnboard(Ra.i.TIP),popup:!1}}onConversationDidOpen(e){ms.default.group_privacy.community.enable_ui&&qa.a.isGroup(e)&&Ra.q.isCommunity(e)&&!this.onboardedGroups.has(e)&&(this.status=this.getStatusForGroup(e),this.status.tip&&(this.emitter.emit("change",this.status),setTimeout((()=>{this.closeOnboard("tip")}),ms.default.group_privacy.community.onboard_tip_time),this.onDoneNewOnboardingLevel(e,Ra.i.TIP)),this.status.popup&&(this.emitter.emit("change",this.status),this.onDoneNewOnboardingLevel(e,Ra.i.POPUP)))}onDoneNewOnboardingLevel(e,t){if(this.isDoneOnboard())return;this.lastOnboardedGroupId=e,e&&this.onboardedGroups.add(e);let s=this.onboardingCounter.getItem(t);"number"!=typeof s&&(s=0),this.onboardingCounter.setItem(t,s+1)}resetOnboardFlagFromLocal(){this.lastOnboardedGroupId=null,this.onboardedGroups.clear(),this.onboardingCounter.clear()}})||iv)||iv)||iv)||iv);var nv,rv=s("eCBG");Object(ke.g)()(nv=Object(ke.i)()(nv=Object(i.singleton)(Ra.o)(nv=Reflect.metadata("design:type",Function)(nv=Reflect.metadata("design:paramtypes",[])(nv=class extends je.b{constructor(){super(),this.cachedGroupOwnerInfo=void 0,this.logger=void 0,this.onOpenConvChildWindow=e=>{const t=Zi.default.getConvIdFromWindowId(e);this.onOpenConversation(t)},this.cachedGroupOwnerInfo=new Set}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.community,[Ra.k])),this.logger}handlePreloadOwnerInfo(e){const t=oi.default.getMiniInfoGroup(e);null!=t&&t.creatorId&&!this.cachedGroupOwnerInfo.has(e)&&i.ModuleContainer.resolve(rv.b).getUserInfo(t.creatorId).then((t=>{this.cachedGroupOwnerInfo.add(e),this.dispatchEvent(new Ra.m("done-preload-owner-info",e,{info:t}))})).catch((e=>{this.Logger.zsymb(18,"FZw1_F","Load owner info fail",t,e)}))}onStart(){Zi.default.subscribe(Qs.a.CHILD_WINDOW_ALIVE,this.onOpenConvChildWindow)}onDispose(){Zi.default.unsubscribe(Qs.a.CHILD_WINDOW_ALIVE,this.onOpenConvChildWindow),this.cachedGroupOwnerInfo.clear()}onOpenConversation(e){Is.default.isGroup(e)&&ms.default.group_privacy.group_created_by_oa&&this.handlePreloadOwnerInfo(e)}})||nv)||nv)||nv)||nv);var ov=s("Ff2n");const dv=["groupId","memberId","actorId"],lv=["groupId","memberId","actorId"];var cv;Object(i.singleton)(Ra.l)(cv=Reflect.metadata("design:type",Function)(cv=Reflect.metadata("design:paramtypes",[])(cv=class{constructor(){this.name=void 0,this.logger=void 0,this.name=Ra.j}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.group,[this.name])),this.logger}onAppointAdmin(e){const{groupId:t,memberId:s,actorId:i}=e;this.Logger.zsymb(0,"d-Nrot",`add admin group=${t} mem=${s} actor=${i}`)}onRemoveAdmin(e){const{groupId:t,memberId:s,actorId:i}=e;this.Logger.zsymb(0,"knA3i7",`remove admin group=${t} mem=${s} actor=${i}`)}onLeaveGroup(e){const{groupId:t,memberId:s,actorId:i}=e,a=Object(ov.a)(e,dv);this.Logger.zsymb(0,"kIKsyY",`leave group=${t} mem=${s} actor=${i}`,a)}onRemoveMember(e){const{groupId:t,memberId:s,actorId:i}=e,a=Object(ov.a)(e,lv);this.Logger.zsymb(0,"hDlAaY",`kickout group=${t} mem=${s} actor=${i}`,a)}})||cv)||cv);var hv=s("P+Nn");let uv=function(e){return e[e.SEND_FSS=4]="SEND_FSS",e[e.SEND_CARD=5]="SEND_CARD",e}({}),gv=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({});var mv=s("nmtd");i.ModuleContainer.registerSingleton(hv.a,class{logAction999(e){const{type:t,payload:s,noisedIds:i}=e;switch(t){case mv.a.CARD:Vt.default.logActionInfoV2(Vt.FeaturesInfo.SendFSS,uv.SEND_CARD,s,i);break;case mv.a.STICKER:Vt.default.logActionInfoV2(Vt.FeaturesInfo.SendFSS,uv.SEND_FSS,s,i)}}getChatTypeFromConvId(e){return Is.default.isGroup(e)?gv.CHAT_GROUP:Op.a.isSendToMe(e)?gv.MY_CLOUD:gv.CHAT_11}getRawDestinationId(e,t){return t===gv.CHAT_GROUP?Is.default.getGroupIdFromConversationId(e):e}sendCardReport(e){const t=this.getChatTypeFromConvId(e.toUid),s=this.getRawDestinationId(e.toUid,t),i=zt.default.getUidMe();this.logAction999({type:mv.a.CARD,payload:{src_id:i,des_id:s,chat_type:t,group_id:t===gv.CHAT_GROUP?s:null,ecard:{background_id:e.backgroundId,char_count:e.charCount,list_title_id:e.listTitleId,tagline_id:e.taglineId}},noisedIds:[i,s]})}sendFSSReport(e){const t=this.getChatTypeFromConvId(e.toUid),s=this.getRawDestinationId(e.toUid,t),i=zt.default.getUidMe();this.logAction999({type:mv.a.STICKER,payload:{src_id:i,des_id:s,chat_type:t,cate_id:e.categoryId,sticker_id:e.stickerId,group_id:t===gv.CHAT_GROUP?s:null},noisedIds:[i,s]})}});var pv=s("yQd5");const fv=`${pv.b}-network-manager`;var vv=Object(i.define)(fv),bv=s("DPHK");var yv=class{constructor(){}updateMyAvatar(e,t,s,i={},a=!1){return zt.default.updateMyAvatar(e,s,t,i)}updateGroupAvatar(e,t,s,i,a){let n=pv.a.w,r=pv.a.h;return a&&(a.originWidth&&(n=a.originWidth),a.originHeight&&(r=a.originHeight)),this.resolveRequest(Nn.default.updateAvatar(e,t,i,s,n,r))}updateAvatar(e,t,s=120,i={},a=!1){const n=e+bv.a.getFullTimeFromMilisecond((new Date).getTime());return Is.default.isGroup(e)?this.updateGroupAvatar(e,s,t,n,i):this.updateMyAvatar(s,t,n,i,a)}async reuseAvatar(e,t){let s={photoId:e,isPostSocial:t?1:0};const i=cs.b.getProfileDomain()+"/api/social/reuse-avatar?"+this._getCommonParams()+"&params="+this.getEncodedParams(s);return this.resolveRequest(this._get(i,null,12453))}async getAvatarHistory(e,t,s,i){let a={page:e,albumId:s,count:i};t&&(a.photoId=t);const n=cs.b.getProfileDomain()+"/api/social/avatar-list?"+this._getCommonParams()+"&params="+this.getEncodedParams(a);return this.resolveRequest(this._get(n,null,12451))}deleteAvatarHistory(e){let t={delPhotos:JSON.stringify(e.map((e=>({photoId:e.toString()}))))};const s=cs.b.getProfileDomain()+"/api/social/del-avatars?"+this._getCommonParams()+"&params="+this.getEncodedParams(t);return this.resolveRequest(this._get(s,null,12452))}_get(e,t,s){return Nn.default._get(e,t,s)}_getCommonParams(){return Nn.default._getCommonParams()}getEncodedParams(e){return Nn.default.getEncodedParams(e)}resolveRequest(e){return new Promise(((t,s)=>{e.then(jn.a).then(t).catch(s)}))}};i.ModuleContainer.register(vv,class{get api(){return this._api||(this._api=new yv),this._api}constructor(){this._api=void 0,this._logger=void 0,this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(pv.b,["network-manager"])}async updateAvatar(e,t,s,i,a){this._logger.zsymb(0,"9h6-b2",`updateAvatar [convId: ${e}], [s: ${t.size}] [share: ${a}] [meta:`,i);try{return await this.api.updateAvatar(e,t,s,i,a),Promise.resolve(!0)}catch(n){return this._logger.zsymb(18,"wefEUO",`updateAvatar [convId: ${e}], [err:`,n),Promise.reject(n)}}async getAvatarHistory(e,t,s,i){return this._logger.zsymb(0,"NyoIWB",`getAvatarHistory [p:${e}], [pId:${t}], [aId:${s}], [c:${i}]`),this.api.getAvatarHistory(e,t,s,i)}async reuseAvatar(e,t){return this._logger.zsymb(0,"uzstUo",`reuseAvatar [photoId: ${e}], [isPostSocial:`,t,"]"),this.api.reuseAvatar(e,t)}async deleteAvatarHistory(e){this._logger.zsymb(0,"78g9Zc","deleteAvatarHistory [photoIds: ",e);try{return await this.api.deleteAvatarHistory(e),Promise.resolve(!0)}catch(t){return Promise.reject(t)}}});const Iv=`${pv.b}-repository`;var _v=Object(i.define)(Iv);const Cv=`${pv.b}-storage`;var Ov,Sv=Object(i.define)(Cv),Ev=s("nKYX"),Mv=s("dVwc");let Tv=Object(i.injectable)()(Ov=function(e,t){return Object(i.inject)(Sv)(e,void 0,0)}(Ov=function(e,t){return Object(i.inject)(vv)(e,void 0,1)}(Ov=Reflect.metadata("design:type",Function)(Ov=Reflect.metadata("design:paramtypes",[Object,Object])(Ov=class{constructor(e,t){this.storage=e,this.fetcher=t}reuseAvatar(e,t){return this.fetcher.reuseAvatar(e,t)}updateAvatar(e,t,s,i,a){return this.fetcher.updateAvatar(e,t,s,i,a)}async getAvatarHistory(e=0,t="",s="0",i=50){try{const a=await this.fetcher.getAvatarHistory(e,t,s,i);return this.mapApiDataToBackup(a),this.mapApiDataToModel(a)}catch(a){let e=Ev.a.ERR_GET_AVA_HISTORY;return a&&a.code&&(e=a.code),Promise.reject({code:e,message:(null==a?void 0:a.message)||a})}}deleteAvatarHistory(e){return this.fetcher.deleteAvatarHistory(e)}mapApiDataToBackup(e){e.photos.length&&e.photos.forEach((({url:e,bkUrl:t})=>{Mv.a.getInstance().setBackup(e,t)}))}mapApiDataToModel(e){return{albumId:e.albumId,hasMore:Boolean(e.hasMore),nextPhotoId:e.nextPhotoId,photos:e.photos.length?e.photos.map((e=>({photoId:e.photoId,thumb:e.thumbnail,url:e.url}))):[]}}})||Ov)||Ov)||Ov)||Ov)||Ov;i.ModuleContainer.register(_v,Tv);var wv;i.ModuleContainer.register(Sv,class{constructor(){this._storage=void 0,this._logger=void 0}get storage(){return this._storage||(this._storage=ze.default.getInstance()),this._storage}get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(pv.b,["storage"])),this._logger}async getAvatarHistory(){return new Promise((async(e,t)=>{try{e(await this.storage.Core.AvaHistory.getAll())}catch(s){return this.logger.zsymb(18,"m4ICBW","getAvatarHistory",s),t(s)}}))}addNewAvatarToHistory(e){const t=(new Date).getTime();return this.storage.Core.AvaHistory.insert(Object(f.a)(Object(f.a)({},e),{},{submit_dttm:t}),{replace:!0})}deleteAvatarHistory(e){return this.storage.Core.AvaHistory.delete(e)}});let Rv=Object(i.injectable)()(wv=function(e,t){return Object(i.inject)(_v)(e,void 0,0)}(wv=Reflect.metadata("design:type",Function)(wv=Reflect.metadata("design:paramtypes",[Object])(wv=class{get logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(pv.b,[ci.ZLoggerNametags.controller])),this._logger}constructor(e){this.repository=e,this._logger=void 0,this._avatarHistoryMeta={page:1,photoId:"",albumId:"0",hasMore:!0},this._historyAvatars=[],this._retryLoadMore=1}getFrameList(e){return e?ms.default.operation_frame_list.group:ms.default.operation_frame_list.personal}getDefaultAvatarList(){var e,t;return(null===ms.default||void 0===ms.default||null===(e=ms.default.settings)||void 0===e||null===(t=e.group)||void 0===t?void 0:t.avt_group_template)||null}async getInitialAvatarHistory(e=50){return this._avatarHistoryMeta={page:1,photoId:"",albumId:"0",hasMore:!0},this._retryLoadMore=1,await this.getAvatarHistory(e)}async loadMoreAvatarHistory(){if(this._avatarHistoryMeta.hasMore&&this._retryLoadMore<3)try{return await this.getAvatarHistory()}catch(e){return this.logger.zsymb(0,"gGzBij","loadMoreAvatarHistory error",e),this.logger.zsymb(0,"lMXaME","retry loadmore",this._retryLoadMore),this._retryLoadMore++,this.loadMoreAvatarHistory()}return[]}async getAvatarHistory(e){if(!this.isValidNetwork())return Promise.reject({code:Ev.a.ERR_NO_NETWORK,message:""});try{const t=await this.repository.getAvatarHistory(this._avatarHistoryMeta.page,this._avatarHistoryMeta.photoId,this._avatarHistoryMeta.albumId,e||50);return this._avatarHistoryMeta={albumId:t.albumId,page:this._avatarHistoryMeta.page+1,photoId:t.nextPhotoId,hasMore:t.hasMore},Array.prototype.push.apply(this._historyAvatars,t.photos),t.photos}catch(t){return this.logger.zsymb(18,"ztKfEp","Error getting avatar history",t),Promise.reject({code:Ev.a.ERR_GET_AVA_HISTORY,message:(null==t?void 0:t.msg)||(null==t?void 0:t.message)})}}async deleteAvatarHistory(e){if(!this.isValidNetwork())return Promise.reject({code:Ev.a.ERR_NO_NETWORK,message:""});try{return await this.repository.deleteAvatarHistory([e]),this._historyAvatars=this._historyAvatars.filter((t=>t.photoId!==e)),!0}catch(t){if(this.logger.zsymb(18,"F2LD8r","deleteAvatarHistory",t),t&&t.errMap){const s=t.errMap;return Promise.reject({code:s[e],message:""})}return Promise.reject({code:Ev.a.DELETE_AVATAR_ERROR,message:""})}}updateAvatar(e,t,s,i,a){return this.isValidNetwork()?this.repository.updateAvatar(e,t,s,i,a):Promise.reject({code:Ev.a.ERR_NO_NETWORK,message:""})}async reuseAvatar(e,t){try{await this.repository.reuseAvatar(e,t);const s=this._historyAvatars.find((t=>t.photoId===e));return s&&(this._historyAvatars=this._historyAvatars.filter((t=>t.photoId!==e)),this._historyAvatars.unshift(s)),!0}catch(s){return Promise.reject(!1)}}isValidNetwork(){return Un.b.getStateNetwork()===Un.a.CONNECTED}})||wv)||wv)||wv)||wv;var Lv=s("TGcW").a;i.ModuleContainer.registerSingleton(Lv,Rv);var Fv,Dv=s("Vh8h"),Av=s("Xt6Q"),jv=s("kEG/");function Pv(){return"number"==typeof ms.default.async_forward.checked_url_cache_expiration_time?ms.default.async_forward.checked_url_cache_expiration_time:36e5}function Nv(){return!ms.default.async_forward.disable_cache_check_exist}function Uv(){return vi.a.now()}var kv=Object(i.injectable)()(Fv=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(Fv=Reflect.metadata("design:type",Function)(Fv=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(Fv=class{constructor(e){this._checkedMap=new Map,this._currentCheckingRequestAmount=0,this._urlChangedMap=new Map,this._logger=void 0,this._isQueueExecuting=!1,this._queue=[],$e.p.listenEvent($e.j,this.onNetworkChange.bind(this)),this.Logger=e.createZLogger("utils",["share-file-handler"])}check(e){return new Promise(((t,s)=>{Nv()&&this.checkedMap.has(e)&&Uv()-this.checkedMap.get(e)<Pv()?(t(!0),this.executeQueue()):this.enqueueExecution(e,t,s)}))}getNewUrl(e){return this.urlChangedMap.get(e)||e}updateFileUrl(e,t){this.urlChangedMap.set(e,t),this.checkedMap.set(t,Uv())}decreaseRequestAmount(){this._currentCheckingRequestAmount--}enqueueExecution(e,t,s,i=!0){this.executionQueue.push({url:e,resolve:t,reject:s,shouldRetry:i}),this.executeQueue()}executeQueue(){if(!this.isQueueExecuting()){for(this.setExecutionQueueWorking();this.getCurrentNetworkStatus()!==Un.a.DISCONNECT&&this.getCurrentRequestAmount()<=("number"==typeof ms.default.async_forward.maximum_requests_in_a_while?ms.default.async_forward.maximum_requests_in_a_while:5)&&this.executionQueue.length>0;){let e=this.executionQueue.shift();this.increaseRequestAmount(),this.processCheckingRequest(e).then((()=>{this.handleResponse(e,!0,null)})).catch((t=>{var s;this.handleResponse(e,!1,null===(s=t.data)||void 0===s?void 0:s.status)}))}this.setExecutionQueueFree()}}getCurrentNetworkStatus(){return Un.b.getStateNetwork()}getCurrentRequestAmount(){return this._currentCheckingRequestAmount}increaseRequestAmount(){this._currentCheckingRequestAmount++}isQueueExecuting(){return this._isQueueExecuting}onNetworkChange(){this.getCurrentNetworkStatus()===Un.a.CONNECTED&&(this.Logger.zsymb(21,"bVvU3J",["network was connected, start executing check-exist queue","eMSQfN"]),this.executeQueue())}setExecutionQueueFree(){this._isQueueExecuting=!1}setExecutionQueueWorking(){this._isQueueExecuting=!0}handleResponse(e,t,s){this.decreaseRequestAmount(),t?(this.checkedMap.set(e.url,Uv()),this.executeQueue()):s===jv.b.ClientError.RequestTimeout&&e.shouldRetry?this.enqueueExecution(e.url,e.resolve,e.reject,!1):(this.checkedMap.set(e.url,0),this.executeQueue()),e.resolve(t)}tryToLoadUrl(e){return new Promise(((t,s)=>{const i=91047;!function(e,t={}){const s=Date.now(),i=Uv();let a=e.replace("http://","https://");a=Is.default.removeE2eeProtocol(a);const{onabort:n=null,onerror:r=null,onload:o=null,ontimeout:d=null,timeout:l=1e4}=t,c=new XMLHttpRequest;c.open("HEAD",a),c.responseType="arraybuffer",c.timeout=l,Av.k||c.setRequestHeader("Cache-Control","no-cache");const h=()=>({duration:Uv()-i,startTime:s});c.onload=e=>{o&&o(e,h())},c.onerror=e=>{r&&r(e,h())},c.ontimeout=e=>{d&&d(e,h())},c.onabort&&(c.onabort=e=>{n&&n(e,h())}),c.send()}(e,{onabort:(e,t)=>{fs.default.increaseFailed(i,0,t.duration,4,t.startTime),s(e.target.status)},onerror:(e,t)=>{this.Logger.zsymb(21,"_yg4yT",["check-exist error: {}","8qaahj"],e),fs.default.increaseFailed(i,0,t.duration,2,t.startTime),s(e.target.status)},onload:(e,a)=>{e.target.status>=400?(fs.default.increaseFailed(i,0,a.duration,3,a.startTime),s(e.target.status)):e.target.responseURL&&e.target.responseURL.indexOf("default")>=0?(fs.default.increaseFailed(i,0,a.duration,5,a.startTime),s(e.target.status)):(fs.default.increaseSuccess(i,0,a.duration),t(!0))},ontimeout:(e,t)=>{fs.default.increaseFailed(i,0,t.duration,1,t.startTime),s(e.target.status)}})}))}async processCheckingRequest(e){if(!e)return Promise.reject({message:"Invalid request item",data:null});const{url:t}=e;if(Nv()&&this.checkedMap.has(t)){let e=this.checkedMap.get(t);if(Uv()-e<Pv())return Promise.resolve()}if(Av.k&&!Is.default.isConnectSrc(t))try{return await Object(Dv.b)(t,"number"==typeof ms.default.async_forward.checking_url_timeout?ms.default.async_forward.checking_url_timeout:1e4),Promise.resolve()}catch(s){return Promise.reject({message:"",data:{status:0}})}try{return await this.tryToLoadUrl(t),Promise.resolve()}catch(s){return Promise.reject({message:"",data:{status:s}})}}get checkedMap(){return this._checkedMap}get executionQueue(){return this._queue}get urlChangedMap(){return this._urlChangedMap}get Logger(){return this._logger}set Logger(e){this._logger=e}})||Fv)||Fv)||Fv)||Fv,Bv=s("vyPS");i.ModuleContainer.register(Bv.a,kv);var Gv=s("X2RP"),xv=s("rvru"),zv=s("Mk04"),Vv=s("Yggq"),Hv=s("HWGt");class $v extends Hv.a{constructor(...e){super(...e),this.dbQos=null,this.signalOutOfMem=Object(zv.a)((()=>{$e.p.triggerEvent($e.b,[!0,"zkey-out-mem"])})),this.signalInvalidVersion=Object(zv.a)((()=>{$e.p.triggerEvent($e.b,[!0])})),this.signalMissingStores=Object(zv.a)((()=>{$e.p.triggerEvent($e.b,[!0,"zkey-miss-object-store"])})),this.signalExceedingLimitInReopeningDBConnection=Object(zv.a)((()=>{$e.p.triggerEvent($e.b,[!1])}))}getDBQos(){return null===this.dbQos&&(this.dbQos=i.ModuleContainer.resolve(xv.a)),this.dbQos}handleQueryError(e){this.getDBQos().sendDBErrorQos(e)}handleOutOfMemError(){this.signalOutOfMem()}handleInvalidVersionError(){this.signalInvalidVersion()}handleMissingStoreError(e){this.signalMissingStores();const t=this.getDBQos(),{database:s,missingTables:i}=e;t.sendMissingTableQos(s,i)}handleExceedingLimitInReopeningDBConnection(){this.signalExceedingLimitInReopeningDBConnection()}handleQueryExec(e){const{database:t,table:s,method:i,transaction:a,startTime:n,getEndTime:r}=e;Vv.a.has(t)||r().then((e=>{const r={method:i,database:t,table:s,transaction:a};Li.default.recordInfo(Li.MetricName.query_resolution_time,{startAt:n,endAt:e,info:r})})).catch((e=>{}))}handleLongOpenDB(e){const{startTime:t,endTime:s,fullname:i}=e;this.getDBQos().sendLongOpenRequestQos(i,t,s-t)}handleTimeConsumingQuery(e,t){this.getDBQos().sendTimeConsumingQueryQos(e,t)}handleSuccessOpenDB(e){const{startTime:t,endTime:s,fullname:i}=e;this.getDBQos().sendSuccessOpenDBDurationQos(i,t,s-t),Li.default.recordInfo(Li.MetricName.db_ready,{startAt:t,endAt:s,info:{dbName:i}})}handleWarning(e){const t=this.getDBQos();if(e.type===Gv.b.FAILED_MULTI)t.sendFailedMultiErrorQos(e)}}(new $v).start();var Wv=s("GaKD"),qv=s("Y65e");const Kv=i.ModuleContainer.resolve(He.b),Zv=(e,t)=>(s,i,a)=>{const n=a.value;a.value=function(...s){const i=performance.now(),a=n.apply(this,s);if(a instanceof Promise)return Br.b.catchAsyncFn((()=>a)).then((([a,n])=>{const r=performance.now()-i,o=Object(f.a)({commandId:e,success:!a,errorCode:null==a?void 0:a.code,duration:r},null==t?void 0:t(s,[a,n],r));if(Kv.log(o),a)throw a;return n}));{const n=performance.now()-i,r=Object(f.a)({commandId:e,success:!0,duration:n},null==t?void 0:t(s,[null,a],n));return Kv.log(r),a}}};let Qv=function(e){return e[e.CLIENT_PARSER=111026]="CLIENT_PARSER",e[e.SERVER_PARSER=111027]="SERVER_PARSER",e[e.NOOP_PARSER=111028]="NOOP_PARSER",e[e.DOWNLOAD_THUMB=111029]="DOWNLOAD_THUMB",e[e.UPLOAD_THUMB=111030]="UPLOAD_THUMB",e[e.PREVIEW_INTEGRITY=111031]="PREVIEW_INTEGRITY",e}({});var Jv,Yv,Xv,eb,tb;let sb=(Jv=Zv(Qv.NOOP_PARSER,(([e])=>({params:[e]}))),Yv=Reflect.metadata("design:type",Function),Xv=Reflect.metadata("design:paramtypes",[String]),tb=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e){return!0}async parse(e){return null}},tb.instance=null,eb=tb,Object(qv.a)(eb.prototype,"parse",[Jv,Yv,Xv],Object.getOwnPropertyDescriptor(eb.prototype,"parse"),eb.prototype),eb);var ib=s("G95d"),ab=s("dXzg");let nb=function(e){return e[e.UNKNOWN_ERROR=100]="UNKNOWN_ERROR",e[e.URL_ERROR=101]="URL_ERROR",e[e.HTTP_STATUS_ERROR=102]="HTTP_STATUS_ERROR",e[e.REDIRECT_ERROR=103]="REDIRECT_ERROR",e[e.PARSE_XML_HEAD_ERROR=104]="PARSE_XML_HEAD_ERROR",e[e.HTTP_REQUEST_ERROR=105]="HTTP_REQUEST_ERROR",e[e.EMPTY_METADATA=106]="EMPTY_METADATA",e[e.PARSE_LINK_SERVER_ERROR=200]="PARSE_LINK_SERVER_ERROR",e[e.DOWNLOAD_THUMB_ERROR=300]="DOWNLOAD_THUMB_ERROR",e[e.THUMB_SIZE_ERROR=301]="THUMB_SIZE_ERROR",e[e.THUMB_TYPE_ERROR=302]="THUMB_TYPE_ERROR",e[e.WEBP_THUMB_TYPE_ERROR=303]="WEBP_THUMB_TYPE_ERROR",e[e.UPLOAD_THUMB_ERROR=400]="UPLOAD_THUMB_ERROR",e[e.COMPRESS_THUMB_ERROR=401]="COMPRESS_THUMB_ERROR",e[e.GET_PARSER_ERROR=500]="GET_PARSER_ERROR",e}({});const rb=(e,t)=>{if(e)throw t};class ob extends Error{constructor(e,t,s,i=[]){super(s),this.code=void 0,this.qosParams=void 0,this.name=e,this.qosParams=[s,...i],this.code=t}setStack(e){const t=`${this.name}: ${this.message}`;this.stack=t+(e||"")}toObject(){return{name:this.name,code:this.code,message:this.message,stack:this.stack,qosParams:this.qosParams}}static createFromObject(e){const{name:t="UnknownError",code:s=nb.UNKNOWN_ERROR,message:i,stack:a,qosParams:n=[]}=e,r=new ob(t,s,i,n);return r.setStack(a),r}}class db extends ob{constructor(e,t,s){super("ParseLinkServerError",nb.PARSE_LINK_SERVER_ERROR,`Parse link server failed. Url: ${e}. Message: ${t}`,s)}}const lb=1048576,cb={GB:1073741824,MB:lb,KB:1024,byte:1};let hb;var ub;(ub=hb||(hb={})).sizeInByte=e=>{const t=/(\d+)(byte|KB|MB|GB)/g;let s,i=0;for(;s=t.exec(e);)i+=parseInt(s[1])*cb[s[2]];return i},ub.getFileSizeByHead=async(e,t)=>{const s=await fetch(e,{method:"HEAD"}),i=s.headers.get("content-length"),a=s.headers.get("content-type");if(t&&t!=a)throw new Error(`An error occurred when trying to get file size. Error: unexpected content-type.Content-type expectation is "${t}" but received Content-type is "${a}".`);return Number(null!=i?i:0)};var gb=function(e){return e[e.META_TITLE=0]="META_TITLE",e[e.META_DESCRIPTION=1]="META_DESCRIPTION",e[e.META_THUMB=2]="META_THUMB",e[e.DOCUMENT=3]="DOCUMENT",e}(gb||{}),mb=function(e){return e[e.NOT_FOUND=0]="NOT_FOUND",e[e.INVALID_FORMAT=1]="INVALID_FORMAT",e[e.DOWNLOAD_ERROR=2]="DOWNLOAD_ERROR",e}(mb||{});class pb{constructor(){}async fetch(e){const[t,s]=await Br.b.catchAsyncFn((()=>this.fetchLinkInfoFromServer(e)));rb(!!t,t&&new db(e,null==t?void 0:t.message));const[i,a]=await this.transformResponse(e,s);return rb(!!i,i),a}fetchLinkInfoFromServer(e){return Nn.default.getLinkInformation(e).then(jn.a)}async transformResponse(e,t){var s,a,n;if(i.ModuleContainer.resolve(ab.a).get("enable_verify_parse_link_server")&&Br.e.isNotEmptyObject(t.error_maps))return[new db(e,JSON.stringify(t.error_maps)),null];if((null===(s=t.error_maps)||void 0===s?void 0:s[gb.DOCUMENT])===mb.DOWNLOAD_ERROR)return[new db(e,JSON.stringify(t.error_maps)),null];if(e.endsWith(".pdf")){var r;const s=await hb.getFileSizeByHead(e);return t.data=null!==(r=t.data)&&void 0!==r?r:{},t.data.title=hl.a.getFileNameFromUrl(e),t.data.desc=Is.default.sizeToString(s),t.data.thumb=Is.DEFAULT_THUMB_URLS.ICON_PDF,[null,t.data]}return t.data.thumb&&!((null===(a=t.error_maps)||void 0===a?void 0:a[gb.META_THUMB])in mb)||t.data.thumb||t.data.title&&t.data.desc?((null===(n=t.error_maps)||void 0===n?void 0:n[gb.META_THUMB])in mb&&(t.data.thumb=""),[null,t.data]):[new db(e,JSON.stringify(t)),null]}}var fb,vb,bb,yb,Ib,_b=s("o2mE"),Cb=s("/vDv");let Ob=(fb=Zv(Qv.SERVER_PARSER,(([e],t,s)=>(i.ModuleContainer.resolve(_b.b).linkParser.zsymb(12,"LH_lPe","ParseLinkMetric",Qv[Qv.SERVER_PARSER],e,s),{params:[e]}))),vb=Reflect.metadata("design:type",Function),bb=Reflect.metadata("design:paramtypes",[String]),(Ib=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e,t){const s=i.ModuleContainer.resolve(ab.a);if(s.get("enable_force_parse_link_server"))return!0;if(!s.get("enable_parse_link_server"))return!1;const a=s.get("white_list_domain");for(const i of a)if(hl.a.isHrefMatchDomain(e,i))return!0;if((null==t?void 0:t.entry)===ib.a.MESSAGE_WIDGET)return!0;if(!s.get("enable_parse_link_client")){if(null!=t&&t.convId){if(!Cb.a.isE2eeConv(t.convId))return!0}if((null==t?void 0:t.entry)===ib.a.SHARE_MESSAGE)return!0}return!1}async parse(e){const[t,s]=await Br.b.catchAsyncFn((()=>(new pb).fetch(e)));return rb(!!t,t),{typeParse:ib.b.SERVER,href:e,desc:null==s?void 0:s.desc,media:null==s?void 0:s.media,src:null==s?void 0:s.src,stream_icon:null==s?void 0:s.stream_icon,thumb:null==s?void 0:s.thumb,title:null==s?void 0:s.title}}}).instance=null,yb=Ib,Object(qv.a)(yb.prototype,"parse",[fb,vb,bb],Object.getOwnPropertyDescriptor(yb.prototype,"parse"),yb.prototype),yb);var Sb;Object(i.injectable)()(Sb=Object(i.singleton)(Wv.a)(Sb=Reflect.metadata("design:type",Function)(Sb=Reflect.metadata("design:paramtypes",[])(Sb=class{constructor(){}getLinkParser(e,t){return Ob.getInstance().isMatchParser(e,t)?Ob.getInstance():sb.getInstance()}})||Sb)||Sb)||Sb);var Eb,Mb=s("TQME");class Tb{constructor(){}static getInstance(){return Tb.instance||(Tb.instance=new Tb),Tb.instance}async process(e){return e}}Tb.instance=null;class wb{constructor(){}static getInstance(){return wb.instance||(wb.instance=new wb),wb.instance}async process(e){return e}}wb.instance=null;Object(i.injectable)()(Eb=Object(i.singleton)(Mb.a)(Eb=Reflect.metadata("design:type",Function)(Eb=Reflect.metadata("design:paramtypes",[])(Eb=class{constructor(){}getDownloadProcessor(e){switch(e){case ib.b.CLIENT:case ib.b.SERVER:}return wb.getInstance()}getUploadProcessor(e){switch(e){case ib.b.CLIENT:case ib.b.SERVER:}return Tb.getInstance()}})||Eb)||Eb)||Eb);const Rb=Object(i.define)("parser-config-event-emitter");i.ModuleContainer.registerFactory(Rb,Gr.f((()=>new Go.a)));var Lb,Fb=s("LvDl"),Db=s.n(Fb);Object(i.injectable)()(Lb=Object(i.singleton)(ab.b)(Lb=function(e,t){return Object(i.inject)(Rb)(e,void 0,0)}(Lb=Reflect.metadata("design:type",Function)(Lb=Reflect.metadata("design:paramtypes",["undefined"==typeof IParserConfigEventEmitter?Object:IParserConfigEventEmitter])(Lb=class{constructor(e){this.eventEmitter=e,this.config={}}setConfig(e){this.isConfigChange(e)&&(this.config=this.mergeConfig(e),this.eventEmitter.emit("on-config-change",this.config))}mergeConfig(e){return Object(f.a)(Object(f.a)({},this.config),e)}isConfigChange(e){return!new Br.e.Comparer(this.config,e,!0).AND("enable_force_parse_link_server").AND("enable_parse_link_server").AND("enable_parse_link_client").AND("enable_auto_download_thumb").AND("enable_parse_link_receiver").AND("enable_parse_link_sender").AND("enable_upload_thumb_for_delay_send").AND("enable_download_partial_media_e2ee").AND("enable_verify_parse_link_server").AND("enable_show_loading_thumb").AND("white_list_domain",Db.a.isEqual).AND("white_list_domain_mode").AND("max_time_reparse").AND("max_thumb_size").AND("max_age_cache_preview").AND("max_item_cache").AND("max_url_character").AND("max_title_character").AND("max_desc_character").AND("max_delay_send_message").AND("max_redirect").AND("debug",Db.a.isEqual).exec()}})||Lb)||Lb)||Lb)||Lb);var Ab,jb=s("XJ/a"),Pb=s("1e0e");const Nb={enable_force_parse_link_server:!0,enable_parse_link_server:!0,enable_parse_link_client:!1,enable_auto_download_thumb:!0,enable_parse_link_receiver:!0,enable_parse_link_sender:!1,enable_upload_thumb_for_delay_send:!1,enable_download_partial_media_e2ee:!0,enable_verify_parse_link_server:!1,enable_show_loading_thumb:!0,white_list_domain:[".zalo.me",".zaloapp.com","s120.avatar.talk.zdn.vn","cover.talk.zdn.vn","qr.talk.zdn.vn","f22.w640.photo.talk.zdn.vn","res-zalo.zadn.vn","vng.com.vn","stg-shop.zalo.me",".zingplay.me","zalopay.vn","kaka.me","api-internal.mp3.zalo","zstudio.io","123c.vn","adtimaserver.vn","adtima.vn","ad.zing.vn","baomoi.com","baomoi.vn","brand.zing.vn","chat-talk.zing.vn","click.123.vn","epi.com.vn","epi.vn","kakaapp.me","laban.vn","lab.zing.vn","mp3.zing.vn","m.zing.vn","news.zing.vn","nhatkyzalo.vn","playzing.vn","plo.com.vn","plo.vn","stc-tv.zing.vn","sukien.net.vn","tachthongtin.com","talk.zing.vn","trithuctructuyen.com.vn","trithuctructuyen.vn","tv.zing.vn","xdn.vn","xone.fm","zagoo.vn","zalo.ai","zalo.careers","zalochat.com","zalo.cx","zalo.gg","zalo.me","zalomusic.com","zalonews.net","zaloplus.vn","zalo-shop.vn","zalo.vn","zamoji.vn","zapps.vn","zavatar.vn","zavi.me","za.zdvn.vn","zdn.vn","zingmp3.com","zingmp3.vn","zingnews.com.vn","zingnews.vn","zingtv.vn","zstudio.io","zaloshop.me","dr.zapps.vn","hc.zalo.me"],white_list_domain_mode:"append",max_time_reparse:Pb.a.timeInMs("24h"),max_thumb_size:hb.sizeInByte("2MB"),max_age_cache_preview:Pb.a.timeInMs("24h"),max_item_cache:300,max_url_character:500,max_title_character:80,max_desc_character:200,max_delay_send_message:Pb.a.timeInMs("2s"),max_redirect:2,debug:{enable_log_metric:!1,delay_parse_client:Pb.a.timeInMs("0s")}};Object(i.injectable)()(Ab=Object(i.singleton)(ab.a)(Ab=Reflect.metadata("design:type",Function)(Ab=Reflect.metadata("design:paramtypes",[])(Ab=class{constructor(){this.config=void 0,this.configValidator=void 0,this.config=Nb,this.configValidator=new jb.a({enable_force_parse_link_server:jb.b.field().boolean(),enable_parse_link_server:jb.b.field().boolean(),enable_parse_link_client:jb.b.field().boolean(),enable_auto_download_thumb:jb.b.field().boolean(),enable_parse_link_receiver:jb.b.field().boolean(),enable_parse_link_sender:jb.b.field().boolean(),enable_download_partial_media_e2ee:jb.b.field().boolean(),enable_verify_parse_link_server:jb.b.field().boolean(),enable_show_loading_thumb:jb.b.field().boolean(),white_list_domain:jb.b.field().array("string"),white_list_domain_mode:jb.b.field().string().oneOf(["append","override"]),max_time_reparse:jb.b.field().number().min(0),max_thumb_size:jb.b.field().number().min(0),max_age_cache_preview:jb.b.field().number().min(0),max_item_cache:jb.b.field().number().min(0),max_url_character:jb.b.field().number().min(0),max_title_character:jb.b.field().number().min(0),max_desc_character:jb.b.field().number().min(0),max_delay_send_message:jb.b.field().number().min(0),max_redirect:jb.b.field().number().min(0),debug:jb.b.field().object({enable_log_metric:jb.b.field().boolean(),delay_parse_client:jb.b.field().number()})})}get(e,t){var s;return null!==(s=this.config[e])&&void 0!==s?s:t}setConfig(e){const t=this.configValidator.validateWithFallback(e,Nb);this.config=Object(f.a)(Object(f.a)(Object(f.a)({},this.config),t),this.mergeWhiteListDomainConfig(t))}mergeWhiteListDomainConfig(e){const t=e.white_list_domain_mode,s=e.white_list_domain,i=this.config.white_list_domain;switch(t){case"append":default:return{white_list_domain:i.concat(s)};case"override":return{white_list_domain:s}}}})||Ab)||Ab)||Ab);i.ModuleContainer.resolve(Rb).on("on-config-change",(e=>{i.ModuleContainer.resolve(ab.a).setConfig(e)}));class Ub{constructor(e){this.maxAge=e,this.mapTsItemIsSet=void 0,this.mapTsItemIsSet=new Map}hookBeforeGet(e,t){const s=this.mapTsItemIsSet.get(e);if(!s)return;Date.now()-s>=this.maxAge&&t(e)}hookAfterSet(e){this.mapTsItemIsSet.set(e,Date.now())}hookAfterDelete(e){this.mapTsItemIsSet.delete(e)}hookAfterClear(){this.mapTsItemIsSet.clear()}}class kb{constructor(e){this.maxItem=e,this.mapTsItemIsVisited=void 0,this.mapTsItemIsVisited=new Map}hookBeforeGet(e){this.mapTsItemIsVisited.set(e,{key:e,ts:Date.now()})}hookAfterSet(e,t){this.mapTsItemIsVisited.set(e,{key:e,ts:Date.now()});let s=Math.max(this.mapTsItemIsVisited.size-this.maxItem,0);if(s>0){Array.from(this.mapTsItemIsVisited.values()).sort(((e,t)=>t.ts>e.ts?-1:0)).slice(0,s).forEach((e=>t(e.key)))}}hookAfterDelete(e){this.mapTsItemIsVisited.delete(e)}hookAfterClear(){this.mapTsItemIsVisited.clear()}}class Bb{constructor(...e){this.strategies=void 0,this.repository=void 0,this.repositoryDeadItem=void 0,this.markDeadItem=e=>{const t=this.repository.get(e);t&&(t.isAlive=!1,this.repositoryDeadItem.push(e))},this.strategies=e,this.repository=new Map,this.repositoryDeadItem=[]}get(e){this.beforeGet(e);const t=this.repository.get(e);return t&&t.isAlive?t.value:null}set(e,t){const s={isAlive:!0,key:e,value:t};this.repository.set(e,s),this.afterSet(e)}delete(e){this.repository.delete(e),this.afterDelete(e)}reset(){this.repository.clear(),this.afterClear()}beforeGet(e){this.strategies.forEach((t=>t.hookBeforeGet(e,this.markDeadItem))),this.doGC()}afterSet(e){this.strategies.forEach((t=>t.hookAfterSet(e,this.markDeadItem))),this.doGC()}afterDelete(e){this.strategies.forEach((t=>t.hookAfterDelete(e)))}afterClear(){this.strategies.forEach((e=>e.hookAfterClear()))}doGC(){this.repositoryDeadItem.length&&(this.repositoryDeadItem.forEach((e=>this.delete(e))),this.repositoryDeadItem=[])}}var Gb;Object(i.injectable)()(Gb=Object(i.singleton)(Wv.c)(Gb=function(e,t){return Object(i.inject)(ab.a)(e,void 0,0)}(Gb=Reflect.metadata("design:type",Function)(Gb=Reflect.metadata("design:paramtypes",["undefined"==typeof IParserConfigConsumer?Object:IParserConfigConsumer])(Gb=class{constructor(e){this.metaData=void 0,this.thumbLocal=void 0,this.thumbLive=void 0;const t=e.get("max_item_cache"),s=e.get("max_age_cache_preview");this.metaData=new Bb(new kb(t),new Ub(s)),this.thumbLocal=new Bb(new kb(t),new Ub(s)),this.thumbLive=new Bb(new kb(t),new Ub(s))}getKey(e,t){switch(e){case"meta-data":case"thumb-local":{const[e]=t;return hl.a.removeProtocol(e)}case"thumb-live":{const[e,s=""]=t;return[Cb.a.getPrefixConv(s),Cb.a.isE2eeConv(s)?"e2ee":"none-e2ee",hl.a.removeProtocol(e)].join("_")}default:return t.join(".")}}})||Gb)||Gb)||Gb)||Gb);var xb,zb=s("WOja");Object(i.injectable)()(xb=Object(i.singleton)(Wv.b)(xb=function(e,t){return Object(i.inject)(_b.b)(e,void 0,0)}(xb=function(e,t){return Object(i.inject)(Wv.c)(e,void 0,1)}(xb=function(e,t){return Object(i.inject)(Wv.a)(e,void 0,2)}(xb=function(e,t){return Object(i.inject)(ab.a)(e,void 0,3)}(xb=Reflect.metadata("design:type",Function)(xb=Reflect.metadata("design:paramtypes",[void 0===_b.IParserLogger?Object:_b.IParserLogger,"undefined"==typeof ILinkPreviewRepository?Object:ILinkPreviewRepository,"undefined"==typeof ILinkParserFactory?Object:ILinkParserFactory,void 0===zb.IParserConfigConsumer?Object:zb.IParserConfigConsumer])(xb=class{constructor(e,t,s,i){this.repository=t,this.linkParserFactory=s,this.config=i,this.logger=void 0,this.logger=e.linkParser}parse(e){var t;const s=this.repository.getKey("meta-data",[e]);return(null===(t=this.repository.metaData.get(s))||void 0===t?void 0:t.value)||null}async preparseAsync(e,t){await this.parseAsync(e,t)}async parseAsync(e,t){if(!this.config.get("enable_parse_link_client")){const e=(null==t?void 0:t.entry)!==ib.a.SHARE_MESSAGE,s=Cb.a.isE2eeConv((null==t?void 0:t.convId)||"");if(e&&s)return null}const s=this.repository.getKey("meta-data",[e]),i=this.repository.metaData.get(s);if(i&&null!==i.value)return i.promise;const a=new Br.b.Container;this.repository.metaData.set(s,a);const[n,r]=await Br.b.catchAsyncFn((()=>this.linkParserFactory.getLinkParser(e,t).parse(e)));return n&&this.logger.zsymb(18,"zFwE-y",`parse link failed ${n}`),a.resolve(r),a.promise}})||xb)||xb)||xb)||xb)||xb)||xb)||xb);var Vb;Object(i.injectable)()(Vb=Object(i.singleton)(Mb.b)(Vb=function(e,t){return Object(i.inject)(_b.b)(e,void 0,0)}(Vb=function(e,t){return Object(i.inject)(Wv.c)(e,void 0,1)}(Vb=function(e,t){return Object(i.inject)(Mb.a)(e,void 0,2)}(Vb=Reflect.metadata("design:type",Function)(Vb=Reflect.metadata("design:paramtypes",[void 0===_b.IParserLogger?Object:_b.IParserLogger,"undefined"==typeof ILinkPreviewRepository?Object:ILinkPreviewRepository,"undefined"==typeof IPreviewLinkProcessorFactory?Object:IPreviewLinkProcessorFactory])(Vb=class{constructor(e,t,s){this.repository=t,this.linkProcessorFactory=s,this.logger=void 0,this.logger=e.linkParser}async processDownload(e){var t;const s=this.repository.getKey("meta-data",[e]),i=this.repository.getKey("thumb-local",[e]),a=this.repository.thumbLocal.get(i);if(a&&null!==a.value){if(!a.value)return a.promise;{const e=a.value.thumbLocal;if(e){const[t,s]=await Br.b.catchAsyncFn((()=>{var t,s;return null===(t=$znode)||void 0===t||null===(s=t.fsPromise)||void 0===s?void 0:s.stat(e)}));if(!t&&s)return a.promise}}}const n=new Br.b.Container;this.repository.thumbLocal.set(i,n);const r=await(null===(t=this.repository.metaData.get(s))||void 0===t?void 0:t.promise)||null,o=await this.linkProcessorFactory.getDownloadProcessor(null==r?void 0:r.typeParse).process(r);return n.resolve(o),n.promise}async processUpload(e,t){var s;const i=this.repository.getKey("thumb-local",[e]),a=this.repository.getKey("thumb-live",[e,t]),n=this.repository.thumbLive.get(a);if(n&&null!==n.value)return n.promise;const r=new Br.b.Container;this.repository.thumbLive.set(a,r);const o=await(null===(s=this.repository.thumbLocal.get(i))||void 0===s?void 0:s.promise)||null,d=await this.linkProcessorFactory.getUploadProcessor(null==o?void 0:o.typeParse).process(o,t);return r.resolve(d),r.promise}})||Vb)||Vb)||Vb)||Vb)||Vb)||Vb);var Hb=s("6e5J");class $b{constructor(){}async getDimension(e){const t={key:Date.now(),file:e,srcAction:3},[s,i]=await Br.b.catchAsyncFn((()=>Hb.default.getDimension(t)));return rb(s,s&&this.transformError(s)),this.transformResponse(i)}transformError(e){return e}transformResponse(e){return{width:e.width,height:e.height,rotation:e.orientation}}}var Wb=s("8I6r"),qb=s("oSk7"),Kb=s("taJj");class Zb{constructor(){}async download(e){const[t,s]=Is.default.parseE2eeProtocol(e),a=new Headers;if(t){let e="unsafe-flush";i.ModuleContainer.resolve(ab.a).get("enable_download_partial_media_e2ee")&&(a.set("Range",`bytes=0-${hb.sizeInByte("64KB")}`),e="safe-flush");const[n,r]=await Br.b.catchAsyncFn((()=>fetch(s,{headers:a})));rb(n,n);const o=new qb.a(r.body).pipe(new Kb.a(hb.sizeInByte("1MB"))).pipe(new Qb(new Wb.b(t,"decrypt"),e)).getStream();return await new Response(o,{headers:r.headers}).blob()}a.set("Range",`bytes=0-${hb.sizeInByte("64KB")}`);const[n,r]=await Br.b.catchAsyncFn((()=>fetch(e,{headers:a})));return rb(n,n),await r.blob()}}class Qb{constructor(e,t){this.zaes=e,this.modeFlush=t,this.transform=(e,t)=>{const s=this.zaes.update(e);t.enqueue(s)},this.flush=e=>{if("safe-flush"!==this.modeFlush)try{this.zaes.end()}catch(t){e.error(t)}}}}const Jb={"image/gif":R.IMAGE_TYPE_GIF,"image/jpg":R.IMAGE_TYPE_JPEG,"image/jpeg":R.IMAGE_TYPE_JPEG,"image/png":R.IMAGE_TYPE_PNG};class Yb{constructor(){}static getInstance(){return Yb.instance||(Yb.instance=new Yb),Yb.instance}isMatchParser(e){return Object.keys(Jb).includes(e)}async parse(e){const[t,s]=await Br.b.catchAsyncFn((()=>(new Zb).download(e)));rb(t,t);const[i,a]=await Br.b.catchAsyncFn((()=>(new $b).getDimension(s)));return rb(i,i),Object(f.a)(Object(f.a)({},a),{},{type:this.transformType(s)})}transformType(e){return Jb[e.type]}}Yb.instance=null;class Xb{constructor(){}static getInstance(){return Xb.instance||(Xb.instance=new Xb),Xb.instance}isMatchParser(e){return!0}async parse(e){return null}}Xb.instance=null;const ey={"application/pdf":R.LINK_TYPE_PDF};class ty{constructor(){}static getInstance(){return ty.instance||(ty.instance=new ty),ty.instance}isMatchParser(e){return Object.keys(ey).includes(e)}async parse(e){try{const t=Is.default.removeE2eeProtocol(e),s=(await fetch(t,{method:"HEAD"})).headers.get("content-length");return null===s?null:{size:Number(s),name:hl.a.getFileNameFromUrl(e),type:ey["application/pdf"]}}catch(t){throw t}}}var sy;ty.instance=null;Object(i.singleton)(Wv.d)(sy=class{async getSizeParser(e){const[t,s]=await Br.b.catchAsyncFn((()=>this.tryGetContentType(e)));return t||!s?Xb.getInstance():Yb.getInstance().isMatchParser(s)?Yb.getInstance():ty.getInstance().isMatchParser(s)?ty.getInstance():Xb.getInstance()}async tryGetContentType(e){if(!hl.a.isBlobUrl(e)){const[t,s]=await Br.b.catchAsyncFn((()=>this.tryGetContentTypeByHead(e)));if(!t)return s}return this.tryGetContentTypeByGet(e)}async tryGetContentTypeByHead(e){const t=Is.default.removeE2eeProtocol(e);return(await fetch(t,{method:"HEAD"})).headers.get("content-type")}async tryGetContentTypeByGet(e){const t=Is.default.removeE2eeProtocol(e),s=new AbortController,i=await fetch(t,{signal:s.signal});s.abort();return i.headers.get("content-type")}});var iy;Object(i.injectable)()(iy=Object(i.singleton)(Wv.e)(iy=function(e,t){return Object(i.inject)(_b.b)(e,void 0,0)}(iy=function(e,t){return Object(i.inject)(Wv.d)(e,void 0,1)}(iy=Reflect.metadata("design:type",Function)(iy=Reflect.metadata("design:paramtypes",[void 0===_b.IParserLogger?Object:_b.IParserLogger,"undefined"==typeof ISizeParserFactory?Object:ISizeParserFactory])(iy=class{constructor(e,t){this.sizeParserFactory=t,this.cache=void 0,this.cacheDedupe=void 0,this.logger=void 0,this.cache=new Bb(new kb(300)),this.logger=e.mediaSizeLogger,this.cacheDedupe=new Map}parse(e){const t=this.getCacheKey(e);return this.cache.get(t)}async preparseAsync(e){await Br.b.catchAsyncFn((()=>this.parseAsync(e)))}async parseAsync(e){const t=this.getCacheKey(e),s=this.cache.get(t);if(s)return s;const i=this.cacheDedupe.get(t);if(i)return i;const a=(await this.sizeParserFactory.getSizeParser(e)).parse(e);this.cacheDedupe.set(t,a);const[n,r]=await Br.b.catchAsyncFn((()=>a));return this.cacheDedupe.delete(t),rb(null!==n,n),null===r?null:(this.cache.set(t,r),r)}getCacheKey(e){return e}})||iy)||iy)||iy)||iy)||iy);var ay,ny=s("2fgy"),ry=s("dG4g"),oy=s("DBGg"),dy=s("bGlS");Object(Hs.b)(ny.b)(ay=Object(i.injectable)()(ay=Reflect.metadata("design:type",Function)(ay=Reflect.metadata("design:paramtypes",[])(ay=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=void 0,this.name=ny.a,this.key=ny.a,this.data={list:new Map,photoViewData:void 0}}initialize(){}destroy(){}async onChangeMessages(e,t){const s={};e.forEach((e=>{if(Object(ry.b)(e)){let t=di.b.isGroupPhoto(e);"number"==typeof t&&(t=t.toString()),e.msgId&&(s[e.msgId]=t||"")}})),await this.getDataFromCache(s,t)}onChangeReactionDataList(e,t,s){const i=(new Date).getTime(),a=i.toString();Object(Kt.j)(a),e.forEach(((e,n)=>{var r;const o=this.data.list.get(n);if((null===(r=this.data.photoViewData)||void 0===r?void 0:r.rMsgId)===n&&(this.data.photoViewData=Object(f.a)(Object(f.a)({},this.data.photoViewData),e),Object(Kt.f)(a,this.name,dy.a)),!s&&!o)return;const d=Object.keys((null==o?void 0:o.reactions)||{}).length>Object.keys((null==e?void 0:e.reactions)||{}).length,l=!t||Object(oy.a)(e.reactions)||d?0:i,c=Object(f.a)(Object(f.a)(Object(f.a)({},o),e),{},{lastUpdateEffects:l});this.data.list.set(n,c);const h=null==c?void 0:c.groupPhotoMsgId;h?(this.data.list.set(h,{isGroupPhotoMsg:!0,lastUpdate:i,lastUpdateEffects:l}),Object(Kt.f)(a,this.name,h),Object(Kt.f)(a,this.name,n)):Object(Kt.f)(a,this.name,n)})),Object(Kt.c)(a)}getReactedListFromMessage(e,t){if(t){if(!e.msgId||!this.data.photoViewData)return{};const t=new Map;return t.set(e.msgId,this.data.photoViewData),Object(ry.d)(e,t)}return Object(ry.d)(e,this.data.list)}removeReactionDataFromList(e){if(!e.msgId)return;const t=this.data.list.get(e.msgId);null!=t&&t.isGroupPhotoMsg&&this.data.list.forEach(((t,s)=>{t.groupPhotoMsgId===e.msgId&&this.data.list.delete(s)})),this.data.list.delete(e.msgId)}async onChangePhotoViewData(e){if(!e.msgId)return;const t=[e.msgId],s=await rn.b.get(t);s&&(this.data.photoViewData=s[e.msgId],Object(Kt.g)(this.name,dy.a))}removePhotoViewData(){this.data.photoViewData=void 0}async resyncReactionData(){var e;const t={};null!==(e=this.data.photoViewData)&&void 0!==e&&e.rMsgId&&(t[this.data.photoViewData.rMsgId]=""),this.data.list.forEach(((e,s)=>{t[s]=e.groupPhotoMsgId||""})),await this.getDataFromCache(t)}async getDataFromCache(e,t){const s=Object.keys(e),i=await rn.b.get(s);if(!i)return;const a=new Map;for(const n in i)a.set(n,Object(f.a)(Object(f.a)({},i[n]),{},{groupPhotoMsgId:e[n]}));this.onChangeReactionDataList(a,!1,!0),null==t||t(Object.keys(i))}clearData(){this.data.list.clear()}getData(e){return this.data.list.get(e)}getItem(e,t){return e.key===dy.a?this.data.photoViewData:this.data.list.get(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||ay)||ay)||ay);var ly,cy=s("VhZi");function hy(e){return e||dy.b.windowId}Object(Hs.b)(cy.b)(ly=Object(i.injectable)()(ly=Object(i.singleton)()(ly=Reflect.metadata("design:type",Function)(ly=Reflect.metadata("design:paramtypes",[])(ly=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=cy.a,this.key=cy.a}initialize(e){const t=hy(e);Gt.ModalManagerV2.addModal({windowId:t,name:dy.b.name,altWindowId:void 0}),Gt.ModalManagerV2.subscribeTriggers({windowId:t,name:dy.b.name,trigger:e=>{}}),this.data.set(t,{message:void 0})}destroy(e){const t=hy(e);this.data.delete(t),Gt.ModalManagerV2.delModal({windowId:t,name:dy.b.name})}toggleReactionPopup(e,t){const s=hy(e);this.data.set(s,{message:t}),t?Gt.ModalManagerV2.openModal(Object(f.a)(Object(f.a)({},dy.b),{},{windowId:s,params:null})):Gt.ModalManagerV2.closeModal(Object(f.a)(Object(f.a)({},dy.b),{},{windowId:s})),Object(Kt.g)(this.name,s)}getItem(e,t){return this.data.get(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||ly)||ly)||ly)||ly);var uy=s("NmZm"),gy=s("66W5"),my=s("xU41");var py;Object(i.injectable)()(py=Object(i.singleton)()(py=Object(Hs.b)(uy.b)(py=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(py=Reflect.metadata("design:type",Function)(py=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(py=class{constructor(e){this.type=void 0,this.key=gy.c,this.name=uy.a,this._chatBoxInputDOMMap=new Map,this._chatBoxInputStateMap=new Map,this._logger=void 0,this._logger=e.createZLogger(ci.ZLoggerNametags.cbiController,[ci.ZLoggerNametags.controllCbi])}init(){}getItem(e,t){if((s=e.key)&&s.startsWith(gy.c))return this._getChatBoxInputState(e.key);var s}getList(e,t){return[]}onGetItemFailure(e,t){this._logger.zsymb(21,"Fw5q0d",["[onGetItemFailure] key: {}, error: {}","S3GLz7"],e,t.message)}onGetListFailure(e,t){this._logger.zsymb(21,"AZwBPV",["[onGetListFailure] key: {}, error: {}","TmbmKj"],e,t.message)}setChatInputType(e,t,s,i=!0){if(!e||!t)return this._logger.zsymb(21,"3vyYyK",["[setChatInputType] {} or {} isn't valid!","fo_DsY"],e,t);if(!s)return this._logger.zsymb(21,"843gNR",["[setChatInputType] chatInputType isn't existed!","bJi5AX"]);let a=this._getChatBoxInputState(Object(my.a)(e,t));const n=Object(wo.a)(a,(e=>{e.chatInputType=Object(f.a)({},s)}));this._chatBoxInputStateMap.set(Object(my.a)(e,t),n),i&&n!==a&&Object(Kt.g)(this.name,Object(my.a)(e,t))}getChatInputType(e,t){return this._getChatBoxInputState(Object(my.a)(e,t)).chatInputType}getDefaultChatInputType(){return{name:gy.g.NORMAL,info:{}}}getChatInputTypeInfo(e,t){return this._getChatBoxInputState(Object(my.a)(e,t)).chatInputType.info}getChatInputTypeName(e,t){return this._getChatBoxInputState(Object(my.a)(e,t)).chatInputType.name}bindChatInputScroller(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatInputScroller=t,this._chatBoxInputDOMMap.set(e,s)}}bindChatInputContent(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatInputContent=t,this._chatBoxInputDOMMap.set(e,s)}}bindChatBoxInputContainer(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatBoxInputContainer=t,this._chatBoxInputDOMMap.set(e,s)}}getChatInputScroller(e,t){if(e){var s;return null!==(s=this._getChatBoxInputDOM(e).chatInputScroller)&&void 0!==s?s:null==t?void 0:t.document.getElementById(gy.f)}return null}getChatInputContent(e){if(e){return this._getChatBoxInputDOM(e).chatInputContent}return null}getChatBoxInputContainer(e){if(e){return this._getChatBoxInputDOM(e).chatBoxInputContainer}return null}_getChatBoxInputState(e){let t=this._chatBoxInputStateMap.get(e);return t||(t=this._getDefaultChatBoxInputState(),this._chatBoxInputStateMap.set(e,t)),t}_getDefaultChatBoxInputState(){return{chatInputType:this.getDefaultChatInputType()}}_getChatBoxInputDOM(e){let t=this._chatBoxInputDOMMap.get(e);return t||(t=this._getDefaultChatBoxInputDOM(),this._chatBoxInputDOMMap.set(e,t)),t}_getDefaultChatBoxInputDOM(){return{chatBoxInputContainer:null,chatInputScroller:null,chatInputContent:null}}})||py)||py)||py)||py)||py);var fy,vy=s("VO3D");const by=()=>ms.default.chat_box_input.use_new_cbi_2023;Object(i.injectable)()(fy=Object(ke.d)()(fy=Object(i.singleton)(vy.a)(fy=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(fy=Reflect.metadata("design:type",Function)(fy=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(fy=class{constructor(e){this._currentFlag=by(),this._newFlag=by(),this._prevConvId="",this._isFlagChanged=!1,this._flagChangeListeners=[],this._logger=void 0,this._logger=e.createZLogger(ci.ZLoggerNametags.auditCBIFlagCoordinator,[ci.ZLoggerNametags.coordinateAuditCBIFlag]),this._handleUpdateFlag=this._handleUpdateFlag.bind(this)}onApplicationReady(e){this._currentFlag=by(),this._newFlag=by(),this._isFlagChanged=!1,this._logger.zsymb(0,"ns5Cqw","[onApplicationReady] _currentFlag: ",this._currentFlag),ms.$AppConfig.subscribe(this._handleUpdateFlag)}getFlag(){return this._currentFlag}listenConvChange(e){this._logger.zsymb(0,"CDspNo","[listenConvChange] newConvId: ",e),this._prevConvId&&this._prevConvId===e||this._isFlagChanged&&(this._currentFlag=this._newFlag,this._isFlagChanged=!1,this._notifyFlagChanged()),this._prevConvId=e}addFlagChangeListener(e){return"function"!=typeof e||this._flagChangeListeners.includes(e)?()=>{}:(this._flagChangeListeners.push(e),()=>{this._flagChangeListeners=this._flagChangeListeners.filter((t=>t!==e))})}_handleUpdateFlag(e){const{use_new_cbi_2023:t}=this._getFlagConfig(e);this._logger.zsymb(0,"ptKSyi","[_handleUpdateFlag] newFlag: ",t),t!==this._currentFlag?this._isFlagChanged=!0:this._isFlagChanged=!1,this._newFlag!==t&&(this._newFlag=t)}_getFlagConfig(e){return e.chat_box_input||{}}_notifyFlagChanged(){this._flagChangeListeners.forEach(((e,t)=>{"function"==typeof e&&(this._logger.zsymb(0,"Cnobue","[_notifyFlagChanged] _currentFlag: ",this._currentFlag,t),e(this._currentFlag))}))}})||fy)||fy)||fy)||fy)||fy);var yy=s("/ApO"),Iy=s("DIKB"),_y=s("/wiu"),Cy=s("WJhq");function Oy(e,t){var s,i;const a=null!==(s=t.duration)&&void 0!==s?s:0,n=null!==(i=t.easing)&&void 0!==i?i:"ease",r=t.animId;return e.animate([{height:t.fromHeight},{height:t.toHeight}],{id:r,duration:a,fill:t.fill,easing:n})}var Sy=s("gn4y");let Ey=function(e){return e.NORMAL_TO_RTF="normal-to-rtf",e.RTF_TO_NORMAL="rtf-to-normal",e.MINI_TO_EXPAND="mini-to-expand",e.EXPAND_TO_MINI="expand-to-mini",e.RESIZE_WHEN_WINDOW_RESIZE="resize-when-window-resize",e.FADE_IN_RTF_TOOLBAR="fade-in-rtf-toolbar",e.FADE_OUT_RTF_TOOLBAR="fade-out-rtf-toolbar",e}({});var My,Ty=s("dZd7");const wy=new Gh.a(0);Object(i.injectable)()(My=Object(i.singleton)(yy.a)(My=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(My=Reflect.metadata("design:type",Function)(My=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(My=class{constructor(e){this._chatBoxInputAnimsMap=new Map,this._logger=void 0,this._isDevelopment=void 0,this._logger=e.createZLogger(ci.ZLoggerNametags.cbiAnimationController,[ci.ZLoggerNametags.manageCBIAnimation]),this._isDevelopment=!1}applyChatInputType(e,t,s){this._isDevelopment&&this._logger.zsymb(0,"faZQ8n","(@=@)! >>>applyChatInputType<<<");const{windowId:i,convId:a,selfWindow:n,hasAnim:r}=s;if(this._isDevelopment&&this._logger.zsymb(3,"znP9-4",["from: {} to: {}","Y7Ps3O"],JSON.stringify(e),JSON.stringify(t)),_y.e(e,t)){if(_y.d(t))return this.switchNormalModeToRTFMode(i,a,n,r);if(_y.c(t))return this.switchRTFModeToNormalMode(i,a,n,r)}else if(_y.c(e)&&_y.d(t)){if(t.info.mode===gy.h.MINI)return this.switchNormalModeToRTFMode(i,a,n,r);t.info.mode,gy.h.EXPAND}else{if(_y.d(e)&&_y.c(t))return this.switchRTFModeToNormalMode(i,a,n,r);if(_y.d(e)&&_y.d(t)){if(e.info.mode===gy.h.EXPAND&&t.info.mode===gy.h.MINI)return this.switchExpandModeToMiniModeInRTFMode(i,a,n,r);if(e.info.mode===gy.h.MINI&&t.info.mode===gy.h.EXPAND)return this.switchMiniModeToExpandModeInRTFMode(i,a,n,r)}}this._isDevelopment&&this._logger.zsymb(3,"PATTy3",["Do not support this case!","UCjTRM"])}switchNormalModeToRTFMode(e,t,s,i=!0){if(this._isDevelopment&&this._logger.zsymb(0,"ory8SY","(@=@)! >>>switchNormalModeToRTFMode<<<"),!e||!t)return;const a=null!=s?s:Zi.default.getWindow(e);if(!Object(Sy.a)(!!a,"window isn't existed."))return;const n=this._getChatInputContainerEl(a);if(!Object(Sy.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(a);if(!Object(Sy.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=()=>{n.classList.add("--rtf-mode","--rtf-mini-mode"),r.classList.add("--visible"),this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.RTF,info:{mode:gy.h.MINI}})};if(this._cancelAllAnimation(e,!0),!i)return o();const d=n.clientHeight,l=Math.round(2*Cy.c.PADDING_TOP_BOTTOM+5.5*Cy.e+Cy.g+Cy.b);this._isDevelopment&&this._logger.zsymb(3,"auOF8d",["heights: {} {}","9bu2h9"],d,l);let c=this._getTransitionDuration(l,d);if(this._isDevelopment&&this._logger.zsymb(3,"J3tU2k",["duration: {}","OzZ8g7"],c),c>0){const s=this._getChatInputContentEl(a);if(!Object(Sy.a)(!!s,"chatInputContentEl isn't existed."))return;const i=s.clientHeight/Cy.e>=2;i||n.classList.add("--animate-from-smallest-height"),n.classList.add("--rtf-mode");const o=Oy(n,{animId:`${Ey.NORMAL_TO_RTF}::${wy.next()}`,duration:c,easing:"ease",fromHeight:`${d}px`,toHeight:`${l}px`});this._setAnimationById(e,o.id,o),o.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"oObTlP",["finished: {}","KUg9LB"],o.id),i||n.classList.remove("--animate-from-smallest-height"),n.classList.add("--rtf-mini-mode"),o.cancel()},o.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"M2AjlA",["canceled: {}","60_2WU"],o.id),i||n.classList.remove("--animate-from-smallest-height"),n.classList.add("--rtf-mini-mode"),this._deleteAnimationById(e,o.id),this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.RTF,info:{mode:gy.h.MINI}})};const h=function(e,t){var s,i,a;const n=t.animId,r=null!==(s=t.duration)&&void 0!==s?s:0,o=null!==(i=t.delay)&&void 0!==i?i:0;return e.animate([{opacity:0},{opacity:1}],{id:n,duration:r,fill:t.fill,delay:o,easing:null!==(a=t.easing)&&void 0!==a?a:"ease"})}(r,{animId:`${Ey.FADE_IN_RTF_TOOLBAR}::${wy.next()}`,duration:c,easing:"ease"});this._setAnimationById(e,h.id,h),h.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"NsskUX",["finished: {}","KUg9LB"],h.id),r.classList.add("--visible"),h.cancel()},h.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"cxBZcH",["canceled: {}","60_2WU"],h.id),r.classList.add("--visible"),this._deleteAnimationById(e,h.id)},this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.SWITCHING,info:{inputType:gy.g.RTF,from:gy.g.NORMAL,to:gy.g.RTF}})}else o()}switchRTFModeToNormalMode(e,t,s,i=!0){if(this._isDevelopment&&this._logger.zsymb(0,"6GzHbD","(@=@)! >>>switchRTFModeToNormalMode<<<"),!e||!t)return;const a=null!=s?s:Zi.default.getWindow(e);if(!Object(Sy.a)(!!a,"window isn't existed."))return;const n=this._getChatInputContainerEl(a);if(!Object(Sy.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(a);if(!Object(Sy.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=this._getChatBoxInputContainerEl(a);if(!Object(Sy.a)(!!o,"chatBoxInputContainerEl isn't existed."))return;const d=()=>{n.classList.remove("--rtf-mode","--rtf-mini-mode"),r.classList.remove("--visible"),o.style.height="",this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.NORMAL,info:{}})};if(this._cancelAllAnimation(e,!0),!i)return d();const l=this._getChatInputContentEl(a);if(!Object(Sy.a)(!!l,"chatInputContentEl isn't existed."))return;const c=l.clientHeight,h=n.clientHeight,u=c/Cy.e>=2;let g=Cy.c.SMALLEST_HEIGHT_IN_NORMAL,m=!1;u||(n.classList.add("--simple-normal-mode"),m=l.clientHeight/Cy.e>=2,n.classList.remove("--simple-normal-mode")),g=u||m?Math.round((c>Cy.d.NORMAL.MAX?Cy.d.NORMAL.MAX:c)+Cy.g+2*Cy.c.PADDING_TOP_BOTTOM+Cy.b):Cy.c.SMALLEST_HEIGHT_IN_NORMAL,this._isDevelopment&&this._logger.zsymb(3,"mIXwpx",["heights: {} {}","9bu2h9"],h,g);let p=this._getTransitionDuration(g,h);if(this._isDevelopment&&this._logger.zsymb(3,"IJBUgn",["duration: {}","OzZ8g7"],p),p>0){u||m||n.classList.add("--animate-to-smallest-height"),n.classList.add("--switching-rtf-to-normal-mode"),n.classList.remove("--rtf-mode","--rtf-mini-mode"),r.classList.remove("--visible"),o.style.height="";const s=Oy(n,{animId:`${Ey.RTF_TO_NORMAL}::${wy.next()}`,duration:p,easing:"ease",fromHeight:`${h}px`,toHeight:`${g}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"DHGbCH",["finished: {}","KUg9LB"],s.id),n.classList.remove("--switching-rtf-to-normal-mode","--animate-to-smallest-height"),s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"4p3-LV",["canceled: {}","60_2WU"],s.id),n.classList.remove("--switching-rtf-to-normal-mode","--animate-to-smallest-height"),this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.NORMAL,info:{}}),this._deleteAnimationById(e,s.id)};const i=function(e,t){var s,i,a;const n=t.animId,r=null!==(s=t.duration)&&void 0!==s?s:0,o=null!==(i=t.delay)&&void 0!==i?i:0;return e.animate([{opacity:1},{opacity:0}],{id:n,duration:r,fill:t.fill,delay:o,easing:null!==(a=t.easing)&&void 0!==a?a:"ease"})}(r,{animId:`${Ey.FADE_OUT_RTF_TOOLBAR}::${wy.next()}`,duration:Math.max(p-50,0),easing:"ease-in"});this._setAnimationById(e,i.id,i),i.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"52TcRz",["finished: {}","KUg9LB"],i.id),i.cancel()},i.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"fVVF4z",["canceled: {}","60_2WU"],i.id),this._deleteAnimationById(e,i.id)},this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.SWITCHING,info:{inputType:gy.g.NORMAL,from:gy.g.RTF,to:gy.g.NORMAL}})}else d()}switchMiniModeToExpandModeInRTFMode(e,t,s,i=!0){var a,n;if(this._isDevelopment&&this._logger.zsymb(0,"npWudZ","(@=@)! >>>switchMiniModeToExpandModeInRTFMode<<<"),!e||!t)return;const r=null!=s?s:Zi.default.getWindow(e);if(!Object(Sy.a)(!!r,"window isn't existed."))return;const o=this._getChatInputContainerEl(r);if(!Object(Sy.a)(!!o,"chatInputContainerEl isn't existed."))return;const d=this._getRTFToolbarEl(r);if(!Object(Sy.a)(!!d,"rtfToolbarEl isn't existed."))return;const l=this._getChatBoxInputContainerEl(r);if(!Object(Sy.a)(!!l,"chatBoxInputContainerEl isn't existed."))return;let c=l.clientHeight,h=Math.round((null!==(a=null===(n=this._getChatViewEl(r))||void 0===n?void 0:n.clientHeight)&&void 0!==a?a:0)*Cy.a);const u=()=>{o.classList.replace("--rtf-mini-mode","--rtf-expand-mode"),l.style.height=`${h}px`,this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.RTF,info:{mode:gy.h.EXPAND}})};if(this._cancelAllAnimation(e,!0),!i)return u();c>=h&&(h=c),this._isDevelopment&&this._logger.zsymb(3,"TSEiOC",["heights: {} {}","9bu2h9"],c,h);let g=this._getTransitionDuration(h,c);if(this._isDevelopment&&this._logger.zsymb(3,"diMKaT",["duration: {}","OzZ8g7"],g),g>0){this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.SWITCHING,info:{inputType:gy.g.RTF,from:gy.h.MINI,to:gy.h.EXPAND}}),o.classList.replace("--rtf-mini-mode","--rtf-expand-mode");const s=Oy(l,{animId:`${Ey.MINI_TO_EXPAND}::${wy.next()}`,duration:g,fromHeight:`${c}px`,toHeight:`${h}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"bHTJn7",["finished: {}","KUg9LB"],s.id),l.style.height=`${h}px`,s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"-ndjaT",["canceled: {}","60_2WU"],s.id),l.style.height=`${h}px`,this._deleteAnimationById(e,s.id),this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.RTF,info:{mode:gy.h.EXPAND}})}}else u()}switchExpandModeToMiniModeInRTFMode(e,t,s,i=!0){if(this._isDevelopment&&this._logger.zsymb(0,"pXc7mx","(@=@)! >>>switchExpandModeToMiniModeInRTFMode<<<"),!e||!t)return;const a=null!=s?s:Zi.default.getWindow(e);if(!Object(Sy.a)(!!a,"window isn't existed."))return;const n=this._getChatInputContainerEl(a);if(!Object(Sy.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(a);if(!Object(Sy.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=this._getChatBoxInputContainerEl(a);if(!Object(Sy.a)(!!o,"chatBoxInputContainerEl isn't existed."))return;const d=()=>{n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.RTF,info:{mode:gy.h.MINI}})};if(this._cancelAllAnimation(e,!0),!i)return d();const l=o.clientHeight,c=n.clientHeight,h=Math.round(l-c+Cy.d.RTF.MIN+Cy.g+2*Cy.c.PADDING_TOP_BOTTOM+Cy.b);this._isDevelopment&&this._logger.zsymb(3,"jWJN7a",["heights: {} {}","9bu2h9"],l,h);let u=this._getTransitionDuration(h,l);if(this._isDevelopment&&this._logger.zsymb(3,"SuiGct",["duration: {}","OzZ8g7"],u),u>0){this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.SWITCHING,info:{inputType:gy.g.RTF,from:gy.h.EXPAND,to:gy.h.MINI}});const s=Oy(o,{animId:`${Ey.EXPAND_TO_MINI}::${wy.next()}`,duration:u,fromHeight:`${l}px`,toHeight:`${h}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"nYBfSE",["finished: {}","KUg9LB"],s.id),n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"VodJVp",["canceled: {}","60_2WU"],s.id),n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",this._deleteAnimationById(e,s.id),this._chatBoxInputController.setChatInputType(e,t,{name:gy.g.RTF,info:{mode:gy.h.MINI}})}}else d()}resizeChatBoxInputWhenWindowResize(e,t,s=!0){var i,a;if(this._isDevelopment&&this._logger.zsymb(0,"GLTkYY","(@=@)! >>>resizeChatBoxInputWhenWindowResize<<<"),!e)return;const n=null!=t?t:Zi.default.getWindow(e);if(!Object(Sy.a)(!!n,"window isn't existed."))return;const r=this._getChatBoxInputContainerEl(n);if(!Object(Sy.a)(!!r,"chatBoxInputContainerEl isn't existed."))return;const o=r.clientHeight,d=Math.round((null!==(i=null===(a=this._getChatViewEl(n))||void 0===a?void 0:a.clientHeight)&&void 0!==i?i:0)*Cy.a),l=()=>{r.style.height=`${d}px`};if(this._cancelAllAnimation(e,!0),!s)return l();this._isDevelopment&&this._logger.zsymb(3,"OmLT4e",["heights: {} {}","9bu2h9"],o,d);let c=this._getTransitionDuration(d,o);if(this._isDevelopment&&this._logger.zsymb(3,"ii5VzG",["duration: {}","OzZ8g7"],c),c>0){const t=Oy(r,{animId:`${Ey.RESIZE_WHEN_WINDOW_RESIZE}::${wy.next()}`,duration:c,fromHeight:`${o}px`,toHeight:`${d}px`});this._setAnimationById(e,t.id,t),t.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"QbxaR7",["finished: {}","KUg9LB"],t.id),r.style.height=`${d}px`,t.cancel()},t.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"qDVMfr",["canceled: {}","60_2WU"],t.id),r.style.height=`${d}px`,this._deleteAnimationById(e,t.id)}}else l()}get _chatBoxInputController(){return i.ModuleContainer.resolve(Iy.b)}_getChatInputContainerEl(e){return e.document.getElementById(gy.d)}_getRTFToolbarEl(e){return e.document.getElementById(gy.i)}_getChatBoxInputContainerEl(e){return e.document.getElementById(gy.b)}_getChatInputContentEl(e){return e.document.getElementById(gy.f)}_getChatViewEl(e){return e.document.getElementById(Cy.f)}_getTransitionDuration(e=0,t=0){if(!e||e<=0||!t||t<=0)return 0;const s=Object(Ty.a)(),i=Math.abs(e-t);return i<=1?0:Math.round(s*Math.log(i))}_getAnimationById(e,t){const s=this._chatBoxInputAnimsMap.get(e);if(s)return s[t]}_setAnimationById(e,t,s){if(!e||!t||!s)return;let i=this._chatBoxInputAnimsMap.get(e);i||(i={}),i[t]=s,this._chatBoxInputAnimsMap.set(e,i)}_deleteAnimationById(e,t){const s=this._chatBoxInputAnimsMap.get(e);s&&(delete s[t],this._chatBoxInputAnimsMap.set(e,s))}_cancelAnimation(e,t,s=!1){let i=this._chatBoxInputAnimsMap.get(e);if(!i)return;i=Object(f.a)({},i);const a=i[t];a&&(a.cancel(),s&&(delete i[t],this._chatBoxInputAnimsMap.set(e,i)))}_cancelAllAnimation(e,t=!1){const s=this._chatBoxInputAnimsMap.get(e);if(s&&0!==Object.keys(s).length){for(const e in s){var i;if(s[e])null===(i=s[e])||void 0===i||i.cancel(),t&&delete s[e]}this._chatBoxInputAnimsMap.set(e,s)}}})||My)||My)||My)||My);var Ry,Ly=s("CkSj"),Fy=s("uUhV"),Dy=s("I9t9"),Ay=s("XoGZ");Object(i.singleton)(Fy.a)(Ry=Reflect.metadata("design:type",Function)(Ry=Reflect.metadata("design:paramtypes",[])(Ry=class{constructor(){this._chatBoxToolbarButtonsMap=new Map,this._registerChatBoxToolbarButtons()}_registerChatBoxToolbarButtons(){this._chatBoxToolbarButtonsMap.set(Ly.b.SEND_STICKER_ITEM,(e=>vt.a.createElement(Dy.r,e))),this._chatBoxToolbarButtonsMap.set(Ly.b.PICK_PHOTO_ITEM,(e=>vt.a.createElement(Dy.l,e))),this._chatBoxToolbarButtonsMap.set(Ly.b.PICK_FILE_ITEM,(e=>vt.a.createElement(Dy.j,e))),this._chatBoxToolbarButtonsMap.set(Ly.b.SCREEN_CAPTURE_ITEM,(e=>vt.a.createElement(Dy.n,e))),this._chatBoxToolbarButtonsMap.set(Ly.b.SCREEN_CAPTURE_OPTIONS_ITEM,(e=>vt.a.createElement(Dy.p,e))),this._chatBoxToolbarButtonsMap.set(Ly.b.SHARE_CONTACT_ITEM,(e=>vt.a.createElement(Dy.s,e))),this._chatBoxToolbarButtonsMap.set(Ly.b.CREATE_REMINDER_ITEM,(e=>vt.a.createElement(Dy.d,e))),this._chatBoxToolbarButtonsMap.set(Ly.b.CREATE_TODO_ITEM,(e=>vt.a.createElement(Dy.e,e))),this._chatBoxToolbarButtonsMap.set(Ly.b.TOGGLE_RTF_MODE_ITEM,(e=>vt.a.createElement(Dy.u,e))),this._chatBoxToolbarButtonsMap.set(Ly.b.MARK_IMPORTANT_MESSAGE_ITEM,(e=>vt.a.createElement(Dy.g,e))),this._chatBoxToolbarButtonsMap.set(Ly.b.QUICK_MESSAGE_ITEM,(e=>vt.a.createElement(Ay.a,{conversationId:e.convId}))),this._chatBoxToolbarButtonsMap.set(Ly.b.MORE_ITEM,(e=>vt.a.createElement(Dy.h,e)))}getChatBoxToolbarButton(e){return this._chatBoxToolbarButtonsMap.get(e)}})||Ry)||Ry);var jy,Py=s("RPT1"),Ny=s("TsEa"),Uy=s("Y25x"),ky=s("7fvu");Object(Hs.b)(Py.b)(jy=function(e,t){return Object(i.inject)(Me.ZLoggerFactory)(e,void 0,0)}(jy=Reflect.metadata("design:type",Function)(jy=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(jy=class{constructor(e){this.type=void 0,this.key=ky.a,this.name=Py.a,this._chatBoxCommandUIStateMap=new Map,this._isSupportCommandModeMap=new Map,this._logger=void 0,this._logger=e.createZLogger(ci.ZLoggerNametags.cbiCommandController,[ci.ZLoggerNametags.cbiCommandMode])}init(){}getItem(e,t){if(!e.key)return;const s=this._chatBoxCommandUIStateMap.get(e.key);if(s)return s;if(Object(Uy.b)(e.key)){const t=this._initDefaultState();return this._chatBoxCommandUIStateMap.set(e.key,t),t}}getList(e,t){return[]}onGetItemFailure(e,t){this._logger.zsymb(21,"cw1bwO",["[onGetItemFailure] key: {}, error: {}","S3GLz7"],e,t.message)}onGetListFailure(e,t){this._logger.zsymb(21,"bJKhWJ",["[onGetListFailure] key: {}, error: {}","TmbmKj"],e,t.message)}getChatBoxCommandModeOfConv(e){if(!e){const t=`[getChatBoxCommandModeOfConv] ${e} is invalid!`;return this._logger.zsymb(18,"_qdUZn",t),-1}let t=this._chatBoxCommandUIStateMap.get(Object(Uy.a)(e));return t||(t=this._initDefaultState(),this._chatBoxCommandUIStateMap.set(Object(Uy.a)(e),t)),t.currentMode}setNewChatBoxCommandModeOfConv(e,t){if(!t){const e=`[setNewChatBoxCommandModeOfConv] ${t} is invalid!`;return void this._logger.zsymb(18,"Sa9pMr",e)}let s=this._chatBoxCommandUIStateMap.get(Object(Uy.a)(t));s||(s=this._initDefaultState());let i=Object(wo.a)(s,(t=>{t.currentMode=e}));i!==s&&(this._chatBoxCommandUIStateMap.set(Object(Uy.a)(t),i),Object(Kt.g)(this.name,Object(Uy.a)(t)))}resetChatBoxCommandModeToNormalModeOfConv(e){this.setNewChatBoxCommandModeOfConv(Ny.b.NORMAL,e)}getPlaceholderOfMode(e){if(!e||-1===e)return"";const t=Ny.c[e];return t.hasOwnProperty("placeholder")&&t.placeholder?t.placeholder:""}_initDefaultState(){return{currentMode:Ny.b.NORMAL}}})||jy)||jy)||jy);var By=s("u/Xa"),Gy=s("0EGn"),xy=s("ETgL"),zy=s("JprO"),Vy=(s("uP4a"),s("xHgQ")),Hy=s("3/Az");const $y="ROTATE_LEFT",Wy="ROTATE_RIGHT";var qy,Ky,Zy,Qy,Jy,Yy,Xy,eI,tI,sI,iI,aI,nI=s("pr8J");const rI={conversationId:"",showSlider:!0,items:[],selectedId:null,hasOlder:!0,hasNewer:!0,entry:Hy.i.Unknown};qy=Object(i.injectable)(),Ky=Object(Hs.b)(By.b),Zy=Reflect.metadata("design:type",Function),Qy=Reflect.metadata("design:paramtypes",[]),Jy=function(e,t,s){const i=s.value;return s.value=async function(...e){const t=this.onFunctionDone||function(){};try{const s=await i.apply(this,e);return t(),s}catch(s){throw t(),s}},s},Yy=Reflect.metadata("design:type",Function),Xy=Reflect.metadata("design:paramtypes",[void 0===nI.LoadConfig?Object:nI.LoadConfig,String,Boolean]),eI=function(e,t,s){const i=s.value;return s.value=async function(...e){const t=this.onFunctionDone||function(){};try{const s=await i.apply(this,e);return t(),s}catch(s){throw t(),s}},s},tI=Reflect.metadata("design:type",Function),sI=Reflect.metadata("design:paramtypes",[void 0===nI.LoadConfig?Object:nI.LoadConfig]),qy(iI=Ky(iI=Zy(iI=Qy((aI=class{constructor(){this._runningTasks=new Map,this._eventEmitter=new Kd.a,this._abortedTask=new Set,this.dispose=()=>{this._runningTasks.forEach((e=>e.abort())),this._runningTasks.clear(),this._abortedTask.clear(),this._eventEmitter.removeAllListeners(),i.ModuleContainer.resolve(Wd.b).removeActiveWindowContext()},this.toggleSlider=e=>{this.ensureInitState(e);let t=this.data.get(e);t=Object(f.a)(Object(f.a)({},t),{},{showSlider:!t.showSlider}),this.data.set(e,t),this._signalRenderItem(this.name,e)},this.ensureInitState=(e,t=!0)=>{this.data.get(e)||(this.data.set(e,Object(f.a)(Object(f.a)({},rI),{},{conversationId:e})),t||this._signalRenderItem(this.name,e))},this.getSelectedItem=e=>{const t=this.data.get(e);if(!t)return null;const s=t.selectedId;if(!s)return null;return t.items.find((e=>e.msgId===s||(null==e?void 0:e.fakeMsgId)===s))},this.manualDownload=(e,t,s,i)=>{As.a.emitWithKey(js.d.userOnNewDeviceTracking,js.d.mediaDownload);const a=this.getSelectedItem(s);Object(K.a)(!!a,`imageViewer: download item not found for ${s} ${i}`),Vt.default.logActionPhotoViewer(1830904),(null==a?void 0:a.msgType)===R.MSG_VIDEO&&Vt.default.logActionPhotoViewer(1831306);{var n,r;const s="string"==typeof a?a:null!=a&&null!==(n=a.message)&&void 0!==n&&n.href?a.message.href:null==a||null===(r=a.message)||void 0===r?void 0:r.oriUrl;Object(Vy.a)(e,t.document,void 0,void 0,s,!1,{msgType:null==a?void 0:a.msgType,type:null==a?void 0:a.type,subType:null==a?void 0:a.subType})}},this.resetShowSlider=e=>{const t=this.data.get(e);t&&(this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{showSlider:!0})),this._signalRenderItem(this.name,e))},this._signalRenderItem=(...e)=>{Object(Kt.h)(...e)},this._abortRunningTasks=(e,t=(()=>!1))=>{Array.from(this._runningTasks.keys()).filter((s=>s.startsWith(e)&&!t(s))).forEach((e=>{const t=this._runningTasks.get(e);null==t||t.abort(),this._runningTasks.delete(e),this._abortedTask.add(e)}))},this._isValidMessage=e=>(null==e?void 0:e.msgType)!==R.MSG_UNDO,this._filterDuplicatedImages=e=>{let t=new Map;return e.reduce(((e,s)=>{if(!s)return e;if(null==s.cliMsgId||null==s.fromUid){if(s.msgType&&!isNaN(s.msgType)){let t=+s.msgType;if(t<=0||[R.MSG_TODO,R.MSG_TODO_DONE,R.MSG_FRIEND_SENT_REQUEST,R.MSG_SUGGEST_IN_CHAT].includes(t))return e.push(s),e}return e.push(s),e}const i=`${s.cliMsgId}_${s.fromUid}`,a=`[${i}]|[${s.msgId}][${s.sendDttm}|${s.src}]`;if(t.has(i)){const{msg:a}=t.get(i);return a.src===R.MSG_SRC.SYNC_MOBILE_DB&&(s.fakeMsgId=a.msgId,Object.assign(a,s)),e}return t.set(i,{data:a,msg:s}),e.push(s),e}),[])},this._eventBusHandler=(e,t)=>{},this.name=By.a,this.data=new Map,this.key="conversationId",this.init()}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){switch(e){case $y:{const e=null==t?void 0:t.mediaId;Object(K.a)("string"==typeof e,"payload must be an object with mediaId property"),i.ModuleContainer.resolve(Wd.b).rotateMedia(e,-90);break}case Wy:{const e=null==t?void 0:t.mediaId;Object(K.a)("string"==typeof e,"payload must be an object with mediaId property"),i.ModuleContainer.resolve(Wd.b).rotateMedia(e,90);break}default:this._eventEmitter.emit(e,t)}}undoDeleteMulti(e,t){const s=this.data.get(e);if(!s||!t.length)return;const i=[...s.items,...t];let a=this._filterDuplicatedImages(i.sort(((e,t)=>+e.sendDttm-+t.sendDttm)));a=this._filterDeletingMessages(e,a),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{items:a})),this._signalRenderItem(this.name,e)}removeItem(e,t){var s;const i=this.data.get(e);if(!i||!t)return;let a=i.items.findIndex((e=>e.msgId===i.selectedId));const n=i.items.filter((e=>e.msgId!==t.msgId));a=Math.min(a,n.length-1);const r=null===(s=n[a])||void 0===s?void 0:s.msgId;this.data.set(e,Object(f.a)(Object(f.a)({},i),{},{items:n,selectedId:r})),0===n.length&&this.emit("CLOSE_VIEWER",{conversationId:e}),this._signalRenderItem(this.name,e)}removeMulti(e,t){var s;const i=this.data.get(e);if(!i||!t.length)return;let a=i.items.findIndex((e=>e.msgId===i.selectedId));const n=i.items.filter((e=>!t.includes(e.msgId)));a=Math.min(a,n.length-1);const r=null===(s=n[a])||void 0===s?void 0:s.msgId;this.data.set(e,Object(f.a)(Object(f.a)({},i),{},{items:n,selectedId:r})),0===n.length&&this.emit("CLOSE_VIEWER",{conversationId:e}),this._signalRenderItem(this.name,e)}async loadSlider(e){const{conversationId:t}=e;Object(K.a)("string"==typeof t,"conversationId must be provided");try{await this._refreshSliderData(e)}catch(s){}}async loadMore(e,t,s){const{conversationId:i,entry:a,isMessageConv:n}=e;Object(K.a)("string"==typeof i&&i.length>0,`conversationId must be provided. Got ${i}`),Object(K.a)("backward"===t||"forward"===t,`direction must be backward or forward. Got ${t}`);const r=this.data.get(i);if(Object(K.a)(!!r,"imageViewer: load more failed. SliderState must be initialized"),"backward"===t){let t=r.hasOlder||s;if(!t)return;const d=`${i}-${a}-backward`;var o;if(this._abortRunningTasks(i,(e=>e!==d)),this._runningTasks.has(d))return void(await(null===(o=this._runningTasks.get(d))||void 0===o?void 0:o.promise));this.onFunctionDone=()=>{this._runningTasks.delete(d),this._abortedTask.delete(d)};const l=sl(this._loadMore,{conversationId:i,limit:20,message:r.items[0],options:{backward:!0,forward:!1,isMessageConv:n}});this._runningTasks.set(d,l);let c=await l.promise;if(this._abortedTask.has(d))return void this._abortedTask.delete(d);e.isMessageConv&&(c=c.result||c);const h=c;let u=this._filterDuplicatedImages([...h,...r.items]);u=this._filterDeletingMessages(i,u),t=h.length>0,this.data.set(i,Object(f.a)(Object(f.a)({},r),{},{items:u,hasOlder:t})),this._signalRenderItem(this.name,i)}else{let t=r.hasNewer||s;if(!t)return;const o=`${i}-${a}-forward`;var d;if(this._abortRunningTasks(i,(e=>e!==o)),this._runningTasks.has(o))return void(await(null===(d=this._runningTasks.get(o))||void 0===d?void 0:d.promise));this.onFunctionDone=()=>{this._runningTasks.delete(o)};const l=sl(this._loadMore,{conversationId:i,limit:20,message:r.items[r.items.length-1],options:{backward:!1,forward:!0,isMessageConv:n}});this._runningTasks.set(o,l);let c=await l.promise;if(this._abortedTask.has(o))return void this._abortedTask.delete(o);e.isMessageConv&&(c=c.result||c);const h=c;let u=this._filterDuplicatedImages([...r.items,...h]);u=this._filterDeletingMessages(i,u),t=h.length>0,this.data.set(i,Object(f.a)(Object(f.a)({},r),{},{items:u,hasNewer:t})),this._signalRenderItem(this.name,i)}}selectPreviousItem(e){const t=this.data.get(e);Object(K.a)(!!t,"imageViewer: select previous item failed. SliderState must be initialized");const s=t.items.findIndex((e=>e.msgId===t.selectedId||(null==e?void 0:e.fakeMsgId)===t.selectedId));if(0===s||!t.items.length)return;const i=t.items[s-1],a=i.msgId;i.cliMsgId,i.fromUid;this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedId:a})),this._signalRenderItem(this.name,e)}selectNextItem(e){const t=this.data.get(e);Object(K.a)(!!t,"imageViewer: select next item failed. SliderState must be initialized");const s=t.items.findIndex((e=>e.msgId===t.selectedId||(null==e?void 0:e.fakeMsgId)===t.selectedId));if(s===t.items.length-1||!t.items.length)return;const i=t.items[s+1],a=i.msgId;i.cliMsgId,i.fromUid;this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedId:a})),this._signalRenderItem(this.name,e)}selectItem(e,t){const s=this.data.get(e);Object(K.a)(!!s,"imageViewer: select item failed. SliderState must be initialized"),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{selectedId:t})),this._signalRenderItem(this.name,e)}reset(e){Array.from(this._runningTasks.keys()).filter((t=>t.startsWith(e))).forEach((e=>{const t=this._runningTasks.get(e);null==t||t.abort(),this._runningTasks.delete(e)})),this._abortedTask.clear(),this.data.has(e)&&this.data.delete(e)}_secureSliderState(e){var t;let{conversationId:s,selectedId:i,defaultItems:a,entry:n}=e,r=this.data.get(e.conversationId);const o=null===(t=r)||void 0===t?void 0:t.items.some((e=>e.msgId===i||e.fakeMsgId===i));let d=!0;if(e.disableLoadMore)return n===Hy.i.Profile&&(a=a.slice().reverse()),r=Object(f.a)(Object(f.a)({},rI),{},{conversationId:s,items:a,selectedId:i,showSlider:!0,hasOlder:!1,hasNewer:!1,entry:e.entry}),this.data.set(e.conversationId,r),this._signalRenderItem(this.name,s),d;const l=this._filterDeletingMessages(s,a);return r&&o?i!==r.selectedId&&(r=Object(f.a)(Object(f.a)({},r),{},{selectedId:i,entry:e.entry}),d=!1):(r=Object(f.a)(Object(f.a)({},rI),{},{conversationId:s,items:l,selectedId:i,showSlider:!0,hasOlder:!0,hasNewer:!0,entry:e.entry}),d=!1),d||(this.data.set(e.conversationId,r),this._signalRenderItem(this.name,s)),d}async _refreshSliderData(e){const{conversationId:t,selectedId:s,isMessageConv:i,entry:a,defaultItems:n}=e;let r=this._secureSliderState(e);if(e.disableLoadMore)return;let o=this.data.get(e.conversationId);const d=o.items.findIndex((e=>e.msgId===s||e.fakeMsgId===s)),l=o.items[d],c=`${t}-${a}-${s}`;this._abortRunningTasks(t);let h=o.hasOlder,u=o.hasNewer;const g=d<10&&h,m=d>=o.items.length-10&&u;if(!g&&!m)return void(r||this._signalRenderItem(this.name,t));this.onFunctionDone=()=>{this._runningTasks.delete(c),this._abortedTask.delete(c)};const p=async t=>{const s=sl(this._loadMore,t);this._runningTasks.set(c,s);let i=await s.promise;if(e.isMessageConv&&(i=i.result||i),!this._abortedTask.has(c))return i;this._abortedTask.delete(c)};if(g){const e={conversationId:t,limit:10,message:l,options:{backward:!0,forward:!1,isMessageConv:i}},a=await p(e),n=this.data.get(t),o=n.items;let d=this._filterDuplicatedImages([...a,...o]);d=this._filterDeletingMessages(t,d),0==a.length&&(h=!1),this.data.set(t,Object(f.a)(Object(f.a)({},n),{},{selectedId:s,items:d,hasOlder:h,hasNewer:u})),r=!1}if(m){const e={conversationId:t,limit:10,message:l,options:{backward:!1,forward:!0,isMessageConv:i}},a=await p(e),n=this.data.get(t),o=n.items;let d=this._filterDuplicatedImages([...o,...a]);d=this._filterDeletingMessages(t,d),0==a.length&&(u=!1),this.data.set(t,Object(f.a)(Object(f.a)({},n),{},{selectedId:s,items:d,hasOlder:h,hasNewer:u})),r=!1}r||this._signalRenderItem(this.name,t)}async _loadMore(e){const{conversationId:t,message:s,limit:a,options:{forward:n=!0,backward:r=!1,filter:o=null,isMessageConv:d=!1}={}}=e,l=s.msgId;if(!1===d){let e;try{e=await i.ModuleContainer.resolve(Gy.a).getImageMessagesForPhotoViewer(t,l,a,n,r,o)}catch(c){}const s=xy.b.getOneBannedGroup(t);return s&&(e=xy.b.filterBannedMediaGroup(s.groupId,e)),e}return await mt.default.getImagesForPhotoViewerFromMessage(s.toUid||t,s.sendDttm,l,a,n,r)}_filterDeletingMessages(e,t){return t.filter((t=>!Nr.d.isDeleteMessage(e,t)&&this._isValidMessage(t)&&!Is.default.ZSafeFunction((()=>Is.default.isPhotoStickerMessage(t)),!1)))}listenEvents(){Cs.default.subscribe(this._eventBusHandler)}init(){this.listenEvents()}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}},Object(qv.a)(aI.prototype,"loadMore",[Jy,Yy,Xy],Object.getOwnPropertyDescriptor(aI.prototype,"loadMore"),aI.prototype),Object(qv.a)(aI.prototype,"_refreshSliderData",[eI,tI,sI],Object.getOwnPropertyDescriptor(aI.prototype,"_refreshSliderData"),aI.prototype),iI=aI))||iI)||iI)||iI);var oI=s("DRxf"),dI=s("ftrm"),lI=s("pDj3");const cI="zcloud-status-service",hI=Object(i.define)(cI),uI="zcloud-key-service",gI=Object(i.define)(uI),mI="zcloud-plan-service-key",pI=Object(i.define)(mI);var fI=s("2T8k"),vI=s("nTk7"),bI=s("/1VS");const yI=Object(i.define)("zcloud-status-manager");let II=function(e){return e[e.ADD_CLOUDS=0]="ADD_CLOUDS",e[e.REMOVE_CLOUDS=1]="REMOVE_CLOUDS",e[e.ADD_TEMP_CLOUDS=2]="ADD_TEMP_CLOUDS",e[e.REMOVE_THREAD=3]="REMOVE_THREAD",e}({});class _I extends vI.a{constructor(e){super(),this.numberOfRunningTasks=void 0,this.queue=void 0,this.queue=e,this.numberOfRunningTasks=0}get cloudDataManager(){return bI.a.getInstance()}get controller(){return i.ModuleContainer.resolve(ep.c)}get openedConvs(){const e=Zi.default.getAllCurrentOpens();if(!e||0===e.length)return[];let t=e.map((e=>e===Qs.c?i.ModuleContainer.resolve($s.SidebarController).getCurrMainConvId():Zi.default.getConvIdFromWindowId(e)));return t=t.filter((e=>!!e)),t}get inInCloudOrZCloudView(){return[pf.b.MEDIA_TYPE,pf.b.CONVERSATION,pf.b.MY_CLOUD].includes(i.ModuleContainer.resolve(af.b).getCurrentView())}calculateFromAddClouds(e){if(this.inInCloudOrZCloudView||(e=ep.d.filterCloudItemsStatus(this.openedConvs,e)),!e.length)return null;const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const i of e)if(i){const e=s,a=ep.d.transferCloudItemRes(!0,i,e),n=Object(ep.q)(i);n&&a&&(t[n]={personalCloud:a})}return t}calculateFromRemoveZCloudKeys(e){const t={};for(const s of e)if(s){s&&(t[s]={personalCloud:void 0})}return t}calculateFromTempClouds(e){if(this.inInCloudOrZCloudView||(e=ep.d.filterCloudItemsStatus(this.openedConvs,e)),!e.length)return null;const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const i of e)if(i){const e=i.msgInfo.isE2EE?null:s,a=ep.d.transferCloudItemRes(!1,i,e),n=Object(ep.q)(i);n&&a&&(t[n]={personalCloud:a})}return t}async run(){for(;this.queue.length>0&&this.numberOfRunningTasks<1;){const e=this.queue.shift();if(!e)break;this.numberOfRunningTasks++;const{data:t,resolve:s,reject:i}=e,{clouds:a=[],removeZCloudKeys:n=[],pCloudUpdate:r,updateSource:o}=t;let d=null;switch(o){case II.ADD_CLOUDS:d=this.calculateFromAddClouds(a);break;case II.ADD_TEMP_CLOUDS:d=this.calculateFromTempClouds(a);break;case II.REMOVE_CLOUDS:d=this.calculateFromRemoveZCloudKeys(n)}d&&this.controller.onZCloudStatus(d),r&&this.controller.onZCloudStatus(r),s(),await new Promise((e=>setTimeout(e,100))),this.numberOfRunningTasks--,this.run()}}}const CI=[],OI=new vI.b(CI),SI=new _I(CI),EI=new class{constructor(e,t){this.provider=void 0,this.consumer=void 0,this.provider=e,this.consumer=t}splitIntoBatches(e,t){const s=[];for(let i=0;i<e.length;i+=t)s.push(e.slice(i,i+t));return s}async calculateStatus(e){const{clouds:t=[],removeZCloudKeys:s=[],pCloudUpdate:i,updateSource:a}=e,n=new Promise(((e,n)=>{const r={data:{clouds:t,removeZCloudKeys:s,pCloudUpdate:i,updateSource:a},resolve:e,reject:n};this.provider.send(r),this.consumer.run()}));return n.catch((()=>{})).finally((()=>{})),n}async syncStatus(e,t=!1){if(t)this.calculateStatus({pCloudUpdate:e});else for(const s in e){const t={};t[s]=e[s],this.calculateStatus({pCloudUpdate:t})}}}(OI,SI);i.ModuleContainer.registerValue(yI,EI);var MI,TI=EI;let wI=Object(ke.d)()(MI=Object(i.injectable)()(MI=function(e,t){return Object(i.inject)(lI.a)(e,void 0,0)}(MI=function(e,t){return Object(i.inject)(hI)(e,void 0,1)}(MI=function(e,t){return Object(i.inject)(gI)(e,void 0,2)}(MI=function(e,t){return Object(i.inject)(pI)(e,void 0,3)}(MI=Reflect.metadata("design:type",Function)(MI=Reflect.metadata("design:paramtypes",[void 0===lI.a?Object:lI.a,void 0===hI?Object:hI,void 0===gI?Object:gI,void 0===pI?Object:pI])(MI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.zCloud,[ci.ZLoggerNametags.zCloudStatusController])),this._Logger}constructor(e,t,s,i){this.metrics=e,this.statusService=t,this.keyService=s,this.planService=i,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=oI.a,this.key=oI.a}onApplicationReady(){}onBizConfigReady(){if(!Object(dI.a)().isEnableUserPCloud())return this.Logger.zsymb(3,"5fzag4",["requestRSAKey but no permission!","81HMrc"]),void this.keyService.removeRSAKey();this.metrics.setGetKeyAfterLoginTime(),this.keyService.requestRSAKey(wf.c.LOGIN)}async calculateZCloudStatusByMessages(e,t){if(!dI.b.shouldLoadInitStatus(t))return;let s=dI.b.filterValidMsgs(e);if(s=dI.b.normalizedMsgs(s),!s||!s.length)return;const i=await this.statusService.getStatusByMessages(s,t);TI.syncStatus(i,!0)}async calculateZCloudStatusByCloudItems(e){const t=await this.statusService.getStatusByCloudItems(e);TI.syncStatus(t,!0)}debug(e,t){Object(dI.a)().isEnableShowToastDebug()&&dI.c.showToastPCloudDebug(e,t)}getErrorPCloudHandler(e,t){const{error:s,msgIds:i,windowId:a,showNoti:n,type:r}=e;return s&&null!=s&&s.hasNoKey&&Object(dI.a)().isEnableTriggerTransferKey()?()=>this.onInteractMediaWithoutKey({msgIds:i,windowId:a,showNoti:n,type:r},t):()=>{}}checkPCloudWithoutKey(e){return this.keyService.checkPCloudWithoutKey(e)}onZCloudStatus(e){if(Object(fI.e)(e))return;this.debug({},e);const t=Object.keys(e);this.statusService.syncCachePCloudInfo(e),this.statusService.signalUIPCloudInfo(e),this.statusService.syncMediaStatus(t),this.statusService.shareUpdatePCloudAction(e)}onHandleHaveKey(){const e=this.keyService.createPCloudUpdateWithValidRSAKey();this.keyService.shareHaveKeyPCloudAction(e),TI.syncStatus(e,!0)}async onInteractMediaWithoutKey(e,t){if(!Object(dI.a)().isEnableTriggerTransferKey())return;if(this.keyService.showToastWarningNoKey(e),!Object(dI.a)().isEnableUserPCloud())return void this.Logger.zsymb(3,"Izqhh_",["requestRSAKey but no permission!","81HMrc"]);const s=t||wf.c.RETRY;s===wf.c.INVIEW?this.metrics.setGetKeyAfterInviewTime():s===wf.c.RETRY&&this.metrics.setGetKeyAfterRetryTime(),this.keyService.requestRSAKey(s)}onZCloudFreePlan(){const e=this.statusService.createEmptyPCloudUpdate();this.keyService.removeRSAKey(),TI.syncStatus(e,!0),this.planService.shareOffPlanEvent()}onUpgradeZCloudPlan(){this.metrics.setGetKeyAfterChangePlanTime(),this.keyService.requestRSAKey(wf.c.CHANGE_PLAN),this.planService.shareUpgradePlanEvent()}onGracePeriodPlan(){this.planService.shareGracePeriodPlanEvent()}onRemoveThreads(e){for(const t of e){const e=this.statusService.createEmptyGroupPCloudUpdate(t);TI.syncStatus(e)}}})||MI)||MI)||MI)||MI)||MI)||MI)||MI)||MI;var RI,LI=s("0VmO");const FI={valid:!1,status:{isClouded:!0,isUncloud:!1},error:{hasNoKey:!0}},DI={valid:!1,status:{isClouded:!1,isUncloud:!0},error:null},AI={valid:!0,status:{isClouded:!0,isUncloud:!1},error:null};let jI=Object(ke.d)()(RI=Object(i.injectable)()(RI=function(e,t){return Object(i.inject)(LI.a)(e,void 0,0)}(RI=Reflect.metadata("design:type",Function)(RI=Reflect.metadata("design:paramtypes",[void 0===LI.a?Object:LI.a])(RI=class extends je.b{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.zCloud,[ci.ZLoggerNametags.zCloudStatusEventsResolver])),this._Logger}get controller(){return i.ModuleContainer.resolve(oI.b)}get cloudDataManager(){return bI.a.getInstance()}constructor(e){super(),this.zaloCloudConfig=e,this.name=void 0,this.key=void 0,this.msgs=void 0,this.convId=void 0,this._Logger=void 0,this.name=Sf.a,this.key=Sf.a,this.msgs=[],this.convId=null}onApplicationReady(){(Object(df.e)()||Object(dI.a)().isEnableBizPCloud())&&(this.addDataCloudListeners(),Object(dI.a)().isEnableDebugTool()&&this.addTestListeners())}addTestListeners(){this.addEventListener(wf.g.INIT_DATA,this.handleTestCloudEvents.bind(this)),this.addEventListener(wf.g.NO_KEY,this.handleTestCloudEvents.bind(this)),this.addEventListener(wf.g.HAVE_KEY,this.handleTestCloudEvents.bind(this)),this.addEventListener(wf.g.NOT_YET_CLOUDED,this.handleTestCloudEvents.bind(this))}addDataCloudListeners(){this.cloudDataManager.addListener(nf.e.ADD_CLOUD_ITEMS,this.handleAddedCloudItems.bind(this)),this.cloudDataManager.addListener(nf.e.UPDATE_CLOUD_ITEMS,this.handleUpdatedCloudItems.bind(this)),this.cloudDataManager.addListener(nf.e.TEMP_CLOUD_ITEMS,this.handleTempCloudItems.bind(this)),this.cloudDataManager.addListener(nf.e.REMOVE_CLOUD_ITEMS,this.handleCloudRemoveItems.bind(this)),this.cloudDataManager.addListener(nf.e.UPDATE_CLOUD_KEY_STATUS,this.handleHaveCloudKey.bind(this)),this.cloudDataManager.addListener(nf.e.REMOVE_THREAD_CLOUD,this.handleCloudRemoveThread.bind(this))}async handleTestCloudEvents(e){const t={};switch(e.type){case wf.g.INIT_DATA:for(const s of e.payload){t[Object(fI.i)(s)]={personalCloud:Object(f.a)({},AI)}}this.controller.onZCloudStatus(t);break;case wf.g.NO_KEY:for(const s of e.payload){t[Object(fI.i)(s)]={personalCloud:Object(f.a)({},FI)}}this.controller.onZCloudStatus(t);break;case wf.g.HAVE_KEY:this.controller.onHandleHaveKey();break;case wf.g.NOT_YET_CLOUDED:for(const s of e.payload){t[Object(fI.i)(s)]={personalCloud:Object(f.a)({},DI)}}this.controller.onZCloudStatus(t)}}handleAddedCloudItems(e){const t=TI.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)TI.calculateStatus({clouds:t[s],updateSource:II.ADD_CLOUDS})}handleUpdatedCloudItems(e){}handleTempCloudItems(e){const t=TI.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)TI.calculateStatus({clouds:t[s],updateSource:II.ADD_TEMP_CLOUDS})}handleCloudRemoveItems(e){const t=TI.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)TI.calculateStatus({removeZCloudKeys:t[s],updateSource:II.REMOVE_CLOUDS})}handleCloudRemoveThread(e){this.controller.onRemoveThreads(e)}handleHaveCloudKey(e){e&&(this.Logger.zsymb(3,"g60QCT",["handleHaveCloudKey","9lbvDS"]),this.controller.onHandleHaveKey())}bindMsg(e,t){Object(dI.a)().isEnableDebugTool()&&(this.msgs=e,this.convId=t)}forceInitData(e){(e=e||this.msgs)&&0!==e.length&&this.convId&&this.dispatchEvent(new wf.b(wf.g.INIT_DATA,e))}forceOffPCloud(e){this.zaloCloudConfig.onUpdateUsage({plan:-1})}forceUpgrade(){this.dispatchEvent(new wf.b(wf.g.UPGRADE_ZCLOUD_PLAN,{})),this.dispatchEvent(new wf.b(wf.g.HAVE_KEY,{})),this.zaloCloudConfig.onUpdateUsage({plan:0})}forceGracePeriod(){this.dispatchEvent(new wf.b(wf.g.GRACE_PERIOD_ZCLOUD_PLAN,{})),this.zaloCloudConfig.onUpdateUsage({plan:100})}forceNoKey(e){if(!(e=e||this.msgs)||0===e.length||!this.convId)return;Object(dI.a)().isSend2Me(this.convId)||this.dispatchEvent(new wf.b(wf.g.NO_KEY,e))}forceHaveKey(e){if(!(e=e||this.msgs)||0===e.length||!this.convId)return;Object(dI.a)().isSend2Me(this.convId)||this.dispatchEvent(new wf.b(wf.g.HAVE_KEY,e))}forceNotYetClouded(e){(e=e||this.msgs)&&0!==e.length&&this.convId&&this.dispatchEvent(new wf.b(wf.g.NOT_YET_CLOUDED,e))}})||RI)||RI)||RI)||RI)||RI;var PI,NI=s("3+fW");let UI=Object(Hs.b)(NI.a)(PI=Object(i.injectable)()(PI=function(e,t){return Object(i.inject)(lI.a)(e,void 0,0)}(PI=Reflect.metadata("design:type",Function)(PI=Reflect.metadata("design:paramtypes",[void 0===lI.a?Object:lI.a])(PI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.zCloud,[ci.ZLoggerNametags.zCloudStatusController])),this._Logger}constructor(e){this.name=void 0,this.type=void 0,this.key=void 0,this.data=new Map,this.metrics=void 0,this._Logger=void 0,this.name=NI.b,this.key=NI.b,this.metrics=e}_getState(e){return this.data.get(e)}setPCloudInfo(e,t){e?this.data.set(t,e):this.data.delete(t)}signalUIPCloudInfo(e){Object(Kt.g)(this.name,e)}getListPCloudInfo(){return this.data.entries()}getPCloudBizState(e){var t,s,i;let a;a="string"==typeof e?e:Object(fI.i)(e);const n=this.data.get(a);return n&&n.status?{valid:n.valid,hasNoKey:(null===(t=n.error)||void 0===t?void 0:t.hasNoKey)||!1,isClouded:null===(s=n.status)||void 0===s?void 0:s.isClouded,isUncloud:null===(i=n.status)||void 0===i?void 0:i.isUncloud,error:n.error,isFreeCloudItem:n.isFreeCloudItem}:null}getPCloudInfo(e){let t;return t="string"==typeof e?e:Object(fI.i)(e),this._getState(t)}getItem(e){return this._getState(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||PI)||PI)||PI)||PI)||PI;const kI="zcloud-repository",BI=Object(i.define)(kI);var GI;let xI=Object(i.injectable)()(GI=Reflect.metadata("design:type",Function)(GI=Reflect.metadata("design:paramtypes",[])(GI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.zCloud,[ci.ZLoggerNametags.zCloudStatusRepository])),this._Logger}constructor(){this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=kI,this.key=kI}get cloudDataManager(){return bI.a.getInstance()}getZCloudList(e,t){return 0===t.length?Promise.resolve({cloudedItems:[],tempCloudItems:[]}):new Promise((e=>{this.cloudDataManager.getCloudItems(t).then((s=>{let i=[];for(const e of s)e&&i.push(e);const a=i,n=a.map((e=>Object(fI.j)(e))),r=t.filter((e=>!n.includes(Object(fI.i)(e))));e({cloudedItems:a,tempCloudItems:r})})).catch((t=>{this.Logger.zsymb(3,"bD2l10",["getZCloudList, err:","vkecC6"],t),e({cloudedItems:[],tempCloudItems:[]})}))}))}})||GI)||GI)||GI;var zI;let VI=Object(i.injectable)()(zI=function(e,t){return Object(i.inject)(lI.a)(e,void 0,0)}(zI=function(e,t){return Object(i.inject)(NI.a)(e,void 0,1)}(zI=function(e,t){return Object(i.inject)(Sf.b)(e,void 0,2)}(zI=function(e,t){return Object(i.inject)(BI)(e,void 0,3)}(zI=Reflect.metadata("design:type",Function)(zI=Reflect.metadata("design:paramtypes",[void 0===lI.a?Object:lI.a,void 0===NI.a?Object:NI.a,void 0===Sf.b?Object:Sf.b,void 0===BI?Object:BI])(zI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.zCloud,[ci.ZLoggerNametags.zCloudStatusServices])),this._Logger}get cloudDataManager(){return bI.a.getInstance()}constructor(e,t,s,i){this.name=void 0,this.key=void 0,this.metrics=void 0,this.zCloudInfo=void 0,this.eventsResolver=void 0,this.zCloudStatusRepository=void 0,this._Logger=void 0,this.name=cI,this.key=cI,this.metrics=e,this.zCloudInfo=t,this.eventsResolver=s,this.zCloudStatusRepository=i}async getStatusByMessages(e,t){const s={},{cloudedItems:i,tempCloudItems:a}=await this.zCloudStatusRepository.getZCloudList(t,e),n=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const r of i){const e=r.msgInfo.isE2EE?null:n,t=Object(fI.j)(r);if(!this.zCloudInfo.getPCloudInfo(t)&&t){const i=dI.b.transferCloudItemRes(!0,r,e);i&&(s[t]={personalCloud:i})}}for(const r of a){const e=Ha.b.isMsgE2ee(r)?null:n,t=Object(fI.i)(r);if(!this.zCloudInfo.getPCloudInfo(t)&&t){const i=dI.b.transferCloudItemRes(!1,r,e);i&&(s[t]={personalCloud:i})}}return Promise.resolve(s)}getStatusByCloudItems(e){const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const i of e){const e=i.msgInfo.isE2EE?null:s,a=Object(fI.j)(i);if(!this.zCloudInfo.getPCloudInfo(a)&&a){const s=dI.b.transferCloudItemRes(!0,i,e);s&&(t[a]={personalCloud:s})}}return Promise.resolve(t)}syncCachePCloudInfo(e){for(const t in e){const s=e[t].personalCloud;this.zCloudInfo.setPCloudInfo(s,t)}}signalUIPCloudInfo(e){for(const t in e)this.zCloudInfo.signalUIPCloudInfo(t)}syncMediaStatus(e){if(!i.ModuleContainer.resolve(Yi.b).getConvId())return void this.Logger.zsymb(3,"j5m9Qe",["syncMediaStatus: MediaStatus Calculator is not initilized to synup","04ac-f"]);const t=this.zCloudInfo.getListPCloudInfo();for(let[s,i]of t){if(!s||!e.includes(s))continue;const t=Object(fI.f)(s);t&&tp.a.status(t,[],!0).then((()=>{})).catch((()=>{}))}}shareUpdatePCloudAction(e){this.eventsResolver.dispatchEvent(new wf.b(wf.a.UPDATE_STATUS,e))}createEmptyPCloudUpdate(){const e={},t=this.zCloudInfo.getListPCloudInfo();for(let[s,i]of t)s&&i&&(i.isFreeCloudItem||(e[s]={personalCloud:void 0}));return e}createEmptyGroupPCloudUpdate(e){const t={},s=this.zCloudInfo.getListPCloudInfo();for(let[i,a]of s)i&&a&&i.includes(e)&&(t[i]={personalCloud:void 0});return t}})||zI)||zI)||zI)||zI)||zI)||zI)||zI;var HI;let $I=Object(i.injectable)()(HI=function(e,t){return Object(i.inject)(lI.a)(e,void 0,0)}(HI=function(e,t){return Object(i.inject)(NI.a)(e,void 0,1)}(HI=function(e,t){return Object(i.inject)(Sf.b)(e,void 0,2)}(HI=Reflect.metadata("design:type",Function)(HI=Reflect.metadata("design:paramtypes",[void 0===lI.a?Object:lI.a,void 0===NI.a?Object:NI.a,void 0===Sf.b?Object:Sf.b])(HI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.zCloud,[ci.ZLoggerNametags.zCloudKeyServices])),this._Logger}get cloudDataManager(){return bI.a.getInstance()}constructor(e,t,s){this.metrics=e,this.zCloudInfo=t,this.eventsResolver=s,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=uI,this.key=uI}removeRSAKey(){this.cloudDataManager.checkUpgraded()&&this.cloudDataManager.removeKey()}requestRSAKey(e){this.cloudDataManager.checkUpgraded()||(e!==wf.c.LOGIN&&e!==wf.c.CHANGE_PLAN||(this.cloudDataManager.updateZCloudKey(!1,e),this.metrics.onAutoRequestKey()),e===wf.c.RETRY&&(this.cloudDataManager.updateZCloudKey(!0,e),this.metrics.onManualRequestKey()))}checkPCloudWithoutKey(e){var t;const s=this.zCloudInfo.getPCloudInfo(e);return Boolean(null==s||null===(t=s.error)||void 0===t?void 0:t.hasNoKey)}createPCloudUpdateWithValidRSAKey(){const e={},t=this.zCloudInfo.getListPCloudInfo();for(let[s,i]of t){if(!s||!i)continue;if(i.isFreeCloudItem)continue;const t=Object(f.a)(Object(f.a)({},i.error),{},{hasNoKey:!1}),a=i.status,n={valid:dI.b.checkValidFromBizState(t,a),status:a,error:t};e[s]={personalCloud:n}}return e}shareHaveKeyPCloudAction(e){this.eventsResolver.dispatchEvent(new wf.b(wf.a.HAVE_KEY,e))}showToastWarningNoKey(e){const{showNoti:t=!0,windowId:s=Qs.c,type:i="file"}=e,a=Wu.ZToastManagerHolder.getZToastManagerByWindowId(s);t&&a.show({noBackground:!0,textKey:"STR_PERSONAL_CLOUD_NO_KEY_TOAST",textArguments:[Object(dI.d)(i),"\n"],type:Wu.TOAST_TYPE.INFO,duration:3e3,styles:{width:"400px"},styleText:{whiteSpace:"pre-line"}})}})||HI)||HI)||HI)||HI)||HI)||HI;var WI;let qI=Object(i.injectable)()(WI=function(e,t){return Object(i.inject)(Sf.b)(e,void 0,0)}(WI=Reflect.metadata("design:type",Function)(WI=Reflect.metadata("design:paramtypes",[void 0===Sf.b?Object:Sf.b])(WI=class{constructor(e){this.eventsResolver=e,this.name=void 0,this.key=void 0,this.name=mI,this.key=mI}shareUpgradePlanEvent(e){this.eventsResolver.dispatchEvent(new wf.b(wf.a.UPGRADE_ZCLOUD_PLAN,e||{}))}shareOffPlanEvent(e){this.eventsResolver.dispatchEvent(new wf.b(wf.a.OFF_PERSONAL_CLOUD_PLAN,e||{}))}shareGracePeriodPlanEvent(e){this.eventsResolver.dispatchEvent(new wf.b(wf.a.GRACE_PERIOD_ZCLOUD_PLAN,e||{}))}})||WI)||WI)||WI)||WI;var KI=s("MNOV");i.ModuleContainer.registerSingleton(oI.b,wI),i.ModuleContainer.registerSingleton(Sf.b,jI),i.ModuleContainer.registerSingleton(NI.a,UI),i.ModuleContainer.registerSingleton(BI,xI),i.ModuleContainer.registerSingleton(hI,VI),i.ModuleContainer.registerSingleton(gI,$I),i.ModuleContainer.registerSingleton(pI,qI),i.ModuleContainer.registerSingleton(lI.a,lI.b),i.ModuleContainer.registerSingleton(KI.a,KI.b),i.ModuleContainer.registerSingleton(LI.a,LI.b);var ZI,QI=s("WDlm"),JI=s("Ivja"),YI=s("3rJp"),XI=s("j+NN");let e_=Object(i.injectable)()(ZI=Reflect.metadata("design:type",Function)(ZI=Reflect.metadata("design:paramtypes",[])(ZI=class{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.zCloud,[ci.ZLoggerNametags.zCloudMediaExtInfoServices])),this._Logger}constructor(){this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=QI.b,this.key=QI.b}async doVerify(e){const t=(null==e?void 0:e.length)&&!!JI.a.instance().isKeyAvailable(),{myCloudItems:s,decryptItems:i,submitItems:a,updateThumbUrlItems:n}=this.filter(e);let r=[];if(Object(ep.b)().isEnableSubmitExtraInfoConv("mycloud")&&s.length>0){const e=await this.updateMyCloudItems(s);r=[...r,...e]}if(Object(ep.b)().isEnableSubmitExtraInfoConv("other")&&t&&i.length>0){const e=await this.updatePCloudItems(i);r=[...r,...e]}if(Object(ep.b)().isEnableSubmitExtraInfoConv("e2ee")&&t&&a.length>0){const e=await this.submitAndUpdatePCloudItems(a);r=[...r,...e]}if(n.length>0){const e=await this.updateThumbUrl(n);r=[...r,...e]}return r}filter(e){const t=e,s=ms.default.sendToMeId;if(0===t.length||!s)return{myCloudItems:[],decryptItems:[],submitItems:[],updateThumbUrlItems:[]};const i=[],a=[],n=[],r=[];for(let m=0;m<t.length;m++){var o,d,l,c,h,u,g;const e=t[m];if(!e)continue;const p=(null==e||null===(o=e.msgInfo)||void 0===o?void 0:o.destId)==s,f=null==e||null===(d=e.msgInfo)||void 0===d?void 0:d.isE2EE,v=(null===(l=e.mediaInfo)||void 0===l||l.mediaExtInfo,null===(c=e.mediaInfo)||void 0===c||null===(h=c.mediaExtInfo)||void 0===h?void 0:h.data),b=null===(u=e.mediaInfo)||void 0===u||null===(g=u.mediaExtInfo)||void 0===g?void 0:g.decryptedData;if(b){this.shouldUpdateThumbUrl(t[m],b)&&r.push(e)}else p?v||i.push(e):f?b||(v?a.push(e):n.push(e)):b||v&&a.push(e)}return{myCloudItems:i,decryptItems:a,submitItems:n,updateThumbUrlItems:r}}shouldUpdateThumbUrl(e,t){const s=Is.default.normalizeMessageType(e.msgInfo.msgType);if(XI.a.includes(s))try{return!Object(cf.a)(t).thumbUrl}catch(i){return!1}return!1}async updateThumbUrl(e){const t=Object(YI.b)(e),s=await Object(YI.h)(t);if(!s)return[];const i=[];if(s.forEach((t=>{for(let s=0;s<t.length;s++){const a=t[s],n=e.find((e=>lf.a.getZCloudKeyFromCloudItem(e)===lf.a.getZCloudKeyFromQueryItem(a)));if(!a||!n)continue;const r=Object(YI.g)(n,a);r&&i.push(r)}})),0===i.length)return[];try{return await bI.a.getInstance().updateCloudQueue(i,["mediaInfo"]),this.Logger.zsymb(0,"hpc14r","[updateThumbUrl] has success","updateClouds",i.length),i}catch(a){throw this.Logger.zsymb(18,"3AGVnw","[updateThumbUrl] has error",a),a}}async updateMyCloudItems(e){const t=Object(YI.b)(e),s=await Object(YI.h)(t);if(!s)return[];const i=[];if(s.forEach((t=>{for(let s=0;s<t.length;s++){const a=t[s],n=e.find((e=>lf.a.getZCloudKeyFromCloudItem(e)===lf.a.getZCloudKeyFromQueryItem(a)));if(!a||!n)continue;const r=Object(YI.d)(n,a);r&&i.push(r)}})),0===i.length)return[];try{return await bI.a.getInstance().updateCloudQueue(i,["mediaInfo"]),this.Logger.zsymb(0,"6dDYIp","[updateMyCloudItems] has success","updateClouds",i.length),i}catch(a){throw this.Logger.zsymb(18,"pNa8-J","[updateMyCloudItems] has error",a),a}}decryptAndUpdateParams(e){return new Promise((async t=>{try{var s,i,a,n;const r=(null===(s=e.mediaInfo.mediaExtInfo)||void 0===s?void 0:s.data)||"",o=(null===(i=e.mediaInfo)||void 0===i||null===(a=i.mediaExtInfo)||void 0===a||null===(n=a.encryptInfo)||void 0===n?void 0:n.encryptKey)||"";let d=await JI.a.instance().decryptCloudInfo(r,o);if(d){const s=lf.a.getZCloudKeyFromCloudItem(e),i={};d=await this.updateDecryptedData(e,d),i[s]=d,t(i)}}catch(r){this.Logger.zsymb(18,"him5TO","[updatePCloudItems] => [decryptAndUpdateParams], has error",r),t("")}}))}async updateDecryptedData(e,t){const s=Is.default.normalizeMessageType(e.msgInfo.msgType);if(XI.a.includes(s)){if((t=Object(cf.a)(t)).thumbUrl)return JSON.stringify(t);const s=Object(YI.b)([e]),a=await Object(YI.h)(s);if(a){const e=a.get(s[0].toUid);var i;if(e&&e[0])t=Object(f.a)(Object(f.a)({},t),{},{thumbUrl:null===(i=e[0].message)||void 0===i?void 0:i.thumbUrl}),t=JSON.stringify(t)}}return t}async updatePCloudItems(e){const t=[],s=[];let i={};e.forEach((e=>{s.push(this.decryptAndUpdateParams(e))}));try{return(await Promise.allSettled(s)).forEach((e=>{e.value&&(i=Object(f.a)(Object(f.a)({},i),e.value))})),e.forEach((e=>{const s=lf.a.getZCloudKeyFromCloudItem(e);let a=i[s];if(a){const s=Object(YI.e)(e,a);t.push(s)}})),0===t.length?[]:(await bI.a.getInstance().updateCloudQueue(t,["mediaInfo"]),this.Logger.zsymb(0,"iMjjv3","[updatePCloudItems] has success","updateClouds",t.length),t)}catch(a){throw this.Logger.zsymb(18,"ZwNO4n","[updatePCloudItems] has error",a),a}}encryptParams(e,t){return new Promise((async s=>{try{const i=await Object(YI.c)(e,t);s(i||"")}catch(i){this.Logger.zsymb(18,"qe9Mdg","[submitAndUpdatePCloudItem] =>[encryptParams], has error",i),s("")}}))}async submitAndUpdatePCloudItems(e){const t=Object(YI.b)(e),s=await Object(YI.h)(t);if(!s)return[];const i=[],a=[];s.forEach((t=>{for(let s=0;s<t.length;s++){const a=t[s],n=e.find((e=>lf.a.getZCloudKeyFromCloudItem(e)===lf.a.getZCloudKeyFromQueryItem(a)));a&&n&&i.push(this.encryptParams(n,a))}}));try{const t=(await Promise.allSettled(i)).map((e=>e.value)).filter((e=>!!e)),s=t.map((e=>e.submit));if(0===s.length)return[];const n=await Of.a.submitMediaExtInfo({info:s});return t.forEach((t=>{const s=e.find((e=>e.noiseId===t.submit.noiseId));n&&s&&!n.noiseIdsErr.includes(s.noiseId)&&a.push(Object(YI.f)(s,t))})),0===a.length?[]:(await bI.a.getInstance().updateCloudQueue(a,["mediaInfo","encryptInfo"]),this.Logger.zsymb(0,"5EjYoE","[submitAndUpdatePCloudItems] has success","updateClouds",a.length),a)}catch(n){throw this.Logger.zsymb(18,"MgoEUF","[submitAndUpdatePCloudItems] has error",n),n}}})||ZI)||ZI)||ZI;var t_=s("LA5e");const s_="zcloud-queue-fetcher",i_=Object(i.define)(s_),a_="zcloud-base-sync-queue";Object(i.define)(a_);var n_;let r_=Object(i.injectable)()(n_=Reflect.metadata("design:type",Function)(n_=Reflect.metadata("design:paramtypes",[])(n_=class{constructor(){this.name=void 0,this.key=void 0,this.name=a_,this.key=a_}groupFetchedCloudsByAction(e){const t=[],s=[],i=[];for(let a=e.length-1;a>=0;a--){let n=e[a];if(n){let{action:e}=n;switch(e){case nf.c.add:i.push(n);break;case nf.c.remove:s.push(n);break;case nf.c.del_thread:t.push(n)}}}return{delThreads:t,delClouds:s,addClouds:i}}})||n_)||n_)||n_;var o_=s("vNFC"),d_=s("FvOk");const l_="zcloud-update-queue-after-fetch-queue",c_=Object(i.define)(l_);var h_=s("ZL0F");const u_=["lastNoiseId"];var g_;let m_=Object(i.injectable)()(g_=function(e,t){return Object(i.inject)(i_)(e,void 0,0)}(g_=function(e,t){return Object(i.inject)(c_)(e,void 0,1)}(g_=function(e,t){return Object(i.inject)(h_.a)(e,void 0,2)}(g_=Reflect.metadata("design:type",Function)(g_=Reflect.metadata("design:paramtypes",[void 0===i_?Object:i_,void 0===c_?Object:c_,void 0===h_.a?Object:h_.a])(g_=class extends r_{get Logger(){return this._Logger||(this._Logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.zCloud,[ci.ZLoggerNametags.zCloudVerifyQueueServices])),this._Logger}constructor(e,t,s){super(),this.queueFetcher=e,this.updateQueueService=t,this.syncZCloudQueueUIState=s,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=t_.a,this.key=t_.a}get PCloudMetrics(){return i.ModuleContainer.resolve(ep.g)}async checkVerify(e){const{lastNoiseId:t,forceVerify:s,forceReset:i}=e.mycloudMedia;let a=await bI.a.getInstance().getLastNoiseId();return i?{sourceForceVerify:o_.a.CMD_621_FORCE_RESET}:s?{sourceForceVerify:o_.a.CMD_621_FORCE_VERIFY}:a?t!==a?{sourceVerify:o_.b.CMD_621_VERIFY}:{}:{sourceForceVerify:o_.a.CMD_621_EMPTY_LAST_NOISEID}}async buildVerifyFetchReq(e){try{return{lastNoiseId:await bI.a.getInstance().getLastNoiseId(),lastNoiseIds:[],loadType:nf.f.oldest_to_newest,trackingSource:e.trackingSource}}catch(t){throw t}}buildForceVerifyFetchReq(e){return{lastNoiseId:"",lastNoiseIds:[],loadType:nf.f.oldest_to_newest,trackingSource:e.trackingSource}}shouldCheckResetItem(e){return(null==e?void 0:e.sourceForceVerify)!==o_.a.CMD_620_RESET_CLOUD}async doFetch(e,t,s,i=!1){const a={lastNoiseId:"",cloudItems:[],hasMore:!1};let n=!0,r=!i&&this.shouldCheckResetItem(s);for(t===d_.a.VERIFY_PAGE&&(a.preventCheckResetItem=i);n;){var o;const{cloudItems:s,lastNoiseId:i,hasMore:d}=await this.queueFetcher.fetchQueueByPage(e),l=null!=i?i:null===(o=s[0])||void 0===o?void 0:o.noiseId;if(s.find((e=>e.action===nf.c.reset_cloud))&&this.Logger.zsymb(0,"a1FsqP","doFetch ###### [DEV-DEBUG] ##### FOUND RESET ITEM ######"),r){s.find((e=>e.action===nf.c.reset_cloud))?(this.Logger.zsymb(0,"UJ2WBQ","doFetch, force verify from [found reset_item], sourceForceVerify",o_.a.VERIFY_FOUND_RESET_CLOUD),await bI.a.getInstance().removeAll(),a.cloudItems=[],a.lastNoiseId="",e.lastNoiseId="",n=!0,r=!1,t===d_.a.VERIFY_PAGE&&(a.preventCheckResetItem=!0)):(a.cloudItems.unshift(...s),a.lastNoiseId=l,a.hasMore=!!d,e.lastNoiseId=l,n=!!d)}else a.cloudItems.unshift(...s),a.lastNoiseId=l,a.hasMore=!!d,e.lastNoiseId=l,n=!!d;if(t===d_.a.VERIFY_PAGE&&a.cloudItems.length>0)break}return a}async verify(e){const{data:t,syncStrategy:s,sourceSync:i,req:a,preventCheckResetItem:n}=e;try{const e=a||await this.buildVerifyFetchReq(t),{cloudItems:r,lastNoiseId:o,hasMore:d,preventCheckResetItem:l}=await this.doFetch(e,s,i,n),{delThreads:c,delClouds:h,addClouds:u}=this.groupFetchedCloudsByAction(r);return{delThreads:c,delClouds:h,addClouds:u,lastNoiseId:o,hasMore:d,preventCheckResetItem:l}}catch(r){throw r}}forceVerify(e){const{data:t,syncStrategy:s,sourceSync:i,req:a,preventCheckResetItem:n}=e,r=a||this.buildForceVerifyFetchReq(t);return this.verify({data:t,syncStrategy:s,sourceSync:i,req:r,preventCheckResetItem:n})}async doVerifyWithSourceVerify(e,t,s){let i=null;return i=await this.verify({data:{trackingSource:nf.l.Need_Verify_CMD},syncStrategy:e,sourceSync:{sourceVerify:t},preventCheckResetItem:s}),i}async doForceVerifyWithOtherForceVerify(e,t,s){let i=null;return this.syncZCloudQueueUIState.setForceSyncSource(t),this.Logger.zsymb(0,"hvys9X","syncQueueByVerify, otherForceVerify",t),await bI.a.getInstance().removeAll(),i=await this.forceVerify({data:{trackingSource:nf.l.Need_Verify_CMD},syncStrategy:e,sourceSync:{sourceForceVerify:t},preventCheckResetItem:s}),i}async doVerifyWithServerCmd(e,t,s){let i=null;Object(vf.j)("doVerifyWithServerCmd",e,t,s);const{sourceForceVerify:a,sourceVerify:n}=await this.checkVerify(e);return a===o_.a.CMD_621_FORCE_RESET||a===o_.a.CMD_621_FORCE_VERIFY||a===o_.a.CMD_621_EMPTY_LAST_NOISEID?(this.Logger.zsymb(0,"JSugFd","syncQueueByVerify, sourceForceVerify",a),this.syncZCloudQueueUIState.setForceSyncSource(a),await bI.a.getInstance().removeAll(),i=await this.forceVerify({data:{trackingSource:nf.l.Need_Verify_CMD},syncStrategy:t,sourceSync:{sourceForceVerify:a},preventCheckResetItem:s})):n===o_.b.CMD_621_VERIFY&&(Object(vf.j)("doVerifyWithServerCmd, sourceVerify",n),i=await this.verify({data:{trackingSource:nf.l.Need_Verify_CMD},syncStrategy:t,sourceSync:{sourceVerify:n}})),i}async doVerify(e){const{data:t,syncStrategy:s,sourceVerify:i,otherForceVerify:a,preventCheckResetItem:n=!1}=e;let r=null;if(i?r=await this.doVerifyWithSourceVerify(s,i,n):a===o_.a.TOOL_CLIENT||a===o_.a.CMD_620_RESET_CLOUD?r=await this.doForceVerifyWithOtherForceVerify(s,a,n):t&&(r=await this.doVerifyWithServerCmd(t,s,n)),r){var o,d,l;const{lastNoiseId:e}=r,t=Object(ov.a)(r,u_);this.Logger.zsymb(0,"ndWERN","syncQueueByVerify, after fetched & filtered actions, ","added clouds",null===(o=t.addClouds)||void 0===o?void 0:o.length,"deleted clouds",null===(d=t.delClouds)||void 0===d?void 0:d.length,"deleted thread",null===(l=t.delThreads)||void 0===l?void 0:l.length),await this.updateQueueService.updateQueue(Object(f.a)(Object(f.a)({},t),{},{lastNoiseId:e})),this.Logger.zsymb(0,"qn3rnW","syncQueueByVerify, done update db, lastNoiseId",e)}return r}async submitVerifyAction(e){try{await Of.a.submitVerifyAction({type:e})}catch(t){this.Logger.zsymb(18,"_g6duG","submitVerifyAction",t)}}})||g_)||g_)||g_)||g_)||g_)||g_;var p_;let f_=Object(i.injectable)()(p_=Reflect.metadata("design:type",Function)(p_=Reflect.metadata("design:paramtypes",[])(p_=class extends r_{constructor(){super(),this.name=void 0,this.key=void 0,this.name=l_,this.key=l_}async updateQueue(e){const{delThreads:t,delClouds:s,addClouds:i,lastNoiseId:a}=e;return(null==i?void 0:i.length)>0&&await sf.a.getInstance().setCloudItems(i),(null==s?void 0:s.length)>0&&await sf.a.getInstance().removeCloudItems(s),(null==t?void 0:t.length)>0&&await sf.a.getInstance().delThreads(t),a&&await sf.a.getInstance().setLastNoiseId(a,Date.now(),{}),[]}})||p_)||p_)||p_;var v_;let b_=Object(i.injectable)()(v_=Reflect.metadata("design:type",Function)(v_=Reflect.metadata("design:paramtypes",[])(v_=class{constructor(){this.name=void 0,this.key=void 0,this.name=s_,this.key=s_}async fetchQueue(e){const{loadType:t,lastNoiseIds:s,trackingSource:i}=e;let{lastNoiseId:a}=e;const n={lastNoiseId:"",cloudItems:[]};let r=!0;for(;r;){var o;const{mediaItems:e,hasMore:d,lastNoiseId:l}=await Of.a.verifyCloudMedia(a,t,s,i);Object(vf.j)("fetchQueue",l,null==e?void 0:e.length,d);const c=null!=l?l:null===(o=e[0])||void 0===o?void 0:o.noiseId,h=e.sort(((e,t)=>t.msgInfo.ts-e.msgInfo.ts));n.cloudItems.unshift(...h),n.lastNoiseId=c,a=c,r=d}return n}async fetchQueueByPage(e){var t;const{lastNoiseId:s,lastNoiseIds:i,loadType:a,trackingSource:n}=e,r={lastNoiseId:"",cloudItems:[],hasMore:0},{mediaItems:o,lastNoiseId:d,hasMore:l}=await Of.a.verifyCloudMedia(s,a,i,n);Object(vf.j)("fetchQueueByPage",null==o?void 0:o.length,d,l);const c=null!=d?d:null===(t=o[0])||void 0===t?void 0:t.noiseId,h=o.sort(((e,t)=>t.msgInfo.ts-e.msgInfo.ts));return r.cloudItems=h,r.lastNoiseId=c,r.hasMore=l,r}})||v_)||v_)||v_;var y_=s("jqP8"),I_=s("Hvyc"),__=s("Dr9L");const C_="zcloud-media-pc-fetcher",O_=Object(i.define)(C_),S_="zcloud-media-web-fetcher",E_=Object(i.define)(S_);$znode.rimraf,$znode.fs;var M_,T_=s("IpzU"),w_=s("KkZn");s("EW/s");let R_=Object(ke.d)()(M_=Object(ke.g)()(M_=Object(ke.h)()(M_=Object(i.injectable)()(M_=function(e,t){return Object(i.inject)(O_)(e,void 0,0)}(M_=function(e,t){return Object(i.inject)(E_)(e,void 0,1)}(M_=Reflect.metadata("design:type",Function)(M_=Reflect.metadata("design:paramtypes",[void 0===O_?Object:O_,void 0===E_?Object:E_])(M_=class extends y_.a{constructor(e,t){super(),this.pcFetcher=e,this.webFetcher=t,this.name=void 0,this.key=void 0,this.cleanupTimeoutId=void 0,this.name=I_.b,this.key=I_.b,this.cleanupTimeoutId=null}onSessionExpired(){this.cleanup()}onDispose(){this.cleanup()}onApplicationReady(){this.cleanup()}doCleanupAfterTimeout(e){e&&(this.cleanupTimeoutId=setTimeout((()=>{this.cleanup()}),e))}clearCleanupTimeoutId(){this.cleanupTimeoutId&&clearTimeout(this.cleanupTimeoutId)}async getCloudItem(e){const t=this.getCloudQueryByMessage(e);return t?this.getCloudItemByCloudQuery(t):null}async getDownloadUrl(e,t,s){return this.getUrl(e,t,s)}async getDownloadHeaders(){return this.getHeaders()}async fetch(e){const{cloud:t,message:s,options:i}=e,{type:a}=i,n=await this.getDownloadUrl(t.cloud,null==s?void 0:s.e2eeSession,a),r=await this.getHeaders();if(!n||!r)throw __.b.getError(Object(f.a)(Object(f.a)({},__.a.INVALID_PARAMS),{},{message:"No cloud "+(n?"headers":"url")}));return this.webFetcher.fetch({url:n,headers:r,cloud:t.cloud,options:i})}async cleanup(){}})||M_)||M_)||M_)||M_)||M_)||M_)||M_)||M_;var L_=s("BxiA"),F_=s("vBob");let D_;(D_||(D_={})).buildData=function(e){return Is.default.normalizeMessageType(e.msgInfo.msgType),R.MSG_FILE,function(e){var t,s;const{zKey:i,msgInfo:a,mediaInfo:n}=e,{msgType:r,destId:o}=a,d=Is.default.normalizeMessageType(r),l=Object(L_.a)(null!=i?i:lf.a.getZCloudKeyFromCloudItem(e),d),c=lf.a.getConversationIdFromCloudItem(e,mt.default.getUserId()),h=Object(cf.a)(o===ms.default.sendToMeId?null==n||null===(t=n.mediaExtInfo)||void 0===t?void 0:t.data:null==n||null===(s=n.mediaExtInfo)||void 0===s?void 0:s.decryptedData),{fileSize:u,checksum:g,fType:m,title:p,fileExt:f}=h,v=p||F_.a.NoNameFile,b=f||v.split(".").pop();return{fileName:v,localPath:l,conversationId:c,msgType:d,fileSize:u,checksum:g,fType:m,ext:b}}(e)};var A_=D_;const j_=["options"];var P_;let N_=Object(i.injectable)()(P_=Reflect.metadata("design:type",Function)(P_=Reflect.metadata("design:paramtypes",[])(P_=class{constructor(){this.name=void 0,this.key=void 0,this.name=C_,this.key=C_}async fetch(e){const{url:t,headers:s,cloud:i,options:a}=e,{options:n}=a,r=Object(ov.a)(a,j_),o=Object.assign(n,{headers:s}),d=Object.assign(A_.buildData(i),{url:t});return zy.a.run(Object(f.a)(Object(f.a)({},r),{},{options:o,data:d}))}})||P_)||P_)||P_;var U_;let k_=Object(i.injectable)()(U_=Reflect.metadata("design:type",Function)(U_=Reflect.metadata("design:paramtypes",[])(U_=class{constructor(){this.name=void 0,this.key=void 0,this.name=S_,this.key=S_}async fetch(e){const{url:t,options:s}=e,i=null!=s&&s.options?Object(f.a)(Object(f.a)({},null==s?void 0:s.options),{},{headers:e.headers}):{headers:e.headers},a=null==s?void 0:s.queueType,n=null==s?void 0:s.onProgress;return Object(Md.h)(Object(Md.i)().toString(),t,a,n,i)}})||U_)||U_)||U_;const B_="zcloud-photo-fetcher",G_=Object(i.define)(B_);var x_=s("BDVO"),z_=s("LeFD"),V_=s("HOwT");const H_=null,$_=e=>zy.a.run(e),W_=e=>new Promise((async(t,s)=>{try{var i;const{url:n,localPath:r,timeout:o=6e4,maxTTFB:d=2e4,signal:l,noCacheRespFail:c,disableCache:h,msgId:u,entrySerial:g,mediaId:m,options:p,sendDttm:v}=e,b=H_.basename(r),y=H_.dirname(r),I=Object(f.a)({srcAction:h?zy.a.constants.srcAction.Manual:zy.a.constants.srcAction.Dev,saveDir:y,caching:!0,cacheResp:{noCacheRespFail:c},error:{handleError:!0},maxTTFB:d,mediaId:m},p),_={entrySerial:g,type:zy.a.constants.DownloadType.Photo,data:{url:n,fileName:b,msgId:u,sendDttm:v},options:I},C=()=>{s(new z_.a)};if(null!=l&&l.aborted)return C();null==l||l.addEventListener("abort",C);const O=setTimeout((()=>{s(new z_.d)}),o),S=await Object(Zo.a)($_,_);if(null==l||l.removeEventListener("abort",C),clearTimeout(O),S.ok)return t(null);const E=S.error;if(!E)return s(new z_.f);const M="string"==typeof(null==E?void 0:E.code)||"number"==typeof(null==E?void 0:E.code)?null==E?void 0:E.code:null==E||null===(i=E.downloadError)||void 0===i?void 0:i.code;if(isNaN(M))return s(new z_.f(E.name));if(M>=75e3&&M<76e3){const e=M-75e3;if(Pd.a.image_loader.enable){var a;const t=null===(a=Pd.a.image_loader.retryErrorCodes)||void 0===a?void 0:a.some((t=>t===e));if(!!v&&t&&Object(x_.a)(v))return s(new V_.NotReadyError)}return s(new z_.c(e))}return s(1010==M?new z_.d:new z_.f(M))}catch(n){const e=new z_.f("[LoadPhotoPC]"+(null==n?void 0:n.message));return null!=n&&n.stack&&(e.stack=n.stack),s(e)}}));var q_;let K_=Object(i.injectable)()(q_=function(e,t){return Object(i.inject)(I_.a)(e,void 0,0)}(q_=Reflect.metadata("design:type",Function)(q_=Reflect.metadata("design:paramtypes",[void 0===I_.a?Object:I_.a])(q_=class extends y_.a{constructor(e){super(),this.mediaZCloudFetcher=e,this._responsesCache=new Map,this._blobURLReserveMap=new Map,this.name=void 0,this.key=void 0,this._downloadHandler=async e=>{const{localPath:t}=e,s=await Object(Zo.a)(W_,e),i=s.ok?t:"";if(s.ok)return{mediaURL:i,error:void 0};throw s.error},this._downloadWithRetry=te(this._downloadHandler,{min:Pd.a.image_loader.retryMin,max:Pd.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:Pd.a.image_loader.lastTryDelayTime.min,max:Pd.a.image_loader.lastTryDelayTime.max},shouldRetryOnError:async({error:e})=>e instanceof Dv.a.NotReadyError||e instanceof Dv.a.TimeoutTTFB||e instanceof Dv.a.TimeoutError}),this.name=B_,this.key=B_}async fetchOnWeb(e,t){Object(Dd.a)("string"==typeof t&&Ad(t),`Media source must be a (http|https) URL. Got ${t}`);const s=this._responsesCache.get(t);if(s&&!s.isRevoked)return yd.k.Success({mediaURL:this._responsesCache.get(t).blobURL});try{const s=Object(Md.i)().toString(),i=te(Md.h,{min:Pd.a.image_loader.retryMin,max:Pd.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:Pd.a.image_loader.lastTryDelayTime.min,max:Pd.a.image_loader.lastTryDelayTime.max}}),a=await this.mediaZCloudFetcher.getDownloadHeaders(),n=await i(s,t,Md.a.dev,void 0,{useDiskCache:!1,headers:a});if(n.error)return yd.k.Failure({code:yd.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:n.error}});const r=this._responsesCache.get(t)||{};return this._cacheResponse(t,Object(f.a)(Object(f.a)({},r),{},{remoteURL:t,blobURL:n.data,mediaId:e,isRevoked:!1})),yd.k.Success({mediaURL:n.data})}catch(i){return yd.k.Failure({code:yd.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:i}})}}_cacheResponse(e,t){this._responsesCache.set(e,t),this._blobURLReserveMap.set(t.blobURL,e)}async fetchOnPC(e,t,s){const{entrySerial:i,savePath:a}=s;if(a&&Object(w_.a)(a))return yd.k.Success({mediaURL:a});try{let n={url:t,mediaId:e,localPath:a,entrySerial:i,sendDttm:null==s?void 0:s.sendDttm,noCacheRespFail:(null==s?void 0:s.sendDttm)&&Object(x_.a)(null==s?void 0:s.sendDttm)};const r=await this.mediaZCloudFetcher.getDownloadHeaders(),o=s.autoDownload?{srcAction:zy.a.constants.srcAction.Auto,headers:r}:{headers:r};n.options=o;const d=await this._downloadWithRetry(n);return d.error?yd.k.Failure({code:yd.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:d.error}}):yd.k.Success({mediaURL:a})}catch(n){return yd.k.Failure({code:yd.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:n}})}}async fetch(e){const{mediaId:t,source:s,diskFetcherConfig:i}=e;let a;Object(Dd.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(Dd.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`),a=yd.i.MemoryCache;const n=Ad(s),r=jd(s);if(!n&&r)return yd.k.Success({mediaURL:s});if(a===yd.i.MemoryCache)try{return await this.fetchOnWeb(t,s)}catch(l){return Promise.reject(l)}Object(Dd.a)("object"==typeof i&&"string"==typeof i.savePath&&!!i.downloadEntrySerial,`MediaFetcherImpl: invalid diskFetcherConfig. Got ${i}`);const{savePath:o,downloadEntrySerial:d}=i;return this.fetchOnPC(t,s,{entrySerial:d,savePath:o})}})||q_)||q_)||q_)||q_;i.ModuleContainer.registerSingleton(QI.a,e_),i.ModuleContainer.registerSingleton(t_.b,m_),i.ModuleContainer.registerSingleton(c_,f_),i.ModuleContainer.registerSingleton(i_,b_),i.ModuleContainer.registerSingleton(I_.a,R_),i.ModuleContainer.registerSingleton(O_,N_),i.ModuleContainer.registerSingleton(E_,k_),i.ModuleContainer.registerSingleton(G_,K_);var Z_=s("hmll"),Q_=s("NL/6");const J_=[{chord:`${R.CmdOrCtrl}${R.K_I}`,commandId:Q_.a.FOCUS_MAIN_CHAT_INPUT_AT_ACTIVE_WINDOW,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${R.CmdOrCtrl}${R.K_I}`,commandId:Q_.a.APPLY_ITALIC_STYLE_FOR_SELECTED_TEXT,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${R.CmdOrCtrl}${R.K_B}`,commandId:Q_.a.APPLY_BOLD_STYLE_FOR_SELECTED_TEXT,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${R.CmdOrCtrl}${R.K_U}`,commandId:Q_.a.APPLY_UNDERLINE_STYLE_FOR_SELECTED_TEXT,commandTitle:"",isMatchedContext:(e,t)=>!0},{chord:`${R.CmdOrCtrl}${R.Shift}${R.K_X}`,commandId:Q_.a.TOGGLE_RTF_MODE,commandTitle:"",isMatchedContext:(e,t)=>!0}];i.ModuleContainer.register(Z_.a,class{constructor(){this._keybindings=[],J_.forEach((e=>{this._keybindings.push({chord:e.chord,commandId:e.commandId,commandTitle:e.commandTitle,isMatchedContext:e.isMatchedContext,eventHandlers:[]})}))}registerEventHandlerByCommandId(e,t){return e&&t?(this._keybindings.forEach((s=>{s.commandId!==e||s.eventHandlers.includes(t)||s.eventHandlers.push(t)})),()=>{this._keybindings.forEach((s=>{s.commandId===e&&s.eventHandlers.includes(t)&&(s.eventHandlers=s.eventHandlers.filter((e=>e!==t)))}))}):()=>{}}loopkupKeybindingByCommandId(e){return e?this._keybindings.reduce(((t,s)=>(e===s.commandId&&t.push(s),t)),[]):[]}loopkupKeybindingByChord(e){return e?this._keybindings.reduce(((t,s)=>(e===s.chord&&t.push(s),t)),[]):[]}});var Y_=s("XRso");i.ModuleContainer.register(Y_.a,class{buildChord(e){let t="";return e&&this._isChord(e)&&((e.ctrlKey||e.metaKey)&&(t+=R.CmdOrCtrl),e.shiftKey&&(t+=R.Shift),e.altKey&&(t+=R.Alt),t+=e.keyCode||e.which),t}buildKeybindingContext(e,t){return e&&t?`${e}#${t}`:""}getChordByCommandId(e){return e===Q_.a.TOGGLE_RTF_MODE?(Object(Av.c)()?"Cmd":"Ctrl")+" + Shift + X":""}_isOnlyModifier(e){return["Shift","Control","Alt","Meta"].includes(e.key)}_isOnlyNonModifier(e){return!(e.ctrlKey||e.metaKey||e.shiftKey||e.altKey)}_isChord(e){return!(this._isOnlyModifier(e)||this._isOnlyNonModifier(e))}});var X_=s("GNMY"),eC=s("sGG0");var tC,sC=s("72EQ"),iC=s("v+vz"),aC=s("F1+M"),nC=s("XbxG"),rC=s("U/XY"),oC=s("1PLK");function dC(){if(!ms.default.profile.cover.randomUrls.length)return"";const{randomUrls:e}=ms.default.profile.cover;return e[Math.floor(Math.random()*e.length)]}Object(ke.g)()(tC=Object(Hs.b)(X_.a)(tC=Reflect.metadata("design:type",Function)(tC=Reflect.metadata("design:paramtypes",[])(tC=class{constructor(){this.name=X_.b,this.key="convId",this.didInit=!1,this.data=void 0,this._cachedFriendRequest={},this._dispatch=void 0,this._genMessageServer=void 0,this._randomCoverSrc=dC(),this._logger=void 0,this.type=void 0,this.data=new Map}get Logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(this.name,["personal-controller"])),this._logger}init(e){this.didInit||(this._fetchReceiveFriendList(),i.ModuleContainer.resolve(er.n).addEventListener(er.m.ReceiveAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(er.n).addEventListener(er.m.UndoAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(er.n).addEventListener(er.m.AcceptAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(er.n).addEventListener(er.m.RejectAddFriendEvent,this.invitationEventHandler.bind(this)),i.ModuleContainer.resolve(er.n).addEventListener(er.m.UndoSentRequestFriendEvent,this.invitationEventHandler.bind(this)),this.didInit=!0)}onDispose(){Mv.a.getInstance().removeAll()}bindDispatch(e){this._dispatch=e,Cs.default.subscribe(this.eventHandler.bind(this)),this._randomCoverSrc=dC()}unbind(){this._dispatch=null,this._genMessageServer=null,this.data.clear(),Cs.default.unsubscribe(this.eventHandler)}dispatch(e){this._dispatch?this._dispatch(e):this.Logger.zsymb(0,"qR22VW","Lost dispatch")}bindGenMessageServer(e){this._genMessageServer=e}clearState(e){this.data.has(e)&&this.data.delete(e)}_signalUpdate(e){Object(Kt.g)(X_.b,e)}_updateData(e,t,s){const i=this.data.get(e);i?this.data.set(e,Object(f.a)(Object(f.a)({},i),{},{[t]:i&&i[t]?Is.default.deepMerge(i[t],s):s})):this.data.set(e,{[t]:s,version:0}),this._signalUpdate(e)}_udapteInfoData(e,t,s=!0){var i;const a=this.data.get(e);return s&&null!=a&&null!==(i=a.info)&&void 0!==i&&i.avatar&&(t.avatar=a.info.avatar),this._updateData(e,"info",t)}_updateVersion(e){const t=this.data.get(e);t?this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{version:t.version+1})):this.data.set(e,{version:0}),this._signalUpdate(e)}getCover(e){var t;const s=null===(t=this.data.get(e))||void 0===t?void 0:t.info;if(s){const e=s.cover;return e&&e==ms.default.profile.cover.defaultUrl?this._randomCoverSrc||ms.default.profile.cover.defaultUrl:e}return this._randomCoverSrc||ms.default.profile.cover.defaultUrl}async getUserInfo(e,t=!1){const s=Object(f.a)({},zt.default.getProfileFriendByIdSync(e));this._udapteInfoData(e,s);const i=async()=>{try{const t=await zt.default.getProfileFriendById(e,R.SRC_GET_PROFILE.FORCE_GET);return zt.default.isFriend(e)||this.getStatusFriendRequest(e),t&&(iC.y(e)&&Cs.default.send(Os.FetchActions.UDPATE_BUSINESS_INFO,{user:t}),this._udapteInfoData(e,t,!1)),this.getFullAvatar(e),t}catch(t){return this.Logger.zsymb(0,"ipVB-m","[getUserInfo]",t),zt.default.getProfileFriendByIdSync(e)}};return t||!this.data.has(e)||!s||Object.keys(s).length<=4?i():s}async getExtraInfo(e){try{const t=await Kn.a.getProfileExtra(e,zt.default.getUidMe());if(t){(e=>{if(e.bkPhotos&&e.photos&&e.photos.length)for(let t=0;t<e.photos.length;t++){const s=e.photos[t],i=e.bkPhotos[t];Mv.a.getInstance().setBackup(s,i)}})(t);const s=(e=>{const t=e.photos?e.photos.map(((t,s)=>({url:t,meta:e.photoMetas&&e.photoMetas[s]}))):[];let s=[];return e.groupIds&&e.groupIds.length>0&&e.groupIds.forEach((e=>{Zs.a.checkHiddenChatByPureGroupId(e)||s.push(e)})),{mutualGroups:s,photos:t}})(t);return this._updateData(e,"extra",s),!0===t.fetched&&this.dispatch({type:Os.ConversationListActions.FORCE_UPDATE_MUTUAL_GROUP_ITEM,payload:e}),s}}catch(s){var t;this.Logger.zsymb(0,"cTDIsF","[getExtraInfo]",s),this._updateData(e,"extra",(null===(t=this.data.get(e))||void 0===t?void 0:t.extra)||{})}return null}async getFullAvatar(e,t=!1){const s=(t,s)=>{Mv.a.getInstance().setBackup(t,s),this._updateData(e,"info",{fullAvatar:t})},i=async()=>{try{const t=await iC.k(e);t&&s(t.full_avatar,t.bk_full_avatar)}catch(t){if(this.Logger.zsymb(18,"qxdXgH","fetch full avatar error:",t),a){if(Is.default.isWeb()){let e=a.url;return e&&s(e),e}{let e=a.path;if(await Object(sC.a)(e))return s("file://"+e),"file://"+e}}}};let a=mt.default.getProfileAvatar(e);if(t||!a)return i();{let e=a.ts;if(Date.now()-3e5>e)return i();if(Is.default.isWeb()){let e=a.url;return s(e),e}{let e=a.path;Object(sC.a)(e).then((t=>t?(s("file://"+e),"file://"+e):i()))}}}async getProfileRank(e){try{const t=await Kn.a.getProfileRank(e,zt.default.getUidMe());return this._updateData(e,"rank",t),t}catch(s){var t;this.Logger.zsymb(0,"4F41d6","[getProfileRank]",s),this._updateData(e,"rank",(null===(t=this.data.get(e))||void 0===t?void 0:t.rank)||{})}return null}async getStatusFriendRequest(e){const t=async()=>{try{await Qi.a.getStatusFriendRequest(e,!1)}catch(t){}};let s=$e.p.getFriendRequestStatus(e);if(s){let e=s.ts;e&&e>-1&&e<Date.now()-2e3&&t()}else t()}async _fetchReceiveFriendList(e=!1){let t=Zn.a.getRecommendedFriendsSync();if(!Object.keys(t).length||e)try{t=await Zn.a.getRecommendedFriendsV2(!0,!0)}catch(i){this.Logger.zsymb(0,"RKYenk","_fetchReceiveFriendList [ERROR]",t)}const s=Object.keys(t);s.length&&s.forEach((e=>{var s,i,a;(null===(s=t[e])||void 0===s||null===(i=s.dataInfo)||void 0===i?void 0:i.recommType)===br.RECEIVE&&(this._cachedFriendRequest[e]=null===(a=t[e])||void 0===a?void 0:a.dataInfo)}))}getRequestInfo(e){return this._cachedFriendRequest[e]}async toggleBlock(e,t){var s;const i=this.data.get(e),a=(null==i||null===(s=i.info)||void 0===s?void 0:s.isBlocked)||zt.default.isBlocked(e);Vt.default.logAction(1460207);try{const s=await zt.default.blockFriend(e,a?R.UNSET_BLOCK:R.SET_BLOCK);return rC.c(t,a?"STR_UNBLOCK_USER_TOAST_SUCCESS":"STR_BLOCK_USER_TOAST_SUCCESS"),i&&this._updateData(e,"info",{isBlocked:!a}),a||Vt.default.logAction(146020701),this.dispatch({type:Os.ConversationListActions.BLOCK_CONVERSATION,payload:{blocked:!a,userId:e}}),s}catch(n){this.Logger.zsymb(18,"0urnrM","toggleBlock",n),rC.c(t,a?"STR_UNBLOCK_USER_TOAST_FAIL":"STR_BLOCK_USER_TOAST_FAIL")}}async toggleRemoveFriend(e,t){Vt.default.logAction(1460206);try{const s=await iC.B(e);return mt.default.removeNewFriend(e),mt.default.removeFriend(e).then((t=>{Cs.default.send(Os.PopupActions.TOGGLE_REMOVE_FRIEND,e)})),this.dispatch({type:Os.FetchActions.FRIENDS_REMOVED,payload:e}),rC.c(t,"STR_DELETE_SUCCESS"),s}catch(s){this.Logger.zsymb(18,"jndMWn","toggleRemoveFriend",s)}}async toggleShareContact(e,t){const s=this.data.get(e),i=await Object(aC.c)([e]);Vt.default.logAction(1460205);let a="",n="";s&&s.info&&(a=s.info.avatar,n=s.info.displayName);let r={message:{action:"recommened.user",description:JSON.stringify({qrCodeUrl:i[e]}),params:e,thumb:a,title:n},msgType:R.MSG_CONTACT,windowId:t};Cs.default.send(Os.PopupActions.SHARE_MSG,r)}showImage(e,t,s=Hy.i.ProfileAvatar){var i;let a=null===(i=this.data.get(e))||void 0===i?void 0:i.info;if(!a)return;const n={user:zt.default.getProfileMeSync(),userId:e,conversation:Object(f.a)({},a),isVideo:!1,selectedId:null,isProfileImg:!0,href:t,appConfig:Object(ms.getPVConfigs)(),source:s};Is.default.isWeb()||(n.appConfig={enable_feature_alias:ms.default.enable_feature_alias,enable_stranger_alias:ms.default.enable_stranger_alias}),Ds.a.OpenPhoto.openPhotoViewer(n)}voiceCall(e,t){const s=this.data.get(e);if(Vt.default.logAction(10643),Vt.default.logActionInfo(Vt.FeaturesInfo.BusinessAccount,1460203,[e,zt.default.isFriend(e)?0:1]),!na.c.isSupport()||null==s||!s.info)return;if(na.c.isCalling())return void rC.b(t,void 0,$t.default.trans(na.b.IN_CALL));const i=s.info;var a;Is.default.isWeb()||(a=e,mt.default.getConversation(a)).then((t=>{let s={lastSmsLocalId:t?t.lastSmsLocalId:null,displayName:i.displayName,userId:e},a=[s.userId];na.c.makeCall(a,!1,!1,(e=>{this._genMessageServer&&this._genMessageServer(s,e),e.caller&&e.duration>0&&nC.b.updateLastActionTime(s.userId,this.dispatch,-1,nC.a.CALL)}))}))}jumpToConversation(e){let t=this.data.get(e);if(!t||!t.info)return;i.ModuleContainer.resolve(ni.b).openConversation(e,ni.c.fromProfileInfo(t.info));const s=zt.default.isFriend(e);Vt.default.logActionInfo(Vt.FeaturesInfo.BusinessAccount,1460204,[e,s?1:0]),Gt.ModalManagerV2.closeAllModal()}async undoFriendRequest(e){Vt.default.logAction(146020802);try{return await Qi.a.undoRequestAddFriend(e),i.ModuleContainer.resolve(er.n).dispatchEvent(new er.o(er.m.UndoSentRequestFriendEvent,null,e)),this.getUserInfo(e),!0}catch(t){t&&t.error_message&&rC.a(t.error_message)}return!1}async addFriend(e,t){const s=this.data.get(e);return!(!s||!s.info||s.info.isBlocked)&&(Qi.a.isYouRequestMe(e)?(Vt.default.logAction(146020801),i.ModuleContainer.resolve(Wn.b).acceptFriendRequest(e,t),mt.default.getAcceptNewFriend(s)):Vt.default.logAction(1460208),!0)}async sendFriendRequest(e,t,s,i){const a=Qi.a.getFriendRequestSource(e);try{await Qi.a.requestAddFriend(e,s,a),this.dispatch({type:Os.ChatBoxActions.SEND_FRIEND_REQUEST,payload:e}),Cs.default.send(Os.SideBarActions.SENT_FRIEND_REQUEST,e),rC.c(t,"STR_REQ_FR_SUCCESS"),mt.default.setStrangerCache(e,1),eC.a.callUpdate(e,i)}catch(n){this.Logger.zsymb(18,"Z0MrDx","sendFriendRequest",n),n&&n.error_message&&rC.a(t,n.error_message),mt.default.setStrangerCache(e,0)}}openLink(e){oC.b.open(e)}eventHandler(e,t){switch(e){case Os.FetchActions.STATUS_BLOCKED_CHANGED:if(t){this.data.has(t)&&this._updateData(t,"info",{isBlocked:zt.default.isBlocked(t)})}break;case Os.FetchActions.UPDATE_NAME:if(t)if(t.constructor===Object){this.data.has(t.userId)&&this.getUserInfo(t.userId)}else if(t.constructor===Array)for(const[e,s]of Object.entries(this.data)){t.includes(e)&&this.getUserInfo(e)}break;case Os.FetchActions.USERID_FETCHED:case Os.FetchActions.PROFILE_ME_FETCHED:{const e=zt.default.getUidMe();t&&this._udapteInfoData(e,Object(f.a)(Object(f.a)({},t),{},{isBlocked:!1,isFr:!0}),!this.data.has(t.userId)),this.data.has(t.userId)&&this.getFullAvatar(t.userId,!0);break}case Os.FetchActions.FRIEND_REQUEST_UPDATE:t&&this.data.has(t.userId)&&this._updateVersion(t.userId);break;case Os.ConversationListActions.BLOCK_CONVERSATION:t&&this.data.has(t.userId)&&this._updateData(t.userId,"info",{isBlocked:t.blocked});break;case Os.FriendListActions.UPDATE_EXTRA_PROFILE_CACHE:t&&t.userId&&this.data.has(t.userId)&&this.getExtraInfo(t.userId);break;case Os.GeneralActions.NETWORK_STATUS_CHANGED:break;case Os.FriendsAction.FRIENDS_CHANGE_INFO:if(t)for(const e of t)this.data.has(e.userId)&&this.getUserInfo(e.userId)}}invitationEventHandler(e){switch(e.type){case er.m.ReceiveAddFriendEvent:Array.isArray(e.payload)&&e.payload.forEach((e=>{const t=e.dataInfo.userId;e&&e.dataInfo&&(this._cachedFriendRequest[t]=e.dataInfo,this.data.has(t)&&this._updateVersion(t))}));break;case er.m.UndoAddFriendEvent:case er.m.AcceptAddFriendEvent:case er.m.RejectAddFriendEvent:case er.m.UndoSentRequestFriendEvent:this._cachedFriendRequest[e.payload]&&(delete this._cachedFriendRequest[e.payload],this.data.has(e.payload)&&this._updateVersion(e.payload))}}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||tC)||tC)||tC);var lC,cC=s("786D");Object(Hs.b)(cC.a)(lC=Reflect.metadata("design:type",Function)(lC=Reflect.metadata("design:paramtypes",[])(lC=class{constructor(){this.name=cC.b,this.key="convId",this.didInit=!1,this.data=void 0,this._cachedFriendRequest={},this._dispatch=void 0,this._genMessageServer=void 0,this._connectClose=[],this._logger=void 0,this.type=void 0,this.data=new Map,this.eventHandler=this.eventHandler.bind(this)}get Logger(){return this._logger||(this._logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(this.name,["group-controller"])),this._logger}init(e){this.didInit||(this.didInit=!0)}clearState(e){this.data.has(e)&&this.data.delete(e)}bindDispatch(e){this._dispatch=e,Cs.default.subscribe(this.eventHandler)}unbind(){this._dispatch=null,this._genMessageServer=null,this._connectClose=[],this.data.clear(),Cs.default.unsubscribe(this.eventHandler)}dispatch(e){this._dispatch?this._dispatch(e):this.Logger.zsymb(0,"WzdroE","Lost dispatch")}bindGenMessageServer(e){this._genMessageServer=e}connectCloseModalCallback(e){this._connectClose.push(e)}_updateData(e,t,s){const i=this.data.get(e);i?this.data.set(e,Object(f.a)(Object(f.a)({},i),{},{[t]:i&&i[t]?Is.default.deepMerge(i[t],s):s})):this.data.set(e,{[t]:s}),Object(Kt.g)(cC.b,e)}_udapteInfoData(e,t){var s;const i=this.data.get(e);return null!=i&&null!==(s=i.info)&&void 0!==s&&s.avatar&&(t.avatar=i.info.avatar),this._updateData(e,"info",t)}async getGroupInfo(e){const t=async()=>{try{const t=await oi.default.getFullInfoGroupById(e,R.SRC_GET_PROFILE.FORCE_GET);return t&&this._udapteInfoData(e,t),t}catch(t){return this.Logger.zsymb(0,"4XrBCO","[getGroupInfo]",t),oi.default.getGroupByIdSync(e,void 0)}},s=oi.default.getGroupByIdSync(e,void 0);return this.data.has(e)?(this._udapteInfoData(e,s),s):(this._udapteInfoData(e,s),await t())}selectConversation(e){const t=this.data.get(e);if(t){Vt.default.logAction(1460204),this.dispatch({type:Os.ConversationListActions.SELECT_CONVERSATION,payload:t}),Kn.a.openConversation(e);const s=$e.p.getSelectConversationSource();s&&Vt.default.logAction(s)}Gt.ModalManagerV2.closeAllModal()}async addGroupAdmin(e,t,s){try{return await oi.default.addGroupAdmin(t,s),!0}catch(i){if(this.Logger.zsymb(18,"WFfOex","[addGroupAdmin] error",i),!i)return;if(i.error_code){let s="";switch(i.error_code){case 161:s=$t.default.str(wr.a.get("STR_GROUP_NO_EXIST",t));break;case 166:s=$t.default.str(wr.a.get("STR_GROUP_NO_PERMISION",t));break;default:s=$t.default.str(wr.a.get("STR_ADD_ADMIN_TOAST_UNSUCCESS",t))+" ("+i.error_code+")"}rC.a(e,void 0,s)}else i.code&&"ERR_NO_NETWORK"===i.code&&rC.a(e,"STR_CONNECTION_ERROR")}return!1}async changeGroupOwner(e,t,s,i=!1){var a;let n=!1;const r=(null===(a=oi.default.getGroupByIdSync(t))||void 0===a?void 0:a.topMember)||[];for(const l of r)if(l.id===s){n=!0;break}if(!n)return void rC.b($t.default.trans(wr.a.get("STR_NO_LONGER_MEMBER_IN_GROUP",t),iC.h(s)));let o=t;o&&o.startsWith(R.GROUPID_PREFIX)&&(o=o.slice(1));try{return await ys.default.changeGroupOwner(o,s),this._updateData(t,"info",{creatorId:s}),this.dispatch({type:Os.ConversationListActions.UPDATE_GROUP_OWNER,payload:{userId:t,creatorId:s}}),i&&await this.leaveGroup(e,o),!0}catch(d){return rC.a(e,wr.a.get("STR_CHANGE_GROUP_OWNER_FAIL",t)),!1}}async leaveGroup(e,t){try{await ys.default.leaveGroup(t)}catch(s){s&&"ERR_NO_NETWORK"==s.code&&rC.a(e,"STR_CHECK_NET")}}eventHandler(e,t){switch(e){case Os.FetchActions.UPDATE_NAME:t.constructor===Object&&this.data.has(t.userId)?this.getGroupInfo(t.userId):t.constructor===Array&&t.forEach((e=>{this.data.has(e)&&this.getGroupInfo(e)}));break;case Os.FetchActions.GROUP_UPDATED:if(t){let{topMember:e=[],userId:i,isGroup:a}=t;const n=this.data.get(i);if(n&&a){var s;let t=null===(s=n.info)||void 0===s?void 0:s.topMember;(null==e?void 0:e.length)>0&&(t=e),this._updateData(i,"info",{topMember:t}),this.getGroupInfo(i)}}break;case Os.FetchActions.UPDATE_GROUP_SETTING:if(t&&t.data){let e=t.data.groupId;if(e&&(e=R.GROUPID_PREFIX+e,this.data.has(e))){var i,a;const s=t.data.groupSetting||(null===(i=this.data.get(e))||void 0===i||null===(a=i.info)||void 0===a?void 0:a.setting);this._updateData(e,"info",{newSetting:s})}}break;case Os.GroupsAction.GROUPS_CHANGE_INFO:t&&t.forEach((e=>{this.data.has(e)&&this.getGroupInfo(e)}));break;case Os.FetchActions.DELETE_CONVERSATION:case Os.FetchActions.GROUP_LEAVE:this.data.has(t)&&this._connectClose.forEach((e=>e()));break;case Os.ConversationListActions.UPDATE_GROUP_OWNER:t&&this.data.has(t.userId)&&this._updateData(t.userId,"info",{creatorId:t.creatorId})}}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||lC)||lC);var hC,uC=s("o5gc");Object(Hs.b)(uC.d)(hC=Reflect.metadata("design:type",Function)(hC=Reflect.metadata("design:paramtypes",[])(hC=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.genId=void 0,this.name=uC.a,this.key="userId",this.data=new Map,this.genId=new Gh.a}init(){throw new Error("Method not implemented.")}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.reportV2,[this.name])),this.logger}getList(){return Array.from(this.data.keys())}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"ufGvTc","Get report abuse data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"2mn7_t","Get report abuse data list failed",e)}signalUpdateItem(e){Object(Kt.g)(this.name,e)}getOrCreateItem(e){let t=this.data.get(e);return t||(t={userId:e,expandAttachment:!1,selectedPhotos:[],selectedMessages:[]}),t}onOpenReport(e){ms.default.report_v2.enable&&this.Logger.zsymb(0,"KzWSvs","open report",e)}onReportDidOpen(e){if(ms.default.report_v2.enable&&!this.data.has(e)){const t={userId:e,expandAttachment:!1,selectedPhotos:[],selectedMessages:[]};this.data.set(e,t),this.signalUpdateItem(e)}}onCloseReport(e){this.data.has(e)&&(this.cleanUpItem(e),Object(Kt.e)(this.name,e),this.Logger.zsymb(0,"Ws0BeA","close report",e))}cleanUpItem(e){const t=this.data.get(e);t&&(t.selectedPhotos.forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.delete(e))}toggleAttachment(e){const t=this.getOrCreateItem(e);this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{expandAttachment:!t.expandAttachment})),this.signalUpdateItem(e)}selectReason(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{reasonId:t})),this.signalUpdateItem(e)}onSelectedPhotos(e,t){const s=this.getOrCreateItem(e),i=t.map((({blob:e,filename:t,type:s})=>({blob:e,id:this.genId.next(),url:URL.createObjectURL(e),filename:t,type:s})));this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{selectedPhotos:s.selectedPhotos.concat(i)})),this.signalUpdateItem(e)}onDeselectPhoto(e,t){const s=this.getOrCreateItem(e),i=[...s.selectedPhotos],a=i.findIndex((e=>e.id===t));if(a>=0){i.splice(a,1).forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{selectedPhotos:i})),this.signalUpdateItem(e)}}clearAllAttachedPhotos(e){const t=this.getOrCreateItem(e);t.selectedPhotos.forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedPhotos:[]})),this.signalUpdateItem(e)}onSelectedMessages(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{selectedMessages:t})),this.signalUpdateItem(e)}clearAllAttachedMessages(e){const t=this.getOrCreateItem(e);this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedMessages:[]})),this.signalUpdateItem(e)}changeDescription(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{description:t})),this.signalUpdateItem(e)}})||hC)||hC);var gC,mC=s("7upJ");Object(i.singleton)(uC.e)(gC=Reflect.metadata("design:type",Function)(gC=Reflect.metadata("design:paramtypes",[])(gC=class{constructor(){this.logger=void 0,this.name=void 0,this.name=uC.b}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.reportV2,[this.name])),this.logger}getRelatedStatus(e){return{blocked:zt.default.isBlocked(e),unfriended:!zt.default.isFriend(e)}}async blockAfterReport(e){try{await zt.default.blockFriend(e,R.SET_BLOCK)}catch(t){throw this.Logger.zsymb(18,"5btD5t","block after report failed",e,t),t}}async unfriendAfterReport(e){try{await zt.default.removeFriend(e)}catch(t){throw this.Logger.zsymb(18,"uFnjFa","unfriend after report failed",e,t),t}}getReportReasonFromId(e,t){const s=mC.a.getSortedAbuseList(e);if(!Array.isArray(s))return null;const i=s.find((e=>e.id===t));return i?i[$t.default.getCurrentLanguageName()]:null}getContentMessageToReport(e){const{message:t,msgType:s}=e;if("object"==typeof t)switch(s){case R.MSG_LINK_CLIENT:case R.MSG_CONTACT:return t.title||t.href;case R.MSG_PHOTO:case R.MSG_PHOTO_2:case R.MSG_PHOTO_GROUP:case R.MSG_VIDEO:return t.oriUrl||t.title;case R.MSG_VOICE:return t.href;default:return t.title}return t}async submitReport(e){const t=new FormData,s={idTo:e.userId,objId:"person.profile",reason:String(e.reasonId),content:e.description};if(e.selectedPhotos.length){const i=e.selectedPhotos.map((e=>({filename:e.filename,type:e.type})));s.imgList=JSON.stringify(i),e.selectedPhotos.forEach((({blob:e},s)=>{t.append(`img${s}`,e)}))}if(e.selectedMessages.length){const t=e.selectedMessages.map((e=>({gmi:e.msgId,msg:this.getContentMessageToReport(e)}))).filter((({msg:e})=>!!e));s.msgList=JSON.stringify(t)}t.append("params",encodeURIComponent(Is.default.encodeAES(JSON.stringify(s))));try{const s=await ys.default.reportUserV2(t);this.Logger.zsymb(0,"WLLmHN","submit success",e.userId,s)}catch(i){throw this.Logger.zsymb(18,"TJHyjM","submit failed",e.userId,i),i}}})||gC)||gC);var pC=s("BpN3"),fC=s("UJhs");function vC(e){return"object"==typeof e&&!!e&&e.hasOwnProperty("loading")&&"boolean"==typeof e.loading&&e.type in fC.d&&e.hasOwnProperty("data")&&"object"==typeof e.data&&!!e.data}const bC="SEND_INPUT_PREVIEW",yC={[bC]:{feature:Vt.FeaturesInfo.InputBoxPreview,subType:1}};var IC=function(e){return e[e.Chat=1]="Chat",e[e.Group=2]="Group",e[e.MyCloud=3]="MyCloud",e[e.OA=4]="OA",e}(IC||{});class _C{}_C.actionlogSendPreview=e=>{requestIdleCallback((()=>{try{var t;if(!e.length)return;const a=e.filter((e=>e.type===fC.d.PHOTO));if(!a.length)return;let n;const r=null==a||null===(t=a[0])||void 0===t?void 0:t.toUid;n=Object(iC.z)(r)?IC.OA:Is.default.isGroup(r)?IC.Group:Object(iC.f)()===r?IC.MyCloud:IC.Chat;const o=e.length,d=[];for(let e=0;e<a.length;e++){var s,i;const t=a[e],n={photo_position:e+1,caption_length:(null==t||null===(s=t.caption)||void 0===s?void 0:s.length)||0,is_caption_form:null!=t&&null!==(i=t.caption)&&void 0!==i&&i.length?1:0};d.push(n)}const l={total_item_in_group:o,caption_info:d,chat_type:n};_C._actionlogSendInputPreview(bC,l)}catch(a){Me.dangerouslyLogConsole.error("InputPreviewActionLog.logSendPreview",a)}}),{timeout:5e3})},_C._actionlogSendInputPreview=async(e,t)=>{const s=yC[e].feature,i=yC[e].subType;Vt.default.logActionInfoV2(s,i,t)};var CC,OC=_C;Object(i.injectable)()(CC=Object(Hs.b)(pC.b)(CC=class{constructor(){this._eventEmitter=new Kd.a,this.addPreviewItem=e=>{var t;Object(K.a)(function(e){return vC(e)&&e.type!==fC.d.PLACEHOLDER}(e),"invalid item for input preview, must be InputPreviewData");const s=e,i=s.data,a=i.toUid,n=this.mayInitState(a),r=null!==(t=s.previewId)&&void 0!==t?t:i.clientId,o=n.oriItems.length>0?[...n.oriItems]:[...n.items],d=o.findIndex((e=>e.previewId===r)),l=s.data.clientId;(this.removedItems.get(a)||new Set).has(l)||(-1!==d?o[d]=Object(f.a)(Object(f.a)(Object(f.a)({},n.items[d]),s),{},{previewId:r}):o.push(s),this.data.set(a,Object(f.a)(Object(f.a)({},n),{},{items:o,oriItems:o})),Object(Kt.g)(this.name,a),this.emit("ON_ADD_INPUT_PREVIEW",{conversationId:a}))},this.getOrderedItemsForSending=e=>{const t=this.getOrderedItems(e).map((e=>e&&e.type===fC.d.GIF?Object(f.a)(Object(f.a)({},e),{},{type:fC.d.PHOTO}):e));return OC.actionlogSendPreview(t.map((e=>Object(f.a)({},e)))),t},this.removePreviewItemById=(e,t)=>{const s=this.data.get(e);if(!s)return;const i=s.items.filter((e=>e.data.clientId!==t)),a=s.oriItems.filter((e=>e.data.clientId!==t));this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{items:i,oriItems:a})),Object(Kt.g)(this.name,e)},this.name=pC.a,this.data=new Map,this.removedItems=new Map,this.key="conversationId"}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter.emit(e,t)}hasPreviewItems(e){const t=this.data.get(e);return!!t&&t.items.length>0}selectItem(e,t){if(!e||!t)return;const s=this.mayInitState(e);this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{selectedItem:t})),Object(Kt.g)(this.name,e)}selectPreviousItem(e){const t=this.mayInitState(e),s=t.items,i=t.selectedItem;if(!i)return;const a=s.findIndex((e=>e.data.clientId===i.cliMsgId));if(-1===a)return;const n=Math.max(a-1,0);this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedItem:s[n]})),Object(Kt.g)(this.name,e)}selectNextItem(e){const t=this.mayInitState(e),s=t.items,i=t.selectedItem;if(!i)return;const a=s.findIndex((e=>e.data.clientId===i.cliMsgId));if(-1===a)return;const n=Math.min(a+1,s.length-1);this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedItem:s[n]})),Object(Kt.g)(this.name,e)}addPlaceholder(e,t){Object(K.a)("string"==typeof e&&!!e,"conversationId must be string"),Object(K.a)("object"==typeof t&&!(null==t||!t.clientId),"invalid item for input preview placeholder");const s=this.mayInitState(e),i={loading:!0,type:fC.d.PLACEHOLDER,previewId:t.clientId,data:{clientId:t.clientId}};this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{items:[...s.items,i],oriItems:[...s.oriItems,i]})),Object(Kt.g)(this.name,e)}getPreviewItemsCount(e){var t,s;return null!==(t=null===(s=this.data.get(e))||void 0===s?void 0:s.items.length)&&void 0!==t?t:0}getOrderedItems(e){const t=this.data.get(e);if(!t)return[];let s=[];const i=t.oriItems.filter((e=>{const t=e.type!==fC.d.PLACEHOLDER;return t&&s.push(e.data.clientId),t})).map((e=>{var s;const i=(null===(s=t.caption[e.data.clientId])||void 0===s?void 0:s.saved)||"",a=Object(f.a)(Object(f.a)({},e.data),{},{caption:i});return Object(f.a)(Object(f.a)({},e),{},{data:a})}));s=s.sort(((e,t)=>e-t));return i.map(((e,t)=>Object(f.a)(Object(f.a)({},e.data),{},{clientId:s[t]})))}getRawOrderedItems(e){const t=this.data.get(e);return t?t.oriItems:[]}updateOrder(e,t){const s=this.mayInitState(e);Object(K.a)(Array.isArray(t),`invalid items for input preview at ${e}`),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{oriItems:t})),Object(Kt.g)(this.name,e)}removePreviewItem(e,t){const s=this.data.get(e);if(!s)return;const i=[...s.items],a=[...s.oriItems],n=i[t];if(!n)return;const r=a.indexOf(n);i.splice(t,1),-1!==r&&a.splice(r,1),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{items:i,oriItems:a})),n.type===fC.d.PHOTO&&URL.revokeObjectURL(n.data.img),Object(Kt.g)(this.name,e),this.emit("ON_REMOVE_INPUT_PREVIEW",{conversationId:e})}removeAllItems(e,t=!1){const s=this.data.get(e);if(!s)return;const i=this.removedItems.get(e)||new Set;if(!t)for(let a of s.items)i.add(a.data.clientId),a.type===fC.d.PHOTO&&URL.revokeObjectURL(a.data.img);this.removedItems.set(e,i),this.data.delete(e),Object(Kt.g)(this.name,e),this.emit("ON_REMOVE_INPUT_PREVIEW",{conversationId:e})}saveDraft(e,t,s){const i="string"==typeof s?s.trimStart().trimEnd():"",a=this.mayInitState(e);Object(K.a)(!!a,`invalid state when saveDraft for conversationId ${e}`),Object(K.a)("string"==typeof i,`invalid draft for conversationId ${e}`);let n=a.caption[t]||{saved:"",draft:""};if(n.saved===i&&n.draft===i)return;n=Object(f.a)(Object(f.a)({},n),{},{draft:i});const r=Object(f.a)(Object(f.a)({},a.caption),{},{[t]:n}),o=new Set(a.unsavedChanges);n.saved!==n.draft?o.add(t):o.delete(t),this.data.set(e,Object(f.a)(Object(f.a)({},a),{},{caption:r,unsavedChanges:Array.from(o)})),Object(Kt.g)(this.name,e)}applyDraft(e,t){return Object(K.a)("string"==typeof e&&!!e,"InputCaption: conversationId must be string"),"number"==typeof t?this.applyDraftSingle(e,t):this.applyDraftMulti(e)}resetSelectedItem(e){if(!e)return;const t=this.mayInitState(e);this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{selectedItem:null})),Object(Kt.g)(this.name,e)}applyDraftSingle(e,t){const s=this.mayInitState(e);Object(K.a)(!!s,`invalid state when addCaption for conversationId ${e}`);let i=s.caption[t];if(!i||i.saved===i.draft)return;const a=i.draft||"";i=Object(f.a)(Object(f.a)({},i),{},{saved:a});const n=Object(f.a)(Object(f.a)({},s.caption),{},{[t]:i}),r=new Set(s.unsavedChanges);r.delete(t),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{caption:n,unsavedChanges:Array.from(r)})),Object(Kt.g)(this.name,e)}applyDraftMulti(e){const t=this.mayInitState(e);Object(K.a)(!!t,`invalid state when addCaption for conversationId ${e}`);const s=Object(f.a)({},t.caption);Object.keys(s).forEach((e=>{const t=s[e];if(!t||t.saved===t.draft)return;const i=t.draft||"";s[e]=Object(f.a)(Object(f.a)({},t),{},{saved:i})}));const i=Object(f.a)(Object(f.a)({},t),{},{caption:s,unsavedChanges:[]});this.data.set(e,i),Object(Kt.g)(this.name,e)}discardDraftedCaption(e,t){return Object(K.a)("string"==typeof e&&!!e,"InputCaption: conversationId must be string"),"number"==typeof t?this.discardDraftedCaptionSingle(e,t):this.discardDraftedCaptionMulti(e)}discardDraftedCaptionSingle(e,t){const s=this.mayInitState(e);if(!s)return;const i=s.caption[t];if(!i||!i.draft)return;const a=s.caption[t],n=Object(f.a)(Object(f.a)({},s.caption),{},{[t]:Object(f.a)(Object(f.a)({},a),{},{draft:null==a?void 0:a.saved})}),r=new Set(s.unsavedChanges);r.delete(t),this.data.set(e,Object(f.a)(Object(f.a)({},s),{},{caption:n,unsavedChanges:Array.from(r)})),Object(Kt.g)(this.name,e)}discardDraftedCaptionMulti(e){let t=this.data.get(e);if(!t)return;const s=Object(f.a)({},t.caption);if(s)for(const i in s)s[i].draft=s[i].saved;t=Object(f.a)(Object(f.a)({},t),{},{caption:s,unsavedChanges:[]}),this.data.set(e,t),Object(Kt.g)(this.name,e)}getCaption(e,t){return this.mayInitState(e).caption[t]}_listenEvents(){}mayInitState(e){let t=this.data.get(e);return t||(t={conversationId:e,items:[],oriItems:[],selectedItem:null,caption:{},unsavedChanges:[]},this.data.set(e,t)),t}init(){this._listenEvents()}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||CC);var SC=s("ONNR"),EC=s("1Q0E"),MC=s("kCjk");function TC(e,t){switch(t){case"byte-to-mb":return e/1024/1024;case"kb-to-mb":return e/1024;default:return}}function wC(e,t=""){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")+t}function RC(e){const t=new URL(e);return"/"!==t.pathname?t.pathname:t.hostname}var LC=s("XnIt"),FC=s("CaBZ"),DC=s("mHfx");let AC,jC;try{AC=$znode.fs,jC=$znode.path}catch(PT){}async function PC(e){return new Promise((t=>{try{AC.readdir(e,(async(s,i)=>{if(s)return t(0);let a=0;for(let t=0;t<i.length;t++){const s=i[t],n=jC.join(e,s),r=AC.statSync(n);if(Object(DC.a)(r)){a+=await PC(n)}a+=r.size}t(a)}))}catch(s){t(0)}}))}var NC,UC=new class{constructor(){this.lastFrameTime=0,this.fps=0,this.pause=!0}loop(e){if(this.pause)return;const t=e;if(0===this.lastFrameTime)return this.lastFrameTime=t,void requestAnimationFrame(this.loop.bind(this));const s=t-this.lastFrameTime;s>0&&(this.fps=Math.round(1e3/s),this.lastFrameTime=t),requestAnimationFrame(this.loop.bind(this))}start(){this.pause=!1,requestAnimationFrame(this.loop.bind(this))}stop(){this.lastFrameTime=0,this.fps=0,this.pause=!0}get value(){return this.fps}};const kC="z_m_h_",BC="z_m_h_i___",GC={CPU:!0,GPU:!0,RAM:!0,FPS:!0,"JS Heap":!0,"Root Render":!0,LCP:!0};Object(Hs.b)(EC.b)(NC=Object(i.injectable)()(NC=Object(i.singleton)()(NC=Reflect.metadata("design:type",Function)(NC=Reflect.metadata("design:paramtypes",[])(NC=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.isStarted=!1,this.userId=void 0,this.monitorItems=[],this.showMonitorItems=new Map,this.rootRenderInitTime=vi.a.now(),this.rootRenderNumber=1,this.lcpMetric=void 0,this.intervalCheck=void 0,this.intervalCheckSteps=0,this.data={isShowZPCHealth:!1,monitorItemForUIs:[]},this.usageMonitor=void 0,this.name=EC.a,this.key=EC.a}initialize(e){this.isStarted||(this.isStarted=!0,function(){const e=i.ModuleContainer.resolve(FC.b);e.registerMonitorItem({expectedOrderPosition:1,title:"Database",description:"Cache & IndexedDB",getValue:async()=>{var e,t,s;let i=(null===(e=await(null===(t=navigator.storage)||void 0===t||null===(s=t.estimate)||void 0===s?void 0:s.call(t)))||void 0===e?void 0:e.usage)||0;return i=Math.round(TC(i,"byte-to-mb")||0),i},getType:e=>e>=200&&e<=500?"medium":e>500?"high":"low",getContent:e=>wC(e," MB"),checkSteps:10}),e.registerMonitorItem({expectedOrderPosition:2,title:"DOM",description:"DOM nodes",getValue:()=>document.getElementsByTagName("*").length||0,getType:e=>e>=3e3&&e<=6e3?"medium":e>6e3?"high":"low",getContent:e=>wC(e," nodes"),checkSteps:2}),e.registerMonitorItem({expectedOrderPosition:3,title:"Temp Files",description:"ZaloTemp & zTemp",getValue:async()=>{try{const e=await Object(T_.getZaloTempDir)(),t=await PC(e),s=await Object(T_.getzTempDir)(),i=await PC(s);return Math.round(TC(t+i,"byte-to-mb")||0)}catch(e){return 0}},getType:e=>e>=50&&e<=100?"medium":e>100?"high":"low",getContent:e=>wC(e," MB"),checkSteps:100}),e.registerMonitorItem({expectedOrderPosition:6,title:"Custom Domains",description:"Count custom domains usage",getValue:async()=>{const e=i.ModuleContainer.resolve(LC.a).getDomainConfig();let t=0;if(!e)return t;for(const s in e)e.hasOwnProperty(s)&&e[s].useDevDomain&&t++;return t},getType:e=>"low",getContent:e=>wC(e,""),checkSteps:2})}());const t=this.getStorage().getItem(kC);this.data.isShowZPCHealth="1"===t;const s=this.getStorage().getItem(BC);if(s){s.split(",").forEach((e=>{e&&this.showMonitorItems.set(e,1)}))}this.data.isShowZPCHealth&&Object(MC.b)()&&(Object(SC.a)((e=>{this.lcpMetric=e}),{reportAllChanges:!0}),this.userId=e,this.startHealthCheck())}destroy(){this.stopHealthCheck()}registerMonitorItem(e){const t=`${e.expectedOrderPosition||""}_${e.title.replace(" ","")}`,s=Object(f.a)(Object(f.a)({},e),{},{id:t});this.monitorItems.push(s),this.monitorItems=this.monitorItems.sort(((e,t)=>e.expectedOrderPosition&&t.expectedOrderPosition?e.expectedOrderPosition-t.expectedOrderPosition:0))}addRootRender(){this.data.isShowZPCHealth&&Object(MC.b)()&&this.rootRenderNumber++}resetRootRender(){this.rootRenderNumber=1}startHealthCheck(){this.intervalCheck||(UC.start(),this.getMonitorItems(this.userId),this.intervalCheck=setInterval((()=>{this.getMonitorItems(this.userId),this.intervalCheckSteps++}),MC.a.INTERVAL_CHECK_TIME))}stopHealthCheck(){UC.stop(),this.rootRenderNumber=1,this.intervalCheck&&(clearInterval(this.intervalCheck),this.intervalCheck=void 0,this.intervalCheckSteps=0)}toggleZPCHealth(){this.data.isShowZPCHealth=!this.data.isShowZPCHealth,this.getStorage().setItem(kC,this.data.isShowZPCHealth?"1":"0"),this.data.isShowZPCHealth||this.stopHealthCheck(),Object(Kt.g)(this.name,"")}getMonitorList(){return this.monitorItems.map((e=>({id:e.id,title:e.title,isShow:!(!this.showMonitorItems.get(e.id)&&!GC[e.title])})))}showZPCHealthItem(e,t){if(!e)return;t?this.showMonitorItems.set(e,1):this.showMonitorItems.delete(e);let s="";this.showMonitorItems.forEach(((e,t)=>{s+=t+","})),this.getStorage().setItem(BC,s),this.stopHealthCheck(),this.startHealthCheck()}async getMonitorItems(e){var t,s,i,a;const n=await $zperf.getCpuInfos();let r=0,o=0,d=0;null==n||n.forEach((e=>{var t,s;const i=(null==e||null===(t=e.cpu)||void 0===t?void 0:t.percentCPUUsage)||0,a=(null==e||null===(s=e.memory)||void 0===s?void 0:s.workingSetSize)||0;"GPU"!==e.type?(r+=i,d+=a):o+=i})),r=Math.round(r),o=Math.round(o),d=Math.round(TC(d,"kb-to-mb")||0);let l=(null===(t=performance.memory)||void 0===t?void 0:t.usedJSHeapSize)||0;l=Math.round(TC(l,"byte-to-mb")||0);const c=UC.value;let h=(null===(s=await(null===(i=navigator.storage)||void 0===i||null===(a=i.estimate)||void 0===a?void 0:a.call(i)))||void 0===s?void 0:s.usage)||0;h=Math.round(TC(h,"byte-to-mb")||0);const u=Math.round((vi.a.now()-this.rootRenderInitTime)/1e3/60)||1,g=Math.round(this.rootRenderNumber/u),m=[...[{id:"0_CPU",title:"CPU",description:"CPU usage",getValue:()=>r,getType:e=>e>=20&&e<=40?"medium":e>40?"high":"low",getContent:e=>wC(e," %"),checkSteps:2},{id:"0_GPU",title:"GPU",description:"GPU usage",getValue:()=>o,getType:e=>e>=10&&e<=30?"medium":e>30?"high":"low",getContent:e=>wC(e," %"),checkSteps:2},{id:"0_FPS",title:"FPS",description:"Frame Per Second",getValue:()=>c,getType:e=>e>=20&&e<=30?"medium":e<20?"high":"low",getContent:e=>wC(e),checkSteps:1},{id:"0_RAM",title:"RAM",description:"RAM usage",getValue:()=>d,getType:e=>e>=500&&e<=1e3?"medium":e>1e3?"high":"low",getContent:e=>wC(e," MB"),checkSteps:2},{id:"0_JSHeap",title:"JS Heap",description:"JS Heap usage",getValue:()=>l,getType:e=>e>=200&&e<=300?"medium":e>300?"high":"low",getContent:e=>wC(e," MB"),checkSteps:2},{id:"0_RootRender",title:"Root Render",description:"Root Render in minutes",getValue:()=>g,getType:e=>e>=10&&e<=20?"medium":e>20?"high":"low",getContent:e=>wC(e," times / minute"),checkSteps:2},{id:"0_LCP",title:"LCP",description:"Largest Contentful Paint",getValue:()=>{var e;return Math.round(((null===(e=this.lcpMetric)||void 0===e?void 0:e.value)||0)/1e3)},getType:e=>{var t;switch(null===(t=this.lcpMetric)||void 0===t?void 0:t.rating){case"poor":return"high";case"needs-improvement":return"medium";default:return"low"}},getContent:e=>wC(e," s"),checkSteps:2}],...this.monitorItems],p=[];for(let y=0;y<m.length;y++){const t=m[y];let s=!1;s=!(!this.showMonitorItems.get(t.id)&&!GC[t.title]);let i,a,n=0;var f,v,b;if(s)if(this.data.monitorItemForUIs[y]&&this.intervalCheckSteps%(t.checkSteps||1)!=0)i=this.data.monitorItemForUIs[y].type,a=this.data.monitorItemForUIs[y].content;else n=await(null===(f=t.getValue)||void 0===f?void 0:f.call(t,e))||0,i=null===(v=t.getType)||void 0===v?void 0:v.call(t,n),a=null===(b=t.getContent)||void 0===b?void 0:b.call(t,n);const r={id:t.id,title:t.title,description:t.description,type:i,content:a,isShow:s,checkTime:(t.checkSteps||1)*MC.a.INTERVAL_CHECK_TIME};p.push(r)}this.data.monitorItemForUIs=p,Object(Kt.g)(this.name,"")}getStorage(){return S.default.getInstance()}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||NC)||NC)||NC)||NC);var xC=s("zdwi"),zC=s("E/Lo");const VC="1",HC={windowId:VC,name:"ZPC_HEALTH"},$C={windowId:VC,name:"METRICS"};var WC,qC=s("Igfx"),KC=s("noAy");const ZC="z_m_h_f_",QC="z_m_h_r_",JC="z_m_h_r_w_";Object(Hs.b)(xC.a)(WC=Object(i.injectable)()(WC=Object(i.singleton)()(WC=function(e,t){return Object(i.inject)(KC.b)(e,void 0,0)}(WC=Reflect.metadata("design:type",Function)(WC=Reflect.metadata("design:paramtypes",[void 0===KC.b?Object:KC.b])(WC=class{constructor(e){this.resourceWarning=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!1,isShowRenderingDebugger:!1,isShowReactiveLogger:!1,isShowResourceWarning:!1},this.observeRendering=void 0,this.name=xC.b,this.key=xC.b}initialize(){if(!Object(MC.b)())return;this.observeRendering=this.observeRendering?this.observeRendering:Object(zC.b)(),Gt.ModalManagerV2.addModal(Object(f.a)(Object(f.a)({},HC),{},{altWindowId:void 0})),Gt.ModalManagerV2.subscribeTriggers({windowId:VC,name:HC.name,trigger:e=>{}});const e=this.getStorage().getItem(ZC);var t;(this.data.isShowRenderingDebugger="1"===e,"1"===e)&&(null===(t=this.observeRendering)||void 0===t||t.observe());const s=this.getStorage().getItem(QC);this.data.isShowReactiveLogger="1"===s,this.data.isShowReactiveLogger?qC.a.enable():qC.a.disable();const i=this.getStorage().getItem(JC);this.data.isShowResourceWarning=null!==i?"1"===i:this.data.isShowResourceWarning,this.data.isShowResourceWarning?this.resourceWarning.enable():this.resourceWarning.disable(),Object(Kt.g)(this.name,"all")}destroy(){0}showZPCHealthPopup(e){Object(MC.b)()&&(e?Gt.ModalManagerV2.openModal(Object(f.a)(Object(f.a)({},HC),{},{windowId:VC,params:null})):Gt.ModalManagerV2.closeModal(Object(f.a)(Object(f.a)({},HC),{},{windowId:VC})),this.data.isShow=e,Object(Kt.g)(this.name,"all"))}setIsShowRenderingDebugger(e){var t,s;(this.data.isShowRenderingDebugger=e,this.getStorage().setItem(ZC,e?"1":"0"),e)?null===(t=this.observeRendering)||void 0===t||t.observe():null===(s=this.observeRendering)||void 0===s||s.disconnect();Object(Kt.g)(this.name,"all")}setIsShowReactiveLogger(e){this.data.isShowReactiveLogger=e,this.getStorage().setItem(QC,e?"1":"0"),e?qC.a.enable():qC.a.disable(),Object(Kt.g)(this.name,"all")}setIsShowResourceWarning(e){this.data.isShowResourceWarning=e,this.getStorage().setItem(JC,e?"1":"0"),e?this.resourceWarning.enable():this.resourceWarning.disable(),Object(Kt.g)(this.name,"all")}getStorage(){return S.default.getInstance()}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||WC)||WC)||WC)||WC)||WC);var YC,XC=s("Bwur");Object(Hs.b)(XC.b)(YC=Object(i.injectable)()(YC=Object(i.singleton)()(YC=Reflect.metadata("design:type",Function)(YC=Reflect.metadata("design:paramtypes",[])(YC=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!1},this.name=XC.a,this.key=XC.a}initialize(){Object(MC.b)()&&(Gt.ModalManagerV2.addModal(Object(f.a)(Object(f.a)({},$C),{},{altWindowId:void 0})),Gt.ModalManagerV2.subscribeTriggers({windowId:VC,name:$C.name,trigger:e=>{}}))}destroy(){0}showMetricsPopup(e){Object(MC.b)()&&(e?Gt.ModalManagerV2.openModal(Object(f.a)(Object(f.a)({},$C),{},{windowId:VC,params:null})):Gt.ModalManagerV2.closeModal(Object(f.a)(Object(f.a)({},$C),{},{windowId:VC})),this.data.isShow=e,Object(Kt.g)(this.name,"all"))}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||YC)||YC)||YC)||YC);var eO=s("1UUk");class tO{constructor(e){this._queue=void 0,this._maxSize=void 0,this._queue=[],this._maxSize=null==e?void 0:e.maxSize}enqueue(e){this._maxSize&&this._queue.length>=this._maxSize&&this._queue.shift(),this._queue.push(e)}dequeue(){return this._queue.shift()}peek(){return this._queue[0]}isEmpty(){return 0===this._queue.length}get length(){return this._queue.length}clear(){this._queue=[]}toArray(){return this._queue}}var sO,iO=s("WZ0o");const aO="requests / second",nO=1e3;Object(Hs.b)(KC.b)(sO=Object(i.injectable)()(sO=Object(i.singleton)()(sO=function(e,t){return Object(i.inject)(eO.b)(e,void 0,0)}(sO=Reflect.metadata("design:type",Function)(sO=Reflect.metadata("design:paramtypes",[void 0===eO.a?Object:eO.a])(sO=class{constructor(e){this.databaseManager=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={network:{totalRequestInLiveTime:0,queue:new tO,hitCount:0,error:void 0},database:{totalRequestInLiveTime:0,queue:new tO,hitCount:0,error:void 0}},this.warningConfigs=MC.c,this.isEnable=void 0,this.initTime=void 0,this.timeoutSignals={},this.enableLogEachRequest=void 0,this.hitQueue=new tO({maxSize:20}),this.observePerformance=void 0,this.name=KC.a,this.key=KC.a,this.dbQueryExecListener=this.dbQueryExecListener.bind(this)}enable(){Object(MC.b)()&&(this.isEnable||(this.isEnable=!0,this.setup()))}disable(){var e;this.isEnable=!1,null===(e=this.observePerformance)||void 0===e||e.disconnect(),this.databaseManager.removeEventListener(Be.b.QueryExec,this.dbQueryExecListener),this.resetData()}getData(){return this.data}resetNetworkError(){this.data.network.totalRequestInLiveTime=0,this.data.network.error=void 0,Object(Kt.g)(this.name,"all")}resetDatabaseError(){this.data.database.totalRequestInLiveTime=0,this.data.database.error=void 0,Object(Kt.g)(this.name,"all")}setWarningConfigs(e){this.warningConfigs=e}setEnableLogEachRequest(e){this.enableLogEachRequest=e}getHitQueue(){return this.hitQueue}setup(){this.initTime=Object(zC.d)(),this.observePerformance=this.observePerformance?this.observePerformance:Object(iO.b)(["resource"],this.listenObservePerformance.bind(this)),this.observePerformance.observe(),this.databaseManager.addEventListener(Be.b.QueryExec,this.dbQueryExecListener)}listenObservePerformance(e){let t=e.filter((e=>"resource"===e.entryType)).filter((e=>"xmlhttprequest"===e.initiatorType));if(0!==t.length){this.dequeueQueue(this.data.network.queue);for(let e=0;e<t.length;e++){const s=t[e],i={url:s.name,path:RC(s.name),ts:Object(zC.d)()};this.data.network.queue.enqueue(i),this.data.network.totalRequestInLiveTime++,this.enableLogEachRequest}this.slowHandleWarning("network",this.data.network,(()=>this.getWarningDetail("network",this.data.network.queue,(e=>{var t;return(null===(t=e.url)||void 0===t?void 0:t.startsWith("file://"))?"file":`${e.path}`}))))}}dbQueryExecListener(e){const t=e.data;if(!t)return;this.dequeueQueue(this.data.database.queue);const s={database:t.database,method:t.method,table:t.table,ts:Object(zC.d)()};this.data.database.queue.enqueue(s),this.data.database.totalRequestInLiveTime++,this.enableLogEachRequest,this.slowHandleWarning("database",this.data.database,(()=>this.getWarningDetail("database",this.data.database.queue,(e=>`${e.database}.${e.table}`))))}dequeueQueue(e){const t=e.peek();if(t&&t.ts){if(!(Object(zC.d)()-t.ts>nO))return;e.dequeue(),this.dequeueQueue(e)}}slowHandleWarning(e,t,s){this.timeoutSignals[e]||(this.timeoutSignals[e]=setTimeout((()=>{const i=s();this.handleWarning(e,t,i),this.timeoutSignals[e]=void 0}),500))}handleWarning(e,t,s){const i=this.warningConfigs[e].default,a=this.warningConfigs[e].items,n=this.warningConfigs[e].avgRequest,r=i.hit;let o,d,l;const c=s.sorted;for(let h=0;h<c.length;h++){const[e,t]=c[h],i=a[e];if(i){if(t>=i.hit){o=`HIT. ${t} ${aO} (${e})`,d=JSON.stringify(c),l=JSON.stringify(s.meta);break}}else if(t>=r){o=`HIT. ${t} ${aO} (${e})`,d=JSON.stringify(c),l=JSON.stringify(s.meta);break}}if(!o&&this.initTime){let e=t.totalRequestInLiveTime/((Object(zC.d)()-this.initTime)/nO);e=Math.round(e),e>=n&&(o=`AVG. ${e} ${aO}`)}o&&(t.hitCount++,t.error={code:400,message:o,description:d,meta:l,ts:Date.now()},this.hitQueue.enqueue(Object(f.a)(Object(f.a)({},t.error),{},{type:e})),Object(Kt.g)(this.name,"all"))}getWarningDetail(e,t,s){const i={};let a="database"===e?{}:void 0;t.toArray().forEach((e=>{const t=s(e);a&&e.method&&(a[e.method]?a[e.method]++:a[e.method]=1),i[t]?i[t]++:i[t]=1}));return{sorted:Object.entries(i).sort((([,e],[,t])=>t-e)),meta:a}}resetData(){this.initTime=void 0,this.data.network.totalRequestInLiveTime=0,this.data.network.queue.clear(),this.data.network.hitCount=0,this.data.network.error=void 0,this.data.database.totalRequestInLiveTime=0,this.data.database.queue.clear(),this.data.database.hitCount=0,this.data.database.error=void 0;for(let e in this.timeoutSignals)this.timeoutSignals[e]&&clearTimeout(this.timeoutSignals[e]);Object(Kt.g)(this.name,"all")}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||sO)||sO)||sO)||sO)||sO);Object(MC.b)()&&(window.$zpcHealth||(window.$zpcHealth={}),window.$zpcHealth.resourceWarningController=i.ModuleContainer.resolve(KC.b));const rO={maxRetry:3},oO=e=>(t,s,i)=>{const a=i.value,n=new Map;i.value=async function(...t){const s=e(t);let i=n.get(s);return i||(i=a.apply(this,t),i.finally((()=>n.delete(s))),n.set(s,i)),i}};var dO,lO,cO,hO,uO,gO,mO,pO=s("Hk5Z"),fO=s("Y3Ul"),vO=s("kuNG"),bO=s("5miw");dO=Object(i.injectable)(),lO=Object(i.singleton)(pO.a),cO=oO((([e])=>e)),hO=Reflect.metadata("design:type",Function),uO=Reflect.metadata("design:paramtypes",[void 0===bO.RemoteURL?Object:bO.RemoteURL]),dO(gO=lO((mO=class{constructor(){this.responseCache_=void 0}async convert(e){if(!e||"string"!=typeof e)return fO.a.Error({error:new Error("Invalid Remote URL!")});if("blob:"===e.slice(0,5))return fO.a.Success({blobURL:e});this.responseCache_||(this.responseCache_=this.getCacheLazily_());if(this.responseCache_.has(e)){const t=this.responseCache_.get(e);return fO.a.Success({blobURL:t.blobURL})}try{const t=te(fetch,{min:1e3,max:5e3,retries:3,afterRetry:async({success:e})=>{}}),s=await t(e),i=await s.blob(),a=URL.createObjectURL(i);return this.responseCache_.set(e,{remoteURL:e,blobURL:a}),fO.a.Success({blobURL:a})}catch(t){return fO.a.Error({error:t})}}revokeBlobUrl_(e){URL.revokeObjectURL(e)}getCacheLazily_(){return new ce.default({maxSize:Object(vO.a)().config.max_bu_cache_size,onEviction:(e,t)=>{this.revokeBlobUrl_(t.blobURL)}})}},Object(qv.a)(mO.prototype,"convert",[cO,hO,uO],Object.getOwnPropertyDescriptor(mO.prototype,"convert"),mO.prototype),gO=mO))||gO);const yO=Object(i.define)("InternalEventBus");var IO;Object(i.injectable)()(IO=Object(i.singleton)(yO)(IO=class extends je.b{})||IO);const _O=Object(i.define)("AIStickerMapper");var CO=s("z80d");function OO(e,t="token"){if("number"!=typeof e||Number.isNaN(e))throw Error(`${t}=${e} is invalid!`);return e}class SO{constructor(e,t,s,i,a){this.id=void 0,this.rootStickerCateId=void 0,this.url=void 0,this.width=void 0,this.height=void 0,this.id=OO(e,"id"),this.rootStickerCateId=OO(t,"rootStickerCateId"),this.url=function(e,t="token"){if(!e)throw Error(`${t}=${e} is invalid!`);return e}(s,"url"),this.width=OO(i,"width"),this.height=OO(a,"height")}equals(e){return this.id===e.id}}var EO;s("SF1S");Object(i.injectable)()(EO=Object(i.singleton)(_O)(EO=class{toAIStickerDTOFromDomain(e){return{id:e.id,url:e.url,thumb:"",type:CO.f.AI_GENERATED,intrinsicWidth:e.width,intrinsicHeight:e.height,renderedWidth:e.width,renderedHeight:e.height,animatable:!1}}toEntityFromSchema(e){return new SO(e.id,e.rootStickerCateId,e.url,e.width,e.height)}toSchemaFromEntity(e){return{id:e.id,rootStickerCateId:e.rootStickerCateId,url:e.url,width:e.width,height:e.height}}})||EO);const MO=Object(i.define)("AIStickerAPIClient");var TO;let wO=Object(i.injectable)()(TO=class{forwardAIStickerMessage(e,t,s,i,a,n){return ys.default.apiForwardMessage(e,R.MSG_PHOTO,t,s,i,a,n)}fetchAIStickerList(){const e={imei:oa.a.getZaloClientID()},t=`${cs.b.getStickerDomain()}/api/message/sticker/ai/list?${this.getCommonParams_()}&params=${this.encodeParams_(e)}`;return new Promise(((e,s)=>{this.makeGETRequest_(t,null,12190).then(jn.a).then(e).catch(s)}))}makeGETRequest_(e,t,s,i,a,n,r,o,d){return Nn.default._get(e,t,s,i,a,n,r,o,d)}getCommonParams_(){return Nn.default._getCommonParams()}encodeParams_(e){return Nn.default.getEncodedParams(e)}})||TO;i.ModuleContainer.register(MO,wO);const RO=Object(i.define)("AIStickerLocalStorageDB");var LO;Object(ke.e)()(LO=Object(i.injectable)()(LO=Object(i.singleton)(RO)(LO=Reflect.metadata("design:type",Function)(LO=Reflect.metadata("design:paramtypes",[])(LO=class{constructor(){this.tableName_="ai_sticker_tbl_1706849065515"}onAuthenticated(e){}async countAsync(){const e=await this.getRecords_();return e?e.length:0}async getAsync(e){var t;const s=await this.getRecords_();return s&&null!==(t=s.find((t=>t.id===e)))&&void 0!==t?t:null}async getAllAsync(){return await this.getRecords_()}async insertMultiAsync(e){var t;const s=null!==(t=await this.getRecords_())&&void 0!==t?t:[],i=[];e.forEach((e=>{const t=s.findIndex((t=>t.id===e.id));-1===t?i.push(e):s[t]=e}));const a=[...s,...i];return await this.writeRecords_(a),e}async delete(e){let t=await this.getRecords_();return!t||(t=t.filter((t=>t.id!==e)),await this.writeRecords_(t),!0)}async deleteAll(){return await this.writeRecords_([]),!0}async destroyAsync(){const e=this.getLocalStorageDB_();await e.removeItemForCurrentUserAsync(this.tableName_)}async getMultiAsync(e){throw new Error("Method not implemented yet!")}async insertAsync(e){throw new Error("Method not implemented yet!")}async updateAsync(e,t){throw new Error("Method not implemented yet!")}async deleteMulti(e){throw new Error("Method not implemented yet!")}getLocalStorageDB_(){return S.default.getInstance()}async getRecords_(){const e=this.getLocalStorageDB_(),t=await e.getItemForCurrentUserAsync(this.tableName_);return t?JSON.parse(t):null}async writeRecords_(e){const t=this.getLocalStorageDB_(),s=JSON.stringify(e);await t.setItemForCurrentUserAsync(this.tableName_,s)}})||LO)||LO)||LO)||LO);const FO=Object(i.define)("AIStickerRepository");var DO;Object(i.injectable)()(DO=Object(i.singleton)(FO)(DO=function(e,t){return Object(i.inject)(RO)(e,void 0,0)}(DO=Reflect.metadata("design:type",Function)(DO=Reflect.metadata("design:paramtypes",[Object])(DO=class{constructor(e){this.aiStickerDB_=void 0,this.aiStickerDB_=e}getFakeAIStickers_(){const e=[];return e.push(new SO(1,123,"https://media-ten.z-cdn.me/oXS0nzgaaTQAAAAl/pyonium-cute.webp",498,498)),e.push(new SO(2,123,"https://media-ten.z-cdn.me/krDtrF9w1wYAAAAl/chinese-dragon-dragon.webp",498,498)),e.push(new SO(3,123,"https://media-ten.z-cdn.me/XwHQ_iIQT6MAAAAl/dragon-ball.webp",360,360)),e}async getAllAsync(){return this.getFakeAIStickers_()}async countAsync(){return this.aiStickerDB_.countAsync()}async deleteAll(){return this.aiStickerDB_.deleteAll()}async delete(e){return this.aiStickerDB_.delete(e)}async insertMultiAsync(e){const t=e.map((e=>({id:e.id,rootStickerCateId:e.rootStickerCateId,url:e.url,width:e.width,height:e.height})));return await this.aiStickerDB_.insertMultiAsync(t),e}async insertAsync(e){throw new Error("Method not implemented yet!")}async updateAsync(e,t){throw new Error("Method not implemented yet!")}async getAsync(e){throw new Error("Method not implemented yet!")}async find(e){throw new Error("Method not implemented yet!")}})||DO)||DO)||DO)||DO);var AO=s("xvqP");var jO=s("VLUZ");let PO=function(e){return e.SETUP_AI_STICKER_LIST_UPDATER="SETUP_AI_STICKER_LIST_UPDATER",e.FETCH_AI_STICKER_LIST="FETCH_AI_STICKER_LIST",e.FORWARD_AI_STICKER_MESSAGE="FORWARD_AI_STICKER_MESSAGE",e}({});class NO extends je.a{constructor(e,t){super(PO.SETUP_AI_STICKER_LIST_UPDATER),this.expiredTime=void 0,this.version=void 0,this.expiredTime=e,this.version=t}}class UO extends je.a{constructor(e,t){super(PO.FETCH_AI_STICKER_LIST),this.onCompleted=void 0,this.onFailed=void 0,this.onCompleted=null!=e?e:()=>{},this.onFailed=null!=t?t:()=>{}}}class kO extends je.a{constructor(e,t,s){super(PO.FORWARD_AI_STICKER_MESSAGE),this.payload=void 0,this.onCompleted=void 0,this.onFailed=void 0,this.payload=null!=e?e:{},this.onCompleted=null!=t?t:()=>{},this.onFailed=null!=s?s:()=>{}}}var BO;Object(i.injectable)()(BO=Object(ke.e)()(BO=Object(i.singleton)(AO.c)(BO=function(e,t){return Object(i.inject)(MO)(e,void 0,0)}(BO=function(e,t){return Object(i.inject)(yO)(e,void 0,1)}(BO=Reflect.metadata("design:type",Function)(BO=Reflect.metadata("design:paramtypes",[Object,Object])(BO=class{constructor(e,t){this.apiClient_=void 0,this.internalEventBus_=void 0,this.apiClient_=e,this.internalEventBus_=t}onAuthenticated(e){this.internalEventBus_.addEventListener(PO.FETCH_AI_STICKER_LIST,this.handleFetchAPIStickerListEvent_.bind(this)),this.internalEventBus_.addEventListener(PO.FORWARD_AI_STICKER_MESSAGE,this.handleForwardAPIStickerMessageEvent_.bind(this))}getAIStickerList(){return new Promise(((e,t)=>{const s=t=>{e({errorCode:jO.a.SUCCESS,data:{expiredTime:t.expired_time,version:t.version,stickers:t.stickers.map((e=>({id:e.id,url:e.url,width:e.width,height:e.height,rootStickerCateId:e.cateid_root})))}})},i=t=>{e({errorCode:jO.a.FAIL,data:void 0})};this.apiClient_.fetchAIStickerList().then(s).catch((e=>{this.requestErrorHandler_(e,this.getAIStickerList).then(s).catch(i)}))}))}handleForwardAPIStickerMessageEvent_(e){const{payload:t,onCompleted:s,onFailed:i}=e,a=t.retryTimeout?{count:ms.default.retryConfig.max_retry_count,timeout:t.retryTimeout,timestamp:Date.now(),lowPriority:t.lowPriority}:null,n=Qa.a.newReq();this.apiClient_.forwardAIStickerMessage(t.toUid,t.messageContent,t.clientMsgId,a,n,t.additional).then(s).catch(i)}handleFetchAPIStickerListEvent_(e){this.getAIStickerList().then(e.onCompleted).catch(e.onFailed)}requestErrorHandler_(e,t,s=0){return new Promise(((i,a)=>{if(s>=1)return a(e);let n=-1;switch(e?e.error_code||e.code:"UNKNOWN"){case 112:n=5e3;break;case"ERR_NO_NETWORK":case"ERR_CONNECTION_TIMED_OUT":n=1e4;break;default:n=-1}if(n<0)return a(e);setTimeout((()=>{t().then(i).catch((e=>{this.requestErrorHandler_(e,t,s+1).then(i).catch(a)}))}),n)}))}})||BO)||BO)||BO)||BO)||BO)||BO);const GO="ai_sticker_list_ver_1706778251026",xO="ai_sticker_list_expt_1707057455164";class zO{constructor(){this.aiStickerListVersion_=null,this.versionExpiredTime_=null}getAIStickerListVersion(){if(null==this.aiStickerListVersion_){const t=S.default.getInstance().getItemForCurrentUser(GO);let s=CO.b;if(t)try{s=JSON.parse(t)}catch(e){}this.aiStickerListVersion_=s}return this.aiStickerListVersion_}setAIStickerListVersion(e){this.aiStickerListVersion_=e;S.default.getInstance().setItemForCurrentUser(GO,JSON.stringify(e))}getVersionExpiredTime(){if(null==this.versionExpiredTime_){const t=S.default.getInstance().getItemForCurrentUser(xO);let s=-1;if(t)try{s=JSON.parse(t)}catch(e){}this.versionExpiredTime_=s}return this.versionExpiredTime_}setVersionExpiredTime(e){this.versionExpiredTime_=e;S.default.getInstance().setItemForCurrentUser(xO,JSON.stringify(e))}}zO.NOT_AI_STICKER_LIST_VERSION=CO.b,zO.NOT_VERSION_EXPIRED_TIME=-1;var VO,HO=new zO;let $O=Object(i.injectable)()(VO=function(e,t){return Object(i.inject)(_O)(e,void 0,0)}(VO=function(e,t){return Object(i.inject)(FO)(e,void 0,1)}(VO=function(e,t){return Object(i.inject)(yO)(e,void 0,2)}(VO=Reflect.metadata("design:type",Function)(VO=Reflect.metadata("design:paramtypes",[Object,Object,Object])(VO=class{constructor(e,t,s){this.aiStickerListVersion_=void 0,this.aiStickerMapper_=void 0,this.aiStickerRepository_=void 0,this.internalEventBus_=void 0,this.aiStickerMapper_=e,this.aiStickerRepository_=t,this.internalEventBus_=s,this.aiStickerListVersion_=HO}transformFromAIStickerMessage(e){var t,s,i,a,n;const r=e.content,o=e.content.parsedParams,d=o.contentId,l=null!==(t=null!==(s=null!==(i=r.oriUrl)&&void 0!==i?i:r.hdUrl)&&void 0!==s?s:null===(a=o.webp)||void 0===a?void 0:a.url)&&void 0!==t?t:"";return{id:d,url:l,thumb:null!==(n=r.thumbUrl)&&void 0!==n?n:l,intrinsicWidth:o.width,intrinsicHeight:o.height,renderedWidth:Object(vO.a)().config.ai_sticker_message.w,renderedHeight:Object(vO.a)().config.ai_sticker_message.h,animatable:undefined,type:CO.f.AI_GENERATED,extra:{fromSrc:CO.a.MESSAGE}}}transformRecentAIStickerFromAISticker(e){return Object(f.a)(Object(f.a)({},e),{},{extra:{fromSrc:CO.a.RECENT}})}transformFromAIStickerMessageContent(e){throw new Error("Method does not be implemented yet!")}isValidAISticker(e){const t=!!e.id,s=!!e.url,i=e.type===CO.f.AI_GENERATED;return t&&s&&i}isValidAIStickerFromRecentStickerPanel(e){var t;return(null==e||null===(t=e.extra)||void 0===t?void 0:t.fromSrc)===CO.a.RECENT}async getAIStickerList(){let e=await this.aiStickerRepository_.getAllAsync();if((!e||0===e.length)&&this.aiStickerListVersion_.getAIStickerListVersion()===zO.NOT_AI_STICKER_LIST_VERSION){e=await this.syncAIStickerList_()?await this.aiStickerRepository_.getAllAsync():[]}return e.map((e=>this.aiStickerMapper_.toAIStickerDTOFromDomain(e)))}getAIStickerListVersion(){return this.aiStickerListVersion_.getAIStickerListVersion()}async syncAIStickerList_(){return new Promise(((e,t)=>{const s=()=>{e(!1)},i=new UO((async t=>{try{if(t.errorCode===jO.a.SUCCESS){const s=t.data;if(s.version>this.aiStickerListVersion_.getAIStickerListVersion()){const t=s.stickers.map((e=>new SO(e.id,e.rootStickerCateId,e.url,e.width,e.height)));await this.aiStickerRepository_.insertMultiAsync(t),this.aiStickerListVersion_.setAIStickerListVersion(s.version),s.expiredTime&&(this.aiStickerListVersion_.setVersionExpiredTime(s.expiredTime),this.internalEventBus_.dispatchEvent(new NO(s.expiredTime,s.version))),e(!0)}}e(!1)}catch(i){s()}}),s);this.internalEventBus_.dispatchEvent(i)}))}})||VO)||VO)||VO)||VO)||VO)||VO;i.ModuleContainer.register(AO.a,$O);var WO=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.common,[]);function qO(e){return JSON.parse(e)}function KO(e,t){if("object"==typeof e)return e;try{e=qO(e)}catch(s){WO.zsymb(18,"8dH-g4","Parse json failed",String(e).slice(0,100)),e=t}return e}function ZO(e){return qO(e)}function QO(e){var t;if(!e)return;let s={message:""};if("string"==typeof e.msg)s.message=e.msg;else try{const t=e.msg;s=Object(f.a)(Object(f.a)({},t),{},{message:t.title||""})}catch(a){}const i=null!==(t=e.ownerId)&&void 0!==t?t:e.fromUid;return Object(f.a)(Object(f.a)({},e),{},{attachment:ZO.deep(e.attach),rootClientMessageID:e.cliMsgId,rootClientMessageType:e.cliMsgType,rootContent:s,rootGlobalMessageID:e.globalMsgId,rootSentTime:+e.ts,rootSenderName:zt.default.getDName(i),rootSenderID:i,ttl:e.ttl})}function JO(e){if(e)return{fromID:e.fromId,icon:e.icon,isGroup:Boolean(e.isGroup),isMessageInfo:Boolean(e.isMsgInfo),senderAvatar:e.senderAvatar,senderDisplayName:e.senderDisplayName,threadID:e.threadId,timestamp:e.ts,ttl:e.ttl}}ZO.noExceptions=function(e){try{return ZO(e)}catch(t){return void Logger.zsymb(18,"fJQvue","Parse json failed",String(e).slice(0,100))}},ZO.fallback=KO,ZO.fallbackSelf=function(e){return KO(e,e)},ZO.deep=function e(t){const s=e=>!isNaN(Number(e));if("string"!=typeof t)return Array.isArray(t)?t.map((t=>e(t))):"object"==typeof t&&null!=t?Object.keys(t).reduce(((i,a)=>{const n=t[a];return i[a]=s(n)?n:e(n),i}),{}):t;if(s(t))return t;try{return e(qO(t))}catch(i){return t}};const YO=()=>({contentId:"",width:-1,height:-1,thumbWidth:-1,thumbHeight:-1,pStickerType:CO.c.AI_STICKER,webp:{width:-1,height:-1,url:""}});function XO(e){return e?Object(f.a)(Object(f.a)({},e),{},{contentId:e.contentId,pStickerType:e.pStickerType,webp:{width:e.webp.width,height:e.webp.height,url:e.webp.url},height:e.height,width:e.width,thumbHeight:e.thumb_height,thumbWidth:e.thumb_width}):YO()}const eS=()=>({title:"",description:"",oriUrl:"",thumbUrl:"",hdUrl:"",parsedParams:XO(null)});function tS(e){if(!e)return eS();const t=e.params;let s=XO(null);if("string"==typeof t)try{s=XO(JSON.parse(t))}catch(PT){0}else"object"==typeof t&&(s=XO(t));return Object(f.a)(Object(f.a)({},e),{},{title:e.title,description:e.description,hdUrl:e.hdUrl,oriUrl:e.oriUrl,thumbUrl:e.thumbUrl,parsedParams:s})}const sS=()=>({color:-1,size:-1,subType:-1,type:-1,parsedExt:{sSrcStr:"",sSrcType:-1}});function iS(e){if(!e)return sS();const t=e.ext;let s={sSrcStr:"",sSrcType:-1};if("string"==typeof t)try{s=JSON.parse(t)}catch(PT){0}else"object"==typeof t&&(s=t);return Object(f.a)(Object(f.a)({},e),{},{color:e.color,size:e.size,subType:e.subType,type:e.type,parsedExt:s})}function aS(e){return Object(f.a)(Object(f.a)({},function(e){if(e)return Object(f.a)(Object(f.a)({},e),{},{actionID:e.actionId,clientMessageID:e.cliMsgId,e2eeStatus:e.e2eeStatus,eventInfo:JO(e.eventInfo),extra:e.extra,fromUID:String(e.fromUid),messageID:e.msgId,platformType:e.platformType,quote:QO(e.quote),sentSource:e.src,sentTime:+e.sendDttm,serverTime:+e.serverTime,status:e.status,syncFromMobile:e.syncFromMobile,toUID:String(e.toUid),ttl:e.ttl,type:-1})}(e)),{},{content:tS(e.message),type:9999,src:e.src,msgType:e.msgType,originMsgType:"chat.photo",properties:iS(e.properties)})}var nS,rS=s("bKjh");let oS=Object(i.injectable)()(nS=function(e,t){return Object(i.inject)(yO)(e,void 0,0)}(nS=Reflect.metadata("design:type",Function)(nS=Reflect.metadata("design:paramtypes",[Object])(nS=class{constructor(e){this.internalEventBus_=void 0,this.internalEventBus_=e}isAIStickerMessageObject(e){return Object(rS.b)(e)}isAIStickerMessage(e){return Object(rS.a)(e)}isOldAIStickerMessage(e){return Object(rS.e)(e)}isNewAIStickerMessage(e){return Object(rS.d)(e)}transformFromRawMessage(e){return aS(e)}transformAIStickerMessageObjectFromAISticker(e,t){return{toId:e,sendByUrl:!0,title:"",description:"",file:{},img:t.url,oriUrl:t.url,thumbUrl:t.thumb||t.url,hdUrl:t.url,width:t.intrinsicWidth,height:t.intrinsicHeight,params:{contentId:t.id,pStickerType:CO.c.AI_STICKER,height:t.intrinsicHeight,width:t.intrinsicWidth,thumb_width:t.intrinsicWidth,thumb_height:t.intrinsicHeight,webp:{width:t.intrinsicWidth,height:t.intrinsicHeight,url:t.url}},properties:{subType:0,color:-1,size:-1,type:R.MSG_BUBBLE_LAYOUT_TYPE_NO_BORDER,ext:{sSrcStr:CO.d.AI,sSrcType:CO.e.AI}}}}forwardAIStickerMessage(e,t,s,i={retryTimeout:0,lowPriority:!1,fwAdditional:{}}){return new Promise(((a,n)=>{const r=s.content.parsedParams.webp.url||s.content.oriUrl;if(!r)return n();this.checkAlive_(r,{count:ms.default.retryConfig.max_normal_request_retry_count}).then((()=>{var r,o,d,l,c,h;const u={description:"",title:"",oriUrl:s.content.oriUrl,thumbUrl:s.content.thumbUrl,normalUrl:s.content.normalUrl,hdUrl:s.content.hdUrl||s.content.normalUrl,contentId:s.content.parsedParams.contentId,thumb_width:null!==(r=s.content.parsedParams.thumbWidth)&&void 0!==r?r:s.content.parsedParams.width,thumb_height:null!==(o=s.content.parsedParams.thumbHeight)&&void 0!==o?o:s.content.parsedParams.height,webp:JSON.stringify(s.content.parsedParams.webp),width:s.content.parsedParams.width,height:s.content.parsedParams.height,properties:JSON.stringify({color:s.properties.color,size:s.properties.size,subType:s.properties.subType,type:s.properties.type,ext:JSON.stringify(s.properties.parsedExt)}),pStickerType:s.content.parsedParams.pStickerType,photoId:null!==(d=s.content.photoId)&&void 0!==d?d:1},g=s.e2eeStatus===R.MSG_E2EE;g&&(u.isAISticker=!0);const m=new kO({toUid:e,clientMsgId:t,lowPriority:null!==(l=i.lowPriority)&&void 0!==l&&l,retryTimeout:null!==(c=i.retryTimeout)&&void 0!==c?c:0,messageContent:u,additional:null!==(h=i.fwAdditional)&&void 0!==h?h:{}},(async e=>{if(g)a(e);else{const t={msgId:e.msgId+"",thumbUrl:s.content.thumbUrl,hdUrl:s.content.hdUrl,oriUrl:s.content.oriUrl,width:s.content.parsedParams.width,height:s.content.parsedParams.height};a(t)}}),(async e=>{n(e)}));this.internalEventBus_.dispatchEvent(m)})).catch(n)}))}checkAlive_(e,t){return new Promise(((s,a)=>{Is.default.checkAlive(e).then(s).catch((n=>{if(ms.default.retryConfig.enable_add_missing_retry&&n===Gp.XMLHttpRequestErrorCode.NO_RESPONSE&&t.count){t.count=t.count-1;const n=()=>this.checkAlive_(e,t).then(s).catch(a);i.ModuleContainer.resolve(Gp.ConnectionPendingController).pushToRetryQueue(n)}else a(n)}))}))}})||nS)||nS)||nS)||nS;i.ModuleContainer.register(AO.b,oS);var dS,lS=s("56jR"),cS=s("397E"),hS=s("RJlJ");Object(i.injectable)()(dS=Object(ke.e)()(dS=Object(Hs.b)(cS.b)(dS=Object(i.singleton)(cS.b)(dS=function(e,t){return Object(i.inject)(AO.a)(e,void 0,0)}(dS=Reflect.metadata("design:type",Function)(dS=Reflect.metadata("design:paramtypes",[void 0===lS.IAIStickerAppService?Object:lS.IAIStickerAppService])(dS=class{constructor(e){this.aiStickerService_=void 0,this.state_={version:CO.b,aiStickers:[]},this.name=cS.a,this.key=hS.a,this.aiStickerService_=e}onAuthenticated(e){Object(vO.a)().isEnable("AIStickerTab")&&this.aiStickerService_.getAIStickerList().then((e=>{this.state_.version=this.aiStickerService_.getAIStickerListVersion(),this.state_.aiStickers=e,Object(Kt.g)(this.name,this.key)}))}getAIStickerList(){return this.state_.aiStickers}init(){}getItem(e){if(e.key===this.key)return this.state_}getList(e,t){return[]}onGetItemFailure(e,t){0}onGetListFailure(e,t){0}})||dS)||dS)||dS)||dS)||dS)||dS);var uS=s("T6Qc"),gS=s("RYTL");const mS=Object(gS.b)("socket-polling"),pS=Object(gS.b)("event-bus"),fS=Object(gS.b)("z-storage"),vS=Object(gS.b)("z-search-v3"),bS=Object(gS.b)("actionlog-service"),yS=Object(gS.b)("important-message-manager"),IS=Object(gS.b)("sync-message-controller");var _S,CS=s("6ivO"),OS=s("KBxP");const SS=new jb.a({enable:jb.b.field().boolean(),batch_size:jb.b.field().number().min(0),enable_fetch_foreground:jb.b.field().boolean(),enable_segment_updater:jb.b.field().boolean(),enable_tracking_overflow:jb.b.field().boolean(),min_throttle:jb.b.field().number().min(100),throttle:jb.b.field().number().min(0),throttle_idle:jb.b.field().number(),queue_config:jb.b.field().array("string"),interval_check_insufficient_data:jb.b.field().number().min(0),max_time_check_insufficient_data:jb.b.field().number().min(0),max_retry_batch:jb.b.field().number().min(0),retry_strategy:jb.b.field().string().oneOf(["fibo","linear"]),time_exclude:jb.b.field().array("number"),debugger:jb.b.field().schema({show_msg_src:jb.b.field().boolean(),logger:jb.b.field().schema({machine_transition:jb.b.field().boolean(),save_message:jb.b.field().boolean(),batch_request_info:jb.b.field().boolean(),interval_update_sufficient_ts:jb.b.field().boolean()}),simulator:jb.b.field().schema({overflow_db_group_offline:jb.b.field().boolean(),slow_load_message:jb.b.field().boolean()})})});let ES=Object(gS.d)()(_S=Object(gS.e)(uS.b)(_S=Reflect.metadata("design:type",Function)(_S=Reflect.metadata("design:paramtypes",[])(_S=class extends CS.ZFeatureConfig{constructor(){super({default:OS.b,valiator:SS})}selector(e){return e.auto_fetch_msg_mini_cloud||{}}shouldConfigUpdate(e,t){return!new Br.e.Comparer(e,t,!0).AND("enable").AND("batch_size").AND("min_throttle").AND("enable_fetch_foreground").AND("enable_segment_updater").AND("enable_tracking_overflow").AND("throttle").AND("throttle_idle").AND("queue_config").AND("interval_check_insufficient_data").AND("max_time_check_insufficient_data").AND("max_retry_batch").AND("retry_strategy").AND("time_exclude").AND("debugger",Db.a.isEqual).exec()}})||_S)||_S)||_S)||_S;var MS=s("7Yx4");let TS=function(e){return e.OVERFLOW_DB_GROUP_OFFLINE="OVERFLOW_DB_GROUP_OFFLINE",e}({});var wS=s("j8Zv");let RS=function(e){return e[e.ONLY_1_1=0]="ONLY_1_1",e[e.ONLY_GROUP=1]="ONLY_GROUP",e[e.BOTH_1_1_AND_GROUP=2]="BOTH_1_1_AND_GROUP",e[e.NONE=3]="NONE",e}({});var LS,FS=s("svq+");class DS extends je.a{constructor(e){super(FS.a.SHOW_SYNC_MESSAGE_SUGGESTION),this.queueId=e}}class AS extends je.a{constructor(){super(FS.a.AFMC_START)}}class jS extends je.a{constructor(){super(FS.a.AFMC_FINISHED)}}let PS=Object(gS.d)()(LS=Object(Gr.e)()(LS=Object(gS.e)(uS.c)(LS=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,0)}(LS=function(e,t){return i.ModuleContainer.inject(vs)(e,void 0,1)}(LS=function(e,t){return Object(Gr.d)(uS.b)(e,void 0,2)}(LS=function(e,t){return Object(Gr.d)(uS.n)(e,void 0,3)}(LS=function(e,t){return Object(Gr.d)(uS.h)(e,void 0,4)}(LS=function(e,t){return Object(Gr.d)(uS.k)(e,void 0,5)}(LS=function(e,t){return Object(Gr.d)(uS.o)(e,void 0,6)}(LS=function(e,t){return Object(Gr.d)(uS.i)(e,void 0,7)}(LS=function(e,t){return Object(Gr.d)(uS.r)(e,void 0,8)}(LS=function(e,t){return Object(Gr.d)(uS.e)(e,void 0,9)}(LS=Reflect.metadata("design:type",Function)(LS=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_ILedger?Object:AFMC_ILedger,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMachine?Object:AFMC_IMachine,"undefined"==typeof AFMC_ITrackingOverflowMessage?Object:AFMC_ITrackingOverflowMessage,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector])(LS=class extends je.b{constructor(e,t,s,i,a,n,r,o,d,l){super(),this.logger=void 0,this.service=void 0,this.ledger=void 0,this.metrics=void 0,this.storage=void 0,this.systemTime=void 0,this.fetcherMachine=void 0,this.eventCollector=void 0,this.trackingOverflow=void 0,this.config=void 0,this.isInsufficientMessage=void 0,this.onOverflowDBGroupOffline=()=>{this.logger.zsymb(0,"lFYzJK","DB Group offline overflow, should suggest sync message"),this.dispatchEvent(new DS(wS.a.SOCKET_MESSAGE_GROUP))},this.onConfigUpdate=e=>{!0===e.config.enable?(this.logger.zsymb(0,"rtS5y-","Receive config enabled, let start machine"),this.registerMachineListener(),this.fetcherMachine.start()):(this.logger.zsymb(0,"OPfiHT","Receive config disabled, let stop machine"),this.fetcherMachine.stop(),this.unregisterMachineListener())},this.onMachineTransition=e=>{switch(e.event.type){case"START":this.onMachineStartFetch();break;case"STOP":this.onMachineStopFetch()}this.config.get("debugger.logger.machine_transition")&&this.logger.zsymb(12,"qAahW-","machine transition",JSON.stringify(e.value))},this.onMachineStop=()=>{this.logger.zsymb(0,"QzRqsn","Machine is stopped")},this.onMachineStartFetch=async()=>{this.dispatchEvent(new AS);const e=this.isInsufficientMessage=await this.service.isInsufficientMessage(),t=this.trackingOverflow.getOverflowStatus(),s=this.fetcherMachine.hasRemainConvInPrevSession();if(e)this.dispatchEvent(new DS(wS.a.SOCKET_MESSAGE_GROUP)),this.logger.zsymb(0,"i-PWu8","User messages may not be enough, should suggest sync message"),this.metrics.logAutoShowBannerSuggestion(s);else if(this.logger.zsymb(0,"-3jDQv","Can cover overflow by fetch message from mini-cloud"),t===RS.ONLY_GROUP)this.metrics.logAutoHideBannerSuggestion();this.metrics.logStartFetch(e,t)},this.onMachineStopFetch=async()=>{const e=0===await this.ledger.size();e?(this.logger.zsymb(0,"h8Lo--","fetch done"),this.storage.saveLastFetchSuccess(this.systemTime.getTimeNow())):this.logger.zsymb(18,"7vSJYe","fetch stop"),null!==this.isInsufficientMessage&&this.metrics.logStopFetch(this.isInsufficientMessage,this.trackingOverflow.getOverflowStatus(),e),this.isInsufficientMessage=null,this.dispatchEvent(new jS)},this.onOverflowMessageQueue=async e=>!1===this.config.get("enable")?(this.logger.zsymb(0,"S6FaFf","Module is disabled, should suggest sync message"),void this.dispatchEvent(new DS(e.queueId))):!1===this.service.isQueueMessageGroup(e.queueId)?(this.logger.zsymb(0,"wsev-x","Detected overflow other queue, forward event to suggest sync message"),void this.dispatchEvent(new DS(e.queueId))):void this.logger.zsymb(0,"x8Fy-v","Detected overflow queue message group, let wait done offline"),this.logger=e.createZLogger(ci.ZLoggerNametags.autoFetchMsgCloud,[ci.ZLoggerNametags.controller]),this.config=s,this.ledger=a,this.service=i,this.metrics=n,this.storage=r,this.systemTime=t,this.fetcherMachine=o,this.eventCollector=l,this.trackingOverflow=d,this.isInsufficientMessage=null}start(){this.fetcherMachine.create(),this.registerListener(),this.config.get("enable")?(this.logger.zsymb(0,"ANcf8I","Module is enabled on startup, let start machine"),this.registerMachineListener(),this.fetcherMachine.start()):this.logger.zsymb(0,"H0GVSp","Module is disabled on startup, let listen config from server")}registerListener(){this.config.addEventListener("update",this.onConfigUpdate),this.ledger.addEventListener(TS.OVERFLOW_DB_GROUP_OFFLINE,this.onOverflowDBGroupOffline),this.eventCollector.addEventListener(MS.a.OVERFLOW_MESSAGE_QUEUE,this.onOverflowMessageQueue)}registerMachineListener(){this.logger.zsymb(0,"nFcEXx","register machine listener"),this.fetcherMachine.onStop(this.onMachineStop),this.fetcherMachine.onTransition(this.onMachineTransition)}unregisterMachineListener(){this.logger.zsymb(0,"EhgAQT","unregister machine listener"),this.fetcherMachine.off(this.onMachineStop),this.fetcherMachine.off(this.onMachineTransition)}})||LS)||LS)||LS)||LS)||LS)||LS)||LS)||LS)||LS)||LS)||LS)||LS)||LS)||LS)||LS,NS=function(e){return e.AUTO_FETCH_MSG_CLOUD_SETTING="auto_fetch_msg_cloud",e.SYNC_MESSAGE_SETTING="sync_cross_settings",e.IMPORT_MESSAGE_SETTING="export_import_data",e.OVERFLOW_MSG_TS="overflow_msg_ts",e.SUFFICIENT_MSG_TS="sufficient_msg_ts",e.LAST_CLOSE_FIRST_LOGIN_TRANSFER_MODAL_TS="last-time-close-first-login-transfer-modal",e}({});class US{constructor(e,t,s){this.key=void 0,this.version=void 0,this.storageAdapter=void 0,this.data=null,this.key=e,this.version=t,this.storageAdapter=s}async get(){return this.data?this.data:this.data=await this.storageAdapter.readAsync(this.key,this.version)}async save(e){this.data=e,await this.storageAdapter.writeAsync(this.key,this.version,e)}async clear(){this.data=null,await this.storageAdapter.removeAsync(this.key)}}class kS extends US{constructor(e,t){super([e,"conv_ids"].join("_"),1,t)}async remove(e){var t;const s=(null!==(t=await this.get())&&void 0!==t?t:[]).filter((t=>t!==e));await this.save(s)}async getRemainConv(){const e=await this.get();return(null==e?void 0:e.length)||0}}class BS extends US{constructor(e,t){super([e,"overflow"].join("_"),1,t)}}class GS extends US{constructor(e,t){super([e,"last_fetch"].join("_"),2,t)}async getLastTsSuccess(){var e,t;return null!==(t=(null!==(e=await this.get())&&void 0!==e?e:{}).lastTsSuccess)&&void 0!==t?t:-1}async getFetchInfo(){var e;return null!==(e=await this.get())&&void 0!==e?e:{}}async saveLastTsSuccess(e){var t;const s=null!==(t=await this.get())&&void 0!==t?t:{};return this.save(Object(f.a)(Object(f.a)({},s),{},{lastTsSuccess:e}))}async saveStartFetchInfo(e){var t,s,i;const a=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=a.onProgressInfo)&&void 0!==s?s:{};n.evict||(n.evict=e.evict),n.listTsStart=(null!==(i=n.listTsStart)&&void 0!==i?i:[]).concat(e.tsStart),n.tsSufficient=e.tsSufficient,await this.save(Object(f.a)(Object(f.a)({},a),{},{onProgressInfo:n}))}async saveConvIds(e){var t,s,i;const a=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=a.onProgressInfo)&&void 0!==s?s:{};n.convIds=Br.a.merge(null!==(i=null==n?void 0:n.convIds)&&void 0!==i?i:[],e);const r=Object(f.a)(Object(f.a)({},a),{},{onProgressInfo:n});await this.save(r)}async saveConvErrorIds(e){var t,s,i;const a=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=a.onProgressInfo)&&void 0!==s?s:{},r=null!==(i=null==n?void 0:n.convErrorIds)&&void 0!==i?i:[],o=Br.a.merge(r,e);n.convErrorIds=o,await this.save(Object(f.a)(Object(f.a)({},a),{},{onProgressInfo:n}))}async saveTotalMessageFetched(e){var t,s,i;const a=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=a.onProgressInfo)&&void 0!==s?s:{},r=(null!==(i=n.totalMsgFetched)&&void 0!==i?i:0)+e;n.totalMsgFetched=r,await this.save(Object(f.a)(Object(f.a)({},a),{},{onProgressInfo:n}))}async removeLastStartFetchInfo(){var e;const t=null!==(e=await this.get())&&void 0!==e?e:{};return delete t.onProgressInfo,this.save(t)}async removeConvId(e){var t,s,i,a;const n=null!==(t=await this.get())&&void 0!==t?t:{},r=null!==(s=n.onProgressInfo)&&void 0!==s?s:{};r.convIds=(null!==(i=r.convIds)&&void 0!==i?i:[]).filter((t=>t!==e)),r.convErrorIds=(null!==(a=r.convErrorIds)&&void 0!==a?a:[]).filter((t=>t!==e));const o=Object(f.a)(Object(f.a)({},n),{},{onProgressInfo:r});await this.save(o)}async removeConvIdFetchFailed(e){var t,s,i;const a=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=a.onProgressInfo)&&void 0!==s?s:{};n.convErrorIds=(null!==(i=n.convErrorIds)&&void 0!==i?i:[]).filter((t=>t!==e));const r=Object(f.a)(Object(f.a)({},a),{},{onProgressInfo:n});await this.save(r)}}var xS;let zS=Object(gS.d)()(xS=Object(Gr.e)()(xS=Object(gS.e)(uS.o)(xS=function(e,t){return Object(Gr.d)(uS.a)(e,void 0,0)}(xS=Reflect.metadata("design:type",Function)(xS=Reflect.metadata("design:paramtypes",["undefined"==typeof IAsyncStorageAdapter?Object:IAsyncStorageAdapter])(xS=class{constructor(e){this.localStorage=void 0,this.storageConvIds=void 0,this.storageOverflow=void 0,this.storageLastFetch=void 0,this.localStorage=S.default.getInstance(),this.storageConvIds=new kS(NS.AUTO_FETCH_MSG_CLOUD_SETTING,e),this.storageOverflow=new BS(NS.AUTO_FETCH_MSG_CLOUD_SETTING,e),this.storageLastFetch=new GS(NS.AUTO_FETCH_MSG_CLOUD_SETTING,e)}async getAllConvIds(){var e;return null!==(e=await this.storageConvIds.get())&&void 0!==e?e:[]}async getLastTsSyncMessageSuccess(){var e;const t=this.localStorage.getItemForCurrentUser(NS.SYNC_MESSAGE_SETTING),[,s]=Br.e.safeParseJson(t);return null!==(e=null==s?void 0:s.lastSync)&&void 0!==e?e:-1}async getLastTsCloseTransferSuggestion(){var e;const t=this.localStorage.getItemForCurrentUser(NS.SYNC_MESSAGE_SETTING),[,s]=Br.e.safeParseJson(t);return null!==(e=null==s?void 0:s.lastCloseSuggest)&&void 0!==e?e:-1}async getLastTsCloseFirstLoginTransferSuggestion(){const e=await this.localStorage.getItemForCurrentUserAsync(NS.LAST_CLOSE_FIRST_LOGIN_TRANSFER_MODAL_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getLastTsImportMessageSuccess(){var e;const t=this.localStorage.getItemForCurrentUser(NS.IMPORT_MESSAGE_SETTING),[,s]=Br.e.safeParseJson(t);return null!==(e=null==s?void 0:s.lastTimeImportSuccess)&&void 0!==e?e:-1}async getLastTsAutoFetchMessageSuccess(){return await this.storageLastFetch.getLastTsSuccess()}async getFetchInfo(){return await this.storageLastFetch.getFetchInfo()}async getLastTsOverflowMessage(){const e=this.localStorage.getItemForCurrentUser(NS.OVERFLOW_MSG_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getLastTsSufficientMessage(){const e=this.localStorage.getItemForCurrentUser(NS.SUFFICIENT_MSG_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getOverflowInfo(){return await this.storageOverflow.get()}async getRemainConv(){return await this.storageConvIds.getRemainConv()}async saveConvIds(e){await this.storageConvIds.save(e),await this.storageLastFetch.saveConvIds(e)}async saveLastFetchSuccess(e){await this.storageLastFetch.saveLastTsSuccess(e)}async saveLastOverflow(e){this.localStorage.setItemForCurrentUser(NS.OVERFLOW_MSG_TS,String(e))}async saveLastSufficientMessage(e){this.localStorage.setItemForCurrentUser(NS.SUFFICIENT_MSG_TS,String(e))}async saveOverflowInfo(e,t,s){await this.storageOverflow.save({queueId:e,lastMsgId:t,lastActionId:s})}async saveStartFetchInfo(e){await this.storageLastFetch.saveStartFetchInfo(e)}async saveConvErrorId(e){await this.storageLastFetch.saveConvErrorIds([e])}async saveTotalMessageFetched(e){await this.storageLastFetch.saveTotalMessageFetched(e)}async removeOverflowInfo(){await this.storageOverflow.clear()}async removeConvId(e){await this.storageConvIds.remove(e),await this.storageLastFetch.removeConvIdFetchFailed(e)}async forceRemoveConvId(e){await this.storageConvIds.remove(e),await this.storageLastFetch.removeConvId(e)}async removeStartFetchInfo(){await this.storageLastFetch.removeLastStartFetchInfo()}})||xS)||xS)||xS)||xS)||xS)||xS;var VS;let HS=Object(gS.d)()(VS=Object(gS.e)(uS.a)(VS=Reflect.metadata("design:type",Function)(VS=Reflect.metadata("design:paramtypes",[])(VS=class{constructor(){this.storage=void 0,this.storage=S.default.getInstance()}async readAsync(e,t){const s=await this.storage.getItemForCurrentUserAsync(e),[i,a]=Br.e.safeParseJson(s);return i||null===a?null:a.version===t?a.value:(await this.storage.removeItemForCurrentUserAsync(e),null)}async writeAsync(e,t,s){const i=JSON.stringify({version:t,value:s});await this.storage.setItemForCurrentUserAsync(e,i)}async removeAsync(e){await this.storage.removeItemForCurrentUserAsync(e)}})||VS)||VS)||VS)||VS;var $S=s("9Gk3"),WS=s("wd/R"),qS=s.n(WS);let KS=function(e){return e[e.SAVE_MESSAE_ERROR=0]="SAVE_MESSAE_ERROR",e[e.GET_GROUP_INFO_ERROR=1]="GET_GROUP_INFO_ERROR",e}({});class ZS extends xr{constructor(e){super("SaveMessageError",KS.SAVE_MESSAE_ERROR,e)}}class QS extends xr{constructor(e,t){super("GetGroupInfoError",KS.GET_GROUP_INFO_ERROR,"An error occured during get list groups info. Error: "+JSON.stringify(t)+". GroupIds: "+e)}}var JS,YS,XS,eE,tE,sE,iE,aE,nE,rE,oE,dE,lE,cE,hE,uE,gE,mE,pE,fE,vE,bE;let yE=(JS=Object(gS.d)(),YS=Object(Gr.e)(),XS=Object(gS.e)(uS.n),eE=function(e,t){return Object(Gr.d)(uS.b)(e,void 0,0)},tE=function(e,t){return Object(Gr.d)(uS.o)(e,void 0,1)},sE=function(e,t){return Object(Gr.d)(uS.j)(e,void 0,2)},iE=function(e,t){return Object(Gr.d)(uS.q)(e,void 0,3)},aE=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,4)},nE=function(e,t){return i.ModuleContainer.inject(ba)(e,void 0,5)},rE=function(e,t){return i.ModuleContainer.inject(ga.b)(e,void 0,6)},oE=function(e,t){return i.ModuleContainer.inject(xs.d)(e,void 0,7)},dE=function(e,t){return i.ModuleContainer.inject(vs)(e,void 0,8)},lE=Reflect.metadata("design:type",Function),cE=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMessageProcessor?Object:AFMC_IMessageProcessor,"undefined"==typeof AFMC_ISufficientMessageController?Object:AFMC_ISufficientMessageController,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,"undefined"==typeof IMessageController?Object:IMessageController,void 0===ga.b?Object:ga.b,void 0===xs.d?Object:xs.d,"undefined"==typeof ISystemTime?Object:ISystemTime]),hE=oO((([e])=>`${e.convId}::${e.requestMsgId}`)),uE=Reflect.metadata("design:type",Function),gE=Reflect.metadata("design:paramtypes",["undefined"==typeof IBatchRequestInfo?Object:IBatchRequestInfo]),mE=oO((([e])=>`${e.convId}::${e.requestMsgId}`)),pE=Reflect.metadata("design:type",Function),fE=Reflect.metadata("design:paramtypes",["undefined"==typeof IBatchRequestInfo?Object:IBatchRequestInfo,Array]),JS(vE=YS(vE=XS(vE=eE(vE=tE(vE=sE(vE=iE(vE=aE(vE=nE(vE=rE(vE=oE(vE=dE(vE=lE(vE=cE((bE=class{constructor(e,t,s,i,a,n,r,o,d){this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.groupManager=void 0,this.convManager=void 0,this.messageProcessor=void 0,this.messageController=void 0,this.sufficientMessageController=void 0,this.logger=a.createZLogger(ci.ZLoggerNametags.autoFetchMsgCloud,[ci.ZLoggerNametags.service]),this.config=e,this.storage=t,this.systemTime=d,this.convManager=o,this.groupManager=r,this.messageProcessor=s,this.messageController=n,this.sufficientMessageController=i}getThrottle(e){return e?Math.max(this.config.get("min_throttle"),this.config.get("throttle")+this.config.get("throttle_idle")):Math.max(this.config.get("min_throttle"),this.config.get("throttle"))}allowFetchForeground(){return this.config.get("enable_fetch_foreground")}async fetchMessages(e){const{convId:t,requestMsgId:s}=e,i=this.config.get("batch_size"),a=await this.messageController.fetchMessagesCloud(t,s,i,{isOA:0,src:$S.c.AUTO_FETCH_MINI_CLOUD});return a.groupMsgs.forEach((e=>e.setSrc(R.MSG_SRC.AUTO_LOADER))),a}async processMessages(e,t){const[s,i]=await Br.b.catchPromise(this.messageProcessor.process(e,t));return rb(s,new ZS("Save messages error "+(null==s?void 0:s.toString()))),i}checkBusyHour(){const e=this.systemTime.getTimeNow(),t=qS()(e).get("h");if(!1===this.config.get("time_exclude").includes(t))return[!1,0];const s=Math.random()*Math.max(this.config.get("throttle"),this.config.get("min_throttle")),i=qS()(e).add(1,"h").set("m",0).set("s",0).toDate().getTime();return[!0,Math.abs(i-e)+s]}checkMaxRetryBatch(e,t){if(e>=this.config.get("max_retry_batch"))return[!0,0];let s=this.getThrottle(t)+1e3*Math.random();if("fibo"===this.config.get("retry_strategy"))s+=1e3*Br.d.get(e+1);return[!1,s]}async isInsufficientMessage(){const e=await this.sufficientMessageController.getLastTsSufficientMessage();return this.systemTime.getTimeNow()-e>this.config.get("max_time_check_insufficient_data")}isQueueMessageGroup(e){return this.config.get("queue_config").includes(e.toString())}async getGroupsHasMessageOffline(){let e=!1,t=[];const s=await this.storage.getOverflowInfo();if(s){const i=await this.messageController.getGroupHasMessageOffline(s.queueId,s.lastMsgId,s.lastActionId);e=i.evict,t=i.listConvIds,OS.a&&this.config.get("debugger.simulator.overflow_db_group_offline")&&(e=!0)}const i=await this.storage.getAllConvIds(),a=Br.a.merge(t,i),[n,r]=await Br.b.catchPromise(this.groupManager.getMulti(a));rb(n,new QS(a,n));return{listGroups:await Br.a.asyncMapParallel(r,(async e=>{const s=await this.convManager.get(e.id),i=e.isAdmin()||e.isOwner(),a=!(null==s||!s.isPinned),n=!(null==s||!s.isMuted),r=e.totalMembers;let o=-1,d=-1;const l=await(null==s?void 0:s.getLastMessage());return null!=l&&l.sendDttm&&(o=Number(l.sendDttm),d=Br.c.getNumberOfDays(o,this.systemTime.getTimeNow())),{convId:e.id,groupInfo:e,isNewGroupOffline:t.includes(e.id),isPinned:a,isOwnerOrAdmin:i,isMuted:n,lastActiveTime:o,totalMembers:r,lastActiveTimeInDays:d}})),evict:e}}reloadMessageOfConv(e){this.messageController.reloadMessage(e)}},Object(qv.a)(bE.prototype,"fetchMessages",[hE,uE,gE],Object.getOwnPropertyDescriptor(bE.prototype,"fetchMessages"),bE.prototype),Object(qv.a)(bE.prototype,"processMessages",[mE,pE,fE],Object.getOwnPropertyDescriptor(bE.prototype,"processMessages"),bE.prototype),vE=bE))||vE)||vE)||vE)||vE)||vE)||vE)||vE)||vE)||vE)||vE)||vE)||vE)||vE)||vE);var IE,_E=s("+Mel"),CE=s("C3LF");let OE=Object(gS.d)()(IE=Object(Gr.e)()(IE=Object(gS.e)(uS.e)(IE=function(e,t){return Object(Gr.d)(pS)(e,void 0,0)}(IE=function(e,t){return Object(Gr.d)(mS)(e,void 0,1)}(IE=function(e,t){return Object(Gr.d)(IS)(e,void 0,2)}(IE=function(e,t){return i.ModuleContainer.inject(ke.a)(e,void 0,3)}(IE=Reflect.metadata("design:type",Function)(IE=Reflect.metadata("design:paramtypes",["undefined"==typeof IEventBus?Object:IEventBus,"undefined"==typeof ISocketPolling?Object:ISocketPolling,"undefined"==typeof SyncMessageController?Object:SyncMessageController,"undefined"==typeof BaseApplication?Object:BaseApplication])(IE=class extends je.b{constructor(e,t,s,i){super(),this.onStartPullOffline=()=>{this.dispatchEvent(new CE.l)},this.onDonePullOffline=()=>{this.dispatchEvent(new CE.n)},this.onOverflowQueue=e=>{this.dispatchEvent(new CE.j(e.queueId))},this.onStartSyncMessage=()=>{this.dispatchEvent(new CE.m("start"))},this.onResumeSyncMessage=()=>{this.dispatchEvent(new CE.m("resume"))},this.onSyncMessageSuccess=()=>{this.dispatchEvent(new CE.o("",!0))},this.onSyncMessageFailed=()=>{this.dispatchEvent(new CE.o("",!1))},this.onApplicationBackground=()=>{this.dispatchEvent(new CE.a)},this.onApplicationForeground=()=>{this.dispatchEvent(new CE.c)},this.onApplicationExit=()=>{this.dispatchEvent(new CE.b)},this.onNetworkStatusChanged=e=>{this.dispatchEvent(new CE.i(e))},this.onLogout=()=>{this.dispatchEvent(new CE.h)},this.onServiceReady=()=>{this.dispatchEvent(new CE.k)},this.onBeforeUnload=()=>{this.dispatchEvent(new CE.d)},this.registerListener(e,t,i,s)}registerListener(e,t,s,i){var a,n,r,o,d;e.subscribe(((e,t)=>{switch(e){case Os.FetchActions.CHECK_OVERFLOW_QUEUE_BY_FLAG:return this.onOverflowQueue(t);case Os.GeneralActions.NETWORK_STATUS:return this.onNetworkStatusChanged(t)}})),t.addEventListener(ku.SOCKET_POLLING_EVENT.CHAT_CONNECTED,(e=>{var t,s;e.nextChatHandler.subcribe($p.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),e.nextChatHandler.subcribe($p.b.ON_DONE_OFFLINE,this.onDonePullOffline),null===(t=e.prevChatHandler)||void 0===t||t.unsubcribe($p.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),null===(s=e.prevChatHandler)||void 0===s||s.unsubcribe($p.b.ON_DONE_OFFLINE,this.onDonePullOffline)})),null==i||null===(a=i.addEventListener)||void 0===a||a.call(i,_E.a.ON_START,this.onStartSyncMessage),null==i||null===(n=i.addEventListener)||void 0===n||n.call(i,_E.a.ON_RETRY,this.onStartSyncMessage),null==i||null===(r=i.addEventListener)||void 0===r||r.call(i,_E.a.ON_RESUME,this.onResumeSyncMessage),null==i||null===(o=i.addEventListener)||void 0===o||o.call(i,_E.a.ON_SUCCESS,this.onSyncMessageSuccess),null==i||null===(d=i.addEventListener)||void 0===d||d.call(i,_E.a.ON_FAILED,this.onSyncMessageFailed),s.addEventListener(ke.b.Idle,this.onApplicationBackground),s.addEventListener(ke.b.Active,this.onApplicationForeground),s.addEventListener(ke.b.Exit,this.onApplicationExit),s.addEventListener(ke.b.ServicesReady,this.onServiceReady),s.addEventListener(ke.b.BeforeUnload,this.onBeforeUnload),s.addEventListener(ke.b.LogOut,this.onLogout)}onLeaveGroup(e){this.dispatchEvent(new CE.f(e))}onDeleteConv(e){this.dispatchEvent(new CE.e(e))}})||IE)||IE)||IE)||IE)||IE)||IE)||IE)||IE)||IE;class SE{constructor(e){this.label=e,this.data=new Map,this.id=0,this.locked=!1}get nextId(){return++this.id}get info(){return`${this.label}: ${this.time}`}get time(){let e=0;return this.data.forEach((t=>e+=t.time)),e}lock(){this.locked=!0}unlock(){this.locked=!1}getTracker(){const e=this.nextId;return{start:()=>this.start(e),end:()=>this.end(e),do:(t,...s)=>{this.start(e);const i=t(...s);return this.end(e),i},doAsync:(t,...s)=>(this.start(e),t(...s).then((t=>(this.end(e),t)))),reset:()=>{this.data.delete(e)}}}start(e){if(this.locked)return;const t=this.data.get(e);if(t){let s=t.start;t.counting<=0&&(s=Date.now()),this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{counting:t.counting+1,start:s}))}else this.data.set(e,{counting:1,time:0,start:Date.now()})}end(e){if(this.locked)return;const t=this.data.get(e);if(t){let s=t.start,i=t.time+Date.now()-t.start;t.counting&&t.counting>1&&(s=Date.now()),this.data.set(e,Object(f.a)(Object(f.a)({},t),{},{time:i,start:s,counting:t.counting-1}))}}}class EE{constructor(e,t,s,a,n,r,o,d,l){var c;this.isNew=s,this.isPinned=a,this.isOwnerOrAdmin=n,this.isMuted=r,this.lastActiveTime=o,this.totalMembers=d,this.lastActiveTimeInDays=l,this.segmentController=void 0,this.hasMore=void 0,this.tsCheck=void 0,this.lastMsgId=void 0,this.id=void 0,this.convId=void 0,this.metrics=void 0,this.disabled=!1,this.convId=this.id=t,this.metrics=new ME(t),this.segmentController=e,this.hasMore=!0,this.tsCheck=i.ModuleContainer.resolve(vs).getTimeNow(),this.lastMsgId=(null===(c=i.ModuleContainer.resolve(xs.b).getConvByIdSync(this.convId))||void 0===c?void 0:c.lastSmsLocalId)||"0"}getCursor(){return{value:()=>this.getCurrentCursorValue(),next:e=>this.update(e)}}async update(e){const t=await this.segmentController.get(this.convId),s=await this.segmentController.updateSegment(t,e);this.hasMore=this.isHasMoreMessage(e,s)}disable(){this.disabled=!0}async isDone(){return null===await this.getCurrentCursorValue()}async getCurrentCursorValue(){var e;if(!this.hasMore)return null;if(this.disabled)return null;const t=await this.segmentController.get(this.convId),s=this.getRequestMsgId(t);return null===s?null:{convId:this.convId,requestMsgId:s,lastMsgId:this.lastMsgId,lastDeleteMsgId:(null===(e=t.lastDeletedMsgID)||void 0===e?void 0:e.toString())||"0"}}getRequestMsgId(e){var t,s,i;const a=null!==(t=e.lastDeletedMsgID)&&void 0!==t?t:0,n=null!==(s=e.lastCloudVerifiedDttm)&&void 0!==s?s:0,r=null!==(i=e.cloudSegmentCheckAutoFetch)&&void 0!==i?i:[];if(parseInt(this.lastMsgId.replace(".",""))<=a)return null;if(this.tsCheck>n)return"9999999999999999";for(let o=r.length-1;o>=0;o--){const[e,t]=r[o];if(a>=t)return null;if(a<e)return String(e)}return null}isHasMoreMessage(e,t){return!!e.hasMore&&(0!==e.messages.length&&this.getRequestMsgId(t)!==e.requestMsgId)}}class ME{constructor(e){this.convId=e,this.timeTracker=new TE,this.tsStart=0,this.tsStop=0,this.isDone=!1,this.totalBatch=0,this.totalRetry=0}get metrics(){return i.ModuleContainer.resolve(uS.l).get(uS.k)}start(){this.tsStart=performance.now()}stop(e){this.tsStop=performance.now(),this.isDone=e}exportReport(){const e=this.tsStop||performance.now(),t=this.timeTracker.prepare.time,s=this.timeTracker.fetch.time,i=this.timeTracker.sync.time,a=e-this.tsStart,n=a-(t+s+i);return{convId:this.convId,meta:{isDone:this.isDone,total:this.totalBatch,retry:this.totalRetry},duration:{total:a,prepare:t,fetch:s,save:i,idle:n}}}increaseBatch(){this.totalBatch++}increaseRetry(){this.totalRetry++}submit(){const e=this.exportReport();this.metrics.submitConvReport(e)}}class TE{constructor(){this.prepare=new SE("AFMC_prepare"),this.fetch=new SE("AFMC_fetch"),this.sync=new SE("AFMC_sync")}}class wE extends je.a{constructor(){super(TS.OVERFLOW_DB_GROUP_OFFLINE)}}var RE,LE,FE,DE,AE,jE,PE,NE,UE,kE,BE,GE,xE,zE;let VE=(RE=Object(Gr.e)(),LE=Object(gS.d)(),FE=Object(gS.e)(uS.h),DE=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,0)},AE=function(e,t){return Object(Gr.d)(uS.n)(e,void 0,1)},jE=function(e,t){return Object(Gr.d)(uS.o)(e,void 0,2)},PE=function(e,t){return Object(Gr.d)(uS.k)(e,void 0,3)},NE=Reflect.metadata("design:type",Function),UE=Reflect.metadata("design:paramtypes",[void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics]),kE=((e=rO)=>(t,s,i)=>{const a=i.value,n="AsyncFunction"===a.constructor.name;i.value=n?async function(...t){let s=0;for(;;){var i;const[n,r]=await Br.b.catchAsyncFn((()=>a.apply(this,t)));if(!n)return r;if(null==e||null===(i=e.onRetry)||void 0===i||i.call(e,n),++s>=e.maxRetry)throw n;e.delay&&await Br.b.delay(e.delay+1e3*Math.random())}}:function(...t){let s=0;for(;;){var i;const[n,r]=Br.b.catchFn((()=>a.apply(this,t)));if(!n)return r;if(null==e||null===(i=e.onRetry)||void 0===i||i.call(e,n),++s>=e.maxRetry)throw n}}})({maxRetry:3,delay:3e3}),BE=Reflect.metadata("design:type",Function),GE=Reflect.metadata("design:paramtypes",[]),RE(xE=LE(xE=FE(xE=DE(xE=AE(xE=jE(xE=PE(xE=NE(xE=UE((zE=class extends je.b{constructor(e,t,s,i){super(),this.logger=void 0,this.service=void 0,this.storage=void 0,this.metrics=void 0,this.listCheckpoints=void 0,this.currentCursorIndex=void 0,this.logger=e.createZLogger(ci.ZLoggerNametags.autoFetchMsgCloud,[ci.ZLoggerNametags.stateMachine]),this.service=t,this.storage=s,this.metrics=i,this.listCheckpoints=[],this.currentCursorIndex=-1}async init(){var e;const{listGroups:t,evict:s}=await this.service.getGroupsHasMessageOffline();s&&this.dispatchEvent(new wE);const a=t.map((e=>e.convId)),n=i.ModuleContainer.resolve(eo);this.listCheckpoints=t.map((e=>new EE(n,e.convId,e.isNewGroupOffline,e.isPinned,e.isOwnerOrAdmin,e.isMuted,e.lastActiveTime,e.totalMembers,e.lastActiveTimeInDays))),this.listCheckpoints.sort(Br.a.Sorter.create([{key:"lastActiveTime",comparer:Br.a.Sorter.Comparer.number,order:Br.a.Sorter.Order.DES},{key:"isPinned",comparer:Br.a.Sorter.Comparer.bool},{key:"isOwnerOrAdmin",comparer:Br.a.Sorter.Comparer.bool},{key:"isMuted",comparer:Br.a.Sorter.Comparer.bool,order:Br.a.Sorter.Order.DES},{key:"lastActiveTimeInDays",comparer:Br.a.Sorter.Comparer.number},{key:"totalMembers",comparer:Br.a.Sorter.Comparer.number}])),this.currentCursorIndex=0-Number(this.listCheckpoints.length<=0),null===(e=this.getCurrentCursorValue())||void 0===e||e.metrics.start(),await this.storage.saveConvIds(a),await this.storage.removeOverflowInfo(),this.logger.zsymb(0,"EVUI8g","init ledger success",a),this.metrics.submitLedgerReport(this.listCheckpoints);return{isEvict:s,isHasNewConv:this.listCheckpoints.some((e=>e.isNew))}}async size(){return await this.storage.getRemainConv()}async clear(){await Promise.all([this.storage.saveConvIds([]),this.storage.removeOverflowInfo()]),this.listCheckpoints=[]}getCursor(){return{value:async()=>this.getCurrentCursorValue(),next:async()=>this.handleNextCursor()}}async remove(e){await this.storage.forceRemoveConvId(e);const t=this.listCheckpoints.find((t=>t.id===e));return!!t&&(t.disable(),!0)}getCurrentCursorValue(){var e;return null!==(e=this.listCheckpoints[this.currentCursorIndex])&&void 0!==e?e:null}async handleNextCursor(){var e;const t=this.getCurrentCursorValue();if(t){const e=await t.isDone();e&&await this.storage.removeConvId(t.convId),t.metrics.stop(e),t.metrics.submit()}this.currentCursorIndex++,null===(e=this.getCurrentCursorValue())||void 0===e||e.metrics.start()}},Object(qv.a)(zE.prototype,"init",[kE,BE,GE],Object.getOwnPropertyDescriptor(zE.prototype,"init"),zE.prototype),xE=zE))||xE)||xE)||xE)||xE)||xE)||xE)||xE)||xE)||xE),HE=function(e){return e.SUCCESS="success",e.FAILED="failed",e.FILLED_BY_SYNC="filled_by_sync",e}({}),$E=function(e){return e.NONE="none",e.CLOSE_APP="close_app",e}({}),WE=function(e){return e.NEW="new",e.RESUME="resume",e.RESUME_AND_NEW="resume_and_new",e}({}),qE=function(e){return e[e.AVG_EXECUTION_TIME_EACH_CONV=151050]="AVG_EXECUTION_TIME_EACH_CONV",e[e.AVG_BATCH=151051]="AVG_BATCH",e[e.AVG_BATCH_RETRY=151052]="AVG_BATCH_RETRY",e[e.AVG_CONV=151053]="AVG_CONV",e[e.AVG_NEW_CONV=151054]="AVG_NEW_CONV",e[e.ERROR_RUNNING=151055]="ERROR_RUNNING",e}({}),KE=function(e){return e.SYNC_MESSAGE="SYNC_MESSAGE",e}({});var ZE=s("Fbac");let QE=function(e){return e.PREPARE_BATCH="PREPARE_BATCH",e.FETCH_MESSAGE="FETCH_MESSAGE",e.PROCESS_MESSAGE="PROCESS_MESSAGE",e}({}),JE=function(e){return e[e.PREPARE_BATCH=0]="PREPARE_BATCH",e[e.FETCH_MESSAGE=1]="FETCH_MESSAGE",e[e.PROCESS_MESSAGE=2]="PROCESS_MESSAGE",e}({});class YE extends xr{constructor(e,t){super("ErrorTaskAborted",-1,`Task [type,id]=[${e},${t}] is aborted`)}}let XE=function(e){return e.ABORT="ABORT",e.PAUSE="PAUSE",e.RESUME="RESUME",e.FULFILLED="FULFILLED",e}({});class eM extends je.b{constructor(){super(),this.id=void 0,this.type=void 0,this.promiseContainer=void 0,this.abortee=void 0,this.status=void 0,this.isPaused=void 0,this.result=void 0,this.error=void 0,this.onAbort=()=>{this.error=new YE(this.type,this.id),this.resolvePromise(),this.dispatchEvent(new je.a(XE.ABORT))},this.status="idle",this.isPaused=!1,this.abortee=new AbortController,this.promiseContainer=new Br.b.Container}exec(e){return this.status="pending",this.abortee.signal.addEventListener("abort",this.onAbort,{once:!0}),Br.b.catchPromise(e()).then((([e,t])=>{this.error=e,this.result=t,this.status="fulfilled",this.isPaused||this.resolvePromise()})),this}toPromise(){return this.promiseContainer.promise}pause(){this.isPaused=!0,this.dispatchEvent(new je.a(XE.PAUSE))}resume(){this.isPaused=!1,this.dispatchEvent(new je.a(XE.RESUME)),this.abortee.signal.aborted||"fulfilled"===this.status&&this.resolvePromise()}abort(){this.abortee.abort()}resolvePromise(){this.error?this.promiseContainer.reject(this.error):this.promiseContainer.resolve(this.result),this.dispatchEvent(new je.a(XE.FULFILLED)),this.abortee.signal.removeEventListener("abort",this.onAbort),this.removeAllEventListener()}}class tM extends eM{constructor(){super(),this.id=void 0,this.type="prepare",this.id=++tM.counter}}tM.counter=0;class sM extends eM{constructor(){super(),this.id=void 0,this.type="fetch",this.id=++sM.counter}}sM.counter=0;class iM extends eM{constructor(){super(),this.id=void 0,this.type="process",this.id=++iM.counter}}iM.counter=0;class aM extends eM{constructor(){super(),this.id=void 0,this.type="sleep",this.id=++aM.counter}}aM.counter=0;const nM={isBackground:!1,pausedCounter:0,error:null,totalMessageFetched:0,totalMessageSaved:0,task:null,currentStep:QE.PREPARE_BATCH,convCheckpoint:null,batchRequestInfo:null,batchResponseInfo:null,retryCounter:0};var rM;let oM=Object(gS.d)()(rM=Object(Gr.e)()(rM=Object(gS.e)(uS.i)(rM=function(e,t){return Object(Gr.d)(uS.h)(e,void 0,0)}(rM=function(e,t){return Object(Gr.d)(uS.b)(e,void 0,1)}(rM=function(e,t){return Object(Gr.d)(uS.n)(e,void 0,2)}(rM=function(e,t){return Object(Gr.d)(uS.o)(e,void 0,3)}(rM=function(e,t){return Object(Gr.d)(uS.k)(e,void 0,4)}(rM=function(e,t){return i.ModuleContainer.inject(uS.d)(e,void 0,5)}(rM=function(e,t){return i.ModuleContainer.inject(vs)(e,void 0,6)}(rM=function(e,t){return Object(Gr.d)(mS)(e,void 0,7)}(rM=function(e,t){return Object(Gr.d)(uS.e)(e,void 0,8)}(rM=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,9)}(rM=Reflect.metadata("design:type",Function)(rM=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_ILedger?Object:AFMC_ILedger,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics,"undefined"==typeof AFMC_IDevtoolMonitor?Object:AFMC_IDevtoolMonitor,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof ISocketPolling?Object:ISocketPolling,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(rM=class extends wu{constructor(e,t,s,i,a,n,r,o,d,l){super(),this.logger=void 0,this.config=void 0,this.ledger=void 0,this.service=void 0,this.storage=void 0,this.monitor=void 0,this.metrics=void 0,this.systemTime=void 0,this.socketPolling=void 0,this.eventCollector=void 0,this.currentSessionFetchInfo=void 0,this.registerSessionFetchListener=()=>{this.logger.zsymb(0,"18OkJd","register session fetch listener"),this.eventCollector.addEventListener(MS.a.LOAD_MESSAGE,this.onLoadMessage),this.eventCollector.addEventListener(MS.a.APPLICATION_BACKGROUND,this.onApplicationBackground),this.eventCollector.addEventListener(MS.a.APPLICATION_FOREGROUND,this.onApplicationForeground)},this.unregisterSessionFetchListener=()=>{this.logger.zsymb(0,"3V1y7u","unregister session fetch listener"),this.eventCollector.removeEventListener(MS.a.LOAD_MESSAGE,this.onLoadMessage),this.eventCollector.removeEventListener(MS.a.APPLICATION_BACKGROUND,this.onApplicationBackground),this.eventCollector.removeEventListener(MS.a.APPLICATION_FOREGROUND,this.onApplicationForeground)},this.onEventChange=e=>{switch(e.type){case"START":this.onMachineStartFetch(),this.registerSessionFetchListener();break;case"STOP":this.unregisterSessionFetchListener(),this.onMachineStopFetch();break;case"NEXT_TO_SLEEP_TO_NEXT_HOUR":this.logger.zsymb(0,"qetr-E","Busy hour, let sleep to next hour");break;case"TRY_MOVE_TO_NEXT_CONV":this.onFetchConvError(e.data.currConvId);break;case"PROCESS_MESSAGE_SUCCESS":this.storage.saveTotalMessageFetched(e.data.totalMessageFetched);break;case"FAILED":const t=this.interpreter.state.context,{batchRequestInfo:s,currentStep:i}=t,a=`${i}-${null==s?void 0:s.convId}-${null==s?void 0:s.requestMsgId}`;this.logger.zsymb(18,"B6QftU",`An error ocurred during fetch message ${a}`),this.logger.zsymb(18,"QFaQ21",e.error),this.metrics.submitErrorRunning(i,e.error)}},this.onEventChangeForDevtool=async e=>{switch(e.type){case"PREPARE_BATCH_SUCCESS":this.monitor.updateBatchRequestInfo(e.data.batchRequestInfo),this.monitor.updateRemainConv(await this.ledger.size()),this.config.get("debugger.logger.batch_request_info")&&this.logger.zsymb(12,"s5jmVk","batch request info",e.data.batchRequestInfo);break;case"PROCESS_MESSAGE_SUCCESS":var t,s;if(this.monitor.updateTotalMessageFetched(e.data.totalMessageFetched),this.config.get("debugger.logger.save_message"))this.logger.zsymb(12,"JckGJG","save message result",null===(t=e.data.result)||void 0===t?void 0:t.batchInfo,null===(s=e.data.result)||void 0===s?void 0:s.messages.map((e=>e.msgId)));break;case"STOP":this.monitor.updateBatchRequestInfo(null),this.monitor.updateRemainConv(await this.ledger.size())}},this.onTransitionChangeForDevtool=e=>{const t=["idle","running","paused","locked"];for(const s of t)if(e.matches(s))return this.monitor.updateStatus(s)},this.onFetchConvError=async e=>{this.logger.zsymb(18,"SJIj4K","Save conv fetch failed",e),await this.storage.saveConvErrorId(e)},this.onMachineStartFetch=()=>{var e,t;this.metrics.submitStartFetchReport(null!==(e=null===(t=this.currentSessionFetchInfo)||void 0===t?void 0:t.startType)&&void 0!==e?e:null)},this.onMachineStopFetch=async()=>{var e,t;await this.metrics.submitStopFetchReport((null===(e=this.currentSessionFetchInfo)||void 0===e?void 0:e.startType)||null,(null===(t=this.currentSessionFetchInfo)||void 0===t?void 0:t.interuptType)||null,await this.ledger.size()),this.currentSessionFetchInfo=null},this.onStartPullDataOffline=()=>{this.pauseMachine()},this.onStopPullDataOffline=async()=>{var e,t;const s=await this.ledger.size();s>0&&this.metrics.logResumeFetchAfterInterupt();const[i,a]=await Br.b.catchPromise(this.ledger.init());if(i)return this.logger.zsymb(18,"PpeU1f","An error occured during init ledger",i),this.stopMachine(),void(this.currentSessionFetchInfo=null);const{isHasNewConv:n,isEvict:r}=a;if(0===await this.ledger.size())return this.logger.zsymb(0,"pdzwoO","stop machine"),this.stopMachine(),void(this.currentSessionFetchInfo=null);n&&this.resetMachine(),this.currentSessionFetchInfo={startType:n&&s>0?WE.RESUME_AND_NEW:n&&0===s?WE.NEW:WE.RESUME},null!==(e=this.interpreter)&&void 0!==e&&null!==(t=e.state.history)&&void 0!==t&&t.matches("running")?(this.logger.zsymb(0,"UqrvHk","resume machine"),this.resumeMachine()):(this.logger.zsymb(0,"EJ_BsC","start machine"),this.startMachine()),await this.storage.saveStartFetchInfo({evict:r,tsStart:this.systemTime.getTimeNow(),tsSufficient:await this.storage.getLastTsSufficientMessage()})},this.onStartTransferMessage=()=>{this.pauseMachine()},this.onStopTransferMessage=async e=>{const t=await this.ledger.size();t>0&&this.currentSessionFetchInfo&&e.isSuccess&&(this.currentSessionFetchInfo.interuptType=KE.SYNC_MESSAGE),e.isSuccess?(await this.ledger.clear(),this.stopMachine()):this.resumeMachine();t>0&&this.metrics.logStopInteruptFetch(KE.SYNC_MESSAGE,e.isSuccess)},this.onDeleteConv=async e=>{this.logger.zsymb(0,"qF9GRl",`Receive delete conversation ${e.convId} event`),this.handleRemoveConv(e.convId)},this.onLeaveGroup=async e=>{this.logger.zsymb(0,"uq0r4a",`Receive leave group ${e.convId} event`),this.handleRemoveConv(e.convId)},this.onLoadMessage=e=>{if(!this.config.get("enable_fetch_foreground"))return;this.pauseMachine();const t=this.config.get("debugger.simulator.slow_load_message");e.promiseContainer.promise.then((()=>t?Br.b.delay(5e3):void 0)).finally((()=>this.resumeMachine()))},this.onApplicationBackground=()=>{this.backgroundMachine()},this.onApplicationForeground=()=>{this.foregroundMachine()},this.autoStartMachine=()=>{var e,t;null!==(e=this.socketPolling.chatHandler)&&void 0!==e&&e.isDoneOffline&&null!==(t=this.interpreter)&&void 0!==t&&t.state.matches("idle")&&(this.logger.zsymb(0,"ssSYsp","Done offline detected, auto dispatch stop pull offline"),this.onStopPullDataOffline())},this.startMachine=()=>this.send({type:"START"}),this.resetMachine=()=>this.send({type:"RESET"}),this.stopMachine=()=>this.send({type:"STOP"}),this.pauseMachine=()=>this.send({type:"PAUSED"}),this.resumeMachine=()=>this.send({type:"RESUME"}),this.foregroundMachine=()=>this.send({type:"FOREGROUND"}),this.backgroundMachine=()=>this.send({type:"BACKGROUND"}),this.logger=l.createZLogger(ci.ZLoggerNametags.autoFetchMsgCloud,[ci.ZLoggerNametags.stateMachine]),this.ledger=e,this.config=t,this.service=s,this.storage=i,this.metrics=a,this.monitor=n,this.systemTime=r,this.socketPolling=o,this.eventCollector=d,this.currentSessionFetchInfo=null}createMachine(){return e=this.ledger,t=this.service,Object(Lu.a)({id:"afmc-machine-v2",initial:"idle",context:nM,states:{idle:{on:{RESUME:{target:"#afmc-machine-v2.resume",actions:["decreasePausedCounter","logPausedCounter"]}}},running:{id:"running",type:"compound",initial:"checking",states:{checking:{invoke:{src:s=>async i=>{var a;if(null===await e.getCursor().value())return void i({type:"STOP"});const[n,r]=t.checkBusyHour();if(n)i({type:"NEXT_TO_SLEEP_TO_NEXT_HOUR",data:{time:r}});else if("sleep"!==(null===(a=s.task)||void 0===a?void 0:a.type))if(s.isBackground||t.allowFetchForeground())switch(s.currentStep){case QE.PREPARE_BATCH:return void i({type:"NEXT_TO_PREPARE_BATCH"});case QE.FETCH_MESSAGE:return void i({type:"NEXT_TO_FETCH_MESSAGE"});case QE.PROCESS_MESSAGE:return void i({type:"NEXT_TO_PROCESS_MESSAGE"});default:return void i({type:"NEXT_TO_SLEEP"})}else i({type:"NEXT_TO_SLEEP"});else i({type:"NEXT_TO_SLEEP"})}},on:{NEXT_TO_PREPARE_BATCH:{target:"#running.prepareBatch"},NEXT_TO_FETCH_MESSAGE:{target:"#running.fetchMessage"},NEXT_TO_PROCESS_MESSAGE:{target:"#running.processMessage"},NEXT_TO_SLEEP:{target:"#running.sleep"},NEXT_TO_SLEEP_TO_NEXT_HOUR:{target:"#running.sleep"},STOP:{target:"#afmc-machine-v2.idle"}}},prepareBatch:{invoke:{src:t=>async s=>{var i;if("prepare"===(null===(i=t.task)||void 0===i?void 0:i.type))t.task.resume();else{const i=t.task=new tM,n=e.getCursor(),r=await n.value(),o=r.metrics.timeTracker.prepare.getTracker();try{o.start();const e=await i.exec((async()=>{const e=await r.getCursor().value();return null===e?(await n.next(),null):(r.metrics.increaseBatch(),{convCheckpoint:r,batchRequestInfo:e})})).toPromise(),{convCheckpoint:a=null,batchRequestInfo:d=null}=e||{};t.convCheckpoint=r,t.batchRequestInfo=d,a&&d?(t.currentStep=QE.FETCH_MESSAGE,s({type:"PREPARE_BATCH_SUCCESS",data:{batchRequestInfo:d,convCheckpoint:a}})):s({type:"MOVE_TO_NEXT_CONV"})}catch(a){if(a instanceof YE)return;s({type:"FAILED",error:a})}finally{o.end()}}}},on:{PREPARE_BATCH_SUCCESS:{target:"#running.checking",actions:"clearTask"},MOVE_TO_NEXT_CONV:{target:"#running.checking",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},fetchMessage:{invoke:{src:e=>async s=>{var i;if("fetch"===(null===(i=e.task)||void 0===i?void 0:i.type))e.task.resume();else{const i=e.task=new sM,{batchRequestInfo:n,convCheckpoint:r}=e,o=r.metrics.timeTracker.fetch.getTracker();try{o.start();const a=await i.exec((()=>t.fetchMessages(n))).toPromise();e.batchResponseInfo=a,e.currentStep=QE.PROCESS_MESSAGE,s({type:"FETCH_MESSAGE_SUCCESS",data:{batchResponseInfo:a}})}catch(a){if(a instanceof YE)return;s({type:"FAILED",error:a})}finally{o.end()}}}},on:{FETCH_MESSAGE_SUCCESS:{target:"#running.checking",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},processMessage:{invoke:{src:e=>async s=>{var i;if("process"===(null===(i=e.task)||void 0===i?void 0:i.type))e.task.resume();else{const i=e.task=new iM,{batchRequestInfo:r,batchResponseInfo:o,convCheckpoint:d}=e,l=d.metrics.timeTracker.sync.getTracker();try{var a;l.start();const n=o.groupMsgs,c=await i.exec((async()=>{const e=await t.processMessages(r,n);return await d.getCursor().next({messages:n,requestMsgId:r.requestMsgId,lastMsgId:r.lastMsgId,checkLoadTop:!0,hasMore:o.hasMore}),e})).toPromise();e.totalMessageFetched+=n.length,e.totalMessageSaved+=(null==c||null===(a=c.messages)||void 0===a?void 0:a.length)||0,e.error=null,e.retryCounter=0,e.currentStep=QE.PREPARE_BATCH,s({type:"PROCESS_MESSAGE_SUCCESS",data:{result:c,totalMessageFetched:n.length}})}catch(n){if(n instanceof YE)return;s({type:"FAILED",error:n})}finally{l.end()}}}},on:{PROCESS_MESSAGE_SUCCESS:{target:"#running.sleep",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},sleep:{invoke:{src:(e,s)=>async i=>{var a;if("sleep"===(null===(a=e.task)||void 0===a?void 0:a.type))e.task.resume();else{const a=e.task=new aM;try{let n=0;switch(s.type){case"NEXT_TO_SLEEP_TO_NEXT_HOUR":case"RETRY":n=s.data.time;break;default:n=t.getThrottle(e.isBackground)}await a.exec((()=>Br.b.delay(n))).toPromise(),i({type:"WAKE_UP"})}catch(n){}}}},on:{WAKE_UP:{target:"#running.checking",actions:"clearTask"}}},checkRetry:{invoke:{src:s=>async i=>{var a;const[n,r]=t.checkMaxRetryBatch(s.retryCounter,s.isBackground);if(n){var o;await e.getCursor().next();const t=(null===(o=s.batchRequestInfo)||void 0===o?void 0:o.convId)||"";return s.error=null,s.retryCounter=0,s.currentStep=QE.PREPARE_BATCH,i({type:"TRY_MOVE_TO_NEXT_CONV",data:{currConvId:t}})}return null===(a=s.convCheckpoint)||void 0===a||a.metrics.increaseRetry(),s.retryCounter++,i({type:"RETRY",data:{time:r}})}},on:{RETRY:{target:"#running.sleep"},TRY_MOVE_TO_NEXT_CONV:{target:"#running.sleep"}}}}},paused:{on:{RESUME:{target:"#afmc-machine-v2.resume",actions:["decreasePausedCounter","logPausedCounter"]}}},resume:{invoke:{src:e=>async t=>{e.pausedCounter?t({type:"RESUME_PAUSED"}):t({type:"RESUME_RUNNING"})}},on:{RESUME_PAUSED:{target:"#afmc-machine-v2.paused"},RESUME_RUNNING:{target:"#afmc-machine-v2.running"}}}},on:{PAUSED:{target:"#afmc-machine-v2.paused",actions:["increasePausedCounter","pauseTask","logPausedCounter"]},STOP:{target:"#afmc-machine-v2.idle",actions:["abortTask","resetAll"]},RESET:{actions:"reset"},START:{target:"#afmc-machine-v2.resume",actions:"decreasePausedCounter"},FOREGROUND:{actions:"foreground"},BACKGROUND:{actions:"background"}}},{actions:{attachError:ZE.a.assign(((e,t)=>Object(f.a)(Object(f.a)({},e),{},{error:t.error}))),abortTask:e=>{var t;return null!==(t=e.task)&&void 0!==t&&t.abort(),e.task=null},pauseTask:e=>{var t;return null===(t=e.task)||void 0===t?void 0:t.pause()},clearTask:ZE.a.assign((e=>Object(f.a)(Object(f.a)({},e),{},{task:null}))),increasePausedCounter:ZE.a.assign((e=>Object(f.a)(Object(f.a)({},e),{},{pausedCounter:e.pausedCounter+1}))),decreasePausedCounter:ZE.a.assign((e=>Object(f.a)(Object(f.a)({},e),{},{pausedCounter:Math.max(e.pausedCounter-1,0)}))),logPausedCounter:e=>{OS.a},foreground:ZE.a.assign((e=>Object(f.a)(Object(f.a)({},e),{},{isBackground:!1}))),background:ZE.a.assign((e=>Object(f.a)(Object(f.a)({},e),{},{isBackground:!0}))),reset:ZE.a.assign((({isBackground:e,pausedCounter:t})=>Object(f.a)(Object(f.a)({},nM),{},{isBackground:e,pausedCounter:t}))),resetAll:ZE.a.assign((()=>Object(f.a)({},nM)))}});var e,t}start(){super.start(),this.registerListener(),this.autoStartMachine()}stop(){this.unregisterListener(),this.unregisterSessionFetchListener(),super.stop(),this.monitor.updateStatus("disabled")}hasRemainConvInPrevSession(){return null!==this.currentSessionFetchInfo&&this.currentSessionFetchInfo.startType!==WE.NEW}registerListener(){var e,t,s;(this.logger.zsymb(0,"OjqQ5X","register persit listener"),this.eventCollector.addEventListener(MS.a.START_PULL_OFFLINE_DATA,this.onStartPullDataOffline),this.eventCollector.addEventListener(MS.a.STOP_PULL_OFFLINE_DATA,this.onStopPullDataOffline),this.eventCollector.addEventListener(MS.a.DELETE_CONV,this.onDeleteConv),this.eventCollector.addEventListener(MS.a.LEAVE_GROUP,this.onLeaveGroup),this.eventCollector.addEventListener(MS.a.START_TRANSFER_MESSAGE,this.onStartTransferMessage),this.eventCollector.addEventListener(MS.a.STOP_TRANSFER_MESSAGE,this.onStopTransferMessage),null===(e=this.interpreter)||void 0===e||e.onEvent(this.onEventChange),OS.a)&&(null===(t=this.interpreter)||void 0===t||t.onEvent(this.onEventChangeForDevtool),null===(s=this.interpreter)||void 0===s||s.onTransition(this.onTransitionChangeForDevtool))}unregisterListener(){var e,t,s;(this.logger.zsymb(0,"Oe-FmG","unregister persit listener"),this.eventCollector.removeEventListener(MS.a.START_PULL_OFFLINE_DATA,this.onStartPullDataOffline),this.eventCollector.removeEventListener(MS.a.STOP_PULL_OFFLINE_DATA,this.onStopPullDataOffline),this.eventCollector.removeEventListener(MS.a.DELETE_CONV,this.onDeleteConv),this.eventCollector.removeEventListener(MS.a.LEAVE_GROUP,this.onLeaveGroup),this.eventCollector.removeEventListener(MS.a.START_TRANSFER_MESSAGE,this.onStartTransferMessage),this.eventCollector.removeEventListener(MS.a.STOP_TRANSFER_MESSAGE,this.onStopTransferMessage),null===(e=this.interpreter)||void 0===e||e.off(this.onEventChange),OS.a)&&(null===(t=this.interpreter)||void 0===t||t.off(this.onEventChangeForDevtool),null===(s=this.interpreter)||void 0===s||s.off(this.onTransitionChangeForDevtool))}async handleRemoveConv(e){this.pauseMachine(),await this.ledger.remove(e)?(this.logger.zsymb(0,"Fv66Bn",`Disabled checkpoint ${e} success`),this.resetMachine()):this.logger.zsymb(0,"0lvRtf",`Checkpoint ${e} does not exist`),this.resumeMachine()}})||rM)||rM)||rM)||rM)||rM)||rM)||rM)||rM)||rM)||rM)||rM)||rM)||rM)||rM)||rM;var dM,lM=s("BYQe");let cM=Object(Gr.e)()(dM=Object(gS.d)()(dM=Object(gS.e)(uS.j)(dM=function(e,t){return Object(Gr.d)(uS.f)(e,void 0,0)}(dM=function(e,t){return Object(Gr.d)(uS.p)(e,void 0,1)}(dM=function(e,t){return Object(Gr.d)(uS.g)(e,void 0,2)}(dM=Reflect.metadata("design:type",Function)(dM=Reflect.metadata("design:paramtypes",["undefined"==typeof IHandler?Object:IHandler,"undefined"==typeof IHandler?Object:IHandler,"undefined"==typeof IHandler?Object:IHandler])(dM=class{constructor(e,t,s){this.processor=void 0,this.processor=(new lM.Chain).pipe(e).pipe(t).pipe(s)}async process(e,t){return await this.processor.process({batchInfo:e,messages:t})}})||dM)||dM)||dM)||dM)||dM)||dM)||dM)||dM;var hM;let uM=Object(gS.d)()(hM=Object(Gr.e)()(hM=Object(gS.e)(uS.k)(hM=function(e,t){return i.ModuleContainer.inject(He.b)(e,void 0,0)}(hM=function(e,t){return Object(Gr.d)(bS)(e,void 0,1)}(hM=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,2)}(hM=function(e,t){return i.ModuleContainer.inject(vs)(e,void 0,3)}(hM=function(e,t){return Object(Gr.d)(uS.o)(e,void 0,4)}(hM=function(e,t){return Object(Gr.d)(uS.b)(e,void 0,5)}(hM=Reflect.metadata("design:type",Function)(hM=Reflect.metadata("design:paramtypes",["undefined"==typeof IQosService?Object:IQosService,"undefined"==typeof IActionlogService?Object:IActionlogService,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig])(hM=class{constructor(e,t,s,i,a,n){this.logger=void 0,this.qos=void 0,this.config=void 0,this.storage=void 0,this.actionlog=void 0,this.systemTime=void 0,this.qos=e,this.config=n,this.storage=a,this.actionlog=t,this.systemTime=i,this.logger=s.createZLogger(ci.ZLoggerNametags.autoFetchMsgCloud,[ci.ZLoggerNametags.metricz])}logAutoHideBannerSuggestion(){this.actionlog.logAction(2460001)}logAutoShowBannerSuggestion(e){this.actionlog.logAction(e?2460003:2460002)}logStartFetch(e,t){switch(this.actionlog.logAction(2460101),t){case RS.ONLY_GROUP:e?this.actionlog.logAction(2460104):this.actionlog.logAction(2460102);break;case RS.BOTH_1_1_AND_GROUP:e?this.actionlog.logAction(2460104):this.actionlog.logAction(2460103)}}logStopFetch(e,t,s){if(!s)return this.actionlog.logAction(2460401);switch(this.actionlog.logAction(2460201),t){case RS.ONLY_GROUP:e?this.actionlog.logAction(2460204):this.actionlog.logAction(2460202);break;case RS.BOTH_1_1_AND_GROUP:e?this.actionlog.logAction(2460204):this.actionlog.logAction(2460203)}}logStopInteruptFetch(e,t){if(e===KE.SYNC_MESSAGE)this.actionlog.logAction(t?2460302:2460303)}logResumeFetchAfterInterupt(){this.actionlog.logAction(2460304)}async submitStartFetchReport(e){if(null===e)return;const t={type:e,total_days_to_fetch:Br.f.countDays(await this.storage.getLastTsSufficientMessage(),this.systemTime.getTimeNow()),days_to_fetch_from_new_evict:-1};this.logger.zsymb(12,"f1RTH1","submit start fetch report",JSON.stringify(t)),this.actionlog.logActionInfoV2(Vt.FeaturesInfo.AutoFetchMessageCloud,2,t)}async submitStopFetchReport(e,t,s){var i,a,n,r;if(null===e)return;const o=await this.storage.getFetchInfo();if(null==o||!o.onProgressInfo)return;const d=this.systemTime.getTimeNow(),l=o.onProgressInfo.totalMsgFetched||0,c={result:t===KE.SYNC_MESSAGE?HE.FILLED_BY_SYNC:s>0?HE.FAILED:HE.SUCCESS,interupted:(()=>{switch(e){case WE.RESUME:case WE.RESUME_AND_NEW:return $E.CLOSE_APP;case WE.NEW:default:return $E.NONE}})(),filled_queue_evict:(()=>{var e;return Br.f.countDays(o.onProgressInfo.tsSufficient,d)>this.config.get("max_time_check_insufficient_data")||null!==(e=o.onProgressInfo)&&void 0!==e&&e.evict?0:1})(),estimated_fetching_time:(()=>Math.ceil(l/this.config.get("batch_size"))*this.config.get("throttle")/1e3)(),total_day_with_session_fetch:Br.f.countUniqDays(...null!==(i=null==o||null===(a=o.onProgressInfo)||void 0===a?void 0:a.listTsStart)&&void 0!==i?i:[]),days_from_start_to_complete:(()=>{var e,t;const s=Math.min(...null!==(e=null===(t=o.onProgressInfo)||void 0===t?void 0:t.listTsStart)&&void 0!==e?e:[-1]);return s<0?-1:Br.f.countDays(s,d)})(),total_conv_fetched:(null===(n=o.onProgressInfo.convIds)||void 0===n?void 0:n.length)||0,conv_fetch_failed:(null===(r=o.onProgressInfo.convErrorIds)||void 0===r?void 0:r.length)||0,total_msg_fetched:l};this.logger.zsymb(12,"n2pCRn","submit stop fetch report",JSON.stringify(c)),this.actionlog.logActionInfoV2(Vt.FeaturesInfo.AutoFetchMessageCloud,1,c),await this.storage.removeStartFetchInfo()}submitConvReport(e){OS.a&&this.logger.zsymb(12,"B7jOz1","submit metrics for conv",e.convId,JSON.stringify(e)),this.qos.log({commandId:qE.AVG_EXECUTION_TIME_EACH_CONV,success:!0,startTime:0,duration:e.duration.total,params:[JSON.stringify(e)]}),this.qos.log({commandId:qE.AVG_BATCH,success:!0,startTime:0,duration:e.meta.total}),this.qos.log({commandId:qE.AVG_BATCH_RETRY,success:!0,startTime:0,duration:e.meta.retry})}submitLedgerReport(e){const t=e.length,s=e.filter((e=>e.isNew)).length;OS.a&&this.logger.zsymb(12,"1Gsuf8","submit ledger report",JSON.stringify({totalConv:t,totalNewConv:s})),this.qos.log({commandId:qE.AVG_CONV,success:!0,startTime:0,duration:t}),this.qos.log({commandId:qE.AVG_NEW_CONV,success:!0,startTime:0,duration:s})}submitErrorRunning(e,t){this.qos.log({commandId:qE.ERROR_RUNNING,success:!1,startTime:0,errorCode:JE[e],params:[e,t.name,...t.qosParams]})}})||hM)||hM)||hM)||hM)||hM)||hM)||hM)||hM)||hM)||hM)||hM;var gM;let mM=Object(gS.d)()(gM=Object(gS.e)(uS.f)(gM=class{async process(e){const{batchInfo:t,messages:s}=e,i=s.filter((e=>parseInt(e.msgId)>parseInt(t.lastDeleteMsgId)));return{batchInfo:t,messages:i}}})||gM)||gM;var pM;let fM=Object(Gr.e)()(pM=Object(gS.d)()(pM=Object(gS.e)(uS.g)(pM=function(e,t){return Object(Gr.d)(vS)(e,void 0,0)}(pM=Reflect.metadata("design:type",Function)(pM=Reflect.metadata("design:paramtypes",["undefined"==typeof IZSearchV3?Object:IZSearchV3])(pM=class{constructor(e){this.zsearchV3=e}async process(e){return this.zsearchV3.executeData(this.filterMessageSearchable(e.messages)),e}filterMessageSearchable(e){return e.filter((e=>{var t;return"chat.delete"!==e.msgType&&"chat.undo"!==e.msgType&&"chat.list.action"!==e.msgType&&"msginfo.actionlist"!==(null===(t=e.content)||void 0===t?void 0:t.action)}))}})||pM)||pM)||pM)||pM)||pM)||pM;var vM;let bM=Object(Gr.e)()(vM=Object(gS.d)()(vM=Object(gS.e)(uS.p)(vM=function(e,t){return Object(Gr.d)(fS)(e,void 0,0)}(vM=function(e,t){return Object(Gr.d)(yS)(e,void 0,1)}(vM=Reflect.metadata("design:type",Function)(vM=Reflect.metadata("design:paramtypes",["undefined"==typeof IZStorage?Object:IZStorage,"undefined"==typeof IImportantMsgManager?Object:IImportantMsgManager])(vM=class{constructor(e,t){this.zstorage=e,this.importantMsgManager=t}async process(e){var t;const{batchInfo:s,messages:i}=e,[a,n]=await Br.b.catchPromise(this.zstorage.addMessages(s.convId,i,void 0));kr(a,new ZS("Save messages error "+JSON.stringify(a))),this.importantMsgManager.receiveImportantMessage((null==n?void 0:n.messages)||[]);const r=(null!==(t=null==n?void 0:n.messages)&&void 0!==t?t:[]).map((e=>e.msgId));return{batchInfo:s,messages:i.filter((e=>r.includes(e.msgId)))}}})||vM)||vM)||vM)||vM)||vM)||vM)||vM;var yM;let IM=Object(Gr.e)()(yM=Object(gS.d)()(yM=Object(gS.e)(uS.m)(yM=function(e,t){return i.ModuleContainer.inject(eo)(e,void 0,0)}(yM=function(e,t){return Object(Gr.d)(uS.b)(e,void 0,1)}(yM=Reflect.metadata("design:type",Function)(yM=Reflect.metadata("design:paramtypes",["undefined"==typeof ICloudSegmentController?Object:ICloudSegmentController,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig])(yM=class{constructor(e,t){this.segmentController=e,this.config=t,this.mapCounter={}}process(e){const[t,s]=e;return!s&&this.config.get("enable_segment_updater")&&Br.b.Macrotask.push((()=>this.updateSegment(t))),e}getGroupMessages(e){return e.deliverProcessData.groupMsgs}hasEvict(e){var t,s;const i=null!==(t=null==e||null===(s=e.deliverProcessData)||void 0===s?void 0:s.queueStatus)&&void 0!==t?t:{};for(const n of this.config.get("queue_config")){var a;if(null!==(a=i[n])&&void 0!==a&&a.evict)return!0}return!1}classifyMessagesByConv(e){const t={};for(const i of e){var s;const e=i.isGroup?i.msgKey:i.idTo;(t[e]=null!==(s=t[e])&&void 0!==s?s:[]).push(i)}return t}async updateSegment(e){const t=this.getGroupMessages(e);if(0===t.length)return;const s=this.classifyMessagesByConv(t),i=[];for(const a in s){const t=s[a],n=this.getRange(t);i.push(this.update(a,n,this.getModeMerged(a,e)))}await Promise.all(i)}getModeMerged(e,t){var s;let i="merge";const a=null!==(s=this.mapCounter[e])&&void 0!==s?s:0;return(this.hasEvict(t)||0===a)&&(i="split"),this.mapCounter[e]=a+1,i}getRange(e){e.sort(Br.a.Sorter.create([{key:"msgId",comparer:Br.a.Sorter.Comparer.number,order:Br.a.Sorter.Order.ASC},{key:"ts",comparer:Br.a.Sorter.Comparer.number,order:Br.a.Sorter.Order.ASC}]));const t=e.filter((e=>!isNaN(Number(e.msgId)))),s=t[0],i=t[t.length-1];return[Number(s.msgId),Number(i.msgId)]}async update(e,t,s){const i=await this.segmentController.get(e),a=0===(null!==(n=i.cloudSegmentCheckAutoFetch)&&void 0!==n?n:[]).length?(s="split",null!==(o=i.cloudSegmentCheck)&&void 0!==o?o:[]):null!==(r=i.cloudSegmentCheckAutoFetch)&&void 0!==r?r:[];var n,r,o;const d=this.mergeSegment(t,a);switch(s){case"split":i.cloudSegmentCheckAutoFetch=d;break;case"merge":i.cloudSegmentCheckAutoFetch=this.connectRange(t,d)}await this.segmentController.update(i)}connectRange(e,t){const s=[];for(let i=0;i<t.length;i++){const a=t[i],n=t[i-1];if(Db.a.isEqual(e,a)&&n){const e=n[0],t=a[1];s.pop(),s.push([e,t])}else s.push(a)}return s}mergeSegment(e,t){if(!e||2!==e.length||e[0]>e[1])return t;if(0==t.length)return[e];const s=[],[i,a]=e;let n=0,r=0;for(let o=0;o<t.length;o++){const e=t[o],d=e[0],l=e[1]===parseInt(R.MessageConstants.MAX_MSG_ID)?e[0]+1:e[1];if(r){s.push(...t.slice(o));break}i>l?(s.push([d,l]),o===t.length-1&&s.push([i,a])):(0===n&&(n=i<d?i:d),a<d?(r=a,s.push([n,r]),s.push([d,l])):a<=l&&a>=d?(r=l,s.push([n,l])):a>l&&o===t.length-1&&s.push([n,a]))}return s}})||yM)||yM)||yM)||yM)||yM)||yM)||yM;var _M;let CM=Object(gS.d)()(_M=Object(Gr.e)()(_M=Object(gS.e)(uS.q)(_M=function(e,t){return Object(Gr.d)(uS.b)(e,void 0,0)}(_M=function(e,t){return Object(Gr.d)(uS.o)(e,void 0,1)}(_M=function(e,t){return Object(Gr.d)(uS.e)(e,void 0,2)}(_M=function(e,t){return i.ModuleContainer.inject(vs)(e,void 0,3)}(_M=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,4)}(_M=Reflect.metadata("design:type",Function)(_M=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector,"undefined"==typeof ISystemTime?Object:ISystemTime,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory])(_M=class{constructor(e,t,s,i,a){this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.prevNetworkState=void 0,this.intervalUpdate=void 0,this.onApplicationExit=()=>{this.updateLastSufficientTs(),this.clearIntervalUpdate()},this.onStartPullOffline=()=>{this.clearIntervalUpdate()},this.onStopPullOffline=()=>{this.updateLastSufficientTs(),this.startIntervalUpdate()},this.logger=a.createZLogger(ci.ZLoggerNametags.autoFetchMsgCloud,[]),this.config=e,this.storage=t,this.systemTime=i,this.prevNetworkState=null,this.intervalUpdate=null,this.registerListener(s)}registerListener(e){e.addEventListener(MS.a.START_PULL_OFFLINE_DATA,this.onStartPullOffline),e.addEventListener(MS.a.STOP_PULL_OFFLINE_DATA,this.onStopPullOffline),e.addEventListener(MS.a.APPLICATION_EXIT,this.onApplicationExit)}async updateLastSufficientTs(){const e=await this.getLastTsSufficientMessage(),t=this.systemTime.getTimeNow(),s=await this.storage.getLastTsOverflowMessage()>e?e:t;await this.storage.saveLastSufficientMessage(s),this.config.get("debugger.logger.interval_update_sufficient_ts")&&this.logger.zsymb(12,"ApYpQb","Update last sufficient ts",s)}async getLastTsSufficientMessage(){const e=await Promise.all([this.storage.getLastTsSyncMessageSuccess(),this.storage.getLastTsImportMessageSuccess(),this.storage.getLastTsAutoFetchMessageSuccess(),this.storage.getLastTsCloseTransferSuggestion(),this.storage.getLastTsCloseFirstLoginTransferSuggestion(),this.storage.getLastTsSufficientMessage()]);return Math.max(...e)}startIntervalUpdate(){this.clearIntervalUpdate(),this.intervalUpdate=setInterval((()=>{this.updateLastSufficientTs()}),this.config.get("interval_check_insufficient_data"))}clearIntervalUpdate(){this.intervalUpdate&&clearInterval(this.intervalUpdate),this.intervalUpdate=null}})||_M)||_M)||_M)||_M)||_M)||_M)||_M)||_M)||_M)||_M;var OM;let SM=Object(gS.d)()(OM=Object(Gr.e)()(OM=Object(gS.e)(uS.r)(OM=function(e,t){return Object(Gr.d)(uS.b)(e,void 0,0)}(OM=function(e,t){return Object(Gr.d)(uS.o)(e,void 0,1)}(OM=function(e,t){return i.ModuleContainer.inject(vs)(e,void 0,2)}(OM=function(e,t){return i.ModuleContainer.inject(Me.ZLoggerFactory)(e,void 0,3)}(OM=function(e,t){return Object(Gr.d)(uS.e)(e,void 0,4)}(OM=Reflect.metadata("design:type",Function)(OM=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof ISystemTime?Object:ISystemTime,void 0===Me.ZLoggerFactory?Object:Me.ZLoggerFactory,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector])(OM=class{constructor(e,t,s,i,a){this.overflowQueueIds=void 0,this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.logger=i.createZLogger(ci.ZLoggerNametags.autoFetchMsgCloud,[]),this.config=e,this.storage=t,this.systemTime=s,this.overflowQueueIds=[],a.addEventListener(MS.a.OVERFLOW_MESSAGE_QUEUE,(e=>{this.overflowQueueIds.push(e.queueId.toString()),this.storage.saveLastOverflow(this.systemTime.getTimeNow())}))}process(e,t){if(e&&this.config.get("enable_tracking_overflow"))for(const s in e)if(this.config.get("queue_config").includes(s)){if(e[s].evict){const e="-1";this.saveOverflowInfo(s,e,t)}}}getOverflowStatus(){const e=!!this.overflowQueueIds.find((e=>[wS.a.SOCKET_MESSAGE_GROUP,wS.a.LP_MESSAGE_GROUP].includes(e))),t=!!this.overflowQueueIds.find((e=>[wS.a.SOCKET_MESSAGE_1_1,wS.a.LP_MESSAGE_1_1].includes(e)));return t||e?t&&e?RS.BOTH_1_1_AND_GROUP:t?RS.ONLY_1_1:RS.ONLY_GROUP:RS.NONE}async saveOverflowInfo(e,t,s){const i=await this.storage.getOverflowInfo();(null==i?void 0:i.queueId)!==e&&(await this.storage.saveOverflowInfo(e,t,s),this.logger.zsymb(0,"fERN2K","Overflow detected, let save info",{queueId:e,lastMsgId:t,lastActionId:s}))}})||OM)||OM)||OM)||OM)||OM)||OM)||OM)||OM)||OM)||OM;var EM,MM=s("h5Sw");Object(i.singleton)(uS.l)(EM=Object(ke.i)()(EM=Object(ke.f)()(EM=Object(gS.c)([ES,uM,yE,zS,VE,PS,OE,IM,bM,cM,oM,fM,HS,mM,SM,CM,{token:fS,useFactory:()=>mt.default},{token:pS,useFactory:()=>Cs.default},{token:vS,useFactory:()=>bi.a.getInstance()},{token:mS,useFactory:()=>ku.default},{token:bS,useFactory:()=>Vt.default},{token:yS,useFactory:()=>MM.a},{token:IS,useFactory:()=>i.ModuleContainer.resolveIfExist(jo.a)}])(EM=class{onAuthenticating(){this.get(uS.b)}onStart(){this.get(uS.c).start()}get(e){return gS.a.resolve(e)}})||EM)||EM)||EM);var TM;const wM="z_afmc_devtool_";Object(Hs.b)(uS.d)(TM=function(e,t){return Object(i.inject)(ba)(e,void 0,0)}(TM=Reflect.metadata("design:type",Function)(TM=Reflect.metadata("design:paramtypes",["undefined"==typeof IMessageController?Object:IMessageController])(TM=class{constructor(e){var t;this.messageController=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!0,status:"disabled",totalMessage:0,totalMessageFetched:0,remainConv:0,currentConv:"",currentRequestMsgId:"",totalMessageCurrentConv:0},this.promiseCountTotalMessage=null,this.promiseCountTotalMessageCurrConv=null,this.name="auto-fetch-message-cloud-devtool-monitor",this.key="auto-fetch-message-cloud-devtool-monitor",this.data.isShow=OS.a&&Boolean(Number(null!==(t=S.default.getInstance().getItem(wM))&&void 0!==t?t:"0")),this.toggleUpdateTotalMessage()}toggleDevtool(){!1!==OS.a&&(this.data.isShow=!this.data.isShow,this.data.isShow?S.default.getInstance().setItem(wM,Number(this.data.isShow).toString()):S.default.getInstance().removeItem(wM),Object(Kt.g)(this.name,"all"))}updateStatus(e){!1!==OS.a&&(this.data.status=e,Object(Kt.g)(this.name,"all"))}async toggleUpdateTotalMessage(){OS.a}async toggleUpdateTotalMessageCurrentConv(){if(!1===OS.a)return;this.promiseCountTotalMessageCurrConv||(this.promiseCountTotalMessageCurrConv=this.messageController.countMessages(this.data.currentConv));const e=await this.promiseCountTotalMessageCurrConv;this.promiseCountTotalMessageCurrConv=null,this.data.totalMessageCurrentConv=e,Object(Kt.g)(this.name,"all")}updateTotalMessageFetched(e){!1!==OS.a&&(this.data.totalMessageFetched+=e,Object(Kt.g)(this.name,"all"),this.toggleUpdateTotalMessage(),this.toggleUpdateTotalMessageCurrentConv())}updateRemainConv(e){!1!==OS.a&&(this.data.remainConv=e,Object(Kt.g)(this.name,"all"))}updateBatchRequestInfo(e){!1!==OS.a&&(this.data.currentConv=(null==e?void 0:e.convId)||"",this.data.currentRequestMsgId=(null==e?void 0:e.requestMsgId)||"",e||(this.data.totalMessageCurrentConv=0),Object(Kt.g)(this.name,"all"))}getItem(e,t){return Object(f.a)({},this.data)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||TM)||TM)||TM);const RM=Object(i.define)("pulloffline-reporter"),LM=()=>void 0!==ms.default.socket.offline_monitor.enable&&ms.default.socket.offline_monitor.enable,FM=()=>void 0!==ms.default.socket.offline_monitor.latency_time?ms.default.socket.offline_monitor.latency_time:3e4,DM=()=>void 0!==ms.default.socket.offline_monitor.exclude_monitors_queues?ms.default.socket.offline_monitor.exclude_monitors_queues:["516","517","518","519"];let AM;var jM;!function(e){function t(e,t,s){const i={lowestFPS:60,dropTime:e[s].ts-e[t].ts};for(let a=t;a<=s;a++)e[a].fps<i.lowestFPS&&(i.lowestFPS=e[a].fps);return i}e.getDroppeds=function(e,s){let i=0,a=0,n=s[0].fps<=e;const r=[];return s.forEach(((o,d)=>{n?(o.fps>e&&(a=d,n=!1,r.push(t(s,i,a))),d==s.length-1&&o.fps<=e&&(a=d,n=!1,r.push(t(s,i,a)))):o.fps>e?(i=d,n=!1):d==s.length-1?(a=d,n=!1,r.push(t(s,i,a))):n=!0})),r}}(AM||(AM={}));const PM={dropCount:0,min:60,dropTime:0};var NM=function(e){return e.BeforePull="beforePull",e.InPull="inPull",e.InSaveDB="inSaveDB",e.AfterSaveDB="afterSaveDB",e}(NM||{});let UM=Object(i.singleton)(La.a)(jM=Reflect.metadata("design:type",Function)(jM=Reflect.metadata("design:paramtypes",[void 0===RM?Object:RM])(jM=class{constructor(e){this.reporter=e,this.cpuUsage=void 0,this.fpsUsage=void 0,this.timeUsage=void 0,this.lastActionId=void 0,this.countData={},this.started=!1,this.isDoneMonitor=!1,this.doneOfflineCount=0,this.donePullCount=0,this.callStartPullCount=0,this.actionIdSnapshot={},this.monitorQueues=new Set,this.timeStartChat={},this.isFirstSnapshot=!0,this.fpsRecorder={},this.timeUsage={startTrackTime:0,beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0,openConv:0,waitSendOO:0,waitSendGr:0},this.cpuUsage={beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0},this.fpsUsage={beforePull:Object(f.a)({},PM),inPull:Object(f.a)({},PM),inSaveDB:Object(f.a)({},PM),afterSaveDB:Object(f.a)({},PM)},this.lastActionId={}}startMonitor(){return LM(),this.reporter.reportLastSession(),LM()?(this.getCPU(),this.trackFPS(NM.BeforePull),Promise.resolve()):Promise.resolve()}async stopMonitor(){this.timeStartChat.group&&!this.timeUsage.waitSendGr&&(this.timeUsage.waitSendGr=vi.a.now()-this.timeStartChat.group),this.timeStartChat.oneone&&!this.timeUsage.waitSendOO&&(this.timeUsage.waitSendOO=vi.a.now()-this.timeStartChat.oneone),await this.takeSnapshot(NM.AfterSaveDB),this.reporter.report({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData}),this.isFirstSnapshot=!1}resetMonitor(){this.monitorQueues.clear(),this.started=!1,this.isDoneMonitor=!1,this.doneOfflineCount=0,this.donePullCount=0,this.timeUsage={startTrackTime:0,beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0,openConv:0,waitSendOO:0,waitSendGr:0},this.cpuUsage={beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0},this.fpsUsage={beforePull:Object(f.a)({},PM),inPull:Object(f.a)({},PM),inSaveDB:Object(f.a)({},PM),afterSaveDB:Object(f.a)({},PM)},this.lastActionId={},this.actionIdSnapshot={},this.countData={},this.timeStartChat={}}addMonitorQueues(e){const t=DM();e.forEach((e=>{t.some((t=>e.startsWith(t)))||this.monitorQueues.add(e)})),this.monitorQueues}async onStartPoll(e){this.callStartPullCount++,LM()&&(this.callStartPullCount%2==1&&this.resetMonitor(),this.addMonitorQueues(e),this.started,this.callStartPullCount,this.started||(this.started=!0,this.timeUsage.startTrackTime=vi.a.now(),await this.takeSnapshot(NM.BeforePull),this.trackFPS(NM.InPull)))}async onEndPoll(e,t){LM()&&this.monitorQueues.has(e)&&(LM(),this.lastActionId[e]=t,this.donePullCount++,this.monitorQueues.size==this.donePullCount&&(await this.takeSnapshot(NM.InPull),this.trackFPS(NM.InSaveDB)))}onPollData(e,t){if(LM()&&!this.isDoneMonitor&&this.monitorQueues.has(e))switch(this.countData[e]||(this.countData[e]=0),e){case"510_0":case"513_0":case"515_0":case"510_1":case"513_1":case"515_1":this.countData[e]+=t.data.msgs.length,this.countData[e]+=t.data.pageMsgs.length;break;case"511_0":case"514_0":case"511_1":case"514_1":this.countData[e]+=t.data.groupMsgs.length;break;case"610_0":case"611_0":case"610_1":case"611_1":this.countData[e]+=t.data.reacts.length,this.countData[e]+=t.data.reactGroups.length;break;case"603_0":case"603_1":this.countData[e]+=t.data.controls.length}}onSavedData(e){if(!this.isDoneMonitor&&LM()){this.actionIdSnapshot;for(const t in e)this.monitorQueues.has(t)&&this.lastActionId[t]&&this.actionIdSnapshot[t]!==e[t]&&(this.checkDoneDoOffline(t,e[t]),this.actionIdSnapshot[t]=e[t])}}onOpenConversation(e){"string"==typeof e&&0===this.timeUsage.openConv&&(this.timeUsage.openConv=vi.a.now()-this.timeUsage.startTrackTime)}onStartChat(e){"string"==typeof e&&(e.startsWith("g")&&!this.timeStartChat.group?this.timeStartChat.group=vi.a.now():this.timeStartChat.oneone||(this.timeStartChat.oneone=vi.a.now()))}onEncryptChat(e){"string"==typeof e&&(e.startsWith("g")&&!this.timeUsage.waitSendGr?this.timeUsage.waitSendGr=vi.a.now()-this.timeStartChat.group:this.timeUsage.waitSendOO||(this.timeUsage.waitSendOO=vi.a.now()-this.timeStartChat.oneone))}async checkDoneDoOffline(e,t){if(this.lastActionId[e],this.doneOfflineCount==this.monitorQueues.size)return;const s=this.lastActionId[e];s&&Number(t)==Number(s)&&(this.doneOfflineCount++,this.doneOfflineCount==this.monitorQueues.size&&(this.isDoneMonitor=!0,await this.takeSnapshot(NM.InSaveDB),this.trackFPS(NM.AfterSaveDB),this.reporter.saveDraft({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData}),setTimeout((()=>{this.stopMonitor()}),FM())))}async takeSnapshot(e){const t=await this.getCPU(),s=this.getFPS(e);this.cpuUsage[e]=t,this.fpsUsage[e]=s,this.timeUsage[e]=vi.a.now()-this.timeUsage.startTrackTime,this.reporter.saveDraft({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData})}async getCPU(){return 0}trackFPS(e){this.fpsRecorder[e]=Li.default.Fps.registerSectionRecorder(e),this.fpsRecorder[e].start()}getFPS(e){var t;const s=null===(t=this.fpsRecorder[e])||void 0===t?void 0:t.end();if(delete this.fpsRecorder[e],!s||0==s.fpsHistory.length)return PM;const i=AM.getDroppeds(50,s.fpsHistory);if(0==i.length)return PM;const a=i.reduce(((e,t)=>e+=t.dropTime),0),n=Math.min(...i.map((e=>e.lowestFPS)));return{dropCount:i.length,dropTime:a,min:n}}})||jM)||jM)||jM;var kM;Object(i.injectable)()(kM=Object(i.singleton)(La.a)(kM=function(e,t){return Object(i.inject)(RM)(e,void 0,0)}(kM=Reflect.metadata("design:type",Function)(kM=Reflect.metadata("design:paramtypes",[void 0===RM?Object:RM])(kM=class extends UM{constructor(e){super(e)}async getCPU(){return 0}})||kM)||kM)||kM)||kM);var BM;const GM="rp_ofl_p";Object(i.singleton)(RM)(BM=Reflect.metadata("design:type",Function)(BM=Reflect.metadata("design:paramtypes",[])(BM=class{constructor(){this.logger=void 0,this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("offline-monitor",["reporter"])}reportLastSession(){const e=S.default.getInstance().getObject(GM);e&&(this.logger.zsymb(0,"z75csB","detect last session"),this.report(e))}report(e){this.logger.zsymb(0,"iQHuZj","report: ",JSON.stringify(e)),Vt.default.logActionInfoV2(Vt.FeaturesInfo.PullOffline,1,e,[],!0);S.default.getInstance().removeItem(GM)}saveDraft(e){S.default.getInstance().setObject(GM,e),this.logger.zsymb(0,"f_HYDH","draft saved: ",JSON.stringify(e))}log(e){this.logger.zsymb(0,"4CNT_0","log: ",JSON.stringify(e))}})||BM)||BM);var xM;const zM={syncSource:null,forceSyncSource:null,isSyncing:!1};Object(Hs.b)(h_.a)(xM=Reflect.metadata("design:type",Function)(xM=Reflect.metadata("design:paramtypes",[])(xM=class{constructor(){this.state=Object(f.a)({},zM),this.name="syc-zcloud-queue-ui",this.key="syc-zcloud-queue-ui"}getSyncSource(){return this.state.syncSource}getForceSyncSource(){return this.state.forceSyncSource}setSyncSource(e){this.setState((t=>{t.syncSource=e}))}setForceSyncSource(e){this.setState((t=>{t.forceSyncSource=e}))}reset(){this.setState((e=>{e.syncSource=null,e.forceSyncSource=null,e.isSyncing=!1}))}isSyncing(){return this.state.isSyncing}setSyncing(e){this.setState((t=>{t.isSyncing=e}))}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(wo.a)(this.state,e);this.state!==t&&(this.state=t,Object(Kt.g)(this.name,"current"))}})||xM)||xM);let VM=function(e){return e[e.Integrity=0]="Integrity",e[e.Strict=1]="Strict",e[e.BestEffort=2]="BestEffort",e}({});const HM={enable_feature:!0,roll_on_exceed_quota:!0,max_alive_account:5,roll_mode:VM.Integrity,roll_buffer_count:0,count_user_in_ls:!1},$M=new jb.a({enable_feature:jb.b.field().boolean(),roll_on_exceed_quota:jb.b.field().boolean(),max_alive_account:jb.b.field().number().min(1),roll_mode:jb.b.field().number().max(VM.BestEffort).min(VM.Integrity),roll_buffer_count:jb.b.field().number().min(0),count_user_in_ls:jb.b.field().boolean()});class WM extends CS.ZFeatureConfig{constructor(){super({default:HM,valiator:$M})}selector(e){return e.auto_roll_ls||{}}shouldConfigUpdate(e,t){return!0}}class qM{constructor(e,t,s){this.uid=e,this.keyPath=t,this.lastAccess=s,this.setup=void 0,this.dispose=void 0,this.runner=void 0,this.setup=null,this.runner=null,this.dispose=null}get rawKeyPath(){return this.keyPath.slice(1)}get userIndex(){return this.keyPath.slice(0,1)}installSetup(e){this.setup=e}installRunner(e){this.runner=e}installDispose(e){this.dispose=e}async roll(){this.setup&&await this.setup(),this.runner&&await this.runner(),this.dispose&&await this.dispose()}}class KM extends qM{constructor(e,t,s){super(e,t,s),this.uid=e,this.keyPath=t,this.lastAccess=s,this.runner=async()=>{localStorage.removeItem(this.keyPath)}}}var ZM,QM=s("Kfp5");const JM="last_check_exceed_quota",YM=["_z_sc","_cdk","_react","_cl-uc","_rs","_tracking-old-cbb","_pcl-k","_preload_cache","_list_recent_g_search_v2"],XM=152101,eT=152102;Object(ke.i)()(ZM=Reflect.metadata("design:type",Function)(ZM=Reflect.metadata("design:paramtypes",[])(ZM=class{constructor(){this.logger=void 0,this.config=void 0,this._quotaExceed=void 0,this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.localstorage,[ci.ZLoggerNametags.lsRoller]),this.config=new WM,this._quotaExceed=null}onAuthenticated(){}onStart(){requestIdleCallback((()=>{this.qosCountAccountInLS(),this.roll()}))}async roll(){if(!this.config.get("enable_feature"))return void this.logger.zsymb(0,"LZVLsv","skip roll, feat disable!");if(!this.isExceededQuota()&&this.config.get("roll_on_exceed_quota"))return void this.logger.zsymb(0,"ygQ3VZ","skip roll, quota ok!");const e=this.config.get("max_alive_account"),t=this.config.get("roll_mode"),s=this.getUserAccessTimes(),i=s.slice(e);switch(this.logger.zsymb(0,"soXVOW","start roll: ",t,s.length,i.length),t){case VM.Integrity:this.doRollMatchingKey(i),this.qosRoll(t,i.length);break;case VM.Strict:this.doRollMatchingId(i),this.qosRoll(t,i.length);break;case VM.BestEffort:{const a=this.config.get("roll_buffer_count"),n=e-a;if(this.doRollMatchingId(i),a&&s.length>=n){const t=s.slice(n,e);this.doRollMatchingKey(t)}this.qosRoll(t,s.length-n);break}default:this.logger.zsymb(0,"i-kV1x","Skip roll, unknow mode!")}}buildRollItems(e){return e.reduce(((e,t)=>(YM.forEach((s=>{const i=`${t.index}${s}`;e.push(new KM(t.uid,i,t.accessTime))})),e)),[])}setupExecutor(e){e.forEach((e=>{"_react"==e.rawKeyPath&&e.installSetup((async()=>{Object(QM.c)(e.uid)}))}))}doRollMatchingKey(e){const t=this.buildRollItems(e);this.setupExecutor(t),this.logger.zsymb(0,"v_-YzE","roll matching key: ",t.length),t.length&&Promise.all(t.map((e=>e.roll().catch((t=>{this.logger.zsymb(0,"6bLofD","roll item got error: ",e.keyPath,t)})))))}doRollMatchingId(e){if(this.logger.zsymb(0,"ZdBqad","roll matching id: ",e.length),e.length){Rn.a.getInstance().cleanupLocalStorageMatchConditions((t=>e.some((e=>t.startsWith(e.index)))))}}isExceededQuota(){if(null!==this._quotaExceed)return this._quotaExceed;this._quotaExceed=!1;try{S.default.getInstance().setItemForCurrentUser(JM,Date.now().toString())}catch(e){this._quotaExceed=22==(null==e?void 0:e.code)}if(!this._quotaExceed){const e=new Blob(Object.values(localStorage)).size;this._quotaExceed=e>=5e6}return this._quotaExceed}getUserAccessTimes(){const e=Object(Ie.e)(),t=[];return e&&e.length&&e.forEach(((e,s)=>{t.push(this.getAccesstimeFor(e,s))})),t.sort(((e,t)=>t.accessTime-e.accessTime)),t}getAccesstimeFor(e,t){const s=localStorage.getItem(`${t}_${R.LAST_TIME_FETCH_ME_PREFIX}`)||0,i=localStorage.getItem(`${t}_${JM}`)||0;return{uid:e,index:t.toString(),accessTime:Math.max(+s,+i)}}qosRoll(e,t){t>0?fs.default.increaseSuccess(XM,e,0,[t]):fs.default.increaseFailed(XM,e,0,-t,Date.now())}qosCountAccountInLS(){if(!this.config.get("count_user_in_ls"))return;const e=this.isExceededQuota(),t=Object(Ie.e)().length;this.logger.zsymb(0,"HIxjXu","total users in ls: ",e,t),e?fs.default.increaseFailed(eT,0,0,t,Date.now()):fs.default.increaseSuccess(eT,0,0,[t])}})||ZM)||ZM);const tT=Object(i.define)("settings-controller"),sT="z_chatbg_reset";var iT;Object(i.singleton)(tT)(iT=Object(ke.i)()(iT=class{onStart(){this.switchDefaultOffBgChat()}switchDefaultOffBgChat(){const e=S.default.getInstance();if(!e.getItemForCurrentUser(sT)){this.isUseChatBackground()&&(ei.g.setUseChatBg($e.p.getSessionUserId(),!1),Cs.default.send(Os.GeneralActions.CHANGE_BG_CHAT,!1)),e.setItemForCurrentUser(sT,"1")}}isUseChatBackground(){const e=$e.p.getSessionUserId();return Boolean(ei.g.useChatBg(e))}})||iT);var aT=s("uPsl");class nT{constructor(){this.onDeleteMessage=this.onDeleteMessage.bind(this),this.registerEvents()}dispose(){}static create(){return new nT}static getInstance(){return nT.instance||(nT.instance=nT.create()),nT.instance}registerEvents(){rs.a.instance.on("delete-message-only-me",this.onDeleteMessage)}cancelUpload(e){aT.a.emit("cancel-upload",e)}onDeleteMessage(e){if(e.type===Os.ChatBoxActions.DELETE_MESSAGE){const{payload:t}=e;if(Array.isArray(t.messages)){const e=new Set;t.messages.forEach((t=>{t&&t.cliMsgId&&("file"===t.mediaType||"image"===t.mediaType)&&e.add(t.cliMsgId)})),e.size>0&&Array.from(e).forEach((e=>{this.cancelUpload(e)}))}}}}nT.instance=void 0,nT.create();var rT,oT=s("W92G"),dT=s("cjS3");Object(i.singleton)(oT.a)(rT=Object(ke.e)()(rT=Object(ke.h)()(rT=Reflect.metadata("design:type",Function)(rT=Reflect.metadata("design:paramtypes",[])(rT=class extends je.b{constructor(){super(),this.logger=void 0,this.bannerState=void 0,this.stateListeners=void 0,this.autoCloseTimer=void 0,this.handleE2eeSessionChange=()=>{this.isEnabled()?(this.bannerState=dT.d.DISPLAY,this.updateBannerStateToDB(),this.signalStateChange(),this.logger.zsymb(0,"VY77Ty",`e2eeSessionChange: detect change session. new banner state ${this.bannerState}`),this.startCheckAutoClose(),requestIdleCallback((()=>{this.getBannerCounter().then((e=>{let t=((null==e?void 0:e.count)||0)+1,s=null==e?void 0:e.firstTs;if(s){(Date.now()-s)/864e5>30&&(this.logger.zsymb(0,"EjNbLs",`e2eeSessionChange: more than 30 days from the date of 1st display, reset. prev counter: ${t}-${s}`),t=1,s=void 0)}s||(s=Date.now());let i=0;1===t?i=25310103:2===t?i=25310104:3===t?i=25310105:t>=4&&t<=5?i=25310106:t>=6&&t<=10?i=25310107:t>=10&&t<=20?i=25310108:t>20&&(i=25310109),i&&Vt.default.logAction(i),this.saveBannerCounter(t,s),this.logger.zsymb(0,"caSoYL",`e2eeSessionChange: update banner counter ${t}; firstDisplay ${s}`)}))}),{timeout:5e3})):this.logger.zsymb(0,"QtvubK","e2eeSessionChange: detect change session, but skipped banner status update due to being disabled")},this.logger=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger(ci.ZLoggerNametags.web,["change-device-notice"]),this.bannerState=dT.d.NONE,this.stateListeners=new Map}onAuthenticated(){(async()=>{if(!this.isEnabled())return void this.logger.zsymb(0,"BVZNo-","authenticated: web change device banner is disabled");const e=await this.getBannerStateFromDB();!e||isNaN(Number(e))||this.bannerState||(this.bannerState=Number(e),this.logger.zsymb(0,"1jPwp4",`authenticated: load prev banner state ${e}`),this.signalStateChange(),this.startCheckAutoClose())})(),this.addEventListener("on-e2ee-session-change",this.handleE2eeSessionChange)}onSessionExpired(){this.bannerState&&(this.logger.zsymb(0,"G8TbkS",`logout: reset banner state. current state ${this.bannerState}`),this.setBannerState(dT.d.NONE)),this.removeEventListener("on-e2ee-session-change",this.handleE2eeSessionChange)}isEnabled(){var e,t,s;return null===(e=null===(t=ms.default.tab_banner.features)||void 0===t||null===(s=t.web_change_device)||void 0===s?void 0:s.enable)||void 0===e||e}getBannerState(){return this.bannerState}setBannerState(e){e!==this.bannerState&&e!==dT.d.DISPLAY&&(this.bannerState=e,this.updateBannerStateToDB(e===dT.d.NONE),this.signalStateChange())}onStateChange(e,t){this.stateListeners.set(e,t)}revoke(e){this.stateListeners.delete(e)}startCheckAutoClose(){var e,t;if(this.bannerState!==dT.d.DISPLAY)return;const s=null===(e=ms.default.tab_banner.features)||void 0===e||null===(t=e.web_change_device)||void 0===t?void 0:t.auto_close;s&&Number.isInteger(s)&&(this.logger.zsymb(0,"AeKSrk",`e2eeSessionChange: start auto close timer. ${s}`),this.autoCloseTimer&&clearTimeout(this.autoCloseTimer),this.autoCloseTimer=setTimeout((()=>{this.setBannerState(dT.d.DISMISSED),this.autoCloseTimer=void 0}),s))}signalStateChange(){this.stateListeners.forEach((e=>{e(this.bannerState)}))}async updateBannerStateToDB(e){e?await S.default.getInstance().removeItemForCurrentUserAsync(dT.c):await S.default.getInstance().setItemForCurrentUserAsync(dT.c,this.bannerState.toString()),this.logger.zsymb(0,"feC0NF","flushBannerStateToDb: "+(e?"delete state.":`saved new state: ${this.bannerState};`))}async getBannerStateFromDB(){return S.default.getInstance().getItemForCurrentUserAsync(dT.c)}async saveBannerCounter(e,t){e||t?await S.default.getInstance().setItemForCurrentUserAsync(dT.a,JSON.stringify({count:e,firstTs:t})):await S.default.getInstance().removeItemForCurrentUserAsync(dT.a)}async getBannerCounter(){const e=await S.default.getInstance().getItemForCurrentUserAsync(dT.a);if(e)try{const t=JSON.parse(e);return{count:Number.isInteger(Number(t.count))?Number(t.count):0,firstTs:Number.isInteger(Number(t.firstTs))?Number(t.firstTs):0}}catch(t){return void(await this.saveBannerCounter())}}})||rT)||rT)||rT)||rT);var lT=s("+pEX"),cT=s("AWVP"),hT=s("Iq7B");class uT{constructor(e,t,s,i,a){this.name=void 0,this.code=void 0,this.data=void 0,this.message=void 0,this.details=void 0,this.name=e,this.code=t,this.message=s,this.details=i,this.data=a,Object(lT.a)().error(`${this.name}[${this.code}]:${this.message}`,this.details)}}class gT extends uT{constructor(e,t,s){super("HttpApiError",cT.e.HTTP_API,e,s),this.data=void 0,this.data=t}}class mT{async sendSeenSubChatTab(e){try{const t=cs.b.getChatDomain(),s=hT.b,i=`${t}${s}${`?${this.getCommonParams_()}`}`,a=Qa.a.newReq(),n={msgInfos:JSON.stringify({seens:e}),imei:oa.a.getZaloClientID()},r=`params=$${this.encodeParams_(n)}`,o=await Nn.default._post(i,r,{retry:0},hT.a,void 0,!1,a),d=await Object(jn.a)(o),{status:l}=null!=d?d:{};return cT.b.Success(0==l)}catch(a){var t,s,i;const e={status:null==a?void 0:a.status,errorCode:null!==(t=null==a?void 0:a.error_code)&&void 0!==t?t:null==a?void 0:a.code,message:null!==(s=null!==(i=null==a?void 0:a.error_message)&&void 0!==i?i:null==a?void 0:a.message)&&void 0!==s?s:""};return cT.b.Failure(new gT("Cannot send seen sub chat tab.",e,e))}}getCommonParams_(){return Nn.default._getCommonParams()}encodeParams_(e){return Nn.default._encodeParams(e)}}class pT extends uT{constructor(e,t,s){super("WSSApiError",cT.e.WSS_API,e,s),this.data=void 0,this.data=t}}class fT{async getLastSeenSubChatTab(e){const t={subtabs:e};try{const e=await Bu.a.instance().requestAsyncV2({cmd:$p.j.GET_LAST_SEEN_SUB_CHAT_TAB,subCmd:0,data:{data:t}});if(0!=e.error_code){const s={errorCode:e.error_code,message:e.error_message},i=Object(f.a)(Object(f.a)({},s),{},{params:JSON.stringify(t)}),a="Cannot get last seen sub chat tab.";return cT.b.Failure(new pT(a,s,i))}return cT.b.Success({clearUnreadInfo:e.data.clearUnreadInfo})}catch(n){var s,i,a;const e={errorCode:null!==(s=null==n?void 0:n.error_code)&&void 0!==s?s:null==n?void 0:n.code,message:null!==(i=null!==(a=null==n?void 0:n.error_message)&&void 0!==a?a:null==n?void 0:n.message)&&void 0!==i?i:""},r=Object(f.a)(Object(f.a)({},e),{},{params:JSON.stringify(t)}),o="Cannot get last seen sub chat tab.";return cT.b.Failure(new pT(o,e,r))}}}var vT,bT=s("1HgD"),yT=s("Ui4J");Object(i.injectable)()(vT=Object(i.singleton)(bT.a)(vT=Reflect.metadata("design:type",Function)(vT=Reflect.metadata("design:paramtypes",[])(vT=class{constructor(){this.httpApi_=void 0,this.wssApi_=void 0,this.currentSyncSeenSubtabReq_=null,this.httpApi_=new mT,this.wssApi_=new fT,Uu.default.getChatHandler().subcribe($p.b.ON_DONE_OFFLINE,this.pullOfflineLastSeenSubChatTabIfNeeded_.bind(this))}sendSeenSubChatTab_(e,t){let s=!1;const i=null==t?void 0:t.signal;return i&&i.addEventListener("abort",(()=>s=!0)),new Promise(((t,i)=>{const a=yT.a(),n=te((async()=>{const t=await this.httpApi_.sendSeenSubChatTab(e);return"error"===t.type?Promise.reject(t.data):Promise.resolve(t.data)}),{min:a.min,max:a.max,step:a.step,retries:a.retries,shouldRetryOnError:({error:e})=>new Promise((t=>{var i;if(s)return t(!1);if(!e)return t(!1);const a=null===(i=e.data)||void 0===i?void 0:i.errorCode;if(-69===a)return t(!1);return[R.NetWorkError.NO_NETWORK,R.NetWorkError.TIMEOUT,R.NetWorkError.TIMEOUT_SENT].includes(a)?t(!0):t(111!==a)}))});n().then((e=>{t(cT.b.Success(e))})).catch((e=>{t(cT.b.Failure(e))}))}))}syncSeenSubChatTab(e){const t={abortController:new AbortController,payload:{seens:e}};if(this.currentSyncSeenSubtabReq_){const s=this.currentSyncSeenSubtabReq_,i=[...s.payload.seens,...e].reduce(((e,t)=>{const s=t.sct+"_"+t.id;if(e[s]=t,e[s]){const i=e[s],a=t.msgId>i.msgId?t.msgId:i.msgId;e[s]=Object(f.a)(Object(f.a)({},t),{},{msgId:a})}else e[s]=t;return e}),Object.create(null));t.payload.seens=Object.values(i),s.abortController.abort()}this.currentSyncSeenSubtabReq_=t,this.sendSeenSubChatTab_(t.payload.seens,{signal:t.abortController.signal}).finally((()=>{this.currentSyncSeenSubtabReq_===t&&(this.currentSyncSeenSubtabReq_=null)}))}onReceiveSeenSubChatTab_(e,t=cT.a.Unknown){Object(lT.a)().info(`[${t}] Receive seen sub chat tab.`,{seens:e});const s=i.ModuleContainer.resolve(hi.TUnreadSubChatTabStateManager),a=e.map((e=>({type:+e.idTo,msgId:e.lastMsgId})));s.onReceiveSeenSubChatTab(a)}async pullOfflineLastSeenSubChatTabIfNeeded_(){if(Object(lT.a)().info("[PullOffline] Start sync when done offline."),ms.default.socket.enable_ctrl_socket){const e=[],t=i.ModuleContainer.resolve(hi.TUnreadSubChatTabStateManager);if(t.getAllValidSubtabs().forEach((s=>{t.hasUnreadSubChatTab(s)&&e.push({sct:cT.c.SubChatTab,id:s})})),!e.length)return;const s=await this.wssApi_.getLastSeenSubChatTab(e);"success"===s.type?this.onReceiveSeenSubChatTab_(s.data.clearUnreadInfo,cT.a.Wss_PullOffline):Object(lT.a)().error("[PullOffline] Cannot get last seen sub chat tab.")}else Object(lT.a)().info("[PullOffline] Socket is not enabled. -> Skip.")}onReceiveSeenSubChatTabFromCtrl(e){this.onReceiveSeenSubChatTab_(e,cT.a.Wss_Response)}})||vT)||vT)||vT);var IT=s("TtB7"),_T=s("BjT2");const CT="s_s_m_prxk",OT="l_r_m_i";class ST{constructor(){this.seenMilestoneAtSubtab_={[cT.d.ARCHIVED]:void 0,[cT.d.FOCUSED]:void 0},this.lastReceivedMsgInfoAtSubtab_={[cT.d.ARCHIVED]:void 0,[cT.d.FOCUSED]:void 0}}setNewSeenMilestone(e,t){this.seenMilestoneAtSubtab_[e]=t;const s=S.default.getInstance(),i=`${CT}::${e}`;s.setItemForCurrentUser(i,t)}getLastSeenMilestone(e){var t;let s=this.seenMilestoneAtSubtab_[e];if(null!=s)return s;const i=S.default.getInstance(),a=`${CT}::${e}`;return s=null!==(t=i.getItemForCurrentUser(a))&&void 0!==t?t:"",this.seenMilestoneAtSubtab_[e]=s,s}setNewReceivedMsgInfo(e,t){this.lastReceivedMsgInfoAtSubtab_[e]=Object(f.a)({},t);const s=S.default.getInstance(),i=`${OT}::${e}`;s.setItemForCurrentUser(i,JSON.stringify(t))}getLastReceivedMsgInfo(e){var t,s;if(null!=this.lastReceivedMsgInfoAtSubtab_[e])return this.lastReceivedMsgInfoAtSubtab_[e];const i=S.default.getInstance(),a=`${OT}::${e}`,n=null!==(t=i.getItemForCurrentUser(a))&&void 0!==t?t:"";return n?(this.lastReceivedMsgInfoAtSubtab_[e]=null!==(s=JSON.parse(n))&&void 0!==s?s:{convId:"",msgId:""},this.lastReceivedMsgInfoAtSubtab_[e]):(this.lastReceivedMsgInfoAtSubtab_[e]={convId:"",msgId:""},this.lastReceivedMsgInfoAtSubtab_[e])}}var ET,MT=s("7l8h");Object(Hs.b)(_T.b)(ET=function(e,t){return Object(i.inject)(MT.c)(e,void 0,0)}(ET=function(e,t){return Object(i.inject)(ke.a)(e,void 0,1)}(ET=Reflect.metadata("design:type",Function)(ET=Reflect.metadata("design:paramtypes",["undefined"==typeof IUnreadSubChatTabNetworkService?Object:IUnreadSubChatTabNetworkService,"undefined"==typeof BaseApplication?Object:BaseApplication])(ET=class{constructor(e,t){this.unreadSubChatTabStateStore_=void 0,this.storage_=void 0,this.networkService_=void 0,this.key=IT.a,this.name=_T.a,this.storage_=new ST,this.networkService_=e,this.handleReceiveLatestMessage=this.handleReceiveLatestMessage.bind(this),this.handleReceiveLatestMessage_=this.handleReceiveLatestMessage_.bind(this),this.handleChangeSubtab=this.handleChangeSubtab.bind(this),this.hasUnreadSubChatTab=this.hasUnreadSubChatTab.bind(this),this.handleDisplayMessageTab=this.handleDisplayMessageTab.bind(this),this.handleHideMessageTab=this.handleHideMessageTab.bind(this),this.handleUpdateArchivedChat=this.handleUpdateArchivedChat.bind(this),this.handleMoveConvFromHiddenToArchivedChat=this.handleMoveConvFromHiddenToArchivedChat.bind(this),this.handleShowReddotsAtSubChatTab=this.handleShowReddotsAtSubChatTab.bind(this),t.addEventListener(ke.b.Idle,this.handleMainApplicationInBackground_.bind(this)),t.addEventListener(ke.b.Active,this.handleMainApplicationInForeground_.bind(this))}handleReceiveLatestMessage(e){e&&e.convId&&this.isRightMsgIdString_(e.msgId)?this.handleReceiveLatestMessage_(e):Object(lT.a)().error("[Event] Receive latest message - Invalid info.",{info:e},1)}handleReceiveLatestMessage_(e){const{convId:t,msgId:s}=e,i=this.getSubtabTypeOfConv(t);if(!this.isValidSubChatTabType(i))return;const a=this.getLastReceivedMsgInfo_(i);(!a.msgId||a.msgId<s)&&this.saveNewReceivedMsgInfo_(i,{convId:t,msgId:s})}getSubtabTypeOfConv(e){let t=cT.d.NONE;return li.a.isArchivedChat(e)?t=cT.d.ARCHIVED:Zs.a.isThreadHidden(e)||(t=cT.d.FOCUSED),t}handleShowReddotsAtSubChatTab(e){const t=this.convetFilterTypeToSubChatTabType(Ds.a.ConvListController.getCurrentFilter().type);this.getAllValidSubtabs().forEach((s=>{if(t===s)return;const i=this.hasUnreadSubChatTab(s),a=e[s];if(i!==a){let e=this.getUnreadSubChatTabStateStore_()[s];e=Object(f.a)(Object(f.a)({},e),{},{hasUnread:a}),this.getUnreadSubChatTabStateStore_()[s]=e,Object(Kt.g)(this.name,this.key)}}))}handleMoveConvFromHiddenToArchivedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,cT.d.ARCHIVED)}handleUpdateArchivedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,cT.d.ARCHIVED)}handleMoveConvToArchiveChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,cT.d.ARCHIVED)}handleMoveConvToFocusedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,cT.d.FOCUSED)}handleChangeSubtab(e,t){const s={fromSubtab:e,toSubtab:t};Object(lT.a)().info("[Event] Change subtab.",s);const i=[];if(this.isValidSubChatTabType(t)){const e=this.getLastReceivedMsgInfo_(t);if(e.msgId){let s=this.getUnreadSubChatTabStateStore_()[t];s=Object(f.a)(Object(f.a)({},s),{},{hasUnread:!1}),this.getUnreadSubChatTabStateStore_()[t]=s,this.saveNewSeenMilestone_(t,e.msgId),Object(Kt.g)(this.name,this.key),i.push({sct:cT.c.SubChatTab,msgId:e.msgId,id:t})}}if(this.isValidSubChatTabType(e)){const t=this.getLastReceivedMsgInfo_(e),s=this.getLastSeenMilestone_(e);t.msgId&&t.msgId>s&&(this.saveNewSeenMilestone_(e,t.msgId),i.push({sct:cT.c.SubChatTab,msgId:t.msgId,id:e}))}i.length&&this.networkService_.syncSeenSubChatTab(i)}handleDisplayMessageTab(e){const t=this.convetFilterTypeToSubChatTabType(Ds.a.ConvListController.getCurrentFilter().type);if(Object(lT.a)().info("[Event] Display message tab.",{info:e,enteringSubtab:t}),!this.isValidSubChatTabType(t))return;const s=[],i=this.getLastReceivedMsgInfo_(t),a=this.getLastSeenMilestone_(t);if(i.msgId&&i.msgId>a){const e=i.msgId;this.saveNewSeenMilestone_(t,e),s.push({sct:cT.c.SubChatTab,id:t,msgId:e})}s.length&&this.networkService_.syncSeenSubChatTab(s)}handleHideMessageTab(e){const t=this.convetFilterTypeToSubChatTabType(Ds.a.ConvListController.getCurrentFilter().type);if(Object(lT.a)().info("[Event] Hide message tab.",{info:e,leavingSubtab:t}),!this.isValidSubChatTabType(t))return;const s=[],i=this.getLastReceivedMsgInfo_(t),a=this.getLastSeenMilestone_(t);if(i.msgId&&i.msgId>a){const e=i.msgId;this.saveNewSeenMilestone_(t,e),s.push({sct:cT.c.SubChatTab,id:t,msgId:e})}s.length&&this.networkService_.syncSeenSubChatTab(s)}updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,t){const s=Ds.a.UnreadDataManager.getUnreadByConvIdSync(e);if(!s)return;const i=s.lastProcessMsgId;if(!i)return;const a=this.getLastSeenMilestone_(t);a&&a>=i||this.saveNewSeenMilestone_(t,i)}handleMainApplicationInForeground_(){const e=this.convetFilterTypeToSubChatTabType(Ds.a.ConvListController.getCurrentFilter().type);if(Object(lT.a)().info(`[Event] Main application in foreground - enteringSubtab: ${e}`),!this.isValidSubChatTabType(e))return;const t=[],s=this.getLastReceivedMsgInfo_(e),i=this.getLastSeenMilestone_(e);if(s.msgId&&s.msgId>i){const i=s.msgId;this.saveNewSeenMilestone_(e,i),t.push({sct:cT.c.SubChatTab,id:e,msgId:i})}t.length&&this.networkService_.syncSeenSubChatTab(t)}handleMainApplicationInBackground_(){const e=this.convetFilterTypeToSubChatTabType(Ds.a.ConvListController.getCurrentFilter().type);if(Object(lT.a)().info(`[Event] Main application in background - leavingSubtab: ${e}`),!this.isValidSubChatTabType(e))return;const t=[],s=this.getLastReceivedMsgInfo_(e),i=this.getLastSeenMilestone_(e);if(s.msgId&&s.msgId>i){const i=s.msgId;this.saveNewSeenMilestone_(e,i),t.push({sct:cT.c.SubChatTab,id:e,msgId:i})}t.length&&this.networkService_.syncSeenSubChatTab(t)}onReceiveSeenSubChatTab(e){e.forEach((({type:e,msgId:t})=>{if(this.isValidSubChatTabType(e)){const s=t,i=this.getLastSeenMilestone_(e);if(s&&s>i){let t=this.getUnreadSubChatTabStateStore_()[e];t=Object(f.a)(Object(f.a)({},t),{},{hasUnread:!1}),this.getUnreadSubChatTabStateStore_()[e]=t,this.saveNewSeenMilestone_(e,s),Object(Kt.g)(this.name,this.key)}}}))}hasUnreadSubChatTab(e){var t;return!!this.isValidSubChatTabType(e)&&(null!==(t=this.getUnreadSubChatTabStateStore_()[e].hasUnread)&&void 0!==t&&t)}isValidSubChatTabType(e){return this.getAllValidSubtabs().includes(e)}convetFilterTypeToSubChatTabType(e){return e===Ci.d.FOCUSED?cT.d.FOCUSED:e===Ci.d.ARCHIVED?cT.d.ARCHIVED:cT.d.NONE}getAllSeenMilestones(){return this.getAllValidSubtabs().reduce(((e,t)=>(e[t]=this.getLastSeenMilestone_(t),e)),{})}getAllValidSubtabs(){return[cT.d.FOCUSED,cT.d.ARCHIVED]}getUnreadSubChatTabStateStore_(){return this.unreadSubChatTabStateStore_||(this.unreadSubChatTabStateStore_=this.getAllValidSubtabs().reduce(((e,t)=>(e[t]={type:t,hasUnread:!1},e)),{})),this.unreadSubChatTabStateStore_}isRightMsgIdString_(e){return!!e&&("string"==typeof e&&!e.includes("object"))}saveNewSeenMilestone_(e,t){this.isValidSubChatTabType(e)?this.isRightMsgIdString_(t)?this.storage_.setNewSeenMilestone(e,t):Object(lT.a)().error("[SaveNMS] Invalid newMilestone.",{newMilestone:t},1):Object(lT.a)().error("[SaveNMS] Invalid subchat tab type.",{type:e},1)}getLastSeenMilestone_(e){if(!this.isValidSubChatTabType(e))return"";let t=this.storage_.getLastSeenMilestone(e);return t&&!this.isRightMsgIdString_(t)&&(Object(lT.a)().error("[GetLSM] Get invalid milestone.",{milestone:t},1),t="",this.storage_.setNewSeenMilestone(e,t)),t}saveNewReceivedMsgInfo_(e,t){this.isValidSubChatTabType(e)?t&&t.convId&&this.isRightMsgIdString_(t.msgId)?this.storage_.setNewReceivedMsgInfo(e,t):Object(lT.a)().error("[SaveNRMI] Invalid msgId.",{info:t},1):Object(lT.a)().error("[SaveNRMI] Invalid subchat tab type.",{type:e},1)}getLastReceivedMsgInfo_(e){if(!this.isValidSubChatTabType(e))return{convId:"",msgId:""};let t=this.storage_.getLastReceivedMsgInfo(e);return t.msgId&&!this.isRightMsgIdString_(t.msgId)&&(Object(lT.a)().error("[GetLRMI] Get invalid msgId.",{lastReceivedMsgInfo:t},1),t={convId:"",msgId:""},this.storage_.setNewReceivedMsgInfo(e,t)),t}init(){}getItem(e){if(e.key===this.key)return this.unreadSubChatTabStateStore_}getList(e,t){return[]}onGetItemFailure(e,t){0}onGetListFailure(e,t){0}})||ET)||ET)||ET)||ET);s("UCdJ");i.ModuleContainer.resolve(ue.a).addEventListener(Pe.a.SessionChange,(async({session:e})=>{const t=S.default.getInstance();null!==e?t.init(e.userId,e.UIN):t.resetSession()}));var TT=s("+eUS");const wT="render"!==__ZaBUNDLENAME__&&"WEB"!==__ZaBUNDLENAME__&&"shared-worker"!==__ZaBUNDLENAME__&&"main"!==__ZaBUNDLENAME__;setTimeout((async function(){if(wT)return;const e=i.ModuleContainer.resolve(Me.ZLoggerFactory).createZLogger("bootstrap",["shared"]);e.zsymb(3,"8enpK7",["running application bootstrap","bJAFPV"]);let t=(()=>{switch(__ZaBUNDLENAME__){case"WEB":return Fe.RunMode.Browser;case"render":return Fe.RunMode.Host;case"shared-worker":return Fe.RunMode.Client;case"main":return Fe.RunMode.Background;default:return Fe.RunMode.Unknown}})();try{const s=i.ModuleContainer.resolve(ke.a);await s.start(),Object(TT.a)(t),t===Fe.RunMode.Browser&&Object(ut.b)(),"shared-worker"===__ZaBUNDLENAME__&&await s.init(),e.zsymb(3,"a4vQma",["application bootstrap success","V42xbo"])}catch(s){e.zsymb(0,"uxWckZ",(()=>["application bootstrap fail",{reason:s}]))}}),0);var RT;s("Lp8g");let LT=Object(i.injectable)()(RT=Object(i.singleton)()(RT=class{constructor(){this.type=void 0,this.name=Zt.a,this.key=""}handleResumeMigrate(e){throw new Error("Method not implemented.")}getMigrateDiskInfoByProgress(e){throw new Error("Method not implemented.")}async handleStartMigrate(){throw new Error("Method not implemented.")}async handleRejectMigrate(){throw new Error("Method not implemented.")}async handleRetryMigrate(){throw new Error("Method not implemented.")}waitMigrateRelease(){return Promise.resolve()}waitForDBMigrate(e,t){return Promise.resolve()}cleanupData(){}promoteMigrateByOpenConv(e){}skipMigrate(){throw new Error("Method not implemented.")}scheduleReminder(){throw new Error("Method not implemented.")}init(){}getItem(){return{percent:0,status:Zt.d.DISABLED,requiredSpace:0,error:"",migratedCount:0,toMigrateCount:0,timeElapsed:0,numOfReader:1,batchSize:5e3,count:1,pausedLastSession:!1,allowReject:!1,forceReject:!1,isLowDiskSpace:!1}}getList(){return[]}onGetItemFailure(e,t){}onGetListFailure(e,t){}})||RT)||RT;i.ModuleContainer.registerSingleton(Zt.b,LT),i.ModuleContainer.registerSingleton(Hs.a,LT);var FT=s("GFHO"),DT=s("ziJS"),AT=s("YZUF");s("zlHd");function jT(){DT.b.init(),Ta.b.init(),AT.b.init()}(function(e){const t=new FT.a(e);if(t.remoteConfigs.key("enable").boolean)jT();else{const e=()=>{t.remoteConfigs.key("enable").boolean&&(jT(),t.remoteConfigs.remove(e))};t.remoteConfigs.add(e)}})({platform:"web"})},rhBN:function(e,t,s){"use strict";var i,a=s("jDHv"),n=s("UK4g"),r=s("YEoC"),o=s("DI/x"),d=s("tHMN"),l=s("LzQZ");let c=a.ModuleContainer.injectable()(i=function(e,t){return a.ModuleContainer.inject(d.b)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===d.b?Object:d.b])(i=class{constructor(e){this.engine=e,this.currentId=1,this.transactions=void 0,this.transactions=new Map}get(e){const t=this.transactions.get(e);if(!t)throw new o.h("The transaction has already committed!");return t}async beginTransaction(e,t,s){const i=this.currentId++,a=new Error,o=await this.engine.do({type:r.e.BeginTransaction,database:e,table:t[0],transaction:i,priority:r.d.BLOCKING,retry:n.g,timing:{},meta:{step:-1,timeout:n.j,error:a},params:{tables:t,mode:s},trace:()=>{}});return this.transactions.set(i,o),o}async commitTransaction(e){const t=this.transactions.get(e);return!t||t.closed?(t&&this.transactions.delete(e),Promise.resolve()):(await t.commit(),new Promise(((s,i)=>{t.onClose((()=>{this.transactions.delete(e),t.error?i(t.error):s()}))})))}})||i)||i)||i)||i;a.ModuleContainer.registerSingleton(l.a,c)},rvru:function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var i,a=s("jDHv"),n=s("fc/q"),r=s("DI/x"),o=s("YEoC"),d=s("MRjZ"),l=s("BwoQ");let c=Object(a.injectable)()(i=function(e,t){return Object(a.inject)(n.b)(e,void 0,0)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===n.IQosService?Object:n.IQosService])(i=class{constructor(e){this.qos=e,this.stopDBErrorQos=!1,this.dbErrorQosCount=0,this.stopMissingTablesQos={}}sendFailedMultiErrorQos(e){const{query:t,error:s}=e.data,i=t.meta.databaseConfig?t.meta.databaseConfig.type:-1,a=(()=>{if("string"==typeof s)return s;if(s instanceof Error)return s.toString();try{return JSON.stringify(s)}catch(e){return"Empty"}})(),n=[`(${Object(d.a)(t)}): ${a}`];this.qos.log({success:!1,commandId:l.g,subCommandId:i,duration:0,errorCode:t.type,params:n})}sendTimeConsumingQueryQos(e,t){let s=0;s=t<3e4?1:t<6e4?2:3,this.qos.log({success:!1,commandId:l.l,subCommandId:0,duration:t,errorCode:s,startTime:Date.now(),params:[JSON.stringify(e)]})}sendDBErrorQos(e){if(!this.stopDBErrorQos){if(e instanceof r.e)e instanceof r.b?this.sendDOMExceptionErrorQos(e):e instanceof r.C?this.sendSQLiteExceptionErrorQos(e):this.sendDALErrorQos(e);else{let t="";"string"==typeof e?t=e:e instanceof Error&&(t=e.message||e.name);const s=new r.i(t);this.sendDALErrorQos(s)}return this.dbErrorQosCount+=1,this.dbErrorQosCount>10?(this.stopDBErrorQos=!0,this.dbErrorQosCount=0,void setTimeout((()=>{this.stopDBErrorQos=!1}),9e5)):void 0}}sendSuccessOpenDBDurationQos(e,t,s){let i=1;s>2e4?i=6:s>15e3?i=5:s>1e4?i=4:s>5e3?i=3:s>1e3&&(i=2),this.qos.log({success:!1,commandId:l.k,subCommandId:0,duration:s,errorCode:i,startTime:t,params:[e]})}sendLongOpenRequestQos(e,t,s){this.qos.log({success:!1,commandId:l.h,subCommandId:0,errorCode:0,duration:s,startTime:t,params:[e]})}sendMissingTableQos(e,t){this.stopMissingTablesQos[e]||(this.qos.log({success:!1,commandId:l.i,subCommandId:0,errorCode:0,duration:0,startTime:Date.now(),params:[e,...t]}),this.stopMissingTablesQos[e]=!0)}sendDALErrorQos(e){this.qos.log({success:!1,commandId:l.e,subCommandId:0,duration:0,errorCode:e.code,startTime:Date.now(),params:e.qosParams})}sendSQLiteExceptionErrorQos(e){this.qos.log({success:!1,commandId:l.j,subCommandId:0,duration:0,errorCode:e.code,startTime:Date.now(),params:e.qosParams})}sendDOMExceptionErrorQos(e){let t=-1;switch(e.name){case"IndexSizeError":t=1;break;case"HierarchyRequestError":t=3;break;case"WrongDocumentError":t=4;break;case"InvalidCharacterError":t=5;break;case"NoModificationAllowedError":t=7;break;case"NotFoundError":t=8;break;case"NotSupportedError":t=9;break;case"InUseAttributeError":t=10;break;case"InvalidStateError":t=11;break;case"SyntaxError":t=12;break;case"InvalidModificationError":t=13;break;case"NamespaceError":t=14;break;case"InvalidAccessError":t=15;break;case"SecurityError":t=18;break;case"NetworkError":t=19;break;case"AbortError":t=20;break;case"URLMismatchError":t=21;break;case"QuotaExceededError":t=22;break;case"TimeoutError":t=23;break;case"InvalidNodeTypeError":t=24;break;case"DataCloneError":t=25;break;case"EncodingError":t=26;break;case"NotReadableError":t=27;break;case"UnknownError":t=-1;break;case"ConstraintError":t=28;break;case"DataError":t=29;break;case"TransactionInactiveError":t=30;break;case"ReadOnlyError":t=31;break;case"VersionError":t=32;break;case"OperationError":t=33;break;case"DBCorruptError":if(e.adapterType===o.a.SQLite){t=50;break}default:void 0!==e.code&&(t=e.code)}const s=e.message||"";this.qos.log({success:!1,commandId:l.f,subCommandId:0,errorCode:t,duration:0,startTime:Date.now(),params:[s]})}})||i)||i)||i)||i;const h=Object(a.define)("database-qos");a.ModuleContainer.registerSingleton(h,c)},taJj:function(e,t,s){"use strict";t.a=class{constructor(e){this.chunkSize=void 0,this.partialChunk=void 0,this.offset=void 0,this.chunkSize=e,this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}send(e,t){t.enqueue(e),this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}transform(e,t){let s=0;if(this.offset>0){const i=Math.min(e.byteLength,this.chunkSize-this.offset);this.partialChunk.set(e.slice(0,i),this.offset),this.offset+=i,s+=i,this.offset===this.chunkSize&&this.send(this.partialChunk,t)}for(;s<e.byteLength;){const i=e.byteLength-s;if(i>=this.chunkSize){const i=e.slice(s,s+this.chunkSize);s+=this.chunkSize,this.send(i,t)}else{const t=e.slice(s,s+i);s+=t.byteLength,this.partialChunk.set(t),this.offset=t.byteLength}}}flush(e){this.offset>0&&e.enqueue(this.partialChunk.slice(0,this.offset))}}},zpw2:function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return h}));var i=s("Uzj0"),a=s("Mk04"),n=s("UK4g"),r=s("YEoC"),o=s("DI/x"),d=s("PmZf"),l=s("d951"),c=s("ipeT");class h{constructor(e,t,s,r,o){this.engine=e,this.transactionManager=t,this.databaseName=s,this.databaseSchema=r,this.numOfActiveQueries=0,this.pendingQueries=[],this.pending=!1,this.idleListeners=[];const d=i.e.map(r,((e,t)=>new c.a(s,t,n.i,this.doQuery.bind(this),this.dispatchQueryErrorEvent.bind(this),o)));Object.entries(d).forEach((([e,t])=>{Object.defineProperty(this,e,{value:t,writable:!1})})),Object.defineProperty(this,"runTransaction",{value:this.runTransaction.bind(this,this.databaseName,this.databaseSchema)}),Object.defineProperty(this,"runTransactionV2",{value:this.runTransactionV2.bind(this,this.databaseName,this.databaseSchema)}),this.closeThisDatabase=Object(a.a)(this.closeThisDatabase.bind(this)),this.deleteThisDatabase=Object(a.a)(this.deleteThisDatabase.bind(this))}dispatchQueryErrorEvent(e){this.engine.dispatchEvent(new d.d(e))}get isIdle(){return 0===this.numOfActiveQueries}dispatchIdleEvent(){this.idleListeners.forEach((e=>e())),this.idleListeners=[]}addIdleListenerOnce(e){this.isIdle?e():this.idleListeners.push(e)}stop(){this.pending=!0}resume(){this.pendingQueries.forEach((e=>{e.execute()})),this.pendingQueries=[],this.pending=!1}waitUntilIdle(){return new Promise((e=>{this.addIdleListenerOnce((()=>e()))}))}trapIdleTracking(e){return this.numOfActiveQueries+=1,e.finally((()=>{this.numOfActiveQueries-=1,this.isIdle&&this.dispatchIdleEvent()}))}doQuery(e){const t=()=>this.trapIdleTracking(this.engine.do(e));if(this.pending){const e=()=>t(),s=new l.a(e);return this.pendingQueries.push(s),s.getResult()}return t()}async closeThisDatabase(e){this.stop(),await this.waitUntilIdle(),await this.engine.closeDatabase(this.databaseName,e),this.resume()}async deleteThisDatabase(e){this.stop(),await this.waitUntilIdle(),await this.engine.deleteDatabase(this.databaseName,e),this.resume()}runTransaction(t,s,i,a,n=r.g.READWRITE){const d=this.transactionManager,l=this.doQuery.bind(this),h=this.dispatchQueryErrorEvent.bind(this);return new Promise(((n,r)=>{try{!async function(n,r){const u=i.map((e=>"string"==typeof e?e:e.name)).map((e=>{if(!s[e])throw new o.y(e);const i=s[e];return new c.a(t,i,0,l,h)}));await a(u),e((()=>{d.commitTransaction(0).then(n).catch(r)}))}(n,r)}catch(u){r(u)}}))}runTransactionV2(t,s,i,a,n=r.g.READWRITE){const d=this.transactionManager,l=this.doQuery.bind(this),h=this.dispatchQueryErrorEvent.bind(this);return new Promise(((r,u)=>{try{!async function(r,u){const g=i.map((e=>"string"==typeof e?e:e.name)),m=await d.beginTransaction(t,g,n),p=g.map((e=>{if(!s[e])throw new o.y(e);const i=s[e];return new c.b(t,i,m.id,l,h)}));await a(p),e((()=>{d.commitTransaction(m.id).then(r).catch(u)}))}(r,u)}catch(g){u(g)}}))}}}).call(this,s("7fu/").setImmediate)}}]);
//# sourceMappingURL=../sourcemaps/lazy/web-startup.b612538677d498545a0d.js.map